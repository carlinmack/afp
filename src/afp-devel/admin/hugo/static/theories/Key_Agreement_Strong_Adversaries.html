<div id="Infra">
<div class="head">
<h1>Theory Infra</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Infra.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Infra.thy 132861 2016-12-21 10:34:41Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Infrastructure for refinement proofs (attributes, prover tuning etc)

  Copyright (c) 2009-2016 Christoph Sprenger 
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proving infrastructure›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Infra <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Prover configuration›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">declare</span></span> if_split_asm <span class="main">[</span><span class="operator">split</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Forward reasoning ("attributes")›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas are used to produce intro/elim rules from
set definitions and relation definitions.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> set_def_to_intro <span class="main">=</span> meta_eq_to_obj_eq <span class="main">[</span><span class="operator">THEN</span> eqset_imp_iff<span class="main">,</span> <span class="operator">THEN</span> iffD2<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> set_def_to_dest <span class="main">=</span> meta_eq_to_obj_eq <span class="main">[</span><span class="operator">THEN</span> eqset_imp_iff<span class="main">,</span> <span class="operator">THEN</span> iffD1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> set_def_to_elim <span class="main">=</span> set_def_to_dest <span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> setc_def_to_intro <span class="main">=</span> 
  set_def_to_intro <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">P</span><span class="main">,</span> <span class="operator">to_pred</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> setc_def_to_dest <span class="main">=</span> 
  set_def_to_dest <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">P</span><span class="main">,</span> <span class="operator">to_pred</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> setc_def_to_elim <span class="main">=</span> setc_def_to_dest <span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> rel_def_to_intro <span class="main">=</span> setc_def_to_intro <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span> <span class="free">t</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> rel_def_to_dest <span class="main">=</span> setc_def_to_dest <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span> <span class="free">t</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> rel_def_to_elim <span class="main">=</span> rel_def_to_dest <span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General results›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Maps›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We usually remove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">domIff</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from the simpset and clasets due
to annoying behavior. Sometimes the lemmas below are more well-behaved than 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">domIff</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Usually to be used as "dest: dom\_lemmas". However, adding 
them as permanent dest rules slows down proofs too much, so we refrain from 
doing this.›</span></span>

<span class="keyword1" id="Infra-map_definedness"><span class="command">lemma</span></span> map_definedness<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff<span class="main">)</span>

<span class="keyword1" id="Infra-map_definedness_contra"><span class="command">lemma</span></span> map_definedness_contra<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span><span class="main">;</span> <span class="free">z</span> <span class="main">∉</span> dom <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> dom_lemmas <span class="main">=</span> map_definedness map_definedness_contra


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Set›</span></span>
<span class="comment1">(******************************************************************************)</span>


<span class="keyword1" id="Infra-vimage_image_subset"><span class="command">lemma</span></span> vimage_image_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">-`</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def vimage_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relations›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1" id="Infra-Image_compose"><span class="command">lemma</span></span> Image_compose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span><span class="main">``</span><span class="free">A</span>  <span class="main">=</span> <span class="free">R2</span><span class="main">``</span><span class="main">(</span><span class="free">R1</span><span class="main">``</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="comment1">― ‹Do NOT add the following equation to the simpset! (looping)›</span>
<span class="keyword1" id="Infra-map_comp"><span class="command">lemma</span></span> map_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> map <span class="free">g</span> <span class="keyword1">o</span> map <span class="free">f</span>"</span></span>  
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> map_comp_map <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Infra-take_prefix"><span class="command">lemma</span></span> take_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> take <span class="free">n</span> <span class="free">l</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> <span class="free">l</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="bound">xs'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">rename_tac</span> n<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finite sets›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Cardinality.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> arg_cong <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">card</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span> 

<span class="keyword1" id="Infra-finite_positive_cardI"><span class="command">lemma</span></span> finite_positive_cardI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> card <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Infra-finite_positive_cardD"><span class="command">lemma</span></span> finite_positive_cardD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">0</span> <span class="main">&lt;</span> card <span class="free">A</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Infra-finite_zero_cardI"><span class="command">lemma</span></span> finite_zero_cardI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> card <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Infra-finite_zero_cardD"><span class="command">lemma</span></span> finite_zero_cardD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> card <span class="free">A</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>





</pre>
</div><div id="Refinement">
<div class="head">
<h1>Theory Refinement</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Refinement.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Refinement.thy 132859 2016-12-21 09:09:39Z eth.jlallemand $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Infrastructure for specifications, invariants, and refinements.

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Models, Invariants and Refinements›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Refinement <span class="keyword2"><span class="keyword">imports</span></span> <a href="Infra.html">Infra</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specifications, reachability, and behaviours.›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transition systems are multi-pointed graphs.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'s</span> TS <span class="main">=</span> 
  init <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The inductive set of reachable states.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">reach</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  r_init <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> init <span class="free">T</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span> <span class="free">T</span>"</span></span>
<span class="main">|</span> r_trans <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">T</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span> <span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∈</span> <span class="free">reach</span> <span class="free">T</span>"</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finite behaviours›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that behaviours grow at the head of the list, i.e., the initial 
state is at the end.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">beh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> list<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  b_empty <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span>"</span></span>
<span class="main">|</span> b_init <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> init <span class="free">T</span> <span class="main">⟹</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span>"</span></span>
<span class="main">|</span> b_trans <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> beh_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">#</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Behaviours are prefix closed.›</span></span>

<span class="keyword1" id="Refinement-beh_immediate_prefix_closed"><span class="command">lemma</span></span> beh_immediate_prefix_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">#</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> beh_non_empty<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1" id="Refinement-beh_prefix_closed"><span class="command">lemma</span></span> beh_prefix_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">@</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> beh_immediate_prefix_closed<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹States in behaviours are exactly reachable.›</span></span>

<span class="keyword1" id="Refinement-beh_in_reach"><span class="command">lemma</span></span> beh_in_reach <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">b</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> reach <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> beh.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  
<span class="keyword1" id="Refinement-reach_in_beh"><span class="command">lemma</span></span> reach_in_beh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> reach <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> beh <span class="free">T</span><span class="main">.</span> <span class="free">s</span> <span class="main">∈</span> set <span class="bound">b</span>"</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>r_init <span class="skolem">s</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set <span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s</span><span class="main">]</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>r_trans <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">b</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b2</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> beh <span class="free">T</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b1</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> beh_prefix_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">T</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">#</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b1</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Refinement-reach_equiv_beh_states"><span class="command">lemma</span></span> reach_equiv_beh_states<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">T</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>set<span class="main">`</span><span class="main">(</span>beh <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_in_beh beh_in_reach<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Specifications, observability, and implementation›</span></span> 
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specifications add an observer function to transition systems.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> TS"</span></span> <span class="main">+</span>
  obs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span>"</span></span> 

<span class="keyword1" id="Refinement-beh_obs_upd"><span class="command">lemma</span></span> beh_obs_upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"beh <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">x</span> <span class="main">|)</span><span class="main">)</span> <span class="main">=</span> beh <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> beh.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Refinement-reach_obs_upd"><span class="command">lemma</span></span> reach_obs_upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">x</span> <span class="main">|)</span><span class="main">)</span> <span class="main">=</span> reach <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observable behaviour and reachability.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">obeh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'o</span> list<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obeh</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span>obs <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>beh <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">oreach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec <span class="main">⇒</span> <span class="tfree">'o</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">oreach</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span>obs <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">`</span><span class="main">(</span>reach <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Refinement-oreach_equiv_obeh_states"><span class="command">lemma</span></span> oreach_equiv_obeh_states<span class="main">:</span>
  <span class="quoted"><span class="quoted">"oreach <span class="free">S</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>set<span class="main">`</span><span class="main">(</span>obeh <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_equiv_beh_states oreach_def obeh_def<span class="main">)</span>


<span class="keyword1" id="Refinement-obeh_pi_translation"><span class="command">lemma</span></span> obeh_pi_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">pi</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>obeh <span class="free">S</span><span class="main">)</span> <span class="main">=</span> obeh <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">pi</span> <span class="keyword1">o</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obeh_def image_comp<span class="main">)</span>

<span class="keyword1" id="Refinement-oreach_pi_translation"><span class="command">lemma</span></span> oreach_pi_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">pi</span><span class="main">`</span><span class="main">(</span>oreach <span class="free">S</span><span class="main">)</span> <span class="main">=</span> oreach <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">pi</span> <span class="keyword1">o</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A predicate $P$ on the states of a specification is \emph{observable} 
if it cannot distinguish between states yielding the same observation. 
Equivalently, $P$ is observable if it is the inverse image under the 
observation function of a predicate on observations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">observable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observable</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">observable2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observable2</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span><span class="main">-`</span><span class="bound">Q</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">observable3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observable3</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span><span class="main">-`</span><span class="free"><span class="bound"><span class="entity">ob</span></span></span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>    <span class="comment1">― ‹other direction holds trivially›</span>

<span class="keyword1" id="Refinement-observableE"><span class="command">lemma</span></span> observableE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>observable <span class="free">ob</span> <span class="free">P</span><span class="main">;</span> <span class="free">ob</span> <span class="free">s</span> <span class="main">=</span> <span class="free">ob</span> <span class="free">s'</span><span class="main">;</span> <span class="free">s'</span> <span class="main">∈</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> observable_def<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>

<span class="keyword1" id="Refinement-observable2_equiv_observable"><span class="command">lemma</span></span> observable2_equiv_observable<span class="main">:</span> <span class="quoted"><span class="quoted">"observable2 <span class="free">ob</span> <span class="free">P</span> <span class="main">=</span> observable <span class="free">ob</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> observable_def observable2_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Refinement-observable3_equiv_observable2"><span class="command">lemma</span></span> observable3_equiv_observable2<span class="main">:</span> <span class="quoted"><span class="quoted">"observable3 <span class="free">ob</span> <span class="free">P</span> <span class="main">=</span> observable2 <span class="free">ob</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> observable3_def observable2_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Refinement-observable_id"><span class="command">lemma</span></span> observable_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"observable id <span class="free">P</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> observable_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set extension of a function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ob</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the left adjoint of 
a Galois connection on the powerset lattices over domain and range of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ob</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
where the right adjoint is the inverse image function.›</span></span>

<span class="keyword1" id="Refinement-image_vimage_adjoints"><span class="command">lemma</span></span> image_vimage_adjoints<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ob</span><span class="main">`</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">ob</span><span class="main">-`</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> image_vimage_subset <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> vimage_image_subset <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similar but "reversed" (wrt to adjointness) relationships only hold under
additional conditions.›</span></span>

<span class="keyword1" id="Refinement-image_r_vimage_l"><span class="command">lemma</span></span> image_r_vimage_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">ob</span><span class="main">`</span><span class="free">P</span><span class="main">;</span> observable <span class="free">ob</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ob</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Refinement-vimage_l_image_r"><span class="command">lemma</span></span> vimage_l_image_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ob</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊆</span> range <span class="free">ob</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">ob</span><span class="main">`</span><span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> image_mono <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ob</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Internal and external invariants›</span></span>

<span class="keyword1" id="Refinement-external_from_internal_invariant"><span class="command">lemma</span></span> external_from_internal_invariant<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">`</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟧</span>  
  <span class="main">⟹</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>

<span class="keyword1" id="Refinement-external_from_internal_invariant_vimage"><span class="command">lemma</span></span> external_from_internal_invariant_vimage<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊆</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⟧</span>
  <span class="main">⟹</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> external_from_internal_invariant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="Refinement-external_to_internal_invariant_vimage"><span class="command">lemma</span></span> external_to_internal_invariant_vimage<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>

<span class="keyword1" id="Refinement-external_to_internal_invariant"><span class="command">lemma</span></span> external_to_internal_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">`</span><span class="free">P</span><span class="main">;</span> observable <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> external_to_internal_invariant_vimage<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="Refinement-external_equiv_internal_invariant_vimage"><span class="command">lemma</span></span> external_equiv_internal_invariant_vimage<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> external_from_internal_invariant_vimage
                external_to_internal_invariant_vimage 
         <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1" id="Refinement-external_equiv_internal_invariant"><span class="command">lemma</span></span> external_equiv_internal_invariant<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">`</span><span class="free">P</span> <span class="main">=</span> <span class="free">Q</span><span class="main">;</span> observable <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_equiv_internal_invariant_vimage<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our notion of implementation is inclusion of observable behaviours.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">implements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> spec<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">implements</span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">pi</span></span></span><span class="main">)</span><span class="main">`</span><span class="main">(</span>obeh <span class="free"><span class="bound"><span class="entity">Sc</span></span></span><span class="main">)</span> <span class="main">⊆</span> obeh <span class="free"><span class="bound"><span class="entity">Sa</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and transitivity›</span></span>

<span class="keyword1" id="Refinement-implements_refl"><span class="command">lemma</span></span> implements_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"implements id <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def<span class="main">)</span>

<span class="keyword1" id="Refinement-implements_trans"><span class="command">lemma</span></span> implements_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> implements <span class="free">pi1</span> <span class="free">S1</span> <span class="free">S2</span><span class="main">;</span> implements <span class="free">pi2</span> <span class="free">S2</span> <span class="free">S3</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> implements <span class="main">(</span><span class="free">pi1</span> <span class="keyword1">o</span> <span class="free">pi2</span><span class="main">)</span> <span class="free">S1</span> <span class="free">S3</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def image_subset_iff<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preservation of external invariants›</span></span>

<span class="keyword1" id="Refinement-implements_oreach"><span class="command">lemma</span></span> implements_oreach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> <span class="free">pi</span><span class="main">`</span><span class="main">(</span>oreach <span class="free">Sc</span><span class="main">)</span> <span class="main">⊆</span> oreach <span class="free">Sa</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def oreach_equiv_obeh_states <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1" id="Refinement-external_invariant_preservation"><span class="command">lemma</span></span> external_invariant_preservation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">pi</span><span class="main">`</span><span class="main">(</span>oreach <span class="free">Sc</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> implements_oreach<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Refinement-external_invariant_translation"><span class="command">lemma</span></span> external_invariant_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> <span class="free">pi</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span>
  <span class="main">⟹</span> oreach <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> vimage_image_subset<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">pi</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">pi</span></span><span class="main"><span class="main">-`</span></span><span class="free"><span class="free">Q</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> vimage_mono external_invariant_preservation<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preservation of internal invariants›</span></span>

<span class="keyword1" id="Refinement-internal_invariant_translation"><span class="command">lemma</span></span> internal_invariant_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">Pa</span><span class="main">;</span> <span class="free">Pa</span> <span class="main">⊆</span> obs <span class="free">Sa</span> <span class="main">-`</span> <span class="free">Qa</span><span class="main">;</span> <span class="free">pi</span> <span class="main">-`</span> <span class="free">Qa</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> obs <span class="free">S</span> <span class="main">-`</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span>
     implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">S</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant_vimage <span class="main"><span class="main">[</span></span>
      <span class="operator">THEN</span> external_invariant_translation<span class="main"><span class="main">,</span></span> 
      <span class="operator">THEN</span> external_to_internal_invariant_vimage<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we define Hoare triples over transition relations and then
we derive proof rules to establish invariants.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Hoare triples›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">PO_hoare</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set<span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
     <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">{</span>_<span class="keyword1">}</span> _ <span class="keyword1">{&gt;</span> _<span class="keyword1">}</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 90<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main"><span class="free">{&gt;</span></span> <span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_hoare_defs <span class="main">=</span> PO_hoare_def Image_def

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some essential facts about Hoare triples.›</span></span>

<span class="keyword1" id="Refinement-hoare_conseq_left"><span class="command">lemma</span></span> hoare_conseq_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">P'</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊆</span> <span class="free">P'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-hoare_conseq_right"><span class="command">lemma</span></span> hoare_conseq_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q'</span><span class="main">}</span><span class="main">;</span> <span class="free">Q'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-hoare_false_left"><span class="command">lemma</span></span> hoare_false_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-hoare_true_right"><span class="command">lemma</span></span> hoare_true_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> UNIV<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-hoare_conj_right"><span class="command">lemma</span></span> hoare_conj_right <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q1</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q2</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q1</span> <span class="main">∩</span> <span class="free">Q2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Special transition relations.›</span></span>

<span class="keyword1" id="Refinement-hoare_stop"><span class="command">lemma</span></span> hoare_stop <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">{}</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-hoare_skip"><span class="command">lemma</span></span> hoare_skip <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> Id <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-hoare_trans_Un"><span class="command">lemma</span></span> hoare_trans_Un <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R1</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">∧</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R2</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-hoare_trans_UN"><span class="command">lemma</span></span> hoare_trans_UN <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">⋃</span> <span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-hoare_apply"><span class="command">lemma</span></span> hoare_apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span><span class="free">Q</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Characterization of reachability›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1" id="Refinement-reach_init"><span class="command">lemma</span></span> reach_init<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟹</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1" id="Refinement-reach_trans"><span class="command">lemma</span></span> reach_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">{</span>reach <span class="free">T</span><span class="main">}</span> trans <span class="free">T</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful consequences.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> init_reach <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"init <span class="free">T</span> <span class="main">⊆</span> reach <span class="free">T</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> trans_reach <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>reach <span class="free">T</span><span class="main">}</span> trans <span class="free">T</span> <span class="main">{&gt;</span> reach <span class="free">T</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant proof rules›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic proof rule for invariants.›</span></span>

<span class="keyword1" id="Refinement-inv_rule_basic"><span class="command">lemma</span></span> inv_rule_basic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">P</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General invariant proof rule. This rule is complete (set 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">I</span></span> <span class="main"><span class="main">=</span></span> reach <span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1" id="Refinement-inv_rule"><span class="command">lemma</span></span> inv_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>              <span class="comment1">― ‹strengthen goal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rule is equivalent to the previous one.›</span></span>

<span class="keyword1" id="Refinement-INV_rule"><span class="command">lemma</span></span> INV_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> reach <span class="free">T</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof of equivalence.›</span></span>

<span class="keyword1" id="Refinement-inv_rule_from_INV_rule"><span class="command">lemma</span></span> inv_rule_from_INV_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> INV_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Refinement-INV_rule_from_inv_rule"><span class="command">lemma</span></span> INV_rule_from_inv_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> reach <span class="free">T</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> reach <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Incremental proof rule for invariants using auxiliary invariant(s). 
This rule might have become obsolete by addition of $INV\_rule$.›</span></span>

<span class="keyword1" id="Refinement-inv_rule_incr"><span class="command">lemma</span></span> inv_rule_incr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">⟧</span>    
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> INV_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our notion of refinement is simulation. We first define a general
notion of relational Hoare tuple, which we then use to define the refinement
proof obligation.  Finally, we show that observation-consistent refinement 
of specifications implies the implementation relation between them.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relational Hoare tuples›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relational Hoare tuples formalize the following generalized simulation 
diagram:

\begin{verbatim}
                           o -- Ra --&gt; o
                           |           |
                          pre         post
                           |           |
                           v           V
                           o -- Rc --&gt; o
\end{verbatim}

Here, $Ra$ and $Rc$ are the abstract and concrete transition relations, 
and $pre$ and $post$ are the pre- and post-relations.
(In the definiton below, the operator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(O)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stands for relational 
composition, which is defined as follows: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> relcomp_def <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.)›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">PO_rhoare</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
     <span class="main">(</span><span class="quoted">"<span class="keyword3">(4</span><span class="keyword1">{</span>_<span class="keyword1">}</span> _<span class="keyword1">,</span> _ <span class="keyword1">{&gt;</span> _<span class="keyword1">}</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 90<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Rc</span></span></span> <span class="main"><span class="free">{&gt;</span></span> <span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="keyword1">O</span> <span class="free"><span class="bound"><span class="entity">Rc</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="keyword1">O</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_rhoare_defs <span class="main">=</span> PO_rhoare_def relcomp_unfold


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Facts about relational Hoare tuples.›</span></span>

<span class="keyword1" id="Refinement-relhoare_conseq_left"><span class="command">lemma</span></span> relhoare_conseq_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre'</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span><span class="main">;</span> <span class="free">pre</span> <span class="main">⊆</span> <span class="free">pre'</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1" id="Refinement-relhoare_conseq_right"><span class="command">lemma</span></span> relhoare_conseq_right<span class="main">:</span>                    <span class="comment1">― ‹do NOT declare [intro]›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post'</span><span class="main">}</span><span class="main">;</span> <span class="free">post'</span> <span class="main">⊆</span> <span class="free">post</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-relhoare_false_left"><span class="command">lemma</span></span> relhoare_false_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>               <span class="comment1">― ‹do NOT declare [intro]›</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">{}</span> <span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-relhoare_true_right"><span class="command">lemma</span></span> relhoare_true_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>                <span class="comment1">― ‹not true in general›</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> UNIV<span class="main">}</span> <span class="main">=</span> <span class="main">(</span>Domain <span class="main">(</span><span class="free">pre</span> <span class="keyword1">O</span> <span class="free">Rc</span><span class="main">)</span> <span class="main">⊆</span> Domain <span class="free">Ra</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-Domain_rel_comp"><span class="command">lemma</span></span> Domain_rel_comp <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Domain <span class="free">pre</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">⟹</span> Domain <span class="main">(</span><span class="free">pre</span> <span class="keyword1">O</span> <span class="free">Rc</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Domain_def<span class="main">)</span>

<span class="keyword1" id="Refinement-rel_hoare_skip"><span class="command">lemma</span></span> rel_hoare_skip <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">R</span><span class="main">}</span> Id<span class="main">,</span> Id <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and transitivity.›</span></span>

<span class="keyword1" id="Refinement-relhoare_refl"><span class="command">lemma</span></span> relhoare_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Id<span class="main">}</span> <span class="free">R</span><span class="main">,</span> <span class="free">R</span> <span class="main">{&gt;</span> Id<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-rhoare_trans"><span class="command">lemma</span></span> rhoare_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">R1</span><span class="main">}</span> <span class="free">T1</span><span class="main">,</span> <span class="free">T2</span> <span class="main">{&gt;</span> <span class="free">R1</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span><span class="free">R2</span><span class="main">}</span> <span class="free">T2</span><span class="main">,</span> <span class="free">T3</span> <span class="main">{&gt;</span> <span class="free">R2</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">}</span> <span class="free">T1</span><span class="main">,</span> <span class="free">T3</span> <span class="main">{&gt;</span> <span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subset_refl <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> relcomp_mono<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subset_refl <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> relcomp_mono<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> O_assoc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Conjunction in the post-relation cannot be split in general.  However, 
here are two useful special cases.  In the first case the abstract transtition 
relation is deterministic and in the second case one conjunct is a cartesian 
product of two state predicates.›</span></span>

<span class="keyword1" id="Refinement-relhoare_conj_right_det"><span class="command">lemma</span></span> relhoare_conj_right_det<span class="main">:</span>                 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post1</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post2</span><span class="main">}</span><span class="main">;</span>
     single_valued <span class="free">Ra</span> <span class="main">⟧</span>                           <span class="comment1">― ‹only for deterministic <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span>!›</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post1</span> <span class="main">∩</span> <span class="free">post2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1" id="Refinement-relhoare_conj_right_cartesian"><span class="command">lemma</span></span> relhoare_conj_right_cartesian <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span>Domain <span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span>Range <span class="free">pre</span><span class="main">}</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs PO_hoare_defs Domain_def Range_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Separate rule for cartesian products.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> relhoare_cartesian<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span>Domain <span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span>Range <span class="free">pre</span><span class="main">}</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>                      <span class="comment1">― ‹any <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>post›</span></span>, including <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>UNIV›</span></span>!›</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> relhoare_conseq_right<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Unions of transition relations.›</span></span>

<span class="keyword1" id="Refinement-relhoare_concrete_Un"><span class="command">lemma</span></span> relhoare_concrete_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc1</span> <span class="main">∪</span> <span class="free">Rc2</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> 
   <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc1</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">∧</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc2</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Refinement-relhoare_concrete_UN"><span class="command">lemma</span></span> relhoare_concrete_UN <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Rc</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Refinement-relhoare_abstract_Un_left"><span class="command">lemma</span></span> relhoare_abstract_Un_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra1</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra1</span> <span class="main">∪</span> <span class="free">Ra2</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-relhoare_abstract_Un_right"><span class="command">lemma</span></span> relhoare_abstract_Un_right <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra2</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra1</span> <span class="main">∪</span> <span class="free">Ra2</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-relhoare_abstract_UN"><span class="command">lemma</span></span> relhoare_abstract_UN <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>   <span class="comment1">― ‹! might be too aggressive? INDEED.›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span> <span class="free">x</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Ra</span> <span class="bound">x</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inclusion of abstract transition relations.›</span></span>

<span class="keyword1" id="Refinement-relhoare_abstract_trans_weak"><span class="command">lemma</span></span> relhoare_abstract_trans_weak <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra'</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span><span class="main">;</span> <span class="free">Ra'</span> <span class="main">⊆</span> <span class="free">Ra</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>PO_rhoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof obligations›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A transition system refines another one if the initial states and the
transitions are refined. 
Initial state refinement means that for each concrete initial state there is 
a related abstract one. Transition refinement means that the simulation 
relation is preserved (as expressed by a relational Hoare tuple). 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">PO_refines</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> TS_scheme<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PO_refines</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="free"><span class="bound"><span class="entity">Tc</span></span></span> <span class="main">≡</span> <span class="main">(</span>
       init <span class="free"><span class="bound"><span class="entity">Tc</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="main">(</span>init <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span> <span class="main">(</span>trans <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free"><span class="bound"><span class="entity">Tc</span></span></span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span> 
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Refinement-PO_refinesI"><span class="command">lemma</span></span> PO_refinesI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> <span class="main">{</span><span class="free">R</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>

<span class="keyword1" id="Refinement-PO_refinesE"><span class="command">lemma</span></span> PO_refinesE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> <span class="main">⟦</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> <span class="main">{</span><span class="free">R</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic refinement rule. This is just an introduction rule for the
definition.›</span></span>

<span class="keyword1" id="Refinement-refine_basic"><span class="command">lemma</span></span> refine_basic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> <span class="main">{</span><span class="free">R</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following proof rule uses individual invariants <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">J</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the concrete and abstract systems to strengthen the 
simulation relation $R$. 

The hypotheses state that these state predicates are indeed invariants.
Note that the pre-condition of the invariant preservation hypotheses for 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">J</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are strengthened by adding the predicates 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Domain <span class="main"><span class="main">(</span></span><span class="free"><span class="free">R</span></span> <span class="main"><span class="main">∩</span></span> UNIV <span class="main"><span class="main">×</span></span> <span class="free"><span class="free">J</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Range <span class="main"><span class="main">(</span></span><span class="free"><span class="free">R</span></span> <span class="main"><span class="main">∩</span></span> <span class="free"><span class="free">I</span></span> <span class="main"><span class="main">×</span></span> UNIV<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
respectively.  In particular, the latter predicate may be essential, if a 
concrete invariant depends on the simulation relation and an abstract invariant, 
i.e. to "transport" abstract invariants to the concrete system.›</span></span>

<span class="keyword1" id="Refinement-refine_init_using_invariants"><span class="command">lemma</span></span> refine_init_using_invariants<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> init <span class="free">Ta</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">⟧</span>
  <span class="main">⟹</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">)</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec subsetD<span class="main">)</span>

<span class="keyword1" id="Refinement-refine_trans_using_invariants"><span class="command">lemma</span></span> refine_trans_using_invariants<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> Domain <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="free">J</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> 
     <span class="main">{</span><span class="free">J</span> <span class="main">∩</span> Range <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span>  <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conj_right_cartesian<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is our main rule for refinements.›</span></span>

<span class="keyword1" id="Refinement-refine_using_invariants"><span class="command">lemma</span></span> refine_using_invariants<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> Domain <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="free">J</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> 
     <span class="main">{</span><span class="free">J</span> <span class="main">∩</span> Range <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span><span class="main">;</span> 
     init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> 
     init <span class="free">Ta</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">⟧</span>
  <span class="main">⟹</span> PO_refines <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">)</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> PO_refines_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">intro</span> refine_init_using_invariants refine_trans_using_invariants conjI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Deriving invariants from refinements›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some invariants can only be proved after the simulation has been 
established, because they depend on the simulation relation and some abstract
invariants.  Here is a rule to derive invariant theorems from the refinement.›</span></span>

<span class="keyword1" id="Refinement-PO_refines_implies_Range_init"><span class="command">lemma</span></span> PO_refines_implies_Range_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span> <span class="main">⟹</span> init <span class="free">Tc</span> <span class="main">⊆</span> Range <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>

<span class="keyword1" id="Refinement-PO_refines_implies_Range_trans"><span class="command">lemma</span></span> PO_refines_implies_Range_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span> <span class="main">⟹</span> <span class="main">{</span>Range <span class="free">R</span><span class="main">}</span> trans <span class="free">Tc</span> <span class="main">{&gt;</span> Range <span class="free">R</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def PO_rhoare_def PO_hoare_def<span class="main">)</span>

<span class="keyword1" id="Refinement-PO_refines_implies_Range_invariant"><span class="command">lemma</span></span> PO_refines_implies_Range_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span> <span class="main">⟹</span> reach <span class="free">Tc</span> <span class="main">⊆</span> Range <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> INV_rule<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_refines_implies_Range_init 
                 PO_refines_implies_Range_trans<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rules are more useful in proofs.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> INV_init_from_refinement<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span>
  <span class="main">⟹</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> PO_refines_implies_Range_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> INV_trans_from_refinement<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> <span class="free">K</span> <span class="main">⊆</span> Range <span class="free">R</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">K</span><span class="main">}</span> trans <span class="free">Tc</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> PO_refines_implies_Range_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hoare_conseq_right<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> INV_from_refinement<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> PO_refines_implies_Range_invariant<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of specifications›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lift relation membership to finite sequences›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">seq_lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> list <span class="main">×</span> <span class="tfree">'t</span> list<span class="main">)</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  sl_nil <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq_lift</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> sl_cons <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq_lift</span> <span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq_lift</span> <span class="free">R</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> sl_cons_right_invert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ba'</span><span class="main">,</span> <span class="free">t</span> <span class="main">#</span> <span class="free">bc</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span>"</span></span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For each concrete behaviour there is a related abstract one.›</span></span>

<span class="keyword1" id="Refinement-behaviour_refinement"><span class="command">lemma</span></span> behaviour_refinement<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> <span class="free">bc</span> <span class="main">∈</span> beh <span class="free">Tc</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ba</span> <span class="main">∈</span> beh <span class="free">Ta</span><span class="main">.</span> <span class="main">(</span><span class="bound">ba</span><span class="main">,</span> <span class="free">bc</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span>"</span></span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> beh.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="comment1">― ‹case: singleton›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def Image_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="comment1">― ‹case: cons; first construct related abstract state›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sl_cons_right_invert<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s bc s' ba t<span class="main">)</span>
  <span class="comment1">― ‹now construct abstract transition›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def PO_rhoare_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency of a relation is defined using a mediator 
function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">pi</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to abstract the concrete observation.  This allows us 
to also refine the observables as we move down a refinement branch.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">obs_consistent</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> spec<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obs_consistent</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="main">(</span>obs <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> obs <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Refinement-obs_consistent_refl"><span class="command">lemma</span></span> obs_consistent_refl <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs_consistent Id id <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1" id="Refinement-obs_consistent_trans"><span class="command">lemma</span></span> obs_consistent_trans <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> obs_consistent <span class="free">R1</span> <span class="free">pi1</span> <span class="free">S1</span> <span class="free">S2</span><span class="main">;</span> obs_consistent <span class="free">R2</span> <span class="free">pi2</span> <span class="free">S2</span> <span class="free">S3</span> <span class="main">⟧</span>
  <span class="main">⟹</span> obs_consistent <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="main">(</span><span class="free">pi1</span> <span class="keyword1">o</span> <span class="free">pi2</span><span class="main">)</span> <span class="free">S1</span> <span class="free">S3</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1" id="Refinement-obs_consistent_empty"><span class="command">lemma</span></span> obs_consistent_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"obs_consistent <span class="main">{}</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1" id="Refinement-obs_consistent_conj1"><span class="command">lemma</span></span> obs_consistent_conj1 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> obs_consistent <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">R'</span><span class="main">)</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1" id="Refinement-obs_consistent_conj2"><span class="command">lemma</span></span> obs_consistent_conj2 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> obs_consistent <span class="main">(</span><span class="free">R'</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1" id="Refinement-obs_consistent_behaviours"><span class="command">lemma</span></span> obs_consistent_behaviours<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> <span class="free">bc</span> <span class="main">∈</span> beh <span class="free">Sc</span><span class="main">;</span> <span class="free">ba</span> <span class="main">∈</span> beh <span class="free">Sa</span><span class="main">;</span> <span class="main">(</span><span class="free">ba</span><span class="main">,</span> <span class="free">bc</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span><span class="main">⟧</span>
  <span class="main">⟹</span> map <span class="free">pi</span> <span class="main">(</span>map <span class="main">(</span>obs <span class="free">Sc</span><span class="main">)</span> <span class="free">bc</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>obs <span class="free">Sa</span><span class="main">)</span> <span class="free">ba</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> seq_lift.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of refinement proof obligations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">refines</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> spec<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">refines</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">≡</span> obs_consistent <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">∧</span> PO_refines <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> refines_defs <span class="main">=</span> 
  refines_def PO_refines_def

<span class="keyword1" id="Refinement-refinesI"><span class="command">lemma</span></span> refinesI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span>
  <span class="main">⟹</span> refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_def<span class="main">)</span>

<span class="keyword1" id="Refinement-refinesE"><span class="command">lemma</span></span> refinesE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> <span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and transitivity of refinement.›</span></span>

<span class="keyword1" id="Refinement-refinement_reflexive"><span class="command">lemma</span></span> refinement_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"refines Id id <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_defs<span class="main">)</span>

<span class="keyword1" id="Refinement-refinement_transitive"><span class="command">lemma</span></span> refinement_transitive<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refines <span class="free">R1</span> <span class="free">pi1</span> <span class="free">S1</span> <span class="free">S2</span><span class="main">;</span> refines <span class="free">R2</span> <span class="free">pi2</span> <span class="free">S2</span> <span class="free">S3</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> refines <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="main">(</span><span class="free">pi1</span> <span class="keyword1">o</span> <span class="free">pi2</span><span class="main">)</span> <span class="free">S1</span> <span class="free">S3</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_defs <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rhoare_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Image_mono<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Soundness of refinement for proving implementation›</span></span>

<span class="keyword1" id="Refinement-observable_behaviour_refinement"><span class="command">lemma</span></span> observable_behaviour_refinement<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> <span class="free">bc</span> <span class="main">∈</span> obeh <span class="free">Sc</span> <span class="main">⟧</span> <span class="main">⟹</span> map <span class="free">pi</span> <span class="free">bc</span> <span class="main">∈</span> obeh <span class="free">Sa</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_def obeh_def image_def
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> behaviour_refinement obs_consistent_behaviours<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> refinement_soundness<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def 
         <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> observable_behaviour_refinement<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extended versions of refinement proof rules including observations›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Refinement_basic <span class="main">=</span> refine_basic <span class="main">[</span><span class="operator">THEN</span> refinesI<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> Refinement_using_invariants <span class="main">=</span> refine_using_invariants <span class="main">[</span><span class="operator">THEN</span> refinesI<span class="main">]</span>

<span class="keyword1" id="Refinement-refines_reachable_strengthening"><span class="command">lemma</span></span> refines_reachable_strengthening<span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> refines <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> reach <span class="free">Sa</span> <span class="main">×</span> reach <span class="free">Sc</span><span class="main">)</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Refinement_using_invariants<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inhertitance of internal invariants through refinements›</span></span>

<span class="keyword1" id="Refinement-INV_init_from_Refinement"><span class="command">lemma</span></span> INV_init_from_Refinement<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">⟧</span> <span class="main">⟹</span> init <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> INV_init_from_refinement<span class="main">)</span> 

<span class="keyword1" id="Refinement-INV_trans_from_Refinement"><span class="command">lemma</span></span> INV_trans_from_Refinement<span class="main">:</span>
  <span class="quoted"><span class="quoted">" <span class="main">⟦</span>refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> <span class="free">K</span> <span class="main">⊆</span> Range <span class="free">R</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">K</span><span class="main">}</span> TS.trans <span class="free">Sc</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> INV_trans_from_refinement<span class="main">)</span> 


<span class="keyword1" id="Refinement-INV_from_Refinement_basic"><span class="command">lemma</span></span> INV_from_Refinement_basic<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span> <span class="main">⟹</span> reach <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_refinement<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1" id="Refinement-INV_from_Refinement_using_invariants"><span class="command">lemma</span></span> INV_from_Refinement_using_invariants<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span> 
          <span class="quoted"><span class="quoted">"reach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">J</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_basic<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"refines <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> reach <span class="free">Sa</span> <span class="main">×</span> reach <span class="free">Sc</span><span class="main">)</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refines_reachable_strengthening<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> reach <span class="free">Sa</span> <span class="main">×</span> reach <span class="free">Sc</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Messages">
<div class="head">
<h1>Theory Messages</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Messages.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Messages.thy 133008 2017-01-17 13:53:14Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Message datatype and quotient construction based on Diffie-Hellman 
  equational theory.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Message definitions›</span></span> 

<span class="keyword1"><span class="command">theory</span></span> Messages
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(****************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Messages›</span></span>
<span class="comment1">(****************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Agents›</span></span>
<span class="keyword1"><span class="command">datatype</span></span>
  agent <span class="main">=</span> Agent <span class="quoted">nat</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nonces›</span></span>
<span class="keyword1"><span class="command">typedecl</span></span> fid_t

<span class="keyword1"><span class="command">datatype</span></span> fresh_t <span class="main">=</span> 
  mk_fresh <span class="quoted"><span class="quoted">"fid_t"</span></span> <span class="quoted"><span class="quoted">"nat"</span></span>      <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">$</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 65<span class="main">)</span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fresh_t <span class="main">⇒</span> fid_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fid</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">num</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fresh_t <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">num</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span>
  nonce_t <span class="main">=</span>
    nonce_fresh <span class="quoted"><span class="quoted">"fresh_t"</span></span>
  <span class="main">|</span> nonce_atk <span class="quoted"><span class="quoted">"nat"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Keys›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> ltkey <span class="main">=</span>
  sharK <span class="quoted"><span class="quoted">"agent"</span></span> <span class="quoted"><span class="quoted">"agent"</span></span>
<span class="main">|</span> publK <span class="quoted"><span class="quoted">"agent"</span></span>
<span class="main">|</span> privK <span class="quoted"><span class="quoted">"agent"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ephkey <span class="main">=</span>
  epublK <span class="quoted">nonce_t</span>
<span class="main">|</span> eprivK <span class="quoted">nonce_t</span>

<span class="keyword1"><span class="command">datatype</span></span> tag <span class="main">=</span> insec <span class="main">|</span> auth <span class="main">|</span> confid <span class="main">|</span> secure

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Messages›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> cmsg <span class="main">=</span>
  cAgent <span class="quoted"><span class="quoted">"agent"</span></span>
<span class="main">|</span> cNumber <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="main">|</span> cNonce <span class="quoted"><span class="quoted">"nonce_t"</span></span>
<span class="main">|</span> cLtK <span class="quoted"><span class="quoted">"ltkey"</span></span>
<span class="main">|</span> cEphK <span class="quoted"><span class="quoted">"ephkey"</span></span>
<span class="main">|</span> cPair <span class="quoted">cmsg</span> <span class="quoted">cmsg</span>
<span class="main">|</span> cEnc <span class="quoted">cmsg</span> <span class="quoted">cmsg</span>
<span class="main">|</span> cAenc <span class="quoted">cmsg</span> <span class="quoted">cmsg</span>
<span class="main">|</span> cSign <span class="quoted">cmsg</span> <span class="quoted">cmsg</span>
<span class="main">|</span> cHash <span class="quoted">cmsg</span>
<span class="main">|</span> cTag <span class="quoted">tag</span>
<span class="main">|</span> cExp <span class="quoted">cmsg</span> <span class="quoted">cmsg</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">catomic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cmsg <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">catomic</span> <span class="main">(</span>cAgent <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">catomic</span> <span class="main">(</span>cNumber <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">catomic</span> <span class="main">(</span>cNonce <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">catomic</span> <span class="main">(</span>cLtK <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">catomic</span> <span class="main">(</span>cEphK <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">catomic</span> <span class="main">(</span>cTag <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">" <span class="free">catomic</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cmsg <span class="main">⇒</span> cmsg <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">― ‹equations›</span>
  Permute <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="main">(</span>cExp <span class="main">(</span>cExp <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>cExp <span class="main">(</span>cExp <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹closure by context›</span>
 <span class="main">|</span> Tag<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="main">(</span>cTag <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>cTag <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> Agent<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="main">(</span>cAgent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>cAgent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> Nonce<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="main">(</span>cNonce <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>cNonce <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> Number<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="main">(</span>cNumber <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>cNumber <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> LtK<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="main">(</span>cLtK <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>cLtK <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> EphK<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="main">(</span>cEphK <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>cEphK <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> Pair<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="main">(</span>cPair <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>cPair <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> Enc<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="main">(</span>cEnc <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>cEnc <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> Aenc<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="main">(</span>cAenc <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>cAenc <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> Sign<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="main">(</span>cSign <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>cSign <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> Hash<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="main">(</span>cHash <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>cHash <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> Exp<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="main">(</span>cExp <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>cExp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹reflexive closure is not needed here because the context closure implies it›</span>
<span class="comment1">― ‹symmetric closure is not needed as it is easier to include equations in both directions›</span>
<span class="comment1">― ‹transitive closure›</span>
 <span class="main">|</span> Tr<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free">eq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1" id="Messages-eq_sym"><span class="command">lemma</span></span> eq_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> eq <span class="free">b</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq.induct<span class="main">)</span>

<span class="keyword1" id="Messages-eq_Sym"><span class="command">lemma</span></span> eq_Sym <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> eq <span class="free">b</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq.induct<span class="main">)</span>

<span class="keyword1" id="Messages-eq_refl"><span class="command">lemma</span></span> eq_refl <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">a</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inductive cases; keep the transitivity case, so we prove the the right lemmas by hand.›</span></span>
<span class="keyword1" id="Messages-eq_Number"><span class="command">lemma</span></span> eq_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cNumber <span class="free">N</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="free">y</span> <span class="main">=</span> cNumber <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"cNumber <span class="free">N</span>"</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-eq_Agent"><span class="command">lemma</span></span> eq_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cAgent <span class="free">A</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="free">y</span> <span class="main">=</span> cAgent <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"cAgent <span class="free">A</span>"</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-eq_Nonce"><span class="command">lemma</span></span> eq_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cNonce <span class="free">N</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="free">y</span> <span class="main">=</span> cNonce <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"cNonce <span class="free">N</span>"</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-eq_LtK"><span class="command">lemma</span></span> eq_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cLtK <span class="free">N</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="free">y</span> <span class="main">=</span> cLtK <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"cLtK <span class="free">N</span>"</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-eq_EphK"><span class="command">lemma</span></span> eq_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cEphK <span class="free">N</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="free">y</span> <span class="main">=</span> cEphK <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"cEphK <span class="free">N</span>"</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-eq_Tag"><span class="command">lemma</span></span> eq_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cTag <span class="free">N</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="free">y</span> <span class="main">=</span> cTag <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"cTag <span class="free">N</span>"</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-eq_Hash"><span class="command">lemma</span></span> eq_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cHash <span class="free">X</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> cHash <span class="bound">Y</span> <span class="main">∧</span> eq <span class="free">X</span> <span class="bound">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> eq.induct <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">∀</span></span></span> <span class="bound"><span class="bound"><span class="bound">X</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> cHash <span class="bound"><span class="bound"><span class="bound">X</span></span></span> <span class="main"><span class="main"><span class="main">⟶</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">∃</span></span></span><span class="bound"><span class="bound"><span class="bound">Y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> cHash <span class="bound"><span class="bound"><span class="bound">Y</span></span></span> <span class="main"><span class="main"><span class="main">∧</span></span></span> eq <span class="bound"><span class="bound"><span class="bound">X</span></span></span> <span class="bound"><span class="bound"><span class="bound">Y</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>Tr<span class="main">)</span>
<span class="keyword1" id="Messages-eq_Pair"><span class="command">lemma</span></span> eq_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cPair <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="main">∃</span> <span class="bound">X'</span> <span class="bound">Y'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> cPair <span class="bound">X'</span> <span class="bound">Y'</span> <span class="main">∧</span> eq <span class="free">X</span> <span class="bound">X'</span> <span class="main">∧</span> eq <span class="free">Y</span> <span class="bound">Y'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> eq.induct <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∀</span></span> <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">Y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">=</span></span> cPair <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">Y</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∃</span></span> <span class="bound"><span class="bound">X'</span></span> <span class="bound"><span class="bound">Y'</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">=</span></span> cPair <span class="bound"><span class="bound">X'</span></span> <span class="bound"><span class="bound">Y'</span></span> <span class="main"><span class="main">∧</span></span> eq <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">X'</span></span> <span class="main"><span class="main">∧</span></span> eq <span class="bound"><span class="bound">Y</span></span> <span class="bound"><span class="bound">Y'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Tr<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1" id="Messages-eq_Enc"><span class="command">lemma</span></span> eq_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cEnc <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="main">∃</span> <span class="bound">X'</span> <span class="bound">Y'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> cEnc <span class="bound">X'</span> <span class="bound">Y'</span> <span class="main">∧</span> eq <span class="free">X</span> <span class="bound">X'</span> <span class="main">∧</span> eq <span class="free">Y</span> <span class="bound">Y'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> eq.induct <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∀</span></span> <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">Y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">=</span></span> cEnc <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">Y</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∃</span></span> <span class="bound"><span class="bound">X'</span></span> <span class="bound"><span class="bound">Y'</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">=</span></span> cEnc <span class="bound"><span class="bound">X'</span></span> <span class="bound"><span class="bound">Y'</span></span> <span class="main"><span class="main">∧</span></span> eq <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">X'</span></span> <span class="main"><span class="main">∧</span></span> eq <span class="bound"><span class="bound">Y</span></span> <span class="bound"><span class="bound">Y'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Tr<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1" id="Messages-eq_Aenc"><span class="command">lemma</span></span> eq_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cAenc <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="main">∃</span> <span class="bound">X'</span> <span class="bound">Y'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> cAenc <span class="bound">X'</span> <span class="bound">Y'</span> <span class="main">∧</span> eq <span class="free">X</span> <span class="bound">X'</span> <span class="main">∧</span> eq <span class="free">Y</span> <span class="bound">Y'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> eq.induct <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∀</span></span> <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">Y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">=</span></span> cAenc <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">Y</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∃</span></span> <span class="bound"><span class="bound">X'</span></span> <span class="bound"><span class="bound">Y'</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">=</span></span> cAenc <span class="bound"><span class="bound">X'</span></span> <span class="bound"><span class="bound">Y'</span></span> <span class="main"><span class="main">∧</span></span> eq <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">X'</span></span> <span class="main"><span class="main">∧</span></span> eq <span class="bound"><span class="bound">Y</span></span> <span class="bound"><span class="bound">Y'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Tr<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1" id="Messages-eq_Sign"><span class="command">lemma</span></span> eq_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cSign <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="main">∃</span> <span class="bound">X'</span> <span class="bound">Y'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> cSign <span class="bound">X'</span> <span class="bound">Y'</span> <span class="main">∧</span> eq <span class="free">X</span> <span class="bound">X'</span> <span class="main">∧</span> eq <span class="free">Y</span> <span class="bound">Y'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> eq.induct <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∀</span></span> <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">Y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">=</span></span> cSign <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">Y</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∃</span></span> <span class="bound"><span class="bound">X'</span></span> <span class="bound"><span class="bound">Y'</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">=</span></span> cSign <span class="bound"><span class="bound">X'</span></span> <span class="bound"><span class="bound">Y'</span></span> <span class="main"><span class="main">∧</span></span> eq <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">X'</span></span> <span class="main"><span class="main">∧</span></span> eq <span class="bound"><span class="bound">Y</span></span> <span class="bound"><span class="bound">Y'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Tr<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1" id="Messages-eq_Exp"><span class="command">lemma</span></span> eq_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="main">(</span>cExp <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="free">y</span> <span class="main">⟹</span>  <span class="main">∃</span> <span class="bound">X'</span> <span class="bound">Y'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> cExp <span class="bound">X'</span> <span class="bound">Y'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> eq.induct <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∀</span></span> <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">Y</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">=</span></span> cExp <span class="bound"><span class="bound">X</span></span> <span class="bound"><span class="bound">Y</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∃</span></span> <span class="bound"><span class="bound">X'</span></span> <span class="bound"><span class="bound">Y'</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">=</span></span> cExp <span class="bound"><span class="bound">X'</span></span> <span class="bound"><span class="bound">Y'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Tr<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> eqD_aux <span class="main">=</span> eq_Number eq_Agent eq_Nonce eq_LtK eq_EphK eq_Tag
                    eq_Hash eq_Pair eq_Enc eq_Aenc eq_Sign eq_Exp
<span class="keyword1"><span class="command">lemmas</span></span> eqD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span> <span class="main">=</span> eqD_aux eqD_aux <span class="main">[</span><span class="operator">OF</span> eq_Sym<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Quotient construction›</span></span>

<span class="keyword1"><span class="command">quotient_type</span></span> msg <span class="main">=</span> <span class="quoted">cmsg</span> <span class="main">/</span> <span class="quoted">eq</span>
<span class="keyword2"><span class="keyword">morphisms</span></span> Re Ab
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equivp_def<span class="main">)</span>


<span class="keyword1"><span class="command">lift_definition</span></span> Number <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cNumber</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command">lift_definition</span></span> Nonce <span class="main">::</span> <span class="quoted"><span class="quoted">"nonce_t <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cNonce</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command">lift_definition</span></span> Agent <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cAgent</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command">lift_definition</span></span> LtK <span class="main">::</span> <span class="quoted"><span class="quoted">"ltkey <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cLtK</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command">lift_definition</span></span> EphK <span class="main">::</span> <span class="quoted"><span class="quoted">"ephkey <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cEphK</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command">lift_definition</span></span> Pair <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cPair</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lift_definition</span></span> Enc <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cEnc</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lift_definition</span></span> Aenc <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cAenc</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lift_definition</span></span> Exp <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cExp</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lift_definition</span></span> Tag <span class="main">::</span> <span class="quoted"><span class="quoted">"tag <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cTag</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command">lift_definition</span></span> Hash <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cHash</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lift_definition</span></span> Sign <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cSign</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> msg_defs <span class="main">=</span> 
  Agent_def Number_def Nonce_def LtK_def EphK_def Pair_def 
  Enc_def Aenc_def Exp_def Hash_def Tag_def Sign_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Commutativity of exponents›</span></span>

<span class="keyword1" id="Messages-permute_exp"><span class="command">lemma</span></span> permute_exp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="main">(</span>Exp <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="free">Z</span> <span class="main">=</span> Exp <span class="main">(</span>Exp <span class="free">X</span> <span class="free">Z</span><span class="main">)</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> atomic <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">catomic</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> eq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">composed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">composed</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">¬</span>atomic <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1" id="Messages-atomic_Agent"><span class="command">lemma</span></span> atomic_Agent <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atomic <span class="main">(</span>Agent <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-atomic_Tag"><span class="command">lemma</span></span> atomic_Tag <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atomic <span class="main">(</span>Tag <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-atomic_Nonce"><span class="command">lemma</span></span> atomic_Nonce <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atomic <span class="main">(</span>Nonce <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-atomic_Number"><span class="command">lemma</span></span> atomic_Number <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atomic <span class="main">(</span>Number <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-atomic_LtK"><span class="command">lemma</span></span> atomic_LtK <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atomic <span class="main">(</span>LtK <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-atomic_EphK"><span class="command">lemma</span></span> atomic_EphK <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atomic <span class="main">(</span>EphK <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Messages-non_atomic_Pair"><span class="command">lemma</span></span> non_atomic_Pair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>atomic <span class="main">(</span>Pair <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-non_atomic_Enc"><span class="command">lemma</span></span> non_atomic_Enc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>atomic <span class="main">(</span>Enc <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-non_atomic_Aenc"><span class="command">lemma</span></span> non_atomic_Aenc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>atomic <span class="main">(</span>Aenc <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-non_atomic_Sign"><span class="command">lemma</span></span> non_atomic_Sign <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>atomic <span class="main">(</span>Sign <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-non_atomic_Exp"><span class="command">lemma</span></span> non_atomic_Exp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>atomic <span class="main">(</span>Exp <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1" id="Messages-non_atomic_Hash"><span class="command">lemma</span></span> non_atomic_Hash <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>atomic <span class="main">(</span>Hash <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Messages-Nonce_Nonce"><span class="command">lemma</span></span> Nonce_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Nonce <span class="free">X</span> <span class="main">=</span> Nonce <span class="free">X'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_Agent"><span class="command">lemma</span></span> Nonce_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> Agent <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_Number"><span class="command">lemma</span></span> Nonce_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> Number <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_Hash"><span class="command">lemma</span></span> Nonce_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_Tag"><span class="command">lemma</span></span> Nonce_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_EphK"><span class="command">lemma</span></span> Nonce_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_LtK"><span class="command">lemma</span></span> Nonce_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_Pair"><span class="command">lemma</span></span> Nonce_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_Enc"><span class="command">lemma</span></span> Nonce_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_Aenc"><span class="command">lemma</span></span> Nonce_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_Sign"><span class="command">lemma</span></span> Nonce_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Nonce_Exp"><span class="command">lemma</span></span> Nonce_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">X</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-Agent_Nonce"><span class="command">lemma</span></span> Agent_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_Agent"><span class="command">lemma</span></span> Agent_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Agent <span class="free">X</span> <span class="main">=</span> Agent <span class="free">X'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_Number"><span class="command">lemma</span></span> Agent_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> Number  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_Hash"><span class="command">lemma</span></span> Agent_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_Tag"><span class="command">lemma</span></span> Agent_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_EphK"><span class="command">lemma</span></span> Agent_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_LtK"><span class="command">lemma</span></span> Agent_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_Pair"><span class="command">lemma</span></span> Agent_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_Enc"><span class="command">lemma</span></span> Agent_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_Aenc"><span class="command">lemma</span></span> Agent_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_Sign"><span class="command">lemma</span></span> Agent_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Agent_Exp"><span class="command">lemma</span></span> Agent_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">X</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-Number_Nonce"><span class="command">lemma</span></span> Number_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_Agent"><span class="command">lemma</span></span> Number_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> Agent  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_Number"><span class="command">lemma</span></span> Number_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Number <span class="free">X</span> <span class="main">=</span> Number <span class="free">X'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_Hash"><span class="command">lemma</span></span> Number_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_Tag"><span class="command">lemma</span></span> Number_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_EphK"><span class="command">lemma</span></span> Number_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_LtK"><span class="command">lemma</span></span> Number_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_Pair"><span class="command">lemma</span></span> Number_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_Enc"><span class="command">lemma</span></span> Number_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_Aenc"><span class="command">lemma</span></span> Number_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_Sign"><span class="command">lemma</span></span> Number_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Number_Exp"><span class="command">lemma</span></span> Number_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">X</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-Hash_Nonce"><span class="command">lemma</span></span> Hash_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_Agent"><span class="command">lemma</span></span> Hash_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> Agent  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_Number"><span class="command">lemma</span></span> Hash_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> Number  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_Hash"><span class="command">lemma</span></span> Hash_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Hash <span class="free">X</span> <span class="main">=</span> Hash <span class="free">X'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_Tag"><span class="command">lemma</span></span> Hash_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_EphK"><span class="command">lemma</span></span> Hash_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_LtK"><span class="command">lemma</span></span> Hash_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_Pair"><span class="command">lemma</span></span> Hash_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_Enc"><span class="command">lemma</span></span> Hash_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_Aenc"><span class="command">lemma</span></span> Hash_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_Sign"><span class="command">lemma</span></span> Hash_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Hash_Exp"><span class="command">lemma</span></span> Hash_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-Tag_Nonce"><span class="command">lemma</span></span> Tag_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_Agent"><span class="command">lemma</span></span> Tag_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> Agent  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_Number"><span class="command">lemma</span></span> Tag_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> Number  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_Hash"><span class="command">lemma</span></span> Tag_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_Tag"><span class="command">lemma</span></span> Tag_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Tag <span class="free">X</span> <span class="main">=</span> Tag <span class="free">X'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_EphK"><span class="command">lemma</span></span> Tag_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_LtK"><span class="command">lemma</span></span> Tag_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_Pair"><span class="command">lemma</span></span> Tag_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_Enc"><span class="command">lemma</span></span> Tag_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_Aenc"><span class="command">lemma</span></span> Tag_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_Sign"><span class="command">lemma</span></span> Tag_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Tag_Exp"><span class="command">lemma</span></span> Tag_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-EphK_Nonce"><span class="command">lemma</span></span> EphK_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_Agent"><span class="command">lemma</span></span> EphK_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> Agent  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_Number"><span class="command">lemma</span></span> EphK_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> Number  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_Hash"><span class="command">lemma</span></span> EphK_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_Tag"><span class="command">lemma</span></span> EphK_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_EphK"><span class="command">lemma</span></span> EphK_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>EphK <span class="free">X</span> <span class="main">=</span> EphK <span class="free">X'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_LtK"><span class="command">lemma</span></span> EphK_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_Pair"><span class="command">lemma</span></span> EphK_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_Enc"><span class="command">lemma</span></span> EphK_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_Aenc"><span class="command">lemma</span></span> EphK_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_Sign"><span class="command">lemma</span></span> EphK_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-EphK_Exp"><span class="command">lemma</span></span> EphK_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-LtK_Nonce"><span class="command">lemma</span></span> LtK_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_Agent"><span class="command">lemma</span></span> LtK_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> Agent  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_Number"><span class="command">lemma</span></span> LtK_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> Number  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_Hash"><span class="command">lemma</span></span> LtK_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_Tag"><span class="command">lemma</span></span> LtK_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_EphK"><span class="command">lemma</span></span> LtK_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_LtK"><span class="command">lemma</span></span> LtK_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>LtK <span class="free">X</span> <span class="main">=</span> LtK <span class="free">X'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_Pair"><span class="command">lemma</span></span> LtK_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_Enc"><span class="command">lemma</span></span> LtK_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_Aenc"><span class="command">lemma</span></span> LtK_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_Sign"><span class="command">lemma</span></span> LtK_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-LtK_Exp"><span class="command">lemma</span></span> LtK_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-Pair_Nonce"><span class="command">lemma</span></span> Pair_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_Agent"><span class="command">lemma</span></span> Pair_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Agent  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_Number"><span class="command">lemma</span></span> Pair_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Number  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_Hash"><span class="command">lemma</span></span> Pair_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_Tag"><span class="command">lemma</span></span> Pair_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_EphK"><span class="command">lemma</span></span> Pair_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_LtK"><span class="command">lemma</span></span> Pair_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_Pair"><span class="command">lemma</span></span> Pair_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">=</span> Pair <span class="free">X'</span> <span class="free">Y'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="free">Y'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_Enc"><span class="command">lemma</span></span> Pair_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_Aenc"><span class="command">lemma</span></span> Pair_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_Sign"><span class="command">lemma</span></span> Pair_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Pair_Exp"><span class="command">lemma</span></span> Pair_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-Enc_Nonce"><span class="command">lemma</span></span> Enc_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_Agent"><span class="command">lemma</span></span> Enc_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Agent  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_Number"><span class="command">lemma</span></span> Enc_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Number  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_Hash"><span class="command">lemma</span></span> Enc_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_Tag"><span class="command">lemma</span></span> Enc_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_EphK"><span class="command">lemma</span></span> Enc_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_LtK"><span class="command">lemma</span></span> Enc_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_Pair"><span class="command">lemma</span></span> Enc_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_Enc"><span class="command">lemma</span></span> Enc_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">=</span> Enc <span class="free">X'</span> <span class="free">Y'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="free">Y'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_Aenc"><span class="command">lemma</span></span> Enc_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_Sign"><span class="command">lemma</span></span> Enc_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Enc_Exp"><span class="command">lemma</span></span> Enc_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-Aenc_Nonce"><span class="command">lemma</span></span> Aenc_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_Agent"><span class="command">lemma</span></span> Aenc_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Agent  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_Number"><span class="command">lemma</span></span> Aenc_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Number  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_Hash"><span class="command">lemma</span></span> Aenc_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_Tag"><span class="command">lemma</span></span> Aenc_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_EphK"><span class="command">lemma</span></span> Aenc_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_LtK"><span class="command">lemma</span></span> Aenc_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_Pair"><span class="command">lemma</span></span> Aenc_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_Enc"><span class="command">lemma</span></span> Aenc_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_Aenc"><span class="command">lemma</span></span> Aenc_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">=</span> Aenc <span class="free">X'</span> <span class="free">Y'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="free">Y'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_Sign"><span class="command">lemma</span></span> Aenc_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Aenc_Exp"><span class="command">lemma</span></span> Aenc_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-Sign_Nonce"><span class="command">lemma</span></span> Sign_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_Agent"><span class="command">lemma</span></span> Sign_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Agent  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_Number"><span class="command">lemma</span></span> Sign_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Number  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_Hash"><span class="command">lemma</span></span> Sign_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_Tag"><span class="command">lemma</span></span> Sign_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_EphK"><span class="command">lemma</span></span> Sign_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_LtK"><span class="command">lemma</span></span> Sign_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_Pair"><span class="command">lemma</span></span> Sign_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_Enc"><span class="command">lemma</span></span> Sign_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_Aenc"><span class="command">lemma</span></span> Sign_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_Sign"><span class="command">lemma</span></span> Sign_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">=</span> Sign <span class="free">X'</span> <span class="free">Y'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="free">X'</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">=</span> <span class="free">Y'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Sign_Exp"><span class="command">lemma</span></span> Sign_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Exp  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Messages-Exp_Nonce"><span class="command">lemma</span></span> Exp_Nonce<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Nonce  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Exp_Agent"><span class="command">lemma</span></span> Exp_Agent<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Agent  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Exp_Number"><span class="command">lemma</span></span> Exp_Number<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Number  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Exp_Hash"><span class="command">lemma</span></span> Exp_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Hash  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Exp_Tag"><span class="command">lemma</span></span> Exp_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Tag  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Exp_EphK"><span class="command">lemma</span></span> Exp_EphK<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> EphK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Exp_LtK"><span class="command">lemma</span></span> Exp_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> LtK  <span class="free">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Exp_Pair"><span class="command">lemma</span></span> Exp_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Pair  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Exp_Enc"><span class="command">lemma</span></span> Exp_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Enc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Exp_Aenc"><span class="command">lemma</span></span> Exp_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Aenc  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Messages-Exp_Sign"><span class="command">lemma</span></span> Exp_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">≠</span> Sign  <span class="free">X'</span> <span class="free">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemmas</span></span> msg_inject <span class="main">[</span><span class="operator">iff</span><span class="main">,</span> <span class="operator">induct_simp</span><span class="main">]</span> <span class="main">=</span>
  Nonce_Nonce Agent_Agent Number_Number Hash_Hash Tag_Tag EphK_EphK LtK_LtK 
  Pair_Pair Enc_Enc Aenc_Aenc Sign_Sign

<span class="keyword1"><span class="command">lemmas</span></span> msg_distinct <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">induct_simp</span><span class="main">]</span> <span class="main">=</span>
  Nonce_Agent Nonce_Number Nonce_Hash Nonce_Tag Nonce_EphK Nonce_LtK Nonce_Pair 
  Nonce_Enc Nonce_Aenc Nonce_Sign Nonce_Exp 
  Agent_Nonce Agent_Number Agent_Hash Agent_Tag Agent_EphK Agent_LtK Agent_Pair 
  Agent_Enc Agent_Aenc Agent_Sign Agent_Exp 
  Number_Nonce Number_Agent Number_Hash Number_Tag Number_EphK Number_LtK 
  Number_Pair Number_Enc Number_Aenc Number_Sign Number_Exp 
  Hash_Nonce Hash_Agent Hash_Number Hash_Tag Hash_EphK Hash_LtK Hash_Pair 
  Hash_Enc Hash_Aenc Hash_Sign Hash_Exp 
  Tag_Nonce Tag_Agent Tag_Number Tag_Hash Tag_EphK Tag_LtK Tag_Pair 
  Tag_Enc Tag_Aenc Tag_Sign Tag_Exp 
  EphK_Nonce EphK_Agent EphK_Number EphK_Hash EphK_Tag EphK_LtK EphK_Pair 
  EphK_Enc EphK_Aenc EphK_Sign EphK_Exp 
  LtK_Nonce LtK_Agent LtK_Number LtK_Hash LtK_Tag LtK_EphK LtK_Pair 
  LtK_Enc LtK_Aenc LtK_Sign LtK_Exp 
  Pair_Nonce Pair_Agent Pair_Number Pair_Hash Pair_Tag Pair_EphK Pair_LtK 
  Pair_Enc Pair_Aenc Pair_Sign Pair_Exp 
  Enc_Nonce Enc_Agent Enc_Number Enc_Hash Enc_Tag Enc_EphK Enc_LtK Enc_Pair 
  Enc_Aenc Enc_Sign Enc_Exp 
  Aenc_Nonce Aenc_Agent Aenc_Number Aenc_Hash Aenc_Tag Aenc_EphK Aenc_LtK 
  Aenc_Pair Aenc_Enc Aenc_Sign Aenc_Exp 
  Sign_Nonce Sign_Agent Sign_Number Sign_Hash Sign_Tag Sign_EphK Sign_LtK 
  Sign_Pair Sign_Enc Sign_Aenc Sign_Exp 
  Exp_Nonce Exp_Agent Exp_Number Exp_Hash Exp_Tag Exp_EphK Exp_LtK Exp_Pair 
  Exp_Enc Exp_Aenc Exp_Sign 


<span class="keyword1"><span class="command">consts</span></span> Ngen <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Gen</span> <span class="main">≡</span> Number Ngen"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">cGen</span> <span class="main">≡</span> cNumber Ngen"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">InsecTag</span> <span class="main">≡</span> Tag insec"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">AuthTag</span> <span class="main">≡</span> Tag auth"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ConfidTag</span> <span class="main">≡</span> Tag confid"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">SecureTag</span> <span class="main">≡</span> Tag secure"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Tags</span> <span class="main">≡</span> range Tag"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">NonceF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fresh_t <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NonceF</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> Nonce <span class="main">(</span>nonce_fresh <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">NonceA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NonceA</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> Nonce <span class="main">(</span>nonce_atk <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">shrK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shrK</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> LtK <span class="main">(</span>sharK <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">pubK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pubK</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> LtK <span class="main">(</span>publK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">priK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">priK</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> LtK <span class="main">(</span>privK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">epubK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nonce_t <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">epubK</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> EphK <span class="main">(</span>epublK <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">epriK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nonce_t <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">epriK</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> EphK <span class="main">(</span>eprivK <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">epubKF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fresh_t <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">epubKF</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> EphK <span class="main">(</span>epublK <span class="main">(</span>nonce_fresh <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">epriKF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fresh_t <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">epriKF</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> EphK <span class="main">(</span>eprivK <span class="main">(</span>nonce_fresh <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">epubKA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">epubKA</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> EphK <span class="main">(</span>epublK <span class="main">(</span>nonce_atk <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">epriKA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">epriKA</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> EphK <span class="main">(</span>eprivK <span class="main">(</span>nonce_atk <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Concrete syntax: messages appear as &lt;A,B,NA&gt;, etc...›</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_MTuple"</span>      <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> args<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span>"</span></span>       <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">⟨</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword1">⟩</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">⟨</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">⟩</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="main">⟨</span><span class="free">x</span><span class="main">,</span> <span class="main">⟨</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">⟩</span><span class="main">⟩</span>"</span>
  <span class="quoted">"<span class="main">⟨</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">⟩</span>"</span>    <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> Pair <span class="free">x</span> <span class="free">y</span>"</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹hash macs›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">hmac</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hmac</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> Hash <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">⟩</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹recover some kind of injectivity for Exp›</span></span>
<span class="keyword1" id="Messages-eq_expgen"><span class="command">lemma</span></span> eq_expgen<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"eq <span class="free">X</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">X'</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> cExp cGen <span class="bound">X'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span>cExp cGen <span class="bound">Z</span><span class="main">)</span> <span class="main">∧</span> eq <span class="bound">X'</span> <span class="bound">Z</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span> <span class="bound">Y'</span><span class="main">.</span> <span class="free">Y</span> <span class="main">=</span> cExp cGen <span class="bound">Y'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Z</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span>cExp cGen <span class="bound">Z</span><span class="main">)</span> <span class="main">∧</span> eq <span class="bound">Y'</span> <span class="bound">Z</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> eq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Tr<span class="main">)</span>

<span class="keyword1" id="Messages-Exp_Gen_inj"><span class="command">lemma</span></span> Exp_Gen_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp Gen <span class="free">X</span> <span class="main">=</span> Exp Gen <span class="free">Y</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_expgen<span class="main">)</span>


<span class="keyword1" id="Messages-eq_expexpgen"><span class="command">lemma</span></span> eq_expexpgen<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"eq <span class="free">X</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">X'</span> <span class="bound">X''</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> cExp <span class="main">(</span>cExp cGen <span class="bound">X'</span><span class="main">)</span> <span class="bound">X''</span> <span class="main">⟶</span> 
                <span class="main">(</span><span class="main">∃</span> <span class="bound">Y'</span> <span class="bound">Y''</span><span class="main">.</span> <span class="free">Y</span> <span class="main">=</span> cExp <span class="main">(</span>cExp cGen <span class="bound">Y'</span><span class="main">)</span> <span class="bound">Y''</span> <span class="main">∧</span> 
                   <span class="main">(</span><span class="main">(</span>eq <span class="bound">X'</span> <span class="bound">Y'</span> <span class="main">∧</span> eq <span class="bound">X''</span> <span class="bound">Y''</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>eq <span class="bound">X'</span> <span class="bound">Y''</span> <span class="main">∧</span> eq <span class="bound">X''</span> <span class="bound">Y'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> eq_expgen<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Messages-Exp_Exp_Gen_inj"><span class="command">lemma</span></span> Exp_Exp_Gen_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Exp <span class="main">(</span>Exp Gen <span class="free">X</span><span class="main">)</span> <span class="free">X'</span> <span class="main">=</span> <span class="free">Z</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∃</span> <span class="bound">Y</span> <span class="bound">Y'</span><span class="main">.</span> <span class="free">Z</span> <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="bound">Y</span><span class="main">)</span> <span class="bound">Y'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="free">X'</span> <span class="main">=</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="bound">Y'</span> <span class="main">∧</span> <span class="free">X'</span> <span class="main">=</span> <span class="bound">Y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_expexpgen<span class="main">)</span>

<span class="keyword1" id="Messages-Exp_Exp_Gen_inj2"><span class="command">lemma</span></span> Exp_Exp_Gen_inj2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Exp <span class="main">(</span>Exp Gen <span class="free">X</span><span class="main">)</span> <span class="free">X'</span> <span class="main">=</span> Exp <span class="free">Z</span> <span class="free">Y'</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">Y'</span> <span class="main">=</span> <span class="free">X</span> <span class="main">∧</span> <span class="free">Z</span> <span class="main">=</span> Exp Gen <span class="free">X'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">Y'</span> <span class="main">=</span> <span class="free">X'</span> <span class="main">∧</span> <span class="free">Z</span> <span class="main">=</span> Exp Gen <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> eq_expexpgen<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Message_derivation">
<div class="head">
<h1>Theory Message_derivation</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Message_derivation.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Message_derivation.thy 132885 2016-12-23 18:41:32Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  A theory of message derivations (analz, synth, parts).
  Based on Larry Paulson's theory HOL/Auth/Message.thy, but extended with
  - composed keys
  - including ephemeral asymmetric keys
  - Diffie-Hellman exponentiation and associated equational theory

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Message theory›</span></span> 

<span class="keyword1"><span class="command">theory</span></span> Message_derivation
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Messages.html">Messages</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory is adapted from Larry Paulson's original Message theory.›</span></span>


<span class="comment1">(****************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Message composition›</span></span>
<span class="comment1">(****************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Dolev-Yao message synthesis.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">synth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span>   
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    Ax <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Agent <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Number <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> NonceA <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"NonceA <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> EpubKA <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"epubKA <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> EpriKA <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"epriKA <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Hash <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> Hash <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Pair <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Enc <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span>Enc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Aenc <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span>Aenc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Sign <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> Sign <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Exp <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about Dolev-Yao message synthesis.›</span></span>

<span class="keyword1" id="Message_derivation-synth_mono"><span class="command">lemma</span></span> synth_mono <span class="main">[</span><span class="operator">mono_set</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> synth <span class="free">G</span> <span class="main">⊆</span> synth <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> synth.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemmas</span></span> synth_monotone <span class="main">=</span> synth_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>[elim!]›</span></span> slows down certain proofs, e.g., <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>⟦ synth H ∩ B ⊆ {} ⟧ ⟹ P›</span></span>›</span>
<span class="keyword1"><span class="command">inductive_cases</span></span> NonceF_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"NonceF <span class="free">n</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> LtK_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> EpubKF_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"epubKF <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> EpriKF_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"epriKF <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> Hash_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> Pair_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> Enc_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> Aenc_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> Sign_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> Tag_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">t</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>

<span class="keyword1" id="Message_derivation-EpriK_synth"><span class="command">lemma</span></span> EpriK_synth <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"epriK <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span> <span class="main">⟹</span>
       epriK <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">N</span><span class="main">.</span> epriK <span class="free">K</span> <span class="main">=</span> epriKA <span class="bound">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">K</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> EpriKF_synth<span class="main">)</span>

<span class="keyword1" id="Message_derivation-EpubK_synth"><span class="command">lemma</span></span> EpubK_synth <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"epubK <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span> <span class="main">⟹</span>
       epubK <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">N</span><span class="main">.</span> epubK <span class="free">K</span> <span class="main">=</span> epubKA <span class="bound">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">K</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> EpubKF_synth<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> synth_inversion <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  NonceF_synth LtK_synth EpubKF_synth EpriKF_synth Hash_synth Pair_synth 
  Enc_synth Aenc_synth Sign_synth Tag_synth


<span class="keyword1" id="Message_derivation-synth_increasing"><span class="command">lemma</span></span> synth_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-synth_Int1"><span class="command">lemma</span></span> synth_Int1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> synth <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> synth <span class="free">A</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> synth.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_Int2"><span class="command">lemma</span></span> synth_Int2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> synth <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> synth <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> synth.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_Int"><span class="command">lemma</span></span> synth_Int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> synth <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> synth <span class="free">A</span> <span class="main">∩</span> synth <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_Int1 synth_Int2<span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_Un"><span class="command">lemma</span></span> synth_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"synth <span class="free">G</span> <span class="main">∪</span> synth <span class="free">H</span> <span class="main">⊆</span> synth <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Un_least synth_mono Un_upper1 Un_upper2<span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_insert"><span class="command">lemma</span></span> synth_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">X</span> <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_synthD"><span class="command">lemma</span></span> synth_synthD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> synth.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_idem"><span class="command">lemma</span></span> synth_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-synth_subset_iff"><span class="command">lemma</span></span> synth_subset_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"synth <span class="free">G</span> <span class="main">⊆</span> synth <span class="free">H</span> <span class="main">⟷</span> <span class="free">G</span> <span class="main">⊆</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_mono<span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_trans"><span class="command">lemma</span></span> synth_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> synth <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_cut"><span class="command">lemma</span></span> synth_cut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">;</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> synth_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1" id="Message_derivation-Nonce_synth_eq"><span class="command">lemma</span></span> Nonce_synth_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NonceF <span class="free">N</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>NonceF <span class="free">N</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-LtK_synth_eq"><span class="command">lemma</span></span> LtK_synth_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>LtK <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LtK <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-EpubKF_synth_eq"><span class="command">lemma</span></span> EpubKF_synth_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>epubKF <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>epubKF <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-EpriKF_synth_eq"><span class="command">lemma</span></span> EpriKF_synth_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>epriKF <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>epriKF <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-Enc_synth_eq1"><span class="command">lemma</span></span> Enc_synth_eq1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> synth <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span>Enc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Enc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-Enc_synth_eq2"><span class="command">lemma</span></span> Enc_synth_eq2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∉</span> synth <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span>Enc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Enc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-Aenc_synth_eq1"><span class="command">lemma</span></span> Aenc_synth_eq1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> synth <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span>Aenc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Aenc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-Aenc_synth_eq2"><span class="command">lemma</span></span> Aenc_synth_eq2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∉</span> synth <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span>Aenc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Aenc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-Sign_synth_eq1"><span class="command">lemma</span></span> Sign_synth_eq1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> synth <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span>Sign <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Sign <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-Sign_synth_eq2"><span class="command">lemma</span></span> Sign_synth_eq2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∉</span> synth <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span>Sign <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Sign <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(****************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Message decomposition›</span></span>
<span class="comment1">(****************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Dolev-Yao message decomposition using known keys.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">analz</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    Ax <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Fst<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Snd<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Dec <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Enc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> synth <span class="main">(</span><span class="free">analz</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Adec_lt <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Aenc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>LtK <span class="main">(</span>publK <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span><span class="main">;</span> priK <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Adec_eph <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Aenc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>EphK <span class="main">(</span>epublK <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span><span class="main">;</span> epriK <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> synth <span class="main">(</span><span class="free">analz</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Sign_getmsg <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"Sign <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>priK <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span> <span class="main">⟹</span> pubK <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about Dolev-Yao message decomposition.›</span></span>

<span class="keyword1" id="Message_derivation-analz_mono"><span class="command">lemma</span></span> analz_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> analz<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> analz<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> analz.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Fst Snd synth_Int2<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_monotone <span class="main">=</span> analz_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>


<span class="keyword1" id="Message_derivation-Pair_analz"><span class="command">lemma</span></span> Pair_analz <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">∈</span> analz <span class="free">H</span><span class="main">;</span> <span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span><span class="main">;</span> <span class="free">Y</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz.Fst analz.Snd<span class="main">)</span>


<span class="keyword1" id="Message_derivation-analz_empty"><span class="command">lemma</span></span> analz_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> analz.induct<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-analz_increasing"><span class="command">lemma</span></span> analz_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> analz<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Message_derivation-analz_analzD"><span class="command">lemma</span></span> analz_analzD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_monotone<span class="main">)</span>

<span class="keyword1" id="Message_derivation-analz_idem"><span class="command">lemma</span></span> analz_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="Message_derivation-analz_Un"><span class="command">lemma</span></span> analz_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="free">G</span> <span class="main">∪</span> analz <span class="free">H</span> <span class="main">⊆</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Un_least analz_mono Un_upper1 Un_upper2<span class="main">)</span>

<span class="keyword1" id="Message_derivation-analz_insertI"><span class="command">lemma</span></span> analz_insertI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">Y</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotone<span class="main">)</span>

<span class="keyword1" id="Message_derivation-analz_insert"><span class="command">lemma</span></span> analz_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">X</span> <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotone<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_insert_eq_I <span class="main">=</span> equalityI <span class="main">[</span><span class="operator">OF</span> subsetI analz_insert<span class="main">]</span>


<span class="keyword1" id="Message_derivation-analz_subset_iff"><span class="command">lemma</span></span> analz_subset_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="free">G</span> <span class="main">⊆</span> analz <span class="free">H</span> <span class="main">⟷</span> <span class="free">G</span> <span class="main">⊆</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz_mono<span class="main">)</span>

<span class="keyword1" id="Message_derivation-analz_trans"><span class="command">lemma</span></span> analz_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="free">G</span> <span class="main">⟹</span>  <span class="free">G</span> <span class="main">⊆</span> analz <span class="free">H</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> analz_mono<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-analz_cut"><span class="command">lemma</span></span> analz_cut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> analz_trans<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-analz_insert_eq"><span class="command">lemma</span></span> analz_insert_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">⟹</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_cut analz_insertI<span class="main">)</span>


<span class="keyword1" id="Message_derivation-analz_subset_cong"><span class="command">lemma</span></span> analz_subset_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="free">G</span> <span class="main">⊆</span> analz <span class="free">G'</span> <span class="main">⟹</span>
   analz <span class="free">H</span> <span class="main">⊆</span> analz <span class="free">H'</span> <span class="main">⟹</span> 
   analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> analz <span class="main">(</span><span class="free">G'</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> conjI subset_trans analz_mono Un_upper1 Un_upper2<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Message_derivation-analz_cong"><span class="command">lemma</span></span> analz_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="free">G</span> <span class="main">=</span> analz <span class="free">G'</span> <span class="main">⟹</span>
   analz <span class="free">H</span> <span class="main">=</span> analz <span class="free">H'</span> <span class="main">⟹</span>
   analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G'</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI analz_subset_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> 

<span class="keyword1" id="Message_derivation-analz_insert_cong"><span class="command">lemma</span></span> analz_insert_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="free">H</span> <span class="main">=</span> analz <span class="free">H'</span> <span class="main">⟹</span>
   analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_cong<span class="main">)</span>

<span class="keyword1" id="Message_derivation-analz_trivial"><span class="command">lemma</span></span> analz_trivial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> Pair <span class="bound">X</span> <span class="bound">Y</span> <span class="main">∉</span> <span class="free">H</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> Enc <span class="bound">X</span> <span class="bound">Y</span> <span class="main">∉</span> <span class="free">H</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> Aenc <span class="bound">X</span> <span class="bound">Y</span> <span class="main">∉</span> <span class="free">H</span> <span class="main">⟹</span>
   <span class="main">∀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> Sign <span class="bound">X</span> <span class="bound">Y</span> <span class="main">∉</span> <span class="free">H</span> <span class="main">⟹</span>
   analz <span class="free">H</span> <span class="main">=</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="Message_derivation-analz_analz_Un"><span class="command">lemma</span></span> analz_analz_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>analz <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> equalityI analz_subset_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Message_derivation-analz_Un_analz"><span class="command">lemma</span></span> analz_Un_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> analz <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Un_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about analz and insert.›</span></span> 

<span class="keyword1" id="Message_derivation-analz_insert_Agent"><span class="command">lemma</span></span> analz_insert_Agent <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="main">(</span>insert <span class="main">(</span>Agent <span class="free">A</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Agent <span class="free">A</span><span class="main">)</span> <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_insert_eq_I<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main">)</span>
<span class="keyword1"><span class="command">thm</span></span> analz.induct
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> 1
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> 1
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x X Y<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Enc <span class="improper"><span class="improper"><span class="improper">X</span></span></span> <span class="improper"><span class="improper"><span class="improper">Y</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Z</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Z</span></span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_Int2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> X Y<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"epriK <span class="improper">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Aenc <span class="improper"><span class="improper"><span class="improper">X</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>epubK <span class="improper"><span class="improper"><span class="improper">Y</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Z</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Z</span></span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="comment1">(****************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about combined composition/decomposition›</span></span>
<span class="comment1">(****************************************************************************************)</span>

<span class="keyword1" id="Message_derivation-synth_analz_incr"><span class="command">lemma</span></span> synth_analz_incr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> synth_analz_increasing <span class="main">=</span> synth_analz_incr <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span> 

<span class="keyword1" id="Message_derivation-synth_analz_mono"><span class="command">lemma</span></span> synth_analz_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> synth <span class="main">(</span>analz <span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_mono synth_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> synth_analz_monotone <span class="main">=</span> synth_analz_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1" id="Message_derivation-lem1"><span class="command">lemma</span></span> lem1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>synth <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> synth <span class="free">G</span><span class="main">)</span><span class="main">)</span> 
<span class="main">⟹</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> synth_subset_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_increasing synth_monotone<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Message_derivation-lem2"><span class="command">lemma</span></span> lem2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">a</span> <span class="main">∈</span> synth <span class="free">G</span><span class="main">}</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> synth <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Message_derivation-analz_synth_Un"><span class="command">lemma</span></span> analz_synth_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>synth <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> synth <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> analz <span class="main">(</span>synth <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> synth <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lem2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotone Fst Snd Dec Adec_eph Adec_lt Sign_getmsg 
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lem1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> synth <span class="free">G</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> analz <span class="main">(</span>synth <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotone<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Message_derivation-analz_synth"><span class="command">lemma</span></span> analz_synth<span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="free">H</span> <span class="main">∪</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_synth_Un <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{}</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1" id="Message_derivation-analz_synth_Un2"><span class="command">lemma</span></span> analz_synth_Un2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Un_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_synth_Un<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1" id="Message_derivation-synth_analz_synth"><span class="command">lemma</span></span> synth_analz_synth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>analz <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>subsetI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> synth_subset_iff analz_synth<span class="main">)</span>

<span class="keyword1" id="Message_derivation-analz_synth_analz"><span class="command">lemma</span></span> analz_synth_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_synth<span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_analz_idem"><span class="command">lemma</span></span> synth_analz_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> analz_synth_analz<span class="main">)</span> <span class="operator">simp</span>


<span class="keyword1" id="Message_derivation-insert_subset_synth_analz"><span class="command">lemma</span></span> insert_subset_synth_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> insert <span class="free">X</span> <span class="free">H</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="Message_derivation-synth_analz_insert"><span class="command">lemma</span></span> synth_analz_insert <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> synth_analz_monotone<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> insert_subset_synth_analz<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span>


<span class="comment1">(****************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Accessible message parts›</span></span>
<span class="comment1">(****************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Accessible message parts: all subterms that are in principle extractable
by the Dolev-Yao attacker, i.e., provided he knows all keys. Note that keys in
key positions and messages under hashes are not message parts in this sense.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">parts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">=&gt;</span> msg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    Inj <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Fst <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Snd <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Dec <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Adec <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Sign_getmsg <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about accessible message parts.›</span></span>

<span class="keyword1" id="Message_derivation-parts_mono"><span class="command">lemma</span></span> parts_mono <span class="main">[</span><span class="operator">mono_set</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> parts <span class="free">G</span> <span class="main">⊆</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> parts_monotone <span class="main">=</span> parts_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>


<span class="keyword1" id="Message_derivation-Pair_parts"><span class="command">lemma</span></span> Pair_parts <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">∈</span> parts <span class="free">H</span><span class="main">;</span> <span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span><span class="main">;</span> <span class="free">Y</span> <span class="main">∈</span> parts <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 


<span class="keyword1" id="Message_derivation-parts_increasing"><span class="command">lemma</span></span> parts_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> parts_insertI <span class="main">=</span> subset_insertI <span class="main">[</span><span class="operator">THEN</span> parts_mono<span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>

<span class="keyword1" id="Message_derivation-parts_empty"><span class="command">lemma</span></span> parts_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_atomic"><span class="command">lemma</span></span> parts_atomic <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atomic <span class="free">x</span> <span class="main">⟹</span> parts <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
 
<span class="keyword1" id="Message_derivation-parts_InsecTag"><span class="command">lemma</span></span> parts_InsecTag <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">{</span>Tag <span class="free">t</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>Tag <span class="free">t</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_emptyE"><span class="command">lemma</span></span> parts_emptyE <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">{}</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Message_derivation-parts_Tags"><span class="command">lemma</span></span> parts_Tags <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts Tags <span class="main">=</span> Tags"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1" id="Message_derivation-parts_singleton"><span class="command">lemma</span></span> parts_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">Y</span><span class="main">∈</span><span class="free">H</span><span class="main">.</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="main">{</span><span class="bound">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_Agents"><span class="command">lemma</span></span> parts_Agents <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>Agent<span class="main">`</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> Agent<span class="main">`</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> parts.induct<span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_Un"><span class="command">lemma</span></span> parts_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">G</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="free">G</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"parts <span class="free">G</span> <span class="main">∪</span> parts <span class="free">H</span> <span class="main">⊆</span> parts <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Un_least parts_mono Un_upper1 Un_upper2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Message_derivation-parts_insert_subset_Un"><span class="command">lemma</span></span> parts_insert_subset_Un<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="free">G</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_mono<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Message_derivation-parts_insert"><span class="command">lemma</span></span> parts_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_insert_subset_Un <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parts_monotone<span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_insert2"><span class="command">lemma</span></span> parts_insert2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>insert <span class="free">Y</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="main">{</span><span class="free">Y</span><span class="main">}</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="Message_derivation-parts_UN"><span class="command">lemma</span></span> parts_UN <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">H</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> parts<span class="main">(</span><span class="free">H</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">=</span> <span class="var">?Y</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">⊆</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> UN_least parts_mono UN_upper<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> in_parts_UnE <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span> <span class="main">=</span> parts_Un <span class="main">[</span><span class="operator">THEN</span> equalityD1<span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">,</span> <span class="operator">THEN</span> UnE<span class="main">]</span> 


<span class="keyword1" id="Message_derivation-parts_insert_subset"><span class="command">lemma</span></span> parts_insert_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">X</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parts_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1" id="Message_derivation-parts_partsD"><span class="command">lemma</span></span> parts_partsD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_idem"><span class="command">lemma</span></span> parts_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-parts_subset_iff"><span class="command">lemma</span></span> parts_subset_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>parts <span class="free">G</span> <span class="main">⊆</span> parts <span class="free">H</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊆</span> parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> parts_mono<span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_trans"><span class="command">lemma</span></span> parts_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="free">G</span> <span class="main">⟹</span>  <span class="free">G</span> <span class="main">⊆</span> parts <span class="free">H</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> parts_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1" id="Message_derivation-parts_cut"><span class="command">lemma</span></span> parts_cut<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span>  <span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∈</span> parts <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parts_trans<span class="main">)</span>


<span class="keyword1" id="Message_derivation-parts_cut_eq"><span class="command">lemma</span></span> parts_cut_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span> <span class="main">⟹</span> parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_cut <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parts_insertI<span class="main">)</span>


<span class="keyword1"><span class="command">lemmas</span></span> parts_insert_eq_I <span class="main">=</span> equalityI <span class="main">[</span><span class="operator">OF</span> subsetI parts_insert_subset<span class="main">]</span>


<span class="keyword1" id="Message_derivation-parts_insert_Agent"><span class="command">lemma</span></span> parts_insert_Agent <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Agent <span class="free">agt</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Agent <span class="free">agt</span><span class="main">)</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_insert_eq_I<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_insert_Nonce"><span class="command">lemma</span></span> parts_insert_Nonce <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Nonce <span class="free">N</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Nonce <span class="free">N</span><span class="main">)</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_insert_eq_I<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_insert_Number"><span class="command">lemma</span></span> parts_insert_Number <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Number <span class="free">N</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Number <span class="free">N</span><span class="main">)</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_insert_eq_I<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_insert_LtK"><span class="command">lemma</span></span> parts_insert_LtK <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>LtK <span class="free">K</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>LtK <span class="free">K</span><span class="main">)</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_insert_eq_I<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-parts_insert_Hash"><span class="command">lemma</span></span> parts_insert_Hash <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_insert_eq_I<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="Message_derivation-parts_insert_Enc"><span class="command">lemma</span></span> parts_insert_Enc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Enc <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Enc <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Message_derivation-parts_insert_Aenc"><span class="command">lemma</span></span> parts_insert_Aenc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Aenc <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Aenc <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Message_derivation-parts_insert_Sign"><span class="command">lemma</span></span> parts_insert_Sign <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Sign <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Sign <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Message_derivation-parts_insert_Pair"><span class="command">lemma</span></span> parts_insert_Pair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Pair <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Pair <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="main">{</span><span class="free">Y</span><span class="main">}</span> <span class="main">∪</span> parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about combinations with composition and decomposition›</span></span>
<span class="comment1">(****************************************************************************************)</span>

<span class="keyword1" id="Message_derivation-analz_subset_parts"><span class="command">lemma</span></span> analz_subset_parts<span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="free">H</span> <span class="main">⊆</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_into_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> analz_subset_parts <span class="main">[</span><span class="operator">THEN</span> subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> not_parts_not_analz <span class="main">=</span> analz_subset_parts <span class="main">[</span><span class="operator">THEN</span> contra_subsetD<span class="main">]</span>


<span class="keyword1" id="Message_derivation-parts_analz"><span class="command">lemma</span></span> parts_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_subset_parts <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> parts_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subset_trans<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_increasing <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> parts_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Message_derivation-analz_parts"><span class="command">lemma</span></span> analz_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="Message_derivation-parts_synth"><span class="command">lemma</span></span> parts_synth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span> <span class="main">∪</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_increasing <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> parts_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> <span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Message_derivation-Fake_parts_insert"><span class="command">lemma</span></span> Fake_parts_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> parts_insert_subset_Un<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Message_derivation-Fake_parts_insert_in_Un"><span class="command">lemma</span></span> Fake_parts_insert_in_Un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">∈</span> parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">Z</span> <span class="main">∈</span>  synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Fake_parts_insert <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">dest</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1" id="Message_derivation-analz_conj_parts"><span class="command">lemma</span></span> analz_conj_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_subset_parts <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-analz_disj_parts"><span class="command">lemma</span></span> analz_disj_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">∨</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_subset_parts <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="comment1">(****************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹More lemmas about combinations of closures›</span></span>
<span class="comment1">(****************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Combinations of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">synth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="Message_derivation-Pair_synth_analz"><span class="command">lemma</span></span> Pair_synth_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-Enc_synth_analz"><span class="command">lemma</span></span> Enc_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span>Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-Hash_synth_analz"><span class="command">lemma</span></span> Hash_synth_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span>Hash <span class="main">(</span>Pair <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>Hash <span class="main">(</span>Pair <span class="free">X</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1" id="Message_derivation-gen_analz_insert_eq"><span class="command">lemma</span></span> gen_analz_insert_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> analz <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_cut analz_insertI analz_monotone<span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_analz_insert_eq"><span class="command">lemma</span></span> synth_analz_insert_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">G</span><span class="main">)</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_insert synth_analz_monotone<span class="main">)</span>

<span class="keyword1" id="Message_derivation-Fake_parts_sing"><span class="command">lemma</span></span> Fake_parts_sing<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> Fake_parts_insert<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parts_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Fake_parts_sing_imp_Un <span class="main">=</span> Fake_parts_sing <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>


<span class="keyword1" id="Message_derivation-analz_hash_nonce"><span class="command">lemma</span></span> analz_hash_nonce <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"analz <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="bound">M</span> <span class="main">=</span> Hash <span class="main">(</span>Nonce <span class="bound">N</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="bound">M</span> <span class="main">=</span> Hash <span class="main">(</span>Nonce <span class="bound">N</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Message_derivation-synth_analz_hash_nonce"><span class="command">lemma</span></span> synth_analz_hash_nonce <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"NonceF <span class="free">N</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="bound">M</span> <span class="main">=</span> Hash <span class="main">(</span>Nonce <span class="bound">N</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Message_derivation-synth_analz_idem_mono"><span class="command">lemma</span></span> synth_analz_idem_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">S'</span><span class="main">)</span> <span class="main">⟹</span> synth <span class="main">(</span>analz <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">S'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> synth_analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> synth_analz_idem_monoI <span class="main">=</span>
  synth_analz_idem_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>



<span class="keyword1" id="Message_derivation-analz_synth_subset"><span class="command">lemma</span></span> analz_synth_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="free">X</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">X'</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="free">Y</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">Y'</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">X'</span> <span class="main">∪</span> <span class="free">Y'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"analz <span class="free">X</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">X'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> HX<span class="main">:</span><span class="quoted"><span class="quoted">"analz <span class="free">X</span> <span class="main">⊆</span> analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">X'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"analz <span class="free">Y</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">Y'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> HY<span class="main">:</span><span class="quoted"><span class="quoted">"analz <span class="free">Y</span> <span class="main">⊆</span> analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">Y'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> analz_subset_cong <span class="main">[</span><span class="operator">OF</span> HX HY<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⊆</span> analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">X'</span><span class="main">)</span> <span class="main">∪</span> synth <span class="main">(</span>analz <span class="free">Y'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">X'</span> <span class="main">∪</span> analz <span class="free">Y'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> analz_mono synth_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span><span class="free">X'</span> <span class="main">∪</span> <span class="free">Y'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> synth_mono analz_mono analz_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">X'</span> <span class="main">∪</span> <span class="free">Y'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">X'</span> <span class="main">∪</span> <span class="free">Y'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Message_derivation-analz_synth_subset_Un1"><span class="command">lemma</span></span> analz_synth_subset_Un1 <span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="free">X</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">X'</span><span class="main">)</span> <span class="main">⟹</span> analz <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">X'</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> analz_synth_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-analz_synth_subset_Un2"><span class="command">lemma</span></span> analz_synth_subset_Un2 <span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="free">X</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">X'</span><span class="main">)</span> <span class="main">⟹</span> analz <span class="main">(</span><span class="free">Y</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">Y</span> <span class="main">∪</span> <span class="free">X'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> analz_synth_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Message_derivation-analz_synth_insert"><span class="command">lemma</span></span> analz_synth_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="free">X</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">X'</span><span class="main">)</span> <span class="main">⟹</span> analz <span class="main">(</span>insert <span class="free">Y</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">Y</span> <span class="free">X'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> analz_synth_subset_Un2 insert_def<span class="main">)</span>

<span class="keyword1" id="Message_derivation-Fake_analz_insert_Un"><span class="command">lemma</span></span> Fake_analz_insert_Un<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">G</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span> 
                     analz_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> synth_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup.commute<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IK">
<div class="head">
<h1>Theory IK</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  IK.thy (Isabelle/HOL 2016-1)
  ID:      $Id: IK.thy 132882 2016-12-23 09:03:55Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  State with intruder knowledge and corresponding Dolev-Yao derivation event.
  - This is used a building block for Secrecy model. 
  - The attacker event is also used by level-3 models.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Environment: Dolev-Yao Intruder›</span></span>

<span class="keyword1"><span class="command">theory</span></span> IK
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Message_derivation.html">Message_derivation</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic state contains intruder knowledge. The secrecy model and concrete Level 1 
states will be record extensions of this state.›</span></span>

<span class="keyword1"><span class="command">record</span></span> ik_state <span class="main">=</span>
  ik <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Dolev-Yao intruder event adds a derived message.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ik_dy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ik_state_scheme <span class="main">*</span> <span class="tfree">'a</span> ik_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ik_dy</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guard›</span>
    <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

    <span class="comment1">― ‹action›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">⦇</span>ik <span class="main">:=</span> ik <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ik_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> ik_state_scheme <span class="main">*</span> <span class="tfree">'a</span> ik_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ik_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">m</span><span class="main">.</span>  ik_dy <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ik_trans_defs <span class="main">=</span> ik_trans_def ik_dy_def


<span class="keyword1" id="IK-ik_trans_ik_increasing"><span class="command">lemma</span></span> ik_trans_ik_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> ik_trans <span class="main">⟹</span> ik <span class="free">s</span> <span class="main">⊆</span> ik <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_trans_defs<span class="main">)</span>

<span class="keyword1" id="IK-ik_trans_synth_analz_ik_increasing"><span class="command">lemma</span></span> ik_trans_synth_analz_ik_increasing<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> ik_trans <span class="main">⟹</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> synth_analz_mono ik_trans_ik_increasing<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Secrecy">
<div class="head">
<h1>Theory Secrecy</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Secrecy.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Secrecy.thy 133008 2017-01-17 13:53:14Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  A simple model of secrecy with a set of secrets and the intruder knowledge.
  Secrecy = disjointness of secret messages and intruder knowledge
  Two events: (1) secret declaration (later by protocols)
              (2) intruder learns a message

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Secrecy Model (L0)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Secrecy 
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Refinement.html">Refinement</a> <a href="IK.html">IK</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span> 

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Level 0 secrecy state: extend intruder knowledge with set of secrets.›</span></span>

<span class="keyword1"><span class="command">record</span></span> s0_state <span class="main">=</span> <span class="quoted">ik_state</span> <span class="main">+</span> 
  secret <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of the secrecy invariant: DY closure of intruder knowledge and set of
secrets are disjoint.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">s0_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> s0_state_scheme set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> s0_secrecyI <span class="main">=</span> s0_secrecy_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> s0_secrecyE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> s0_secrecy_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two events: add/declare a message as a secret and learn a (non-secret) message.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">s0_add_secret</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> s0_state_scheme <span class="main">*</span> <span class="tfree">'a</span> s0_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0_add_secret</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guard›</span>
    <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    
    <span class="comment1">― ‹action›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>secret <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>secret <span class="bound">s</span><span class="main">)</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">s0_learn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> s0_state_scheme <span class="main">*</span> <span class="tfree">'a</span> s0_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0_learn</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guard›</span>
    <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">⦈</span> <span class="main">∈</span> s0_secrecy <span class="main">∧</span> 

    <span class="comment1">― ‹action›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">s0_learn'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> s0_state_scheme <span class="main">*</span> <span class="tfree">'a</span> s0_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0_learn'</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guard›</span>
    synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 

    <span class="comment1">― ‹action›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">s0_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> s0_state_scheme <span class="main">*</span> <span class="tfree">'a</span> s0_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">.</span> s0_add_secret <span class="bound">m</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span><span class="main">.</span> s0_learn <span class="bound">m</span><span class="main">)</span> <span class="main">∪</span> Id"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initial state is any state satisfying the invariant. The whole state is
observable. Put all together to define the L0 specification.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">s0_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> s0_state_scheme set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0_init</span> <span class="main">≡</span> s0_secrecy"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  s0_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"s0_state"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">s0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>s0_state<span class="main">,</span> s0_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> s0_init<span class="main">,</span>
    trans <span class="main">=</span> s0_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> s0_defs <span class="main">=</span> s0_def s0_init_def s0_trans_def s0_add_secret_def s0_learn_def 
<span class="keyword1"><span class="command">lemmas</span></span> s0_all_defs <span class="main">=</span> s0_defs ik_trans_defs

<span class="keyword1" id="Secrecy-s0_obs_id"><span class="command">lemma</span></span> s0_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs s0 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s0_def<span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of secrecy invariant›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Secrecy-s0_secrecy_init"><span class="command">lemma</span></span> s0_secrecy_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"init s0 <span class="main">⊆</span> s0_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s0_defs<span class="main">)</span>

<span class="keyword1" id="Secrecy-s0_secrecy_trans"><span class="command">lemma</span></span> s0_secrecy_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>s0_secrecy<span class="main">}</span> trans s0 <span class="main">{&gt;</span> s0_secrecy<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s0_all_defs PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s0_secrecyI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Secrecy-s0_secrecy"><span class="command">lemma</span></span> s0_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"reach s0 <span class="main">⊆</span> s0_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="Secrecy-s0_obs_secrecy"><span class="command">lemma</span></span> s0_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"oreach s0 <span class="main">⊆</span> s0_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1" id="Secrecy-s0_anyP_observable"><span class="command">lemma</span></span> s0_anyP_observable <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"observable <span class="main">(</span>obs s0<span class="main">)</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="AuthenticationN">
<div class="head">
<h1>Theory AuthenticationN</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  AuthenticationN.thy (Isabelle/HOL 2016-1)
  ID:      $Id: AuthenticationN.thy 133008 2017-01-17 13:53:14Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Simple abstract model of non-injective agreement based on a multiset 
  of signals. Two events: running and commit.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Non-injective Agreement (L0)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> AuthenticationN <span class="keyword2"><span class="keyword">imports</span></span> <a href="Refinement.html">Refinement</a> <a href="Messages.html">Messages</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Signals›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹signals›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> signal <span class="main">=</span>
  Running <span class="quoted">agent</span> <span class="quoted">agent</span> <span class="quoted">msg</span>
<span class="main">|</span> Commit <span class="quoted">agent</span> <span class="quoted">agent</span> <span class="quoted">msg</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">addSignal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>signal <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> signal <span class="main">⇒</span> signal <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">addSignal</span> <span class="free"><span class="bound"><span class="entity">sigs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sigs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">sigs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹level 0 non-injective agreement›</span></span>
<span class="keyword1"><span class="command">record</span></span> a0n_state <span class="main">=</span> 
  signals <span class="main">::</span> <span class="quoted"><span class="quoted">"signal <span class="main">⇒</span> nat"</span></span>    <span class="comment1">― ‹multi-set of signals›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  a0n_obs <span class="main">=</span> <span class="quoted">a0n_state</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n_running</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span>a0n_state <span class="main">×</span> a0n_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a0n_running</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹action›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>signals <span class="main">:=</span> addSignal <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n_commit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span>a0n_state <span class="main">×</span> a0n_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a0n_commit</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
  <span class="comment1">― ‹guard›</span>
    signals <span class="bound">s</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span>
  <span class="comment1">― ‹action›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>signals <span class="main">:=</span> addSignal <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a0n_state <span class="main">×</span> a0n_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0n_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> a0n_running <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> a0n_commit <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">∪</span> Id"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Level 0 state›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">a0n_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"a0n_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0n_init</span> <span class="main">≡</span> <span class="main">{</span><span class="main">⦇</span>signals <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">⦈</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a0n_state<span class="main">,</span> a0n_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0n</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> a0n_init<span class="main">,</span>
    trans <span class="main">=</span> a0n_trans<span class="main">,</span> 
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> a0n_defs <span class="main">=</span> 
  a0n_def a0n_init_def a0n_trans_def 
  a0n_running_def a0n_commit_def

<span class="keyword1" id="AuthenticationN-a0n_obs_id"><span class="command">lemma</span></span> a0n_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs a0n <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0n_def<span class="main">)</span>  

<span class="keyword1" id="AuthenticationN-a0n_anyP_observable"><span class="command">lemma</span></span> a0n_anyP_observable <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"observable <span class="main">(</span>obs a0n<span class="main">)</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>  


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Non injective agreement invariant›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariant: non injective agreement›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n_agreement</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"a0n_state set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0n_agreement</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span>
     signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> signals <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> a0n_agreementI <span class="main">=</span> a0n_agreement_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> a0n_agreementE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> a0n_agreement_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> a0n_agreementD <span class="main">=</span> a0n_agreement_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 2<span class="main">]</span>


<span class="keyword1" id="AuthenticationN-a0n_agreement_init"><span class="command">lemma</span></span> a0n_agreement_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init a0n <span class="main">⊆</span> a0n_agreement"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0n_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0n_agreementI<span class="main">)</span>

<span class="keyword1" id="AuthenticationN-a0n_agreement_trans"><span class="command">lemma</span></span> a0n_agreement_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>a0n_agreement<span class="main">}</span> trans a0n <span class="main">{&gt;</span> a0n_agreement<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs a0n_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0n_agreementI<span class="main">)</span>

<span class="keyword1" id="AuthenticationN-a0n_agreement"><span class="command">lemma</span></span> a0n_agreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach a0n <span class="main">⊆</span> a0n_agreement"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="AuthenticationN-a0n_obs_agreement"><span class="command">lemma</span></span> a0n_obs_agreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"oreach a0n <span class="main">⊆</span> a0n_agreement"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> a0n_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AuthenticationI">
<div class="head">
<h1>Theory AuthenticationI</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  AuthenticationI.thy (Isabelle/HOL 2016-1)
  ID:      $Id: AuthenticationI.thy 132844 2016-12-19 15:21:54Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Simple abstract model of injective agreement based on a multiset of signals. 
  Two events: running and commit. Refines model for non-injective agreement.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Injective Agreement (L0)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> AuthenticationI
<span class="keyword2"><span class="keyword">imports</span></span> <a href="AuthenticationN.html">AuthenticationN</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  a0i_state <span class="main">=</span> <span class="quoted">a0n_state</span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  a0i_obs <span class="main">=</span> <span class="quoted">a0n_obs</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">a0i_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"a0n_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0i_init</span> <span class="main">≡</span> a0n_init"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">a0i_running</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span>a0i_state <span class="main">×</span> a0i_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0i_running</span> <span class="main">≡</span> a0n_running"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> a0i_running_def <span class="main">=</span> a0n_running_def

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0i_commit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span>a0i_state <span class="main">×</span> a0i_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a0i_commit</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
   <span class="comment1">― ‹guard›</span>
     signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">&lt;</span> signals <span class="bound">s</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∧</span>
   <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>signals <span class="main">:=</span> addSignal <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0i_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a0i_state <span class="main">×</span> a0i_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0i_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> a0i_running <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> a0i_commit <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">∪</span> Id"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a0i_state<span class="main">,</span>a0i_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0i</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> a0i_init<span class="main">,</span>
    trans <span class="main">=</span> a0i_trans<span class="main">,</span> 
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> a0i_defs <span class="main">=</span> a0n_defs a0i_def a0i_trans_def a0i_commit_def

<span class="keyword1" id="AuthenticationI-a0i_obs"><span class="command">lemma</span></span> a0i_obs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs a0i <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0i_def<span class="main">)</span>

<span class="keyword1" id="AuthenticationI-a0i_anyP_observable"><span class="command">lemma</span></span> a0i_anyP_observable <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"observable <span class="main">(</span>obs a0i<span class="main">)</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>  


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Injective agreement invariant›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0i_agreement</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"a0i_state set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0i_agreement</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span>
    signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">≤</span> signals <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> a0i_agreementI <span class="main">=</span> 
  a0i_agreement_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> a0i_agreementE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  a0i_agreement_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> a0i_agreementD <span class="main">=</span> 
  a0i_agreement_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1" id="AuthenticationI-PO_a0i_agreement_init"><span class="command">lemma</span></span> PO_a0i_agreement_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init a0i <span class="main">⊆</span> a0i_agreement"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0i_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0i_agreementI<span class="main">)</span>

<span class="keyword1" id="AuthenticationI-PO_a0i_agreement_trans"><span class="command">lemma</span></span> PO_a0i_agreement_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>a0i_agreement<span class="main">}</span> trans a0i <span class="main">{&gt;</span> a0i_agreement<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs a0i_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0i_agreementI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> a0i_agreementD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_SucI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="AuthenticationI-PO_a0i_agreement"><span class="command">lemma</span></span> PO_a0i_agreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach a0i <span class="main">⊆</span> a0i_agreement"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="AuthenticationI-PO_a0i_obs_agreement"><span class="command">lemma</span></span> PO_a0i_obs_agreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach a0i <span class="main">⊆</span> a0i_agreement"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> a0i_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med0n0i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"a0i_obs <span class="main">⇒</span> a0i_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med0n0i</span> <span class="main">≡</span> id"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R0n0i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a0n_state <span class="main">×</span> a0i_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R0n0i</span> <span class="main">≡</span> Id"</span></span>

<span class="keyword1" id="AuthenticationI-PO_a0i_running_refines_a0n_running"><span class="command">lemma</span></span> PO_a0i_running_refines_a0n_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0n0i<span class="main">}</span> a0n_running <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">,</span> a0i_running <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">{&gt;</span> R0n0i<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> R0n0i_def<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> relhoare_refl<span class="main">)</span>

<span class="keyword1" id="AuthenticationI-PO_a0i_commit_refines_a0n_commit"><span class="command">lemma</span></span> PO_a0i_commit_refines_a0n_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0n0i<span class="main">}</span> a0n_commit <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">,</span> a0i_commit <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">{&gt;</span> R0n0i<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0n0i_def a0i_defs<span class="main">)</span>


<span class="keyword1"><span class="command">lemmas</span></span> PO_a0i_trans_refines_a0n_trans <span class="main">=</span> 
  PO_a0i_running_refines_a0n_running
  PO_a0i_commit_refines_a0n_commit


<span class="keyword1" id="AuthenticationI-PO_a0i_refines_init_a0n"><span class="command">lemma</span></span> PO_a0i_refines_init_a0n <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init a0i <span class="main">⊆</span> R0n0i<span class="main">``</span><span class="main">(</span>init a0n<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R0n0i_def a0i_defs<span class="main">)</span>

<span class="keyword1" id="AuthenticationI-PO_a0i_refines_trans_a0n"><span class="command">lemma</span></span> PO_a0i_refines_trans_a0n <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0n0i<span class="main">}</span> trans a0n<span class="main">,</span> trans a0i <span class="main">{&gt;</span> R0n0i<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0n_def a0n_trans_def a0i_def a0i_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_a0i_trans_refines_a0n_trans relhoare_abstract_UN<span class="main">)</span>

<span class="keyword1" id="AuthenticationI-PO_obs_consistent"><span class="command">lemma</span></span> PO_obs_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R0n0i med0n0i a0n a0i"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R0n0i_def med0n0i_def a0i_def a0n_def<span class="main">)</span>

<span class="keyword1" id="AuthenticationI-PO_a0i_refines_a0n"><span class="command">lemma</span></span> PO_a0i_refines_a0n<span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines R0n0i med0n0i a0n a0i"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariant›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="AuthenticationI-iagreement_implies_niagreement"><span class="command">lemma</span></span> iagreement_implies_niagreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"a0i_agreement <span class="main">⊆</span> a0n_agreement"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0n_agreementI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> a0i_agreementD<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> order.strict_trans2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="AuthenticationI-PO_a0i_a0n_agreement"><span class="command">lemma</span></span> PO_a0i_a0n_agreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach a0i <span class="main">⊆</span> a0n_agreement"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>

<span class="keyword1" id="AuthenticationI-PO_a0i_obs_a0n_agreement"><span class="command">lemma</span></span> PO_a0i_obs_a0n_agreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach a0i <span class="main">⊆</span> a0n_agreement"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Runs">
<div class="head">
<h1>Theory Runs</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Runs.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Runs.thy 132861 2016-12-21 10:34:41Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Defines types protocol runs: a run is described by a protocol role, the owner 
  and partner agents, and frame, which maps variables to messages. 

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Runs›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Runs <span class="keyword2"><span class="keyword">imports</span></span> <a href="Messages.html">Messages</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type definitions›</span></span>


<span class="keyword1"><span class="command">datatype</span></span> role_t <span class="main">=</span> Init <span class="main">|</span> Resp 

<span class="keyword1"><span class="command">datatype</span></span> var <span class="main">=</span> Var <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  rid_t <span class="main">=</span> <span class="quoted"><span class="quoted">"fid_t"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  frame <span class="main">=</span> <span class="quoted"><span class="quoted">"var <span class="main">⇀</span> msg"</span></span> 

<span class="keyword1"><span class="command">record</span></span> run_t <span class="main">=</span> 
  role <span class="main">::</span> <span class="quoted">role_t</span>
  owner <span class="main">::</span> <span class="quoted">agent</span>
  partner <span class="main">::</span> <span class="quoted">agent</span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  progress_t <span class="main">=</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇀</span> var set"</span></span> 


<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">in_progress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set option <span class="main">⇒</span> var <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_progress</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">in_progress</span> None <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">in_progressS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set option <span class="main">⇒</span> var set <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_progressS</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S'</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">in_progressS</span> None <span class="free"><span class="bound"><span class="entity">S'</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Runs-in_progress_dom"><span class="command">lemma</span></span> in_progress_dom <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"in_progress <span class="main">(</span><span class="free">r</span> <span class="free">R</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">∈</span> dom <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">R</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Runs-in_progress_Some"><span class="command">lemma</span></span> in_progress_Some <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"in_progress <span class="free">r</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Runs-in_progressS_elt"><span class="command">lemma</span></span> in_progressS_elt <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"in_progressS <span class="free">r</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> in_progress <span class="free">r</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Channels">
<div class="head">
<h1>Theory Channels</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Channels.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Channels.thy 132885 2016-12-23 18:41:32Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Channel messages and related message derivations (extract and fake).

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Channel Messages›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Channels
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Message_derivation.html">Message_derivation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Channel messages›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">datatype</span></span> chan <span class="main">=</span> 
  Chan <span class="quoted"><span class="quoted">"tag"</span></span> <span class="quoted"><span class="quoted">"agent"</span></span> <span class="quoted"><span class="quoted">"agent"</span></span> <span class="quoted"><span class="quoted">"msg"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">Insec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent<span class="main">,</span> agent<span class="main">,</span> msg<span class="main">]</span> <span class="main">⇒</span> chan"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Insec</span> <span class="main">≡</span> Chan insec"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">Confid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent<span class="main">,</span> agent<span class="main">,</span> msg<span class="main">]</span> <span class="main">⇒</span> chan"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Confid</span> <span class="main">≡</span> Chan confid"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">Auth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent<span class="main">,</span> agent<span class="main">,</span> msg<span class="main">]</span> <span class="main">⇒</span> chan"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Auth</span> <span class="main">≡</span> Chan auth"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">Secure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent<span class="main">,</span> agent<span class="main">,</span> msg<span class="main">]</span> <span class="main">⇒</span> chan"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Secure</span> <span class="main">≡</span> Chan secure"</span></span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extract›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of payload messages that can be extracted from a set of (crypto) messages 
and a set of channel messages, given a set of bad agents. The second rule states that 
the payload can be extracted from insecure and authentic channels as well as from channels
with a compromised endpoint.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">extr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set <span class="main">⇒</span> msg set <span class="main">⇒</span> chan set <span class="main">⇒</span> msg set"</span></span>  
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">bad</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">IK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chan set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  extr_Inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> <span class="free">IK</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> <span class="free">extr</span> <span class="free">bad</span> <span class="free">IK</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> extr_Chan<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Chan <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> <span class="free">H</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> insec <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> auth <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈</span> <span class="free">bad</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∈</span> <span class="free">bad</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> <span class="free">extr</span> <span class="free">bad</span> <span class="free">IK</span> <span class="free">H</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> extr.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> extr.cases <span class="main">[</span><span class="operator">elim</span><span class="main">]</span>


<span class="keyword1" id="Channels-extr_empty_chan"><span class="command">lemma</span></span> extr_empty_chan <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">{}</span> <span class="main">=</span> <span class="free">IK</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-IK_subset_extr"><span class="command">lemma</span></span> IK_subset_extr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">IK</span> <span class="main">⊆</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-extr_mono_chan"><span class="command">lemma</span></span> extr_mono_chan <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">G</span> <span class="main">⊆</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> extr.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-extr_mono_IK"><span class="command">lemma</span></span> extr_mono_IK <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">IK1</span> <span class="main">⊆</span> <span class="free">IK2</span> <span class="main">⟹</span> extr <span class="free">bad</span> <span class="free">IK1</span> <span class="free">H</span> <span class="main">⊆</span> extr <span class="free">bad</span> <span class="free">IK2</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> extr.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-extr_mono_bad"><span class="command">lemma</span></span> extr_mono_bad <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bad</span> <span class="main">⊆</span> <span class="free">bad'</span> <span class="main">⟹</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">H</span> <span class="main">⊆</span> extr <span class="free">bad'</span> <span class="free">IK</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> extr.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> extr_monotone_chan <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> extr_mono_chan <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extr_monotone_IK <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> extr_mono_IK <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extr_monotone_bad <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> extr_mono_bad <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1" id="Channels-extr_mono"><span class="command">lemma</span></span> extr_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">b'</span><span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">I'</span><span class="main">;</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">C'</span> <span class="main">⟧</span> <span class="main">⟹</span> extr <span class="free">b</span> <span class="free">I</span> <span class="free">C</span> <span class="main">⊆</span> extr <span class="free">b'</span> <span class="free">I'</span> <span class="free">C'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> extr_monotone <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> extr_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1" id="Channels-extr_insert"><span class="command">lemma</span></span> extr_insert <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">∈</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="free">C</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-extr_insert_Chan"><span class="command">lemma</span></span> extr_insert_Chan <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="main">(</span>Chan <span class="free">c</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> 
   <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="main">=</span> insec <span class="main">∨</span> <span class="free">c</span> <span class="main">=</span> auth <span class="main">∨</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">bad</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">bad</span> 
      <span class="keyword1">then</span> insert <span class="free">M</span> <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">H</span><span class="main">)</span> <span class="keyword1">else</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* do not declare [simp]! *)</span>
<span class="keyword1" id="Channels-extr_insert_chan_eq"><span class="command">lemma</span></span> extr_insert_chan_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">CH</span><span class="main">)</span> <span class="main">=</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-extr_insert_IK_eq"><span class="command">lemma</span></span> extr_insert_IK_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extr <span class="free">bad</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">IK</span><span class="main">)</span> <span class="free">CH</span> <span class="main">=</span> insert <span class="free">X</span> <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-extr_insert_bad"><span class="command">lemma</span></span> extr_insert_bad<span class="main">:</span>
  <span class="quoted"><span class="quoted">"extr <span class="main">(</span>insert <span class="free">A</span> <span class="free">bad</span><span class="main">)</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">⊆</span>
   extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">B</span><span class="main">.</span> Confid <span class="free">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free">CH</span> <span class="main">∨</span> Confid <span class="bound">B</span> <span class="free">A</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free">CH</span> <span class="main">∨</span>
                             Secure <span class="free">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free">CH</span> <span class="main">∨</span> Secure <span class="bound">B</span> <span class="free">A</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free">CH</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> extr.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tag.exhaust<span class="main">)</span>

<span class="keyword1" id="Channels-extr_insert_Confid"><span class="command">lemma</span></span> extr_insert_Confid <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> <span class="free">bad</span> <span class="main">⟹</span>
   <span class="free">B</span> <span class="main">∉</span> <span class="free">bad</span> <span class="main">⟹</span> 
   extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="main">(</span>Confid <span class="free">A</span> <span class="free">B</span> <span class="free">X</span><span class="main">)</span> <span class="free">CH</span><span class="main">)</span> <span class="main">=</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fake›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of channel messages that an attacker can fake given a set of compromised
agents, a set of crypto messages and a set of channel messages. The second rule states
that an attacker can fake an insecure or confidential messages or a channel message
with a compromised endpoint using a payload that he knows.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set <span class="main">⇒</span> msg set <span class="main">⇒</span> chan set <span class="main">⇒</span> chan set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">bad</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">IK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">chan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chan set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  fake_Inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> <span class="free">chan</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> <span class="free">fake</span> <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span>"</span></span>
<span class="main">|</span> fake_New<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> <span class="free">IK</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> insec <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> confid <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈</span> <span class="free">bad</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∈</span> <span class="free">bad</span>  <span class="main">⟧</span> 
   <span class="main">⟹</span> Chan <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> <span class="free">fake</span> <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> fake.cases <span class="main">[</span><span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> fake.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> fake_intros <span class="main">=</span> fake_Inj fake_New

<span class="keyword1" id="Channels-fake_mono_bad"><span class="command">lemma</span></span> fake_mono_bad <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">bad</span> <span class="main">⊆</span> <span class="free">bad'</span> <span class="main">⟹</span> fake <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⊆</span> fake <span class="free">bad'</span> <span class="free">IK</span> <span class="free">chan</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-fake_mono_ik"><span class="command">lemma</span></span> fake_mono_ik <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">IK</span> <span class="main">⊆</span> <span class="free">IK'</span> <span class="main">⟹</span> fake <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⊆</span> fake <span class="free">bad</span> <span class="free">IK'</span> <span class="free">chan</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-fake_mono_chan"><span class="command">lemma</span></span> fake_mono_chan <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">chan</span> <span class="main">⊆</span> <span class="free">chan'</span> <span class="main">⟹</span> fake <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⊆</span> fake <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan'</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-fake_mono"><span class="command">lemma</span></span> fake_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">bad</span> <span class="main">⊆</span> <span class="free">bad'</span><span class="main">;</span> <span class="free">IK</span> <span class="main">⊆</span> <span class="free">IK'</span><span class="main">;</span> <span class="free">chan</span> <span class="main">⊆</span> <span class="free">chan'</span><span class="main">⟧</span> <span class="main">⟹</span> fake <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⊆</span> fake <span class="free">bad'</span> <span class="free">IK'</span> <span class="free">chan'</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> fake.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> fake_monotone_bad <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> fake_mono_bad <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> fake_monotone_ik <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> fake_mono_ik <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> fake_monotone_chan <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> fake_mono_chan <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> fake_monotone <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> fake_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>


<span class="keyword1" id="Channels-chan_subset_fake"><span class="command">lemma</span></span> chan_subset_fake<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chan</span> <span class="main">⊆</span> fake <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Channels-extr_fake"><span class="command">lemma</span></span> extr_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> fake <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⟹</span> extr <span class="free">bad</span> <span class="free">IK'</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">IK</span> <span class="main">∪</span> extr <span class="free">bad</span> <span class="free">IK'</span> <span class="free">chan</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> extr_fake_2 <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> extr_fake <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1" id="Channels-fake_parts_extr_singleton"><span class="command">lemma</span></span> fake_parts_extr_singleton<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> fake <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⟹</span> parts <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK'</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="free">IK</span> <span class="main">∪</span> parts <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK'</span> <span class="free">chan</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extr_fake <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> parts_mono<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> fake_parts_extr_singleton_2 <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> fake_parts_extr_singleton <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>


<span class="keyword1" id="Channels-fake_parts_extr_insert"><span class="command">lemma</span></span> fake_parts_extr_insert<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> fake <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK'</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK'</span> <span class="free">CH</span><span class="main">)</span> <span class="main">∪</span> parts <span class="free">IK</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK'</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK'</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> parts <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK'</span> <span class="free">CH</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extr_insert_chan_eq <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> CH<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">CH</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> parts <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK'</span> <span class="free">CH</span><span class="main">)</span> <span class="main">∪</span> parts <span class="free">IK</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fake_parts_extr_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Channels-fake_synth_analz_extr"><span class="command">lemma</span></span> fake_synth_analz_extr<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> fake <span class="free">bad</span> <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">CH</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
     <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> synth_analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> synth_analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> synth_analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">⊆</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">CH</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> synth_analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Closure of Dolev-Yao, extract and fake›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dy_fake_msg›</span></span></span></span>: returns messages, closure of DY and extr is sufficient›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Close <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">extr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under Dolev-Yao closure using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">synth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
This will be used in Level 2 attacker events to fake crypto messages.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">dy_fake_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set <span class="main">⇒</span> msg set <span class="main">⇒</span> chan set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dy_fake_msg</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Channels-dy_fake_msg_empty"><span class="command">lemma</span></span> dy_fake_msg_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="free">bad</span> <span class="main">{}</span> <span class="main">{}</span> <span class="main">=</span> synth <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_msg_mono_bad"><span class="command">lemma</span></span> dy_fake_msg_mono_bad <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bad</span> <span class="main">⊆</span> <span class="free">bad'</span> <span class="main">⟹</span> dy_fake_msg <span class="free">bad</span> <span class="free">I</span> <span class="free">C</span> <span class="main">⊆</span> dy_fake_msg <span class="free">bad'</span> <span class="free">I</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_mono<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_msg_mono_ik"><span class="command">lemma</span></span> dy_fake_msg_mono_ik <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> dy_fake_msg <span class="free">bad</span> <span class="free">G</span> <span class="free">C</span> <span class="main">⊆</span> dy_fake_msg <span class="free">bad</span> <span class="free">H</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_mono<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_msg_mono_chan"><span class="command">lemma</span></span> dy_fake_msg_mono_chan <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> dy_fake_msg <span class="free">bad</span> <span class="free">I</span> <span class="free">G</span> <span class="main">⊆</span> dy_fake_msg <span class="free">bad</span> <span class="free">I</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_mono<span class="main">)</span>
 
<span class="keyword1"><span class="command">lemmas</span></span> dy_fake_msg_monotone_bad <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> dy_fake_msg_mono_bad <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> dy_fake_msg_monotone_ik <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> dy_fake_msg_mono_ik <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> dy_fake_msg_monotone_chan <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> dy_fake_msg_mono_chan <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1" id="Channels-dy_fake_msg_insert"><span class="command">lemma</span></span> dy_fake_msg_insert <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> dy_fake_msg <span class="free">bad</span> <span class="free">I</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">∈</span> dy_fake_msg <span class="free">bad</span> <span class="free">I</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_msg_mono"><span class="command">lemma</span></span> dy_fake_msg_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">b'</span><span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">I'</span><span class="main">;</span> <span class="free">C</span> <span class="main">⊆</span> <span class="free">C'</span> <span class="main">⟧</span> <span class="main">⟹</span> dy_fake_msg <span class="free">b</span> <span class="free">I</span> <span class="free">C</span> <span class="main">⊆</span> dy_fake_msg <span class="free">b'</span> <span class="free">I'</span> <span class="free">C'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> dy_fake_msg_monotone <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> dy_fake_msg_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1" id="Channels-dy_fake_msg_insert_chan"><span class="command">lemma</span></span> dy_fake_msg_insert_chan<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> insec <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> auth <span class="main">⟹</span>
   <span class="free">M</span> <span class="main">∈</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="free">CH</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dy_fake_chan›</span></span></span></span>: returns channel messages›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of all channel messages that an attacker can fake is obtained using
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">fake</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the sets of possible payload messages derived with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">dy_fake_msg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
defined above. This will be used in Level 2 attacker events to fake channel messages.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dy_fake_chan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set <span class="main">⇒</span> msg set <span class="main">⇒</span> chan set <span class="main">⇒</span> chan set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dy_fake_chan</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> fake <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>dy_fake_msg <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>


<span class="keyword1" id="Channels-dy_fake_chan_mono_bad"><span class="command">lemma</span></span> dy_fake_chan_mono_bad <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">bad</span> <span class="main">⊆</span> <span class="free">bad'</span> <span class="main">⟹</span> dy_fake_chan <span class="free">bad</span> <span class="free">I</span> <span class="free">C</span> <span class="main">⊆</span> dy_fake_chan <span class="free">bad'</span> <span class="free">I</span> <span class="free">C</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_chan_def<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_chan_mono_ik"><span class="command">lemma</span></span> dy_fake_chan_mono_ik <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">T'</span> <span class="main">⟹</span> dy_fake_chan <span class="free">bad</span> <span class="free">T</span> <span class="free">C</span> <span class="main">⊆</span> dy_fake_chan <span class="free">bad</span> <span class="free">T'</span> <span class="free">C</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_chan_def<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_chan_mono_chan"><span class="command">lemma</span></span> dy_fake_chan_mono_chan <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="free">C'</span> <span class="main">⟹</span> dy_fake_chan <span class="free">bad</span> <span class="free">T</span> <span class="free">C</span> <span class="main">⊆</span> dy_fake_chan <span class="free">bad</span> <span class="free">T</span> <span class="free">C'</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_chan_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> dy_fake_chan_monotone_bad <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> dy_fake_chan_mono_bad <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> dy_fake_chan_monotone_ik <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> dy_fake_chan_mono_ik <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> dy_fake_chan_monotone_chan <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> dy_fake_chan_mono_chan <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>


<span class="keyword1" id="Channels-dy_fake_chan_mono"><span class="command">lemma</span></span> dy_fake_chan_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊆</span> <span class="free">b'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">I'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> <span class="free">C'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dy_fake_chan <span class="free">b</span> <span class="free">I</span> <span class="free">C</span> <span class="main">⊆</span> dy_fake_chan <span class="free">b'</span> <span class="free">I'</span> <span class="free">C'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dy_fake_chan <span class="free">b</span> <span class="free">I</span> <span class="free">C</span> <span class="main">⊆</span> dy_fake_chan <span class="free">b'</span> <span class="free">I</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">⊆</span> <span class="free">b'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> dy_fake_chan <span class="free">b'</span> <span class="free">I'</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="main">⊆</span> <span class="free">I'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> dy_fake_chan <span class="free">b'</span> <span class="free">I'</span> <span class="free">C'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">⊆</span> <span class="free">C'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> dy_fake_chan_monotone <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> dy_fake_chan_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1" id="Channels-dy_fake_msg_subset_synth_analz"><span class="command">lemma</span></span> dy_fake_msg_subset_synth_analz<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⊆</span> <span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def synth_analz_mono<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_chan_mono2"><span class="command">lemma</span></span> dy_fake_chan_mono2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">y</span><span class="main">)</span><span class="main">;</span> <span class="free">chan</span> <span class="main">⊆</span> fake <span class="free">bad</span> <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span> <span class="main">⟧</span>
 <span class="main">⟹</span> dy_fake_chan <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⊆</span> fake <span class="free">bad</span> <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_chan_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> fake.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fake_New <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dy_fake_msg_subset_synth_analz<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Channels-extr_subset_dy_fake_msg"><span class="command">lemma</span></span> extr_subset_dy_fake_msg<span class="main">:</span> <span class="quoted"><span class="quoted">"extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span> <span class="main">⊆</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">chan</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def<span class="main">)</span>


<span class="keyword1" id="Channels-dy_fake_chan_extr_insert"><span class="command">lemma</span></span> dy_fake_chan_extr_insert<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> dy_fake_chan <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">⟹</span> extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="free">M</span> <span class="free">CH</span><span class="main">)</span> <span class="main">⊆</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_chan_def dy_fake_msg_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fake_synth_analz_extr<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_chan_extr_insert_parts"><span class="command">lemma</span></span> dy_fake_chan_extr_insert_parts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> dy_fake_chan <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">⟹</span>
   parts <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="free">M</span> <span class="free">CH</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="main">(</span>extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span> <span class="main">∪</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> dy_fake_chan_extr_insert <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> parts_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_msg_extr"><span class="command">lemma</span></span> dy_fake_msg_extr<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"extr <span class="free">bad</span> <span class="free">ik</span> <span class="free">chan</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">X</span><span class="main">)</span> <span class="main">⟹</span> dy_fake_msg <span class="free">bad</span> <span class="free">ik</span> <span class="free">chan</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> synth_analz_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def<span class="main">)</span>

<span class="keyword1" id="Channels-extr_insert_dy_fake_msg"><span class="command">lemma</span></span> extr_insert_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">⟹</span> extr <span class="free">bad</span> <span class="main">(</span>insert <span class="free">M</span> <span class="free">IK</span><span class="main">)</span> <span class="free">CH</span> <span class="main">⊆</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_msg_insert_dy_fake_msg"><span class="command">lemma</span></span> dy_fake_msg_insert_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">⟹</span> dy_fake_msg <span class="free">bad</span> <span class="main">(</span>insert <span class="free">M</span> <span class="free">IK</span><span class="main">)</span> <span class="free">CH</span> <span class="main">⊆</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> synth_analz_mono <span class="main"><span class="main">[</span></span><span class="operator">OF</span> extr_insert_dy_fake_msg<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def<span class="main">)</span>

<span class="keyword1" id="Channels-synth_analz_insert_dy_fake_msg"><span class="command">lemma</span></span> synth_analz_insert_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">⟹</span> synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">M</span> <span class="free">IK</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dy_fake_msg_insert_dy_fake_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> subsetD<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span>

<span class="keyword1" id="Channels-Fake_insert_dy_fake_msg"><span class="command">lemma</span></span> Fake_insert_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">⟹</span>
   extr <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">X</span><span class="main">)</span> <span class="main">⟹</span>
   synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">M</span> <span class="free">IK</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_insert_dy_fake_msg dy_fake_msg_extr<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_chan_insert_chan"><span class="command">lemma</span></span> dy_fake_chan_insert_chan<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> insec <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> auth <span class="main">⟹</span>
   Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> dy_fake_chan <span class="free">bad</span> <span class="free">IK</span> <span class="main">(</span>insert <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="free">CH</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_chan_def<span class="main">)</span>

<span class="keyword1" id="Channels-dy_fake_chan_subset"><span class="command">lemma</span></span> dy_fake_chan_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">CH</span> <span class="main">⊆</span> fake <span class="free">bad</span> <span class="main">(</span>dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span> <span class="free">CH'</span> <span class="main">⟹</span>
   dy_fake_chan <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span> <span class="main">⊆</span> fake <span class="free">bad</span> <span class="main">(</span>dy_fake_msg <span class="free">bad</span> <span class="free">IK</span> <span class="free">CH</span><span class="main">)</span> <span class="free">CH'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_chan_def<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Payloads">
<div class="head">
<h1>Theory Payloads</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Payloads.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Payloads.thy 132885 2016-12-23 18:41:32Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Payload messages are messages that contain no implementation material,
  i.e. neither long-term keys nor channel tags; also:
  - auxiliary definitions: Keys_bad, broken, Enc_keys_clean 
  - lemmas for moving message sets out of 'analz'

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Payloads and Support for Channel Message Implementations›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definitions and lemmas that do not require the implementations.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Payloads
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Message_derivation.html">Message_derivation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Payload messages›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Payload messages contain no implementation material ie no long term keys or tags.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Define set of payloads for basic messages.›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">cpayload</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cmsg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"cAgent <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"cNumber <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"cNonce <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"cEphK <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span> <span class="main">⟹</span> cHash <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span> <span class="main">⟧</span> <span class="main">⟹</span> cPair <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span> <span class="main">⟧</span> <span class="main">⟹</span> cEnc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span> <span class="main">⟧</span> <span class="main">⟹</span> cAenc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span> <span class="main">⟧</span> <span class="main">⟹</span> cSign <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span> <span class="main">⟧</span> <span class="main">⟹</span> cExp <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">cpayload</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lift <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">cpayload</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the quotiented message type.›</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> payload <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cpayload</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas used to prove the intro and inversion rules for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">payload</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Payloads-eq_rep_abs"><span class="command">lemma</span></span> eq_rep_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"eq <span class="free">x</span> <span class="main">(</span>Re <span class="main">(</span>Ab <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Quotient3_msg rep_abs_rsp<span class="main">)</span>


<span class="keyword1" id="Payloads-eq_cpayload"><span class="command">lemma</span></span> eq_cpayload<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> cpayload"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> cpayload"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cpayload.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cpayload.cases<span class="main">)</span>

<span class="keyword1" id="Payloads-abs_payload"><span class="command">lemma</span></span> abs_payload<span class="main">:</span> <span class="quoted"><span class="quoted">"Ab <span class="free">x</span> <span class="main">∈</span> payload <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> cpayload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> payload_def msg.abs_eq_iff eq_cpayload eq_sym cpayload.intros 
         <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cpayload.cases<span class="main">)</span>

<span class="keyword1" id="Payloads-abs_cpayload_rep"><span class="command">lemma</span></span> abs_cpayload_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Ab<span class="main">`</span> cpayload <span class="main">⟷</span> Re <span class="free">x</span> <span class="main">∈</span> cpayload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_cpayload <span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_rep_abs<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Ab <span class="main">(</span>Re <span class="free">x</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> Quotient3_abs_rep Quotient3_msg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Payloads-payload_rep_cpayload"><span class="command">lemma</span></span> payload_rep_cpayload<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="free">x</span> <span class="main">∈</span> cpayload <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> payload_def abs_cpayload_rep<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Manual proof of payload introduction rules. Transfer does not work for these›</span></span>

<span class="keyword1"><span class="command">declare</span></span> cpayload.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
<span class="keyword1" id="Payloads-payload_AgentI"><span class="command">lemma</span></span> payload_AgentI<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">A</span> <span class="main">∈</span> payload"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msg_defs abs_payload<span class="main">)</span>
<span class="keyword1" id="Payloads-payload_NonceI"><span class="command">lemma</span></span> payload_NonceI<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">N</span> <span class="main">∈</span> payload"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msg_defs abs_payload<span class="main">)</span>
<span class="keyword1" id="Payloads-payload_NumberI"><span class="command">lemma</span></span> payload_NumberI<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">N</span> <span class="main">∈</span> payload"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msg_defs abs_payload<span class="main">)</span>
<span class="keyword1" id="Payloads-payload_EphKI"><span class="command">lemma</span></span> payload_EphKI<span class="main">:</span> <span class="quoted"><span class="quoted">"EphK <span class="free">X</span> <span class="main">∈</span> payload"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msg_defs abs_payload<span class="main">)</span>
<span class="keyword1" id="Payloads-payload_HashI"><span class="command">lemma</span></span> payload_HashI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> payload <span class="main">⟹</span> Hash <span class="free">x</span> <span class="main">∈</span> payload"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msg_defs payload_rep_cpayload abs_payload<span class="main">)</span>
<span class="keyword1" id="Payloads-payload_PairI"><span class="command">lemma</span></span> payload_PairI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> payload <span class="main">⟹</span> Pair <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> payload"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msg_defs payload_rep_cpayload abs_payload<span class="main">)</span>
<span class="keyword1" id="Payloads-payload_EncI"><span class="command">lemma</span></span> payload_EncI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> payload <span class="main">⟹</span> Enc <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> payload"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msg_defs payload_rep_cpayload abs_payload<span class="main">)</span>
<span class="keyword1" id="Payloads-payload_AencI"><span class="command">lemma</span></span> payload_AencI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> payload <span class="main">⟹</span> Aenc <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> payload"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msg_defs payload_rep_cpayload abs_payload<span class="main">)</span>
<span class="keyword1" id="Payloads-payload_SignI"><span class="command">lemma</span></span> payload_SignI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> payload <span class="main">⟹</span> Sign <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> payload"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msg_defs payload_rep_cpayload abs_payload<span class="main">)</span>
<span class="keyword1" id="Payloads-payload_ExpI"><span class="command">lemma</span></span> payload_ExpI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> payload <span class="main">⟹</span> Exp <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> msg_defs payload_rep_cpayload abs_payload<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> payload_intros <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span> <span class="main">=</span>
  payload_AgentI payload_NonceI payload_NumberI payload_EphKI payload_HashI
  payload_PairI payload_EncI payload_AencI payload_SignI payload_ExpI

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Manual proof of payload inversion rules, transfer does not work for these.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> cpayload.cases<span class="main">[</span><span class="operator">elim</span><span class="main">]</span>
<span class="keyword1" id="Payloads-payload_Tag"><span class="command">lemma</span></span> payload_Tag<span class="main">:</span> <span class="quoted"><span class="quoted">"Tag <span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> payload_def msg_defs msg.abs_eq_iff eq_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_cpayload <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_cpayload_rep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Payloads-payload_LtK"><span class="command">lemma</span></span> payload_LtK<span class="main">:</span> <span class="quoted"><span class="quoted">"LtK <span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> payload_def msg_defs msg.abs_eq_iff eq_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_cpayload <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_cpayload_rep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1" id="Payloads-payload_Hash"><span class="command">lemma</span></span> payload_Hash<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> payload_def msg_defs msg.abs_eq_iff eq_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_cpayload <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_cpayload_rep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1" id="Payloads-payload_Pair"><span class="command">lemma</span></span> payload_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"Pair <span class="free">X</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> payload_def msg_defs msg.abs_eq_iff eq_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_cpayload <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_cpayload_rep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1" id="Payloads-payload_Enc"><span class="command">lemma</span></span> payload_Enc<span class="main">:</span> <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> payload_def msg_defs msg.abs_eq_iff eq_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_cpayload <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_cpayload_rep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1" id="Payloads-payload_Aenc"><span class="command">lemma</span></span> payload_Aenc<span class="main">:</span> <span class="quoted"><span class="quoted">"Aenc <span class="free">X</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> payload_def msg_defs msg.abs_eq_iff eq_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_cpayload <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_cpayload_rep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1" id="Payloads-payload_Sign"><span class="command">lemma</span></span> payload_Sign<span class="main">:</span> <span class="quoted"><span class="quoted">"Sign <span class="free">X</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> payload_def msg_defs msg.abs_eq_iff eq_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_cpayload <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_cpayload_rep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1" id="Payloads-payload_Exp"><span class="command">lemma</span></span> payload_Exp<span class="main">:</span> <span class="quoted"><span class="quoted">"Exp <span class="free">X</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> payload_def Exp_def msg.abs_eq_iff eq_sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_cpayload <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_cpayload_rep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> cpayload.intros<span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> cpayload.cases<span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> payload_inductive_cases <span class="main">=</span>
  payload_Tag payload_LtK payload_Hash
  payload_Pair payload_Enc payload_Aenc payload_Sign payload_Exp

<span class="keyword1" id="Payloads-eq_exhaust"><span class="command">lemma</span></span> eq_exhaust<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cAgent <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cNumber <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cNonce <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cLtK <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cEphK <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cPair <span class="bound">x</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cEnc <span class="bound">x</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cAenc <span class="bound">x</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cSign <span class="bound">x</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cHash <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cTag <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> eq <span class="free">y</span> <span class="main">(</span>cExp <span class="bound">x</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> Messages.eq_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Payloads-msg_exhaust"><span class="command">lemma</span></span> msg_exhaust<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Agent <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Number <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Nonce <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> LtK <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> EphK <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Pair <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Enc <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Aenc <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Sign <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Hash <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Tag <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Exp <span class="bound">x</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eq_exhaust<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Payloads-payload_cases"><span class="command">lemma</span></span> payload_cases<span class="main">:</span> 
<span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> payload <span class="main">⟹</span>
<span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Agent <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Number <span class="bound">T</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="main">⋀</span><span class="bound">N</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Nonce <span class="bound">N</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> EphK <span class="bound">K</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Hash <span class="bound">X</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="main">⋀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Pair <span class="bound">X</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="main">⋀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Enc <span class="bound">X</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="main">⋀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Aenc <span class="bound">X</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="main">⋀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Sign <span class="bound">X</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
<span class="main">(</span><span class="main">⋀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> Exp <span class="bound">X</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
 <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> msg_exhaust <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> payload_inductive_cases<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> payload_cases <span class="main">[</span><span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> payload_inductive_cases <span class="main">[</span><span class="operator">elim</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Properties of payload; messages constructed from payload messages are also payloads.›</span></span>

<span class="keyword1" id="Payloads-payload_parts"><span class="command">lemma</span></span> payload_parts <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="free">S</span><span class="main">;</span> <span class="free">S</span> <span class="main">⊆</span> payload <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> payload"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Payloads-payload_parts_singleton"><span class="command">lemma</span></span> payload_parts_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="main">{</span><span class="free">Y</span><span class="main">}</span><span class="main">;</span> <span class="free">Y</span> <span class="main">∈</span> payload <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> payload"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Payloads-payload_analz"><span class="command">lemma</span></span> payload_analz <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> analz <span class="free">S</span><span class="main">;</span> <span class="free">S</span> <span class="main">⊆</span> payload <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> payload"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz_into_parts<span class="main">)</span>

<span class="keyword1" id="Payloads-payload_synth_analz"><span class="command">lemma</span></span> payload_synth_analz<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">S</span><span class="main">)</span><span class="main">;</span> <span class="free">S</span> <span class="main">⊆</span> payload <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> payload"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> synth.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> payload_analz<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Important lemma: using messages with implementation material one can only 
synthesise more such messages.›</span></span>

<span class="keyword1" id="Payloads-synth_payload"><span class="command">lemma</span></span> synth_payload<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∩</span> payload <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> synth <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="free">X</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> synth.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1" id="Payloads-synth_payload2"><span class="command">lemma</span></span> synth_payload2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∩</span> payload <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> synth <span class="main">(</span><span class="free">Y</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="free">X</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> synth.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma: in the case of the previous lemma, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">synth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be applied on the 
left with no consequence.›</span></span>

<span class="keyword1" id="Payloads-synth_idem_payload"><span class="command">lemma</span></span> synth_idem_payload<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> synth <span class="free">Y</span> <span class="main">∪</span> <span class="main">-</span>payload <span class="main">⟹</span> synth <span class="free">X</span> <span class="main">⊆</span> synth <span class="free">Y</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_mono subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ synth_payload<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>isLtKey›</span></span></span></span>: is a long term key›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Payloads-LtKeys_payload"><span class="command">lemma</span></span> LtKeys_payload <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NI</span> <span class="main">⊆</span> payload <span class="main">⟹</span> <span class="free">NI</span> <span class="main">∩</span> range LtK <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Payloads-LtKeys_parts_payload"><span class="command">lemma</span></span> LtKeys_parts_payload <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NI</span> <span class="main">⊆</span> payload <span class="main">⟹</span> parts <span class="free">NI</span> <span class="main">∩</span> range LtK <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Payloads-LtKeys_parts_payload_singleton"><span class="command">lemma</span></span> LtKeys_parts_payload_singleton <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟹</span> LtK <span class="free">Y</span> <span class="main">∈</span> parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">⟹</span> False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Payloads-parts_of_LtKeys"><span class="command">lemma</span></span> parts_of_LtKeys <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK <span class="main">⟹</span> parts <span class="free">K</span> <span class="main">=</span> <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>keys_of›</span></span></span></span>: the long term keys of an agent›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">keys_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">keys_of</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> insert <span class="main">(</span>priK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">{</span>shrK <span class="bound">B</span> <span class="bound">C</span> <span class="main">|</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="bound">B</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∨</span> <span class="bound">C</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Payloads-keys_of_Ltk"><span class="command">lemma</span></span> keys_of_Ltk <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keys_of <span class="free">A</span> <span class="main">⊆</span> range LtK"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_of_def<span class="main">)</span>

<span class="keyword1" id="Payloads-priK_keys_of"><span class="command">lemma</span></span> priK_keys_of <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"priK <span class="free">A</span> <span class="main">∈</span> keys_of <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_of_def<span class="main">)</span>

<span class="keyword1" id="Payloads-shrK_keys_of_1"><span class="command">lemma</span></span> shrK_keys_of_1 <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"shrK <span class="free">A</span> <span class="free">B</span> <span class="main">∈</span> keys_of <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_of_def<span class="main">)</span>

<span class="keyword1" id="Payloads-shrK_keys_of_2"><span class="command">lemma</span></span> shrK_keys_of_2 <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"shrK <span class="free">B</span> <span class="free">A</span> <span class="main">∈</span> keys_of <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_of_def<span class="main">)</span>
<span class="keyword1" id="Payloads-priK_keys_of_eq"><span class="command">lemma</span></span> priK_keys_of_eq <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"priK <span class="free">B</span> <span class="main">∈</span> keys_of <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_of_def<span class="main">)</span>

<span class="keyword1" id="Payloads-shrK_keys_of_eq"><span class="command">lemma</span></span> shrK_keys_of_eq <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"shrK <span class="free">A</span> <span class="free">B</span> <span class="main">∈</span> keys_of <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_of_def<span class="main">)</span>

<span class="keyword1" id="Payloads-def_keys_of"><span class="command">lemma</span></span> def_keys_of <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> keys_of <span class="free">A</span> <span class="main">⟹</span> <span class="free">K</span> <span class="main">=</span> priK <span class="free">A</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">B</span><span class="main">.</span> <span class="free">K</span> <span class="main">=</span> shrK <span class="free">A</span> <span class="bound">B</span> <span class="main">∨</span> <span class="free">K</span> <span class="main">=</span> shrK <span class="bound">B</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_of_def<span class="main">)</span>

<span class="keyword1" id="Payloads-parts_keys_of"><span class="command">lemma</span></span> parts_keys_of <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>keys_of <span class="free">A</span><span class="main">)</span> <span class="main">=</span> keys_of <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_of_LtKeys<span class="main">)</span>


<span class="keyword1" id="Payloads-analz_keys_of"><span class="command">lemma</span></span> analz_keys_of <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>keys_of <span class="free">A</span><span class="main">)</span> <span class="main">=</span> keys_of <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Keys_bad›</span></span></span></span>: bounds on the attacker's knowledge of long-term keys.›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A set of keys contains all public long term keys, and only the private/shared keys 
of bad agents.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Keys_bad</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> agent set <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Keys_bad</span> <span class="free"><span class="bound"><span class="entity">IK</span></span></span> <span class="free"><span class="bound"><span class="entity">Bad</span></span></span> <span class="main">≡</span>    
    <span class="free"><span class="bound"><span class="entity">IK</span></span></span> <span class="main">∩</span> range LtK <span class="main">⊆</span> range pubK <span class="main">∪</span> <span class="main">⋃</span> <span class="main">(</span>keys_of <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">Bad</span></span></span><span class="main">)</span>
    <span class="main">∧</span> range pubK <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">IK</span></span></span>"</span></span>

<span class="comment1">― ‹basic lemmas›</span>

<span class="keyword1" id="Payloads-Keys_badI"><span class="command">lemma</span></span> Keys_badI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">IK</span> <span class="main">∩</span> range LtK <span class="main">⊆</span> range pubK <span class="main">∪</span> priK<span class="main">`</span><span class="free">Bad</span> <span class="main">∪</span> <span class="main">{</span>shrK <span class="bound">A</span> <span class="bound">B</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> <span class="free">Bad</span> <span class="main">∨</span> <span class="bound">B</span> <span class="main">∈</span> <span class="free">Bad</span><span class="main">}</span><span class="main">;</span> 
     range pubK <span class="main">⊆</span> <span class="free">IK</span>  <span class="main">⟧</span>
 <span class="main">⟹</span> Keys_bad <span class="free">IK</span> <span class="free">Bad</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>

<span class="keyword1" id="Payloads-Keys_badE"><span class="command">lemma</span></span> Keys_badE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Keys_bad <span class="free">IK</span> <span class="free">Bad</span><span class="main">;</span>
     <span class="main">⟦</span> range pubK <span class="main">⊆</span> <span class="free">IK</span><span class="main">;</span> 
       <span class="free">IK</span> <span class="main">∩</span> range LtK <span class="main">⊆</span> range pubK <span class="main">∪</span> <span class="main">⋃</span> <span class="main">(</span>keys_of <span class="main">`</span> <span class="free">Bad</span><span class="main">)</span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>

<span class="keyword1" id="Payloads-Keys_bad_Ltk"><span class="command">lemma</span></span> Keys_bad_Ltk <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Keys_bad <span class="main">(</span><span class="free">IK</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="free">Bad</span> <span class="main">⟷</span> Keys_bad <span class="free">IK</span> <span class="free">Bad</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>


<span class="keyword1" id="Payloads-Keys_bad_priK_D"><span class="command">lemma</span></span> Keys_bad_priK_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> priK <span class="free">A</span> <span class="main">∈</span> <span class="free">IK</span><span class="main">;</span> Keys_bad <span class="free">IK</span> <span class="free">Bad</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">Bad</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>

<span class="keyword1" id="Payloads-Keys_bad_shrK_D"><span class="command">lemma</span></span> Keys_bad_shrK_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> shrK <span class="free">A</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">IK</span><span class="main">;</span> Keys_bad <span class="free">IK</span> <span class="free">Bad</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">Bad</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">Bad</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> Keys_bad_dests <span class="main">[</span><span class="operator">dest</span><span class="main">]</span> <span class="main">=</span> Keys_bad_priK_D Keys_bad_shrK_D


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹interaction with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">insert</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="Payloads-Keys_bad_insert_non_LtK"><span class="command">lemma</span></span> Keys_bad_insert_non_LtK<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∉</span> range LtK <span class="main">⟹</span> Keys_bad <span class="main">(</span>insert <span class="free">X</span> <span class="free">IK</span><span class="main">)</span> <span class="free">Bad</span> <span class="main">⟷</span> Keys_bad <span class="free">IK</span> <span class="free">Bad</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>

<span class="keyword1" id="Payloads-Keys_bad_insert_pubK"><span class="command">lemma</span></span> Keys_bad_insert_pubK<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Keys_bad <span class="free">IK</span> <span class="free">Bad</span> <span class="main">⟧</span> <span class="main">⟹</span> Keys_bad <span class="main">(</span>insert <span class="main">(</span>pubK <span class="free">A</span><span class="main">)</span> <span class="free">IK</span><span class="main">)</span> <span class="free">Bad</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>

<span class="keyword1" id="Payloads-Keys_bad_insert_priK_bad"><span class="command">lemma</span></span> Keys_bad_insert_priK_bad<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Keys_bad <span class="free">IK</span> <span class="free">Bad</span><span class="main">;</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">Bad</span> <span class="main">⟧</span> <span class="main">⟹</span> Keys_bad <span class="main">(</span>insert <span class="main">(</span>priK <span class="free">A</span><span class="main">)</span> <span class="free">IK</span><span class="main">)</span> <span class="free">Bad</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>

<span class="keyword1" id="Payloads-Keys_bad_insert_shrK_bad"><span class="command">lemma</span></span> Keys_bad_insert_shrK_bad<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Keys_bad <span class="free">IK</span> <span class="free">Bad</span><span class="main">;</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">Bad</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">Bad</span> <span class="main">⟧</span> <span class="main">⟹</span> Keys_bad <span class="main">(</span>insert <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">IK</span><span class="main">)</span> <span class="free">Bad</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> Keys_bad_insert_lemmas <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> 
  Keys_bad_insert_non_LtK Keys_bad_insert_pubK 
  Keys_bad_insert_priK_bad Keys_bad_insert_shrK_bad


<span class="keyword1" id="Payloads-Keys_bad_insert_Fake"><span class="command">lemma</span></span> Keys_bad_insert_Fake<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Keys_bad <span class="free">IK</span> <span class="free">Bad</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"parts <span class="free">IK</span> <span class="main">∩</span> range LtK <span class="main">⊆</span> <span class="free">IK</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">IK</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Keys_bad <span class="main">(</span>insert <span class="free">X</span> <span class="free">IK</span><span class="main">)</span> <span class="free">Bad</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> range LtK"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ltk</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> LtK <span class="skolem">ltk</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_absorb <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz_into_parts<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∉</span> range LtK"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Payloads-Keys_bad_insert_keys_of"><span class="command">lemma</span></span> Keys_bad_insert_keys_of<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Keys_bad <span class="free">Ik</span> <span class="free">Bad</span> <span class="main">⟹</span>
   Keys_bad <span class="main">(</span>keys_of <span class="free">A</span> <span class="main">∪</span> <span class="free">Ik</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">A</span> <span class="free">Bad</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>

<span class="keyword1" id="Payloads-Keys_bad_insert_payload"><span class="command">lemma</span></span> Keys_bad_insert_payload<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Keys_bad <span class="free">Ik</span> <span class="free">Bad</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> payload <span class="main">⟹</span>
   Keys_bad <span class="main">(</span>insert <span class="free">x</span> <span class="free">Ik</span><span class="main">)</span> <span class="free">Bad</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Keys_bad_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>broken K›</span></span></span></span>: pairs of agents where at least one is compromised.›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Set of pairs (A,B) such that the priK of A or B, or their shared key, is in K›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">broken</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> <span class="main">(</span>agent <span class="main">*</span> agent<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">broken</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> priK <span class="bound">A</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∨</span> priK <span class="bound">B</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∨</span> shrK <span class="bound">A</span> <span class="bound">B</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∨</span> shrK <span class="bound">B</span> <span class="bound">A</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Payloads-brokenD"><span class="command">lemma</span></span> brokenD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">K</span> <span class="main">⟹</span> priK <span class="free">A</span> <span class="main">∈</span> <span class="free">K</span> <span class="main">∨</span> priK <span class="free">B</span> <span class="main">∈</span> <span class="free">K</span> <span class="main">∨</span> shrK <span class="free">A</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">K</span> <span class="main">∨</span> shrK <span class="free">B</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> broken_def<span class="main">)</span>

<span class="keyword1" id="Payloads-brokenI"><span class="command">lemma</span></span> brokenI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"priK <span class="free">A</span> <span class="main">∈</span> <span class="free">K</span> <span class="main">∨</span> priK <span class="free">B</span> <span class="main">∈</span> <span class="free">K</span> <span class="main">∨</span> shrK <span class="free">A</span> <span class="free">B</span> <span class="main">∈</span> <span class="free">K</span> <span class="main">∨</span> shrK <span class="free">B</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">K</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> broken_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Enc_keys_clean S›</span></span></span></span>: messages with ``clean'' symmetric encryptions.›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All terms used as symmetric keys in S are either long term keys or messages without 
implementation material.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Enc_keys_clean</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Enc_keys_clean</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> Enc <span class="bound">X</span> <span class="bound">Y</span> <span class="main">∈</span> parts <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟶</span> <span class="bound">Y</span> <span class="main">∈</span> range LtK <span class="main">∪</span> payload"</span></span>

<span class="keyword1" id="Payloads-Enc_keys_cleanI"><span class="command">lemma</span></span> Enc_keys_cleanI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> Enc <span class="bound">X</span> <span class="bound">Y</span> <span class="main">∈</span> parts <span class="free">S</span> <span class="main">⟶</span> <span class="bound">Y</span> <span class="main">∈</span> range LtK <span class="main">∪</span> payload <span class="main">⟹</span> Enc_keys_clean <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def<span class="main">)</span>

<span class="comment1">― ‹general lemmas about <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Enc_keys_clean›</span></span>›</span>
<span class="keyword1" id="Payloads-Enc_keys_clean_mono"><span class="command">lemma</span></span> Enc_keys_clean_mono<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> Enc_keys_clean <span class="free">G</span>"</span></span>  <span class="comment1">― ‹anti-tone›</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_monotone <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> G<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">G</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Payloads-Enc_keys_clean_Un"><span class="command">lemma</span></span> Enc_keys_clean_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟷</span> Enc_keys_clean <span class="free">G</span> <span class="main">∧</span> Enc_keys_clean <span class="free">H</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def<span class="main">)</span>


<span class="comment1">― ‹from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Enc_keys_clean S›</span></span>, the property on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>parts S›</span></span> also holds for <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>analz S›</span></span>›</span>
<span class="keyword1" id="Payloads-Enc_keys_clean_analz"><span class="command">lemma</span></span> Enc_keys_clean_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> analz <span class="free">S</span> <span class="main">⟹</span> Enc_keys_clean <span class="free">S</span> <span class="main">⟹</span> <span class="free">K</span> <span class="main">∈</span> range LtK <span class="main">∪</span> payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz_into_parts<span class="main">)</span>


<span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Enc_keys_clean›</span></span> and different types of messages›</span>
<span class="keyword1" id="Payloads-Enc_keys_clean_Tags"><span class="command">lemma</span></span> Enc_keys_clean_Tags <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Enc_keys_clean Tags"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def<span class="main">)</span>

<span class="keyword1" id="Payloads-Enc_keys_clean_LtKeys"><span class="command">lemma</span></span> Enc_keys_clean_LtKeys <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK <span class="main">⟹</span> Enc_keys_clean <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def<span class="main">)</span>

<span class="keyword1" id="Payloads-Enc_keys_clean_payload"><span class="command">lemma</span></span> Enc_keys_clean_payload <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NI</span> <span class="main">⊆</span> payload <span class="main">⟹</span> Enc_keys_clean <span class="free">NI</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sets of messages with particular constructors›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sets of all pairs, ciphertexts, and signatures constructed from a set of messages.›</span></span>
<span class="comment1">(*
 FIX: These should probably be turned into definitions, since they may create automation problems 
*)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">AgentSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AgentSet</span> <span class="main">≡</span> range Agent"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PairSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PairSet</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> <span class="main">{</span>Pair <span class="bound">X</span> <span class="bound">Y</span> <span class="main">|</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">EncSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EncSet</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span>Enc <span class="bound">X</span> <span class="bound">Y</span> <span class="main">|</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">AencSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AencSet</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span>Aenc <span class="bound">X</span> <span class="bound">Y</span> <span class="main">|</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SignSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SignSet</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span>Sign <span class="bound">X</span> <span class="bound">Y</span> <span class="main">|</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">HashSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HashSet</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">{</span>Hash <span class="bound">X</span> <span class="main">|</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Move <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Enc</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Aenc</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Sign</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Pair</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> sets out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">parts</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
›</span></span>

<span class="keyword1" id="Payloads-parts_PairSet"><span class="command">lemma</span></span> parts_PairSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>PairSet <span class="free">G</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> PairSet <span class="free">G</span> <span class="free">H</span> <span class="main">∪</span> parts <span class="free">G</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Payloads-parts_EncSet"><span class="command">lemma</span></span> parts_EncSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>EncSet <span class="free">G</span> <span class="free">K</span><span class="main">)</span> <span class="main">⊆</span> EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span>  <span class="main">∪</span> range Agent <span class="main">∪</span>  parts <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Payloads-parts_AencSet"><span class="command">lemma</span></span> parts_AencSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>AencSet <span class="free">G</span> <span class="free">K</span><span class="main">)</span> <span class="main">⊆</span> AencSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span>  <span class="main">∪</span> range Agent <span class="main">∪</span>  parts <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Payloads-parts_SignSet"><span class="command">lemma</span></span> parts_SignSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>SignSet <span class="free">G</span> <span class="free">K</span><span class="main">)</span> <span class="main">⊆</span> SignSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span>  <span class="main">∪</span> range Agent <span class="main">∪</span>  parts <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Payloads-parts_HashSet"><span class="command">lemma</span></span> parts_HashSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>HashSet <span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> HashSet <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> parts_msgSet <span class="main">=</span> parts_PairSet parts_EncSet parts_AencSet parts_SignSet parts_HashSet
<span class="keyword1"><span class="command">lemmas</span></span> parts_msgSetD <span class="main">=</span> parts_msgSet <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Remove the message sets from under the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> predicate.
Only when the first part is a set of agents or tags for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Pair</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, this is sufficient.›</span></span>

<span class="keyword1" id="Payloads-Enc_keys_clean_PairSet_Agent_Un"><span class="command">lemma</span></span> Enc_keys_clean_PairSet_Agent_Un<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> Enc_keys_clean <span class="main">(</span>PairSet <span class="main">(</span>Agent<span class="main">`</span><span class="free">X</span><span class="main">)</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_msgSetD<span class="main">)</span>

<span class="keyword1" id="Payloads-Enc_keys_clean_PairSet_Tag_Un"><span class="command">lemma</span></span> Enc_keys_clean_PairSet_Tag_Un<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> Enc_keys_clean <span class="main">(</span>PairSet Tags <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_msgSetD<span class="main">)</span>

<span class="keyword1" id="Payloads-Enc_keys_clean_AencSet_Un"><span class="command">lemma</span></span> Enc_keys_clean_AencSet_Un<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> Enc_keys_clean <span class="main">(</span>AencSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_msgSetD<span class="main">)</span>

<span class="keyword1" id="Payloads-Enc_keys_clean_EncSet_Un"><span class="command">lemma</span></span> Enc_keys_clean_EncSet_Un<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK <span class="main">⟹</span> Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> Enc_keys_clean <span class="main">(</span>EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_msgSetD<span class="main">)</span>

<span class="keyword1" id="Payloads-Enc_keys_clean_SignSet_Un"><span class="command">lemma</span></span> Enc_keys_clean_SignSet_Un<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> Enc_keys_clean <span class="main">(</span>SignSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_msgSetD<span class="main">)</span>

<span class="keyword1" id="Payloads-Enc_keys_clean_HashSet_Un"><span class="command">lemma</span></span> Enc_keys_clean_HashSet_Un<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> Enc_keys_clean <span class="main">(</span>HashSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_msgSetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> Enc_keys_clean_msgSet_Un <span class="main">=</span>
  Enc_keys_clean_PairSet_Tag_Un Enc_keys_clean_PairSet_Agent_Un
  Enc_keys_clean_EncSet_Un Enc_keys_clean_AencSet_Un
  Enc_keys_clean_SignSet_Un Enc_keys_clean_HashSet_Un


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas for moving message sets out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"analz"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">EncSet</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="Payloads-analz_Un_EncSet"><span class="command">lemma</span></span> analz_Un_EncSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="main">(</span>EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dec <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span>     
    <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> range LtK <span class="main">∪</span> payload"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_analz<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Dec.IH<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_payload2 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>  
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_eph <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span>  
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EpriK_synth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">EncSet</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 2nd case: the keys are unknown.›</span></span>

<span class="keyword1" id="Payloads-analz_Un_EncSet2"><span class="command">lemma</span></span> analz_Un_EncSet2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∩</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="main">(</span>EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dec <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> range LtK <span class="main">∪</span> payload"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="free">H</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_analz<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>EncSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="free">H</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> synth_payload2 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> payload_Enc<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> payload"</span></span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">K</span> <span class="main">⊆</span> range LtK›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">KK</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> LtK <span class="skolem">KK</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">∈</span> payload›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> EncSet <span class="free">G</span> <span class="free">K</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹<span class="free">K</span> <span class="main">⊆</span> range LtK›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">KK</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">=</span> LtK <span class="skolem">KK</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Dec.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">K</span> <span class="main">∩</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_eph <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EpriK_synth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AencSet</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="Payloads-analz_Un_AencSet"><span class="command">lemma</span></span> analz_Un_AencSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>AencSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> AencSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="main">(</span>AencSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> AencSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dec <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> range LtK <span class="main">∪</span> payload"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_analz<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>AencSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Dec.IH<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_payload2 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_eph <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EpriK_synth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AencSet</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 2nd case: the keys are unknown.›</span></span>

<span class="keyword1" id="Payloads-analz_Un_AencSet2"><span class="command">lemma</span></span> analz_Un_AencSet2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"priK<span class="main">`</span><span class="free">Ag</span> <span class="main">∩</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>AencSet <span class="free">G</span> <span class="main">(</span>pubK<span class="main">`</span><span class="free">Ag</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> AencSet <span class="free">G</span> <span class="main">(</span>pubK<span class="main">`</span><span class="free">Ag</span><span class="main">)</span> <span class="main">∪</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="main">(</span>AencSet <span class="free">G</span> <span class="main">(</span>pubK<span class="main">`</span> <span class="free">Ag</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> AencSet <span class="free">G</span> <span class="main">(</span>pubK<span class="main">`</span> <span class="free">Ag</span><span class="main">)</span> <span class="main">∪</span> analz <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dec <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> range LtK <span class="main">∪</span> payload"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="free">H</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_analz<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>AencSet <span class="free">G</span> <span class="main">(</span>pubK<span class="main">`</span><span class="free">Ag</span><span class="main">)</span> <span class="main">∪</span> analz <span class="free">H</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_payload2 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_eph <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EpriK_synth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">PairSet</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Payloads-analz_Un_PairSet"><span class="command">lemma</span></span> analz_Un_PairSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="main">(</span>PairSet <span class="free">G</span> <span class="free">G'</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> PairSet <span class="free">G</span> <span class="free">G'</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">G'</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="main">(</span>PairSet <span class="free">G</span> <span class="free">G'</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> PairSet <span class="free">G</span> <span class="free">G'</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">G'</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dec <span class="skolem">Y</span> <span class="skolem">K</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> Dec.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">Y</span> <span class="skolem">K</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">G'</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Dec.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">∈</span> synth <span class="main">(</span>PairSet <span class="free">G</span> <span class="free">G'</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">G'</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">G'</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> synth_trans<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_eph <span class="skolem">Y</span> <span class="skolem">K</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EpriK_synth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹move the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>SignSet›</span></span> out of the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>analz›</span></span>›</span>
<span class="keyword1" id="Payloads-analz_Un_SignSet"><span class="command">lemma</span></span> analz_Un_SignSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>SignSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> SignSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="main">(</span>SignSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> SignSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dec <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> Dec.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> range LtK <span class="main">∪</span> payload"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_analz<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> Dec.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>SignSet <span class="free">G</span> <span class="free">K</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> "</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_payload2 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_eph <span class="skolem">Y</span> <span class="skolem">K</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EpriK_synth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Tags</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="Payloads-analz_Un_Tag"><span class="command">lemma</span></span> analz_Un_Tag<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>Tags <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> Tags <span class="main">∪</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="main">(</span>Tags <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> Tags <span class="main">∪</span> analz <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dec <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Dec.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> range LtK <span class="main">∪</span> payload"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="free">H</span>›</span></span> assms 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_analz<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>Tags <span class="main">∪</span> analz <span class="free">H</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_payload2 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_eph <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EpriK_synth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pull the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">AgentSet</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="Payloads-analz_Un_AgentSet"><span class="command">lemma</span></span> analz_Un_AgentSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>AgentSet <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> AgentSet <span class="main">∪</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="main">(</span>AgentSet <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> AgentSet <span class="main">∪</span> analz <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dec <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>AgentSet <span class="main">∪</span> analz <span class="free">H</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>AgentSet <span class="main">∪</span> analz <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> synth_subset_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_eph <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EpriK_synth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">HashSet</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Payloads-analz_Un_HashSet"><span class="command">lemma</span></span> analz_Un_HashSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="main">-</span> payload"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>HashSet <span class="free">G</span>  <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> HashSet <span class="free">G</span> <span class="main">∪</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="main">(</span>HashSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> HashSet <span class="free">G</span> <span class="main">∪</span> analz <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dec <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> range LtK <span class="main">∪</span> payload"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Enc <span class="skolem">Y</span> <span class="skolem">K'</span> <span class="main">∈</span> analz <span class="free">H</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_analz<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> range LtK"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">KK</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">=</span> LtK <span class="skolem">KK</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Dec.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> payload"</span></span>  
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HashSet <span class="free">G</span> <span class="main">∩</span> payload <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>HashSet <span class="free">G</span> <span class="main">∪</span> analz <span class="free">H</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_Int2<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K'</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_payload2 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">K'</span> <span class="main">∈</span> payload›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_eph <span class="skolem">Y</span> <span class="skolem">K'</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EpriK_synth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Implem">
<div class="head">
<h1>Theory Implem</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Implem.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Implem.thy 132885 2016-12-23 18:41:32Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Parametric channel message implementation
  - definition of 'valid' implementations
  - assumptions for channel implementations (formulated as locales)

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Assumptions for Channel Message Implementation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a series of locales capturing our assumptions on channel message 
implementations.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Implem
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Channels.html">Channels</a> <a href="Payloads.html">Payloads</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹First step: basic implementation locale›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This locale has no assumptions, it only fixes an implementation function and 
defines some useful abbreviations (impl*, impl*Set) and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>valid›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> basic_implem <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">implem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chan <span class="main">⇒</span> msg"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">implInsec</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="free">implem</span> <span class="main">(</span>Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">implConfid</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="free">implem</span> <span class="main">(</span>Confid <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">implAuth</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="free">implem</span> <span class="main">(</span>Auth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">implSecure</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="free">implem</span> <span class="main">(</span>Secure <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implInsecSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">implInsecSet</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">{</span>implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implConfidSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>agent <span class="main">*</span> agent<span class="main">)</span> set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">implConfidSet</span> <span class="free"><span class="bound"><span class="entity">Ag</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">{</span>implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span>  <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Ag</span></span></span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implAuthSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">implAuthSet</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">{</span>implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implSecureSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>agent <span class="main">*</span> agent<span class="main">)</span> set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">implSecureSet</span> <span class="free"><span class="bound"><span class="entity">Ag</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">{</span>implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Ag</span></span></span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid</span> <span class="main">≡</span> <span class="main">{</span><span class="free">implem</span> <span class="main">(</span>Chan <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">}</span>"</span></span>

<span class="keyword1" id="Implem-validI"><span class="command">lemma</span></span> validI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">∈</span> valid"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1" id="Implem-validE"><span class="command">lemma</span></span> validE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> valid <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="free">implem</span> <span class="main">(</span>Chan <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1" id="Implem-valid_cases"><span class="command">lemma</span></span> valid_cases<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="free">P</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> valid"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="bound">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="bound">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="bound">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="bound">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="free">implem</span> <span class="main">(</span>Chan <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> validE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="free">implem</span> <span class="main">(</span>Chan <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">implem</span> <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> payload"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Second step: basic and analyze assumptions›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This locale contains most of the assumptions on implem, i.e.:
\begin{itemize}
\item <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>impl_inj›</span></span></span></span>: injectivity
\item <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>parts_impl_inj›</span></span></span></span>: injectivity through parts
\item <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Enc_parts_valid_impl›</span></span></span></span>: if Enc X Y appears in parts of an implem, then it is 
  in parts of the payload, or the key is either long term or payload
\item <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>impl_composed›</span></span></span></span>: the implementations are composed (not nonces, agents, tags etc.)
\item <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>analz_Un_implXXXSet›</span></span></span></span>: move the impl*Set out of the analz (only keep the payloads)
\item <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>impl_Impl›</span></span></span></span>: implementations contain implementation material
\item <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LtK_parts_impl›</span></span></span></span>: no exposed long term keys in the implementations 
  (i.e., they are only used as keys, or under hashes)
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> semivalid_implem <span class="main">=</span> basic_implem <span class="main">+</span>
<span class="comment1">― ‹injectivity›</span>
<span class="keyword2"><span class="keyword">assumes</span></span> impl_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x'</span> <span class="free">A'</span> <span class="free">B'</span> <span class="free">M'</span><span class="main">)</span> 
   <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A'</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B'</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">=</span> <span class="free">M'</span>"</span></span>
<span class="comment1">― ‹implementations and parts›</span>
<span class="keyword2"><span class="keyword">and</span></span> parts_impl_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M'</span> <span class="main">∈</span> payload <span class="main">⟹</span>
   <span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">{</span><span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x'</span> <span class="free">A'</span> <span class="free">B'</span> <span class="free">M'</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span> 
   <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A'</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B'</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">=</span> <span class="free">M'</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Enc_keys_clean_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> valid <span class="main">⟹</span> Enc_keys_clean <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> impl_composed<span class="main">:</span> <span class="quoted"><span class="quoted">"composed <span class="main">(</span><span class="free">implem</span> <span class="free">Z</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> impl_Impl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">∉</span> payload"</span></span>
<span class="comment1">― ‹no ltk in the parts of an implementation›</span>
<span class="keyword2"><span class="keyword">and</span></span> LtK_parts_impl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> valid <span class="main">⟹</span> LtK <span class="free">K</span> <span class="main">∉</span> parts <span class="main">{</span><span class="free">X</span><span class="main">}</span>"</span></span>

<span class="comment1">― ‹analyze assumptions:›</span>
<span class="keyword2"><span class="keyword">and</span></span> analz_Un_implInsecSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">G</span> <span class="main">⊆</span> payload<span class="main">;</span> Enc_keys_clean <span class="free">H</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> analz <span class="main">(</span>implInsecSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> analz_Un_implConfidSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">G</span> <span class="main">⊆</span> payload<span class="main">;</span> Enc_keys_clean <span class="free">H</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> analz <span class="main">(</span>implConfidSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> analz_Un_implConfidSet_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">G</span> <span class="main">⊆</span> payload<span class="main">;</span> Enc_keys_clean <span class="free">H</span><span class="main">;</span> <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
 <span class="main">⟹</span> analz <span class="main">(</span>implConfidSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> analz_Un_implAuthSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">G</span> <span class="main">⊆</span> payload<span class="main">;</span> Enc_keys_clean <span class="free">H</span> <span class="main">⟧</span>
 <span class="main">⟹</span> analz <span class="main">(</span>implAuthSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> analz_Un_implSecureSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">G</span> <span class="main">⊆</span> payload<span class="main">;</span> Enc_keys_clean <span class="free">H</span> <span class="main">⟧</span>
 <span class="main">⟹</span> analz <span class="main">(</span>implSecureSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> analz_Un_implSecureSet_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">G</span> <span class="main">⊆</span> payload<span class="main">;</span> Enc_keys_clean <span class="free">H</span><span class="main">;</span> <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
 <span class="main">⟹</span> analz <span class="main">(</span>implSecureSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">― ‹declare some attributes and abbreviations for the hypotheses›</span>
<span class="comment1">― ‹and prove some simple consequences of the hypotheses›</span>
<span class="keyword1"><span class="command">declare</span></span> impl_inj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> parts_implE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> parts_impl_inj <span class="main">[</span><span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> impl_composed <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>

<span class="keyword1" id="Implem-composed_arg_cong"><span class="command">lemma</span></span> composed_arg_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">⟹</span> composed <span class="free">X</span> <span class="main">⟷</span> composed <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main">)</span>

<span class="keyword1" id="Implem-implem_Tags_aux"><span class="command">lemma</span></span> implem_Tags_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">∉</span> Tags"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> composed_arg_cong<span class="main">)</span>
<span class="keyword1" id="Implem-implem_Tags"><span class="command">lemma</span></span> implem_Tags <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">implem</span> <span class="free">x</span> <span class="main">∉</span> Tags"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implem_Tags_aux<span class="main">)</span>
<span class="keyword1" id="Implem-implem_LtK_aux"><span class="command">lemma</span></span> implem_LtK_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">≠</span> LtK <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> composed_arg_cong<span class="main">)</span>
<span class="keyword1" id="Implem-implem_LtK"><span class="command">lemma</span></span> implem_LtK <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">implem</span> <span class="free">x</span> <span class="main">≠</span> LtK <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implem_LtK_aux<span class="main">)</span>
<span class="keyword1" id="Implem-implem_LtK2"><span class="command">lemma</span></span> implem_LtK2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">implem</span> <span class="free">x</span> <span class="main">∉</span> range LtK"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implem_LtK_aux<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> impl_Impl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Implem-LtK_parts_impl_insert"><span class="command">lemma</span></span> LtK_parts_impl_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LtK <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>insert <span class="main">(</span><span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> LtK <span class="free">K</span> <span class="main">∈</span> parts <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> validI LtK_parts_impl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">declare</span></span> LtK_parts_impl_insert <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> Enc_keys_clean_valid <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>

<span class="keyword1" id="Implem-valid_composed"><span class="command">lemma</span></span> valid_composed <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> valid <span class="main">⟹</span> composed <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> validE<span class="main">)</span>

<span class="comment1">― ‹lemmas: valid/payload are mutually exclusive›</span>
<span class="keyword1" id="Implem-valid_payload"><span class="command">lemma</span></span> valid_payload <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> valid<span class="main">;</span> <span class="free">X</span> <span class="main">∈</span> payload <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validE<span class="main">)</span>
    
<span class="comment1">― ‹valid/LtK are mutually exclusive›</span>
<span class="keyword1" id="Implem-valid_isLtKey"><span class="command">lemma</span></span> valid_isLtKey <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> valid<span class="main">;</span> <span class="free">X</span> <span class="main">∈</span> range LtK <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem-analz_valid"><span class="command">lemma</span></span> analz_valid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   <span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">⟹</span>
   <span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> analz_into_parts<span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">drule</span> parts_monotone <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">H</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"payload <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span> <span class="main"><span class="main">∩</span></span> valid <span class="main"><span class="main">∪</span></span> range LtK <span class="main"><span class="main">∪</span></span> Tags"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> parts_singleton<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>validE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> parts_impl_inj<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem-parts_valid_LtKeys_disjoint"><span class="command">lemma</span></span> parts_valid_LtKeys_disjoint<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> valid <span class="main">⟹</span> parts <span class="free">I</span> <span class="main">∩</span> range LtK <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_singleton<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD LtK_parts_impl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem-analz_LtKeys"><span class="command">lemma</span></span> analz_LtKeys<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   analz <span class="free">H</span> <span class="main">∩</span> range LtK <span class="main">⊆</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> analz_into_parts<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_monotone <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">H</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"payload <span class="main"><span class="main">∪</span></span> valid <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span> <span class="main"><span class="main">∩</span></span> range LtK <span class="main"><span class="main">∪</span></span> Tags"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> parts_singleton<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>validE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> parts_impl_inj<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Third step: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>valid_implem›</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This extends <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> "semivalid_implem"<span class="antiquote"><span class="antiquote">}</span></span></span></span> with four new assumptions, which under certain 
  conditions give information on $A$, $B$, $M$ when <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">implXXX</span></span> <span class="free"><span class="free">A</span></span> <span class="free"><span class="free">B</span></span> <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">∈</span></span> synth <span class="main"><span class="main">(</span></span>analz <span class="free"><span class="free">Z</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  These assumptions are separated because interpretations are more easily proved, if the 
  conclusions that follow from the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> "semivalid_implem"<span class="antiquote"><span class="antiquote">}</span></span></span></span> assumptions are already 
  available.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> valid_implem <span class="main">=</span> semivalid_implem <span class="main">+</span>

<span class="comment1">― ‹Synthesize assumptions: conditions on payloads $M$ implied by derivable›</span>
<span class="comment1">― ‹channel messages with payload $M$.›</span>
<span class="keyword2"><span class="keyword">assumes</span></span> implInsec_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   implInsec <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   implInsec <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> implConfid_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   implConfid <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   implConfid <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> implAuth_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   implAuth <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   implAuth <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="main">(</span><span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> implSecure_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   implSecure <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   implSecure <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="main">(</span><span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Implem_lemmas">
<div class="head">
<h1>Theory Implem_lemmas</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Implem_lemmas.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Implem_lemmas.thy 132885 2016-12-23 18:41:32Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Auxiliary notions and lemmas for channel implementations.
  - message abstraction = inverse of (valid) impl, lifted to sets
  - extractable messages (those of non-confidential and "broken" channels)
  - lemmas for proving L2-L3 intruder refinement

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lemmas Following from Channel Message Implementation Assumptions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Implem_lemmas
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Implem.html">Implem</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These lemmas require the assumptions added in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> "valid_implem"<span class="antiquote"><span class="antiquote">}</span></span></span></span> locale.›</span></span>

<span class="keyword1"><span class="command">context</span></span> semivalid_implem
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Message implementations and abstractions›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstracting a set of messages into channel messages.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> chan set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abs</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span>Chan <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> payload <span class="main">∧</span> <span class="free">implem</span> <span class="main">(</span>Chan <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Implem_lemmas-absE"><span class="command">lemma</span></span> absE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> abs <span class="free">H</span><span class="main">;</span>
     <span class="main">⋀</span> <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> Chan <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="bound">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">implem</span> <span class="free">X</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_def<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-absI"><span class="command">lemma</span></span> absI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> <span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> abs <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_def<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-abs_mono"><span class="command">lemma</span></span> abs_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> abs <span class="free">G</span> <span class="main">⊆</span> abs <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> abs_monotone <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> abs_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1" id="Implem_lemmas-abs_empty"><span class="command">lemma</span></span> abs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_def<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-abs_Un_eq"><span class="command">lemma</span></span> abs_Un_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> abs <span class="free">G</span> <span class="main">∪</span> abs <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General lemmas about implementations and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">abs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Implem_lemmas-abs_insert_payload"><span class="command">lemma</span></span> abs_insert_payload <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> abs <span class="main">(</span>insert <span class="free">M</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> abs <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_def<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-abs_insert_impl"><span class="command">lemma</span></span> abs_insert_impl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> payload <span class="main">⟹</span> abs <span class="main">(</span>insert <span class="main">(</span><span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>abs <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_def<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-extr_payload"><span class="command">lemma</span></span> extr_payload <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span> <span class="main">∈</span> extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">;</span> <span class="free">NI</span> <span class="main">⊆</span> payload <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> extr.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-abs_Un_LtK"><span class="command">lemma</span></span> abs_Un_LtK<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK <span class="main">⟹</span> abs <span class="main">(</span><span class="free">K</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> abs <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_Un_eq<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-abs_Un_keys_of"><span class="command">lemma</span></span> abs_Un_keys_of <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs <span class="main">(</span>keys_of <span class="free">A</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> abs <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> abs_Un_LtK<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">valid</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">abs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Implem_lemmas-abs_validSet"><span class="command">lemma</span></span> abs_validSet<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">=</span> abs <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> absE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> validI<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-valid_abs"><span class="command">lemma</span></span> valid_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> valid <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">M'</span><span class="main">.</span> <span class="bound">M'</span> <span class="main">∈</span> abs <span class="main">{</span><span class="free">M</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> validE<span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extractable messages›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>extractable K I›</span></span></span></span>: subset of messages in $I$ which are implementations 
(not necessarily valid since we do not require that they are payload) and can be extracted 
using the keys in K. It corresponds to L2 <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">extr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">extractable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extractable</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span>
    <span class="main">{</span>implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Implem_lemmas-extractable_red"><span class="command">lemma</span></span> extractable_red<span class="main">:</span> <span class="quoted"><span class="quoted">"extractable <span class="free">K</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extractable_def<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-extractableI"><span class="command">lemma</span></span> extractableI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">=</span> insec <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> auth <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">=</span> confid <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> secure<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">K</span><span class="main">)</span> <span class="main">⟹</span>   
   <span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">∈</span> extractable <span class="free">K</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extractable_def<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-extractableE"><span class="command">lemma</span></span> extractableE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> extractable <span class="free">K</span> <span class="free">I</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">K</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">K</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extractable_def brokenI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General lemmas about implementations and extractable.›</span></span>
<span class="keyword1" id="Implem_lemmas-implem_extractable"><span class="command">lemma</span></span> implem_extractable <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Keys_bad <span class="free">K</span> <span class="free">Bad</span><span class="main">;</span> <span class="free">implem</span> <span class="main">(</span>Chan <span class="free">x</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="main">∈</span> extractable <span class="free">K</span> <span class="free">I</span><span class="main">;</span> <span class="free">M</span> <span class="main">∈</span> payload <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="free">M</span> <span class="main">∈</span> extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> extractableE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary lemmas about extractable messages: they are implementations.›</span></span>
<span class="keyword1" id="Implem_lemmas-valid_extractable"><span class="command">lemma</span></span> valid_extractable <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> valid <span class="main">⟹</span> extractable <span class="free">K</span> <span class="free">I</span> <span class="main">⊆</span> valid"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_trans extractable_red <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-LtKeys_parts_extractable"><span class="command">lemma</span></span> LtKeys_parts_extractable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> valid <span class="main">⟹</span> parts <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span><span class="main">)</span> <span class="main">∩</span> range LtK <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> valid_extractable <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_valid_LtKeys_disjoint<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-LtKeys_parts_extractable_elt"><span class="command">lemma</span></span> LtKeys_parts_extractable_elt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> valid <span class="main">⟹</span> LtK <span class="free">ltk</span> <span class="main">∉</span> parts <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LtKeys_parts_extractable<span class="main">)</span>


<span class="keyword1" id="Implem_lemmas-LtKeys_parts_implSecureSet"><span class="command">lemma</span></span> LtKeys_parts_implSecureSet<span class="main">:</span>   <span class="comment1">(* FIX: possibly problematic: not in normal form *)</span>
  <span class="quoted"><span class="quoted">"parts <span class="main">(</span>implSecureSet <span class="free">Ag</span> payload<span class="main">)</span> <span class="main">∩</span> range LtK <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_valid_LtKeys_disjoint <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> validI<span class="main">)</span>

<span class="keyword1" id="Implem_lemmas-LtKeys_parts_implSecureSet_elt"><span class="command">lemma</span></span> LtKeys_parts_implSecureSet_elt<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"LtK <span class="free">K</span> <span class="main">∉</span> parts <span class="main">(</span>implSecureSet <span class="free">Ag</span> payload<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> LtKeys_parts_implSecureSet
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> LtKeys_parts <span class="main">=</span> LtKeys_parts_payload parts_valid_LtKeys_disjoint
                      LtKeys_parts_extractable LtKeys_parts_implSecureSet 
                      LtKeys_parts_implSecureSet_elt


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Partition $I$ to keep only the extractable messages›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Partition the implementation set.›</span></span>

<span class="keyword1" id="Implem_lemmas-impl_partition"><span class="command">lemma</span></span> impl_partition<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">NI</span> <span class="main">⊆</span> payload<span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> valid <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">I</span> <span class="main">⊆</span> extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span>
      implConfidSet <span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> payload <span class="main">∪</span>
      implSecureSet <span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">I</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> valid_cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  extractableI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Partition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"extractable"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We partition the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"extractable"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> set into insecure, confidential, authentic 
implementations.›</span></span>

<span class="keyword1" id="Implem_lemmas-extractable_partition"><span class="command">lemma</span></span> extractable_partition<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Keys_bad <span class="free">K</span> <span class="free">Bad</span><span class="main">;</span> <span class="free">NI</span> <span class="main">⊆</span> payload<span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> valid<span class="main">⟧</span> <span class="main">⟹</span>
  extractable <span class="free">K</span> <span class="free">I</span> <span class="main">⊆</span> 
  implInsecSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
  implConfidSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
  implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
  implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> valid_extractable<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"extractable <span class="free"><span class="free">K</span></span> <span class="free"><span class="free">I</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> valid_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas for proving intruder refinement (L2-L3)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Chain of lemmas used to prove the refinement for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l3_dy›</span></span></span></span>. 
The ultimate goal is to show <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> [display] 
  <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span><span class="free"><span class="free">NI</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">I</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">K</span></span> <span class="main"><span class="main">∪</span></span> Tags<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⊆</span></span> synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>extr <span class="free"><span class="free">Bad</span></span> <span class="free"><span class="free">NI</span></span> <span class="main"><span class="main">(</span></span>abs <span class="free"><span class="free">I</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">-</span></span>payload"</span></span>
<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹First: we only keep the extractable messages›</span></span>

<span class="comment1">― ‹the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>synth›</span></span> is probably not needed›</span>
<span class="keyword1" id="Implem_lemmas-analz_NI_I_K_analz_NI_EI"><span class="command">lemma</span></span> analz_NI_I_K_analz_NI_EI<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> HNI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NI</span> <span class="main">⊆</span> payload"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> HK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> HI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> valid"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> <span class="main">⊆</span>
       synth <span class="main">(</span>analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> HNI HI
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> <span class="main">⊆</span> 
        analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span>
                     implConfidSet <span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> payload <span class="main">∪</span>
                     implSecureSet <span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> payload<span class="main">)</span>
                <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> analz_mono Un_mono impl_partition<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> analz <span class="main">(</span>implConfidSet <span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> payload <span class="main">∪</span>
                    <span class="main">(</span>implSecureSet <span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> payload <span class="main">∪</span>
                    <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>implSecureSet <span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> payload <span class="main">∪</span>
                  <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implConfidSet_2<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span>implSecureSet <span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> payload 
                              <span class="main">∪</span> <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNI HI HK <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> validI<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> HK HI HNI 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> <span class="main">∩</span> 
            broken <span class="main">(</span>parts <span class="main">(</span>
              implSecureSet <span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> payload <span class="main">∪</span>
              <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∩</span> range LtK<span class="main">)</span>  <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LtKeys_parts 
               LtKeys_parts_implSecureSet_elt <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Ag<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">-</span> broken <span class="free">K</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Un_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> synth_idem_payload<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implSecureSet <span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> payload <span class="main">∪</span> 
                   <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span>
            <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implSecureSet_2<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> HNI HK HI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>  
          <span class="keyword1"><span class="command">from</span></span> HI HK HNI 
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">-</span> broken <span class="free">K</span><span class="main">)</span> <span class="main">∩</span> 
                broken <span class="main">(</span>parts <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LtKeys_parts<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>payload <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup.left_commute sup_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Only keep the extracted messages (instead of extractable)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_lemmas-analz_NI_EI_K_synth_analz_NI_E_K"><span class="command">lemma</span></span> analz_NI_EI_K_synth_analz_NI_E_K<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> HNI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NI</span> <span class="main">⊆</span> payload"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> HK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> HI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> valid"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Hbad<span class="main">:</span> <span class="quoted"><span class="quoted">"Keys_bad <span class="free">K</span> <span class="free">Bad</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span>
    <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> HNI HI Hbad
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> <span class="main">⊆</span> 
        analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="main">(</span>implInsecSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                     implConfidSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                     implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                     implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                    <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> analz_mono Un_mono extractable_partition<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> analz <span class="main">(</span>implInsecSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                     <span class="main">(</span>implConfidSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                     <span class="main">(</span>implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                     <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                     <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                   <span class="main">(</span>implConfidSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                   <span class="main">(</span>implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                   <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                 <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implInsecSet<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_commute <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"extr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span> Un_assoc Un_absorb<span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNI HK HI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                   <span class="main">(</span>implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                   <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                 <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Un_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> synth_idem_payload<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implConfidSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                   <span class="main">(</span>implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                   <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
                   <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="main">(</span><span class="free">K</span> <span class="main">∪</span> extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                           <span class="main">(</span>implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                           <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
                           <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="main">(</span><span class="free">K</span> <span class="main">∪</span> extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
              <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implConfidSet<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_commute <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"extr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span> Un_assoc Un_absorb<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HK HI HNI  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                        <span class="main">(</span>implConfidSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                        <span class="main">(</span>implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                        <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                         <span class="main">(</span>implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                         <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
                         <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                   <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_sup_aci<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> inf_sup_aci<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>payload
            <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                           <span class="main">(</span>implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                           <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
              <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                   <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                 <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Un_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> synth_idem_payload<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                   <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
                   <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="main">(</span><span class="free">K</span> <span class="main">∪</span> <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                           <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
                           <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="main">(</span><span class="free">K</span> <span class="main">∪</span> <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
              <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implAuthSet<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_commute <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"extr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span> Un_assoc Un_absorb<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HI HNI HK <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                        <span class="main">(</span>implAuthSet <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                        <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                         <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
                         <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                   <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_sup_aci<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> inf_sup_aci<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>payload
            <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                           <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> 
                            <span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  
              <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                 <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Un_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> synth_idem_payload<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
                   <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="main">(</span><span class="free">K</span> <span class="main">∪</span> <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                           <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="main">(</span><span class="free">K</span> <span class="main">∪</span> <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
               <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implSecureSet<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_commute <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"extr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span> Un_assoc Un_absorb<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HI HNI HK <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span>
                        <span class="main">(</span>implSecureSet UNIV <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                   <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_sup_aci<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> inf_sup_aci<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>payload
            <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">∪</span> <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span> 
              <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IK_subset_extr inf_sup_aci<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> set_eq_subset sup.absorb1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Keys and Tags can be moved out of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"analz"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Implem_lemmas-analz_LtKeys_Tag"><span class="command">lemma</span></span> analz_LtKeys_Tag<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">NI</span> <span class="main">⊆</span> payload"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> <span class="main">⊆</span> analz <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> "</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> analz <span class="free">NI</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> analz.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Dec <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">∈</span> payload"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Dec.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">NI</span> <span class="main">∪</span> <span class="main">(</span><span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_disj_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_Int2 <span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Dec.IH<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_payload <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_lt <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="skolem">X</span> <span class="main">(</span>pubK <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> payload <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sign_getmsg <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sign <span class="skolem">X</span> <span class="main">(</span>priK <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> payload <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Adec_eph <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EpriK_synth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_lemmas-analz_NI_E_K_analz_NI_E"><span class="command">lemma</span></span> analz_NI_E_K_analz_NI_E<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">NI</span> <span class="main">⊆</span> payload<span class="main">;</span> <span class="free">K</span> <span class="main">⊆</span> range LtK<span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> valid <span class="main">⟧</span> 
 <span class="main">⟹</span> analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> <span class="main">⊆</span> analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_LtKeys_Tag<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Final lemmas, using all the previous ones›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_lemmas-analz_NI_I_K_synth_analz_NI_E"><span class="command">lemma</span></span> analz_NI_I_K_synth_analz_NI_E<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
  Hbad<span class="main">:</span> <span class="quoted"><span class="quoted">"Keys_bad <span class="free">K</span> <span class="free">Bad</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  HNI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NI</span> <span class="main">⊆</span> payload"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  HK<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">⊆</span> range LtK"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  HI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> valid"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> HNI HK HI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> <span class="main">⊆</span>
        synth <span class="main">(</span>analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_NI_I_K_analz_NI_EI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Un_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Hbad HNI HK HI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> <span class="main">⊆</span>
            synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> analz_NI_EI_K_synth_analz_NI_E_K<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> extractable <span class="free">K</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
                 synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> synth_idem_payload<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Un_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> HNI HK HI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span> <span class="main">⊆</span>
                           analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_NI_E_K_analz_NI_E<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> HK <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
                  synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> synth_idem_payload<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma actually used to prove the refinement.›</span></span>
<span class="keyword1" id="Implem_lemmas-synth_analz_NI_I_K_synth_analz_NI_E"><span class="command">lemma</span></span> synth_analz_NI_I_K_synth_analz_NI_E<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Keys_bad <span class="free">K</span> <span class="free">Bad</span><span class="main">;</span> <span class="free">NI</span> <span class="main">⊆</span> payload<span class="main">;</span> <span class="free">K</span> <span class="main">⊆</span> range LtK<span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> valid<span class="main">⟧</span>
 <span class="main">⟹</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">NI</span> <span class="main">∪</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">K</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> 
   <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="free">Bad</span> <span class="free">NI</span> <span class="main">(</span>abs <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> synth_idem_payload analz_NI_I_K_synth_analz_NI_E<span class="main">)</span> <span class="main">(</span><span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Partitioning <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span><span class="free"><span class="free">ik</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two lemmas useful for proving the invariant
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> [display] <span class="quoted"><span class="quoted">"analz <span class="free"><span class="free">ik</span></span> <span class="main"><span class="main">⊆</span></span> synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span><span class="free"><span class="free">ik</span></span> <span class="main"><span class="main">∩</span></span> payload <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">ik</span></span> <span class="main"><span class="main">∩</span></span> valid <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">ik</span></span> <span class="main"><span class="main">∩</span></span> range LtK <span class="main"><span class="main">∪</span></span> Tags<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1" id="Implem_lemmas-analz_Un_partition"><span class="command">lemma</span></span> analz_Un_partition<span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="free">S</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK <span class="main">⟹</span>
  analz <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span>
    synth <span class="main">(</span>analz <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> HH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> <span class="main">(</span><span class="free">H</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">H</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> HA<span class="main">:</span>
    <span class="quoted"><span class="quoted">"analz <span class="free">S</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
   <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> 
    synth <span class="main">(</span>analz <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_synth_subset_Un2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> HH <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">H</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">H</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
                         <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> 
                                 <span class="main">(</span><span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_left_commute sup.commute Int_Un_distrib2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_lemmas-analz_insert_partition"><span class="command">lemma</span></span> analz_insert_partition<span class="main">:</span>
  <span class="quoted"><span class="quoted">"analz <span class="free">S</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">x</span> <span class="main">∈</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK <span class="main">⟹</span>
  analz <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span>
    synth <span class="main">(</span>analz <span class="main">(</span><span class="main">(</span><span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> 
                  <span class="main">(</span><span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert_is_Un <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> analz_Un_partition<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Implem_symmetric">
<div class="head">
<h1>Theory Implem_symmetric</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Implem_symmetric.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Implem_symmetric.thy 132885 2016-12-23 18:41:32Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Symmetric channel implementation (locale interpretation) using
  symmetric encryption and HMACs

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Symmetric Implementation of Channel Messages›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Implem_symmetric
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Implem.html">Implem</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation of channel messages›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">implem_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chan <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">implem_sym</span> <span class="main">(</span>Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>InsecTag<span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟩</span>"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">implem_sym</span> <span class="main">(</span>Confid <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> Enc <span class="main">⟨</span>ConfidTag<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">implem_sym</span> <span class="main">(</span>Auth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span> hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">⟩</span>"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">implem_sym</span> <span class="main">(</span>Secure <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> Enc <span class="main">⟨</span>SecureTag<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
First step: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> "basic_implem"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
Trivial as there are no assumption, this locale just defines some useful abbreviations and valid.
›</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> sym<span class="main">:</span> basic_implem <span class="quoted">implem_sym</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Second step: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> "semivalid_implem"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Here we prove some basic properties such as injectivity and some properties about the 
interaction of sets of implementation messages with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>; these properties are 
proved as separate lemmas as the proofs are more complex. 
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary: simpler definitions of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>implSets›</span></span></span></span> for the proofs, using the 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>msgSet›</span></span></span></span> definitions. 
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implInsecSet_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">implInsecSet_aux</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> PairSet Tags <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implAuthSet_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">implAuthSet_aux</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> PairSet <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>HashSet <span class="main">(</span>PairSet <span class="main">(</span>PairSet Tags <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>case_prod shrK<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implConfidSet_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>agent <span class="main">*</span> agent<span class="main">)</span> set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">implConfidSet_aux</span> <span class="free"><span class="bound"><span class="entity">Ag</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> EncSet <span class="main">(</span>PairSet Tags <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span>case_prod shrK<span class="main">`</span><span class="free"><span class="bound"><span class="entity">Ag</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implSecureSet_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>agent <span class="main">*</span> agent<span class="main">)</span> set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted">"<span class="free">implSecureSet_aux</span> <span class="free"><span class="bound"><span class="entity">Ag</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> EncSet <span class="main">(</span>PairSet Tags <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span>case_prod shrK<span class="main">`</span><span class="free"><span class="bound"><span class="entity">Ag</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These auxiliary definitions are overapproximations.›</span></span>

<span class="keyword1" id="Implem_symmetric-implInsecSet_implInsecSet_aux"><span class="command">lemma</span></span> implInsecSet_implInsecSet_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"sym.implInsecSet <span class="free">G</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Implem_symmetric-implAuthSet_implAuthSet_aux"><span class="command">lemma</span></span> implAuthSet_implAuthSet_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"sym.implAuthSet <span class="free">G</span> <span class="main">⊆</span> implAuthSet_aux <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_symmetric-implConfidSet_implConfidSet_aux"><span class="command">lemma</span></span> implConfidSet_implConfidSet_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"sym.implConfidSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">⊆</span> implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_symmetric-implSecureSet_implSecureSet_aux"><span class="command">lemma</span></span> implSecureSet_implSecureSet_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"sym.implSecureSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">⊆</span> implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> implSet_implSet_aux <span class="main">=</span>
  implInsecSet_implInsecSet_aux implAuthSet_implAuthSet_aux
  implConfidSet_implConfidSet_aux implSecureSet_implSecureSet_aux

<span class="keyword1"><span class="command">declare</span></span> Enc_keys_clean_msgSet_Un <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas to pull implementation sets out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
All these proofs are similar:
\begin{enumerate}
\item prove the lemma for the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">implSet_aux</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and with the set added outside of  
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> given explicitly,
\item prove the lemma for the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">implSet_aux</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> but with payload, and
\item prove the lemma for the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">implSet</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\end{enumerate}
There  are two cases for the confidential and secure messages:
the general case (the payloads stay in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>  <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) and the case where the key is unknown
(the messages cannot be opened and are completely removed from the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).
›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implInsecSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implInsecSet_aux_1"><span class="command">lemma</span></span> analz_Un_implInsecSet_aux_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
     implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span>
     PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span>
     PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span> <span class="main">∪</span>
     analz <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span>
          analz <span class="main">(</span>Tags <span class="main">∪</span> PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_PairSet<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> 
            analz <span class="main">(</span>Tags <span class="main">∪</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span>
          <span class="main">(</span>Tags <span class="main">∪</span> analz <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz_Un_Tag<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span>
                  analz <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span>
                  analz <span class="main">(</span>range Agent <span class="main">∪</span> PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz_Un_PairSet<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span>
                  analz <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span>
                  <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span> <span class="main">∪</span> analz <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz_Un_PairSet<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span>
                  PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> analz <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc Un_commute<span class="main">)</span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implInsecSet_aux_2"><span class="command">lemma</span></span> analz_Un_implInsecSet_aux_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
     implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> 
     synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> HH<span class="main">:</span><span class="quoted"><span class="quoted">"PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span>
                  PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> HHH<span class="main">:</span><span class="quoted"><span class="quoted">"analz <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 
            synth <span class="main">(</span>analz <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="main">(</span>synth <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>synth <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> synth_analz_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>synth <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> synth_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> 
   <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span>  
      implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span>
      PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span> <span class="main">∪</span> analz <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implInsecSet_aux_1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> 
                   <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="main">(</span>PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span>
                   PairSet <span class="main">(</span>range Agent<span class="main">)</span> <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> analz <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>range Agent <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
                    synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HH HHH<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implInsecSet_aux_3"><span class="command">lemma</span></span> analz_Un_implInsecSet_aux_3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implInsecSet_aux_2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implInsecSet"><span class="command">lemma</span></span> analz_Un_implInsecSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>sym.implInsecSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implInsecSet_aux <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implInsecSet_aux_3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implConfidSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implConfidSet_aux_1"><span class="command">lemma</span></span> analz_Un_implConfidSet_aux_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
     implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span>
     analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
        implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> analz <span class="main">(</span>PairSet Tags <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_EncSet<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>PairSet Tags <span class="free">G</span> <span class="main">∪</span> analz <span class="main">(</span>Tags <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz_Un_PairSet<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> analz <span class="main">(</span>Tags <span class="main">∪</span> <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>Tags <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz_Un_Tag<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implConfidSet_aux_2"><span class="command">lemma</span></span> analz_Un_implConfidSet_aux_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
     implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span>
     synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
                implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implConfidSet_aux_1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implConfidSet_aux_3"><span class="command">lemma</span></span> analz_Un_implConfidSet_aux_3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
  analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implConfidSet_aux_2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implConfidSet"><span class="command">lemma</span></span> analz_Un_implConfidSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>sym.implConfidSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implConfidSet_aux <span class="free"><span class="free">Ag</span></span> <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implConfidSet_aux_3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implConfidSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 2nd case where the agents are honest.›</span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implConfidSet_2_aux_1"><span class="command">lemma</span></span> analz_Un_implConfidSet_2_aux_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_EncSet2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>analz_into_parts<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implConfidSet_2_aux_3"><span class="command">lemma</span></span> analz_Un_implConfidSet_2_aux_3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implConfidSet_2_aux_1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implConfidSet_2"><span class="command">lemma</span></span> analz_Un_implConfidSet_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>sym.implConfidSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implConfidSet_aux <span class="free"><span class="free">Ag</span></span> <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implConfidSet_2_aux_3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implSecureSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implSecureSet_aux_1"><span class="command">lemma</span></span> analz_Un_implSecureSet_aux_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
     implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span>
     analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
        implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> analz <span class="main">(</span>PairSet Tags <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_EncSet<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>PairSet Tags <span class="free">G</span> <span class="main">∪</span> analz <span class="main">(</span>Tags <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz_Un_PairSet<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> analz <span class="main">(</span>Tags <span class="main">∪</span> <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> <span class="main">(</span>Tags <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz_Un_Tag<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H<span class="main">)</span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implSecureSet_aux_2"><span class="command">lemma</span></span> analz_Un_implSecureSet_aux_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
     implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span>
     synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
                implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implSecureSet_aux_1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet Tags <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implSecureSet_aux_3"><span class="command">lemma</span></span> analz_Un_implSecureSet_aux_3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
  analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implSecureSet_aux_2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implSecureSet"><span class="command">lemma</span></span> analz_Un_implSecureSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>sym.implSecureSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implSecureSet_aux <span class="free"><span class="free">Ag</span></span> <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implSecureSet_aux_3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implSecureSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 2nd case, where the agents are honest. 
›</span></span>
<span class="keyword1" id="Implem_symmetric-analz_Un_implSecureSet_2_aux_1"><span class="command">lemma</span></span> analz_Un_implSecureSet_2_aux_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_EncSet2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>analz_into_parts<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implSecureSet_2_aux_3"><span class="command">lemma</span></span> analz_Un_implSecureSet_2_aux_3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implSecureSet_2_aux_1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implSecureSet_2"><span class="command">lemma</span></span> analz_Un_implSecureSet_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>sym.implSecureSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implSecureSet_aux <span class="free"><span class="free">Ag</span></span> <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implSecureSet_2_aux_3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implAuthSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implAuthSet_aux_1"><span class="command">lemma</span></span> analz_Un_implAuthSet_aux_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
     implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> HashSet <span class="main">(</span>PairSet <span class="main">(</span>PairSet Tags <span class="free">G</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>case_prod shrK<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
     analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> implAuthSet_aux <span class="free">G</span> <span class="main">∪</span>
          analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> HashSet <span class="main">(</span>PairSet <span class="main">(</span>PairSet Tags <span class="free">G</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>case_prod shrK<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_PairSet<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> implAuthSet_aux <span class="free">G</span> <span class="main">∪</span>
          analz <span class="main">(</span>HashSet <span class="main">(</span>PairSet <span class="main">(</span>PairSet Tags <span class="free">G</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>case_prod shrK<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> implAuthSet_aux <span class="free">G</span> <span class="main">∪</span>
          analz <span class="main">(</span>HashSet <span class="main">(</span>PairSet <span class="main">(</span>PairSet Tags <span class="free">G</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>case_prod shrK<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> 
            <span class="main">(</span>HashSet <span class="main">(</span>PairSet <span class="main">(</span>PairSet Tags <span class="free">G</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>case_prod shrK<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
             analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz_Un_HashSet<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> H<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> 
                   HashSet <span class="main">(</span>PairSet <span class="main">(</span>PairSet Tags <span class="free">G</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>case_prod shrK<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
                   analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implAuthSet_aux_2"><span class="command">lemma</span></span> analz_Un_implAuthSet_aux_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span>
     implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> HashSet <span class="main">(</span>PairSet <span class="main">(</span>PairSet Tags <span class="free">G</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>case_prod shrK<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
     synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
       implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> 
       HashSet <span class="main">(</span>PairSet <span class="main">(</span>PairSet Tags <span class="free">G</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>case_prod shrK<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
       analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implAuthSet_aux_1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> 
            HashSet <span class="main">(</span>PairSet <span class="main">(</span>PairSet Tags <span class="free">G</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>case_prod shrK<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
            synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implAuthSet_aux_3"><span class="command">lemma</span></span> analz_Un_implAuthSet_aux_3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
  analz <span class="main">(</span>implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implAuthSet_aux_2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_symmetric-analz_Un_implAuthSet"><span class="command">lemma</span></span> analz_Un_implAuthSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>sym.implAuthSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implAuthSet_aux <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implAuthSet_aux_3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> Enc_keys_clean_msgSet_Un <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Locale interpretations›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">interpretation</span></span> sym<span class="main">:</span> semivalid_implem <span class="quoted">implem_sym</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span> <span class="skolem">x'</span> <span class="skolem">A'</span> <span class="skolem">B'</span> <span class="skolem">M'</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> implem_sym <span class="main">(</span>Chan <span class="skolem">x'</span> <span class="skolem">A'</span> <span class="skolem">B'</span> <span class="skolem">M'</span><span class="main">)</span> <span class="main">⟷</span>
        <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A'</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B'</span> <span class="main">∧</span> <span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M'</span> <span class="skolem">M</span> <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">∈</span> payload"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> parts <span class="main">{</span><span class="skolem">M'</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> payload"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">M'</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> payload"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">{</span>implem_sym <span class="main">(</span>Chan <span class="skolem">x'</span> <span class="skolem">A'</span> <span class="skolem">B'</span> <span class="skolem">M'</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A'</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B'</span> <span class="main">∧</span> <span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> A1 A2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> sym.valid"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">∈</span> parts <span class="skolem">I</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> payload"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">∈</span> parts <span class="main">{</span>implem_sym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parts_singleton <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Enc <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">∈</span> parts <span class="skolem">I</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">⊆</span> sym.valid›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sym.validE<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> range LtK <span class="main">∨</span> <span class="skolem">Y</span> <span class="main">∈</span> payload"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"composed <span class="main">(</span>implem_sym <span class="skolem">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"composed <span class="main">(</span>implem_sym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∉</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">K</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sym.valid"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> payload"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> implem_sym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sym.validE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LtK <span class="skolem">K</span> <span class="main">∉</span> parts <span class="main">{</span><span class="skolem">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⊆</span> payload"</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_sym <span class="main">(</span>Insec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implInsecSet<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⊆</span> payload"</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_sym <span class="main">(</span>Auth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implAuthSet<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">Ag</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⊆</span> payload"</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_sym <span class="main">(</span>Confid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ag</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implConfidSet<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">Ag</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⊆</span> payload"</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_sym <span class="main">(</span>Secure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ag</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implSecureSet<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">Ag</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="skolem">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_sym <span class="main">(</span>Confid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ag</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implConfidSet_2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">Ag</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="skolem">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_sym <span class="main">(</span>Secure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ag</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implSecureSet_2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Third step: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> "valid_implem"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The lemmas giving conditions on $M$, $A$ and $B$ for 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">implXXX</span></span> <span class="free"><span class="free">A</span></span> <span class="free"><span class="free">B</span></span> <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">∈</span></span> synth <span class="main"><span class="main">(</span></span>analz <span class="free"><span class="free">Z</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1" id="Implem_symmetric-implInsec_synth_analz"><span class="command">lemma</span></span> implInsec_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> sym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   sym.implInsec <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   sym.implInsec <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_symmetric-implConfid_synth_analz"><span class="command">lemma</span></span> implConfid_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> sym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   sym.implConfid <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   sym.implConfid <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> sym.analz_valid <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">confid</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_symmetric-implAuth_synth_analz"><span class="command">lemma</span></span> implAuth_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> sym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   sym.implAuth <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   sym.implAuth <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="main">(</span><span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> sym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">M</span><span class="main">,</span> hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">⟩</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">X</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sym.implAuth <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sym.implAuth <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym.analz_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> H' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> sym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∧</span> hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">∨</span> 
             shrK <span class="free">A</span> <span class="free">B</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">X</span><span class="main">,</span> hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="skolem">X</span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"shrK <span class="free">A</span> <span class="free">B</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>sym.analz_LtKeys<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_into_parts<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="free">H</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>payload_parts <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>payload_Hash<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> H <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∈</span> <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H''<span class="main">:</span><span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">{</span><span class="skolem">Z</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> parts_singleton <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹hmac <span class="main">⟨</span>AuthTag<span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>shrK <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="free">H</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∈</span> sym.valid"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> H'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> sym.implAuth <span class="free">A</span> <span class="free">B</span> <span class="free">M</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> sym.valid_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sym.implAuth <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> H' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_symmetric-implSecure_synth_analz"><span class="command">lemma</span></span> implSecure_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> sym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   sym.implSecure <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   sym.implSecure <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="main">(</span><span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="comment1">(* 1 subgoal*)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> sym.analz_valid <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">secure</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> sym.analz_valid <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">secure</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>sym.analz_LtKeys<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">interpretation</span></span> sym<span class="main">:</span> valid_implem <span class="quoted">implem_sym</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> sym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
         <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Insec <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Insec <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">H</span> <span class="main">∨</span> <span class="skolem">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> implInsec_synth_analz<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> sym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
         <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Confid <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Confid <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">H</span> <span class="main">∨</span> <span class="skolem">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> implConfid_synth_analz<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> sym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
         <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Auth <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Auth <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">H</span> <span class="main">∨</span> 
             <span class="skolem">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="skolem">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> implAuth_synth_analz<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> sym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
         <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Secure <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_sym <span class="main">(</span>Secure <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">H</span> <span class="main">∨</span> 
             <span class="skolem">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="skolem">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> implSecure_synth_analz<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Implem_asymmetric">
<div class="head">
<h1>Theory Implem_asymmetric</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  Implem_asymmetric.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Implem_asymmetric.thy 132885 2016-12-23 18:41:32Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Asymmetric channel implementation (local interpretation) using
  public-key encryption and signatures.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Asymmetric Implementation of Channel Messages›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Implem_asymmetric
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Implem.html">Implem</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation of channel messages›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">implem_asym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chan <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">implem_asym</span> <span class="main">(</span>Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>InsecTag<span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟩</span>"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">implem_asym</span> <span class="main">(</span>Confid <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> Aenc <span class="main">⟨</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟩</span> <span class="main">(</span>pubK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">implem_asym</span> <span class="main">(</span>Auth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> Sign <span class="main">⟨</span>Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟩</span> <span class="main">(</span>priK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">implem_asym</span> <span class="main">(</span>Secure <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> Sign <span class="main">(</span>Aenc <span class="main">⟨</span>SecureTag<span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">⟩</span> <span class="main">(</span>pubK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>priK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
First step: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> "basic_implem"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
Trivial as there are no assumption, this locale just defines some useful abbreviations and valid.
›</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> asym<span class="main">:</span> basic_implem <span class="quoted">implem_asym</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Second step: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> "semivalid_implem"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Here we prove some basic properties such as injectivity and some properties about the 
interaction of sets of implementation messages with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>; these properties are 
proved as separate lemmas as the proofs are more complex. 
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary: simpler definitions of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>implSets›</span></span></span></span> for the proofs, using the 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>msgSet›</span></span></span></span> definitions. 
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implInsecSet_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">implInsecSet_aux</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> PairSet Tags <span class="main">(</span>PairSet AgentSet <span class="main">(</span>PairSet AgentSet <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implAuthSet_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">implAuthSet_aux</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> SignSet <span class="main">(</span>PairSet AgentSet <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span>range priK<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implConfidSet_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>agent <span class="main">*</span> agent<span class="main">)</span> set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">implConfidSet_aux</span> <span class="free"><span class="bound"><span class="entity">Ag</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> AencSet <span class="main">(</span>PairSet AgentSet <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span>pubK<span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ag</span></span></span> <span class="main">``</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">implSecureSet_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>agent <span class="main">*</span> agent<span class="main">)</span> set <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">implSecureSet_aux</span> <span class="free"><span class="bound"><span class="entity">Ag</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span>
  SignSet <span class="main">(</span>AencSet <span class="main">(</span>PairSet Tags <span class="main">(</span>PairSet AgentSet <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pubK<span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ag</span></span></span> <span class="main">``</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>range priK<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These auxiliary definitions are overapproximations.›</span></span>

<span class="keyword1" id="Implem_asymmetric-implInsecSet_implInsecSet_aux"><span class="command">lemma</span></span> implInsecSet_implInsecSet_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"asym.implInsecSet <span class="free">G</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Implem_asymmetric-implAuthSet_implAuthSet_aux"><span class="command">lemma</span></span> implAuthSet_implAuthSet_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"asym.implAuthSet <span class="free">G</span> <span class="main">⊆</span> implAuthSet_aux <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Implem_asymmetric-implConfidSet_implConfidSet_aux"><span class="command">lemma</span></span> implConfidSet_implConfidSet_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"asym.implConfidSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">⊆</span> implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Implem_asymmetric-implSecureSet_implSecureSet_aux"><span class="command">lemma</span></span> implSecureSet_implSecureSet_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"asym.implSecureSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">⊆</span> implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> implSet_implSet_aux <span class="main">=</span>
  implInsecSet_implInsecSet_aux implAuthSet_implAuthSet_aux
  implConfidSet_implConfidSet_aux implSecureSet_implSecureSet_aux

<span class="keyword1"><span class="command">declare</span></span> Enc_keys_clean_msgSet_Un <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas to pull implementation sets out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
All these proofs are similar:
\begin{enumerate}
\item prove the lemma for the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">implSet_aux</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and with the set added outside of  
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> given explicitly,
\item prove the lemma for the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">implSet_aux</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> but with payload, and
\item prove the lemma for the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">implSet</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\end{enumerate}
There  are two cases for the confidential and secure messages:
the general case (the payloads stay in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>  <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) and the case where the key is unknown
(the messages cannot be opened and are completely removed from the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).
›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">PairAgentSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>analz›</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_PairAgentSet"><span class="command">lemma</span></span> analz_Un_PairAgentSet<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"analz <span class="main">(</span>PairSet AgentSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> PairSet AgentSet <span class="free">G</span> <span class="main">∪</span> AgentSet <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>PairSet AgentSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> PairSet AgentSet <span class="free">G</span> <span class="main">∪</span> analz <span class="main">(</span>AgentSet <span class="main">∪</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_PairSet<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> PairSet AgentSet <span class="free">G</span> <span class="main">∪</span> AgentSet <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Un_mono analz_Un_AgentSet<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implInsecSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implInsecSet_aux_aux"><span class="command">lemma</span></span> analz_Un_implInsecSet_aux_aux<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
         implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> analz <span class="main">(</span>Tags <span class="main">∪</span> PairSet AgentSet <span class="main">(</span>PairSet AgentSet <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_PairSet<span class="main">)</span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> analz <span class="main">(</span>PairSet AgentSet <span class="main">(</span>PairSet AgentSet <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_Tag<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> PairSet AgentSet <span class="main">(</span>PairSet AgentSet <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> AgentSet 
                     <span class="main">∪</span> analz <span class="main">(</span>PairSet AgentSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz_Un_PairAgentSet<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
     <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> PairSet AgentSet <span class="main">(</span>PairSet AgentSet <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> AgentSet 
            <span class="main">∪</span> PairSet AgentSet <span class="free">G</span> <span class="main">∪</span> AgentSet <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> analz_Un_PairAgentSet<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> Tags <span class="main">∪</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implInsecSet_aux"><span class="command">lemma</span></span> analz_Un_implInsecSet_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implInsecSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implInsecSet_aux_aux<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implInsecSet"><span class="command">lemma</span></span> analz_Un_implInsecSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>asym.implInsecSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implInsecSet_aux <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz_Un_implInsecSet_aux<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implConfidSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implConfidSet_aux_aux"><span class="command">lemma</span></span> analz_Un_implConfidSet_aux_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
  analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
  implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> PairSet AgentSet <span class="free">G</span> <span class="main">∪</span>
  synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_AencSet<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_PairAgentSet<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implConfidSet_aux"><span class="command">lemma</span></span> analz_Un_implConfidSet_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
  analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implConfidSet_aux_aux<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implConfidSet"><span class="command">lemma</span></span> analz_Un_implConfidSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>asym.implConfidSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implConfidSet_aux <span class="free"><span class="free">Ag</span></span> <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implConfidSet_aux <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implConfidSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 2nd case where the agents are honest.›</span></span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implConfidSet_aux_aux_2"><span class="command">lemma</span></span> analz_Un_implConfidSet_aux_aux_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_AencSet2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>analz_into_parts<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implConfidSet_aux_2"><span class="command">lemma</span></span> analz_Un_implConfidSet_aux_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implConfidSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implConfidSet_aux_aux_2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implConfidSet_2"><span class="command">lemma</span></span> analz_Un_implConfidSet_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="free">H</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>asym.implConfidSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implConfidSet_aux <span class="free"><span class="free">Ag</span></span> <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implConfidSet_aux_2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implAuthSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implAuthSet_aux_aux"><span class="command">lemma</span></span> analz_Un_implAuthSet_aux_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_SignSet<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_PairAgentSet<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implAuthSet_aux"><span class="command">lemma</span></span> analz_Un_implAuthSet_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implAuthSet_aux <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implAuthSet_aux_aux<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implAuthSet"><span class="command">lemma</span></span> analz_Un_implAuthSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>asym.implAuthSet <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implAuthSet_aux <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implAuthSet_aux <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implSecureSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implSecureSet_aux_aux"><span class="command">lemma</span></span> analz_Un_implSecureSet_aux_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span>
   implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> AencSet <span class="main">(</span>PairSet Tags <span class="main">(</span>PairSet AgentSet <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pubK<span class="main">`</span> <span class="main">(</span><span class="free">Ag</span><span class="main">``</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
   PairSet Tags <span class="main">(</span>PairSet AgentSet <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> Tags <span class="main">∪</span> PairSet AgentSet <span class="free">G</span> <span class="main">∪</span>
   synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_SignSet<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>Un_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_AencSet<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_PairSet<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_Tag<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_PairAgentSet<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implSecureSet_aux"><span class="command">lemma</span></span> analz_Un_implSecureSet_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
  analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implSecureSet_aux_aux<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implSecureSet"><span class="command">lemma</span></span> analz_Un_implSecureSet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   analz <span class="main">(</span>asym.implSecureSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implSecureSet_aux <span class="free"><span class="free">Ag</span></span> <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implSecureSet_aux <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Pull <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">implSecureSet</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> out of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 2nd case, where the agents are honest. 
›</span></span>
<span class="keyword1" id="Implem_asymmetric-analz_Un_implSecureSet_aux_aux_2"><span class="command">lemma</span></span> analz_Un_implSecureSet_aux_aux_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> 
   implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> AencSet <span class="main">(</span>PairSet Tags <span class="main">(</span>PairSet AgentSet <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pubK<span class="main">`</span> <span class="main">(</span><span class="free">Ag</span><span class="main">``</span> UNIV<span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
   synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_SignSet<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_AencSet2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz_into_parts<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implSecureSet_aux_2"><span class="command">lemma</span></span> analz_Un_implSecureSet_aux_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>implSecureSet_aux <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_Un_implSecureSet_aux_aux_2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Implem_asymmetric-analz_Un_implSecureSet_2"><span class="command">lemma</span></span> analz_Un_implSecureSet_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="free">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   analz <span class="main">(</span>asym.implSecureSet <span class="free">Ag</span> <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span>
   synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>implSecureSet_aux <span class="free"><span class="free">Ag</span></span> <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Un_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSet_implSet_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> analz_Un_implSecureSet_aux_2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> Enc_keys_clean_msgSet_Un <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Locale interpretations›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">interpretation</span></span> asym<span class="main">:</span> semivalid_implem <span class="quoted">implem_asym</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span> <span class="skolem">x'</span> <span class="skolem">A'</span> <span class="skolem">B'</span> <span class="skolem">M'</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> implem_asym <span class="main">(</span>Chan <span class="skolem">x'</span> <span class="skolem">A'</span> <span class="skolem">B'</span> <span class="skolem">M'</span><span class="main">)</span> <span class="main">⟷</span>
        <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A'</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B'</span> <span class="main">∧</span> <span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M'</span> <span class="skolem">M</span> <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">∈</span> payload"</span></span> <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">{</span>implem_asym <span class="main">(</span>Chan <span class="skolem">x'</span> <span class="skolem">A'</span> <span class="skolem">B'</span> <span class="skolem">M'</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A'</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B'</span> <span class="main">∧</span> <span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> asym.valid"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">∈</span> parts <span class="skolem">I</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> payload"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Enc <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">∈</span> parts <span class="main">{</span>implem_asym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parts_singleton <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Enc <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">∈</span> parts <span class="skolem">I</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">I</span> <span class="main">⊆</span> asym.valid›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> asym.validE<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> range LtK <span class="main">∨</span> <span class="skolem">Y</span> <span class="main">∈</span> payload"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"composed <span class="main">(</span>implem_asym <span class="skolem">Z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"composed <span class="main">(</span>implem_asym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∉</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">K</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> asym.valid"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> payload"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> implem_asym <span class="main">(</span>Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> asym.validE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LtK <span class="skolem">K</span> <span class="main">∉</span> parts <span class="main">{</span><span class="skolem">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⊆</span> payload"</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_asym <span class="main">(</span>Insec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implInsecSet<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⊆</span> payload"</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_asym <span class="main">(</span>Auth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implAuthSet<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">Ag</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⊆</span> payload"</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_asym <span class="main">(</span>Confid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ag</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implConfidSet<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">Ag</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⊆</span> payload"</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_asym <span class="main">(</span>Secure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ag</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implSecureSet<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">Ag</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⊆</span> payload"</span></span> <span class="comment1">(*unused*)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="skolem">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_asym <span class="main">(</span>Confid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ag</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
               synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implConfidSet_2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">Ag</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⊆</span> payload"</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="skolem">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Enc_keys_clean <span class="main">(</span><span class="skolem">G</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Enc_keys_clean_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ag</span> <span class="main">∩</span> broken <span class="main">(</span>parts <span class="skolem">H</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">{</span>implem_asym <span class="main">(</span>Secure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">)</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ag</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">⊆</span> 
          synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span> payload"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_Un_implSecureSet_2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Third step: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> "valid_implem"<span class="antiquote"><span class="antiquote">}</span></span></span></span>. The lemmas giving conditions on $M$, $A$ and $B$ for 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> [display] <span class="quoted"><span class="quoted">"<span class="free"><span class="free">implXXX</span></span> <span class="free"><span class="free">A</span></span> <span class="free"><span class="free">B</span></span> <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">∈</span></span> synth <span class="main"><span class="main">(</span></span>analz <span class="free"><span class="free">Z</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1" id="Implem_asymmetric-implInsec_synth_analz"><span class="command">lemma</span></span> implInsec_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> asym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   asym.implInsec <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   asym.implInsec <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_asymmetric-implConfid_synth_analz"><span class="command">lemma</span></span> implConfid_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> asym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   asym.implConfid <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   asym.implConfid <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> asym.analz_valid <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">confid</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_asymmetric-implAuth_synth_analz"><span class="command">lemma</span></span> implAuth_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> asym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   asym.implAuth <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   asym.implAuth <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="main">(</span><span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> asym.analz_valid <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">auth</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> asym.analz_valid <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">auth</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> asym.analz_LtKeys<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Implem_asymmetric-implSecure_synth_analz"><span class="command">lemma</span></span> implSecure_synth_analz<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> asym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags <span class="main">⟹</span>
   asym.implSecure <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span>
   asym.implSecure <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="main">(</span><span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> asym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span><span class="quoted"><span class="quoted">"Sign <span class="main">(</span>Aenc <span class="main">⟨</span>SecureTag<span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>pubK <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>priK <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
            <span class="quoted"><span class="quoted">" <span class="skolem">X</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"asym.implSecure <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"asym.implSecure <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asym.analz_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> H' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> asym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span><span class="quoted"><span class="quoted">"Aenc <span class="main">⟨</span>SecureTag<span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>pubK <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∧</span> priK <span class="free">A</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"priK <span class="free">A</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> HAgents<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> asym.analz_LtKeys<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> H' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="main">⟨</span>SecureTag<span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>pubK <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="main">⟨</span>SecureTag<span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>pubK <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">∨</span> 
             <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sign <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> HAgents <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="main">⟨</span>SecureTag<span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>pubK <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="main">⟨</span>SecureTag<span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>pubK <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analz_into_parts<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> H <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∈</span> <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H''<span class="main">:</span><span class="quoted"><span class="quoted">"Aenc <span class="main">⟨</span>SecureTag<span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>pubK <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">{</span><span class="skolem">Z</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> parts_singleton <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Aenc <span class="main">⟨</span>SecureTag<span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> <span class="free">M</span><span class="main">⟩</span> <span class="main">(</span>pubK <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="free">H</span>›</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∈</span> asym.valid"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> H'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> asym.implSecure <span class="free">A</span> <span class="free">B</span> <span class="free">M</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> asym.valid_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"asym.implSecure <span class="free">A</span> <span class="free">B</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> H' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">interpretation</span></span> asym<span class="main">:</span> valid_implem <span class="quoted">implem_asym</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> asym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
         <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Insec <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Insec <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">H</span> <span class="main">∨</span> <span class="skolem">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> implInsec_synth_analz<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> asym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
         <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Confid <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Confid <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">H</span> <span class="main">∨</span> <span class="skolem">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> implConfid_synth_analz<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> asym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
         <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Auth <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Auth <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">H</span> <span class="main">∨</span> 
             <span class="skolem">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="skolem">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> implAuth_synth_analz<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> payload <span class="main">∪</span> asym.valid <span class="main">∪</span> range LtK <span class="main">∪</span> Tags"</span></span>
         <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Secure <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"implem_asym <span class="main">(</span>Secure <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">H</span> <span class="main">∨</span> 
             <span class="skolem">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="skolem">H</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> broken <span class="skolem">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> implSecure_synth_analz<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="pfslvl1">
<div class="head">
<h1>Theory pfslvl1</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  pfslvl1.thy (Isabelle/HOL 2016-1)
  ID:      $Id: pfslvl1.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-1 protocol using ephemeral asymmetric keys to achieve forward secrecy.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Key Transport Protocol with PFS (L1)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> pfslvl1
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Runs.html">Runs</a> <a href="Secrecy.html">Secrecy</a> <a href="AuthenticationI.html">AuthenticationI</a> <a href="Payloads.html">Payloads</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">declare</span></span> option.split_asm <span class="main">[</span><span class="operator">split</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span> 

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and Events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">consts</span></span>
  sk <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  kE <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>  
  Nend <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proofs break if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is used, because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">method</span></span> "simp"<span class="antiquote"><span class="antiquote">}</span></span></span></span> replaces it with
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\dots›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xpkE</span> <span class="main">≡</span> Var <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xskE</span> <span class="main">≡</span> Var <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xsk</span> <span class="main">≡</span> Var <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xEnd</span> <span class="main">≡</span> Var <span class="numeral">4</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">End</span> <span class="main">≡</span> Number Nend"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹domain of each role (protocol dependent)›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">domain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">domain</span> Init <span class="main">=</span> <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">domain</span> Resp <span class="main">=</span> <span class="main">{</span>xpkE<span class="main">,</span> xsk<span class="main">}</span>"</span></span>



<span class="keyword1"><span class="command">consts</span></span>
  test <span class="main">::</span> <span class="quoted">rid_t</span>
  
<span class="keyword1"><span class="command">consts</span></span>
  guessed_runs <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> run_t"</span></span>
  guessed_frame <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> frame"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹specification of the guessed frame›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\begin{enumerate}
\item Domain
\item Well-typedness.
  The messages in the frame of a run never contain implementation material
  even if the agents of the run are dishonest.
  Therefore we consider only well-typed frames.
  This is notably required for the session key compromise; it also helps proving
  the partitionning of ik,
  since we know that the messages added by the protocol do not contain ltkeys in their
  payload and are therefore valid implementations.
\item We also ensure that the values generated by the frame owner are correctly guessed.
\end{enumerate}›</span></span>
<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">guessed_frame</span><span class="main">)</span> 
  guessed_frame_dom_spec <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"dom <span class="main">(</span>guessed_frame <span class="free">R</span><span class="main">)</span> <span class="main">=</span> domain <span class="main">(</span>role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_payload_spec <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> payload"</span></span>
  guessed_frame_Init_xpkE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init <span class="main">⟹</span> guessed_frame <span class="free">R</span> xpkE <span class="main">=</span> Some <span class="main">(</span>epubKF <span class="main">(</span><span class="free">R</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_Init_xskE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init <span class="main">⟹</span> guessed_frame <span class="free">R</span> xskE <span class="main">=</span> Some <span class="main">(</span>epriKF <span class="main">(</span><span class="free">R</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_Resp_xsk <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Resp <span class="main">⟹</span> guessed_frame <span class="free">R</span> xsk <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> 
    <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">.</span></span>
      <span class="keyword1"><span class="keyword1">if</span></span> role <span class="main"><span class="main">(</span></span>guessed_runs <span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> Init 
      <span class="keyword1"><span class="keyword1">then</span></span> <span class="main"><span class="main">[</span></span>xpkE <span class="main"><span class="main">↦</span></span> epubKF <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">$</span></span>kE<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> xskE <span class="main"><span class="main">↦</span></span> epriKF <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">$</span></span>kE<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> xsk <span class="main"><span class="main">↦</span></span> End<span class="main"><span class="main">]</span></span>
      <span class="keyword1"><span class="keyword1">else</span></span> <span class="main"><span class="main">[</span></span>xpkE <span class="main"><span class="main">↦</span></span> End<span class="main"><span class="main">,</span></span> xsk <span class="main"><span class="main">↦</span></span> NonceF <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">$</span></span>sk<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> role_t.exhaust<span class="main">)</span>  
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_owner</span> <span class="main">≡</span> owner <span class="main">(</span>guessed_runs test<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_partner</span> <span class="main">≡</span> partner <span class="main">(</span>guessed_runs test<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹level 1 state›</span></span>
<span class="keyword1"><span class="command">record</span></span> l1_state <span class="main">=</span> 
  <span class="quoted">s0_state</span> <span class="main">+</span>
  progress <span class="main">::</span> <span class="quoted">progress_t</span>
  signals <span class="main">::</span> <span class="quoted"><span class="quoted">"signal <span class="main">⇒</span> nat"</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> l1_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"l1_state"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">run_ended</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set option <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">run_ended</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> in_progress <span class="free"><span class="bound"><span class="entity">r</span></span></span> xsk"</span></span>

<span class="keyword1" id="pfslvl1-run_ended_not_None"><span class="command">lemma</span></span> run_ended_not_None <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_ended <span class="free">R</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">=</span> None <span class="main">⟹</span> False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_progress_Some<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">test_ended</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> $\longleftrightarrow$ the test run has ended in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">test_ended</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> l1_state_scheme <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_ended</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> run_ended <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">s</span></span></span> test<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹a run can emit signals if it involves the same agents as the test run, and if the test run 
  has not ended yet›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">can_signal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> l1_state_scheme <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">can_signal</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> test_owner <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> test_partner<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> test_owner <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> test_partner<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">¬</span> test_ended <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹events›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_learn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_learn</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guard›</span>
    synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>secret <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>  <span class="main">∧</span>
    <span class="comment1">― ‹action›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">⦇</span>ik <span class="main">:=</span> ik <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹protocol events›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{itemize}
\item step 1: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">pkE</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">skE</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item step 2: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reads <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">pkE</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authentically,
  generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, emits a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">pkE</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)
\item step 3: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reads <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">pkE</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authentically,
  emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">pkE</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">}</span><span class="main">)</span>
      <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">KE</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xpkE <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">KE</span></span></span> <span class="main">∧</span>
    <span class="main">(</span>can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟶</span> <span class="comment1">― ‹authentication guard›</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">Ra</span><span class="main">.</span> guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
             in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> xpkE <span class="main">∧</span> guessed_frame <span class="bound">Ra</span> xpkE <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">KE</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test <span class="main">⟶</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xpkE<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signals <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                          addSignal <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span><span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">KE</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                          signals <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xsk <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span>
    <span class="main">(</span>can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟶</span> <span class="comment1">― ‹authentication guard›</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">Rb</span><span class="main">.</span> guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
             progress <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xpkE<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xpkE <span class="main">=</span> Some <span class="main">(</span>epubKF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xsk <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signals <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                         addSignal <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>epubKF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>kE<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">⟩</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                         signals <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>




<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹specification›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l1_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
    ik <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    secret <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    progress <span class="main">=</span> Map.empty<span class="main">,</span>
    signals <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span>
    <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l1_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">K</span> <span class="bound">KE</span><span class="main">.</span>
     l1_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     l1_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">KE</span> <span class="main">∪</span>
     l1_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">K</span> <span class="main">∪</span>
     l1_learn <span class="bound">m</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l1_state<span class="main">,</span> l1_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> l1_init<span class="main">,</span>
    trans <span class="main">=</span> l1_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_defs <span class="main">=</span> 
  l1_def l1_init_def l1_trans_def
  l1_learn_def
  l1_step1_def l1_step2_def l1_step3_def

<span class="keyword1"><span class="command">lemmas</span></span> l1_nostep_defs <span class="main">=</span>
  l1_def l1_init_def l1_trans_def

<span class="keyword1" id="pfslvl1-l1_obs_id"><span class="command">lemma</span></span> l1_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs l1 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def<span class="main">)</span>


<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>

<span class="keyword1" id="pfslvl1-run_ended_trans"><span class="command">lemma</span></span> run_ended_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_ended <span class="main">(</span>progress <span class="free">s</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l1 <span class="main">⟹</span>
   run_ended <span class="main">(</span>progress <span class="free">s'</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_defs ik_dy_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span> <span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="pfslvl1-can_signal_trans"><span class="command">lemma</span></span> can_signal_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"can_signal <span class="free">s'</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l1 <span class="main">⟹</span>
  can_signal <span class="free">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def run_ended_trans<span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement: secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹mediator function›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med01s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_obs <span class="main">⇒</span> s0_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med01s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> ik <span class="main">=</span> ik <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> secret <span class="main">=</span> secret <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹relation between states›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R01s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>s0_state <span class="main">*</span> l1_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R01s</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">s</span> <span class="main">=</span> <span class="main">⦇</span>ik <span class="main">=</span> ik <span class="bound">s'</span><span class="main">,</span> secret <span class="main">=</span> secret <span class="bound">s'</span><span class="main">⦈</span>
    <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹protocol independent events›</span></span>

<span class="keyword1" id="pfslvl1-l1_learn_refines_learn"><span class="command">lemma</span></span> l1_learn_refines_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> s0_learn <span class="free">m</span><span class="main">,</span> l1_learn <span class="free">m</span> <span class="main">{&gt;</span>R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01s_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_defs s0_defs s0_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹protocol events›</span></span>
<span class="keyword1" id="pfslvl1-l1_step1_refines_skip"><span class="command">lemma</span></span> l1_step1_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> Id<span class="main">,</span> l1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01s_def l1_step1_def<span class="main">)</span>

<span class="keyword1" id="pfslvl1-l1_step2_refines_add_secret_skip"><span class="command">lemma</span></span> l1_step2_refines_add_secret_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> s0_add_secret <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">∪</span> Id<span class="main">,</span> l1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">KE</span> <span class="main">{&gt;</span>R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01s_def s0_add_secret_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl1-l1_step3_refines_add_secret_skip"><span class="command">lemma</span></span> l1_step3_refines_add_secret_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> s0_add_secret <span class="free">K</span> <span class="main">∪</span> Id<span class="main">,</span> l1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">K</span> <span class="main">{&gt;</span>R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01s_def s0_add_secret_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹refinement proof›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_trans_refines_s0_trans <span class="main">=</span> 
  l1_learn_refines_learn
  l1_step1_refines_skip l1_step2_refines_add_secret_skip l1_step3_refines_add_secret_skip 

<span class="keyword1" id="pfslvl1-l1_refines_init_s0"><span class="command">lemma</span></span> l1_refines_init_s0 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> R01s <span class="main">``</span> <span class="main">(</span>init s0<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R01s_def s0_defs l1_defs s0_secrecy_def<span class="main">)</span>


<span class="keyword1" id="pfslvl1-l1_refines_trans_s0"><span class="command">lemma</span></span> l1_refines_trans_s0 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> trans s0<span class="main">,</span> trans l1 <span class="main">{&gt;</span> R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s0_def l1_def s0_trans_def l1_trans_def 
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l1_trans_refines_s0_trans<span class="main">)</span>


<span class="keyword1" id="pfslvl1-obs_consistent_med01x"><span class="command">lemma</span></span> obs_consistent_med01x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R01s med01s s0 l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R01s_def med01s_def<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹refinement result›</span></span>
<span class="keyword1" id="pfslvl1-l1s_refines_s0"><span class="command">lemma</span></span> l1s_refines_s0 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     R01s
     med01s s0 l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>refines_def PO_refines_def<span class="main">)</span>

<span class="keyword1" id="pfslvl1-l1_implements_s0"><span class="command">lemma</span></span>  l1_implements_s0 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med01s s0 l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants: secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l1_secrecy</span> <span class="main">≡</span> s0_secrecy"</span></span>


<span class="keyword1" id="pfslvl1-l1_obs_secrecy"><span class="command">lemma</span></span> l1_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l1 <span class="main">⊆</span> l1_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> s0_obs_secrecy _ l1_implements_s0<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med01s_def s0_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl1-l1_secrecy"><span class="command">lemma</span></span> l1_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_secrecy<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹if a commit signal for a nonce has been emitted,
 then there is a finished initiator run with this nonce.
›</span></span>



<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_inv1</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">K</span><span class="main">.</span>
    signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span>epubKF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>kE<span class="main">)</span><span class="main">,</span> <span class="bound">K</span><span class="main">⟩</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span>
      guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">∧</span>
      progress <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Ra</span> xsk <span class="main">=</span> Some <span class="bound">K</span>
   <span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv1I <span class="main">=</span> l1_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv1D <span class="main">=</span> l1_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>


<span class="keyword1" id="pfslvl1-l1_inv1_init"><span class="command">lemma</span></span> l1_inv1_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> l1_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def l1_init_def l1_inv1_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>

<span class="keyword1" id="pfslvl1-l1_inv1_trans"><span class="command">lemma</span></span> l1_inv1_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l1_inv1<span class="main">}</span> trans l1 <span class="main">{&gt;</span> l1_inv1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l1_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv1I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_defs ik_dy_def l1_inv1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl1-PO_l1_inv1"><span class="command">lemma</span></span> PO_l1_inv1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹if a responder run knows a nonce, then a running signal for this nonce has been emitted›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_inv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_inv2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">KE</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span><span class="main">.</span>
    guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
    progress <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xpkE<span class="main">,</span> xsk<span class="main">}</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xpkE <span class="main">=</span> Some <span class="bound">KE</span> <span class="main">⟶</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
      signals <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span><span class="bound">KE</span><span class="main">,</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>sk<span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_inv2I <span class="main">=</span> l1_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv2D <span class="main">=</span> l1_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>


<span class="keyword1" id="pfslvl1-l1_inv2_init"><span class="command">lemma</span></span> l1_inv2_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> l1_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def l1_init_def l1_inv2_def<span class="main">)</span>

<span class="keyword1" id="pfslvl1-l1_inv2_trans"><span class="command">lemma</span></span> l1_inv2_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l1_inv2<span class="main">}</span> trans l1 <span class="main">{&gt;</span> l1_inv2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> can_signal_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_defs ik_dy_def l1_inv2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl1-PO_l1_inv2"><span class="command">lemma</span></span> PO_l1_inv2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3 (derived)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹if an unfinished initiator run and a finished responder run both know the same nonce,
 then the number of running signals for this nonce is strictly greater than the number of commit
 signals.
 (actually, there are 0 commit and 1 running)
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_inv3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_inv3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Ra</span><span class="main">.</span>
    guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
    progress <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xpkE<span class="main">,</span> xsk<span class="main">}</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xpkE <span class="main">=</span> Some <span class="main">(</span>epubKF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟶</span>
    progress <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">}</span> <span class="main">⟶</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
      signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="main">(</span><span class="main">⟨</span>epubKF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>kE<span class="main">)</span><span class="main">,</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>sk<span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">&lt;</span> signals <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="main">(</span><span class="main">⟨</span>epubKF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>kE<span class="main">)</span><span class="main">,</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>sk<span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_inv3I <span class="main">=</span> l1_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv3D <span class="main">=</span> l1_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="pfslvl1-l1_inv3_derived"><span class="command">lemma</span></span> l1_inv3_derived<span class="main">:</span> <span class="quoted"><span class="quoted">"l1_inv1 <span class="main">∩</span> l1_inv2 <span class="main">⊆</span> l1_inv3"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x A B Rb Ra<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"signals <span class="improper">x</span> <span class="main">(</span>Commit <span class="improper">A</span> <span class="improper">B</span> <span class="main">⟨</span>epubKF <span class="main">(</span><span class="improper">Ra</span> <span class="main">$</span> kE<span class="main">)</span><span class="main">,</span> NonceF <span class="main">(</span><span class="improper">Rb</span> <span class="main">$</span> sk<span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l1_inv1D <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> equalityE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement: injective agreement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹mediator function›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med01ia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_obs <span class="main">⇒</span> a0i_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med01ia</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>a0n_state.signals <span class="main">=</span> signals <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹relation between states›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R01ia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a0i_state <span class="main">*</span> l1_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R01ia</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    a0n_state.signals <span class="bound">s</span> <span class="main">=</span> signals <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹protocol independent events›</span></span>

<span class="keyword1" id="pfslvl1-l1_learn_refines_a0_ia_skip"><span class="command">lemma</span></span> l1_learn_refines_a0_ia_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01ia<span class="main">}</span> Id<span class="main">,</span> l1_learn <span class="free">m</span> <span class="main">{&gt;</span>R01ia<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01ia_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_learn_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹protocol events›</span></span>
<span class="keyword1" id="pfslvl1-l1_step1_refines_a0i_skip"><span class="command">lemma</span></span> l1_step1_refines_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01ia<span class="main">}</span> Id<span class="main">,</span> l1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R01ia<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01ia_def l1_step1_def<span class="main">)</span>


<span class="keyword1" id="pfslvl1-l1_step2_refines_a0i_running_skip"><span class="command">lemma</span></span> l1_step2_refines_a0i_running_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01ia<span class="main">}</span> a0i_running <span class="free">A</span> <span class="free">B</span> <span class="main">⟨</span><span class="free">KE</span><span class="main">,</span> NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>sk<span class="main">)</span><span class="main">⟩</span> <span class="main">∪</span> Id<span class="main">,</span> l1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">KE</span> <span class="main">{&gt;</span>R01ia<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01ia_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step2_def a0i_running_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="pfslvl1-l1_step3_refines_a0i_commit_skip"><span class="command">lemma</span></span> l1_step3_refines_a0i_commit_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01ia <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> l1_inv3<span class="main">)</span><span class="main">}</span> a0i_commit <span class="free">A</span> <span class="free">B</span> <span class="main">⟨</span>epubKF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>kE<span class="main">)</span><span class="main">,</span> <span class="free">K</span><span class="main">⟩</span> <span class="main">∪</span> Id<span class="main">,</span> l1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">K</span> <span class="main">{&gt;</span>R01ia<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01ia_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step3_def a0i_commit_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv3E<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹refinement proof›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_trans_refines_a0i_trans <span class="main">=</span> 
  l1_learn_refines_a0_ia_skip
  l1_step1_refines_a0i_skip l1_step2_refines_a0i_running_skip l1_step3_refines_a0i_commit_skip 

<span class="keyword1" id="pfslvl1-l1_refines_init_a0i"><span class="command">lemma</span></span> l1_refines_init_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> R01ia <span class="main">``</span> <span class="main">(</span>init a0i<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R01ia_def a0i_defs l1_defs<span class="main">)</span>


<span class="keyword1" id="pfslvl1-l1_refines_trans_a0i"><span class="command">lemma</span></span> l1_refines_trans_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01ia <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l1_inv1 <span class="main">∩</span> l1_inv2<span class="main">)</span><span class="main">)</span><span class="main">}</span> trans a0i<span class="main">,</span> trans l1 <span class="main">{&gt;</span> R01ia<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pre'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"R01ia <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> l1_inv3<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span><span class="var">?post</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conseq_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pre</span> <span class="main">⊆</span> <span class="var">?pre'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l1_inv3_derived <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre'</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span> <span class="var">?post</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0i_def l1_def a0i_trans_def l1_trans_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> l1_step2_refines_a0i_running_skip <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> l1_step3_refines_a0i_commit_skip <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l1_trans_refines_a0i_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="pfslvl1-obs_consistent_med01ia"><span class="command">lemma</span></span> obs_consistent_med01ia <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R01ia med01ia a0i l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R01ia_def med01ia_def<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹refinement result›</span></span>
<span class="keyword1" id="pfslvl1-l1_refines_a0i"><span class="command">lemma</span></span> l1_refines_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R01ia <span class="main">∩</span> <span class="main">(</span>reach a0i <span class="main">×</span> <span class="main">(</span>l1_inv1 <span class="main">∩</span> l1_inv2<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med01ia a0i l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="pfslvl1-l1_implements_a0i"><span class="command">lemma</span></span>  l1_implements_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med01ia a0i l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants: injective agreement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l1_iagreement</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_iagreement</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span><span class="main">.</span> signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span><span class="main">)</span> <span class="main">≤</span> signals <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_iagreementI <span class="main">=</span> l1_iagreement_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_iagreementE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_iagreement_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1" id="pfslvl1-l1_obs_iagreement"><span class="command">lemma</span></span> l1_obs_iagreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l1 <span class="main">⊆</span> l1_iagreement"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_a0i_obs_agreement _ l1_implements_a0i<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med01ia_def l1_iagreement_def a0i_agreement_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl1-l1_iagreement"><span class="command">lemma</span></span> l1_iagreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_iagreement"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_iagreement<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="pfslvl2">
<div class="head">
<h1>Theory pfslvl2</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  pfslvl2.thy (Isabelle/HOL 2016-1)
  ID:      $Id: pfslvl2.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-2 protocol using ephemeral asymmetric keys to achieve forward secrecy.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Key Transport Protocol with PFS (L2)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> pfslvl2
<span class="keyword2"><span class="keyword">imports</span></span> <a href="pfslvl1.html">pfslvl1</a> <a href="Channels.html">Channels</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and Events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹initial compromise›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  bad_init <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span> 

<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">bad_init</span><span class="main">)</span>
  bad_init_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"test_owner <span class="main">∉</span> bad_init <span class="main">∧</span> test_partner <span class="main">∉</span> bad_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹level 2 state›</span></span>
<span class="keyword1"><span class="command">record</span></span> l2_state <span class="main">=</span> 
  <span class="quoted">l1_state</span> <span class="main">+</span>
  chan <span class="main">::</span> <span class="quoted"><span class="quoted">"chan set"</span></span>
  bad <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> l2_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"l2_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l2_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l2_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l2_state <span class="main">×</span> l2_state<span class="main">)</span> set"</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹attacker events›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_dy_fake_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_dy_fake_msg</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∈</span> dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_dy_fake_chan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chan <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_dy_fake_chan</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> dy_fake_chan <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>chan <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">}</span> <span class="main">∪</span> chan <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹partnering›</span></span>
<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">role_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> role_t"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">role_comp</span> Init <span class="main">=</span> Resp"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">role_comp</span> Resp <span class="main">=</span> Init"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">matching</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"frame <span class="main">⇒</span> frame <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">matching</span> <span class="free"><span class="bound"><span class="entity">sigma</span></span></span> <span class="free"><span class="bound"><span class="entity">sigma'</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">sigma</span></span></span> <span class="main">∩</span> dom <span class="free"><span class="bound"><span class="entity">sigma'</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">sigma</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sigma'</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partner_runs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> rid_t <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partner_runs</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">R'</span></span></span> <span class="main">≡</span> 
    role <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">=</span> role_comp <span class="main">(</span>role <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    owner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">=</span> partner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span> <span class="main">∧</span>
    owner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span> <span class="main">=</span> partner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">∧</span>
    matching <span class="main">(</span>guessed_frame <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span>guessed_frame <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span>
  "</span></span>

<span class="keyword1" id="pfslvl2-role_comp_inv"><span class="command">lemma</span></span> role_comp_inv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"role_comp <span class="main">(</span>role_comp <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="pfslvl2-role_comp_inv_eq"><span class="command">lemma</span></span> role_comp_inv_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> role_comp <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> role_comp <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> role_comp.elims <span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partners</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partners</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">R</span><span class="main">.</span> partner_runs test <span class="bound">R</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="pfslvl2-test_not_partner"><span class="command">lemma</span></span> test_not_partner <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"test <span class="main">∉</span> partners"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partners_def partner_runs_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs test<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="pfslvl2-matching_symmetric"><span class="command">lemma</span></span> matching_symmetric<span class="main">:</span>
  <span class="quoted"><span class="quoted">"matching <span class="free">sigma</span> <span class="free">sigma'</span> <span class="main">⟹</span> matching <span class="free">sigma'</span> <span class="free">sigma</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>

<span class="keyword1" id="pfslvl2-partner_symmetric"><span class="command">lemma</span></span> partner_symmetric<span class="main">:</span>
  <span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R'</span> <span class="main">⟹</span> partner_runs <span class="free">R'</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def matching_symmetric<span class="main">)</span>

<span class="keyword1" id="pfslvl2-partner_unique"><span class="command">lemma</span></span> partner_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R''</span> <span class="main">⟹</span> partner_runs <span class="free">R</span> <span class="free">R'</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="main">=</span> <span class="free">R''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span><span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Hm'<span class="main">:</span> <span class="quoted"><span class="quoted">"matching <span class="main">(</span>guessed_frame <span class="free">R</span><span class="main">)</span> <span class="main">(</span>guessed_frame <span class="free">R'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> H''<span class="main">:</span><span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R''</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Hm''<span class="main">:</span> <span class="quoted"><span class="quoted">"matching <span class="main">(</span>guessed_frame <span class="free">R</span><span class="main">)</span> <span class="main">(</span>guessed_frame <span class="free">R''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R'</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Init
      <span class="keyword1"><span class="command">with</span></span> H' partner_symmetric <span class="main">[</span><span class="operator">OF</span> H''<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> Hrole<span class="main">:</span><span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Resp"</span></span>
                                                    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R''</span><span class="main">)</span> <span class="main">=</span> Init"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Init Hm' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xpkE <span class="main">=</span> Some <span class="main">(</span>epubKF <span class="main">(</span><span class="free">R'</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Hrole Hm'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xpkE <span class="main">=</span> Some <span class="main">(</span>epubKF <span class="main">(</span><span class="free">R''</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Resp
      <span class="keyword1"><span class="command">with</span></span> H' partner_symmetric <span class="main">[</span><span class="operator">OF</span> H''<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> Hrole<span class="main">:</span><span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init"</span></span>
                                                    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R''</span><span class="main">)</span> <span class="main">=</span> Resp"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Resp Hm' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xsk <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R'</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Hrole Hm'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xsk <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R''</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="pfslvl2-partner_test"><span class="command">lemma</span></span> partner_test<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> partners <span class="main">⟹</span> partner_runs <span class="free">R</span> <span class="free">R'</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="main">=</span> test"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>partner_unique <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>partners_def partner_symmetric<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹compromising events›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_lkr_others</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_lkr_others</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_lkr_actor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_lkr_actor</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_lkr_after</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_lkr_after</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    test_ended <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_skr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_skr</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≠</span> test <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∉</span> partners <span class="main">∧</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> xsk <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">R</span></span></span> xsk <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹protocol events›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
    <span class="entity">l2_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">}</span><span class="main">)</span><span class="main">,</span>
      chan <span class="main">:=</span> <span class="main">{</span>Auth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span><span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> epubKF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>kE<span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
      <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">KE</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xpkE <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">KE</span></span></span> <span class="main">∧</span>
    Auth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">KE</span></span></span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xpkE<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
      chan <span class="main">:=</span> <span class="main">{</span>Auth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Aenc <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">KE</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
      signals <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                   addSignal <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">KE</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
                 <span class="keyword1">else</span>
                   signals <span class="bound">s</span><span class="main">,</span>
      secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span>
         <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>  


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xsk <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span>
    Auth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Aenc <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>epubKF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            signals <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                         addSignal <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>epubKF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>kE<span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">⟩</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                         signals <span class="bound">s</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹specification›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
    ik <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    secret <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    progress <span class="main">=</span> Map.empty<span class="main">,</span>
    signals <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    chan <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    bad <span class="main">=</span> bad_init
    <span class="main">⦈</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span> <span class="bound">M</span> <span class="bound">KE</span> <span class="bound">Rb</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">K</span><span class="main">.</span>
     l2_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     l2_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">KE</span> <span class="main">∪</span>
     l2_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">m</span> <span class="main">∪</span>
     l2_dy_fake_chan <span class="bound">M</span> <span class="main">∪</span>
     l2_dy_fake_msg <span class="bound">m</span> <span class="main">∪</span>
     l2_lkr_others <span class="bound">A</span> <span class="main">∪</span>
     l2_lkr_after <span class="bound">A</span> <span class="main">∪</span>
     l2_skr <span class="bound">Ra</span> <span class="bound">K</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l2_state<span class="main">,</span> l2_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> l2_init<span class="main">,</span>
    trans <span class="main">=</span> l2_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_loc_defs <span class="main">=</span> 
  l2_step1_def l2_step2_def l2_step3_def
  l2_def l2_init_def l2_trans_def
  l2_dy_fake_chan_def l2_dy_fake_msg_def
  l2_lkr_after_def l2_lkr_others_def l2_skr_def

<span class="keyword1"><span class="command">lemmas</span></span> l2_defs <span class="main">=</span> l2_loc_defs ik_dy_def

<span class="keyword1"><span class="command">lemmas</span></span> l2_nostep_defs <span class="main">=</span> l2_def l2_init_def l2_trans_def


<span class="keyword1" id="pfslvl2-l2_obs_id"><span class="command">lemma</span></span> l2_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs l2 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once a run is finished, it stays finished, therefore if the test is not finished at some
point then it was not finished before either›</span></span>
<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
<span class="keyword1" id="pfslvl2-l2_run_ended_trans"><span class="command">lemma</span></span> l2_run_ended_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_ended <span class="main">(</span>progress <span class="free">s</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2 <span class="main">⟹</span>
   run_ended <span class="main">(</span>progress <span class="free">s'</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span> <span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="pfslvl2-l2_can_signal_trans"><span class="command">lemma</span></span> l2_can_signal_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"can_signal <span class="free">s'</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2 <span class="main">⟹</span>
  can_signal <span class="free">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def l2_run_ended_trans<span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">A</span></span> <span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (i.e., <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are the test session 
agents and the test is not finished), then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are honest.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv1</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
    <span class="bound">A</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv1I <span class="main">=</span> l2_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv1D <span class="main">=</span> l2_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="pfslvl2-l2_inv1_init"><span class="command">lemma</span></span> l2_inv1_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv1_def can_signal_def bad_init_spec<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv1_trans"><span class="command">lemma</span></span> l2_inv1_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv1<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv1I  <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">l2_state</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
  <span class="keyword3"><span class="command">assume</span></span> HI<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span>  
  <span class="keyword3"><span class="command">assume</span></span> HT<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s'</span> <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> HT <span class="keyword1"><span class="command">have</span></span> HS<span class="main">:</span><span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_can_signal_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> HI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> bad <span class="skolem">s</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">∉</span> bad <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> HS HT <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> bad <span class="skolem">s'</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">∉</span> bad <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs can_signal_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="pfslvl2-PO_l2_inv1"><span class="command">lemma</span></span> PO_l2_inv1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2 (authentication guard)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Auth <span class="free"><span class="free">A</span></span> <span class="free"><span class="free">B</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨</span></span>Number <span class="main"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">KE</span></span><span class="main"><span class="main">⟩</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> chan <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are honest
  then the message has indeed been sent by an initiator run (with the right agents etc.)›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">KE</span><span class="main">.</span>
    Auth <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="bound">KE</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span>
    <span class="bound">A</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">Ra</span><span class="main">.</span>
      guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">∧</span>
      in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> xpkE <span class="main">∧</span>
      <span class="bound">KE</span> <span class="main">=</span> epubKF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv2I <span class="main">=</span> l2_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv2D <span class="main">=</span> l2_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="pfslvl2-l2_inv2_init"><span class="command">lemma</span></span> l2_inv2_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv2_def<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv2_trans"><span class="command">lemma</span></span> l2_inv2_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv2<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl2-PO_l2_inv2"><span class="command">lemma</span></span> PO_l2_inv2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3 (authentication guard)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Auth <span class="free"><span class="free">B</span></span> <span class="free"><span class="free">A</span></span> <span class="main"><span class="main">(</span></span>Aenc <span class="free"><span class="free">K</span></span> <span class="main"><span class="main">(</span></span>epubKF <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Ra</span></span> <span class="main"><span class="main">$</span></span> kE<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> chan <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
 and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are honest then the message has indeed been sent by a
 responder run (etc).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">K</span><span class="main">.</span>
     Auth <span class="bound">B</span> <span class="bound">A</span> <span class="main">(</span>Aenc <span class="bound">K</span> <span class="main">(</span>epubKF <span class="main">(</span><span class="bound">Ra</span> <span class="main">$</span> kE<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">⟶</span>
     <span class="main">(</span><span class="main">∃</span> <span class="bound">Rb</span><span class="main">.</span>
       guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">∧</span>
       progress <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xpkE<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
       guessed_frame <span class="bound">Rb</span> xpkE <span class="main">=</span> Some <span class="main">(</span>epubKF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span><span class="main">∧</span>
       <span class="bound">K</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>sk<span class="main">)</span>
     <span class="main">)</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3I <span class="main">=</span> l2_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3D <span class="main">=</span> l2_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="pfslvl2-l2_inv3_init"><span class="command">lemma</span></span> l2_inv3_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv3_def<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv3_trans"><span class="command">lemma</span></span> l2_inv3_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl2-PO_l2_inv3"><span class="command">lemma</span></span> PO_l2_inv3 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the test run is finished and has the session key generated by a run,
  then this run is also finished.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv4</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rb</span><span class="main">.</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> test<span class="main">)</span> xsk <span class="main">⟶</span>
    guessed_frame test xsk <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    progress <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xpkE<span class="main">,</span> xsk<span class="main">}</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4I <span class="main">=</span> l2_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4D <span class="main">=</span> l2_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="pfslvl2-l2_inv4_init"><span class="command">lemma</span></span> l2_inv4_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv4_def<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv4_trans"><span class="command">lemma</span></span> l2_inv4_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv4 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv1<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv4D <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff can_signal_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l2_inv1D <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl2-PO_l2_inv4"><span class="command">lemma</span></span> PO_l2_inv4 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l2_inv3 <span class="main">∩</span> l2_inv1"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The only confidential or secure messages on the channel have been put there
  by the attacker.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv5</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span>
    <span class="main">(</span>Confid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∨</span> Secure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="bound">M</span> <span class="main">∈</span> dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv5I <span class="main">=</span> l2_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv5E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv5D <span class="main">=</span> l2_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="pfslvl2-l2_inv5_init"><span class="command">lemma</span></span> l2_inv5_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv5_def<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv5_trans"><span class="command">lemma</span></span> l2_inv5_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv5<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv5I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l2_inv5D dy_fake_msg_monotone<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl2-PO_l2_inv5"><span class="command">lemma</span></span> PO_l2_inv5 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If an initiator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> knows a session key <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then the attacker
  knows <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="free"><span class="free">K</span></span> <span class="main"><span class="main">(</span></span>epubKF <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Ra</span></span><span class="main"><span class="main">$</span></span>kE<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv6</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Ra</span> <span class="bound">K</span><span class="main">.</span>
    role <span class="main">(</span>guessed_runs <span class="bound">Ra</span><span class="main">)</span> <span class="main">=</span> Init <span class="main">⟶</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> xsk <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xsk <span class="main">=</span> Some <span class="bound">K</span> <span class="main">⟶</span>
    Aenc <span class="bound">K</span> <span class="main">(</span>epubKF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> extr <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6I <span class="main">=</span> l2_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6D <span class="main">=</span> l2_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="pfslvl2-l2_inv6_init"><span class="command">lemma</span></span> l2_inv6_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv6"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv6_def<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv6_trans"><span class="command">lemma</span></span> l2_inv6_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv6<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv6<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv6I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv6D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl2-PO_l2_inv6"><span class="command">lemma</span></span> PO_l2_inv6 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv6"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Form of the messages in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"extr <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> =
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span><span class="free"><span class="free">generators</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generators</span> <span class="main">≡</span> range epubK <span class="main">∪</span>
         <span class="main">{</span>Aenc <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span> <span class="main">$</span> sk<span class="main">)</span><span class="main">)</span> <span class="main">(</span>epubKF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">Ra</span> <span class="bound">Rb</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>
            guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">∧</span>
            guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">∧</span>
            guessed_frame <span class="bound">Rb</span> xpkE <span class="main">=</span> Some <span class="main">(</span>epubKF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
         <span class="main">{</span>NonceF <span class="main">(</span><span class="bound">R</span> <span class="main">$</span> sk<span class="main">)</span> <span class="main">|</span><span class="bound">R</span><span class="main">.</span> <span class="bound">R</span> <span class="main">≠</span> test <span class="main">∧</span> <span class="bound">R</span> <span class="main">∉</span> partners<span class="main">}</span>"</span></span>

<span class="keyword1" id="pfslvl2-analz_generators"><span class="command">lemma</span></span> analz_generators<span class="main">:</span> <span class="quoted"><span class="quoted">"analz generators <span class="main">=</span> generators"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv7</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> 
    extr <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> 
      synth <span class="main">(</span>analz <span class="main">(</span>generators<span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7I <span class="main">=</span> l2_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7D <span class="main">=</span> l2_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="pfslvl2-l2_inv7_init"><span class="command">lemma</span></span> l2_inv7_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv7"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv7_def<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv7_step1"><span class="command">lemma</span></span> l2_inv7_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7<span class="main">}</span> l2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv7D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl2-l2_inv7_step2"><span class="command">lemma</span></span> l2_inv7_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv7<span class="main">}</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">KE</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">l2_state</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> Hx<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> extr <span class="main">(</span>bad <span class="skolem">s'</span><span class="main">)</span> <span class="main">(</span>ik <span class="skolem">s'</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hi'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hi''<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv2"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hi'''<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv4"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">KE</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Hx Hi Hs <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">x</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>generators<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv7D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹first case: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="skolem"><span class="skolem">s</span></span> <span class="free"><span class="free">A</span></span> <span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which implies that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are
      honest, and therefore the public key received by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not from the attacker,
      which proves that the
      message added to the channel is in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">z</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">k</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">z</span></span> <span class="main"><span class="main">=</span></span> Aenc <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">(</span></span>epubKF <span class="bound"><span class="bound">k</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
      <span class="keyword3"><span class="command">assume</span></span> Hc<span class="main">:</span><span class="quoted"><span class="quoted">"Auth <span class="free">A</span> <span class="free">B</span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="free">KE</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> HRb<span class="main">:</span><span class="quoted"><span class="quoted">"guessed_runs <span class="free">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Resp<span class="main">,</span> owner <span class="main">=</span> <span class="free">B</span><span class="main">,</span> partner <span class="main">=</span> <span class="free">A</span><span class="main">⦈</span>"</span></span>
                 <span class="quoted"><span class="quoted">"guessed_frame <span class="free">Rb</span> xpkE <span class="main">=</span> Some <span class="free">KE</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> Hcs<span class="main">:</span> <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Hcs Hi' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad <span class="skolem">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">∉</span> bad <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> Hc Hi'' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ra</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">KE</span> <span class="main">=</span> epubKF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>kE<span class="main">)</span>"</span></span> 
                             <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free">A</span><span class="main">,</span> partner<span class="main">=</span><span class="free">B</span><span class="main">⦈</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv2D<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> HRb <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span> <span class="main">$</span> sk<span class="main">)</span><span class="main">)</span> <span class="free">KE</span> <span class="main">∈</span> synth <span class="main">(</span>analz generators<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹second case: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">¬</span></span> can_signal <span class="skolem"><span class="skolem">s</span></span> <span class="free"><span class="free">A</span></span> <span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not test and
        not a partner:
      - <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not test because in that case test is not finished and
        <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are the test agents, thus
        <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="skolem"><span class="skolem">s</span></span> <span class="free"><span class="free">A</span></span> <span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
      - <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not a partner for the same reason
      therefore the message added to the channel can be constructed from
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span>NonceF <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">R</span></span> <span class="main"><span class="main">$</span></span> sk<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">|</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">R</span></span> <span class="main"><span class="main">≠</span></span> test <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">R</span></span> <span class="main"><span class="main">∉</span></span> partners<span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
      <span class="keyword3"><span class="command">assume</span></span> Hc<span class="main">:</span><span class="quoted"><span class="quoted">"Auth <span class="free">A</span> <span class="free">B</span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="free">KE</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> Hcs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> can_signal <span class="skolem">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> HRb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Rb</span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="skolem">s</span><span class="main">)</span>"</span></span>
                  <span class="quoted"><span class="quoted">"guessed_runs <span class="free">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Resp<span class="main">,</span> owner <span class="main">=</span> <span class="free">B</span><span class="main">,</span> partner <span class="main">=</span> <span class="free">A</span><span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Hcs HRb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rb</span> <span class="main">≠</span> test"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def domIff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> HRb Hi''' Hcs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rb</span> <span class="main">∉</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partners_def partner_runs_def can_signal_def matching_def domIff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Hc Hi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">KE</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>generators<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span> <span class="main">$</span> sk<span class="main">)</span><span class="main">)</span> <span class="free">KE</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>generators<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>    
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="pfslvl2-l2_inv7_step3"><span class="command">lemma</span></span> l2_inv7_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7<span class="main">}</span> l2_step3 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">K</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv7D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv7_dy_fake_msg"><span class="command">lemma</span></span> l2_inv7_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7<span class="main">}</span> l2_dy_fake_msg <span class="free">M</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs extr_insert_IK_eq 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7E dy_fake_msg_extr <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv7_dy_fake_chan"><span class="command">lemma</span></span> l2_inv7_dy_fake_chan<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7<span class="main">}</span> l2_dy_fake_chan <span class="free">M</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I 
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  dy_fake_chan_extr_insert <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7E dy_fake_msg_extr <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv7_lkr_others"><span class="command">lemma</span></span> l2_inv7_lkr_others<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv5<span class="main">}</span> l2_lkr_others <span class="free">A</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> extr_insert_bad <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7E l2_inv5E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dy_fake_msg_extr <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl2-l2_inv7_lkr_after"><span class="command">lemma</span></span> l2_inv7_lkr_after<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv5<span class="main">}</span> l2_lkr_after <span class="free">A</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> extr_insert_bad <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7E l2_inv5E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dy_fake_msg_extr <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 
<span class="keyword1" id="pfslvl2-l2_inv7_skr"><span class="command">lemma</span></span> l2_inv7_skr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv6<span class="main">}</span> l2_skr <span class="free">R</span> <span class="free">K</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs extr_insert_IK_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> l2_inv7D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> HRtest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≠</span> test"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∉</span> partners"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hi'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv6"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> HRsk<span class="main">:</span> <span class="quoted"><span class="quoted">"in_progress <span class="main">(</span>progress <span class="skolem">s</span> <span class="free">R</span><span class="main">)</span> xsk"</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xsk <span class="main">=</span> Some <span class="free">K</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> synth <span class="main">(</span>analz generators<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹first case: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the initiator, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="free"><span class="free">K</span></span> <span class="free"><span class="free">epk</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
        is in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"extr <span class="main"><span class="main">(</span></span>bad <span class="skolem"><span class="skolem">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="skolem"><span class="skolem">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="skolem"><span class="skolem">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (by invariant)
        therefore either <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span> <span class="main"><span class="main">∈</span></span> synth <span class="main"><span class="main">(</span></span>analz generators<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which proves the goal
        or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="free"><span class="free">K</span></span> <span class="free"><span class="free">epk</span></span> <span class="main"><span class="main">∈</span></span> generators"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which means that
        <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span> <span class="main"><span class="main">=</span></span> NonceF <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Rb</span></span><span class="main"><span class="main">$</span></span>sk<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are matching
        and since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not partner or test, neither is
        <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and therefore <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span> <span class="main"><span class="main">∈</span></span> synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>generators<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
      <span class="keyword3"><span class="command">assume</span></span> HRI<span class="main">:</span> <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init"</span></span>
      <span class="keyword1"><span class="command">with</span></span> HRsk Hi Hi' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Aenc <span class="free">K</span> <span class="main">(</span>epubKF <span class="main">(</span><span class="free">R</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> synth <span class="main">(</span>analz generators<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7D<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> synth <span class="main">(</span>analz generators<span class="main">)</span> <span class="main">∨</span> Aenc <span class="free">K</span> <span class="main">(</span>epubKF <span class="main">(</span><span class="free">R</span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> generators"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_generators<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> HRsk <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span>
          <span class="keyword3"><span class="command">assume</span></span> HR<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_runs <span class="free">R</span> <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Init<span class="main">,</span> owner <span class="main">=</span> <span class="skolem">A</span><span class="main">,</span> partner <span class="main">=</span> <span class="skolem">B</span><span class="main">⦈</span>"</span></span>
                     <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xsk <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> sk<span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> HRb<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Resp<span class="main">,</span> owner <span class="main">=</span> <span class="skolem">B</span><span class="main">,</span> partner <span class="main">=</span> <span class="skolem">A</span><span class="main">⦈</span>"</span></span>
                      <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Rb</span> xpkE <span class="main">=</span> Some <span class="main">(</span>epubKF <span class="main">(</span><span class="free">R</span> <span class="main">$</span> kE<span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> HR HRb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partner_runs <span class="skolem">Rb</span> <span class="free">R</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def matching_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> HRtest <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Rb</span> <span class="main">≠</span> test <span class="main">∧</span> <span class="skolem">Rb</span> <span class="main">∉</span> partners"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> partner_test<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>partners_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> sk<span class="main">)</span> <span class="main">∈</span> analz generators"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹second case: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the Responder, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">K</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span><span class="main"><span class="main">$</span></span>sk"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
        which is in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>generators<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
        since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not test or partner›</span></span>
      <span class="keyword3"><span class="command">assume</span></span> HRI<span class="main">:</span> <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Resp"</span></span>
      <span class="keyword1"><span class="command">with</span></span> HRsk HRtest <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7_trans_aux <span class="main">=</span>
  l2_inv7_step1 l2_inv7_step2 l2_inv7_step3
  l2_inv7_dy_fake_msg l2_inv7_dy_fake_chan
  l2_inv7_lkr_others l2_inv7_lkr_after l2_inv7_skr

<span class="keyword1" id="pfslvl2-l2_inv7_trans"><span class="command">lemma</span></span> l2_inv7_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv5 <span class="main">∩</span> l2_inv6<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>l2_inv7_trans_aux<span class="main">)</span>

<span class="keyword1" id="pfslvl2-PO_l2_inv7"><span class="command">lemma</span></span> PO_l2_inv7 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv7"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv5 <span class="main">∩</span> l2_inv6"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv7_aux"><span class="command">lemma</span></span> l2_inv7_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> l2_inv7 <span class="main">⟹</span> <span class="free">R</span> <span class="main">≠</span> test <span class="main">∧</span> <span class="free">R</span> <span class="main">∉</span> partners"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv7"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H'<span class="main">:</span><span class="quoted"><span class="quoted">"NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> H''<span class="main">:</span><span class="quoted"><span class="quoted">"NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> analz_monotone<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> analz <span class="main">(</span>synth <span class="main">(</span>analz generators<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz_mono <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l2_inv7D<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> H'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∈</span> analz generators"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∈</span> generators"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_generators<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv8›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Form of the secrets = nonces generated by test or partners›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv8</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv8</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    secret <span class="bound">s</span> <span class="main">⊆</span> <span class="main">{</span>NonceF <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">|</span> <span class="bound">R</span><span class="main">.</span> <span class="bound">R</span> <span class="main">=</span> test <span class="main">∨</span> <span class="bound">R</span> <span class="main">∈</span> partners<span class="main">}</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv8I <span class="main">=</span> l2_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv8E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv8D <span class="main">=</span> l2_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="pfslvl2-l2_inv8_init"><span class="command">lemma</span></span> l2_inv8_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv8"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv8_def<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_inv8_trans"><span class="command">lemma</span></span> l2_inv8_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv8 <span class="main">∩</span> l2_inv1 <span class="main">∩</span> l2_inv3<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv8<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv8I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partners_def partner_runs_def matching_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl2-PO_l2_inv8"><span class="command">lemma</span></span> PO_l2_inv8 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv8"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l2_inv1 <span class="main">∩</span> l2_inv3"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹mediator function›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med12s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_obs <span class="main">⇒</span> l1_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med12s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    ik <span class="main">=</span> ik <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    secret <span class="main">=</span> secret <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    progress <span class="main">=</span> progress <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signals <span class="main">=</span> signals <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹relation between states›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R12s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l1_state <span class="main">*</span> l2_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R12s</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">s</span> <span class="main">=</span> med12s <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R12s_defs <span class="main">=</span> R12s_def med12s_def


<span class="keyword1" id="pfslvl2-can_signal_R12"><span class="command">lemma</span></span> can_signal_R12 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span> <span class="main">∈</span> R12s <span class="main">⟹</span>
   can_signal <span class="free">s1</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> can_signal <span class="free">s2</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def R12s_defs<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹protocol events›</span></span>

<span class="keyword1" id="pfslvl2-l2_step1_refines_step1"><span class="command">lemma</span></span> l2_step1_refines_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> l1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">,</span> l2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l1_step1_def l2_step1_def<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_step2_refines_step2"><span class="command">lemma</span></span> l2_step2_refines_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv7<span class="main">)</span><span class="main">}</span> 
     l1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">KE</span><span class="main">,</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">KE</span> 
   <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l1_step2_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_step2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7_aux l2_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹auxiliary lemma needed to prove that the nonce received by the test in step 3
comes from a partner›</span></span>
<span class="keyword1" id="pfslvl2-l2_step3_partners"><span class="command">lemma</span></span> l2_step3_partners<span class="main">:</span>
  <span class="quoted"><span class="quoted">"guessed_runs test <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Init<span class="main">,</span> owner <span class="main">=</span> <span class="free">A</span><span class="main">,</span> partner <span class="main">=</span> <span class="free">B</span><span class="main">⦈</span> <span class="main">⟹</span>
   guessed_frame test xsk <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   guessed_runs <span class="free">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Resp<span class="main">,</span> owner <span class="main">=</span> <span class="free">B</span><span class="main">,</span> partner <span class="main">=</span> <span class="free">A</span><span class="main">⦈</span> <span class="main">⟹</span>
   guessed_frame <span class="free">Rb</span> xpkE <span class="main">=</span> Some <span class="main">(</span>epubKF <span class="main">(</span>test <span class="main">$</span> kE<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">Rb</span> <span class="main">∈</span> partners"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partners_def partner_runs_def matching_def<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_step3_refines_step3"><span class="command">lemma</span></span> l2_step3_refines_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv7<span class="main">)</span><span class="main">}</span> 
      l1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">K</span><span class="main">,</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">K</span> 
   <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l1_step3_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_step3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D l2_inv7_aux <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>l2_step3_partners<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹attacker events›</span></span>
<span class="keyword1" id="pfslvl2-l2_dy_fake_chan_refines_skip"><span class="command">lemma</span></span> l2_dy_fake_chan_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> Id<span class="main">,</span> l2_dy_fake_chan <span class="free">M</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_defs<span class="main">)</span>


<span class="keyword1" id="pfslvl2-l2_dy_fake_msg_refines_learn"><span class="command">lemma</span></span> l2_dy_fake_msg_refines_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> l2_inv7 <span class="main">∩</span> UNIV <span class="main">×</span> l2_inv8<span class="main">}</span> l1_learn <span class="free">m</span><span class="main">,</span> l2_dy_fake_msg <span class="free">m</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Fake_insert_dy_fake_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> l2_inv7D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_generators <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv8D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="comment1">(*change this ?*)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹compromising events›</span></span>
<span class="keyword1" id="pfslvl2-l2_lkr_others_refines_skip"><span class="command">lemma</span></span> l2_lkr_others_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> Id<span class="main">,</span> l2_lkr_others <span class="free">A</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_lkr_after_refines_skip"><span class="command">lemma</span></span> l2_lkr_after_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> Id<span class="main">,</span> l2_lkr_after <span class="free">A</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_skr_refines_learn"><span class="command">lemma</span></span> l2_skr_refines_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> l2_inv7 <span class="main">∩</span> UNIV <span class="main">×</span> l2_inv6 <span class="main">∩</span> UNIV <span class="main">×</span> l2_inv8<span class="main">}</span> l1_learn <span class="free">K</span><span class="main">,</span> l2_skr <span class="free">R</span> <span class="free">K</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">l2_state</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv6"</span></span>
         <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∉</span> partners"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≠</span> test"</span></span> <span class="quoted"><span class="quoted">"run_ended <span class="main">(</span>progress <span class="skolem">s</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xsk <span class="main">=</span> Some <span class="free">K</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hx<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">K</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv8"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="skolem">R</span><span class="main">$</span>sk<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> test <span class="main">∨</span> <span class="skolem">R</span> <span class="main">∈</span> partners"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⦇</span>ik <span class="main">:=</span> insert <span class="free">K</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span><span class="main">⦈</span> <span class="main">∈</span> l2_inv7"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hoare_apply <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_inv7_skr<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Hx 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv7_aux <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹refinement proof›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_trans_refines_l1_trans <span class="main">=</span> 
  l2_dy_fake_msg_refines_learn l2_dy_fake_chan_refines_skip
  l2_lkr_others_refines_skip l2_lkr_after_refines_skip l2_skr_refines_learn
  l2_step1_refines_step1 l2_step2_refines_step2 l2_step3_refines_step3 

<span class="keyword1" id="pfslvl2-l2_refines_init_l1"><span class="command">lemma</span></span> l2_refines_init_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> R12s <span class="main">``</span> <span class="main">(</span>init l1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R12s_defs l1_defs l2_loc_defs<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_refines_trans_l1"><span class="command">lemma</span></span> l2_refines_trans_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv6 <span class="main">∩</span> l2_inv7 <span class="main">∩</span> l2_inv8<span class="main">)</span><span class="main">)</span><span class="main">}</span> trans l1<span class="main">,</span> trans l2 <span class="main">{&gt;</span> R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def l2_def l1_trans_def l2_trans_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_trans_refines_l1_trans<span class="main">)</span>

<span class="keyword1" id="pfslvl2-PO_obs_consistent_R12s"><span class="command">lemma</span></span> PO_obs_consistent_R12s <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R12s med12s l1 l2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R12s_def med12s_def l2_defs<span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_refines_l1"><span class="command">lemma</span></span> l2_refines_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R12s <span class="main">∩</span> 
      <span class="main">(</span>reach l1 <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv5 <span class="main">∩</span> l2_inv6 <span class="main">∩</span> l2_inv7 <span class="main">∩</span> l2_inv8<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med12s l1 l2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="pfslvl2-l2_implements_l1"><span class="command">lemma</span></span> l2_implements_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med12s l1 l2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We want to prove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l2_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  but by refinement we only get <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l2_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  This is fine, since a message in
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> could be added to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ik <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l2_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> would still hold for this new state.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_partial_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l2_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_partial_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>


<span class="keyword1" id="pfslvl2-l2_obs_partial_secrecy"><span class="command">lemma</span></span> l2_obs_partial_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_partial_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_secrecy _ l2_implements_l1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med12s_def s0_secrecy_def l2_partial_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl2-l2_oreach_dy_fake_msg"><span class="command">lemma</span></span> l2_oreach_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> oreach l2 <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> dy_fake_msg <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⦇</span>ik <span class="main">:=</span> insert <span class="free">x</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span><span class="main">⦈</span> <span class="main">∈</span> oreach l2"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_trans_def l2_dy_fake_msg_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l2_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="pfslvl2-l2_obs_secrecy"><span class="command">lemma</span></span> l2_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>l2_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> l2_oreach_dy_fake_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> l2_obs_partial_secrecy <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_partial_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="pfslvl2-l2_secrecy"><span class="command">lemma</span></span> l2_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_secrecy<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l2_iagreement</span> <span class="main">≡</span> l1_iagreement"</span></span>

<span class="keyword1" id="pfslvl2-l2_obs_iagreement"><span class="command">lemma</span></span> l2_obs_iagreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_iagreement"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_iagreement _ l2_implements_l1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med12s_def l1_iagreement_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl2-l2_iagreement"><span class="command">lemma</span></span> l2_iagreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_iagreement"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_iagreement<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="pfslvl3">
<div class="head">
<h1>Theory pfslvl3</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  pfslvl3.thy (Isabelle/HOL 2016-1)
  ID:      $Id: pfslvl3.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Generic Level 3 protocol using ephemeral asymmetric keys to achieve 
  forward secrecy.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Key Transport Protocol with PFS (L3 locale)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> pfslvl3
<span class="keyword2"><span class="keyword">imports</span></span> <a href="pfslvl2.html">pfslvl2</a> <a href="Implem_lemmas.html">Implem_lemmas</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and Events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Level 3 state›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹(The types have to be defined outside the locale.)›</span></span>

<span class="keyword1"><span class="command">record</span></span> l3_state <span class="main">=</span> <span class="quoted">l1_state</span> <span class="main">+</span>  
  bad <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> l3_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"l3_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l3_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l3_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l3_state <span class="main">×</span> l3_state<span class="main">)</span> set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹attacker event›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_dy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_dy</span> <span class="main">≡</span> ik_dy"</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹compromise events›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_lkr_others</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_lkr_others</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">,</span>
           ik <span class="main">:=</span> keys_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_lkr_actor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_lkr_actor</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">,</span>
           ik <span class="main">:=</span> keys_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_lkr_after</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_lkr_after</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    test_ended <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">,</span>
           ik <span class="main">:=</span> keys_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_skr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_skr</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≠</span> test <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∉</span> partners <span class="main">∧</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> xsk <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">R</span></span></span> xsk <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹New locale for the level 3 protocol›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This locale does not add new assumptions, it is only used to separate the level 3
protocol from the implementation locale.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> pfslvl3 <span class="main">=</span> valid_implem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹protocol events›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
    <span class="entity">l3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">}</span><span class="main">)</span><span class="main">,</span>
      ik <span class="main">:=</span> <span class="main">{</span>implAuth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> epubKF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>kE<span class="main">)</span><span class="main">⟩</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span>
      <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">KE</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xpkE <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">KE</span></span></span> <span class="main">∧</span>
    implAuth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">KE</span></span></span><span class="main">⟩</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xpkE<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
      ik <span class="main">:=</span> <span class="main">{</span>implAuth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Aenc <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">KE</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
      signals <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                   addSignal <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">KE</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
                 <span class="keyword1">else</span>
                   signals <span class="bound">s</span><span class="main">,</span>
      secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span>
         <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>  


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xsk <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span>
    implAuth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Aenc <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>epubKF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>kE<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xpkE<span class="main">,</span> xskE<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            signals <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                         addSignal <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>epubKF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>kE<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">⟩</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                         signals <span class="bound">s</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹specification›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹initial compromise›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ik_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ik_init</span> <span class="main">≡</span> <span class="main">{</span>priK <span class="bound">C</span> <span class="main">|</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> bad_init<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>pubK <span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> True<span class="main">}</span> <span class="main">∪</span> 
             <span class="main">{</span>shrK <span class="bound">A</span> <span class="bound">B</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> bad_init <span class="main">∨</span> <span class="bound">B</span> <span class="main">∈</span> bad_init<span class="main">}</span> <span class="main">∪</span> Tags"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹lemmas about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ik_init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1" id="pfslvl3-parts_ik_init"><span class="command">lemma</span></span> parts_ik_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts ik_init <span class="main">=</span> ik_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>

<span class="keyword1" id="pfslvl3-analz_ik_init"><span class="command">lemma</span></span> analz_ik_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz ik_init <span class="main">=</span> ik_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz_into_parts<span class="main">)</span>

<span class="keyword1" id="pfslvl3-abs_ik_init"><span class="command">lemma</span></span> abs_ik_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs ik_init <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> absE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-payloadSet_ik_init"><span class="command">lemma</span></span> payloadSet_ik_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ik_init <span class="main">∩</span> payload <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>

<span class="keyword1" id="pfslvl3-validSet_ik_init"><span class="command">lemma</span></span> validSet_ik_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ik_init <span class="main">∩</span> valid <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
    ik <span class="main">=</span> ik_init<span class="main">,</span>
    secret <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    progress <span class="main">=</span> Map.empty<span class="main">,</span>
    signals <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    bad <span class="main">=</span> bad_init
    <span class="main">⦈</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_init_defs <span class="main">=</span> l3_init_def ik_init_def

<span class="keyword1"><span class="command">definition</span></span> 
<span class="entity">l3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span> <span class="bound">M</span> <span class="bound">KE</span> <span class="bound">Rb</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">K</span><span class="main">.</span>
     l3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     l3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">KE</span> <span class="main">∪</span>
     l3_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">m</span> <span class="main">∪</span>
     l3_dy <span class="bound">M</span> <span class="main">∪</span>
     l3_lkr_others <span class="bound">A</span> <span class="main">∪</span>
     l3_lkr_after <span class="bound">A</span> <span class="main">∪</span>
     l3_skr <span class="bound">Ra</span> <span class="bound">K</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l3_state<span class="main">,</span> l3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> l3_init<span class="main">,</span>
    trans <span class="main">=</span> l3_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_loc_defs <span class="main">=</span> 
  l3_step1_def l3_step2_def l3_step3_def
  l3_def l3_init_defs l3_trans_def
  l3_dy_def
  l3_lkr_others_def l3_lkr_after_def l3_skr_def

<span class="keyword1"><span class="command">lemmas</span></span> l3_defs <span class="main">=</span> l3_loc_defs ik_dy_def
<span class="keyword1"><span class="command">lemmas</span></span> l3_nostep_defs <span class="main">=</span> l3_def l3_init_def l3_trans_def


<span class="keyword1" id="pfslvl3-l3_obs_id"><span class="command">lemma</span></span> l3_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs l3 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def<span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: No long-term keys as message parts›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv1</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
     parts <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">∩</span> range LtK <span class="main">⊆</span> ik <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv1I <span class="main">=</span> l3_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l3_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv1D <span class="main">=</span> l3_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="pfslvl3-l3_inv1D'"><span class="command">lemma</span></span> l3_inv1D' <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> LtK <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">s</span> <span class="main">∈</span> l3_inv1<span class="main">⟧</span> <span class="main">⟹</span> LtK <span class="free">K</span> <span class="main">∈</span> ik <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_inv1_def<span class="main">)</span>

<span class="keyword1" id="pfslvl3-l3_inv1_init"><span class="command">lemma</span></span> l3_inv1_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv1I<span class="main">)</span>

<span class="keyword1" id="pfslvl3-l3_inv1_trans"><span class="command">lemma</span></span> l3_inv1_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv1<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv1I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs dy_fake_msg_def dy_fake_chan_def
        parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ik <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"insert <span class="main">_</span> <span class="main">(</span>ik <span class="main">_</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Fake_parts_insert<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>analz_into_parts<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-PO_l3_inv1"><span class="command">lemma</span></span> PO_l3_inv1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"bad <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> indeed contains "bad" keys›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    Keys_bad <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv2I <span class="main">=</span> l3_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l3_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv2D <span class="main">=</span> l3_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1" id="pfslvl3-l3_inv2_init"><span class="command">lemma</span></span> l3_inv2_init <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv2I Keys_badI<span class="main">)</span>

<span class="keyword1" id="pfslvl3-l3_inv2_trans"><span class="command">lemma</span></span> l3_inv2_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv2 <span class="main">∩</span> l3_inv1<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs dy_fake_msg_def dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹4 subgoals: dy, lkr*, skr›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Keys_bad_insert_Fake Keys_bad_insert_keys_of<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Keys_bad_insert_payload<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-PO_l3_inv2"><span class="command">lemma</span></span> PO_l3_inv2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l3_inv1"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a message can be analyzed from the intruder knowledge then it can
be derived (using synth/analz) from the sets of implementation, non-implementation, and
long-term key messages and the tags. That is, intermediate messages are not needed.
›</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>      
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> 
    synth <span class="main">(</span>analz <span class="main">(</span><span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv3I <span class="main">=</span> l3_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv3E <span class="main">=</span> l3_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv3D <span class="main">=</span> l3_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="pfslvl3-l3_inv3_init"><span class="command">lemma</span></span> l3_inv3_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv3"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_increasing <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Most of the cases in this proof are simple and very similar.
The proof could probably be shortened.›</span></span>
<span class="keyword1" id="pfslvl3-l3_inv3_trans"><span class="command">lemma</span></span> l3_inv3_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_nostep_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step1 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">KE</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step2 <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">KE</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">K</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step3 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">K</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_dy <span class="skolem">m</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs dy_fake_chan_def dy_fake_msg_def
                <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_analz_insert<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_monotone<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_lkr_others <span class="skolem">A</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> analz_Un_partition <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"keys_of <span class="skolem"><span class="skolem">A</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_lkr_after <span class="skolem">A</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> analz_Un_partition <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"keys_of <span class="skolem"><span class="skolem">A</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="skolem">K</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_skr <span class="skolem">R</span> <span class="skolem">K</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="pfslvl3-PO_l3_inv3"><span class="command">lemma</span></span> PO_l3_inv3 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4: the intruder knows the tags›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv4</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    Tags <span class="main">⊆</span> ik <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv4I <span class="main">=</span> l3_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l3_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv4D <span class="main">=</span> l3_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="pfslvl3-l3_inv4_init"><span class="command">lemma</span></span> l3_inv4_init <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def ik_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv4I<span class="main">)</span>

<span class="keyword1" id="pfslvl3-l3_inv4_trans"><span class="command">lemma</span></span> l3_inv4_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv4<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs dy_fake_chan_def dy_fake_msg_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-PO_l3_inv4"><span class="command">lemma</span></span> PO_l3_inv4 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The remaining invariants are derived from the others.
They are not protocol dependent provided the previous invariants hold.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The messages that the L3 DY intruder can derive from the intruder knowledge 
(using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>/<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"analz"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), are either implementations or intermediate messages or
can also be derived by the L2 intruder from the set 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"extr <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> payload<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>abs <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, that is, given the 
non-implementation messages and the abstractions of (implementation) messages
in the intruder knowledge. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv5</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 
    dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">(</span>abs <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv5I <span class="main">=</span> l3_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv5E <span class="main">=</span> l3_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv5D <span class="main">=</span> l3_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="pfslvl3-l3_inv5_derived"><span class="command">lemma</span></span> l3_inv5_derived<span class="main">:</span> <span class="quoted"><span class="quoted">"l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">⊆</span> l3_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_validSet dy_fake_msg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv5I
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> synth_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_NI_I_K_synth_analz_NI_E <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="pfslvl3-PO_l3_inv5"><span class="command">lemma</span></span> PO_l3_inv5 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv5"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv5_derived PO_l3_inv2 PO_l3_inv3 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing an insecure channel message, then:
\begin{itemize}
  \item either the message is already in the intruder knowledge;
  \item or the message is constructed, and the payload can also be deduced by the intruder.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv6</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv6I <span class="main">=</span> l3_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv6E <span class="main">=</span> l3_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv6D <span class="main">=</span> l3_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="pfslvl3-l3_inv6_derived"><span class="command">lemma</span></span> l3_inv6_derived <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv6"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv6I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹1 subgoal›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implInsec_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">"ik <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-PO_l3_inv6"><span class="command">lemma</span></span> PO_l3_inv6 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv6"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv6_derived PO_l3_inv3 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing a confidential channel message,
then:
\begin{itemize}
 \item either the message is already in the intruder knowledge;
 \item or the message is constructed, and the payload can also be deduced by the intruder.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv7</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv7I <span class="main">=</span> l3_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv7E <span class="main">=</span> l3_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv7D <span class="main">=</span> l3_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="pfslvl3-l3_inv7_derived"><span class="command">lemma</span></span> l3_inv7_derived <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv7"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv7I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹1 subgoal›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implConfid_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">"ik <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-PO_l3_inv7"><span class="command">lemma</span></span> PO_l3_inv7 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv7"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv7_derived PO_l3_inv3 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv8›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing an authentic channel message then:
\begin{itemize}
  \item either the message is already in the intruder knowledge;
  \item or the message is constructed, and in this case the payload can also be deduced
     by the intruder, and one of the agents is bad.
\end{itemize}
›</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv8</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv8</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∈</span> bad <span class="bound">s</span> <span class="main">∨</span> <span class="bound">B</span> <span class="main">∈</span> bad <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv8I <span class="main">=</span> l3_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv8E <span class="main">=</span> l3_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv8D <span class="main">=</span> l3_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="pfslvl3-l3_inv8_derived"><span class="command">lemma</span></span> l3_inv8_derived <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv8"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv8I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D l3_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹2 subgoals: M is deducible and the agents are bad›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implAuth_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implAuth_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-PO_l3_inv8"><span class="command">lemma</span></span> PO_l3_inv8 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv8"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv8_derived
  PO_l3_inv3 PO_l3_inv2 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv9›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing a secure channel message then:
\begin{itemize}
  \item either the message is already in the intruder knowledge;
  \item or the message is constructed, and in this case the payload can also be deduced 
 by the intruder, and one of the agents is bad.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv9</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv9</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∈</span> bad <span class="bound">s</span> <span class="main">∨</span> <span class="bound">B</span> <span class="main">∈</span> bad <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv9I <span class="main">=</span> l3_inv9_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv9E <span class="main">=</span> l3_inv9_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv9D <span class="main">=</span> l3_inv9_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="pfslvl3-l3_inv9_derived"><span class="command">lemma</span></span> l3_inv9_derived <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv9"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv9I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv3D l3_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹2 subgoals: M is deducible and the agents are bad›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSecure_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSecure_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-PO_l3_inv9"><span class="command">lemma</span></span> PO_l3_inv9 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv9"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv9_derived
  PO_l3_inv3 PO_l3_inv2 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹mediator function›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med23s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_obs <span class="main">⇒</span> l2_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med23s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    ik <span class="main">=</span> ik <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∩</span> payload<span class="main">,</span>
    secret <span class="main">=</span> secret <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    progress <span class="main">=</span> progress <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signals <span class="main">=</span> signals <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    chan <span class="main">=</span> abs <span class="main">(</span>ik <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
    bad <span class="main">=</span> bad <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹relation between states›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l2_state <span class="main">*</span> l3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23s</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">s</span> <span class="main">=</span> med23s <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23s_defs <span class="main">=</span> R23s_def med23s_def


<span class="keyword1" id="pfslvl3-R23sI"><span class="command">lemma</span></span> R23sI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ik <span class="free">s</span> <span class="main">=</span> ik <span class="free">t</span> <span class="main">∩</span> payload<span class="main">;</span> secret <span class="free">s</span> <span class="main">=</span> secret <span class="free">t</span><span class="main">;</span> progress <span class="free">s</span> <span class="main">=</span> progress <span class="free">t</span><span class="main">;</span> signals <span class="free">s</span> <span class="main">=</span> signals <span class="free">t</span><span class="main">;</span>
     chan <span class="free">s</span> <span class="main">=</span> abs <span class="main">(</span>ik <span class="free">t</span><span class="main">)</span><span class="main">;</span> l2_state.bad <span class="free">s</span> <span class="main">=</span> bad <span class="free">t</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23s"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_def med23s_def<span class="main">)</span>

<span class="keyword1" id="pfslvl3-R23sD"><span class="command">lemma</span></span> R23sD<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23s <span class="main">⟹</span>
    ik <span class="free">s</span> <span class="main">=</span> ik <span class="free">t</span> <span class="main">∩</span> payload <span class="main">∧</span> secret <span class="free">s</span> <span class="main">=</span> secret <span class="free">t</span> <span class="main">∧</span> progress <span class="free">s</span> <span class="main">=</span> progress <span class="free">t</span> <span class="main">∧</span> signals <span class="free">s</span> <span class="main">=</span> signals <span class="free">t</span> <span class="main">∧</span>
    chan <span class="free">s</span> <span class="main">=</span> abs <span class="main">(</span>ik <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> l2_state.bad <span class="free">s</span> <span class="main">=</span> bad <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_def med23s_def<span class="main">)</span>

<span class="keyword1" id="pfslvl3-R23sE"><span class="command">lemma</span></span> R23sE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23s<span class="main">;</span>
     <span class="main">⟦</span> ik <span class="free">s</span> <span class="main">=</span> ik <span class="free">t</span> <span class="main">∩</span> payload<span class="main">;</span> secret <span class="free">s</span> <span class="main">=</span> secret <span class="free">t</span><span class="main">;</span> progress <span class="free">s</span> <span class="main">=</span> progress <span class="free">t</span><span class="main">;</span> signals <span class="free">s</span> <span class="main">=</span> signals <span class="free">t</span><span class="main">;</span>
     chan <span class="free">s</span> <span class="main">=</span> abs <span class="main">(</span>ik <span class="free">t</span><span class="main">)</span><span class="main">;</span> l2_state.bad <span class="free">s</span> <span class="main">=</span> bad <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_def med23s_def<span class="main">)</span>

<span class="keyword1" id="pfslvl3-can_signal_R23"><span class="command">lemma</span></span> can_signal_R23 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s2</span><span class="main">,</span> <span class="free">s3</span><span class="main">)</span> <span class="main">∈</span> R23s <span class="main">⟹</span>
   can_signal <span class="free">s2</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> can_signal <span class="free">s3</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Protocol events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="pfslvl3-l3_step1_refines_step1"><span class="command">lemma</span></span> l3_step1_refines_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">,</span> l3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_step1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-l3_step2_refines_step2"><span class="command">lemma</span></span> l3_step2_refines_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">KE</span><span class="main">,</span> l3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">KE</span><span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l2_step2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_step2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-l3_step3_refines_step3"><span class="command">lemma</span></span> l3_step3_refines_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">K</span><span class="main">,</span> l3_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">K</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l2_step3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_step3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Intruder events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="pfslvl3-l3_dy_payload_refines_dy_fake_msg"><span class="command">lemma</span></span> l3_dy_payload_refines_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> payload <span class="main">⟹</span>
   <span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> l3_inv5<span class="main">}</span> l2_dy_fake_msg <span class="free">M</span><span class="main">,</span> l3_dy <span class="free">M</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_dy_fake_msg_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv5D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-l3_dy_valid_refines_dy_fake_chan"><span class="command">lemma</span></span> l3_dy_valid_refines_dy_fake_chan<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">∈</span> valid<span class="main">;</span> <span class="free">M'</span> <span class="main">∈</span> abs <span class="main">{</span><span class="free">M</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">}</span> 
      l2_dy_fake_chan <span class="free">M'</span><span class="main">,</span> l3_dy <span class="free">M</span> 
   <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹1 subgoal›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> valid_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_chan_def<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Insec›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv6D l3_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Confid›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv7D l3_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auth›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv8D l3_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Secure›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv9D l3_inv5D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="pfslvl3-l3_dy_valid_refines_dy_fake_chan_Un"><span class="command">lemma</span></span> l3_dy_valid_refines_dy_fake_chan_Un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> valid <span class="main">⟹</span>
   <span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">}</span> 
      <span class="main">⋃</span><span class="bound">M'</span><span class="main">.</span> l2_dy_fake_chan <span class="bound">M'</span><span class="main">,</span> l3_dy <span class="free">M</span> 
   <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> valid_abs <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l3_dy_valid_refines_dy_fake_chan<span class="main">)</span>


<span class="keyword1" id="pfslvl3-l3_dy_isLtKey_refines_skip"><span class="command">lemma</span></span> l3_dy_isLtKey_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> Id<span class="main">,</span> l3_dy <span class="main">(</span>LtK <span class="free">ltk</span><span class="main">)</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l3_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> absE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-l3_dy_others_refines_skip"><span class="command">lemma</span></span> l3_dy_others_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">∉</span> range LtK<span class="main">;</span> <span class="free">M</span> <span class="main">∉</span> valid<span class="main">;</span> <span class="free">M</span> <span class="main">∉</span> payload <span class="main">⟧</span> <span class="main">⟹</span> 
   <span class="main">{</span>R23s<span class="main">}</span> Id<span class="main">,</span> l3_dy <span class="free">M</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>     <span class="comment1">(* auto SLOW *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> absE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> validI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="pfslvl3-l3_dy_refines_dy_fake_msg_dy_fake_chan_skip"><span class="command">lemma</span></span> l3_dy_refines_dy_fake_msg_dy_fake_chan_skip<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">}</span> 
      l2_dy_fake_msg <span class="free">M</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">M'</span><span class="main">.</span> l2_dy_fake_chan <span class="bound">M'</span><span class="main">)</span> <span class="main">∪</span> Id<span class="main">,</span> l3_dy <span class="free">M</span> 
    <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK"</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_dy_payload_refines_dy_fake_msg l3_dy_valid_refines_dy_fake_chan_Un 
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l3_dy_isLtKey_refines_skip <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_dy_others_refines_skip<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Compromise events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="pfslvl3-l3_lkr_others_refines_lkr_others"><span class="command">lemma</span></span> l3_lkr_others_refines_lkr_others<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_lkr_others <span class="free">A</span><span class="main">,</span> l3_lkr_others <span class="free">A</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_lkr_others_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-l3_lkr_after_refines_lkr_after"><span class="command">lemma</span></span> l3_lkr_after_refines_lkr_after<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_lkr_after <span class="free">A</span><span class="main">,</span> l3_lkr_after <span class="free">A</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_lkr_after_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-l3_skr_refines_skr"><span class="command">lemma</span></span> l3_skr_refines_skr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_skr <span class="free">R</span> <span class="free">K</span><span class="main">,</span> l3_skr <span class="free">R</span> <span class="free">K</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_skr_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">lemmas</span></span> l3_trans_refines_l2_trans <span class="main">=</span> 
  l3_step1_refines_step1 l3_step2_refines_step2 l3_step3_refines_step3
  l3_dy_refines_dy_fake_msg_dy_fake_chan_skip
  l3_lkr_others_refines_lkr_others l3_lkr_after_refines_lkr_after l3_skr_refines_skr



<span class="keyword1" id="pfslvl3-l3_refines_init_l2"><span class="command">lemma</span></span> l3_refines_init_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> R23s <span class="main">``</span> <span class="main">(</span>init l2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_defs l2_defs l3_def l3_init_def<span class="main">)</span>

<span class="keyword1" id="pfslvl3-l3_refines_trans_l2"><span class="command">lemma</span></span> l3_refines_trans_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l3_inv1 <span class="main">∩</span> l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4<span class="main">)</span><span class="main">)</span><span class="main">}</span> trans l2<span class="main">,</span> trans l3 <span class="main">{&gt;</span> R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pre'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"R23s <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span><span class="var">?post</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conseq_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pre</span> <span class="main">⊆</span> <span class="var">?pre'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l3_inv5_derived l3_inv6_derived l3_inv7_derived l3_inv8_derived l3_inv9_derived <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre'</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span> <span class="var">?post</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l3_def l2_trans_def l3_trans_def
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_trans_refines_l2_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1" id="pfslvl3-PO_obs_consistent_R23s"><span class="command">lemma</span></span> PO_obs_consistent_R23s <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R23s med23s l2 l3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23s_def med23s_def l2_defs<span class="main">)</span>


<span class="keyword1" id="pfslvl3-l3_refines_l2"><span class="command">lemma</span></span> l3_refines_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R23s <span class="main">∩</span> 
      <span class="main">(</span>reach l2 <span class="main">×</span> <span class="main">(</span>l3_inv1 <span class="main">∩</span> l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med23s l2 l3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="pfslvl3-l3_implements_l2"><span class="command">lemma</span></span> l3_implements_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med23s l2 l3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv10: secrets contain no implementation material›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv10</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv10</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    secret <span class="bound">s</span> <span class="main">⊆</span> payload
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv10I <span class="main">=</span> l3_inv10_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv10E <span class="main">=</span> l3_inv10_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv10D <span class="main">=</span> l3_inv10_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="pfslvl3-l3_inv10_init"><span class="command">lemma</span></span> l3_inv10_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv10"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def ik_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv10I<span class="main">)</span>

<span class="keyword1" id="pfslvl3-l3_inv10_trans"><span class="command">lemma</span></span> l3_inv10_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv10<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv10<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l3_inv10_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-PO_l3_inv10"><span class="command">lemma</span></span> PO_l3_inv10 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv10"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="pfslvl3-l3_obs_inv10"><span class="command">lemma</span></span> l3_obs_inv10 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_inv10"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Partial secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We want to prove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l3_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, ie
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  but by refinement we only get <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l3_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: 
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">payloadSet</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>abs <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  This is fine if secrets contain no implementation material.
  Then, by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">inv5</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, a message in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is in
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">payloadSet</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>abs <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">-</span></span>payload"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l3_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> proves it is not a secret.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_partial_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l3_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_partial_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> 
    dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">(</span>abs <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1" id="pfslvl3-l3_obs_partial_secrecy"><span class="command">lemma</span></span> l3_obs_partial_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_partial_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_secrecy _ l3_implements_l2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l2_secrecy_def l3_partial_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l3_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l3_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_secrecy</span> <span class="main">≡</span> l1_secrecy"</span></span>

<span class="keyword1" id="pfslvl3-l3_obs_inv5"><span class="command">lemma</span></span> l3_obs_inv5<span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>

<span class="keyword1" id="pfslvl3-l3_obs_secrecy"><span class="command">lemma</span></span> l3_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> l3_obs_inv5 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> l3_obs_inv10 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l2_secrecy_def l3_secrecy_def s0_secrecy_def l3_inv10_def<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> l3_partial_secrecy_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv5D subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_partial_secrecy<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-l3_secrecy"><span class="command">lemma</span></span> l3_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_secrecy<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Injective agreement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l3_iagreement</span> <span class="main">≡</span> l1_iagreement"</span></span>

<span class="keyword1" id="pfslvl3-l3_obs_iagreement"><span class="command">lemma</span></span> l3_obs_iagreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_iagreement"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_iagreement _ l3_implements_l2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l1_iagreement_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="pfslvl3-l3_iagreement"><span class="command">lemma</span></span> l3_iagreement <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_iagreement"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_iagreement<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="pfslvl3_asymmetric">
<div class="head">
<h1>Theory pfslvl3_asymmetric</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  pfslvl3_asymmetric.thy (Isabelle/HOL 2016-1)
  ID:      $Id: pfslvl3_asymmetric.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-3 protocol using ephemeral asymmetric keys to achieve forward secrecy.
  Asymmetric instantiation.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Key Transport Protocol with PFS (L3, asymmetric implementation)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> pfslvl3_asymmetric
<span class="keyword2"><span class="keyword">imports</span></span> <a href="pfslvl3.html">pfslvl3</a> <a href="Implem_asymmetric.html">Implem_asymmetric</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pfslvl3_asym<span class="main">:</span> pfslvl3 <span class="quoted">implem_asym</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="pfslvl3_symmetric">
<div class="head">
<h1>Theory pfslvl3_symmetric</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  pfslvl3_symmetric.thy (Isabelle/HOL 2016-1)
  ID:      $Id: pfslvl3_symmetric.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-3 protocol using ephemeral asymmetric keys to achieve forward secrecy.
  Symmetric instantiation.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Key Transport Protocol with PFS (L3, symmetric implementation)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> pfslvl3_symmetric
<span class="keyword2"><span class="keyword">imports</span></span> <a href="pfslvl3.html">pfslvl3</a> <a href="Implem_symmetric.html">Implem_symmetric</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pfslvl3_asym<span class="main">:</span> pfslvl3 <span class="quoted">implem_sym</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="dhlvl1">
<div class="head">
<h1>Theory dhlvl1</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  dhlvl1.thy (Isabelle/HOL 2016-1)
  ID:      $Id: dhlvl1.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-1 Diffie-Hellman guard protocol.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Authenticated Diffie Hellman Protocol (L1)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> dhlvl1
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Runs.html">Runs</a> <a href="Secrecy.html">Secrecy</a> <a href="AuthenticationI.html">AuthenticationI</a> <a href="Payloads.html">Payloads</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> option.split_asm <span class="main">[</span><span class="operator">split</span><span class="main">]</span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and Events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">consts</span></span>
  Nend <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nx</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">nx</span> <span class="main">≡</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ny</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ny</span> <span class="main">≡</span> <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proofs break if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is used, because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">method</span></span> "simp"<span class="antiquote"><span class="antiquote">}</span></span></span></span> replaces it with
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\dots.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xEnd</span> <span class="main">≡</span> Var <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xnx</span> <span class="main">≡</span> Var <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xny</span> <span class="main">≡</span> Var <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xsk</span> <span class="main">≡</span> Var <span class="numeral">4</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xgnx</span> <span class="main">≡</span> Var <span class="numeral">5</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xgny</span> <span class="main">≡</span> Var <span class="numeral">6</span>"</span></span>



<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">End</span> <span class="main">≡</span> Number Nend"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Domain of each role (protocol dependent).›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">domain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">domain</span> Init <span class="main">=</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">domain</span> Resp <span class="main">=</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">consts</span></span>
  test <span class="main">::</span> <span class="quoted">rid_t</span>
  
<span class="keyword1"><span class="command">consts</span></span>
  guessed_runs <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> run_t"</span></span>
  guessed_frame <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> frame"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specification of the guessed frame: 
\begin{enumerate}
\item Domain
\item Well-typedness.
  The messages in the frame of a run never contain implementation material
  even if the agents of the run are dishonest.
  Therefore we consider only well-typed frames.
  This is notably required for the session key compromise; it also helps proving
  the partitionning of ik,
  since we know that the messages added by the protocol do not contain ltkeys in their
  payload and are therefore valid implementations.
\item We also ensure that the values generated by the frame owner are correctly guessed.
\end{enumerate}›</span></span>
<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">guessed_frame</span><span class="main">)</span> 
  guessed_frame_dom_spec <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"dom <span class="main">(</span>guessed_frame <span class="free">R</span><span class="main">)</span> <span class="main">=</span> domain <span class="main">(</span>role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_payload_spec <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> payload"</span></span>
  guessed_frame_Init_xnx <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init <span class="main">⟹</span> guessed_frame <span class="free">R</span> xnx <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_Init_xgnx <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init <span class="main">⟹</span> guessed_frame <span class="free">R</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_Resp_xny <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Resp <span class="main">⟹</span> guessed_frame <span class="free">R</span> xny <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_Resp_xgny <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Resp <span class="main">⟹</span> guessed_frame <span class="free">R</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_xEnd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xEnd <span class="main">=</span> Some End"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> 
    <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">.</span></span>
      <span class="keyword1"><span class="keyword1">if</span></span> role <span class="main"><span class="main">(</span></span>guessed_runs <span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> Init <span class="keyword1"><span class="keyword1">then</span></span>
        <span class="main"><span class="main">[</span></span>xnx <span class="main"><span class="main">↦</span></span> NonceF <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">$</span></span>nx<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> xgnx <span class="main"><span class="main">↦</span></span> Exp Gen <span class="main"><span class="main">(</span></span>NonceF <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">$</span></span>nx<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> xgny <span class="main"><span class="main">↦</span></span> End<span class="main"><span class="main">,</span></span> 
         xsk <span class="main"><span class="main">↦</span></span> End<span class="main"><span class="main">,</span></span> xEnd <span class="main"><span class="main">↦</span></span> End<span class="main"><span class="main">]</span></span>
      <span class="keyword1"><span class="keyword1">else</span></span>
        <span class="main"><span class="main">[</span></span>xny <span class="main"><span class="main">↦</span></span> NonceF <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">$</span></span>ny<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> xgnx <span class="main"><span class="main">↦</span></span> End<span class="main"><span class="main">,</span></span> xgny <span class="main"><span class="main">↦</span></span> Exp Gen <span class="main"><span class="main">(</span></span>NonceF <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">$</span></span>ny<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> 
         xsk <span class="main"><span class="main">↦</span></span> End<span class="main"><span class="main">,</span></span> xEnd <span class="main"><span class="main">↦</span></span> End<span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> role_t.exhaust<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_owner</span> <span class="main">≡</span> owner <span class="main">(</span>guessed_runs test<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_partner</span> <span class="main">≡</span> partner <span class="main">(</span>guessed_runs test<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Level 1 state.›</span></span>

<span class="keyword1"><span class="command">record</span></span> l1_state <span class="main">=</span> 
  <span class="quoted">s0_state</span> <span class="main">+</span>
  progress <span class="main">::</span> <span class="quoted">progress_t</span>
  signalsInit <span class="main">::</span> <span class="quoted"><span class="quoted">"signal <span class="main">⇒</span> nat"</span></span>
  signalsResp <span class="main">::</span> <span class="quoted"><span class="quoted">"signal <span class="main">⇒</span> nat"</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> l1_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"l1_state"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">run_ended</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set option <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">run_ended</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> in_progress <span class="free"><span class="bound"><span class="entity">r</span></span></span> xEnd"</span></span>

<span class="keyword1" id="dhlvl1-run_ended_not_None"><span class="command">lemma</span></span> run_ended_not_None <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_ended <span class="free">R</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">=</span> None <span class="main">⟹</span> False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_progress_Some<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">test_ended</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> $\longleftrightarrow$ the test run has ended in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">test_ended</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> l1_state_scheme <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_ended</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> run_ended <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">s</span></span></span> test<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A run can emit signals if it involves the same agents as the test run, and if the test run 
  has not ended yet.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">can_signal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> l1_state_scheme <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">can_signal</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> test_owner <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> test_partner<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> test_owner <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> test_partner<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">¬</span> test_ended <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_learn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_learn</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guard›</span>
    synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>secret <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>  <span class="main">∧</span>
    <span class="comment1">― ‹action›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">⦇</span>ik <span class="main">:=</span> ik <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Potocol events.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{itemize}
\item step 1: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 2: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reads $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ insecurely,
  generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  emits a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 3: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reads $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  authentically,
  computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$, emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$, a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 4: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reads $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  authentically,
  emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">}</span><span class="main">)</span>
      <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xgny<span class="main">,</span> xgnx<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                          addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                          signalsInit <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xgny <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟶</span> <span class="comment1">― ‹authentication guard›</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">Rb</span><span class="main">.</span> guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
             in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xgny <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                         addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                         signalsInit <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                         addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                         signalsResp <span class="bound">s</span>

          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_step4</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    <span class="main">(</span>can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟶</span> <span class="comment1">― ‹authentication guard›</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">Ra</span><span class="main">.</span> guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
             in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Ra</span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
             guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                             addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                           <span class="keyword1">else</span>
                             signalsResp <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specification.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l1_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
    ik <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    secret <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    progress <span class="main">=</span> Map.empty<span class="main">,</span>
    signalsInit <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsResp <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span>
    <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l1_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">x</span><span class="main">.</span>
     l1_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     l1_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">x</span> <span class="main">∪</span>
     l1_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">x</span> <span class="main">∪</span>
     l1_step4 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">x</span> <span class="main">∪</span>
     l1_learn <span class="bound">m</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l1_state<span class="main">,</span> l1_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> l1_init<span class="main">,</span>
    trans <span class="main">=</span> l1_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_defs <span class="main">=</span> 
  l1_def l1_init_def l1_trans_def
  l1_learn_def
  l1_step1_def l1_step2_def l1_step3_def l1_step4_def

<span class="keyword1"><span class="command">lemmas</span></span> l1_nostep_defs <span class="main">=</span>
  l1_def l1_init_def l1_trans_def

<span class="keyword1" id="dhlvl1-l1_obs_id"><span class="command">lemma</span></span> l1_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs l1 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def<span class="main">)</span>


<span class="keyword1" id="dhlvl1-run_ended_trans"><span class="command">lemma</span></span> run_ended_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_ended <span class="main">(</span>progress <span class="free">s</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l1 <span class="main">⟹</span>
   run_ended <span class="main">(</span>progress <span class="free">s'</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_defs ik_dy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl1-can_signal_trans"><span class="command">lemma</span></span> can_signal_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"can_signal <span class="free">s'</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l1 <span class="main">⟹</span>
  can_signal <span class="free">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def run_ended_trans<span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement: secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med01s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_obs <span class="main">⇒</span> s0_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med01s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> ik <span class="main">=</span> ik <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> secret <span class="main">=</span> secret <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation between states.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R01s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>s0_state <span class="main">*</span> l1_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R01s</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">s</span> <span class="main">=</span> <span class="main">⦇</span>ik <span class="main">=</span> ik <span class="bound">s'</span><span class="main">,</span> secret <span class="main">=</span> secret <span class="bound">s'</span><span class="main">⦈</span>
    <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol independent events.›</span></span>

<span class="keyword1" id="dhlvl1-l1_learn_refines_learn"><span class="command">lemma</span></span> l1_learn_refines_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> s0_learn <span class="free">m</span><span class="main">,</span> l1_learn <span class="free">m</span> <span class="main">{&gt;</span>R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01s_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_defs s0_defs s0_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1" id="dhlvl1-l1_step1_refines_skip"><span class="command">lemma</span></span> l1_step1_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> Id<span class="main">,</span> l1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01s_def l1_step1_def<span class="main">)</span>

<span class="keyword1" id="dhlvl1-l1_step2_refines_skip"><span class="command">lemma</span></span> l1_step2_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> Id<span class="main">,</span> l1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01s_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl1-l1_step3_refines_add_secret_skip"><span class="command">lemma</span></span> l1_step3_refines_add_secret_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> s0_add_secret <span class="main">(</span>Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> Id<span class="main">,</span> l1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span> <span class="main">{&gt;</span>R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01s_def s0_add_secret_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl1-l1_step4_refines_add_secret_skip"><span class="command">lemma</span></span> l1_step4_refines_add_secret_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> s0_add_secret <span class="main">(</span>Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> Id<span class="main">,</span> l1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01s_def s0_add_secret_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step4_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_trans_refines_s0_trans <span class="main">=</span> 
  l1_learn_refines_learn
  l1_step1_refines_skip l1_step2_refines_skip 
  l1_step3_refines_add_secret_skip l1_step4_refines_add_secret_skip

<span class="keyword1" id="dhlvl1-l1_refines_init_s0"><span class="command">lemma</span></span> l1_refines_init_s0 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> R01s <span class="main">``</span> <span class="main">(</span>init s0<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R01s_def s0_defs l1_defs s0_secrecy_def<span class="main">)</span>


<span class="keyword1" id="dhlvl1-l1_refines_trans_s0"><span class="command">lemma</span></span> l1_refines_trans_s0 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01s<span class="main">}</span> trans s0<span class="main">,</span> trans l1 <span class="main">{&gt;</span> R01s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s0_def l1_def s0_trans_def l1_trans_def 
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l1_trans_refines_s0_trans<span class="main">)</span>


<span class="keyword1" id="dhlvl1-obs_consistent_med01x"><span class="command">lemma</span></span> obs_consistent_med01x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R01s med01s s0 l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R01s_def med01s_def<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>
<span class="keyword1" id="dhlvl1-l1s_refines_s0"><span class="command">lemma</span></span> l1s_refines_s0 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     R01s
     med01s s0 l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>refines_def PO_refines_def<span class="main">)</span>

<span class="keyword1" id="dhlvl1-l1_implements_s0"><span class="command">lemma</span></span>  l1_implements_s0 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med01s s0 l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants: secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l1_secrecy</span> <span class="main">≡</span> s0_secrecy"</span></span>


<span class="keyword1" id="dhlvl1-l1_obs_secrecy"><span class="command">lemma</span></span> l1_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l1 <span class="main">⊆</span> l1_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> s0_obs_secrecy _ l1_implements_s0<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med01s_def s0_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl1-l1_secrecy"><span class="command">lemma</span></span> l1_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_secrecy<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authenticates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If an initiator commit signal exists for $(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span><span class="main"><span class="main">$</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, has passed step 3, and has <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(g^ny)^(Ra$nx)›</span></span></span></span> as the key in its frame.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_inv1</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gny</span><span class="main">.</span>
    signalsInit <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="main">(</span>Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span>
      guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">∧</span>
      progress <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Ra</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv1I <span class="main">=</span> l1_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv1D <span class="main">=</span> l1_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>


<span class="keyword1" id="dhlvl1-l1_inv1_init"><span class="command">lemma</span></span> l1_inv1_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> l1_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def l1_init_def l1_inv1_def<span class="main">)</span>

<span class="keyword1" id="dhlvl1-l1_inv1_trans"><span class="command">lemma</span></span> l1_inv1_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l1_inv1<span class="main">}</span> trans l1 <span class="main">{&gt;</span> l1_inv1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l1_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv1I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_defs ik_dy_def l1_inv1_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_inj2 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl1-PO_l1_inv1"><span class="command">lemma</span></span> PO_l1_inv1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has passed step 2 then
      (if possible) an initiator running signal has been emitted.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_inv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_inv2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">gnx</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span><span class="main">.</span>
    guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="bound">gnx</span> <span class="main">⟶</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
      signalsInit <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="main">(</span>Exp <span class="bound">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_inv2I <span class="main">=</span> l1_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv2D <span class="main">=</span> l1_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>


<span class="keyword1" id="dhlvl1-l1_inv2_init"><span class="command">lemma</span></span> l1_inv2_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> l1_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def l1_init_def l1_inv2_def<span class="main">)</span>

<span class="keyword1" id="dhlvl1-l1_inv2_trans"><span class="command">lemma</span></span> l1_inv2_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l1_inv2<span class="main">}</span> trans l1 <span class="main">{&gt;</span> l1_inv2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> can_signal_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_defs ik_dy_def l1_inv2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl1-PO_l1_inv2"><span class="command">lemma</span></span> PO_l1_inv2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3 (derived)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
If an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run before step 3 and a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run after step 2 both know the same
half-keys (more or less), then the number of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> running signals for the key is strictly
greater than the number of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> commit signals.
(actually, there are 0 commit and 1 running).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_inv3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_inv3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Ra</span> <span class="bound">gny</span><span class="main">.</span>
    guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xgny <span class="main">=</span> Some <span class="bound">gny</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟶</span>
    progress <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">}</span> <span class="main">⟶</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
      signalsInit <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="main">(</span>Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">&lt;</span> signalsInit <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="main">(</span>Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_inv3I <span class="main">=</span> l1_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv3D <span class="main">=</span> l1_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl1-l1_inv3_derived"><span class="command">lemma</span></span> l1_inv3_derived<span class="main">:</span> <span class="quoted"><span class="quoted">"l1_inv1 <span class="main">∩</span> l1_inv2 <span class="main">⊆</span> l1_inv3"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x A B Rb Ra<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> 
  <span class="quoted"><span class="quoted">"signalsInit <span class="improper">x</span> <span class="main">(</span>Commit <span class="improper">A</span> <span class="improper">B</span> <span class="main">(</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="improper">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="improper">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l1_inv1D <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> equalityE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authenticates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> commit signal exists for $(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span><span class="main"><span class="main">$</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, has finished its run, and
  has $(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span><span class="main"><span class="main">$</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ as the key in its frame.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_inv4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_inv4</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gnx</span><span class="main">.</span>
    signalsResp <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="main">(</span>Exp <span class="bound">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span>
      guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">∧</span>
      progress <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="bound">gnx</span>
   <span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv4I <span class="main">=</span> l1_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv4D <span class="main">=</span> l1_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>


<span class="keyword1" id="dhlvl1-l1_inv4_init"><span class="command">lemma</span></span> l1_inv4_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> l1_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def l1_init_def l1_inv4_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>

<span class="keyword1" id="dhlvl1-l1_inv4_trans"><span class="command">lemma</span></span> l1_inv4_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l1_inv4<span class="main">}</span> trans l1 <span class="main">{&gt;</span> l1_inv4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l1_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_inv4_def  l1_defs ik_dy_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_inj2 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="dhlvl1-PO_l1_inv4"><span class="command">lemma</span></span> PO_l1_inv4 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has passed step3 then (if possible) a
       <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> running signal has been emitted.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_inv5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_inv5</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">gny</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span><span class="main">.</span>
    guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="bound">gny</span> <span class="main">⟶</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
      signalsResp <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="main">(</span>Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_inv5I <span class="main">=</span> l1_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv5E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv5D <span class="main">=</span> l1_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>


<span class="keyword1" id="dhlvl1-l1_inv5_init"><span class="command">lemma</span></span> l1_inv5_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> l1_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def l1_init_def l1_inv5_def<span class="main">)</span>

<span class="keyword1" id="dhlvl1-l1_inv5_trans"><span class="command">lemma</span></span> l1_inv5_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l1_inv5<span class="main">}</span> trans l1 <span class="main">{&gt;</span> l1_inv5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv5I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> can_signal_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_defs ik_dy_def l1_inv5_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl1-PO_l1_inv5"><span class="command">lemma</span></span> PO_l1_inv5 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6 (derived)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run before step 4 and an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run after step 3 both know
  the same half-keys (more or less), then the number of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> running signals
  for the key is strictly greater than the number of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> commit signals.
  (actually, there are 0 commit and 1 running).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l1_inv6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_inv6</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Ra</span> <span class="bound">gnx</span><span class="main">.</span>
    guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xgnx <span class="main">=</span> Some <span class="bound">gnx</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
    progress <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">⟶</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
      signalsResp <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="main">(</span>Exp <span class="bound">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">&lt;</span> signalsResp <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="main">(</span>Exp <span class="bound">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_inv6I <span class="main">=</span> l1_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv6E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_inv6D <span class="main">=</span> l1_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl1-l1_inv6_derived"><span class="command">lemma</span></span> l1_inv6_derived<span class="main">:</span>
  <span class="quoted"><span class="quoted">"l1_inv4 <span class="main">∩</span> l1_inv5 <span class="main">⊆</span> l1_inv6"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv6I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted">l1_state</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Rb</span> <span class="skolem">Ra</span>
  <span class="keyword3"><span class="command">assume</span></span> HRun<span class="main">:</span><span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Init<span class="main">,</span> owner <span class="main">=</span> <span class="skolem">A</span><span class="main">,</span> partner <span class="main">=</span> <span class="skolem">B</span><span class="main">⦈</span>"</span></span>
              <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="skolem">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> HRb<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="skolem">s</span> <span class="skolem">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> I4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l1_inv4"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> I5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l1_inv5"</span></span>
  <span class="keyword1"><span class="command">from</span></span> I4 HRb 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"signalsResp <span class="skolem">s</span> <span class="main">(</span>Commit <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">(</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> 
       <span class="main">⟹</span> False"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv4D<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">=</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
    HC<span class="main">:</span> <span class="quoted"><span class="quoted">"signalsResp <span class="skolem">s</span> <span class="main">(</span>Commit <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">(</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> I5 HRun 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"signalsResp <span class="skolem">s</span> <span class="main">(</span>Running <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">(</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> HC <span class="keyword3"><span class="command">show</span></span> 
     <span class="quoted"><span class="quoted">"signalsResp <span class="skolem">s</span> <span class="main">(</span>Commit <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">(</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">&lt;</span> signalsResp <span class="skolem">s</span> <span class="main">(</span>Running <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">(</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement: injective agreement  (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authenticates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med01iai</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_obs <span class="main">⇒</span> a0i_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med01iai</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>a0n_state.signals <span class="main">=</span> signalsInit <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation between states.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R01iai</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a0i_state <span class="main">*</span> l1_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R01iai</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    a0n_state.signals <span class="bound">s</span> <span class="main">=</span> signalsInit <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol-independent events.›</span></span>

<span class="keyword1" id="dhlvl1-l1_learn_refines_a0_ia_skip_i"><span class="command">lemma</span></span> l1_learn_refines_a0_ia_skip_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iai<span class="main">}</span> Id<span class="main">,</span> l1_learn <span class="free">m</span> <span class="main">{&gt;</span>R01iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01iai_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_learn_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>
<span class="keyword1" id="dhlvl1-l1_step1_refines_a0i_skip_i"><span class="command">lemma</span></span> l1_step1_refines_a0i_skip_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iai<span class="main">}</span> Id<span class="main">,</span> l1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R01iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01iai_def l1_step1_def<span class="main">)</span>


<span class="keyword1" id="dhlvl1-l1_step2_refines_a0i_running_skip_i"><span class="command">lemma</span></span> l1_step2_refines_a0i_running_skip_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iai<span class="main">}</span> a0i_running <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> Id<span class="main">,</span> l1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R01iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01iai_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step2_def a0i_running_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="dhlvl1-l1_step3_refines_a0i_commit_skip_i"><span class="command">lemma</span></span> l1_step3_refines_a0i_commit_skip_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iai <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> l1_inv3<span class="main">)</span><span class="main">}</span> 
     a0i_commit <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> Id<span class="main">,</span> 
     l1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span> 
   <span class="main">{&gt;</span>R01iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01iai_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step3_def a0i_commit_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv3E<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl1-l1_step4_refines_a0i_skip_i"><span class="command">lemma</span></span> l1_step4_refines_a0i_skip_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iai<span class="main">}</span> Id<span class="main">,</span> l1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R01iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01iai_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step4_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_trans_refines_a0i_trans_i <span class="main">=</span> 
  l1_learn_refines_a0_ia_skip_i
  l1_step1_refines_a0i_skip_i l1_step2_refines_a0i_running_skip_i
  l1_step3_refines_a0i_commit_skip_i l1_step4_refines_a0i_skip_i

<span class="keyword1" id="dhlvl1-l1_refines_init_a0i_i"><span class="command">lemma</span></span> l1_refines_init_a0i_i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> R01iai <span class="main">``</span> <span class="main">(</span>init a0i<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R01iai_def a0i_defs l1_defs<span class="main">)</span>


<span class="keyword1" id="dhlvl1-l1_refines_trans_a0i_i"><span class="command">lemma</span></span> l1_refines_trans_a0i_i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iai <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l1_inv1 <span class="main">∩</span> l1_inv2<span class="main">)</span><span class="main">)</span><span class="main">}</span> trans a0i<span class="main">,</span> trans l1 <span class="main">{&gt;</span> R01iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pre'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"R01iai <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> l1_inv3<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span><span class="var">?post</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conseq_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pre</span> <span class="main">⊆</span> <span class="var">?pre'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l1_inv3_derived <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre'</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span> <span class="var">?post</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0i_def l1_def a0i_trans_def l1_trans_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> l1_step2_refines_a0i_running_skip_i <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> l1_step3_refines_a0i_commit_skip_i <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l1_trans_refines_a0i_trans_i<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="dhlvl1-obs_consistent_med01iai"><span class="command">lemma</span></span> obs_consistent_med01iai <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R01iai med01iai a0i l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R01iai_def med01iai_def<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>
<span class="keyword1" id="dhlvl1-l1_refines_a0i_i"><span class="command">lemma</span></span> l1_refines_a0i_i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R01iai <span class="main">∩</span> <span class="main">(</span>reach a0i <span class="main">×</span> <span class="main">(</span>l1_inv1 <span class="main">∩</span> l1_inv2<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med01iai a0i l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="dhlvl1-l1_implements_a0i_i"><span class="command">lemma</span></span>  l1_implements_a0i_i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med01iai a0i l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants: injective agreement (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authenticates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l1_iagreement_Init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_iagreement_Init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span><span class="main">.</span> 
     signalsInit <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span><span class="main">)</span> <span class="main">≤</span> signalsInit <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_iagreement_InitI <span class="main">=</span> l1_iagreement_Init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_iagreement_InitE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_iagreement_Init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1" id="dhlvl1-l1_obs_iagreement_Init"><span class="command">lemma</span></span> l1_obs_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l1 <span class="main">⊆</span> l1_iagreement_Init"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_a0i_obs_agreement _ l1_implements_a0i_i<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med01iai_def l1_iagreement_Init_def a0i_agreement_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl1-l1_iagreement_Init"><span class="command">lemma</span></span> l1_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_iagreement_Init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_iagreement_Init<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement: injective agreement  (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authenticates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med01iar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l1_obs <span class="main">⇒</span> a0i_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med01iar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>a0n_state.signals <span class="main">=</span> signalsResp <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation between states.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R01iar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a0i_state <span class="main">*</span> l1_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R01iar</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    a0n_state.signals <span class="bound">s</span> <span class="main">=</span> signalsResp <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol-independent events.›</span></span>

<span class="keyword1" id="dhlvl1-l1_learn_refines_a0_ia_skip_r"><span class="command">lemma</span></span> l1_learn_refines_a0_ia_skip_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iar<span class="main">}</span> Id<span class="main">,</span> l1_learn <span class="free">m</span> <span class="main">{&gt;</span>R01iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01iar_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_learn_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>
<span class="keyword1" id="dhlvl1-l1_step1_refines_a0i_skip_r"><span class="command">lemma</span></span> l1_step1_refines_a0i_skip_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iar<span class="main">}</span> Id<span class="main">,</span> l1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R01iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01iar_def l1_step1_def<span class="main">)</span>


<span class="keyword1" id="dhlvl1-l1_step2_refines_a0i_skip_r"><span class="command">lemma</span></span> l1_step2_refines_a0i_skip_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iar<span class="main">}</span> Id<span class="main">,</span> l1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R01iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01iar_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>l1_step2_def<span class="main">)</span>

<span class="keyword1" id="dhlvl1-l1_step3_refines_a0i_running_skip_r"><span class="command">lemma</span></span> l1_step3_refines_a0i_running_skip_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iar<span class="main">}</span> a0i_running <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> Id<span class="main">,</span> l1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span> <span class="main">{&gt;</span>R01iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01iar_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step3_def a0i_running_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="dhlvl1-l1_step4_refines_a0i_commit_skip_r"><span class="command">lemma</span></span> l1_step4_refines_a0i_commit_skip_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iar <span class="main">∩</span> UNIV<span class="main">×</span>l1_inv6<span class="main">}</span> 
     a0i_commit <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> Id<span class="main">,</span> 
     l1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> 
   <span class="main">{&gt;</span>R01iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01iar_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step4_def a0i_commit_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l1_inv6D <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proofs.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_trans_refines_a0i_trans_r <span class="main">=</span> 
  l1_learn_refines_a0_ia_skip_r
  l1_step1_refines_a0i_skip_r l1_step2_refines_a0i_skip_r
  l1_step3_refines_a0i_running_skip_r l1_step4_refines_a0i_commit_skip_r

<span class="keyword1" id="dhlvl1-l1_refines_init_a0i_r"><span class="command">lemma</span></span> l1_refines_init_a0i_r <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l1 <span class="main">⊆</span> R01iar <span class="main">``</span> <span class="main">(</span>init a0i<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R01iar_def a0i_defs l1_defs<span class="main">)</span>


<span class="keyword1" id="dhlvl1-l1_refines_trans_a0i_r"><span class="command">lemma</span></span> l1_refines_trans_a0i_r <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01iar <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l1_inv4 <span class="main">∩</span> l1_inv5<span class="main">)</span><span class="main">)</span><span class="main">}</span> trans a0i<span class="main">,</span> trans l1 <span class="main">{&gt;</span> R01iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pre'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"R01iar <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> l1_inv6<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span><span class="var">?post</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conseq_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pre</span> <span class="main">⊆</span> <span class="var">?pre'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l1_inv6_derived <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre'</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span> <span class="var">?post</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0i_def l1_def a0i_trans_def l1_trans_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command">using</span></span> l1_step3_refines_a0i_running_skip_r <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command">using</span></span> l1_step4_refines_a0i_commit_skip_r <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l1_trans_refines_a0i_trans_r<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="dhlvl1-obs_consistent_med01iar"><span class="command">lemma</span></span> obs_consistent_med01iar <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R01iar med01iar a0i l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R01iar_def med01iar_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1" id="dhlvl1-l1_refines_a0i_r"><span class="command">lemma</span></span> l1_refines_a0i_r <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R01iar <span class="main">∩</span> <span class="main">(</span>reach a0i <span class="main">×</span> <span class="main">(</span>l1_inv4 <span class="main">∩</span> l1_inv5<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med01iar a0i l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="dhlvl1-l1_implements_a0i_r"><span class="command">lemma</span></span>  l1_implements_a0i_r <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med01iar a0i l1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants: injective agreement (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authenticates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l1_iagreement_Resp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l1_iagreement_Resp</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span><span class="main">.</span> 
     signalsResp <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span><span class="main">)</span> <span class="main">≤</span> signalsResp <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l1_iagreement_RespI <span class="main">=</span> l1_iagreement_Resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l1_iagreement_RespE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l1_iagreement_Resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1" id="dhlvl1-l1_obs_iagreement_Resp"><span class="command">lemma</span></span> l1_obs_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l1 <span class="main">⊆</span> l1_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_a0i_obs_agreement _ l1_implements_a0i_r<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med01iar_def l1_iagreement_Resp_def a0i_agreement_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl1-l1_iagreement_Resp"><span class="command">lemma</span></span> l1_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l1 <span class="main">⊆</span> l1_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_iagreement_Resp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="dhlvl2">
<div class="head">
<h1>Theory dhlvl2</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  dhlvl2.thy (Isabelle/HOL 2016-1)
  ID:      $Id: dhlvl2.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-2 Diffie-Hellman channel protocol using authenticated channels.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Authenticated Diffie-Hellman Protocol (L2)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> dhlvl2
<span class="keyword2"><span class="keyword">imports</span></span> <a href="dhlvl1.html">dhlvl1</a> <a href="Channels.html">Channels</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and Events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initial compromise.›</span></span>
<span class="keyword1"><span class="command">consts</span></span>
  bad_init <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span> 

<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">bad_init</span><span class="main">)</span>
  bad_init_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"test_owner <span class="main">∉</span> bad_init <span class="main">∧</span> test_partner <span class="main">∉</span> bad_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Level 2 state.›</span></span>

<span class="keyword1"><span class="command">record</span></span> l2_state <span class="main">=</span> 
  <span class="quoted">l1_state</span> <span class="main">+</span>
  chan <span class="main">::</span> <span class="quoted"><span class="quoted">"chan set"</span></span>
  bad <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> l2_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"l2_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l2_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l2_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l2_state <span class="main">×</span> l2_state<span class="main">)</span> set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Attacker events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_dy_fake_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_dy_fake_msg</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∈</span> dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_dy_fake_chan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chan <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_dy_fake_chan</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> dy_fake_chan <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>chan <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">}</span> <span class="main">∪</span> chan <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Partnering.›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">role_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> role_t"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">role_comp</span> Init <span class="main">=</span> Resp"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">role_comp</span> Resp <span class="main">=</span> Init"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">matching</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"frame <span class="main">⇒</span> frame <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">matching</span> <span class="free"><span class="bound"><span class="entity">sigma</span></span></span> <span class="free"><span class="bound"><span class="entity">sigma'</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">sigma</span></span></span> <span class="main">∩</span> dom <span class="free"><span class="bound"><span class="entity">sigma'</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">sigma</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sigma'</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partner_runs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> rid_t <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partner_runs</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">R'</span></span></span> <span class="main">≡</span> 
    role <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">=</span> role_comp <span class="main">(</span>role <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    owner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">=</span> partner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span> <span class="main">∧</span>
    owner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span> <span class="main">=</span> partner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">∧</span>
    matching <span class="main">(</span>guessed_frame <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span>guessed_frame <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span>
  "</span></span>

<span class="keyword1" id="dhlvl2-role_comp_inv"><span class="command">lemma</span></span> role_comp_inv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"role_comp <span class="main">(</span>role_comp <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="dhlvl2-role_comp_inv_eq"><span class="command">lemma</span></span> role_comp_inv_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> role_comp <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> role_comp <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> role_comp.elims <span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partners</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partners</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">R</span><span class="main">.</span> partner_runs test <span class="bound">R</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="dhlvl2-test_not_partner"><span class="command">lemma</span></span> test_not_partner <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"test <span class="main">∉</span> partners"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partners_def partner_runs_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs test<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="dhlvl2-matching_symmetric"><span class="command">lemma</span></span> matching_symmetric<span class="main">:</span>
  <span class="quoted"><span class="quoted">"matching <span class="free">sigma</span> <span class="free">sigma'</span> <span class="main">⟹</span> matching <span class="free">sigma'</span> <span class="free">sigma</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>

<span class="keyword1" id="dhlvl2-partner_symmetric"><span class="command">lemma</span></span> partner_symmetric<span class="main">:</span>
  <span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R'</span> <span class="main">⟹</span> partner_runs <span class="free">R'</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def matching_symmetric<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The unicity of the parther is actually protocol dependent:
it only holds if there are generated fresh nonces (which identify the runs) in the frames.›</span></span>

<span class="keyword1" id="dhlvl2-partner_unique"><span class="command">lemma</span></span> partner_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R''</span> <span class="main">⟹</span> partner_runs <span class="free">R</span> <span class="free">R'</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="main">=</span> <span class="free">R''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span><span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Hm'<span class="main">:</span> <span class="quoted"><span class="quoted">"matching <span class="main">(</span>guessed_frame <span class="free">R</span><span class="main">)</span> <span class="main">(</span>guessed_frame <span class="free">R'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> H''<span class="main">:</span><span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R''</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Hm''<span class="main">:</span> <span class="quoted"><span class="quoted">"matching <span class="main">(</span>guessed_frame <span class="free">R</span><span class="main">)</span> <span class="main">(</span>guessed_frame <span class="free">R''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R'</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Init
      <span class="keyword1"><span class="command">with</span></span> H' partner_symmetric <span class="main">[</span><span class="operator">OF</span> H''<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> Hrole<span class="main">:</span><span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Resp"</span></span>
                                                    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R''</span><span class="main">)</span> <span class="main">=</span> Init"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Init Hm' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R'</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Hrole Hm'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R''</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Gen_inj<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Resp
      <span class="keyword1"><span class="command">with</span></span> H' partner_symmetric <span class="main">[</span><span class="operator">OF</span> H''<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> Hrole<span class="main">:</span><span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init"</span></span>
                                                    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R''</span><span class="main">)</span> <span class="main">=</span> Resp"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Resp Hm' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R'</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Hrole Hm'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R''</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Gen_inj<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="dhlvl2-partner_test"><span class="command">lemma</span></span> partner_test<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> partners <span class="main">⟹</span> partner_runs <span class="free">R</span> <span class="free">R'</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="main">=</span> test"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>partner_unique <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>partners_def partner_symmetric<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Compromising events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_lkr_others</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_lkr_others</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_lkr_actor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_lkr_actor</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_lkr_after</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_lkr_after</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    test_ended <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_skr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_skr</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≠</span> test <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∉</span> partners <span class="main">∧</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> xsk <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">R</span></span></span> xsk <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events:
\begin{itemize}
  \item step 1: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
    computes and insecurely sends $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  \item step 2: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ insecurely,
    generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
    authentically sends $(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)$,
    computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
    emits a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  \item step 3: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
    authentically,
    sends $(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)$ authentically,
    computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$, emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
    $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$, a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
    declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  \item step 4: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
    authentically,
    emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
    declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
    <span class="entity">l2_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">}</span><span class="main">)</span><span class="main">,</span>
      chan <span class="main">:=</span> <span class="main">{</span>Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xgny<span class="main">,</span> xgnx<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            chan <span class="main">:=</span> <span class="main">{</span>Auth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span><span class="main">⟩</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                          addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                          signalsInit <span class="bound">s</span>
         <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>  


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xgny <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    Auth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            chan <span class="main">:=</span> <span class="main">{</span>Auth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span><span class="main">⟩</span><span class="main">}</span> <span class="main">∪</span> chan <span class="bound">s</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                         addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                         signalsInit <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                         addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                         signalsResp <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step4</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    Auth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                             addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                           <span class="keyword1">else</span>
                             signalsResp <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specification.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
    ik <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    secret <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    progress <span class="main">=</span> Map.empty<span class="main">,</span>
    signalsInit <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsResp <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    chan <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    bad <span class="main">=</span> bad_init
    <span class="main">⦈</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span> <span class="bound">M</span> <span class="bound">X</span> <span class="bound">Rb</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">K</span><span class="main">.</span>
     l2_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     l2_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">X</span> <span class="main">∪</span>
     l2_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">X</span> <span class="main">∪</span>
     l2_step4 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">X</span> <span class="main">∪</span>
     l2_dy_fake_chan <span class="bound">M</span> <span class="main">∪</span>
     l2_dy_fake_msg <span class="bound">m</span> <span class="main">∪</span>
     l2_lkr_others <span class="bound">A</span> <span class="main">∪</span>
     l2_lkr_after <span class="bound">A</span> <span class="main">∪</span>
     l2_skr <span class="bound">Ra</span> <span class="bound">K</span> <span class="main">∪</span>
     Id 
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l2_state<span class="main">,</span> l2_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> l2_init<span class="main">,</span>
    trans <span class="main">=</span> l2_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_loc_defs <span class="main">=</span> 
  l2_step1_def l2_step2_def l2_step3_def l2_step4_def
  l2_def l2_init_def l2_trans_def
  l2_dy_fake_chan_def l2_dy_fake_msg_def
  l2_lkr_after_def l2_lkr_others_def l2_skr_def

<span class="keyword1"><span class="command">lemmas</span></span> l2_defs <span class="main">=</span> l2_loc_defs ik_dy_def

<span class="keyword1"><span class="command">lemmas</span></span> l2_nostep_defs <span class="main">=</span> l2_def l2_init_def l2_trans_def


<span class="keyword1" id="dhlvl2-l2_obs_id"><span class="command">lemma</span></span> l2_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs l2 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once a run is finished, it stays finished, therefore if the test is not finished at some
point then it was not finished before either.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
<span class="keyword1" id="dhlvl2-l2_run_ended_trans"><span class="command">lemma</span></span> l2_run_ended_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_ended <span class="main">(</span>progress <span class="free">s</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2 <span class="main">⟹</span>
   run_ended <span class="main">(</span>progress <span class="free">s'</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="dhlvl2-l2_can_signal_trans"><span class="command">lemma</span></span> l2_can_signal_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"can_signal <span class="free">s'</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2 <span class="main">⟹</span>
  can_signal <span class="free">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def l2_run_ended_trans<span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">A</span></span> <span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
(i.e., <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are the test session agents and the test is not finished),
then A and B are honest.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv1</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
    <span class="bound">A</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv1I <span class="main">=</span> l2_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv1D <span class="main">=</span> l2_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl2-l2_inv1_init"><span class="command">lemma</span></span> l2_inv1_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv1_def can_signal_def bad_init_spec<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv1_trans"><span class="command">lemma</span></span> l2_inv1_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv1<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv1I  <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">l2_state</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
  <span class="keyword3"><span class="command">assume</span></span> HI<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span>  
  <span class="keyword3"><span class="command">assume</span></span> HT<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s'</span> <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> HT <span class="keyword1"><span class="command">have</span></span> HS<span class="main">:</span><span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_can_signal_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> HI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> bad <span class="skolem">s</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">∉</span> bad <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> HS HT <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> bad <span class="skolem">s'</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">∉</span> bad <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs can_signal_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="dhlvl2-PO_l2_inv1"><span class="command">lemma</span></span> PO_l2_inv1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2 (authentication guard)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Auth <span class="free"><span class="free">B</span></span> <span class="free"><span class="free">A</span></span> <span class="main"><span class="main">⟨</span></span>Number <span class="main"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">gny</span></span><span class="main"><span class="main">,</span></span> Exp Gen <span class="main"><span class="main">(</span></span>NonceF <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Ra</span></span><span class="main"><span class="main">$</span></span>nx<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main">∈</span></span> chan <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are honest then the message has indeed been sent by a responder run (etc).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gny</span><span class="main">.</span>
    Auth <span class="bound">B</span> <span class="bound">A</span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="bound">gny</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="bound">s</span>  <span class="main">⟶</span>
    <span class="bound">A</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">Rb</span><span class="main">.</span> guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">∧</span>
           in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
           <span class="bound">gny</span> <span class="main">=</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
           guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv2I <span class="main">=</span> l2_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv2D <span class="main">=</span> l2_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl2-l2_inv2_init"><span class="command">lemma</span></span> l2_inv2_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv2_def<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv2_trans"><span class="command">lemma</span></span> l2_inv2_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv2<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-PO_l2_inv2"><span class="command">lemma</span></span> PO_l2_inv2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3 (authentication guard)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Auth A B ⟨Number 1, gnx, Exp Gen (NonceF (Rb$ny))⟩ ∈ chan s›</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are honest
  then the message has indeed been sent by an initiator run (etc).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gnx</span><span class="main">.</span>
     Auth <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> <span class="bound">gnx</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span> <span class="bound">Ra</span><span class="main">.</span> guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">∧</span>
              in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
              guessed_frame <span class="bound">Ra</span> xgnx <span class="main">=</span> Some <span class="bound">gnx</span> <span class="main">∧</span>
              guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3I <span class="main">=</span> l2_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3D <span class="main">=</span> l2_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl2-l2_inv3_init"><span class="command">lemma</span></span> l2_inv3_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv3_def<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv3_trans"><span class="command">lemma</span></span> l2_inv3_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff insert_ident<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-PO_l2_inv3"><span class="command">lemma</span></span> PO_l2_inv3 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For an initiator, the session key is always <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>gny^nx›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv4</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gny</span><span class="main">.</span>
    guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> xsk <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="bound">gny</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4I <span class="main">=</span> l2_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4D <span class="main">=</span> l2_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl2-l2_inv4_init"><span class="command">lemma</span></span> l2_inv4_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv4_def<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv4_trans"><span class="command">lemma</span></span> l2_inv4_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv4<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-PO_l2_inv4"><span class="command">lemma</span></span> PO_l2_inv4 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4'›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For a responder, the session key is always <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>gnx^ny›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv4'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv4'</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gnx</span><span class="main">.</span>
    guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Rb</span><span class="main">)</span> xsk <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="bound">gnx</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4'I <span class="main">=</span> l2_inv4'_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4'E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv4'_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4'D <span class="main">=</span> l2_inv4'_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl2-l2_inv4'_init"><span class="command">lemma</span></span> l2_inv4'_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv4'"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv4'_def<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv4'_trans"><span class="command">lemma</span></span> l2_inv4'_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv4'<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv4'<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv4'I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-PO_l2_inv4'"><span class="command">lemma</span></span> PO_l2_inv4' <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv4'"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The only confidential or secure messages on the channel have been put there
  by the attacker.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv5</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span>
    <span class="main">(</span>Confid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∨</span> Secure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> 
    <span class="bound">M</span> <span class="main">∈</span> dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv5I <span class="main">=</span> l2_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv5E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv5D <span class="main">=</span> l2_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl2-l2_inv5_init"><span class="command">lemma</span></span> l2_inv5_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv5_def<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv5_trans"><span class="command">lemma</span></span> l2_inv5_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv5<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv5I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l2_inv5D dy_fake_msg_monotone<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-PO_l2_inv5"><span class="command">lemma</span></span> PO_l2_inv5 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For a run <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (with any role), the session key always has the form
$something^n$ where $n$ is a nonce generated by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv6</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">R</span><span class="main">.</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">R</span><span class="main">)</span> xsk <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">X</span> <span class="bound">N</span><span class="main">.</span>
      guessed_frame <span class="bound">R</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">X</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R</span><span class="main">$</span><span class="bound">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6I <span class="main">=</span> l2_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6D <span class="main">=</span> l2_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl2-l2_inv6_init"><span class="command">lemma</span></span> l2_inv6_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv6"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv6_def<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv6_trans"><span class="command">lemma</span></span> l2_inv6_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv6<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv6<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv6I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv6D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-PO_l2_inv6"><span class="command">lemma</span></span> PO_l2_inv6 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv6"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Form of the messages in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"extr <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> =
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span><span class="free"><span class="free">generators</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generators</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp Gen <span class="main">(</span>Nonce <span class="bound">N</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> 
                <span class="main">{</span>Exp <span class="bound">y</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R</span><span class="main">$</span><span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">N</span> <span class="bound">R</span><span class="main">.</span> <span class="bound">R</span> <span class="main">≠</span> test <span class="main">∧</span> <span class="bound">R</span> <span class="main">∉</span> partners<span class="main">}</span>"</span></span>

<span class="keyword1" id="dhlvl2-analz_generators"><span class="command">lemma</span></span> analz_generators<span class="main">:</span> <span class="quoted"><span class="quoted">"analz generators <span class="main">=</span> generators"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv7</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> 
    extr <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> 
      synth <span class="main">(</span>analz <span class="main">(</span>generators<span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7I <span class="main">=</span> l2_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7D <span class="main">=</span> l2_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl2-l2_inv7_init"><span class="command">lemma</span></span> l2_inv7_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv7"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv7_def<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv7_step1"><span class="command">lemma</span></span> l2_inv7_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7<span class="main">}</span> l2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-l2_inv7_step2"><span class="command">lemma</span></span> l2_inv7_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7<span class="main">}</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-l2_inv7_step3"><span class="command">lemma</span></span> l2_inv7_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7<span class="main">}</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>l2_inv7D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>extr_Chan<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-l2_inv7_step4"><span class="command">lemma</span></span> l2_inv7_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7<span class="main">}</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv7_dy_fake_msg"><span class="command">lemma</span></span> l2_inv7_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7<span class="main">}</span> l2_dy_fake_msg <span class="free">M</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs extr_insert_IK_eq 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7E dy_fake_msg_extr <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv7_dy_fake_chan"><span class="command">lemma</span></span> l2_inv7_dy_fake_chan<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7<span class="main">}</span> l2_dy_fake_chan <span class="free">M</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I 
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  dy_fake_chan_extr_insert <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7E dy_fake_msg_extr <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv7_lkr_others"><span class="command">lemma</span></span> l2_inv7_lkr_others<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv5<span class="main">}</span> l2_lkr_others <span class="free">A</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> extr_insert_bad <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7E l2_inv5E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dy_fake_msg_extr <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-l2_inv7_lkr_after"><span class="command">lemma</span></span> l2_inv7_lkr_after<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv5<span class="main">}</span> l2_lkr_after <span class="free">A</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> extr_insert_bad <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7E l2_inv5E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dy_fake_msg_extr <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 
<span class="keyword1" id="dhlvl2-l2_inv7_skr"><span class="command">lemma</span></span> l2_inv7_skr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv6<span class="main">}</span> l2_skr <span class="free">R</span> <span class="free">K</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extr_insert_IK_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv6D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7_trans_aux <span class="main">=</span>
  l2_inv7_step1 l2_inv7_step2 l2_inv7_step3 l2_inv7_step4
  l2_inv7_dy_fake_msg l2_inv7_dy_fake_chan
  l2_inv7_lkr_others l2_inv7_lkr_after l2_inv7_skr

<span class="keyword1" id="dhlvl2-l2_inv7_trans"><span class="command">lemma</span></span> l2_inv7_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv5 <span class="main">∩</span> l2_inv6<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>l2_inv7_trans_aux<span class="main">)</span>

<span class="keyword1" id="dhlvl2-PO_l2_inv7"><span class="command">lemma</span></span> PO_l2_inv7 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv7"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l2_inv5 <span class="main">∩</span> l2_inv6"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary dest rule for inv7.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7D_aux <span class="main">=</span> 
  l2_inv7D <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> subset_trans<span class="main">,</span> <span class="operator">THEN</span> synth_analz_mono<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> 
            <span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">OF</span> IK_subset_extr<span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv8: form of the secrets›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv8</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv8</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    secret <span class="bound">s</span> <span class="main">⊆</span> <span class="main">{</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R</span><span class="main">$</span><span class="bound">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R'</span><span class="main">$</span><span class="bound">N'</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">N</span> <span class="bound">N'</span> <span class="bound">R</span> <span class="bound">R'</span><span class="main">.</span>
                  <span class="bound">R</span> <span class="main">=</span> test <span class="main">∧</span> <span class="bound">R'</span> <span class="main">∈</span> partners<span class="main">}</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv8I <span class="main">=</span> l2_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv8E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv8D <span class="main">=</span> l2_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="dhlvl2-l2_inv8_init"><span class="command">lemma</span></span> l2_inv8_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv8"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv8_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Steps 3 and 4 are the hard part.›</span></span>

<span class="keyword1" id="dhlvl2-l2_inv8_step3"><span class="command">lemma</span></span> l2_inv8_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv8 <span class="main">∩</span> l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv4'<span class="main">}</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span> <span class="main">{&gt;</span> l2_inv8<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv8I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="main">::</span> <span class="quoted">l2_state</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv8"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv2"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv4'"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Ht<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Hs Ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s</span> <span class="main">∨</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">=</span> test <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi Ht 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span> <span class="bound">N'</span> <span class="bound">R'</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R'</span> <span class="main">$</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">R'</span> <span class="main">∈</span> partners"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv8D <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> Hx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Hi <span class="keyword1"><span class="command">have</span></span> HA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad <span class="skolem">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">∉</span> bad <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">assume</span></span> Htest<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_runs test <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Init<span class="main">,</span> owner <span class="main">=</span> <span class="free">A</span><span class="main">,</span> partner <span class="main">=</span> <span class="free">B</span><span class="main">⦈</span>"</span></span>
                    <span class="quoted"><span class="quoted">"guessed_frame test xgny <span class="main">=</span> Some <span class="free">gny</span>"</span></span>
                    <span class="quoted"><span class="quoted">"guessed_frame test xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Auth <span class="free">B</span> <span class="free">A</span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="free">gny</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Hi HA <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Rb</span></span> <span class="keyword2"><span class="keyword">where</span></span> HRb<span class="main">:</span>
        <span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free">B</span><span class="main">,</span> partner<span class="main">=</span><span class="free">A</span><span class="main">⦈</span>"</span></span>
        <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="skolem">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">gny</span> <span class="main">=</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv2D<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Hi 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Rb</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv4'D<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> HRb Htest <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Rb</span> <span class="main">∈</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partners_def partner_runs_def matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> HRb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                        Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">Rb</span> <span class="main">∈</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span> <span class="bound">N'</span> <span class="bound">R'</span><span class="main">.</span>
          Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span> <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R'</span> <span class="main">$</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          <span class="bound">R'</span> <span class="main">∈</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="dhlvl2-l2_inv8_step4"><span class="command">lemma</span></span> l2_inv8_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv8 <span class="main">∩</span> l2_inv1 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv4'<span class="main">}</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> <span class="main">{&gt;</span> l2_inv8<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv8I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="main">::</span> <span class="quoted">l2_state</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv8"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv3"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv4"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv4'"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Ht<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Hs Ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s</span> <span class="main">∨</span> <span class="main">(</span><span class="free">Rb</span> <span class="main">=</span> test <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi Ht 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span> <span class="bound">N'</span> <span class="bound">R'</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R'</span> <span class="main">$</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">R'</span> <span class="main">∈</span> partners"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv8D <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> Hx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Hi <span class="keyword1"><span class="command">have</span></span> HA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad <span class="skolem">s</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">∉</span> bad <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">assume</span></span> Htest<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_runs test <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Resp<span class="main">,</span> owner <span class="main">=</span> <span class="free">B</span><span class="main">,</span> partner <span class="main">=</span> <span class="free">A</span><span class="main">⦈</span>"</span></span>
                    <span class="quoted"><span class="quoted">"guessed_frame test xgnx <span class="main">=</span> Some <span class="free">gnx</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"progress <span class="skolem">s</span> test <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Htest Hi <span class="keyword1"><span class="command">have</span></span> Htest'<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_frame test xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv4'D<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Auth <span class="free">A</span> <span class="free">B</span> <span class="main">⟨</span>Number <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">gnx</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Hi HA <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ra</span></span> <span class="keyword2"><span class="keyword">where</span></span> HRa<span class="main">:</span>
        <span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free">A</span><span class="main">,</span> partner<span class="main">=</span><span class="free">B</span><span class="main">⦈</span>"</span></span>
        <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="skolem">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">gnx</span> <span class="main">=</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Hi 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv4D<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> HRa Htest Htest' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ra</span> <span class="main">∈</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partners_def partner_runs_def matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> HRa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                        Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">Ra</span> <span class="main">∈</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span> <span class="bound">N'</span> <span class="bound">R'</span><span class="main">.</span>
          Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span> <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R'</span> <span class="main">$</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          <span class="bound">R'</span> <span class="main">∈</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="dhlvl2-l2_inv8_trans"><span class="command">lemma</span></span> l2_inv8_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv8 <span class="main">∩</span> l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv4'<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv8<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv8_step3 l2_inv8_step4<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv8I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv8D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-PO_l2_inv8"><span class="command">lemma</span></span> PO_l2_inv8 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv8"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv4'"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary destruction rule for inv8.›</span></span>

<span class="keyword1" id="dhlvl2-Exp_Exp_Gen_synth"><span class="command">lemma</span></span> Exp_Exp_Gen_synth<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Exp <span class="main">(</span>Exp Gen <span class="free">X</span><span class="main">)</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="free">H</span> <span class="main">⟹</span> Exp <span class="main">(</span>Exp Gen <span class="free">X</span><span class="main">)</span> <span class="free">Y</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="free">H</span> <span class="main">∨</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_inj2<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_inv8_aux"><span class="command">lemma</span></span> l2_inv8_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv8 <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> secret <span class="free">s</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∉</span> synth <span class="main">(</span>analz generators<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_generators <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv8D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_synth Exp_Exp_Gen_inj2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med12s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_obs <span class="main">⇒</span> l1_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med12s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    ik <span class="main">=</span> ik <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    secret <span class="main">=</span> secret <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    progress <span class="main">=</span> progress <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsInit <span class="main">=</span> signalsInit <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsResp <span class="main">=</span> signalsResp <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation between states.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R12s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l1_state <span class="main">*</span> l2_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R12s</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">s</span> <span class="main">=</span> med12s <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R12s_defs <span class="main">=</span> R12s_def med12s_def


<span class="keyword1" id="dhlvl2-can_signal_R12"><span class="command">lemma</span></span> can_signal_R12 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span> <span class="main">∈</span> R12s <span class="main">⟹</span>
   can_signal <span class="free">s1</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> can_signal <span class="free">s2</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def R12s_defs<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1" id="dhlvl2-l2_step1_refines_step1"><span class="command">lemma</span></span> l2_step1_refines_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> l1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">,</span> l2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l1_step1_def l2_step1_def<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_step2_refines_step2"><span class="command">lemma</span></span> l2_step2_refines_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> l1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span><span class="main">,</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l1_step2_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_step2_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For step3 and 4, we prove the level 1 guard, i.e.,
"the future session key is not in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>"
  using the fact that inv8 also holds for the future state in which the session key is already in 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"secret <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="dhlvl2-l2_step3_refines_step3"><span class="command">lemma</span></span> l2_step3_refines_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv4' <span class="main">∩</span> l2_inv7 <span class="main">∩</span> l2_inv8<span class="main">)</span><span class="main">}</span> 
      l1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span><span class="main">,</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span> 
   <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv2"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv4'"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> Ht<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv8"</span></span>
  <span class="keyword1"><span class="command">with</span></span> Hi Ht l2_inv8_step3 <span class="keyword1"><span class="command">have</span></span> Hi'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> l2_inv8"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ra</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> secret <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ra</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz generators<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv8_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi <span class="keyword1"><span class="command">have</span></span> G2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Ra</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7D_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ht Hi <span class="keyword1"><span class="command">have</span></span> G1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Rb</span><span class="main">.</span> guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free">B</span><span class="main">,</span> partner<span class="main">=</span><span class="free">A</span><span class="main">⦈</span> <span class="main">∧</span>
           in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
           <span class="free">gny</span> <span class="main">=</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
           guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv2D <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 2<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> Ht G1 G2 <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦇</span> ik <span class="main">=</span> ik <span class="skolem">s</span><span class="main">,</span> secret <span class="main">=</span> secret <span class="skolem">s</span><span class="main">,</span> progress <span class="main">=</span> progress <span class="skolem">s</span><span class="main">,</span> 
        signalsInit <span class="main">=</span> signalsInit <span class="skolem">s</span><span class="main">,</span> signalsResp <span class="main">=</span> signalsResp <span class="skolem">s</span> <span class="main">⦈</span><span class="main">,</span>
      <span class="main">⦇</span> ik <span class="main">=</span> ik <span class="skolem">s'</span><span class="main">,</span> secret <span class="main">=</span> secret <span class="skolem">s'</span><span class="main">,</span> progress <span class="main">=</span> progress <span class="skolem">s'</span><span class="main">,</span> 
        signalsInit <span class="main">=</span> signalsInit <span class="skolem">s'</span><span class="main">,</span> signalsResp <span class="main">=</span> signalsResp <span class="skolem">s'</span> <span class="main">⦈</span><span class="main">)</span>
           <span class="main">∈</span> l1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_step3_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step3_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="dhlvl2-l2_step4_refines_step4"><span class="command">lemma</span></span> l2_step4_refines_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv4' <span class="main">∩</span> l2_inv7 <span class="main">∩</span> l2_inv8<span class="main">)</span><span class="main">}</span> 
      l1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span><span class="main">,</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span>
   <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv3"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv4"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv4'"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> Ht<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv8"</span></span>
  <span class="keyword1"><span class="command">with</span></span> Hi Ht l2_inv8_step4 <span class="keyword1"><span class="command">have</span></span> Hi'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> l2_inv8"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rb</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> secret <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rb</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz generators<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv8_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi <span class="keyword1"><span class="command">have</span></span> G2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Rb</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7D_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ht Hi <span class="keyword1"><span class="command">have</span></span> G1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Ra</span><span class="main">.</span> guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free">A</span><span class="main">,</span> partner<span class="main">=</span><span class="free">B</span><span class="main">⦈</span> <span class="main">∧</span>
              in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
              guessed_frame <span class="bound">Ra</span> xgnx <span class="main">=</span> Some <span class="free">gnx</span> <span class="main">∧</span>
              guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 2<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> Ht G1 G2 <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦇</span> ik <span class="main">=</span> ik <span class="skolem">s</span><span class="main">,</span> secret <span class="main">=</span> secret <span class="skolem">s</span><span class="main">,</span> progress <span class="main">=</span> progress <span class="skolem">s</span><span class="main">,</span> 
        signalsInit <span class="main">=</span> signalsInit <span class="skolem">s</span><span class="main">,</span> signalsResp <span class="main">=</span> signalsResp <span class="skolem">s</span> <span class="main">⦈</span><span class="main">,</span>
      <span class="main">⦇</span> ik <span class="main">=</span> ik <span class="skolem">s'</span><span class="main">,</span> secret <span class="main">=</span> secret <span class="skolem">s'</span><span class="main">,</span> progress <span class="main">=</span> progress <span class="skolem">s'</span><span class="main">,</span> 
        signalsInit <span class="main">=</span> signalsInit <span class="skolem">s'</span><span class="main">,</span> signalsResp <span class="main">=</span> signalsResp <span class="skolem">s'</span> <span class="main">⦈</span><span class="main">)</span>
           <span class="main">∈</span> l1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_step4_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_step4_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Attacker events.›</span></span>

<span class="keyword1" id="dhlvl2-l2_dy_fake_chan_refines_skip"><span class="command">lemma</span></span> l2_dy_fake_chan_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> Id<span class="main">,</span> l2_dy_fake_chan <span class="free">M</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_defs<span class="main">)</span>


<span class="keyword1" id="dhlvl2-l2_dy_fake_msg_refines_learn"><span class="command">lemma</span></span> l2_dy_fake_msg_refines_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l2_inv7 <span class="main">∩</span> l2_inv8<span class="main">)</span><span class="main">}</span> l1_learn <span class="free">m</span><span class="main">,</span> l2_dy_fake_msg <span class="free">m</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Fake_insert_dy_fake_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> l2_inv7D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv8_aux<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Compromising events.›</span></span>

<span class="keyword1" id="dhlvl2-l2_lkr_others_refines_skip"><span class="command">lemma</span></span> l2_lkr_others_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> Id<span class="main">,</span> l2_lkr_others <span class="free">A</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_lkr_after_refines_skip"><span class="command">lemma</span></span> l2_lkr_after_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> Id<span class="main">,</span> l2_lkr_after <span class="free">A</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_skr_refines_learn"><span class="command">lemma</span></span> l2_skr_refines_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> l2_inv7 <span class="main">∩</span> UNIV <span class="main">×</span> l2_inv6 <span class="main">∩</span> UNIV <span class="main">×</span> l2_inv8<span class="main">}</span> l1_learn <span class="free">K</span><span class="main">,</span> l2_skr <span class="free">R</span> <span class="free">K</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">l2_state</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv6"</span></span>
         <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∉</span> partners"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≠</span> test"</span></span> <span class="quoted"><span class="quoted">"in_progress <span class="main">(</span>progress <span class="skolem">s</span> <span class="free">R</span><span class="main">)</span> xsk"</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xsk <span class="main">=</span> Some <span class="free">K</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hx<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">K</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv8"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="skolem"><span class="skolem">R'</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Hx'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">R</span><span class="main">$</span><span class="skolem">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">R'</span><span class="main">$</span><span class="skolem">N'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                                <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> test <span class="main">∧</span> <span class="skolem">R'</span> <span class="main">∈</span> partners"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv8D subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⦇</span>ik <span class="main">:=</span> insert <span class="free">K</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span><span class="main">⦈</span> <span class="main">∈</span> l2_inv7"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hoare_apply <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_inv7_skr<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hx <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>generators<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv7D_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hx' <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_synth <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_inj2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_generators<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_trans_refines_l1_trans <span class="main">=</span> 
  l2_dy_fake_msg_refines_learn l2_dy_fake_chan_refines_skip
  l2_lkr_others_refines_skip l2_lkr_after_refines_skip l2_skr_refines_learn
  l2_step1_refines_step1 l2_step2_refines_step2 l2_step3_refines_step3 l2_step4_refines_step4

<span class="keyword1" id="dhlvl2-l2_refines_init_l1"><span class="command">lemma</span></span> l2_refines_init_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> R12s <span class="main">``</span> <span class="main">(</span>init l1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R12s_defs l1_defs l2_loc_defs<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_refines_trans_l1"><span class="command">lemma</span></span> l2_refines_trans_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv4' <span class="main">∩</span> 
                     l2_inv6 <span class="main">∩</span> l2_inv7 <span class="main">∩</span> l2_inv8<span class="main">)</span><span class="main">)</span><span class="main">}</span>
     trans l1<span class="main">,</span> trans l2
   <span class="main">{&gt;</span> R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def l2_def l1_trans_def l2_trans_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l2_trans_refines_l1_trans<span class="main">)</span> 


<span class="keyword1" id="dhlvl2-PO_obs_consistent_R12s"><span class="command">lemma</span></span> PO_obs_consistent_R12s <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R12s med12s l1 l2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R12s_def med12s_def l2_defs<span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_refines_l1"><span class="command">lemma</span></span> l2_refines_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R12s <span class="main">∩</span> 
      <span class="main">(</span>reach l1 <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv4' <span class="main">∩</span> l2_inv5 <span class="main">∩</span>
                                                  l2_inv6 <span class="main">∩</span> l2_inv7 <span class="main">∩</span> l2_inv8<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med12s l1 l2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="dhlvl2-l2_implements_l1"><span class="command">lemma</span></span> l2_implements_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med12s l1 l2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We want to prove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l2_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  but by refinement we only get <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l2_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  This is fine, since a message in
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> could be added to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ik <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l2_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> would still hold for this new state.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_partial_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l2_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_partial_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>


<span class="keyword1" id="dhlvl2-l2_obs_partial_secrecy"><span class="command">lemma</span></span> l2_obs_partial_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_partial_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_secrecy _ l2_implements_l1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med12s_def s0_secrecy_def l2_partial_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-l2_oreach_dy_fake_msg"><span class="command">lemma</span></span> l2_oreach_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> oreach l2<span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> dy_fake_msg <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span> <span class="main">⟧</span>
 <span class="main">⟹</span> <span class="free">s</span> <span class="main">⦇</span>ik <span class="main">:=</span> insert <span class="free">x</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span><span class="main">⦈</span> <span class="main">∈</span> oreach l2"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_trans_def l2_dy_fake_msg_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l2_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="dhlvl2-l2_obs_secrecy"><span class="command">lemma</span></span> l2_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>l2_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> l2_oreach_dy_fake_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> l2_obs_partial_secrecy <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_partial_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="dhlvl2-l2_secrecy"><span class="command">lemma</span></span> l2_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_secrecy<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l2_iagreement_Init</span> <span class="main">≡</span> l1_iagreement_Init"</span></span>

<span class="keyword1" id="dhlvl2-l2_obs_iagreement_Init"><span class="command">lemma</span></span> l2_obs_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_iagreement_Init"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_iagreement_Init _ l2_implements_l1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med12s_def l1_iagreement_Init_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-l2_iagreement_Init"><span class="command">lemma</span></span> l2_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_iagreement_Init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_iagreement_Init<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l2_iagreement_Resp</span> <span class="main">≡</span> l1_iagreement_Resp"</span></span>

<span class="keyword1" id="dhlvl2-l2_obs_iagreement_Resp"><span class="command">lemma</span></span> l2_obs_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_iagreement_Resp _ l2_implements_l1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med12s_def l1_iagreement_Resp_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl2-l2_iagreement_Resp"><span class="command">lemma</span></span> l2_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_iagreement_Resp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="dhlvl3">
<div class="head">
<h1>Theory dhlvl3</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  dhlvl3.thy (Isabelle/HOL 2016-1)
  ID:      $Id: dhlvl3.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-3 Diffie-Hellman protocol using generic channel implementation.
  Refines dhlvl2 based on channel assumptions.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Authenticated Diffie-Hellman Protocol (L3 locale)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> dhlvl3
<span class="keyword2"><span class="keyword">imports</span></span> <a href="dhlvl2.html">dhlvl2</a> <a href="Implem_lemmas.html">Implem_lemmas</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and Events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Level 3 state.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹(The types have to be defined outside the locale.)›</span></span>

<span class="keyword1"><span class="command">record</span></span> l3_state <span class="main">=</span> <span class="quoted">l1_state</span> <span class="main">+</span>  
  bad <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> l3_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"l3_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l3_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l3_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l3_state <span class="main">×</span> l3_state<span class="main">)</span> set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Attacker event.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_dy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_dy</span> <span class="main">≡</span> ik_dy"</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Compromise events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_lkr_others</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_lkr_others</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">,</span>
           ik <span class="main">:=</span> keys_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_lkr_actor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_lkr_actor</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">,</span>
           ik <span class="main">:=</span> keys_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_lkr_after</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_lkr_after</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    test_ended <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">,</span>
           ik <span class="main">:=</span> keys_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_skr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_skr</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≠</span> test <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∉</span> partners <span class="main">∧</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> xsk <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">R</span></span></span> xsk <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹New locale for the level 3 protocol. This locale does not add new assumptions, 
it is only used to separate the level 3 protocol from the implementation locale.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> dhlvl3 <span class="main">=</span> valid_implem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events: 
\begin{itemize}
  \item step 1: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
    computes and insecurely sends $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  \item step 2: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ insecurely,
    generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
    authentically sends $(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)$,
    computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
    emits a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  \item step 3: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
    authentically,
    sends $(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)$ authentically,
    computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$, emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
    $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$, a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
    declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  \item step 4: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
    authentically,
    emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
    declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\end{itemize}
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
    <span class="entity">l3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">}</span><span class="main">)</span><span class="main">,</span>
      ik <span class="main">:=</span> <span class="main">{</span>implInsec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span>
      <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    implInsec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xgny<span class="main">,</span> xgnx<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            ik <span class="main">:=</span> <span class="main">{</span>implAuth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span><span class="main">⟩</span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                          addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                          signalsInit <span class="bound">s</span>
         <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>  


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xgny <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    implAuth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            ik <span class="main">:=</span> <span class="main">{</span>implAuth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span><span class="main">⟩</span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                         addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                         signalsInit <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                         addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span>
                         signalsResp <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step4</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    implAuth <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                             addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                           <span class="keyword1">else</span>
                             signalsResp <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specification.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initial compromise.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ik_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ik_init</span> <span class="main">≡</span> <span class="main">{</span>priK <span class="bound">C</span> <span class="main">|</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> bad_init<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>pubK <span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> True<span class="main">}</span> <span class="main">∪</span> 
             <span class="main">{</span>shrK <span class="bound">A</span> <span class="bound">B</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> bad_init <span class="main">∨</span> <span class="bound">B</span> <span class="main">∈</span> bad_init<span class="main">}</span> <span class="main">∪</span> Tags"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ik_init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="dhlvl3-parts_ik_init"><span class="command">lemma</span></span> parts_ik_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts ik_init <span class="main">=</span> ik_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>

<span class="keyword1" id="dhlvl3-analz_ik_init"><span class="command">lemma</span></span> analz_ik_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz ik_init <span class="main">=</span> ik_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz_into_parts<span class="main">)</span>

<span class="keyword1" id="dhlvl3-abs_ik_init"><span class="command">lemma</span></span> abs_ik_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs ik_init <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> absE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-payloadSet_ik_init"><span class="command">lemma</span></span> payloadSet_ik_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ik_init <span class="main">∩</span> payload <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>

<span class="keyword1" id="dhlvl3-validSet_ik_init"><span class="command">lemma</span></span> validSet_ik_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ik_init <span class="main">∩</span> valid<span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
    ik <span class="main">=</span> ik_init<span class="main">,</span>
    secret <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    progress <span class="main">=</span> Map.empty<span class="main">,</span>
    signalsInit <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsResp <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    bad <span class="main">=</span> bad_init
    <span class="main">⦈</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_init_defs <span class="main">=</span> l3_init_def ik_init_def

<span class="keyword1"><span class="command">definition</span></span> 
<span class="entity">l3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">M</span> <span class="bound">X</span> <span class="bound">Rb</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">K</span><span class="main">.</span>
     l3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     l3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">X</span> <span class="main">∪</span>
     l3_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">X</span> <span class="main">∪</span>
     l3_step4 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">X</span> <span class="main">∪</span>
     l3_dy <span class="bound">M</span> <span class="main">∪</span>
     l3_lkr_others <span class="bound">A</span> <span class="main">∪</span>
     l3_lkr_after <span class="bound">A</span> <span class="main">∪</span>
     l3_skr <span class="bound">Ra</span> <span class="bound">K</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l3_state<span class="main">,</span> l3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> l3_init<span class="main">,</span>
    trans <span class="main">=</span> l3_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_loc_defs <span class="main">=</span> 
  l3_step1_def l3_step2_def l3_step3_def l3_step4_def
  l3_def l3_init_defs l3_trans_def
  l3_dy_def
  l3_lkr_others_def l3_lkr_after_def l3_skr_def

<span class="keyword1"><span class="command">lemmas</span></span> l3_defs <span class="main">=</span> l3_loc_defs ik_dy_def
<span class="keyword1"><span class="command">lemmas</span></span> l3_nostep_defs <span class="main">=</span> l3_def l3_init_def l3_trans_def


<span class="keyword1" id="dhlvl3-l3_obs_id"><span class="command">lemma</span></span> l3_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs l3 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def<span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: No long-term keys as message parts›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv1</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
     parts <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">∩</span> range LtK <span class="main">⊆</span> ik <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv1I <span class="main">=</span> l3_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l3_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv1D <span class="main">=</span> l3_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="dhlvl3-l3_inv1D'"><span class="command">lemma</span></span> l3_inv1D' <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> LtK <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">s</span> <span class="main">∈</span> l3_inv1<span class="main">⟧</span> <span class="main">⟹</span> LtK <span class="free">K</span> <span class="main">∈</span> ik <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_inv1_def<span class="main">)</span>

<span class="keyword1" id="dhlvl3-l3_inv1_init"><span class="command">lemma</span></span> l3_inv1_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv1I<span class="main">)</span>

<span class="keyword1" id="dhlvl3-l3_inv1_trans"><span class="command">lemma</span></span> l3_inv1_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv1<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv1I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs dy_fake_msg_def dy_fake_chan_def
        parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ik <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"insert <span class="main">_</span> <span class="main">(</span>ik <span class="main">_</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Fake_parts_insert<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>analz_into_parts<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-PO_l3_inv1"><span class="command">lemma</span></span> PO_l3_inv1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"bad <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> indeed contains "bad" keys›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    Keys_bad <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv2I <span class="main">=</span> l3_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l3_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv2D <span class="main">=</span> l3_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1" id="dhlvl3-l3_inv2_init"><span class="command">lemma</span></span> l3_inv2_init <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv2I Keys_badI<span class="main">)</span>

<span class="keyword1" id="dhlvl3-l3_inv2_trans"><span class="command">lemma</span></span> l3_inv2_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv2 <span class="main">∩</span> l3_inv1<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs dy_fake_msg_def dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹4 subgoals: dy, lkr*, skr›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Keys_bad_insert_Fake Keys_bad_insert_keys_of<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Keys_bad_insert_payload<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-PO_l3_inv2"><span class="command">lemma</span></span> PO_l3_inv2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l3_inv1"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a message can be analyzed from the intruder knowledge then it can
be derived (using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>/<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"analz"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) from the sets of implementation, 
non-implementation, and long-term key messages and the tags. That is, intermediate messages 
are not needed.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>      
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> 
    synth <span class="main">(</span>analz <span class="main">(</span><span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv3I <span class="main">=</span> l3_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv3E <span class="main">=</span> l3_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv3D <span class="main">=</span> l3_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="dhlvl3-l3_inv3_init"><span class="command">lemma</span></span> l3_inv3_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv3"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_increasing <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Most of the cases in this proof are simple and very similar.
The proof could probably be shortened.›</span></span>
<span class="keyword1" id="dhlvl3-l3_inv3_trans"><span class="command">lemma</span></span> l3_inv3_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_nostep_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step1 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">gnx</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step2 <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">gnx</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">gny</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step3 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">gny</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">gnx</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step4 <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">gnx</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_dy <span class="skolem">m</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs dy_fake_chan_def dy_fake_msg_def
                <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_analz_insert<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_monotone<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_lkr_others <span class="skolem">A</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> analz_Un_partition <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"keys_of <span class="skolem"><span class="skolem">A</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_lkr_after <span class="skolem">A</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> analz_Un_partition <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"keys_of <span class="skolem"><span class="skolem">A</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="skolem">K</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_skr <span class="skolem">R</span> <span class="skolem">K</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="dhlvl3-PO_l3_inv3"><span class="command">lemma</span></span> PO_l3_inv3 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4: the intruder knows the tags›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv4</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    Tags <span class="main">⊆</span> ik <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv4I <span class="main">=</span> l3_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l3_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv4D <span class="main">=</span> l3_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="dhlvl3-l3_inv4_init"><span class="command">lemma</span></span> l3_inv4_init <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def ik_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv4I<span class="main">)</span>

<span class="keyword1" id="dhlvl3-l3_inv4_trans"><span class="command">lemma</span></span> l3_inv4_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv4<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs dy_fake_chan_def dy_fake_msg_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-PO_l3_inv4"><span class="command">lemma</span></span> PO_l3_inv4 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The remaining invariants are derived from the others.
They are not protocol dependent provided the previous invariants hold.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The messages that the L3 DY intruder can derive from the intruder knowledge 
(using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>/<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"analz"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), are either implementations or intermediate messages or
can also be derived by the L2 intruder from the set 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"extr <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> payload<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>abs <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, that is, given the 
non-implementation messages and the abstractions of (implementation) messages
in the intruder knowledge. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv5</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 
    dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">(</span>abs <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv5I <span class="main">=</span> l3_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv5E <span class="main">=</span> l3_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv5D <span class="main">=</span> l3_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="dhlvl3-l3_inv5_derived"><span class="command">lemma</span></span> l3_inv5_derived<span class="main">:</span> <span class="quoted"><span class="quoted">"l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">⊆</span> l3_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_validSet dy_fake_msg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv5I
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> synth_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_NI_I_K_synth_analz_NI_E <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="dhlvl3-PO_l3_inv5"><span class="command">lemma</span></span> PO_l3_inv5 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv5"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv5_derived PO_l3_inv2 PO_l3_inv3 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing an insecure channel message, then:
\begin{itemize}
  \item either the message is already in the intruder knowledge;
  \item or the message is constructed, and the payload can also be deduced by the intruder.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv6</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv6I <span class="main">=</span> l3_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv6E <span class="main">=</span> l3_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv6D <span class="main">=</span> l3_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="dhlvl3-l3_inv6_derived"><span class="command">lemma</span></span> l3_inv6_derived <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv6"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv6I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹1 subgoal›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implInsec_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">"ik <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-PO_l3_inv6"><span class="command">lemma</span></span> PO_l3_inv6 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv6"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv6_derived PO_l3_inv3 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing a confidential channel message,
then either 
\begin{itemize}
 \item the message is already in the intruder knowledge, or
 \item the message is constructed, and the payload can also be deduced by the intruder.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv7</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv7I <span class="main">=</span> l3_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv7E <span class="main">=</span> l3_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv7D <span class="main">=</span> l3_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="dhlvl3-l3_inv7_derived"><span class="command">lemma</span></span> l3_inv7_derived <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv7"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv7I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹1 subgoal›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implConfid_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">"ik <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-PO_l3_inv7"><span class="command">lemma</span></span> PO_l3_inv7 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv7"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv7_derived PO_l3_inv3 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv8›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing an authentic channel message 
then either
\begin{itemize}
  \item the message is already in the intruder knowledge, or
  \item the message is constructed, and in this case the payload can also be deduced
     by the intruder, and one of the agents is bad.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv8</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv8</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∈</span> bad <span class="bound">s</span> <span class="main">∨</span> <span class="bound">B</span> <span class="main">∈</span> bad <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv8I <span class="main">=</span> l3_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv8E <span class="main">=</span> l3_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv8D <span class="main">=</span> l3_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="dhlvl3-l3_inv8_derived"><span class="command">lemma</span></span> l3_inv8_derived <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv8"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv8I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D l3_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹2 subgoals: M is deducible and the agents are bad›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implAuth_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implAuth_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-PO_l3_inv8"><span class="command">lemma</span></span> PO_l3_inv8 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv8"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv8_derived
  PO_l3_inv3 PO_l3_inv2 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv9›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing a secure channel message 
then either:
\begin{itemize}
  \item the message is already in the intruder knowledge, or
  \item the message is constructed, and in this case the payload can also be deduced 
 by the intruder, and one of the agents is bad.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv9</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv9</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∈</span> bad <span class="bound">s</span> <span class="main">∨</span> <span class="bound">B</span> <span class="main">∈</span> bad <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv9I <span class="main">=</span> l3_inv9_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv9E <span class="main">=</span> l3_inv9_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv9D <span class="main">=</span> l3_inv9_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="dhlvl3-l3_inv9_derived"><span class="command">lemma</span></span> l3_inv9_derived <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv9"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv9I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv3D l3_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹2 subgoals: M is deducible and the agents are bad›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSecure_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSecure_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-PO_l3_inv9"><span class="command">lemma</span></span> PO_l3_inv9 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv9"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv9_derived
  PO_l3_inv3 PO_l3_inv2 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med23s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_obs <span class="main">⇒</span> l2_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med23s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    ik <span class="main">=</span> ik <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∩</span> payload<span class="main">,</span>
    secret <span class="main">=</span> secret <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    progress <span class="main">=</span> progress <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsInit <span class="main">=</span> signalsInit <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsResp <span class="main">=</span> signalsResp <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    chan <span class="main">=</span> abs <span class="main">(</span>ik <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
    bad <span class="main">=</span> bad <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation between states.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l2_state <span class="main">*</span> l3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23s</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">s</span> <span class="main">=</span> med23s <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23s_defs <span class="main">=</span> R23s_def med23s_def

<span class="keyword1" id="dhlvl3-R23sI"><span class="command">lemma</span></span> R23sI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ik <span class="free">s</span> <span class="main">=</span> ik <span class="free">t</span> <span class="main">∩</span> payload<span class="main">;</span> secret <span class="free">s</span> <span class="main">=</span> secret <span class="free">t</span><span class="main">;</span> progress <span class="free">s</span> <span class="main">=</span> progress <span class="free">t</span><span class="main">;</span> 
     signalsInit <span class="free">s</span> <span class="main">=</span> signalsInit <span class="free">t</span><span class="main">;</span> signalsResp <span class="free">s</span> <span class="main">=</span> signalsResp <span class="free">t</span><span class="main">;</span> 
     chan <span class="free">s</span> <span class="main">=</span> abs <span class="main">(</span>ik <span class="free">t</span><span class="main">)</span><span class="main">;</span> l2_state.bad <span class="free">s</span> <span class="main">=</span> bad <span class="free">t</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23s"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_def med23s_def<span class="main">)</span>

<span class="keyword1" id="dhlvl3-R23sD"><span class="command">lemma</span></span> R23sD<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23s <span class="main">⟹</span>
    ik <span class="free">s</span> <span class="main">=</span> ik <span class="free">t</span> <span class="main">∩</span> payload <span class="main">∧</span> secret <span class="free">s</span> <span class="main">=</span> secret <span class="free">t</span> <span class="main">∧</span> progress <span class="free">s</span> <span class="main">=</span> progress <span class="free">t</span> <span class="main">∧</span> 
    signalsInit <span class="free">s</span> <span class="main">=</span> signalsInit <span class="free">t</span> <span class="main">∧</span> signalsResp <span class="free">s</span> <span class="main">=</span> signalsResp <span class="free">t</span> <span class="main">∧</span> 
    chan <span class="free">s</span> <span class="main">=</span> abs <span class="main">(</span>ik <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> l2_state.bad <span class="free">s</span> <span class="main">=</span> bad <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_def med23s_def<span class="main">)</span>

<span class="keyword1" id="dhlvl3-R23sE"><span class="command">lemma</span></span> R23sE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23s<span class="main">;</span>
     <span class="main">⟦</span> ik <span class="free">s</span> <span class="main">=</span> ik <span class="free">t</span> <span class="main">∩</span> payload<span class="main">;</span> secret <span class="free">s</span> <span class="main">=</span> secret <span class="free">t</span><span class="main">;</span> progress <span class="free">s</span> <span class="main">=</span> progress <span class="free">t</span><span class="main">;</span> 
       signalsInit <span class="free">s</span> <span class="main">=</span> signalsInit <span class="free">t</span><span class="main">;</span> signalsResp <span class="free">s</span> <span class="main">=</span> signalsResp <span class="free">t</span><span class="main">;</span> 
       chan <span class="free">s</span> <span class="main">=</span> abs <span class="main">(</span>ik <span class="free">t</span><span class="main">)</span><span class="main">;</span> l2_state.bad <span class="free">s</span> <span class="main">=</span> bad <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_def med23s_def<span class="main">)</span>

<span class="keyword1" id="dhlvl3-can_signal_R23"><span class="command">lemma</span></span> can_signal_R23 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s2</span><span class="main">,</span> <span class="free">s3</span><span class="main">)</span> <span class="main">∈</span> R23s <span class="main">⟹</span>
   can_signal <span class="free">s2</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> can_signal <span class="free">s3</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Protocol events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="dhlvl3-l3_step1_refines_step1"><span class="command">lemma</span></span> l3_step1_refines_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">,</span> l3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_step1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-l3_step2_refines_step2"><span class="command">lemma</span></span> l3_step2_refines_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span><span class="main">,</span> l3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span><span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l2_step2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_step2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-l3_step3_refines_step3"><span class="command">lemma</span></span> l3_step3_refines_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span><span class="main">,</span> l3_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l2_step3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_step3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-l3_step4_refines_step4"><span class="command">lemma</span></span> l3_step4_refines_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span><span class="main">,</span> l3_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l2_step4_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_step4_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Intruder events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="dhlvl3-l3_dy_payload_refines_dy_fake_msg"><span class="command">lemma</span></span> l3_dy_payload_refines_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> payload <span class="main">⟹</span>
   <span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> l3_inv5<span class="main">}</span> l2_dy_fake_msg <span class="free">M</span><span class="main">,</span> l3_dy <span class="free">M</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_dy_fake_msg_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv5D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-l3_dy_valid_refines_dy_fake_chan"><span class="command">lemma</span></span> l3_dy_valid_refines_dy_fake_chan<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">∈</span> valid<span class="main">;</span> <span class="free">M'</span> <span class="main">∈</span> abs <span class="main">{</span><span class="free">M</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">}</span> 
      l2_dy_fake_chan <span class="free">M'</span><span class="main">,</span> l3_dy <span class="free">M</span> 
   <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹1 subgoal›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> valid_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_chan_def<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Insec›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv6D l3_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Confid›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv7D l3_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auth›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv8D l3_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Secure›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv9D l3_inv5D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="dhlvl3-l3_dy_valid_refines_dy_fake_chan_Un"><span class="command">lemma</span></span> l3_dy_valid_refines_dy_fake_chan_Un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> valid <span class="main">⟹</span>
   <span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">}</span> 
      <span class="main">⋃</span><span class="bound">M'</span><span class="main">.</span> l2_dy_fake_chan <span class="bound">M'</span><span class="main">,</span> l3_dy <span class="free">M</span> 
   <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> valid_abs <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l3_dy_valid_refines_dy_fake_chan<span class="main">)</span>


<span class="keyword1" id="dhlvl3-l3_dy_isLtKey_refines_skip"><span class="command">lemma</span></span> l3_dy_isLtKey_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> Id<span class="main">,</span> l3_dy <span class="main">(</span>LtK <span class="free">ltk</span><span class="main">)</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l3_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> absE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-l3_dy_others_refines_skip"><span class="command">lemma</span></span> l3_dy_others_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">∉</span> range LtK<span class="main">;</span> <span class="free">M</span> <span class="main">∉</span> valid<span class="main">;</span> <span class="free">M</span> <span class="main">∉</span> payload <span class="main">⟧</span> <span class="main">⟹</span> 
   <span class="main">{</span>R23s<span class="main">}</span> Id<span class="main">,</span> l3_dy <span class="free">M</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>     <span class="comment1">(* auto SLOW *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> absE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> validI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="dhlvl3-l3_dy_refines_dy_fake_msg_dy_fake_chan_skip"><span class="command">lemma</span></span> l3_dy_refines_dy_fake_msg_dy_fake_chan_skip<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">}</span> 
      l2_dy_fake_msg <span class="free">M</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">M'</span><span class="main">.</span> l2_dy_fake_chan <span class="bound">M'</span><span class="main">)</span> <span class="main">∪</span> Id<span class="main">,</span> l3_dy <span class="free">M</span> 
    <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK"</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_dy_payload_refines_dy_fake_msg l3_dy_valid_refines_dy_fake_chan_Un 
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l3_dy_isLtKey_refines_skip <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_dy_others_refines_skip<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Compromise events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="dhlvl3-l3_lkr_others_refines_lkr_others"><span class="command">lemma</span></span> l3_lkr_others_refines_lkr_others<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_lkr_others <span class="free">A</span><span class="main">,</span> l3_lkr_others <span class="free">A</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_lkr_others_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-l3_lkr_after_refines_lkr_after"><span class="command">lemma</span></span> l3_lkr_after_refines_lkr_after<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_lkr_after <span class="free">A</span><span class="main">,</span> l3_lkr_after <span class="free">A</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_lkr_after_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-l3_skr_refines_skr"><span class="command">lemma</span></span> l3_skr_refines_skr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_skr <span class="free">R</span> <span class="free">K</span><span class="main">,</span> l3_skr <span class="free">R</span> <span class="free">K</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_skr_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">lemmas</span></span> l3_trans_refines_l2_trans <span class="main">=</span> 
  l3_step1_refines_step1 l3_step2_refines_step2 l3_step3_refines_step3 l3_step4_refines_step4
  l3_dy_refines_dy_fake_msg_dy_fake_chan_skip
  l3_lkr_others_refines_lkr_others l3_lkr_after_refines_lkr_after l3_skr_refines_skr



<span class="keyword1" id="dhlvl3-l3_refines_init_l2"><span class="command">lemma</span></span> l3_refines_init_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> R23s <span class="main">``</span> <span class="main">(</span>init l2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_defs l2_defs l3_def l3_init_def<span class="main">)</span>

<span class="keyword1" id="dhlvl3-l3_refines_trans_l2"><span class="command">lemma</span></span> l3_refines_trans_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l3_inv1 <span class="main">∩</span> l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4<span class="main">)</span><span class="main">)</span><span class="main">}</span> trans l2<span class="main">,</span> trans l3 <span class="main">{&gt;</span> R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pre'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"R23s <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span><span class="var">?post</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conseq_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pre</span> <span class="main">⊆</span> <span class="var">?pre'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l3_inv5_derived l3_inv6_derived l3_inv7_derived l3_inv8_derived l3_inv9_derived 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre'</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span> <span class="var">?post</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l3_def l2_trans_def l3_trans_def
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_trans_refines_l2_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1" id="dhlvl3-PO_obs_consistent_R23s"><span class="command">lemma</span></span> PO_obs_consistent_R23s <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R23s med23s l2 l3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23s_def med23s_def l2_defs<span class="main">)</span>


<span class="keyword1" id="dhlvl3-l3_refines_l2"><span class="command">lemma</span></span> l3_refines_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R23s <span class="main">∩</span> 
      <span class="main">(</span>reach l2 <span class="main">×</span> <span class="main">(</span>l3_inv1 <span class="main">∩</span> l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med23s l2 l3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="dhlvl3-l3_implements_l2"><span class="command">lemma</span></span> l3_implements_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med23s l2 l3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv10: secrets contain no implementation material›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv10</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv10</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    secret <span class="bound">s</span> <span class="main">⊆</span> payload
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv10I <span class="main">=</span> l3_inv10_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv10E <span class="main">=</span> l3_inv10_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv10D <span class="main">=</span> l3_inv10_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="dhlvl3-l3_inv10_init"><span class="command">lemma</span></span> l3_inv10_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv10"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def ik_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv10I<span class="main">)</span>

<span class="keyword1" id="dhlvl3-l3_inv10_trans"><span class="command">lemma</span></span> l3_inv10_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv10<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv10<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l3_inv10_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-PO_l3_inv10"><span class="command">lemma</span></span> PO_l3_inv10 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv10"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="dhlvl3-l3_obs_inv10"><span class="command">lemma</span></span> l3_obs_inv10 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_inv10"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Partial secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We want to prove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l3_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, i.e.,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  but by refinement we only get <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l3_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: 
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">payloadSet</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>abs <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  This is fine if secrets contain no implementation material.
  Then, by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">inv5</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, a message in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is in
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">payloadSet</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>abs <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">-</span></span>payload"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l3_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> proves it is not a secret.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_partial_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l3_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_partial_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> 
    dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">(</span>abs <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1" id="dhlvl3-l3_obs_partial_secrecy"><span class="command">lemma</span></span> l3_obs_partial_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_partial_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_secrecy _ l3_implements_l2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l2_secrecy_def l3_partial_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l3_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l3_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_secrecy</span> <span class="main">≡</span> l1_secrecy"</span></span>

<span class="keyword1" id="dhlvl3-l3_obs_inv5"><span class="command">lemma</span></span> l3_obs_inv5<span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>

<span class="keyword1" id="dhlvl3-l3_obs_secrecy"><span class="command">lemma</span></span> l3_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> l3_obs_inv5 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> l3_obs_inv10 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l2_secrecy_def l3_secrecy_def s0_secrecy_def l3_inv10_def<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> l3_partial_secrecy_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv5D subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_partial_secrecy<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-l3_secrecy"><span class="command">lemma</span></span> l3_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_secrecy<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Injective agreement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l3_iagreement_Init</span> <span class="main">≡</span> l1_iagreement_Init"</span></span>

<span class="keyword1" id="dhlvl3-l3_obs_iagreement_Init"><span class="command">lemma</span></span> l3_obs_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_iagreement_Init"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_iagreement_Init _ l3_implements_l2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l1_iagreement_Init_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-l3_iagreement_Init"><span class="command">lemma</span></span> l3_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_iagreement_Init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_iagreement_Init<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l3_iagreement_Resp</span> <span class="main">≡</span> l1_iagreement_Resp"</span></span>

<span class="keyword1" id="dhlvl3-l3_obs_iagreement_Resp"><span class="command">lemma</span></span> l3_obs_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_iagreement_Resp _ l3_implements_l2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l1_iagreement_Resp_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="dhlvl3-l3_iagreement_Resp"><span class="command">lemma</span></span> l3_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_iagreement_Resp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="dhlvl3_asymmetric">
<div class="head">
<h1>Theory dhlvl3_asymmetric</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  dhlvl3_asymmetric.thy (Isabelle/HOL 2016-1)
  ID:      $Id: dhlvl3_asymmetric.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-3 Diffie-Hellman protocol; asymmetric instantiation of version with 
  generic channel implementation. This corresponds to a standard signature-
  authenticated Diffie-Hellman protocol. 

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Authenticated Diffie-Hellman Protocol (L3, asymmetric)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> dhlvl3_asymmetric
<span class="keyword2"><span class="keyword">imports</span></span> <a href="dhlvl3.html">dhlvl3</a> <a href="Implem_asymmetric.html">Implem_asymmetric</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> dhlvl3_asym<span class="main">:</span> dhlvl3 <span class="quoted">implem_asym</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="dhlvl3_symmetric">
<div class="head">
<h1>Theory dhlvl3_symmetric</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  dhlvl3_symmetric.thy (Isabelle/HOL 2016-1)
  ID:      $Id: dhlvl3_symmetric.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-3 Diffie-Hellman protocol; symmetric instantiation of 
  version with generic channel implementation.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Authenticated Diffie-Hellman Protocol (L3, symmetric)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> dhlvl3_symmetric
<span class="keyword2"><span class="keyword">imports</span></span> <a href="dhlvl3.html">dhlvl3</a> <a href="Implem_symmetric.html">Implem_symmetric</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> dhlvl3_sym<span class="main">:</span> dhlvl3 <span class="quoted">implem_sym</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="sklvl1">
<div class="head">
<h1>Theory sklvl1</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  sklvl1.thy (Isabelle/HOL 2016-1)
  ID:      $Id: sklvl1.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-1 Diffie-Hellman guard protocol augmented with two nonces.
  Refines model dhlvl1, moving towards SKEME/IKEv1 protocol.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹SKEME Protocol (L1)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> sklvl1
<span class="keyword2"><span class="keyword">imports</span></span> <a href="dhlvl1.html">dhlvl1</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> option.split_asm <span class="main">[</span><span class="operator">split</span><span class="main">]</span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and Events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ni</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ni</span> <span class="main">≡</span> <span class="numeral">4</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nr</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">nr</span> <span class="main">≡</span> <span class="numeral">5</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proofs break if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is used, because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">method</span></span> "simp"<span class="antiquote"><span class="antiquote">}</span></span></span></span> replaces it with
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\dots.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xni</span> <span class="main">≡</span> Var <span class="numeral">7</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">xnr</span> <span class="main">≡</span> Var <span class="numeral">8</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Domain of each role (protocol-dependent).›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">domain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">domain</span> Init <span class="main">=</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">domain</span> Resp <span class="main">=</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  guessed_frame <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> frame"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specification of the guessed frame:
\begin{enumerate}
\item Domain.
\item Well-typedness.
  The messages in the frame of a run never contain implementation material
  even if the agents of the run are dishonest.
  Therefore we consider only well-typed frames.
  This is notably required for the session key compromise; it also helps proving
  the partitionning of ik,
  since we know that the messages added by the protocol do not contain ltkeys in their
  payload and are therefore valid implementations.
\item We also ensure that the values generated by the frame owner are correctly guessed.
\item The new frame extends the previous one (from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="dhlvl1.html"></a><a href="dhlvl1.html">Key_Agreement_Strong_Adversaries.dhlvl1</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>)
\end{enumerate}
›</span></span>
<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">guessed_frame</span><span class="main">)</span> 
  guessed_frame_dom_spec <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"dom <span class="main">(</span>guessed_frame <span class="free">R</span><span class="main">)</span> <span class="main">=</span> domain <span class="main">(</span>role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_payload_spec <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> payload"</span></span>
  guessed_frame_Init_xnx <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init <span class="main">⟹</span> guessed_frame <span class="free">R</span> xnx <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_Init_xgnx <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init <span class="main">⟹</span> guessed_frame <span class="free">R</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_Init_xni <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init <span class="main">⟹</span> guessed_frame <span class="free">R</span> xni <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>ni<span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_Resp_xny <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Resp <span class="main">⟹</span> guessed_frame <span class="free">R</span> xny <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_Resp_xgny <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Resp <span class="main">⟹</span> guessed_frame <span class="free">R</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  guessed_frame_Resp_xnr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Resp <span class="main">⟹</span> guessed_frame <span class="free">R</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span>"</span></span>    
  guessed_frame_xEnd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xEnd <span class="main">=</span> Some End"</span></span>
  guessed_frame_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>xnx<span class="main">,</span> xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">⟹</span> dhlvl1.guessed_frame <span class="free">R</span> <span class="free">x</span> <span class="main">=</span> guessed_frame <span class="free">R</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> 
    <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">.</span></span>
      <span class="keyword1"><span class="keyword1">if</span></span> role <span class="main"><span class="main">(</span></span>guessed_runs <span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> Init <span class="keyword1"><span class="keyword1">then</span></span>
        <span class="main"><span class="main">(</span></span>dhlvl1.guessed_frame <span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>xni <span class="main"><span class="main">↦</span></span> NonceF <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">$</span></span>ni<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> xnr <span class="main"><span class="main">↦</span></span> End<span class="main"><span class="main">)</span></span>
      <span class="keyword1"><span class="keyword1">else</span></span>
        <span class="main"><span class="main">(</span></span>dhlvl1.guessed_frame <span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>xnr <span class="main"><span class="main">↦</span></span> NonceF <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">R</span></span><span class="main"><span class="main">$</span></span>nr<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> xni <span class="main"><span class="main">↦</span></span> End<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> role_t.exhaust<span class="main">)</span>  
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">record</span></span> skl1_state <span class="main">=</span> 
  <span class="quoted">l1_state</span> <span class="main">+</span>
  signalsInit2 <span class="main">::</span> <span class="quoted"><span class="quoted">"signal <span class="main">⇒</span> nat"</span></span>
  signalsResp2 <span class="main">::</span> <span class="quoted"><span class="quoted">"signal <span class="main">⇒</span> nat"</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> skl1_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"skl1_state"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events:
\begin{itemize}
\item step 1: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 2: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reads <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  insecurely,
  generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  emits a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 3: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reads $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  authentically,
  computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$, emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 4: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reads <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ authentically,
  emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\end{itemize}
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> skl1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> skl1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xgnx<span class="main">}</span><span class="main">)</span>
      <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_step2</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> skl1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> skl1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xni <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgny<span class="main">,</span> xgnx<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ni</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit <span class="bound">s</span><span class="main">,</span>
            signalsInit2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit2 <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_step3</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> skl1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> skl1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xgnx<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xgny <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xnr <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Nr</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟶</span> <span class="comment1">― ‹authentication guard›</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">Rb</span><span class="main">.</span> guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
             in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xgny <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xnr <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Nr</span></span></span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xni <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit <span class="bound">s</span><span class="main">,</span>
            signalsInit2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit2 <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp <span class="bound">s</span><span class="main">,</span>
            signalsResp2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp2 <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_step4</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> msg <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> skl1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> skl1_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_step4</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xni <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="main">∧</span>
    <span class="main">(</span>can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟶</span> <span class="comment1">― ‹authentication guard›</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">Ra</span><span class="main">.</span> guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
             in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Ra</span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
             guessed_frame <span class="bound">Ra</span> xni <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="main">∧</span>
             guessed_frame <span class="bound">Ra</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ni</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp <span class="bound">s</span><span class="main">,</span>
            signalsResp2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp2 <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specification.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">skl1_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> skl1_state_scheme <span class="main">*</span> <span class="tfree">'a</span> skl1_state_scheme<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span>
     skl1_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     skl1_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∪</span>
     skl1_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∪</span>
     skl1_step4 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∪</span>
     l1_learn <span class="bound">m</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"skl1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
    ik <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    secret <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    progress <span class="main">=</span> Map.empty<span class="main">,</span>
    signalsInit <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsResp <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsInit2 <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsResp2 <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span>
    <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">skl1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>skl1_state<span class="main">,</span> skl1_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> skl1_init<span class="main">,</span>
    trans <span class="main">=</span> skl1_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> skl1_defs <span class="main">=</span> 
  skl1_def skl1_init_def skl1_trans_def
  l1_learn_def
  skl1_step1_def skl1_step2_def skl1_step3_def skl1_step4_def

<span class="keyword1"><span class="command">lemmas</span></span> skl1_nostep_defs <span class="main">=</span>
  skl1_def skl1_init_def skl1_trans_def

<span class="keyword1" id="sklvl1-skl1_obs_id"><span class="command">lemma</span></span> skl1_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs skl1 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_def<span class="main">)</span>


<span class="keyword1" id="sklvl1-run_ended_trans"><span class="command">lemma</span></span> run_ended_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_ended <span class="main">(</span>progress <span class="free">s</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans skl1 <span class="main">⟹</span>
   run_ended <span class="main">(</span>progress <span class="free">s'</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_nostep_defs<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_defs ik_dy_def domIff<span class="main">)</span>

<span class="keyword1" id="sklvl1-can_signal_trans"><span class="command">lemma</span></span> can_signal_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"can_signal <span class="free">s'</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans skl1 <span class="main">⟹</span>
  can_signal <span class="free">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def run_ended_trans<span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement: secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">option_inter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> var set option <span class="main">⇒</span> var set option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">option_inter</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">option_inter</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> None <span class="main">=</span> None"</span></span>
  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">med_progress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"progress_t <span class="main">⇒</span> progress_t"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med_progress</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">R</span><span class="main">.</span> option_inter <span class="main">{</span>xnx<span class="main">,</span> xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">R</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="sklvl1-med_progress_upd"><span class="command">lemma</span></span> med_progress_upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"med_progress <span class="main">(</span><span class="free">r</span><span class="main">(</span><span class="free">R</span> <span class="main">↦</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>med_progress <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="main">↦</span> <span class="free">S</span> <span class="main">∩</span> <span class="main">{</span>xnx<span class="main">,</span> xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med_progress_def<span class="main">)</span>

<span class="keyword1" id="sklvl1-med_progress_Some"><span class="command">lemma</span></span> med_progress_Some<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">s</span> <span class="main">⟹</span> med_progress <span class="free">r</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">s</span> <span class="main">∩</span> <span class="main">{</span>xnx<span class="main">,</span> xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med_progress_def<span class="main">)</span> 

<span class="keyword1" id="sklvl1-med_progress_None"><span class="command">lemma</span></span> med_progress_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"med_progress <span class="free">r</span> <span class="free">x</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="free">r</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med_progress_def<span class="main">)</span> 

<span class="keyword1" id="sklvl1-med_progress_Some2"><span class="command">lemma</span></span> med_progress_Some2 <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"med_progress <span class="free">r</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">z</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">∩</span> <span class="main">{</span>xnx<span class="main">,</span> xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med_progress_def<span class="main">)</span> 

<span class="keyword1" id="sklvl1-med_progress_dom"><span class="command">lemma</span></span> med_progress_dom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>med_progress <span class="free">r</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff med_progress_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x y<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1" id="sklvl1-med_progress_empty"><span class="command">lemma</span></span> med_progress_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"med_progress Map.empty <span class="main">=</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med11</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"skl1_obs <span class="main">⇒</span> l1_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med11</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>ik <span class="main">=</span> ik <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
              secret<span class="main">=</span>secret <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
              progress <span class="main">=</span> med_progress <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
              signalsInit <span class="main">=</span> signalsInit2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
              signalsResp <span class="main">=</span> signalsResp2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹relation between states›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R11</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l1_state <span class="main">*</span> skl1_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R11</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">s</span> <span class="main">=</span> med11 <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R11_defs <span class="main">=</span> R11_def med11_def

<span class="keyword1" id="sklvl1-in_progress_med_progress"><span class="command">lemma</span></span> in_progress_med_progress<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>xnx<span class="main">,</span> xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> 
  <span class="main">⟹</span> in_progress <span class="main">(</span>med_progress <span class="free">r</span> <span class="free">R</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> in_progress <span class="main">(</span><span class="free">r</span> <span class="free">R</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">R</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"med_progress <span class="free">r</span> <span class="free">R</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="sklvl1-in_progressS_eq"><span class="command">lemma</span></span> in_progressS_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"in_progressS <span class="free">S</span> <span class="free">S'</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">S</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S'</span><span class="main">.</span> in_progress <span class="free">S</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="sklvl1-in_progressS_med_progress"><span class="command">lemma</span></span> in_progressS_med_progress<span class="main">:</span>
  <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span><span class="free">r</span> <span class="free">R</span><span class="main">)</span> <span class="free">S</span> 
  <span class="main">⟹</span> in_progressS <span class="main">(</span>med_progress <span class="free">r</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span>xnx<span class="main">,</span> xny<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_progressS_eq in_progress_med_progress<span class="main">)</span>

<span class="keyword1" id="sklvl1-can_signal_R11"><span class="command">lemma</span></span> can_signal_R11 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span> <span class="main">∈</span> R11 <span class="main">⟹</span>
   can_signal <span class="free">s1</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> can_signal <span class="free">s2</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def R11_defs in_progress_med_progress<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol-independent events.›</span></span>

<span class="keyword1" id="sklvl1-skl1_learn_refines_learn"><span class="command">lemma</span></span> skl1_learn_refines_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R11<span class="main">}</span> l1_learn <span class="free">m</span><span class="main">,</span> l1_learn <span class="free">m</span> <span class="main">{&gt;</span>R11<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R11_defs<span class="main">)</span>
   <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1" id="sklvl1-skl1_step1_refines_step1"><span class="command">lemma</span></span> skl1_step1_refines_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R11<span class="main">}</span> l1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">,</span> skl1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R11<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R11_defs l1_step1_def skl1_step1_def<span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_step2_refines_step2"><span class="command">lemma</span></span> skl1_step2_refines_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R11<span class="main">}</span> l1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span><span class="main">,</span> skl1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R11<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R11_defs  l1_step2_def<span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_step2_def<span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_step3_refines_step3"><span class="command">lemma</span></span> skl1_step3_refines_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R11<span class="main">}</span> l1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gny</span><span class="main">,</span> skl1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span> <span class="main">{&gt;</span>R11<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R11_defs l1_step3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_step3_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> med_progress_Some<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> in_progressS_med_progress<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl1-skl1_step4_refines_step4"><span class="command">lemma</span></span> skl1_step4_refines_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R11<span class="main">}</span> l1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">gnx</span><span class="main">,</span> skl1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R11<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R11_defs l1_step4_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_step4_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> med_progress_Some<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> in_progressS_med_progress<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> skl1_trans_refines_l1_trans <span class="main">=</span> 
  skl1_learn_refines_learn
  skl1_step1_refines_step1 skl1_step2_refines_step2 
  skl1_step3_refines_step3 skl1_step4_refines_step4

<span class="keyword1" id="sklvl1-skl1_refines_init_l1"><span class="command">lemma</span></span> skl1_refines_init_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init skl1 <span class="main">⊆</span> R11 <span class="main">``</span> <span class="main">(</span>init l1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R11_defs l1_defs skl1_defs<span class="main">)</span>


<span class="keyword1" id="sklvl1-skl1_refines_trans_l1"><span class="command">lemma</span></span> skl1_refines_trans_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R11<span class="main">}</span> trans l1<span class="main">,</span> trans skl1 <span class="main">{&gt;</span> R11<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_def skl1_def l1_trans_def skl1_trans_def 
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> skl1_trans_refines_l1_trans<span class="main">)</span>


<span class="keyword1" id="sklvl1-obs_consistent_med11"><span class="command">lemma</span></span> obs_consistent_med11 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R11 med11 l1 skl1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R11_defs<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1" id="sklvl1-skl1_refines_l1"><span class="command">lemma</span></span> skl1_refines_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     R11
     med11 l1 skl1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>refines_def PO_refines_def<span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_implements_l1"><span class="command">lemma</span></span>  skl1_implements_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med11 l1 skl1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants: secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="sklvl1-skl1_obs_secrecy"><span class="command">lemma</span></span> skl1_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach skl1 <span class="main">⊆</span> s0_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l1_obs_secrecy _ skl1_implements_l1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med11_def s0_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl1-skl1_secrecy"><span class="command">lemma</span></span> skl1_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach skl1 <span class="main">⊆</span> s0_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> skl1_obs_secrecy<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authenticates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If an initiator commit signal exists for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span><span class="main"><span class="main">$</span></span>ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Nr</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  $(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span><span class="main"><span class="main">$</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, has passed step 3, and has the nonce <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Nr</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(g^ny)^(Ra$nx)›</span></span></span></span> as the key in its frame. 
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"skl1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_inv1</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gny</span> <span class="bound">Nr</span><span class="main">.</span>
    signalsInit <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="bound">Nr</span><span class="main">,</span> Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span>
      guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">∧</span>
      progress <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Ra</span> xnr <span class="main">=</span> Some <span class="bound">Nr</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Ra</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv1I <span class="main">=</span> skl1_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> skl1_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv1D <span class="main">=</span> skl1_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>


<span class="keyword1" id="sklvl1-skl1_inv1_init"><span class="command">lemma</span></span> skl1_inv1_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init skl1 <span class="main">⊆</span> skl1_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_def skl1_init_def skl1_inv1_def<span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_inv1_trans"><span class="command">lemma</span></span> skl1_inv1_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>skl1_inv1<span class="main">}</span> trans skl1 <span class="main">{&gt;</span> skl1_inv1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs skl1_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> skl1_inv1I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_defs ik_dy_def skl1_inv1_def domIff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_inj2 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl1-PO_skl1_inv1"><span class="command">lemma</span></span> PO_skl1_inv1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach skl1 <span class="main">⊆</span> skl1_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has passed step 2 then (if possible) 
an initiator running signal has been emitted.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_inv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"skl1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_inv2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">gnx</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Ni</span><span class="main">.</span>
    guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="bound">gnx</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xni <span class="main">=</span> Some <span class="bound">Ni</span> <span class="main">⟶</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
      signalsInit <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span><span class="bound">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="bound">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv2I <span class="main">=</span> skl1_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> skl1_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv2D <span class="main">=</span> skl1_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>


<span class="keyword1" id="sklvl1-skl1_inv2_init"><span class="command">lemma</span></span> skl1_inv2_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init skl1 <span class="main">⊆</span> skl1_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_def skl1_init_def skl1_inv2_def<span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_inv2_trans"><span class="command">lemma</span></span> skl1_inv2_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>skl1_inv2<span class="main">}</span> trans skl1 <span class="main">{&gt;</span> skl1_inv2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> skl1_inv2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> can_signal_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_defs ik_dy_def skl1_inv2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl1-PO_skl1_inv2"><span class="command">lemma</span></span> PO_skl1_inv2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach skl1 <span class="main">⊆</span> skl1_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3 (derived)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run before step 3 and a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run after step 2 both know
  the same half-keys and nonces (more or less), then the number of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> running signals
  for the key is strictly greater than the number of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> commit signals.
  (actually, there are 0 commit and 1 running).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_inv3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"skl1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_inv3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Ra</span> <span class="bound">gny</span> <span class="bound">Nr</span><span class="main">.</span>
    guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xgny <span class="main">=</span> Some <span class="bound">gny</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xnr <span class="main">=</span> Some <span class="bound">Nr</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xni <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟶</span>
    progress <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xgnx<span class="main">,</span> xni<span class="main">}</span> <span class="main">⟶</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
      signalsInit <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="bound">Nr</span><span class="main">,</span> Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> 
    <span class="main">&lt;</span> signalsInit <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="bound">Nr</span><span class="main">,</span> Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv3I <span class="main">=</span> skl1_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> skl1_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv3D <span class="main">=</span> skl1_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="sklvl1-skl1_inv3_derived"><span class="command">lemma</span></span> skl1_inv3_derived<span class="main">:</span> <span class="quoted"><span class="quoted">"skl1_inv1 <span class="main">∩</span> skl1_inv2 <span class="main">⊆</span> skl1_inv3"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>skl1_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> skl1_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x A B Rb Ra<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> 
  <span class="quoted"><span class="quoted">"signalsInit <span class="improper">x</span> <span class="main">(</span>Commit <span class="improper">A</span> <span class="improper">B</span> 
     <span class="main">⟨</span>NonceF <span class="main">(</span><span class="improper">Ra</span> <span class="main">$</span> ni<span class="main">)</span><span class="main">,</span> NonceF <span class="main">(</span><span class="improper">Rb</span> <span class="main">$</span> nr<span class="main">)</span><span class="main">,</span> 
      Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="improper">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="improper">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> skl1_inv1D <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> equalityE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants: Resp authenticates Init›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> commit signal exists for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ni</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span><span class="main"><span class="main">$</span></span>nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  $(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span><span class="main"><span class="main">$</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
  then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, has finished its run, and has the nonce <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ni</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
  $(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span><span class="main"><span class="main">$</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ as the key in its frame.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_inv4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"skl1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_inv4</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gnx</span> <span class="bound">Ni</span><span class="main">.</span>
    signalsResp <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span><span class="bound">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="bound">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span>
      guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">∧</span>
      progress <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="bound">gnx</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Rb</span> xni <span class="main">=</span> Some <span class="bound">Ni</span>
   <span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv4I <span class="main">=</span> skl1_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> skl1_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv4D <span class="main">=</span> skl1_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>


<span class="keyword1" id="sklvl1-skl1_inv4_init"><span class="command">lemma</span></span> skl1_inv4_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init skl1 <span class="main">⊆</span> skl1_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_def skl1_init_def skl1_inv4_def<span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_inv4_trans"><span class="command">lemma</span></span> skl1_inv4_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>skl1_inv4<span class="main">}</span> trans skl1 <span class="main">{&gt;</span> skl1_inv4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs skl1_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> skl1_inv4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_inv4_def skl1_defs ik_dy_def domIff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_inj2 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl1-PO_skl1_inv4"><span class="command">lemma</span></span> PO_skl1_inv4 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach skl1 <span class="main">⊆</span> skl1_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has passed step3 then (if possible) a
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> running signal has been emitted.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_inv5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"skl1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_inv5</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">gny</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Nr</span><span class="main">.</span>
    guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="bound">gny</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xnr <span class="main">=</span> Some <span class="bound">Nr</span> <span class="main">⟶</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
      signalsResp <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="bound">Nr</span><span class="main">,</span> Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv5I <span class="main">=</span> skl1_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv5E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> skl1_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv5D <span class="main">=</span> skl1_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>


<span class="keyword1" id="sklvl1-skl1_inv5_init"><span class="command">lemma</span></span> skl1_inv5_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init skl1 <span class="main">⊆</span> skl1_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_def skl1_init_def skl1_inv5_def<span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_inv5_trans"><span class="command">lemma</span></span> skl1_inv5_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>skl1_inv5<span class="main">}</span> trans skl1 <span class="main">{&gt;</span> skl1_inv5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> skl1_inv5I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> can_signal_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_defs ik_dy_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> skl1_inv5D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl1-PO_skl1_inv5"><span class="command">lemma</span></span> PO_skl1_inv5 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach skl1 <span class="main">⊆</span> skl1_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6 (derived)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run before step 4 and an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> run after step 3 both know
  the same half-keys (more or less), then the number of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> running signals
  for the key is strictly greater than the number of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> commit signals.
  (actually, there are 0 commit and 1 running).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">skl1_inv6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"skl1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">skl1_inv6</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Ra</span> <span class="bound">gnx</span> <span class="bound">Ni</span><span class="main">.</span>
    guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xgnx <span class="main">=</span> Some <span class="bound">gnx</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xni <span class="main">=</span> Some <span class="bound">Ni</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
    progress <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">⟶</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
      signalsResp <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span><span class="bound">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="bound">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> 
    <span class="main">&lt;</span> signalsResp <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟨</span><span class="bound">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="bound">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv6I <span class="main">=</span> skl1_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv6E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> skl1_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_inv6D <span class="main">=</span> skl1_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="sklvl1-skl1_inv6_derived"><span class="command">lemma</span></span> skl1_inv6_derived<span class="main">:</span>
  <span class="quoted"><span class="quoted">"skl1_inv4 <span class="main">∩</span> skl1_inv5 <span class="main">⊆</span> skl1_inv6"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> skl1_inv6I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted">skl1_state</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Rb</span> <span class="skolem">Ra</span>
  <span class="keyword3"><span class="command">assume</span></span> HRun<span class="main">:</span><span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Init<span class="main">,</span> owner <span class="main">=</span> <span class="skolem">A</span><span class="main">,</span> partner <span class="main">=</span> <span class="skolem">B</span><span class="main">⦈</span>"</span></span>
              <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="skolem">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> nr<span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> HRb<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="skolem">s</span> <span class="skolem">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> I4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> skl1_inv4"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> I5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> skl1_inv5"</span></span>
  <span class="keyword1"><span class="command">from</span></span> I4 HRb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"signalsResp <span class="skolem">s</span> <span class="main">(</span>Commit <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span>
                      Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> False"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> skl1_inv4D<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">=</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> HC<span class="main">:</span><span class="quoted"><span class="quoted">"signalsResp <span class="skolem">s</span> <span class="main">(</span>Commit <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span>
                      Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> I5 HRun <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"signalsResp <span class="skolem">s</span> <span class="main">(</span>Running <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span>
                      Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> skl1_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> HC <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"signalsResp <span class="skolem">s</span> <span class="main">(</span>Commit <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span>
                      Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="main">&lt;</span> signalsResp <span class="skolem">s</span> <span class="main">(</span>Running <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span>
                      Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement: injective agreement  (Init authenticates Resp)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med0sk1iai</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"skl1_obs <span class="main">⇒</span> a0i_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med0sk1iai</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>a0n_state.signals <span class="main">=</span> signalsInit <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation between states.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R0sk1iai</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a0i_state <span class="main">*</span> skl1_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R0sk1iai</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    a0n_state.signals <span class="bound">s</span> <span class="main">=</span> signalsInit <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol-independent events.›</span></span>

<span class="keyword1" id="sklvl1-skl1_learn_refines_a0_ia_skip_i"><span class="command">lemma</span></span> skl1_learn_refines_a0_ia_skip_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iai<span class="main">}</span> Id<span class="main">,</span> l1_learn <span class="free">m</span> <span class="main">{&gt;</span>R0sk1iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0sk1iai_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_learn_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1" id="sklvl1-skl1_step1_refines_a0i_skip_i"><span class="command">lemma</span></span> skl1_step1_refines_a0i_skip_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iai<span class="main">}</span> Id<span class="main">,</span> skl1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R0sk1iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0sk1iai_def skl1_step1_def<span class="main">)</span>


<span class="keyword1" id="sklvl1-skl1_step2_refines_a0i_running_skip_i"><span class="command">lemma</span></span> skl1_step2_refines_a0i_running_skip_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iai<span class="main">}</span> a0i_running <span class="free">A</span> <span class="free">B</span> <span class="main">⟨</span><span class="free">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span>Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∪</span> Id<span class="main">,</span>
              skl1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R0sk1iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0sk1iai_def<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_step2_def a0i_running_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_step3_refines_a0i_commit_skip_i"><span class="command">lemma</span></span> skl1_step3_refines_a0i_commit_skip_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iai <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> skl1_inv3<span class="main">)</span><span class="main">}</span>
      a0i_commit <span class="free">A</span> <span class="free">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free">Nr</span><span class="main">,</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∪</span> Id<span class="main">,</span>
      skl1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span>
   <span class="main">{&gt;</span>R0sk1iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0sk1iai_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_step3_def a0i_commit_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> skl1_inv3D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl1-skl1_step4_refines_a0i_skip_i"><span class="command">lemma</span></span> skl1_step4_refines_a0i_skip_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iai<span class="main">}</span> Id<span class="main">,</span> skl1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R0sk1iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0sk1iai_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_step4_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹refinement proof›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> skl1_trans_refines_a0i_trans_i <span class="main">=</span> 
  skl1_learn_refines_a0_ia_skip_i
  skl1_step1_refines_a0i_skip_i skl1_step2_refines_a0i_running_skip_i
  skl1_step3_refines_a0i_commit_skip_i skl1_step4_refines_a0i_skip_i

<span class="keyword1" id="sklvl1-skl1_refines_init_a0i_i"><span class="command">lemma</span></span> skl1_refines_init_a0i_i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init skl1 <span class="main">⊆</span> R0sk1iai <span class="main">``</span> <span class="main">(</span>init a0i<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R0sk1iai_def a0i_defs skl1_defs<span class="main">)</span>


<span class="keyword1" id="sklvl1-skl1_refines_trans_a0i_i"><span class="command">lemma</span></span> skl1_refines_trans_a0i_i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iai <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>skl1_inv1 <span class="main">∩</span> skl1_inv2<span class="main">)</span><span class="main">)</span><span class="main">}</span> trans a0i<span class="main">,</span> trans skl1 <span class="main">{&gt;</span> R0sk1iai<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pre'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"R0sk1iai <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> skl1_inv3<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span><span class="var">?post</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conseq_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pre</span> <span class="main">⊆</span> <span class="var">?pre'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> skl1_inv3_derived <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre'</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span> <span class="var">?post</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0i_def skl1_def a0i_trans_def skl1_trans_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> skl1_step2_refines_a0i_running_skip_i <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> skl1_step3_refines_a0i_commit_skip_i <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>skl1_trans_refines_a0i_trans_i<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="sklvl1-obs_consistent_med01iai"><span class="command">lemma</span></span> obs_consistent_med01iai <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R0sk1iai med0sk1iai a0i skl1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R0sk1iai_def med0sk1iai_def<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹refinement result›</span></span>
<span class="keyword1" id="sklvl1-skl1_refines_a0i_i"><span class="command">lemma</span></span> skl1_refines_a0i_i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R0sk1iai <span class="main">∩</span> <span class="main">(</span>reach a0i <span class="main">×</span> <span class="main">(</span>skl1_inv1 <span class="main">∩</span> skl1_inv2<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med0sk1iai a0i skl1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_implements_a0i_i"><span class="command">lemma</span></span>  skl1_implements_a0i_i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med0sk1iai a0i skl1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants: injective agreement (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authenticates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="sklvl1-skl1_obs_iagreement_Init"><span class="command">lemma</span></span> skl1_obs_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach skl1 <span class="main">⊆</span> l1_iagreement_Init"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_a0i_obs_agreement _ skl1_implements_a0i_i<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med0sk1iai_def l1_iagreement_Init_def a0i_agreement_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl1-skl1_iagreement_Init"><span class="command">lemma</span></span> skl1_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach skl1 <span class="main">⊆</span> l1_iagreement_Init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> skl1_obs_iagreement_Init<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement: injective agreement  (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authenticates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med0sk1iar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"skl1_obs <span class="main">⇒</span> a0i_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med0sk1iar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>a0n_state.signals <span class="main">=</span> signalsResp <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation between states.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R0sk1iar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a0i_state <span class="main">*</span> skl1_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R0sk1iar</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    a0n_state.signals <span class="bound">s</span> <span class="main">=</span> signalsResp <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol independent events.›</span></span>

<span class="keyword1" id="sklvl1-skl1_learn_refines_a0_ia_skip_r"><span class="command">lemma</span></span> skl1_learn_refines_a0_ia_skip_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iar<span class="main">}</span> Id<span class="main">,</span> l1_learn <span class="free">m</span> <span class="main">{&gt;</span>R0sk1iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0sk1iar_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l1_learn_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1" id="sklvl1-skl1_step1_refines_a0i_skip_r"><span class="command">lemma</span></span> skl1_step1_refines_a0i_skip_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iar<span class="main">}</span> Id<span class="main">,</span> skl1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R0sk1iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0sk1iar_def skl1_step1_def<span class="main">)</span>


<span class="keyword1" id="sklvl1-skl1_step2_refines_a0i_skip_r"><span class="command">lemma</span></span> skl1_step2_refines_a0i_skip_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iar<span class="main">}</span> Id<span class="main">,</span> skl1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R0sk1iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0sk1iar_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>skl1_step2_def<span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_step3_refines_a0i_running_skip_r"><span class="command">lemma</span></span> skl1_step3_refines_a0i_running_skip_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iar<span class="main">}</span> 
     a0i_running <span class="free">A</span> <span class="free">B</span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free">Nr</span><span class="main">,</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∪</span> Id<span class="main">,</span> 
     skl1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span> 
   <span class="main">{&gt;</span>R0sk1iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0sk1iar_def<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_step3_def a0i_running_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_step4_refines_a0i_commit_skip_r"><span class="command">lemma</span></span> skl1_step4_refines_a0i_commit_skip_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iar <span class="main">∩</span> UNIV<span class="main">×</span>skl1_inv6<span class="main">}</span> 
      a0i_commit <span class="free">A</span> <span class="free">B</span> <span class="main">⟨</span><span class="free">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∪</span> Id<span class="main">,</span>
      skl1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> 
   <span class="main">{&gt;</span>R0sk1iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0sk1iar_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_step4_def a0i_commit_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> skl1_inv6D <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> skl1_trans_refines_a0i_trans_r <span class="main">=</span> 
  skl1_learn_refines_a0_ia_skip_r
  skl1_step1_refines_a0i_skip_r skl1_step2_refines_a0i_skip_r
  skl1_step3_refines_a0i_running_skip_r skl1_step4_refines_a0i_commit_skip_r

<span class="keyword1" id="sklvl1-skl1_refines_init_a0i_r"><span class="command">lemma</span></span> skl1_refines_init_a0i_r <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init skl1 <span class="main">⊆</span> R0sk1iar <span class="main">``</span> <span class="main">(</span>init a0i<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R0sk1iar_def a0i_defs skl1_defs<span class="main">)</span>


<span class="keyword1" id="sklvl1-skl1_refines_trans_a0i_r"><span class="command">lemma</span></span> skl1_refines_trans_a0i_r <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0sk1iar <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>skl1_inv4 <span class="main">∩</span> skl1_inv5<span class="main">)</span><span class="main">)</span><span class="main">}</span> trans a0i<span class="main">,</span> trans skl1 <span class="main">{&gt;</span> R0sk1iar<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pre'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"R0sk1iar <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> skl1_inv6<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span><span class="var">?post</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conseq_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pre</span> <span class="main">⊆</span> <span class="var">?pre'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> skl1_inv6_derived <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre'</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span> <span class="var">?post</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0i_def skl1_def a0i_trans_def skl1_trans_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command">using</span></span> skl1_step3_refines_a0i_running_skip_r <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command">using</span></span> skl1_step4_refines_a0i_commit_skip_r <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>skl1_trans_refines_a0i_trans_r<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="sklvl1-obs_consistent_med0sk1iar"><span class="command">lemma</span></span> obs_consistent_med0sk1iar <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R0sk1iar med0sk1iar a0i skl1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R0sk1iar_def med0sk1iar_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1" id="sklvl1-skl1_refines_a0i_r"><span class="command">lemma</span></span> skl1_refines_a0i_r <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R0sk1iar <span class="main">∩</span> <span class="main">(</span>reach a0i <span class="main">×</span> <span class="main">(</span>skl1_inv4 <span class="main">∩</span> skl1_inv5<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med0sk1iar a0i skl1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="sklvl1-skl1_implements_a0i_r"><span class="command">lemma</span></span>  skl1_implements_a0i_r <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med0sk1iar a0i skl1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants: injective agreement (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> authenticates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="sklvl1-skl1_obs_iagreement_Resp"><span class="command">lemma</span></span> skl1_obs_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach skl1 <span class="main">⊆</span> l1_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_a0i_obs_agreement _ skl1_implements_a0i_r<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med0sk1iar_def l1_iagreement_Resp_def a0i_agreement_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl1-skl1_iagreement_Resp"><span class="command">lemma</span></span> skl1_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach skl1 <span class="main">⊆</span> l1_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> skl1_obs_iagreement_Resp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="sklvl2">
<div class="head">
<h1>Theory sklvl2</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  sklvl2.thy (Isabelle/HOL 2016-1)
  ID:      $Id: sklvl2.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-2 SKEME/IKEv1 channel protocol using confidential channels and 
  dynamically keyed HMACs. Refines model sklvl1.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹SKEME Protocol (L2)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> sklvl2
<span class="keyword2"><span class="keyword">imports</span></span> <a href="sklvl1.html">sklvl1</a> <a href="Channels.html">Channels</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and Events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initial compromise.›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  bad_init <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span> 

<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">bad_init</span><span class="main">)</span>
  bad_init_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"test_owner <span class="main">∉</span> bad_init <span class="main">∧</span> test_partner <span class="main">∉</span> bad_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Level 2 state.›</span></span>

<span class="keyword1"><span class="command">record</span></span> l2_state <span class="main">=</span> 
  <span class="quoted">skl1_state</span> <span class="main">+</span>
  chan <span class="main">::</span> <span class="quoted"><span class="quoted">"chan set"</span></span>
  bad <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> l2_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"l2_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l2_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l2_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l2_state <span class="main">×</span> l2_state<span class="main">)</span> set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Attacker events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_dy_fake_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_dy_fake_msg</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∈</span> dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_dy_fake_chan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chan <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_dy_fake_chan</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> dy_fake_chan <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>chan <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">}</span> <span class="main">∪</span> chan <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Partnering.›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">role_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> role_t"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">role_comp</span> Init <span class="main">=</span> Resp"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">role_comp</span> Resp <span class="main">=</span> Init"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">matching</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"frame <span class="main">⇒</span> frame <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">matching</span> <span class="free"><span class="bound"><span class="entity">sigma</span></span></span> <span class="free"><span class="bound"><span class="entity">sigma'</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">sigma</span></span></span> <span class="main">∩</span> dom <span class="free"><span class="bound"><span class="entity">sigma'</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">sigma</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sigma'</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partner_runs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> rid_t <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partner_runs</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">R'</span></span></span> <span class="main">≡</span> 
    role <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">=</span> role_comp <span class="main">(</span>role <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    owner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">=</span> partner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span> <span class="main">∧</span>
    owner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span> <span class="main">=</span> partner <span class="main">(</span>guessed_runs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">∧</span>
    matching <span class="main">(</span>guessed_frame <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span>guessed_frame <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span>
  "</span></span>

<span class="keyword1" id="sklvl2-role_comp_inv"><span class="command">lemma</span></span> role_comp_inv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"role_comp <span class="main">(</span>role_comp <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="sklvl2-role_comp_inv_eq"><span class="command">lemma</span></span> role_comp_inv_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> role_comp <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> role_comp <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> role_comp.elims <span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">partners</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partners</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">R</span><span class="main">.</span> partner_runs test <span class="bound">R</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="sklvl2-test_not_partner"><span class="command">lemma</span></span> test_not_partner <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"test <span class="main">∉</span> partners"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partners_def partner_runs_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs test<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="sklvl2-matching_symmetric"><span class="command">lemma</span></span> matching_symmetric<span class="main">:</span>
  <span class="quoted"><span class="quoted">"matching <span class="free">sigma</span> <span class="free">sigma'</span> <span class="main">⟹</span> matching <span class="free">sigma'</span> <span class="free">sigma</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>

<span class="keyword1" id="sklvl2-partner_symmetric"><span class="command">lemma</span></span> partner_symmetric<span class="main">:</span>
  <span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R'</span> <span class="main">⟹</span> partner_runs <span class="free">R'</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def matching_symmetric<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The unicity of the parther is actually protocol dependent:
it only holds if there are generated fresh nonces (which identify the runs) in the frames›</span></span>
<span class="keyword1" id="sklvl2-partner_unique"><span class="command">lemma</span></span> partner_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R''</span> <span class="main">⟹</span> partner_runs <span class="free">R</span> <span class="free">R'</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="main">=</span> <span class="free">R''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H'<span class="main">:</span><span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Hm'<span class="main">:</span> <span class="quoted"><span class="quoted">"matching <span class="main">(</span>guessed_frame <span class="free">R</span><span class="main">)</span> <span class="main">(</span>guessed_frame <span class="free">R'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> H''<span class="main">:</span><span class="quoted"><span class="quoted">"partner_runs <span class="free">R</span> <span class="free">R''</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Hm''<span class="main">:</span> <span class="quoted"><span class="quoted">"matching <span class="main">(</span>guessed_frame <span class="free">R</span><span class="main">)</span> <span class="main">(</span>guessed_frame <span class="free">R''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R'</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Init
      <span class="keyword1"><span class="command">with</span></span> H' partner_symmetric <span class="main">[</span><span class="operator">OF</span> H''<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> Hrole<span class="main">:</span><span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Resp"</span></span>
                                                    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R''</span><span class="main">)</span> <span class="main">=</span> Init"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Init Hm' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R'</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Hrole Hm'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R''</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Gen_inj<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Resp
      <span class="keyword1"><span class="command">with</span></span> H' partner_symmetric <span class="main">[</span><span class="operator">OF</span> H''<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> Hrole<span class="main">:</span><span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R</span><span class="main">)</span> <span class="main">=</span> Init"</span></span>
                                                    <span class="quoted"><span class="quoted">"role <span class="main">(</span>guessed_runs <span class="free">R''</span><span class="main">)</span> <span class="main">=</span> Resp"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partner_runs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Resp Hm' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R'</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Hrole Hm'' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">R''</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Gen_inj<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="sklvl2-partner_test"><span class="command">lemma</span></span> partner_test<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∈</span> partners <span class="main">⟹</span> partner_runs <span class="free">R</span> <span class="free">R'</span> <span class="main">⟹</span> <span class="free">R'</span> <span class="main">=</span> test"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>partner_unique <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>partners_def partner_symmetric<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹compromising events›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_lkr_others</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_lkr_others</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_lkr_actor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_lkr_actor</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_lkr_after</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_lkr_after</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    test_ended <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_skr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_skr</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≠</span> test <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∉</span> partners <span class="main">∧</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> xsk <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">R</span></span></span> xsk <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events (with $K=H(ni, nr)$):
\begin{itemize}
\item step 1: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  confidentially sends <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  computes and insecurely sends $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 2: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (confidentially)
  and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ (insecurely),
  generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  confidentially sends <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, insecurely sends $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and
  $MAC_K(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)$
  computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  emits a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 3: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> confidentially,
  and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and the MAC insecurely,
  sends $MAC_K(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)$
  insecurely, computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$, emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 4: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives the MAC insecurely,
  emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\end{itemize}
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
    <span class="entity">l2_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xgnx<span class="main">}</span><span class="main">)</span><span class="main">,</span>
      chan <span class="main">:=</span> <span class="main">{</span>Confid <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> 
             <span class="main">(</span><span class="main">{</span>Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
              <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xni <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    Confid <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>
    Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgny<span class="main">,</span> xgnx<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            chan <span class="main">:=</span> <span class="main">{</span>Confid <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
                   <span class="main">(</span><span class="main">{</span>Insec <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> 
                       <span class="main">⟨</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span>
                        hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟩</span>
                             <span class="main">(</span>Hash <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ni</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span> <span class="main">}</span> <span class="main">∪</span> 
                    <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ni</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit <span class="bound">s</span><span class="main">,</span>
            signalsInit2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit2 <span class="bound">s</span>
         <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>  


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xgnx<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xgny <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xnr <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Nr</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    Confid <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>
    Insec <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">gny</span></span></span><span class="main">,</span> hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟩</span>
                         <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            chan <span class="main">:=</span> <span class="main">{</span>Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> 
                       <span class="main">(</span>hmac <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟩</span>
                             <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> 
                    <span class="main">∪</span> chan <span class="bound">s</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit <span class="bound">s</span><span class="main">,</span>
            signalsInit2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit2 <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp <span class="bound">s</span><span class="main">,</span>
            signalsResp2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp2 <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> msg <span class="main">⇒</span> l2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_step4</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xni <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="main">∧</span>
    Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>hmac <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟩</span>
                    <span class="main">(</span>Hash <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ni</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ni</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp <span class="bound">s</span><span class="main">,</span>
            signalsResp2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp2 <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹specification›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
    ik <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    secret <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    progress <span class="main">=</span> Map.empty<span class="main">,</span>
    signalsInit <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsResp <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsInit2 <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsResp2 <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    chan <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    bad <span class="main">=</span> bad_init
    <span class="main">⦈</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">m</span> <span class="bound">M</span> <span class="bound">X</span> <span class="bound">Rb</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">K</span> <span class="bound">Y</span><span class="main">.</span>
     l2_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     l2_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="main">∪</span>
     l2_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="main">∪</span>
     l2_step4 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="main">∪</span>
     l2_dy_fake_chan <span class="bound">M</span> <span class="main">∪</span>
     l2_dy_fake_msg <span class="bound">m</span> <span class="main">∪</span>
     l2_lkr_others <span class="bound">A</span> <span class="main">∪</span>
     l2_lkr_after <span class="bound">A</span> <span class="main">∪</span>
     l2_skr <span class="bound">Ra</span> <span class="bound">K</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l2_state<span class="main">,</span> l2_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> l2_init<span class="main">,</span>
    trans <span class="main">=</span> l2_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_loc_defs <span class="main">=</span> 
  l2_step1_def l2_step2_def l2_step3_def l2_step4_def
  l2_def l2_init_def l2_trans_def
  l2_dy_fake_chan_def l2_dy_fake_msg_def
  l2_lkr_after_def l2_lkr_others_def l2_skr_def

<span class="keyword1"><span class="command">lemmas</span></span> l2_defs <span class="main">=</span> l2_loc_defs ik_dy_def

<span class="keyword1"><span class="command">lemmas</span></span> l2_nostep_defs <span class="main">=</span> l2_def l2_init_def l2_trans_def
<span class="keyword1"><span class="command">lemmas</span></span> l2_step_defs <span class="main">=</span> 
  l2_step1_def l2_step2_def l2_step3_def l2_step4_def 
  l2_dy_fake_chan_def l2_dy_fake_msg_def l2_lkr_after_def l2_lkr_others_def l2_skr_def

<span class="keyword1" id="sklvl2-l2_obs_id"><span class="command">lemma</span></span> l2_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs l2 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once a run is finished, it stays finished, therefore if the test is not finished at some
point then it was not finished before either.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
<span class="keyword1" id="sklvl2-l2_run_ended_trans"><span class="command">lemma</span></span> l2_run_ended_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_ended <span class="main">(</span>progress <span class="free">s</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2 <span class="main">⟹</span>
   run_ended <span class="main">(</span>progress <span class="free">s'</span> <span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="sklvl2-l2_can_signal_trans"><span class="command">lemma</span></span> l2_can_signal_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"can_signal <span class="free">s'</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2 <span class="main">⟹</span>
  can_signal <span class="free">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def l2_run_ended_trans<span class="main">)</span>

<span class="keyword1" id="sklvl2-in_progressS_trans"><span class="command">lemma</span></span> in_progressS_trans<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="free">s</span> <span class="free">R</span><span class="main">)</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2 <span class="main">⟹</span> in_progressS <span class="main">(</span>progress <span class="free">s'</span> <span class="free">R</span><span class="main">)</span> <span class="free">S</span>"</span></span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs domIff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">A</span></span> <span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
(i.e., <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are the test session agents and the test 
is not finished), then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are honest.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv1</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>
    can_signal <span class="bound">s</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟶</span>
    <span class="bound">A</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv1I <span class="main">=</span> l2_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv1D <span class="main">=</span> l2_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="sklvl2-l2_inv1_init"><span class="command">lemma</span></span> l2_inv1_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv1_def can_signal_def bad_init_spec<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_inv1_trans"><span class="command">lemma</span></span> l2_inv1_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv1<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv1I  <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">l2_state</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
  <span class="keyword3"><span class="command">assume</span></span> HI<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span>  
  <span class="keyword3"><span class="command">assume</span></span> HT<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s'</span> <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> HT <span class="keyword1"><span class="command">have</span></span> HS<span class="main">:</span><span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_can_signal_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> HI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> bad <span class="skolem">s</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">∉</span> bad <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> HS HT <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> bad <span class="skolem">s'</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">∉</span> bad <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs can_signal_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="sklvl2-PO_l2_inv1"><span class="command">lemma</span></span> PO_l2_inv1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For a run <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (with any role), the session key is always
$something^n$ where $n$ is a nonce generated by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">R</span><span class="main">.</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">R</span><span class="main">)</span> xsk <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">X</span> <span class="bound">N</span><span class="main">.</span>
      guessed_frame <span class="bound">R</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">X</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R</span><span class="main">$</span><span class="bound">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv2I <span class="main">=</span> l2_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv2D <span class="main">=</span> l2_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="sklvl2-l2_inv2_init"><span class="command">lemma</span></span> l2_inv2_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv2_def<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_inv2_trans"><span class="command">lemma</span></span> l2_inv2_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv2<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-PO_l2_inv2"><span class="command">lemma</span></span> PO_l2_inv2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bad_runs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">R</span><span class="main">.</span> owner <span class="main">(</span>guessed_runs <span class="bound">R</span><span class="main">)</span> <span class="main">∈</span> bad <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> partner <span class="main">(</span>guessed_runs <span class="bound">R</span><span class="main">)</span> <span class="main">∈</span> bad <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">generators</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state <span class="main">⇒</span> msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">generators</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> 
     <span class="comment1">― ‹from the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>insec›</span></span> messages in steps 1 2›</span>
     <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp Gen <span class="main">(</span>Nonce <span class="bound">N</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> 
     <span class="comment1">― ‹from the opened <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>confid›</span></span> messages in steps 1 2›</span>
     <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">R</span> <span class="main">∈</span> bad_runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="bound">R</span><span class="main">$</span>ni<span class="main">)</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="bound">R</span><span class="main">$</span>nr<span class="main">)</span><span class="main">}</span> <span class="main">∪</span> 
     <span class="comment1">― ‹from the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>insec›</span></span> messages in steps 2 3›</span>
     <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="bound">y'</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> hmac <span class="main">⟨</span><span class="bound">y</span><span class="main">,</span> <span class="bound">y'</span><span class="main">⟩</span> <span class="main">(</span>Hash <span class="bound">z</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> 
     <span class="comment1">― ‹from the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>skr›</span></span>›</span>
     <span class="main">{</span>Exp <span class="bound">y</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R</span><span class="main">$</span><span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">y</span> <span class="bound">N</span> <span class="bound">R</span><span class="main">.</span> <span class="bound">R</span> <span class="main">≠</span> test <span class="main">∧</span> <span class="bound">R</span> <span class="main">∉</span> partners<span class="main">}</span>"</span></span> 

<span class="keyword1" id="sklvl2-analz_generators"><span class="command">lemma</span></span> analz_generators<span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>generators <span class="free">s</span><span class="main">)</span> <span class="main">=</span> generators <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> analz.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">faked_chan_msgs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state <span class="main">⇒</span> chan set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">faked_chan_msgs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> 
     <span class="main">{</span>Chan <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>ik <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>chan <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">chan_generators</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chan set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chan_generators</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span> <span class="bound">R</span><span class="main">.</span> <span class="comment1">― ‹the messages that can't be opened›</span>
     <span class="bound">x</span> <span class="main">=</span> Confid <span class="main">(</span>owner <span class="main">(</span>guessed_runs <span class="bound">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>partner <span class="main">(</span>guessed_runs <span class="bound">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R</span><span class="main">$</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
     <span class="main">(</span><span class="bound">n</span> <span class="main">=</span> ni <span class="main">∨</span> <span class="bound">n</span> <span class="main">=</span> nr<span class="main">)</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    extr <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>generators <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    chan <span class="bound">s</span> <span class="main">⊆</span> faked_chan_msgs <span class="bound">s</span> <span class="main">∪</span> chan_generators
  <span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3_aux_defs <span class="main">=</span> faked_chan_msgs_def chan_generators_def
  
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3I <span class="main">=</span> l2_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3E <span class="main">=</span> l2_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3D <span class="main">=</span> l2_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
 
<span class="keyword1" id="sklvl2-l2_inv3_init"><span class="command">lemma</span></span> l2_inv3_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv3_def<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_inv3_step1"><span class="command">lemma</span></span> l2_inv3_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3<span class="main">}</span> l2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs bad_runs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone 
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"chan <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-l2_inv3_step2"><span class="command">lemma</span></span> l2_inv3_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3<span class="main">}</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bad_runs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs<span class="main">)</span>        <span class="comment1">― ‹SLOW, ca. 30s›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone analz.intros insert_iff synth_analz_increasing
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"chan <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-l2_inv3_step3"><span class="command">lemma</span></span> l2_inv3_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3<span class="main">}</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span> <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs bad_runs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"chan <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-l2_inv3_step4"><span class="command">lemma</span></span> l2_inv3_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3<span class="main">}</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bad_runs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>synth_analz_increasing <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"chan <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-l2_inv3_dy_fake_msg"><span class="command">lemma</span></span> l2_inv3_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3<span class="main">}</span> l2_dy_fake_msg <span class="free">M</span> <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs extr_insert_IK_eq 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3E dy_fake_msg_extr <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fake_New
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing fake_monotone dy_fake_msg_monotone 
                   dy_fake_msg_insert_chan  
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bad_runs_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone 
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"chan <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="sklvl2-l2_inv3_dy_fake_chan"><span class="command">lemma</span></span> l2_inv3_dy_fake_chan<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3<span class="main">}</span> l2_dy_fake_chan <span class="free">M</span> <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bad_runs_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3E
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>dy_fake_msg_extr <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
                 dy_fake_chan_extr_insert <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
                 dy_fake_chan_mono2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs dy_fake_chan_def dy_fake_msg_def<span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">erule</span> fake.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone 
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"chan <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-l2_inv3_lkr_others"><span class="command">lemma</span></span> l2_inv3_lkr_others<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3<span class="main">}</span> l2_lkr_others <span class="free">A</span> <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> extr_insert_bad <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs bad_runs_def 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing synth_analz_monotone<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_analz_mono <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> G<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"extr <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span>
       <span class="main">(</span><span class="operator">drule</span> rev_subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"chan <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">drule</span> rev_subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>extr <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-l2_inv3_lkr_after"><span class="command">lemma</span></span> l2_inv3_lkr_after<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3<span class="main">}</span> l2_lkr_after <span class="free">A</span> <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> extr_insert_bad <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs bad_runs_def 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing synth_analz_monotone<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_analz_mono <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> G<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"extr <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span>
       <span class="main">(</span><span class="operator">drule</span> rev_subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"chan <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">drule</span> rev_subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>extr <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 
<span class="keyword1" id="sklvl2-l2_inv3_skr"><span class="command">lemma</span></span> l2_inv3_skr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3 <span class="main">∩</span> l2_inv2<span class="main">}</span> l2_skr <span class="free">R</span> <span class="free">K</span> <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_defs  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs bad_runs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_increasing   
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"chan <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3_trans_aux <span class="main">=</span>
  l2_inv3_step1 l2_inv3_step2 l2_inv3_step3 l2_inv3_step4
  l2_inv3_dy_fake_msg l2_inv3_dy_fake_chan
  l2_inv3_lkr_others l2_inv3_lkr_after l2_inv3_skr

<span class="keyword1" id="sklvl2-l2_inv3_trans"><span class="command">lemma</span></span> l2_inv3_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv3 <span class="main">∩</span> l2_inv2<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>l2_inv3_trans_aux<span class="main">)</span>

<span class="keyword1" id="sklvl2-PO_l2_inv3"><span class="command">lemma</span></span> PO_l2_inv3 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l2_inv2"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary dest rule for inv3.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv3D_aux <span class="main">=</span>
  l2_inv3D <span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">,</span>
            <span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> subset_trans<span class="main">,</span>
            <span class="operator">THEN</span> synth_analz_mono<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span>
            <span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">OF</span> IK_subset_extr<span class="main">]</span>

<span class="keyword1" id="sklvl2-l2_inv3D_HashNonce1"><span class="command">lemma</span></span> l2_inv3D_HashNonce1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv3 <span class="main">⟹</span>
   Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span><span class="free">N</span><span class="main">)</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">R</span> <span class="main">∈</span> bad_runs <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> l2_inv3D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> synth_analz_monotone<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_generators<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-l2_inv3D_HashNonce2"><span class="command">lemma</span></span> l2_inv3D_HashNonce2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv3 <span class="main">⟹</span>
   Hash <span class="main">⟨</span><span class="free">X</span><span class="main">,</span> NonceF <span class="main">(</span><span class="free">R</span><span class="main">$</span><span class="free">N</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">R</span> <span class="main">∈</span> bad_runs <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> l2_inv3D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> synth_analz_monotone<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_generators<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹hmac preservation lemmas›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">s</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s'</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> trans l2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then the MACs (with secret keys) that the attacker knows in
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (overapproximated by those in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"parts <span class="main"><span class="main">(</span></span>extr <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s'</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s'</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s'</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)
  are already known in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, except in the case of the steps 2 and 3 of the protocol.
›</span></span>

<span class="keyword1" id="sklvl2-hmac_key_unknown"><span class="command">lemma</span></span> hmac_key_unknown<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">K</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⟹</span> hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="sklvl2-parts_exp"><span class="command">lemma</span></span> parts_exp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"parts <span class="main">{</span>Exp <span class="free">X</span> <span class="free">Y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>Exp <span class="free">X</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="sklvl2-hmac_trans_1_4_skr_extr_fake"><span class="command">lemma</span></span> hmac_trans_1_4_skr_extr_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">K</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="comment1">― ‹necessary for the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>dy_fake_msg›</span></span> case›</span>
   <span class="free">s</span> <span class="main">∈</span> l2_inv2 <span class="main">⟹</span> <span class="comment1">― ‹necessary for the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>skr›</span></span> case›</span>
   <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">∪</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">∪</span> l2_skr <span class="free">R</span> <span class="free">KK</span> <span class="main">∪</span> 
             l2_dy_fake_msg <span class="free">M</span> <span class="main">∪</span> l2_dy_fake_chan <span class="free">MM</span> <span class="main">⟹</span>
     hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"extr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> 
                              parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"insert <span class="main">_</span> <span class="main">(</span>extr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l2_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>dy_fake_chan_extr_insert_parts <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
                  parts_monotone <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">M</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_msg_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-hmac_trans_2"><span class="command">lemma</span></span> hmac_trans_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">⟹</span>
   hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
   <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="free">gnx</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">⟩</span> <span class="main">∧</span>
    <span class="free">K</span> <span class="main">=</span> Hash <span class="main">⟨</span><span class="free">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span> <span class="main">∧</span>
    guessed_runs <span class="free">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free">B</span><span class="main">,</span> partner<span class="main">=</span><span class="free">A</span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="free">s'</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free">Rb</span> xgnx <span class="main">=</span> Some <span class="free">gnx</span> <span class="main">∧</span>
    guessed_frame <span class="free">Rb</span> xni <span class="main">=</span> Some <span class="free">Ni</span> <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"extr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> 
                              parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"insert <span class="main">_</span> <span class="main">(</span>extr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-hmac_trans_3"><span class="command">lemma</span></span> hmac_trans_3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span> <span class="main">⟹</span>
   hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
   <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> <span class="free">gny</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">⟩</span> <span class="main">∧</span>
    <span class="free">K</span> <span class="main">=</span> Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free">Nr</span><span class="main">⟩</span> <span class="main">∧</span>
    guessed_runs <span class="free">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free">A</span><span class="main">,</span> partner<span class="main">=</span><span class="free">B</span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="free">s'</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free">Ra</span> xgny <span class="main">=</span> Some <span class="free">gny</span> <span class="main">∧</span>
    guessed_frame <span class="free">Ra</span> xnr <span class="main">=</span> Some <span class="free">Nr</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"extr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> 
                              parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"insert <span class="main">_</span> <span class="main">(</span>extr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-hmac_trans_lkr_aux"><span class="command">lemma</span></span> hmac_trans_lkr_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> Chan <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> chan <span class="free">s</span><span class="main">}</span> <span class="main">⟹</span>
   <span class="free">K</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">s</span> <span class="main">∈</span> l2_inv3 <span class="main">⟹</span>
   hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv3"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">{</span><span class="bound">M</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> Chan <span class="bound">x</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> chan <span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> H<span class="main">:</span><span class="quoted"><span class="quoted">"hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">{</span><span class="skolem">M</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H'<span class="main">:</span><span class="quoted"><span class="quoted">"Chan <span class="skolem">x</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">M</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> parts_singleton<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv3"</span></span>
  <span class="keyword1"><span class="command">with</span></span> H' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> range Nonce  <span class="main">∨</span> <span class="skolem">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_inv3_aux_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> H <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">M</span><span class="main">}</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"parts <span class="main">{</span><span class="skolem">M</span><span class="main">}</span> <span class="main">⊆</span> parts <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
 

<span class="keyword1" id="sklvl2-hmac_trans_lkr"><span class="command">lemma</span></span> hmac_trans_lkr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">K</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">s</span> <span class="main">∈</span> l2_inv3 <span class="main">⟹</span> 
   <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> l2_lkr_others <span class="free">A</span> <span class="main">∪</span> l2_lkr_after <span class="free">A</span> <span class="main">⟹</span>
   hmac <span class="free">X</span> <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_monotone <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ extr_insert_bad<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parts_monotone <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>hmac_trans_lkr_aux<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> hmac_trans <span class="main">=</span> hmac_trans_1_4_skr_extr_fake hmac_trans_lkr hmac_trans_2 hmac_trans_3



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4 (authentication guard)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If HMAC is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"parts <span class="main"><span class="main">(</span></span>extr <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
are honest then the message has indeed been sent by a responder run (etc).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv4</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gny</span> <span class="bound">Nr</span><span class="main">.</span>
     hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">gny</span><span class="main">,</span> Agent <span class="bound">B</span><span class="main">,</span> Agent <span class="bound">A</span><span class="main">⟩</span>
        <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="bound">Nr</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
     guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟶</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">Rb</span><span class="main">.</span> guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">∧</span>
             in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xgny <span class="main">=</span> Some <span class="bound">gny</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xnr <span class="main">=</span> Some <span class="bound">Nr</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xni <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4I <span class="main">=</span> l2_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv4D <span class="main">=</span> l2_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="sklvl2-l2_inv4_init"><span class="command">lemma</span></span> l2_inv4_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv4_def<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_inv4_trans"><span class="command">lemma</span></span> l2_inv4_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv4 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv3<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv4I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">l2_state</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">gny</span> <span class="skolem">Nr</span>
  <span class="keyword3"><span class="command">assume</span></span> HHparts<span class="main">:</span><span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">gny</span><span class="main">,</span> Agent <span class="skolem">B</span><span class="main">,</span> Agent <span class="skolem">A</span><span class="main">⟩</span>
             <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> ni<span class="main">)</span><span class="main">,</span> <span class="skolem">Nr</span><span class="main">⟩</span><span class="main">)</span>
       <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="skolem">s'</span><span class="main">)</span> <span class="main">(</span>ik <span class="skolem">s'</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> HRa<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="skolem">A</span><span class="main">,</span> partner<span class="main">=</span><span class="skolem">B</span><span class="main">⦈</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv4"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv2"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv3"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Ht<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> bad <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∉</span> bad <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> Ht <span class="keyword1"><span class="command">have</span></span> Hb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> bad <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∉</span> bad <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> HRa Hi 
  <span class="keyword1"><span class="command">have</span></span> HH<span class="main">:</span><span class="quoted"><span class="quoted">"Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span> ni<span class="main">)</span><span class="main">,</span>  <span class="skolem">Nr</span><span class="main">⟩</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D_HashNonce1 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bad_runs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ht Hi HHparts HH 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">gny</span><span class="main">,</span> Agent <span class="skolem">B</span><span class="main">,</span> Agent <span class="skolem">A</span><span class="main">⟩</span>
             <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> ni<span class="main">)</span><span class="main">,</span> <span class="skolem">Nr</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">∃</span> <span class="bound">Rb</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step2 <span class="bound">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               <span class="skolem">gny</span> <span class="main">=</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               <span class="skolem">Nr</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>nr<span class="main">)</span> <span class="main">∧</span>
               guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="skolem">B</span><span class="main">,</span> partner<span class="main">=</span><span class="skolem">A</span><span class="main">⦈</span> <span class="main">∧</span>
               progress <span class="skolem">s'</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
               guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               guessed_frame <span class="bound">Rb</span> xni <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs<span class="main">)</span>
    <span class="comment1">(*apply (auto dest: hmac_trans) does not work*)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_1_4_skr_extr_fake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_3<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_1_4_skr_extr_fake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_1_4_skr_extr_fake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_1_4_skr_extr_fake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_lkr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_lkr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_1_4_skr_extr_fake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Rb</span><span class="main">.</span> guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Resp<span class="main">,</span> owner <span class="main">=</span> <span class="skolem">B</span><span class="main">,</span> partner <span class="main">=</span> <span class="skolem">A</span><span class="main">⦈</span> <span class="main">∧</span>
            in_progressS <span class="main">(</span>progress <span class="skolem">s'</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
            guessed_frame <span class="bound">Rb</span> xgny <span class="main">=</span> Some <span class="skolem">gny</span> <span class="main">∧</span>
            guessed_frame <span class="bound">Rb</span> xnr <span class="main">=</span> Some <span class="skolem">Nr</span> <span class="main">∧</span>
            guessed_frame <span class="bound">Rb</span> xni <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> ni<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
            guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword3"><span class="command">assume</span></span> 
         <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">gny</span><span class="main">,</span> Agent <span class="skolem">B</span><span class="main">,</span> Agent <span class="skolem">A</span><span class="main">⟩</span> 
               <span class="main">(</span>hmac <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> ni<span class="main">)</span><span class="main">)</span> <span class="skolem">Nr</span><span class="main">)</span>
            <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">with</span></span> Hi Hb HRa <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Rb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
         HRb<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Resp<span class="main">,</span> owner <span class="main">=</span> <span class="skolem">B</span><span class="main">,</span> partner <span class="main">=</span> <span class="skolem">A</span><span class="main">⦈</span>"</span></span>
              <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="skolem">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Rb</span> xgny <span class="main">=</span> Some <span class="skolem">gny</span>"</span></span>
              <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Rb</span> xnr <span class="main">=</span> Some <span class="skolem">Nr</span>"</span></span>
              <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Rb</span> xni <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> ni<span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv4D<span class="main">)</span>
       <span class="keyword1"><span class="command">with</span></span> Ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="skolem">s'</span> <span class="skolem">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_progressS_trans<span class="main">)</span>
       <span class="keyword1"><span class="command">with</span></span> HRb <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="sklvl2-PO_l2_inv4"><span class="command">lemma</span></span> PO_l2_inv4 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l2_inv2 <span class="main">∩</span> l2_inv3"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="sklvl2-auth_guard_step3"><span class="command">lemma</span></span> auth_guard_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv4 <span class="main">⟹</span>
   <span class="free">s</span> <span class="main">∈</span> l2_inv1 <span class="main">⟹</span>
   Insec <span class="free">B</span> <span class="free">A</span> <span class="main">⟨</span><span class="free">gny</span><span class="main">,</span> hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">gny</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">⟩</span>
                        <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free">Nr</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span>
     <span class="main">∈</span> chan <span class="free">s</span> <span class="main">⟹</span>
   guessed_runs <span class="free">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free">A</span><span class="main">,</span> partner<span class="main">=</span><span class="free">B</span><span class="main">⦈</span> <span class="main">⟹</span>
   can_signal <span class="free">s</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∃</span> <span class="bound">Rb</span><span class="main">.</span> guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free">B</span><span class="main">,</span> partner<span class="main">=</span><span class="free">A</span><span class="main">⦈</span> <span class="main">∧</span>
      in_progressS <span class="main">(</span>progress <span class="free">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Rb</span> xgny <span class="main">=</span> Some <span class="free">gny</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Rb</span> xnr <span class="main">=</span> Some <span class="free">Nr</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Rb</span> xni <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv1"</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="free">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> Hb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∉</span> bad <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Insec <span class="free">B</span> <span class="free">A</span> <span class="main">⟨</span><span class="free">gny</span><span class="main">,</span> hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">gny</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">⟩</span>
                        <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free">Nr</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> HH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">gny</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">⟩</span> 
          <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free">Nr</span><span class="main">⟩</span><span class="main">)</span>
       <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv4"</span></span> <span class="quoted"><span class="quoted">"guessed_runs <span class="free">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free">A</span><span class="main">,</span> partner<span class="main">=</span><span class="free">B</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> Hb HH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5 (authentication guard)›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If MAC is in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"parts <span class="main"><span class="main">(</span></span>extr <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  are honest then the message has indeed been sent by an initiator run (etc).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv5</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gnx</span> <span class="bound">Ni</span><span class="main">.</span>
     hmac <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">gnx</span><span class="main">,</span> Agent <span class="bound">A</span><span class="main">,</span> Agent <span class="bound">B</span><span class="main">⟩</span>
        <span class="main">(</span>Hash <span class="main">⟨</span><span class="bound">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
     guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="bound">s</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">Ra</span><span class="main">.</span> guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">∧</span>
             in_progressS <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Ra</span> xgnx <span class="main">=</span> Some <span class="bound">gnx</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Ra</span> xni <span class="main">=</span> Some <span class="bound">Ni</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Ra</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
             guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv5I <span class="main">=</span> l2_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv5E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv5D <span class="main">=</span> l2_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="sklvl2-l2_inv5_init"><span class="command">lemma</span></span> l2_inv5_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv5_def<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_inv5_trans"><span class="command">lemma</span></span> l2_inv5_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv5 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv3<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv5I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">l2_state</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">gnx</span> <span class="skolem">Ni</span>
  <span class="keyword3"><span class="command">assume</span></span> HHparts<span class="main">:</span><span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>Number <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">gnx</span><span class="main">,</span> Agent <span class="skolem">A</span><span class="main">,</span> Agent <span class="skolem">B</span><span class="main">⟩</span>
             <span class="main">(</span>Hash <span class="main">⟨</span><span class="skolem">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
       <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="skolem">s'</span><span class="main">)</span> <span class="main">(</span>ik <span class="skolem">s'</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> HRb<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="skolem">B</span><span class="main">,</span> partner<span class="main">=</span><span class="skolem">A</span><span class="main">⦈</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv5"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv2"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv3"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Ht<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> trans l2"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> bad <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∉</span> bad <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> Ht <span class="keyword1"><span class="command">have</span></span> Hb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∉</span> bad <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∉</span> bad <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> HRb Hi <span class="keyword1"><span class="command">have</span></span> HH<span class="main">:</span><span class="quoted"><span class="quoted">"Hash <span class="main">⟨</span><span class="skolem">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>extr <span class="main">(</span>bad <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D_HashNonce2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bad_runs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ht Hi HHparts HH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">gnx</span><span class="main">,</span> Agent <span class="skolem">A</span><span class="main">,</span> Agent <span class="skolem">B</span><span class="main">⟩</span>
             <span class="main">(</span>Hash <span class="main">⟨</span><span class="skolem">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">∃</span> <span class="bound">Ra</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step3 <span class="bound">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               <span class="skolem">gnx</span> <span class="main">=</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               <span class="skolem">Ni</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>ni<span class="main">)</span> <span class="main">∧</span>
               guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="skolem">A</span><span class="main">,</span> partner<span class="main">=</span><span class="skolem">B</span><span class="main">⦈</span> <span class="main">∧</span>
               progress <span class="skolem">s'</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
               guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               guessed_frame <span class="bound">Ra</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs<span class="main">)</span>
    <span class="comment1">(*apply (auto dest: hmac_trans) does not work*)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_1_4_skr_extr_fake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_3<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_1_4_skr_extr_fake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_1_4_skr_extr_fake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_1_4_skr_extr_fake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_lkr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_lkr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hmac_trans_1_4_skr_extr_fake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Ra</span><span class="main">.</span> guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="skolem">A</span><span class="main">,</span> partner<span class="main">=</span><span class="skolem">B</span><span class="main">⦈</span> <span class="main">∧</span>
            in_progressS <span class="main">(</span>progress <span class="skolem">s'</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
            guessed_frame <span class="bound">Ra</span> xgnx <span class="main">=</span> Some <span class="skolem">gnx</span> <span class="main">∧</span>
            guessed_frame <span class="bound">Ra</span> xni <span class="main">=</span> Some <span class="skolem">Ni</span> <span class="main">∧</span>
            guessed_frame <span class="bound">Ra</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
            guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
       <span class="keyword3"><span class="command">assume</span></span> 
         <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>Number <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">gnx</span><span class="main">,</span> Agent <span class="skolem">A</span><span class="main">,</span> Agent <span class="skolem">B</span><span class="main">⟩</span> 
               <span class="main">(</span>Hash <span class="main">⟨</span><span class="skolem">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
            <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">with</span></span> Hi Hb HRb <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ra</span></span> <span class="keyword2"><span class="keyword">where</span></span> HRa<span class="main">:</span><span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="skolem">A</span><span class="main">,</span> partner<span class="main">=</span><span class="skolem">B</span><span class="main">⦈</span>"</span></span>
            <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="skolem">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>
            <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xgnx <span class="main">=</span> Some <span class="skolem">gnx</span>"</span></span>
            <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xni <span class="main">=</span> Some <span class="skolem">Ni</span>"</span></span>
            <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv5D<span class="main">)</span>
       <span class="keyword1"><span class="command">with</span></span> Ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="skolem">s'</span> <span class="skolem">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_progressS_trans<span class="main">)</span>
       <span class="keyword1"><span class="command">with</span></span> HRa <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="sklvl2-PO_l2_inv5"><span class="command">lemma</span></span> PO_l2_inv5 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l2_inv2 <span class="main">∩</span> l2_inv3"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="sklvl2-auth_guard_step4"><span class="command">lemma</span></span> auth_guard_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv5 <span class="main">⟹</span>
   <span class="free">s</span> <span class="main">∈</span> l2_inv1 <span class="main">⟹</span>
   Insec <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>hmac <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">gnx</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">⟩</span>
                        <span class="main">(</span>Hash <span class="main">⟨</span><span class="free">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
     <span class="main">∈</span> chan <span class="free">s</span> <span class="main">⟹</span>
   guessed_runs <span class="free">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free">B</span><span class="main">,</span> partner<span class="main">=</span><span class="free">A</span><span class="main">⦈</span> <span class="main">⟹</span>
   can_signal <span class="free">s</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∃</span> <span class="bound">Ra</span><span class="main">.</span> guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free">A</span><span class="main">,</span> partner<span class="main">=</span><span class="free">B</span><span class="main">⦈</span> <span class="main">∧</span>
      in_progressS <span class="main">(</span>progress <span class="free">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Ra</span> xgnx <span class="main">=</span> Some <span class="free">gnx</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Ra</span> xni <span class="main">=</span> Some <span class="free">Ni</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Ra</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv1"</span></span> <span class="quoted"><span class="quoted">"can_signal <span class="free">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> Hb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∉</span> bad <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Insec <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>hmac <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">gnx</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">⟩</span>
                        <span class="main">(</span>Hash <span class="main">⟨</span><span class="free">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> HH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"hmac <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">gnx</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">⟩</span> 
          <span class="main">(</span>Hash <span class="main">⟨</span><span class="free">Ni</span><span class="main">,</span> NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
       <span class="main">∈</span> parts <span class="main">(</span>extr <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv5"</span></span> <span class="quoted"><span class="quoted">"guessed_runs <span class="free">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free">B</span><span class="main">,</span> partner<span class="main">=</span><span class="free">A</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> Hb HH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For an initiator, the session key is always $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">gny</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv6</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gny</span><span class="main">.</span>
    guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="bound">A</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">B</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Ra</span><span class="main">)</span> xsk <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="bound">gny</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Ra</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6I <span class="main">=</span> l2_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6D <span class="main">=</span> l2_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="sklvl2-l2_inv6_init"><span class="command">lemma</span></span> l2_inv6_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv6"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv6_def<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_inv6_trans"><span class="command">lemma</span></span> l2_inv6_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv6<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv6<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv6I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-PO_l2_inv6"><span class="command">lemma</span></span> PO_l2_inv6 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv6"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6'›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For a responder, the session key is always $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">gnx</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv6'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv6'</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">gnx</span><span class="main">.</span>
    guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="bound">B</span><span class="main">,</span> partner<span class="main">=</span><span class="bound">A</span><span class="main">⦈</span> <span class="main">⟶</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="bound">Rb</span><span class="main">)</span> xsk <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="bound">gnx</span> <span class="main">⟶</span>
    guessed_frame <span class="bound">Rb</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="bound">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6'I <span class="main">=</span> l2_inv6'_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6'E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv6'_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv6'D <span class="main">=</span> l2_inv6'_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="sklvl2-l2_inv6'_init"><span class="command">lemma</span></span> l2_inv6'_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv6'"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv6'_def<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_inv6'_trans"><span class="command">lemma</span></span> l2_inv6'_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv6'<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv6'<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv6'I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-PO_l2_inv6'"><span class="command">lemma</span></span> PO_l2_inv6' <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv6'"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7: form of the secrets›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_inv7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_inv7</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    secret <span class="bound">s</span> <span class="main">⊆</span> <span class="main">{</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R</span><span class="main">$</span><span class="bound">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R'</span><span class="main">$</span><span class="bound">N'</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">N</span> <span class="bound">N'</span> <span class="bound">R</span> <span class="bound">R'</span><span class="main">.</span>
                  <span class="bound">R</span> <span class="main">=</span> test <span class="main">∧</span> <span class="bound">R'</span> <span class="main">∈</span> partners <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span><span class="main">=</span>nx <span class="main">∨</span> <span class="bound">N</span><span class="main">=</span>ny<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">N'</span><span class="main">=</span>nx <span class="main">∨</span> <span class="bound">N'</span><span class="main">=</span>ny<span class="main">)</span><span class="main">}</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7I <span class="main">=</span> l2_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l2_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l2_inv7D <span class="main">=</span> l2_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="sklvl2-l2_inv7_init"><span class="command">lemma</span></span> l2_inv7_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> l2_inv7"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_init_def l2_inv7_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Steps 3 and 4 are the hard part.›</span></span>

<span class="keyword1" id="sklvl2-l2_inv7_step3"><span class="command">lemma</span></span> l2_inv7_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv1 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv6'<span class="main">}</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="main">::</span> <span class="quoted">l2_state</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv4"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv6'"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Ht<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Hs Ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s</span> <span class="main">∨</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">=</span> test <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi Ht 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span> <span class="bound">N'</span> <span class="bound">R'</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R'</span> <span class="main">$</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
                  <span class="bound">R'</span> <span class="main">∈</span> partners <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span> <span class="main">=</span> nx <span class="main">∨</span> <span class="bound">N</span> <span class="main">=</span> ny<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">N'</span> <span class="main">=</span> nx <span class="main">∨</span> <span class="bound">N'</span> <span class="main">=</span> ny<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv7D <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> Htest<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_runs test <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Init<span class="main">,</span> owner <span class="main">=</span> <span class="free">A</span><span class="main">,</span> partner <span class="main">=</span> <span class="free">B</span><span class="main">⦈</span>"</span></span>
                    <span class="quoted"><span class="quoted">"guessed_frame test xgny <span class="main">=</span> Some <span class="free">gny</span>"</span></span>
                    <span class="quoted"><span class="quoted">"guessed_frame test xnr <span class="main">=</span> Some <span class="free">Nr</span>"</span></span>
                    <span class="quoted"><span class="quoted">"guessed_frame test xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"Insec <span class="free">B</span> <span class="free">A</span> <span class="main">⟨</span><span class="free">gny</span><span class="main">,</span> hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">gny</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">⟩</span>
                              <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span>test<span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free">Nr</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span>
                  <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
        <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Htest Hi <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Rb</span></span> <span class="keyword2"><span class="keyword">where</span></span> HRb<span class="main">:</span>
        <span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free">B</span><span class="main">,</span> partner<span class="main">=</span><span class="free">A</span><span class="main">⦈</span>"</span></span>
        <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="skolem">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">gny</span> <span class="main">=</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">Nr</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>nr<span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Rb</span> xni <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>ni<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> auth_guard_step3<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Hi 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Rb</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv6'D<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> HRb Htest <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Rb</span> <span class="main">∈</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partners_def partner_runs_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> HRb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                        Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Rb</span> <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">Rb</span> <span class="main">∈</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span> <span class="bound">N'</span> <span class="bound">R'</span><span class="main">.</span>
          Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span> <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R'</span> <span class="main">$</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          <span class="bound">R'</span> <span class="main">∈</span> partners <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span> <span class="main">=</span> nx <span class="main">∨</span> <span class="bound">N</span> <span class="main">=</span> ny<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">N'</span> <span class="main">=</span> nx <span class="main">∨</span> <span class="bound">N'</span> <span class="main">=</span> ny<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="sklvl2-l2_inv7_step4"><span class="command">lemma</span></span> l2_inv7_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv1 <span class="main">∩</span> l2_inv5 <span class="main">∩</span> l2_inv6 <span class="main">∩</span> l2_inv6'<span class="main">}</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="main">::</span> <span class="quoted">l2_state</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv5"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv6"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv6'"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Ht<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Hs Ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s</span> <span class="main">∨</span> <span class="main">(</span><span class="free">Rb</span> <span class="main">=</span> test <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi Ht 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span> <span class="bound">N'</span> <span class="bound">R'</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R'</span> <span class="main">$</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">R'</span> <span class="main">∈</span> partners
                                <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span> <span class="main">=</span> nx <span class="main">∨</span> <span class="bound">N</span> <span class="main">=</span> ny<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">N'</span> <span class="main">=</span> nx <span class="main">∨</span> <span class="bound">N'</span> <span class="main">=</span> ny<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv7D <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> Htest<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_runs test <span class="main">=</span> <span class="main">⦇</span>role <span class="main">=</span> Resp<span class="main">,</span> owner <span class="main">=</span> <span class="free">B</span><span class="main">,</span> partner <span class="main">=</span> <span class="free">A</span><span class="main">⦈</span>"</span></span>
                    <span class="quoted"><span class="quoted">"guessed_frame test xgnx <span class="main">=</span> Some <span class="free">gnx</span>"</span></span>
                    <span class="quoted"><span class="quoted">"guessed_frame test xni <span class="main">=</span> Some <span class="free">Ni</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"progress <span class="skolem">s</span> test <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Htest Hi <span class="keyword1"><span class="command">have</span></span> Htest'<span class="main">:</span> <span class="quoted"><span class="quoted">"guessed_frame test xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv6'D<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> 
        <span class="quoted"><span class="quoted">"Insec <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>hmac <span class="main">⟨</span>Number <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">gnx</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">⟩</span>
                         <span class="main">(</span>Hash <span class="main">⟨</span><span class="free">Ni</span><span class="main">,</span> NonceF <span class="main">(</span>test <span class="main">$</span> nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
        <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Hi Htest <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ra</span></span> <span class="keyword2"><span class="keyword">where</span></span> HRa<span class="main">:</span>
        <span class="quoted"><span class="quoted">"guessed_runs <span class="skolem">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free">A</span><span class="main">,</span> partner<span class="main">=</span><span class="free">B</span><span class="main">⦈</span>"</span></span>
        <span class="quoted"><span class="quoted">"in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="skolem">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">gnx</span> <span class="main">=</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">Ni</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>ni<span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>nr<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> auth_guard_step4<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Hi 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="skolem">Ra</span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test<span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv6D<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> HRa Htest Htest' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ra</span> <span class="main">∈</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partners_def partner_runs_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matching_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> HRa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                        Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">Ra</span> <span class="main">$</span> nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">Ra</span> <span class="main">∈</span> partners"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span> <span class="bound">N'</span> <span class="bound">R'</span><span class="main">.</span>
          Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> ny<span class="main">)</span><span class="main">)</span> 
          <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">R'</span> <span class="main">$</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span>test <span class="main">$</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          <span class="bound">R'</span> <span class="main">∈</span> partners <span class="main">∧</span> <span class="main">(</span><span class="bound">N</span> <span class="main">=</span> nx <span class="main">∨</span> <span class="bound">N</span> <span class="main">=</span> ny<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">N'</span> <span class="main">=</span> nx <span class="main">∨</span> <span class="bound">N'</span> <span class="main">=</span> ny<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="sklvl2-l2_inv7_trans"><span class="command">lemma</span></span> l2_inv7_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l2_inv7 <span class="main">∩</span> l2_inv1 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv5 <span class="main">∩</span> l2_inv6 <span class="main">∩</span> l2_inv6'<span class="main">}</span> trans l2 <span class="main">{&gt;</span> l2_inv7<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7_step3 l2_inv7_step4<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs dy_fake_chan_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv7D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-PO_l2_inv7"><span class="command">lemma</span></span> PO_l2_inv7 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_inv7"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l2_inv1 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv5 <span class="main">∩</span> l2_inv6 <span class="main">∩</span> l2_inv6'"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹auxiliary dest rule for inv7›</span></span>
<span class="keyword1" id="sklvl2-Exp_Exp_Gen_synth"><span class="command">lemma</span></span> Exp_Exp_Gen_synth<span class="main">:</span> 
<span class="quoted"><span class="quoted">"Exp <span class="main">(</span>Exp Gen <span class="free">X</span><span class="main">)</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="free">H</span> <span class="main">⟹</span> Exp <span class="main">(</span>Exp Gen <span class="free">X</span><span class="main">)</span> <span class="free">Y</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">∨</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="free">H</span> <span class="main">∨</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> synth.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_inj2<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_inv7_aux"><span class="command">lemma</span></span> l2_inv7_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> l2_inv7 <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∈</span> secret <span class="free">s</span> <span class="main">⟹</span>
   <span class="free">x</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>generators <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_generators <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_synth Exp_Exp_Gen_inj2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med12s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l2_obs <span class="main">⇒</span> skl1_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med12s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    ik <span class="main">=</span> ik <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    secret <span class="main">=</span> secret <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    progress <span class="main">=</span> progress <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsInit <span class="main">=</span> signalsInit <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsResp <span class="main">=</span> signalsResp <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsInit2 <span class="main">=</span> signalsInit2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsResp2 <span class="main">=</span> signalsResp2 <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation between states.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R12s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>skl1_state <span class="main">*</span> l2_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R12s</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">s</span> <span class="main">=</span> med12s <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R12s_defs <span class="main">=</span> R12s_def med12s_def


<span class="keyword1" id="sklvl2-can_signal_R12"><span class="command">lemma</span></span> can_signal_R12 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span> <span class="main">∈</span> R12s <span class="main">⟹</span>
   can_signal <span class="free">s1</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> can_signal <span class="free">s2</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def R12s_defs<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1" id="sklvl2-l2_step1_refines_step1"><span class="command">lemma</span></span> l2_step1_refines_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> skl1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">,</span> l2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs skl1_step1_def l2_step1_def<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_step2_refines_step2"><span class="command">lemma</span></span> l2_step2_refines_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> skl1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span><span class="main">,</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs skl1_step2_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_step2_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹for step3 and 4, we prove the level 1 guard, i.e.,
  "the future session key is not in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>",
  using the fact that inv8 also holds for the future state in which the session key is already in 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"secret <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1" id="sklvl2-l2_step3_refines_step3"><span class="command">lemma</span></span> l2_step3_refines_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv6' <span class="main">∩</span> l2_inv7<span class="main">)</span><span class="main">}</span> 
      skl1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span><span class="main">,</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span> 
   <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv4"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span> l2_inv6'"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Ht<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv3"</span></span>
  <span class="keyword1"><span class="command">with</span></span> Hi Ht l2_inv7_step3 l2_inv3_step3 <span class="keyword1"><span class="command">have</span></span> Hi'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> l2_inv7"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span><span class="main">∈</span> l2_inv3"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ra</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> secret <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ra</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>generators <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv7_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi' <span class="keyword1"><span class="command">have</span></span> G2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Ra</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gny</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ht Hi <span class="keyword1"><span class="command">have</span></span> G1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Rb</span><span class="main">.</span> guessed_runs <span class="bound">Rb</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free">B</span><span class="main">,</span> partner<span class="main">=</span><span class="free">A</span><span class="main">⦈</span> <span class="main">∧</span>
           in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="bound">Rb</span><span class="main">)</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
           <span class="free">gny</span> <span class="main">=</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
           <span class="free">Nr</span> <span class="main">=</span> NonceF <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>nr<span class="main">)</span> <span class="main">∧</span>
           guessed_frame <span class="bound">Rb</span> xgnx <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
           guessed_frame <span class="bound">Rb</span> xni <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Ra</span><span class="main">$</span>ni<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> auth_guard_step3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Ht G1 G2 <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦇</span>ik <span class="main">=</span> ik <span class="skolem">s</span><span class="main">,</span> secret <span class="main">=</span> secret <span class="skolem">s</span><span class="main">,</span> progress <span class="main">=</span> progress <span class="skolem">s</span><span class="main">,</span> 
       signalsInit <span class="main">=</span> signalsInit <span class="skolem">s</span><span class="main">,</span> signalsResp <span class="main">=</span> signalsResp <span class="skolem">s</span><span class="main">,</span>
       signalsInit2 <span class="main">=</span> signalsInit2 <span class="skolem">s</span><span class="main">,</span> signalsResp2 <span class="main">=</span> signalsResp2 <span class="skolem">s</span><span class="main">⦈</span><span class="main">,</span>
      <span class="main">⦇</span>ik <span class="main">=</span> ik <span class="skolem">s'</span><span class="main">,</span> secret <span class="main">=</span> secret <span class="skolem">s'</span><span class="main">,</span> progress <span class="main">=</span> progress <span class="skolem">s'</span><span class="main">,</span>
       signalsInit <span class="main">=</span> signalsInit <span class="skolem">s'</span><span class="main">,</span> signalsResp <span class="main">=</span> signalsResp <span class="skolem">s'</span><span class="main">,</span>
       signalsInit2 <span class="main">=</span> signalsInit2 <span class="skolem">s'</span><span class="main">,</span> signalsResp2 <span class="main">=</span> signalsResp2 <span class="skolem">s'</span><span class="main">⦈</span><span class="main">)</span>
           <span class="main">∈</span> skl1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_step3_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_step3_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="sklvl2-l2_step4_refines_step4"><span class="command">lemma</span></span> l2_step4_refines_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv5 <span class="main">∩</span> l2_inv6 <span class="main">∩</span> l2_inv6' <span class="main">∩</span> l2_inv7<span class="main">)</span><span class="main">}</span> 
      skl1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span><span class="main">,</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span>
   <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> Hi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv5"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv6"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv6'"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Ht<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv3"</span></span>
  <span class="keyword1"><span class="command">with</span></span> Hi Ht l2_inv7_step4 l2_inv3_step4 <span class="keyword1"><span class="command">have</span></span> Hi'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> l2_inv7"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> l2_inv3"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rb</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> secret <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rb</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>generators <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv7_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hi' <span class="keyword1"><span class="command">have</span></span> G2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Rb</span> <span class="main">=</span> test <span class="main">⟶</span> Exp <span class="free">gnx</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv3D_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ht Hi <span class="keyword1"><span class="command">have</span></span> G1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"can_signal <span class="skolem">s</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Ra</span><span class="main">.</span> guessed_runs <span class="bound">Ra</span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free">A</span><span class="main">,</span> partner<span class="main">=</span><span class="free">B</span><span class="main">⦈</span> <span class="main">∧</span>
              in_progressS <span class="main">(</span>progress <span class="skolem">s</span> <span class="bound">Ra</span><span class="main">)</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span> <span class="main">∧</span>
              guessed_frame <span class="bound">Ra</span> xgnx <span class="main">=</span> Some <span class="free">gnx</span> <span class="main">∧</span>
              guessed_frame <span class="bound">Ra</span> xni <span class="main">=</span> Some <span class="free">Ni</span> <span class="main">∧</span>
              guessed_frame <span class="bound">Ra</span> xgny <span class="main">=</span> Some <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
              guessed_frame <span class="bound">Ra</span> xnr <span class="main">=</span> Some <span class="main">(</span>NonceF <span class="main">(</span><span class="free">Rb</span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> auth_guard_step4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Ht G1 G2 <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦇</span>ik <span class="main">=</span> ik <span class="skolem">s</span><span class="main">,</span> secret <span class="main">=</span> secret <span class="skolem">s</span><span class="main">,</span> progress <span class="main">=</span> progress <span class="skolem">s</span><span class="main">,</span>
       signalsInit <span class="main">=</span> signalsInit <span class="skolem">s</span><span class="main">,</span> signalsResp <span class="main">=</span> signalsResp <span class="skolem">s</span><span class="main">,</span>
       signalsInit2 <span class="main">=</span> signalsInit2 <span class="skolem">s</span><span class="main">,</span> signalsResp2 <span class="main">=</span> signalsResp2 <span class="skolem">s</span><span class="main">⦈</span><span class="main">,</span>
      <span class="main">⦇</span>ik <span class="main">=</span> ik <span class="skolem">s'</span><span class="main">,</span> secret <span class="main">=</span> secret <span class="skolem">s'</span><span class="main">,</span> progress <span class="main">=</span> progress <span class="skolem">s'</span><span class="main">,</span>
       signalsInit <span class="main">=</span> signalsInit <span class="skolem">s'</span><span class="main">,</span> signalsResp <span class="main">=</span> signalsResp <span class="skolem">s'</span><span class="main">,</span>
       signalsInit2 <span class="main">=</span> signalsInit2 <span class="skolem">s'</span><span class="main">,</span> signalsResp2 <span class="main">=</span> signalsResp2 <span class="skolem">s'</span><span class="main">⦈</span><span class="main">)</span>
           <span class="main">∈</span> skl1_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_step4_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_step4_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹attacker events›</span></span>
<span class="keyword1" id="sklvl2-l2_dy_fake_chan_refines_skip"><span class="command">lemma</span></span> l2_dy_fake_chan_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> Id<span class="main">,</span> l2_dy_fake_chan <span class="free">M</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_defs<span class="main">)</span>


<span class="keyword1" id="sklvl2-l2_dy_fake_msg_refines_learn"><span class="command">lemma</span></span> l2_dy_fake_msg_refines_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l2_inv3 <span class="main">∩</span> l2_inv7<span class="main">)</span><span class="main">}</span> l1_learn <span class="free">m</span><span class="main">,</span> l2_dy_fake_msg <span class="free">m</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Fake_insert_dy_fake_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> l2_inv3D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7_aux<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹compromising events›</span></span>
<span class="keyword1" id="sklvl2-l2_lkr_others_refines_skip"><span class="command">lemma</span></span> l2_lkr_others_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> Id<span class="main">,</span> l2_lkr_others <span class="free">A</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_lkr_after_refines_skip"><span class="command">lemma</span></span> l2_lkr_after_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s<span class="main">}</span> Id<span class="main">,</span> l2_lkr_after <span class="free">A</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_skr_refines_learn"><span class="command">lemma</span></span> l2_skr_refines_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l2_inv2 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv7<span class="main">)</span><span class="main">}</span> l1_learn <span class="free">K</span><span class="main">,</span> l2_skr <span class="free">R</span> <span class="free">K</span> <span class="main">{&gt;</span>R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12s_defs l2_loc_defs l1_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">l2_state</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv2"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv3"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∉</span> partners"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≠</span> test"</span></span> <span class="quoted"><span class="quoted">"in_progress <span class="main">(</span>progress <span class="skolem">s</span> <span class="free">R</span><span class="main">)</span> xsk"</span></span> <span class="quoted"><span class="quoted">"guessed_frame <span class="free">R</span> xsk <span class="main">=</span> Some <span class="free">K</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Hx<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">K</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> secret <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> l2_inv7"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="skolem"><span class="skolem">R'</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="skolem"><span class="skolem">N'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Hx'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Exp <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">R</span><span class="main">$</span><span class="skolem">N</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>NonceF <span class="main">(</span><span class="skolem">R'</span><span class="main">$</span><span class="skolem">N'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                                <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> test <span class="main">∧</span> <span class="skolem">R'</span> <span class="main">∈</span> partners <span class="main">∧</span> <span class="main">(</span><span class="skolem">N</span><span class="main">=</span>nx <span class="main">∨</span> <span class="skolem">N</span><span class="main">=</span>ny<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">N'</span><span class="main">=</span>nx <span class="main">∨</span> <span class="skolem">N'</span><span class="main">=</span>ny<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_inv7D subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⦇</span>ik <span class="main">:=</span> insert <span class="free">K</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span><span class="main">⦈</span> <span class="main">∈</span> l2_inv3"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hoare_apply <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_inv3_skr<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_defs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hx <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>generators <span class="main">(</span><span class="skolem">s</span> <span class="main">⦇</span>ik <span class="main">:=</span> insert <span class="free">K</span> <span class="main">(</span>ik <span class="skolem">s</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l2_inv3D_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Hx' <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_synth <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Exp_Exp_Gen_inj2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_generators<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l2_trans_refines_l1_trans <span class="main">=</span> 
  l2_dy_fake_msg_refines_learn l2_dy_fake_chan_refines_skip
  l2_lkr_others_refines_skip l2_lkr_after_refines_skip l2_skr_refines_learn
  l2_step1_refines_step1 l2_step2_refines_step2 l2_step3_refines_step3 l2_step4_refines_step4

<span class="keyword1" id="sklvl2-l2_refines_init_l1"><span class="command">lemma</span></span> l2_refines_init_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l2 <span class="main">⊆</span> R12s <span class="main">``</span> <span class="main">(</span>init skl1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R12s_defs skl1_defs l2_loc_defs<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_refines_trans_l1"><span class="command">lemma</span></span> l2_refines_trans_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12s <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv5 <span class="main">∩</span> 
                     l2_inv6 <span class="main">∩</span> l2_inv6' <span class="main">∩</span> l2_inv7<span class="main">)</span><span class="main">)</span><span class="main">}</span>
     trans skl1<span class="main">,</span> trans l2
   <span class="main">{&gt;</span> R12s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> skl1_def l2_def skl1_trans_def l2_trans_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2_trans_refines_l1_trans<span class="main">)</span>

<span class="keyword1" id="sklvl2-PO_obs_consistent_R12s"><span class="command">lemma</span></span> PO_obs_consistent_R12s <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R12s med12s skl1 l2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R12s_def med12s_def l2_defs<span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_refines_l1"><span class="command">lemma</span></span> l2_refines_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R12s <span class="main">∩</span> 
      <span class="main">(</span>reach skl1 <span class="main">×</span> <span class="main">(</span>l2_inv1 <span class="main">∩</span> l2_inv2 <span class="main">∩</span> l2_inv3 <span class="main">∩</span> l2_inv4 <span class="main">∩</span> l2_inv5 <span class="main">∩</span>
                                                  l2_inv6 <span class="main">∩</span> l2_inv6' <span class="main">∩</span> l2_inv7<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med12s skl1 l2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="sklvl2-l2_implements_l1"><span class="command">lemma</span></span> l2_implements_l1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med12s skl1 l2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We want to prove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l2_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  but by refinement we only get <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l2_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  This is fine, since a message in
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>chan <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> could be added to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ik <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l2_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> would still hold for this new state.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l2_partial_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l2_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_partial_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>


<span class="keyword1" id="sklvl2-l2_obs_partial_secrecy"><span class="command">lemma</span></span> l2_obs_partial_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_partial_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> skl1_obs_secrecy _ l2_implements_l1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med12s_def s0_secrecy_def l2_partial_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-l2_oreach_dy_fake_msg"><span class="command">lemma</span></span> l2_oreach_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> oreach l2<span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> dy_fake_msg <span class="main">(</span>bad <span class="free">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span> <span class="main">⟧</span>
 <span class="main">⟹</span> <span class="free">s</span> <span class="main">⦇</span>ik <span class="main">:=</span> insert <span class="free">x</span> <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span><span class="main">⦈</span> <span class="main">∈</span> oreach l2"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l2_trans_def l2_dy_fake_msg_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l2_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l2_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="sklvl2-l2_obs_secrecy"><span class="command">lemma</span></span> l2_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>l2_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> l2_oreach_dy_fake_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> l2_obs_partial_secrecy <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_partial_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="sklvl2-l2_secrecy"><span class="command">lemma</span></span> l2_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_secrecy<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l2_iagreement_Init</span> <span class="main">≡</span> l1_iagreement_Init"</span></span>

<span class="keyword1" id="sklvl2-l2_obs_iagreement_Init"><span class="command">lemma</span></span> l2_obs_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_iagreement_Init"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> skl1_obs_iagreement_Init _ l2_implements_l1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med12s_def l1_iagreement_Init_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-l2_iagreement_Init"><span class="command">lemma</span></span> l2_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_iagreement_Init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_iagreement_Init<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l2_iagreement_Resp</span> <span class="main">≡</span> l1_iagreement_Resp"</span></span>

<span class="keyword1" id="sklvl2-l2_obs_iagreement_Resp"><span class="command">lemma</span></span> l2_obs_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l2 <span class="main">⊆</span> l2_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> skl1_obs_iagreement_Resp _ l2_implements_l1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med12s_def l1_iagreement_Resp_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl2-l2_iagreement_Resp"><span class="command">lemma</span></span> l2_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l2 <span class="main">⊆</span> l2_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_iagreement_Resp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="sklvl3">
<div class="head">
<h1>Theory sklvl3</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  sklvl3.thy (Isabelle/HOL 2016-1)
  ID:      $Id: sklvl3.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-3 SKEME/IKEv1 protocol using generic channel implementation. 
  Refines model sklvl2 based on channel assumptions.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹SKEME Protocol (L3 locale)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> sklvl3
<span class="keyword2"><span class="keyword">imports</span></span> <a href="sklvl2.html">sklvl2</a> <a href="Implem_lemmas.html">Implem_lemmas</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and Events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Level 3 state.›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹(The types have to be defined outside the locale.)›</span></span>

<span class="keyword1"><span class="command">record</span></span> l3_state <span class="main">=</span> <span class="quoted">skl1_state</span> <span class="main">+</span>  
  bad <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> l3_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"l3_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l3_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  l3_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l3_state <span class="main">×</span> l3_state<span class="main">)</span> set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹attacker event›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_dy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_dy</span> <span class="main">≡</span> ik_dy"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Compromise events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_lkr_others</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_lkr_others</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">,</span>
           ik <span class="main">:=</span> keys_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_lkr_actor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_lkr_actor</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> test_owner <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> test_partner <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">,</span>
           ik <span class="main">:=</span> keys_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_lkr_after</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_lkr_after</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    test_ended <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>bad <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">∪</span> bad <span class="bound">s</span><span class="main">,</span>
           ik <span class="main">:=</span> keys_of <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_skr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_skr</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≠</span> test <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">∉</span> partners <span class="main">∧</span>
    in_progress <span class="main">(</span>progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> xsk <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">R</span></span></span> xsk <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∧</span>
    <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>ik <span class="main">:=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹New locale for the level 3 protocol. This locale does not add new assumptions, it is 
only used to separate the level 3 protocol from the implementation locale.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> sklvl3 <span class="main">=</span> valid_implem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events (with $K=H(ni, nr))$:
\begin{itemize}
\item step 1: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ra</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  confidentially sends <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  computes and insecurely sends $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 2: create <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Rb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (confidentially)
  and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ (insecurely),
  generates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  confidentially sends <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, insecurely sends $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and
  $MAC_K(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)$
  computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  emits a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
  $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 3: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> confidentially,
  and $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$ and the MAC insecurely,
  sends $MAC_K(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)$
  insecurely, computes $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$, emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  a running signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ny<span class="main"><span class="main">*</span></span>nx"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\item step 4: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> receives the MAC insecurely,
  emits a commit signal for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Resp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ni"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nr"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  declares the secret $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>^<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nx<span class="main"><span class="main">*</span></span>ny"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$
\end{itemize}
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xgnx<span class="main">}</span><span class="main">)</span><span class="main">,</span>
      ik <span class="main">:=</span> <span class="main">{</span>implConfid <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> 
             <span class="main">(</span><span class="main">{</span>implInsec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
              <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xni <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    implConfid <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∧</span>
    implInsec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgny<span class="main">,</span> xgnx<span class="main">,</span> xsk<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            ik <span class="main">:=</span> <span class="main">{</span>implConfid <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
                   <span class="main">(</span><span class="main">{</span>implInsec <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟨</span>Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span>
                                hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟩</span>
                                     <span class="main">(</span>Hash <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ni</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span> <span class="main">}</span> <span class="main">∪</span> 
                    <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ni</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit <span class="bound">s</span><span class="main">,</span>
            signalsInit2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit2 <span class="bound">s</span>
         <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>  


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Init<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xgnx<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xgny <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xnr <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Nr</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> xsk <span class="main">=</span> Some <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    implConfid <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∧</span>
    implInsec <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">gny</span></span></span><span class="main">,</span> hmac <span class="main">⟨</span>Number <span class="main">0</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟩</span>
                         <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span><span class="main">⟩</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∧</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">{</span>xnx<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            ik <span class="main">:=</span> <span class="main">{</span>implInsec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>hmac <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gny</span></span></span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟩</span>
                                     <span class="main">(</span>Hash <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> ik <span class="bound">s</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsInit <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit <span class="bound">s</span><span class="main">,</span>
            signalsInit2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsInit2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsInit2 <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>ni<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nr</span></span></span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp <span class="bound">s</span><span class="main">,</span>
            signalsResp2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gny</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>nx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp2 <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> agent <span class="main">⇒</span> agent <span class="main">⇒</span> msg <span class="main">⇒</span> msg <span class="main">⇒</span> l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_step4</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    guessed_runs <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> <span class="main">⦇</span>role<span class="main">=</span>Resp<span class="main">,</span> owner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> partner<span class="main">=</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦈</span> <span class="main">∧</span>
    progress <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">}</span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xgnx <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">∧</span>
    guessed_frame <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> xni <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">Ni</span></span></span> <span class="main">∧</span>
    implInsec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>hmac <span class="main">⟨</span>Number <span class="main">1</span><span class="main">,</span> Exp Gen <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gnx</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟩</span>
                    <span class="main">(</span>Hash <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ni</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> progress <span class="main">:=</span> <span class="main">(</span>progress <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">{</span>xny<span class="main">,</span> xni<span class="main">,</span> xnr<span class="main">,</span> xgnx<span class="main">,</span> xgny<span class="main">,</span> xsk<span class="main">,</span> xEnd<span class="main">}</span><span class="main">)</span><span class="main">,</span>
            secret <span class="main">:=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> test<span class="main">}</span> <span class="main">∪</span> secret <span class="bound">s</span><span class="main">,</span>
            signalsResp <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp <span class="bound">s</span><span class="main">)</span> 
                          <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ni</span></span></span><span class="main">,</span> NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nr<span class="main">)</span><span class="main">,</span> Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp <span class="bound">s</span><span class="main">,</span>
            signalsResp2 <span class="main">:=</span> 
              <span class="keyword1">if</span> can_signal <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">then</span>
                addSignal <span class="main">(</span>signalsResp2 <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Exp <span class="free"><span class="bound"><span class="entity">gnx</span></span></span> <span class="main">(</span>NonceF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>ny<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword1">else</span>
                signalsResp2 <span class="bound">s</span>
          <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specification.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initial compromise.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ik_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ik_init</span> <span class="main">≡</span> <span class="main">{</span>priK <span class="bound">C</span> <span class="main">|</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> bad_init<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>pubK <span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> True<span class="main">}</span> <span class="main">∪</span> 
             <span class="main">{</span>shrK <span class="bound">A</span> <span class="bound">B</span> <span class="main">|</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> bad_init <span class="main">∨</span> <span class="bound">B</span> <span class="main">∈</span> bad_init<span class="main">}</span> <span class="main">∪</span> Tags"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹lemmas about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ik_init"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1" id="sklvl3-parts_ik_init"><span class="command">lemma</span></span> parts_ik_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts ik_init <span class="main">=</span> ik_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>

<span class="keyword1" id="sklvl3-analz_ik_init"><span class="command">lemma</span></span> analz_ik_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz ik_init <span class="main">=</span> ik_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz_into_parts<span class="main">)</span>

<span class="keyword1" id="sklvl3-abs_ik_init"><span class="command">lemma</span></span> abs_ik_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs ik_init <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> absE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-payloadSet_ik_init"><span class="command">lemma</span></span> payloadSet_ik_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ik_init <span class="main">∩</span> payload <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>

<span class="keyword1" id="sklvl3-validSet_ik_init"><span class="command">lemma</span></span> validSet_ik_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ik_init <span class="main">∩</span> valid<span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
    ik <span class="main">=</span> ik_init<span class="main">,</span>
    secret <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
    progress <span class="main">=</span> Map.empty<span class="main">,</span>
    signalsInit <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsResp <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsInit2 <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    signalsResp2 <span class="main">=</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
    bad <span class="main">=</span> bad_init
    <span class="main">⦈</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_init_defs <span class="main">=</span> l3_init_def ik_init_def

<span class="keyword1"><span class="command">definition</span></span> 
<span class="entity">l3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">M</span> <span class="bound">N</span> <span class="bound">X</span> <span class="bound">Rb</span> <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">K</span><span class="main">.</span>
     l3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     l3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span> <span class="bound">X</span> <span class="main">∪</span>
     l3_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span> <span class="bound">X</span> <span class="main">∪</span>
     l3_step4 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span> <span class="bound">X</span> <span class="main">∪</span>
     l3_dy <span class="bound">M</span> <span class="main">∪</span>
     l3_lkr_others <span class="bound">A</span> <span class="main">∪</span>
     l3_lkr_after <span class="bound">A</span> <span class="main">∪</span>
     l3_skr <span class="bound">Ra</span> <span class="bound">K</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l3_state<span class="main">,</span> l3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> l3_init<span class="main">,</span>
    trans <span class="main">=</span> l3_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_loc_defs <span class="main">=</span> 
  l3_step1_def l3_step2_def l3_step3_def l3_step4_def
  l3_def l3_init_defs l3_trans_def
  l3_dy_def
  l3_lkr_others_def l3_lkr_after_def l3_skr_def

<span class="keyword1"><span class="command">lemmas</span></span> l3_defs <span class="main">=</span> l3_loc_defs ik_dy_def
<span class="keyword1"><span class="command">lemmas</span></span> l3_nostep_defs <span class="main">=</span> l3_def l3_init_def l3_trans_def


<span class="keyword1" id="sklvl3-l3_obs_id"><span class="command">lemma</span></span> l3_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs l3 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def<span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: No long-term keys as message parts›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv1</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
     parts <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">∩</span> range LtK <span class="main">⊆</span> ik <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv1I <span class="main">=</span> l3_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l3_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv1D <span class="main">=</span> l3_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="sklvl3-l3_inv1D'"><span class="command">lemma</span></span> l3_inv1D' <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> LtK <span class="free">K</span> <span class="main">∈</span> parts <span class="main">(</span>ik <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">s</span> <span class="main">∈</span> l3_inv1<span class="main">⟧</span> <span class="main">⟹</span> LtK <span class="free">K</span> <span class="main">∈</span> ik <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_inv1_def<span class="main">)</span>

<span class="keyword1" id="sklvl3-l3_inv1_init"><span class="command">lemma</span></span> l3_inv1_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv1I<span class="main">)</span>

<span class="keyword1" id="sklvl3-l3_inv1_trans"><span class="command">lemma</span></span> l3_inv1_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv1<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv1I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs dy_fake_msg_def dy_fake_chan_def
        parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"ik <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> parts_insert <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"insert <span class="main">_</span> <span class="main">(</span>ik <span class="main">_</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Fake_parts_insert<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>analz_into_parts<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-PO_l3_inv1"><span class="command">lemma</span></span> PO_l3_inv1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"bad <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> indeed contains "bad" keys›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    Keys_bad <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv2I <span class="main">=</span> l3_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l3_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv2D <span class="main">=</span> l3_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1" id="sklvl3-l3_inv2_init"><span class="command">lemma</span></span> l3_inv2_init <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv2I Keys_badI<span class="main">)</span>

<span class="keyword1" id="sklvl3-l3_inv2_trans"><span class="command">lemma</span></span> l3_inv2_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv2 <span class="main">∩</span> l3_inv1<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs dy_fake_msg_def dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹4 subgoals: dy, lkr*, skr.›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Keys_bad_insert_Fake Keys_bad_insert_keys_of<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Keys_bad_insert_payload<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-PO_l3_inv2"><span class="command">lemma</span></span> PO_l3_inv2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l3_inv1"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a message can be analyzed from the intruder knowledge then it can
be derived (using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>/<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"analz"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) from the sets of implementation, 
non-implementation, and long-term key messages and the tags. That is, intermediate messages 
are not needed.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>      
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> 
    synth <span class="main">(</span>analz <span class="main">(</span><span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span> <span class="main">∩</span> valid<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> range LtK<span class="main">)</span> <span class="main">∪</span> Tags<span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv3I <span class="main">=</span> l3_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv3E <span class="main">=</span> l3_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv3D <span class="main">=</span> l3_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="sklvl3-l3_inv3_init"><span class="command">lemma</span></span> l3_inv3_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv3"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_increasing <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Most of the cases in this proof are simple and very similar.
The proof could probably be shortened.›</span></span>

<span class="keyword1" id="sklvl3-l3_inv3_trans"><span class="command">lemma</span></span> l3_inv3_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_nostep_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step1 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Ni</span> <span class="skolem">gnx</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step2 <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Ni</span> <span class="skolem">gnx</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Nr</span> <span class="skolem">gny</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step3 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Nr</span> <span class="skolem">gny</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> validI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Ni</span> <span class="skolem">gnx</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_step4 <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Ni</span> <span class="skolem">gnx</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_dy <span class="skolem">m</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs dy_fake_chan_def dy_fake_msg_def
                <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_analz_insert<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> synth_monotone<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_lkr_others <span class="skolem">A</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> analz_Un_partition <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"keys_of <span class="skolem"><span class="skolem">A</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_lkr_after <span class="skolem">A</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> analz_Un_partition <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"keys_of <span class="skolem"><span class="skolem">A</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="skolem">K</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv3<span class="main">}</span> l3_skr <span class="skolem">R</span> <span class="skolem">K</span> <span class="main">{&gt;</span> l3_inv3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def l3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_insert_partition <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="sklvl3-PO_l3_inv3"><span class="command">lemma</span></span> PO_l3_inv3 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4: the intruder knows the tags›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv4</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    Tags <span class="main">⊆</span> ik <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv4I <span class="main">=</span> l3_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> l3_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv4D <span class="main">=</span> l3_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="sklvl3-l3_inv4_init"><span class="command">lemma</span></span> l3_inv4_init <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def ik_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv4I<span class="main">)</span>

<span class="keyword1" id="sklvl3-l3_inv4_trans"><span class="command">lemma</span></span> l3_inv4_trans <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv4<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs dy_fake_chan_def dy_fake_msg_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-PO_l3_inv4"><span class="command">lemma</span></span> PO_l3_inv4 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The remaining invariants are derived from the others.
They are not protocol dependent provided the previous invariants hold.›</span></span>
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The messages that the L3 DY intruder can derive from the intruder knowledge 
(using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>/<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"analz"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), are either implementations or intermediate messages or
can also be derived by the L2 intruder from the set 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"extr <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> payload<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>abs <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, that is, given the 
non-implementation messages and the abstractions of (implementation) messages
in the intruder knowledge. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv5</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 
    dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">(</span>abs <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">-</span>payload
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv5I <span class="main">=</span> l3_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv5E <span class="main">=</span> l3_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv5D <span class="main">=</span> l3_inv5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="sklvl3-l3_inv5_derived"><span class="command">lemma</span></span> l3_inv5_derived<span class="main">:</span> <span class="quoted"><span class="quoted">"l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">⊆</span> l3_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_validSet dy_fake_msg_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv5I
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> synth_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_NI_I_K_synth_analz_NI_E <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="sklvl3-PO_l3_inv5"><span class="command">lemma</span></span> PO_l3_inv5 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv5"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv5_derived PO_l3_inv2 PO_l3_inv3 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing an insecure channel message, 
then either:
\begin{itemize}
  \item the message is already in the intruder knowledge, or
  \item the message is constructed, and the payload can also be deduced by the intruder.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv6</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implInsec <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv6I <span class="main">=</span> l3_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv6E <span class="main">=</span> l3_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv6D <span class="main">=</span> l3_inv6_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="sklvl3-l3_inv6_derived"><span class="command">lemma</span></span> l3_inv6_derived <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv6"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv6I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹1 subgoal›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implInsec_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">"ik <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-PO_l3_inv6"><span class="command">lemma</span></span> PO_l3_inv6 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv6"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv6_derived PO_l3_inv3 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing a confidential channel message,
then either:
\begin{itemize}
 \item the message is already in the intruder knowledge, or
 \item the message is constructed, and the payload can also be deduced by the intruder.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv7</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implConfid <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv7I <span class="main">=</span> l3_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv7E <span class="main">=</span> l3_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv7D <span class="main">=</span> l3_inv7_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="sklvl3-l3_inv7_derived"><span class="command">lemma</span></span> l3_inv7_derived <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv7"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv7I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹1 subgoal›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implConfid_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">"ik <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-PO_l3_inv7"><span class="command">lemma</span></span> PO_l3_inv7 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv7"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv7_derived PO_l3_inv3 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv8›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing an authentic channel message 
then either:
\begin{itemize}
  \item the message is already in the intruder knowledge, or
  \item the message is constructed, and in this case the payload can also be deduced
     by the intruder, and one of the agents is bad.
\end{itemize}
›</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv8</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv8</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implAuth <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∈</span> bad <span class="bound">s</span> <span class="main">∨</span> <span class="bound">B</span> <span class="main">∈</span> bad <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv8I <span class="main">=</span> l3_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv8E <span class="main">=</span> l3_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv8D <span class="main">=</span> l3_inv8_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="sklvl3-l3_inv8_derived"><span class="command">lemma</span></span> l3_inv8_derived <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv8"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv8I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv3D l3_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹2 subgoals: M is deducible and the agents are bad›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implAuth_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implAuth_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-PO_l3_inv8"><span class="command">lemma</span></span> PO_l3_inv8 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv8"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv8_derived
  PO_l3_inv3 PO_l3_inv2 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv9›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the level 3 intruder can deduce a message implementing a secure channel message 
then either:
\begin{itemize}
  \item the message is already in the intruder knowledge, or
  \item the message is constructed, and in this case the payload can also be deduced 
 by the intruder, and one of the agents is bad.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv9</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv9</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span><span class="main">.</span> 
     <span class="main">(</span>implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">∈</span> payload<span class="main">)</span> <span class="main">⟶</span> 
     <span class="main">(</span>implSecure <span class="bound">A</span> <span class="bound">B</span> <span class="bound">M</span> <span class="main">∈</span> ik <span class="bound">s</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">M</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∈</span> bad <span class="bound">s</span> <span class="main">∨</span> <span class="bound">B</span> <span class="main">∈</span> bad <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv9I <span class="main">=</span> l3_inv9_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv9E <span class="main">=</span> l3_inv9_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv9D <span class="main">=</span> l3_inv9_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="sklvl3-l3_inv9_derived"><span class="command">lemma</span></span> l3_inv9_derived <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4 <span class="main">⊆</span> l3_inv9"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv9I <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv3D l3_inv2D<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹2 subgoals: M is deducible and the agents are bad.›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSecure_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> 
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> synth_analz_monotone<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> implSecure_synth_analz <span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-PO_l3_inv9"><span class="command">lemma</span></span> PO_l3_inv9 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv9"</span></span>
<span class="keyword1"><span class="command">using</span></span> l3_inv9_derived
  PO_l3_inv3 PO_l3_inv2 PO_l3_inv4
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med23s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_obs <span class="main">⇒</span> l2_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med23s</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    ik <span class="main">=</span> ik <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∩</span> payload<span class="main">,</span>
    secret <span class="main">=</span> secret <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    progress <span class="main">=</span> progress <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsInit <span class="main">=</span> signalsInit <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsResp <span class="main">=</span> signalsResp <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsInit2 <span class="main">=</span> signalsInit2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    signalsResp2 <span class="main">=</span> signalsResp2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>
    chan <span class="main">=</span> abs <span class="main">(</span>ik <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span>
    bad <span class="main">=</span> bad <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation between states.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>l2_state <span class="main">*</span> l3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23s</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">s</span> <span class="main">=</span> med23s <span class="bound">s'</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23s_defs <span class="main">=</span> R23s_def med23s_def


<span class="keyword1" id="sklvl3-R23sI"><span class="command">lemma</span></span> R23sI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ik <span class="free">s</span> <span class="main">=</span> ik <span class="free">t</span> <span class="main">∩</span> payload<span class="main">;</span> secret <span class="free">s</span> <span class="main">=</span> secret <span class="free">t</span><span class="main">;</span> progress <span class="free">s</span> <span class="main">=</span> progress <span class="free">t</span><span class="main">;</span>
     signalsInit <span class="free">s</span> <span class="main">=</span> signalsInit <span class="free">t</span><span class="main">;</span> signalsResp <span class="free">s</span> <span class="main">=</span> signalsResp <span class="free">t</span><span class="main">;</span>
     signalsInit2 <span class="free">s</span> <span class="main">=</span> signalsInit2 <span class="free">t</span><span class="main">;</span> signalsResp2 <span class="free">s</span> <span class="main">=</span> signalsResp2 <span class="free">t</span><span class="main">;</span>
     chan <span class="free">s</span> <span class="main">=</span> abs <span class="main">(</span>ik <span class="free">t</span><span class="main">)</span><span class="main">;</span> l2_state.bad <span class="free">s</span> <span class="main">=</span> bad <span class="free">t</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23s"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_def med23s_def<span class="main">)</span>

<span class="keyword1" id="sklvl3-R23sD"><span class="command">lemma</span></span> R23sD<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23s <span class="main">⟹</span>
    ik <span class="free">s</span> <span class="main">=</span> ik <span class="free">t</span> <span class="main">∩</span> payload <span class="main">∧</span> secret <span class="free">s</span> <span class="main">=</span> secret <span class="free">t</span> <span class="main">∧</span> progress <span class="free">s</span> <span class="main">=</span> progress <span class="free">t</span> <span class="main">∧</span>
    signalsInit <span class="free">s</span> <span class="main">=</span> signalsInit <span class="free">t</span> <span class="main">∧</span> signalsResp <span class="free">s</span> <span class="main">=</span> signalsResp <span class="free">t</span> <span class="main">∧</span>
    signalsInit2 <span class="free">s</span> <span class="main">=</span> signalsInit2 <span class="free">t</span> <span class="main">∧</span> signalsResp2 <span class="free">s</span> <span class="main">=</span> signalsResp2 <span class="free">t</span> <span class="main">∧</span>
    chan <span class="free">s</span> <span class="main">=</span> abs <span class="main">(</span>ik <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> l2_state.bad <span class="free">s</span> <span class="main">=</span> bad <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_def med23s_def<span class="main">)</span>

<span class="keyword1" id="sklvl3-R23sE"><span class="command">lemma</span></span> R23sE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23s<span class="main">;</span>
     <span class="main">⟦</span> ik <span class="free">s</span> <span class="main">=</span> ik <span class="free">t</span> <span class="main">∩</span> payload<span class="main">;</span> secret <span class="free">s</span> <span class="main">=</span> secret <span class="free">t</span><span class="main">;</span> progress <span class="free">s</span> <span class="main">=</span> progress <span class="free">t</span><span class="main">;</span>
      signalsInit <span class="free">s</span> <span class="main">=</span> signalsInit <span class="free">t</span><span class="main">;</span> signalsResp <span class="free">s</span> <span class="main">=</span> signalsResp <span class="free">t</span><span class="main">;</span>
      signalsInit2 <span class="free">s</span> <span class="main">=</span> signalsInit2 <span class="free">t</span><span class="main">;</span> signalsResp2 <span class="free">s</span> <span class="main">=</span> signalsResp2 <span class="free">t</span><span class="main">;</span>
      chan <span class="free">s</span> <span class="main">=</span> abs <span class="main">(</span>ik <span class="free">t</span><span class="main">)</span><span class="main">;</span> l2_state.bad <span class="free">s</span> <span class="main">=</span> bad <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_def med23s_def<span class="main">)</span>

<span class="keyword1" id="sklvl3-can_signal_R23"><span class="command">lemma</span></span> can_signal_R23 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s2</span><span class="main">,</span> <span class="free">s3</span><span class="main">)</span> <span class="main">∈</span> R23s <span class="main">⟹</span>
   can_signal <span class="free">s2</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> can_signal <span class="free">s3</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> can_signal_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Protocol events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="sklvl3-l3_step1_refines_step1"><span class="command">lemma</span></span> l3_step1_refines_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">,</span> l3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_step1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-l3_step2_refines_step2"><span class="command">lemma</span></span> l3_step2_refines_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span><span class="main">,</span> l3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span><span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l2_step2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_step2_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-l3_step3_refines_step3"><span class="command">lemma</span></span> l3_step3_refines_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span><span class="main">,</span> l3_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nr</span> <span class="free">gny</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l2_step3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_step3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-l3_step4_refines_step4"><span class="command">lemma</span></span> l3_step4_refines_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span><span class="main">,</span> l3_step4 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Ni</span> <span class="free">gnx</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l2_step4_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_step4_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Intruder events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="sklvl3-l3_dy_payload_refines_dy_fake_msg"><span class="command">lemma</span></span> l3_dy_payload_refines_dy_fake_msg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> payload <span class="main">⟹</span>
   <span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> l3_inv5<span class="main">}</span> l2_dy_fake_msg <span class="free">M</span><span class="main">,</span> l3_dy <span class="free">M</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_dy_fake_msg_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv5D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-l3_dy_valid_refines_dy_fake_chan"><span class="command">lemma</span></span> l3_dy_valid_refines_dy_fake_chan<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">∈</span> valid<span class="main">;</span> <span class="free">M'</span> <span class="main">∈</span> abs <span class="main">{</span><span class="free">M</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">}</span> 
      l2_dy_fake_chan <span class="free">M'</span><span class="main">,</span> l3_dy <span class="free">M</span> 
   <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_dy_fake_chan_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹1 subgoal›</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> valid_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dy_fake_chan_def<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Insec›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv6D l3_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Confid›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv7D l3_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auth›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv8D l3_inv5D<span class="main">)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Secure›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_inv9D l3_inv5D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="sklvl3-l3_dy_valid_refines_dy_fake_chan_Un"><span class="command">lemma</span></span> l3_dy_valid_refines_dy_fake_chan_Un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> valid <span class="main">⟹</span>
   <span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">}</span> 
      <span class="main">⋃</span><span class="bound">M'</span><span class="main">.</span> l2_dy_fake_chan <span class="bound">M'</span><span class="main">,</span> l3_dy <span class="free">M</span> 
   <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> valid_abs <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l3_dy_valid_refines_dy_fake_chan<span class="main">)</span>


<span class="keyword1" id="sklvl3-l3_dy_isLtKey_refines_skip"><span class="command">lemma</span></span> l3_dy_isLtKey_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> Id<span class="main">,</span> l3_dy <span class="main">(</span>LtK <span class="free">ltk</span><span class="main">)</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs l3_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> absE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-l3_dy_others_refines_skip"><span class="command">lemma</span></span> l3_dy_others_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">M</span> <span class="main">∉</span> range LtK<span class="main">;</span> <span class="free">M</span> <span class="main">∉</span> valid<span class="main">;</span> <span class="free">M</span> <span class="main">∉</span> payload <span class="main">⟧</span> <span class="main">⟹</span> 
   <span class="main">{</span>R23s<span class="main">}</span> Id<span class="main">,</span> l3_dy <span class="free">M</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> absE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> validI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="sklvl3-l3_dy_refines_dy_fake_msg_dy_fake_chan_skip"><span class="command">lemma</span></span> l3_dy_refines_dy_fake_msg_dy_fake_chan_skip<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">}</span> 
      l2_dy_fake_msg <span class="free">M</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">M'</span><span class="main">.</span> l2_dy_fake_chan <span class="bound">M'</span><span class="main">)</span> <span class="main">∪</span> Id<span class="main">,</span> l3_dy <span class="free">M</span> 
    <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> payload <span class="main">∪</span> valid <span class="main">∪</span> range LtK"</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> l3_dy_payload_refines_dy_fake_msg l3_dy_valid_refines_dy_fake_chan_Un 
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l3_dy_isLtKey_refines_skip <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_dy_others_refines_skip<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Compromise events›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1" id="sklvl3-l3_lkr_others_refines_lkr_others"><span class="command">lemma</span></span> l3_lkr_others_refines_lkr_others<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_lkr_others <span class="free">A</span><span class="main">,</span> l3_lkr_others <span class="free">A</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_lkr_others_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-l3_lkr_after_refines_lkr_after"><span class="command">lemma</span></span> l3_lkr_after_refines_lkr_after<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_lkr_after <span class="free">A</span><span class="main">,</span> l3_lkr_after <span class="free">A</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_lkr_after_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-l3_skr_refines_skr"><span class="command">lemma</span></span> l3_skr_refines_skr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s<span class="main">}</span> l2_skr <span class="free">R</span> <span class="free">K</span><span class="main">,</span> l3_skr <span class="free">R</span> <span class="free">K</span> <span class="main">{&gt;</span>R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23s_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l2_skr_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">lemmas</span></span> l3_trans_refines_l2_trans <span class="main">=</span> 
  l3_step1_refines_step1 l3_step2_refines_step2 l3_step3_refines_step3 l3_step4_refines_step4
  l3_dy_refines_dy_fake_msg_dy_fake_chan_skip
  l3_lkr_others_refines_lkr_others l3_lkr_after_refines_lkr_after l3_skr_refines_skr



<span class="keyword1" id="sklvl3-l3_refines_init_l2"><span class="command">lemma</span></span> l3_refines_init_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> R23s <span class="main">``</span> <span class="main">(</span>init l2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23s_defs l2_defs l3_def l3_init_def<span class="main">)</span>

<span class="keyword1" id="sklvl3-l3_refines_trans_l2"><span class="command">lemma</span></span> l3_refines_trans_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23s <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l3_inv1 <span class="main">∩</span> l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4<span class="main">)</span><span class="main">)</span><span class="main">}</span> trans l2<span class="main">,</span> trans l3 <span class="main">{&gt;</span> R23s<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pre'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"R23s <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>l3_inv5 <span class="main">∩</span> l3_inv6 <span class="main">∩</span> l3_inv7 <span class="main">∩</span> l3_inv8 <span class="main">∩</span> l3_inv9<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span><span class="var">?post</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conseq_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pre</span> <span class="main">⊆</span> <span class="var">?pre'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l3_inv5_derived l3_inv6_derived l3_inv7_derived l3_inv8_derived l3_inv9_derived 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre'</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span> <span class="var">?post</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_def l3_def l2_trans_def l3_trans_def
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_trans_refines_l2_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1" id="sklvl3-PO_obs_consistent_R23s"><span class="command">lemma</span></span> PO_obs_consistent_R23s <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R23s med23s l2 l3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23s_def med23s_def l2_defs<span class="main">)</span>


<span class="keyword1" id="sklvl3-l3_refines_l2"><span class="command">lemma</span></span> l3_refines_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R23s <span class="main">∩</span> 
      <span class="main">(</span>reach l2 <span class="main">×</span> <span class="main">(</span>l3_inv1 <span class="main">∩</span> l3_inv2 <span class="main">∩</span> l3_inv3 <span class="main">∩</span> l3_inv4<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med23s l2 l3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="sklvl3-l3_implements_l2"><span class="command">lemma</span></span> l3_implements_l2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med23s l2 l3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(**************************************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv10: secrets contain no implementation material›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_inv10</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"l3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_inv10</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span>
    secret <span class="bound">s</span> <span class="main">⊆</span> payload
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> l3_inv10I <span class="main">=</span> l3_inv10_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv10E <span class="main">=</span> l3_inv10_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> l3_inv10D <span class="main">=</span> l3_inv10_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1" id="sklvl3-l3_inv10_init"><span class="command">lemma</span></span> l3_inv10_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"init l3 <span class="main">⊆</span> l3_inv10"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_def l3_init_def ik_init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>l3_inv10I<span class="main">)</span>

<span class="keyword1" id="sklvl3-l3_inv10_trans"><span class="command">lemma</span></span> l3_inv10_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>l3_inv10<span class="main">}</span> trans l3 <span class="main">{&gt;</span> l3_inv10<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs l3_nostep_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l3_defs l3_inv10_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-PO_l3_inv10"><span class="command">lemma</span></span> PO_l3_inv10 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_inv10"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="sklvl3-l3_obs_inv10"><span class="command">lemma</span></span> l3_obs_inv10 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_inv10"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Partial secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We want to prove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l3_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, ie
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  but by refinement we only get <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l3_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: 
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">payloadSet</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>abs <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∩</span></span> secret <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  This is fine if secrets contain no implementation material.
  Then, by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">inv5</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, a message in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"synth <span class="main"><span class="main">(</span></span>analz <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is in
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dy_fake_msg <span class="main"><span class="main">(</span></span>bad <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">payloadSet</span></span> <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>abs <span class="main"><span class="main">(</span></span>ik <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">-</span></span>payload"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l3_partial_secrecy</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> proves it is not a secret.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l3_partial_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l3_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_partial_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> 
    dy_fake_msg <span class="main">(</span>bad <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>ik <span class="bound">s</span> <span class="main">∩</span> payload<span class="main">)</span> <span class="main">(</span>abs <span class="main">(</span>ik <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> secret <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1" id="sklvl3-l3_obs_partial_secrecy"><span class="command">lemma</span></span> l3_obs_partial_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_partial_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_secrecy _ l3_implements_l2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l2_secrecy_def l3_partial_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Secrecy›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">l3_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> l3_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l3_secrecy</span> <span class="main">≡</span> l1_secrecy"</span></span>

<span class="keyword1" id="sklvl3-l3_obs_inv5"><span class="command">lemma</span></span> l3_obs_inv5<span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_inv5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>

<span class="keyword1" id="sklvl3-l3_obs_secrecy"><span class="command">lemma</span></span> l3_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> l3_obs_inv5 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> l3_obs_inv10 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l2_secrecy_def l3_secrecy_def s0_secrecy_def l3_inv10_def<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> l3_partial_secrecy_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l3_inv5D subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_partial_secrecy<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-l3_secrecy"><span class="command">lemma</span></span> l3_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_secrecy<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Injective agreement›</span></span>
<span class="comment1">(**************************************************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l3_iagreement_Init</span> <span class="main">≡</span> l1_iagreement_Init"</span></span>

<span class="keyword1" id="sklvl3-l3_obs_iagreement_Init"><span class="command">lemma</span></span> l3_obs_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_iagreement_Init"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_iagreement_Init _ l3_implements_l2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l1_iagreement_Init_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-l3_iagreement_Init"><span class="command">lemma</span></span> l3_iagreement_Init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_iagreement_Init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_iagreement_Init<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">l3_iagreement_Resp</span> <span class="main">≡</span> l1_iagreement_Resp"</span></span>

<span class="keyword1" id="sklvl3-l3_obs_iagreement_Resp"><span class="command">lemma</span></span> l3_obs_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach l3 <span class="main">⊆</span> l3_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation 
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l2_obs_iagreement_Resp _ l3_implements_l2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med23s_def l1_iagreement_Resp_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="sklvl3-l3_iagreement_Resp"><span class="command">lemma</span></span> l3_iagreement_Resp <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach l3 <span class="main">⊆</span> l3_iagreement_Resp"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> l3_obs_iagreement_Resp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="sklvl3_asymmetric">
<div class="head">
<h1>Theory sklvl3_asymmetric</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  sklvl3_asymmetric.thy (Isabelle/HOL 2016-1)
  ID:      $Id: sklvl3_asymmetric.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-3 SKEME/IKEv1 protocol; asymmetric instantiation of version with generic
  channel implementation. Refines model sklvl2 based on channel assumptions.
  This corresponds to the basic mode of the SKEME protocol and to the public-key 
  variant of the IKEv1 protocol in agressive mode.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹SKEME Protocol (L3 with asymmetric implementation)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> sklvl3_asymmetric
<span class="keyword2"><span class="keyword">imports</span></span> <a href="sklvl3.html">sklvl3</a> <a href="Implem_asymmetric.html">Implem_asymmetric</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> sklvl3_asym<span class="main">:</span> sklvl3 <span class="quoted">implem_asym</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="sklvl3_symmetric">
<div class="head">
<h1>Theory sklvl3_symmetric</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Refining Authenticated Key Agreement with Strong Adversaries

  Module:  sklvl3_symmetric.thy (Isabelle/HOL 2016-1)
  ID:      $Id: sklvl3_symmetric.thy 133183 2017-01-31 13:55:43Z csprenge $
  Author:  Joseph Lallemand, INRIA Nancy &lt;joseph.lallemand@loria.fr&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Level-3 SKEME/IKEv1 protocol; symmetric instantiation of version with generic
  channel implementation. Refines model sklvl2 based on channel assumptions.

  Copyright (c) 2015-2016 Joseph Lallemand and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹SKEME Protocol (L3 with symmetric implementation)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> sklvl3_symmetric
<span class="keyword2"><span class="keyword">imports</span></span> <a href="sklvl3.html">sklvl3</a> <a href="Implem_symmetric.html">Implem_symmetric</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> sklvl3_sym<span class="main">:</span> sklvl3 <span class="quoted">implem_sym</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>