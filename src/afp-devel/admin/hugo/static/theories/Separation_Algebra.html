<div id="Separation_Algebra">
<div class="head">
<h1>Theory Separation_Algebra</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: Gerwin Klein and Rafal Kolanski, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Abstract Separation Algebra"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Separation_Algebra
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory is the main abstract separation algebra development›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Input syntax for lifting boolean predicates to separation predicates›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_and</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">and</span>"</span> 35<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1"><span class="free">and</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_or</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">or</span>"</span> 30<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1"><span class="free">or</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_not</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">not</span> _"</span> <span class="main">[</span>40<span class="main">]</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">not</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_imp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">imp</span>"</span> 25<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1"><span class="free">imp</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_K</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">EXS</span> "</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">EXS</span></span> <span class="bound">x</span><span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">ALLS</span> "</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ALLS</span></span> <span class="bound">x</span><span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">s</span>"</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Associative/Commutative Monoid Basis of Separation Algebras›</span></span>

<span class="keyword1"><span class="command">class</span></span> pre_sep_algebra <span class="main">=</span> zero <span class="main">+</span> plus <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">sep_disj</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">##</span></span></span>"</span> 60<span class="main">)</span>

  <span class="keyword2"><span class="keyword">assumes</span></span> sep_disj_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">##</span></span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sep_disj_commuteI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">##</span></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main"><span class="free">##</span></span> <span class="free">x</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> sep_add_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sep_add_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">##</span></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> sep_add_assoc<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main"><span class="free">##</span></span> <span class="free">y</span><span class="main">;</span> <span class="free">y</span> <span class="main"><span class="free">##</span></span> <span class="free">z</span><span class="main">;</span> <span class="free">x</span> <span class="main"><span class="free">##</span></span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">##</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_disj_commuteI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_add_left_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">##</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">##</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">##</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="free">b</span> <span class="main">+</span> <span class="free">a</span> <span class="main">+</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_add_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sep_disj_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_add_commute sep_disj_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_add_assoc sep_disj_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sep_add_ac <span class="main">=</span> sep_add_assoc sep_add_commute sep_add_left_commute
                    sep_disj_commute <span class="comment1">(* nearly always necessary *)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Separation Algebra as Defined by Calcagno et al.›</span></span>

<span class="keyword1"><span class="command">class</span></span> sep_algebra <span class="main">=</span> pre_sep_algebra <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sep_disj_addD1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">;</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sep_disj_addI1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">;</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">##</span>  <span class="free">z</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Construct Definitions and Abbreviations›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">**</span>"</span> 35<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">**</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">##</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">h</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">y</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span>
  sep_conj <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∧*</span>"</span> 35<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">□</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">□</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⟶*</span>"</span> 25<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⟶*</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="main">∀</span><span class="bound">h'</span><span class="main">.</span> <span class="bound">h</span> <span class="main">##</span> <span class="bound">h'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">h'</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span><span class="bound">h</span> <span class="main">+</span> <span class="bound">h'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_substate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">≼</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">##</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="bound">z</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="comment1">(* We want these to be abbreviations not definitions, because basic True and
   False will occur by simplification in sep_conj terms *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_true</span> <span class="main">≡</span> <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_false</span> <span class="main">≡</span> <span class="main">⟨</span>False<span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_list_conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">⋀*</span> _"</span> <span class="main">[</span>60<span class="main">]</span> 90<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_list_conj</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span> <span class="main">≡</span> foldl <span class="main">(**)</span> <span class="main">□</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Disjunction/Addition Properties›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disjoint_zero_sym <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">##</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_disj_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_add_zero_sym <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_add_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_addD2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">;</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">##</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_disj_addD1 sep_add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_addD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">;</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">##</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_disj_addD1 sep_disj_addD2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_add_disjD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span><span class="main">;</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">##</span> <span class="free">z</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_disj_addD sep_disj_commuteI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_addI2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">;</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">+</span> <span class="free">z</span> <span class="main">##</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_add_ac sep_disj_addI1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_add_disjI1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span><span class="main">;</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">+</span> <span class="free">z</span> <span class="main">##</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_add_ac sep_add_disjD sep_disj_addI2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_add_disjI2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span><span class="main">;</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">##</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_add_ac sep_add_disjD sep_disj_addI2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_addI3<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_add_ac sep_add_disjD sep_add_disjI2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span><span class="main">;</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_disj_addI1 sep_disj_addI3<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Substate Properties›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_substate_disj_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≼</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sep_substate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_substate_disj_add'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≼</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_add_ac sep_substate_disj_add<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Separating Conjunction Properties›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conjD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">##</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">h</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conjE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">x</span><span class="main">;</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">;</span> <span class="bound">x</span> <span class="main">##</span> <span class="bound">y</span><span class="main">;</span> <span class="free">h</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conjI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">x</span><span class="main">;</span> <span class="free">Q</span> <span class="free">y</span><span class="main">;</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span><span class="main">;</span> <span class="free">h</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_commuteI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conj_commuteI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">h</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">z</span>"</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">##</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sep_add_disjD<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">##</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_disj_add<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_add_ac <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="skolem">h</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">z</span>"</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">##</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">##</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_add_ac <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sep_disj_addD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_conj_def sep_disj_addI1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_impl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">h</span><span class="main">.</span> <span class="free">P</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="bound">h</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">h</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">h</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P'</span> <span class="main">**</span> <span class="free">Q'</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> sep_conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_impl1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span><span class="main">.</span> <span class="free">P</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conj_impl P<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_globalise<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">h</span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">h</span><span class="main">.</span> <span class="free">P</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">h</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conj_impl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_trivial_strip2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">=</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> disjoint_subheaps_exist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">##</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">h</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_left_commute<span class="main">:</span> <span class="comment1">(* for permutative rewriting *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> <span class="var">?y</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="main">(</span><span class="free">R</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sep_conj_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sep_conj_ac <span class="main">=</span> sep_conj_commute sep_conj_assoc sep_conj_left_commute

<span class="keyword1"><span class="command">lemma</span></span> ab_semigroup_mult_sep_conj<span class="main">:</span> <span class="quoted"><span class="quoted">"class.ab_semigroup_mult <span class="main">(**)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_empty_zero <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">□</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_empty_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sep_true›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sep_false›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> sep_true<span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conjI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_true'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span>sep_true <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conjI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_true <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">**</span> sep_true<span class="main">)</span> <span class="main">=</span> sep_true"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sep_conj_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> disjoint_subheaps_exist<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_false_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> sep_false<span class="main">)</span> <span class="main">=</span> sep_false"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conjE <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_false_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_false <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> sep_false"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sep_conj_commute<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> sep_conj_false_right<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of zero (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sep_empty<span class="antiquote"><span class="antiquote">}</span></span></span></span>)›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">□</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_def sep_empty_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_empty'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sep_conj_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sep_conj_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_emptyI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">□</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_emptyE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">□</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> monoid_add<span class="main">:</span> <span class="quoted"><span class="quoted">"class.monoid_add <span class="main">(</span><span class="main">(**)</span><span class="main">)</span> <span class="main">□</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comm_monoid_add<span class="main">:</span> <span class="quoted"><span class="quoted">"class.comm_monoid_add <span class="main">(**)</span> <span class="main">□</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_ac<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of top (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sep_true›</span></span></span></span>)›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_true_P <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">**</span> <span class="main">(</span>sep_true <span class="main">**</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sep_true <span class="main">**</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_disj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">or</span> <span class="free">Q</span><span class="main">)</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_true_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span>sep_true <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> sep_conj_impl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_true_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> sep_true<span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sep_conj_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> sep_conj_sep_true_left<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_ac<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Separating Conjunction with Quantifiers›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">and</span> <span class="free">Q</span><span class="main">)</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conjI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_exists1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">EXS</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">EXS</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conjI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_exists2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">(</span><span class="keyword1">EXS</span> <span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">EXS</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">**</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjI ext <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> sep_conj_exists <span class="main">=</span> sep_conj_exists1 sep_conj_exists2

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">ALLS</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="free">x</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conjI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of Separating Implication›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_implI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">h</span> <span class="main">##</span> <span class="bound">h'</span><span class="main">;</span> <span class="free">P</span> <span class="bound">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="main">+</span> <span class="bound">h'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">⟶*</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sep_impl_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_implD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⟶*</span> <span class="free">y</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">h'</span><span class="main">.</span> <span class="free">h</span> <span class="main">##</span> <span class="bound">h'</span> <span class="main">∧</span> <span class="free">x</span> <span class="bound">h'</span> <span class="main">⟶</span> <span class="free">y</span> <span class="main">(</span><span class="free">h</span> <span class="main">+</span> <span class="bound">h'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_impl_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_implE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⟶*</span> <span class="free">y</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h'</span><span class="main">.</span> <span class="free">h</span> <span class="main">##</span> <span class="bound">h'</span> <span class="main">∧</span> <span class="free">x</span> <span class="bound">h'</span> <span class="main">⟶</span> <span class="free">y</span> <span class="main">(</span><span class="free">h</span> <span class="main">+</span> <span class="bound">h'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sep_implD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_impl_sep_true <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">⟶*</span> sep_true<span class="main">)</span> <span class="main">=</span> sep_true"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_implI ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_impl_sep_false <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_false <span class="main">⟶*</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> sep_true"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_implI ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_impl_sep_true_P<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">⟶*</span> <span class="free">P</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_implD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_impl_sep_true_false <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">⟶*</span> sep_false<span class="main">)</span> <span class="main">=</span> sep_false"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sep_impl_sep_true_P<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_impl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">h</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">h</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">h</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⟶*</span> <span class="free">R</span><span class="main">)</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sep_implI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h'</span> <span class="skolem">h</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">##</span> <span class="skolem">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">h'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">+</span> <span class="skolem">h'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">h</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">+</span> <span class="skolem">h'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_impl2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">h</span><span class="main">.</span> <span class="free">P</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⟶*</span> <span class="free">R</span><span class="main">)</span> <span class="bound">h</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sep_implD <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_impl_sep_conj2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⟶*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sep_conj_impl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sep_conj_sep_impl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_ac<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pure assertions›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pure</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">h</span> <span class="bound">h'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">h</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">h'</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pure_sep_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pure sep_true"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pure_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_sep_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pure sep_true"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pure_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pure <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">=</span> sep_true <span class="main">∨</span> <span class="free">P</span> <span class="main">=</span> sep_false<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_sep_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> pure <span class="free">P</span><span class="main">;</span> pure <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> pure <span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_sep_impl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> pure <span class="free">P</span><span class="main">;</span> pure <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> pure <span class="main">(</span><span class="free">P</span> <span class="main">⟶*</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_conj_sep_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">and</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span><span class="main">;</span> pure <span class="free">P</span> <span class="main">∨</span> pure <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pure_def sep_add_zero sep_conjI sep_conj_commute sep_disj_zero<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_sep_conj_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span><span class="main">;</span> pure <span class="free">P</span><span class="main">;</span> pure <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">and</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_conj_sep_conj_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pure <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="keyword1">and</span> <span class="free">Q</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∧*</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_sep_impl_impl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">⟶*</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span><span class="main">;</span> pure <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">h</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sep_impl_sep_true_P<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_impl_sep_impl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">h</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="free">h</span><span class="main">;</span> pure <span class="free">P</span><span class="main">;</span> pure <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">⟶*</span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_conj_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Q</span> <span class="main">∧*</span> <span class="main">(</span><span class="main">⟨</span><span class="free">P'</span><span class="main">⟩</span> <span class="keyword1">and</span> <span class="free">Q'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free">P'</span><span class="main">⟩</span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∧*</span> <span class="free">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>
     <span class="main">(</span><span class="operator">erule</span> sep_conj_impl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_conj_right'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Q</span> <span class="main">∧*</span> <span class="main">(</span><span class="free">P'</span> <span class="keyword1">and</span> <span class="main">⟨</span><span class="free">Q'</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Q'</span><span class="main">⟩</span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∧*</span> <span class="free">P'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conj_comms pure_conj_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_conj_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="free">P'</span><span class="main">⟩</span> <span class="keyword1">and</span> <span class="free">Q'</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free">P'</span><span class="main">⟩</span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">Q'</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pure_conj_right sep_conj_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_conj_left'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P'</span> <span class="keyword1">and</span> <span class="main">⟨</span><span class="free">Q'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Q'</span><span class="main">⟩</span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">P'</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> conj_comms<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> pure_conj_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> pure_conj <span class="main">=</span> pure_conj_right pure_conj_right' pure_conj_left
    pure_conj_left'

<span class="keyword1"><span class="command">declare</span></span> pure_conj<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">add</span></span></span></span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Intuitionistic assertions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">intuitionistic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intuitionistic</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">h</span> <span class="bound">h'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">h</span> <span class="main">∧</span> <span class="bound">h</span> <span class="main">≼</span> <span class="bound">h'</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">h'</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionisticI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">h</span> <span class="bound">h'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">h</span><span class="main">;</span> <span class="bound">h</span> <span class="main">≼</span> <span class="bound">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">h'</span><span class="main">)</span> <span class="main">⟹</span> intuitionistic <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> intuitionistic_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionisticD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> intuitionistic <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="free">h</span><span class="main">;</span> <span class="free">h</span> <span class="main">≼</span> <span class="free">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">h'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> intuitionistic_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pure_intuitionistic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pure <span class="free">P</span> <span class="main">⟹</span> intuitionistic <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intuitionistic_def pure_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> intuitionistic <span class="free">P</span><span class="main">;</span> intuitionistic <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> intuitionistic <span class="main">(</span><span class="free">P</span> <span class="keyword1">and</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> intuitionisticI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> intuitionisticD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_disj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> intuitionistic <span class="free">P</span><span class="main">;</span> intuitionistic <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> intuitionistic <span class="main">(</span><span class="free">P</span> <span class="keyword1">or</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> intuitionisticI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> intuitionisticD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_forall<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> intuitionistic <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> intuitionistic <span class="main">(</span><span class="keyword1">ALLS</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> intuitionisticI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> intuitionisticD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_exists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> intuitionistic <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> intuitionistic <span class="main">(</span><span class="keyword1">EXS</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> intuitionisticI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> intuitionisticD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_sep_conj_sep_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"intuitionistic <span class="main">(</span>sep_true <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> intuitionisticI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">h'</span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">h</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xyd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">##</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> sep_conjD<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≼</span> <span class="skolem">h'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hzd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_substate_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> sep_true<span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P h hzd xyd
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_add_disjI1 sep_disj_commute sep_conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hzd
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_commute sep_add_ac <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_disj_addD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_sep_impl_sep_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"intuitionistic <span class="main">(</span>sep_true <span class="main">⟶*</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> intuitionisticI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">h'</span>
  <span class="keyword3"><span class="command">assume</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">⟶*</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hh'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≼</span> <span class="skolem">h'</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> hh' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hzd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_substate_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">⟶*</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> imp h' hzd
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_implD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> sep_add_assoc sep_add_disjD sep_disj_addI3 sep_implI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_sep_conj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ip<span class="main">:</span> <span class="quoted"><span class="quoted">"intuitionistic <span class="main">(</span><span class="free">P</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"intuitionistic <span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> intuitionisticI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">h'</span>
  <span class="keyword3"><span class="command">assume</span></span> sc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hh'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≼</span> <span class="skolem">h'</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> hh' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hzd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_substate_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> sc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> px<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> qy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">y</span>"</span></span>
                       <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xyd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">##</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hzd h xyd
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_add_disjD<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> ip px <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> intuitionisticD sep_substate_disj_add<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h' h hzd qy xyd
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> sep_add_commute sep_add_disjD sep_add_disjI2
              sep_add_left_commute sep_conjI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_sep_impl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iq<span class="main">:</span> <span class="quoted"><span class="quoted">"intuitionistic <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"intuitionistic <span class="main">(</span><span class="free">P</span> <span class="main">⟶*</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> intuitionisticI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">h'</span>
  <span class="keyword3"><span class="command">assume</span></span> imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">⟶*</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hh'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≼</span> <span class="skolem">h'</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> hh' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hzd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_substate_def<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> px<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hzx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">##</span> <span class="skolem">x</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">≼</span> <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hzx hzd
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_add_disjI1 sep_substate_def<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> imp hzd iq px hzx
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> intuitionisticD sep_add_assoc sep_add_ac sep_add_disjD sep_implE<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">with</span></span> imp h' hzd iq <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">⟶*</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">h'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_implI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strongest_intuitionistic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span><span class="main">.</span> <span class="main">(</span><span class="bound">Q</span> <span class="bound">h</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> sep_true<span class="main">)</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> intuitionistic <span class="bound">Q</span> <span class="main">∧</span>
      <span class="bound">Q</span> <span class="main">≠</span> <span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> sep_true<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span><span class="main">.</span> <span class="free">P</span> <span class="bound">h</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext sep_substate_disj_add
                <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjD intuitionisticD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> weakest_intuitionistic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>sep_true <span class="main">⟶*</span> <span class="free">P</span><span class="main">)</span> <span class="bound">h</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> intuitionistic <span class="bound">Q</span> <span class="main">∧</span>
      <span class="bound">Q</span> <span class="main">≠</span> <span class="main">(</span>sep_true <span class="main">⟶*</span> <span class="free">P</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span><span class="main">.</span> <span class="bound">Q</span> <span class="bound">h</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sep_implI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">+</span> <span class="improper">h'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> intuitionisticD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_add_ac sep_substate_disj_add<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_sep_conj_sep_true_P<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> sep_true<span class="main">)</span> <span class="free">s</span><span class="main">;</span> intuitionistic <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> intuitionisticD <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conjE sep_substate_disj_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_sep_conj_sep_true_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"intuitionistic <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> sep_true<span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conj_sep_true ext
           <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> intuitionistic_sep_conj_sep_true_P<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_sep_impl_sep_true_P<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">h</span><span class="main">;</span> intuitionistic <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>sep_true <span class="main">⟶*</span> <span class="free">P</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_implI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> intuitionisticD
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_substate_disj_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intuitionistic_sep_impl_sep_true_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"intuitionistic <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span>sep_true <span class="main">⟶*</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext
           <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_impl_sep_true_P intuitionistic_sep_impl_sep_true_P<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strictly exact assertions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strictly_exact</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strictly_exact</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">h</span> <span class="bound">h'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">h</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">h'</span> <span class="main">⟶</span> <span class="bound">h</span> <span class="main">=</span> <span class="bound">h'</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_exactD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> strictly_exact <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="free">h</span><span class="main">;</span> <span class="free">P</span> <span class="free">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">=</span> <span class="free">h'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> strictly_exact_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_exactI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">h</span> <span class="bound">h'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">h</span><span class="main">;</span> <span class="free">P</span> <span class="bound">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">h</span> <span class="main">=</span> <span class="bound">h'</span><span class="main">)</span> <span class="main">⟹</span> strictly_exact <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> strictly_exact_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_exact_sep_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> strictly_exact <span class="free">P</span><span class="main">;</span> strictly_exact <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> strictly_exact <span class="main">(</span><span class="free">P</span> <span class="main">∧*</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> strictly_exactI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sep_conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">xa</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> strictly_exactD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">ya</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> strictly_exactD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_exact_conj_impl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∧*</span> sep_true<span class="main">)</span> <span class="free">h</span><span class="main">;</span> <span class="free">P</span> <span class="free">h</span><span class="main">;</span> strictly_exact <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∧*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⟶*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conjI sep_implI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> strictly_exactD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE
            <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_add_commute sep_add_assoc<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> sep<span class="main">:</span> ab_semigroup_mult <span class="quoted"><span class="quoted">"<span class="main">(**)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ab_semigroup_mult_sep_conj<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> sep<span class="main">:</span> comm_monoid_add <span class="quoted"><span class="quoted">"<span class="main">(**)</span>"</span></span> <span class="quoted"><span class="main">□</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> comm_monoid_add<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Separation Algebra with Stronger, but More Intuitive Disjunction Axiom›</span></span>

<span class="keyword1"><span class="command">class</span></span> stronger_sep_algebra <span class="main">=</span> pre_sep_algebra <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sep_add_disj_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">##</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">##</span> <span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_add_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">z</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_add_disj_eq sep_disj_commute<span class="main">)</span>

<span class="keyword1"><span class="command">subclass</span></span> sep_algebra <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Folding separating conjunction over lists of predicates›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_list_conj_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀*</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">□</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_list_conj_def<span class="main">)</span>

<span class="comment1">(* apparently these two are rarely used and had to be removed from List.thy *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semigroup_add<span class="main">)</span> foldl_assoc<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="free">y</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>add.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid_add<span class="main">)</span> foldl_absorb0<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="free">x</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>foldl_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_list_conj_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀*</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">**</span> <span class="main">⋀*</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_list_conj_def sep.foldl_absorb0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_list_conj_append <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀*</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋀*</span> <span class="free">xs</span> <span class="main">**</span> <span class="main">⋀*</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_list_conj_def sep.foldl_absorb0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> comm_monoid_add<span class="main">)</span> foldl_map_filter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
     foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>filter <span class="main">(</span><span class="keyword1">not</span> <span class="free">P</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>
   <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>map <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
               foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>filter <span class="free">P</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
               foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> eq_commute<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> foldl_Cons'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> foldl_absorb0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> foldl_Cons <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_Cons' IH <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> foldl_Cons <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_Cons' IH <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Separation Algebra with a Cancellative Monoid (for completeness)›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Separation algebra with a cancellative monoid. The results of being a precise
  assertion (distributivity over separating conjunction) require this.
  although we never actually use this property in our developments, we keep
  it here for completeness.
›</span></span>
<span class="keyword1"><span class="command">class</span></span> cancellative_sep_algebra <span class="main">=</span> sep_algebra <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sep_add_cancelD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">+</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span> <span class="main">;</span> <span class="free">x</span> <span class="main">##</span> <span class="free">z</span> <span class="main">;</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="comment1">(* In any heap, there exists at most one subheap for which P holds *)</span>
  <span class="entity">precise</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">precise</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span> <span class="bound">hp</span> <span class="bound">hp'</span><span class="main">.</span> <span class="bound">hp</span> <span class="main">≼</span> <span class="bound">h</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">hp</span> <span class="main">∧</span> <span class="bound">hp'</span> <span class="main">≼</span> <span class="bound">h</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">hp'</span> <span class="main">⟶</span> <span class="bound">hp</span> <span class="main">=</span> <span class="bound">hp'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"precise <span class="main">(</span><span class="main">(=)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> precise_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_add_cancel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">##</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">##</span> <span class="free">z</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sep_add_cancelD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> precise_distribute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"precise <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">Q</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Q</span> <span class="keyword1">and</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">Q</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="bound">R</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> pp<span class="main">:</span> <span class="quoted"><span class="quoted">"precise <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="skolem">R</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">hp</span> <span class="skolem">hp'</span> <span class="skolem">s</span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">and</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">Q</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="skolem">R</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjD <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Q</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> qr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">R</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>

      <span class="keyword1"><span class="command">from</span></span> qs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> sxy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">##</span> <span class="skolem">y</span>"</span></span>
                           <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjD<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> qr <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> sxy'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">x'</span> <span class="main">+</span> <span class="skolem">y'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xy'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">##</span> <span class="skolem">y'</span>"</span></span>
                           <span class="keyword2"><span class="keyword">and</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjD<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> sxy <span class="keyword1"><span class="command">have</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≼</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xy
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_substate_disj_add' sep_disj_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sxy' <span class="keyword1"><span class="command">have</span></span> ys'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">≼</span> <span class="skolem">x'</span> <span class="main">+</span> <span class="skolem">y'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xy'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_substate_disj_add' sep_disj_commute<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> pp <span class="keyword1"><span class="command">have</span></span> yy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sxy sxy' xy xy' y y' ys ys'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> precise_def<span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sxy sxy' xy xy'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_add_cancelD<span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">and</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sxy x x' yy y' xy'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">and</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Q</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="skolem">R</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Q</span> <span class="keyword1">and</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">Q</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="bound">R</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Q</span> <span class="keyword1">and</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">Q</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="bound">R</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"precise <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> precise_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">hp</span> <span class="skolem">hp'</span> <span class="skolem">Q</span> <span class="skolem">R</span>
    <span class="keyword3"><span class="command">assume</span></span> hp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hp</span> <span class="main">≼</span> <span class="skolem">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hp'</span> <span class="main">≼</span> <span class="skolem">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> php<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">hp</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> php'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">hp'</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> hhp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="skolem">hp</span> <span class="main">+</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hpz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hp</span> <span class="main">##</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hp
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_substate_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> hhp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="skolem">hp'</span> <span class="main">+</span> <span class="skolem">z'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hpz'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hp'</span> <span class="main">##</span> <span class="skolem">z'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hp'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_substate_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> h_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">+</span> <span class="skolem">hp'</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">hp</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hhp hhp' hpz hpz'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_add_ac<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> hhp hhp' a hpz hpz' h_eq
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">Q</span> <span class="keyword1">and</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="skolem">hp</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">Q</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="bound">R</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z'</span> <span class="main">+</span> <span class="skolem">hp'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_eq sep_add_ac sep_conj_commute<span class="main">)</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(=)</span> <span class="skolem">z</span> <span class="keyword1">and</span> <span class="main">(=)</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">+</span> <span class="skolem">hp</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">(</span><span class="main">(=)</span> <span class="skolem">z</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="main">(=)</span> <span class="skolem">z'</span> <span class="main">∧*</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z'</span> <span class="main">+</span> <span class="skolem">hp'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">thus</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">hp</span> <span class="main">=</span> <span class="skolem">hp'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> php php' hpz hpz' h_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iffD2 <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong
                    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_add_ac sep_add_cancel sep_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strictly_precise<span class="main">:</span> <span class="quoted"><span class="quoted">"strictly_exact <span class="free">P</span> <span class="main">⟹</span> precise <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> precise_def strictly_exactD<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sep_Heap_Instance">
<div class="head">
<h1>Theory Sep_Heap_Instance</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Gerwin Klein, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Standard Heaps as an Instance of Separation Algebra"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sep_Heap_Instance
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Separation_Algebra.html">Separation_Algebra</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Example instantiation of a the separation algebra to a map, i.e.\ a
  function from any type to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> opt <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">none</span></span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">domain</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">≠</span> none<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> option <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">opt</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> none_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"none <span class="main">≡</span> None"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">opt</span><span class="main">)</span> <span class="quoted">zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> zero_fun_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> none"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">opt</span><span class="main">)</span> <span class="quoted">sep_algebra</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  plus_fun_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="bound">x</span> <span class="main">=</span> none <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  sep_disj_fun_def<span class="main">:</span> <span class="quoted"><span class="quoted">"sep_disj <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">≡</span> domain <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">∩</span> domain <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_disj_fun_def domain_def zero_fun_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_disj_fun_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_fun_def zero_fun_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_fun_def sep_disj_fun_def domain_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_fun_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_disj_fun_def domain_def plus_fun_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_disj_fun_def domain_def plus_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For the actual option type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> domain<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>+›</span></span></span></span> are
  just <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> dom<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>++›</span></span></span></span>:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> domain_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"domain <span class="main">=</span> dom"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domain_def dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plus_fun_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="main">++</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_fun_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> map_convs <span class="main">=</span> domain_conv plus_fun_conv

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Any map can now act as a separation heap without further work:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">=&gt;</span> nat<span class="main">)</span> <span class="main">=&gt;</span> <span class="tfree">'foo</span> option"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span> <span class="main">**</span> <span class="free">H</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">H</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_ac<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Sep_Tactics">
<div class="head">
<h1>Theory Sep_Tactics</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: Gerwin Klein and Rafal Kolanski, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Separation Logic Tactics"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sep_Tactics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Separation_Algebra.html">Separation_Algebra</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹sep_tactics.ML›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A number of proof methods to assist with reasoning about separation logic.›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Selection (move-to-front) tactics›</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> sep_select <span class="main">=</span> <span class="quoted">‹
  Scan.lift Parse.int &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">sep_select_tac</span> <span class="entity">ctxt</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Select nth separation conjunct in conclusion"</span>

<span class="keyword1"><span class="command">method_setup</span></span> sep_select_asm <span class="main">=</span> <span class="quoted">‹
  Scan.lift Parse.int &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">sep_select_asm_tac</span> <span class="entity">ctxt</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Select nth separation conjunct in assumptions"</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Substitution›</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> <span class="quoted">"sep_subst"</span> <span class="main">=</span> <span class="quoted">‹
  Scan.lift <span class="main">(</span>Args.mode <span class="inner_quoted">"asm"</span> -- Scan.optional <span class="main">(</span>Args.parens <span class="main">(</span>Scan.repeat Parse.nat<span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="inner_numeral">0</span><span class="main">]</span><span class="main">)</span> --
    <span class="entity">Attrib.thms</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">asm</span><span class="main">,</span> <span class="entity">occs</span><span class="main">)</span><span class="main">,</span> <span class="entity">thms</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
      <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">asm</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">sep_subst_asm_tac</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">sep_subst_tac</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">occs</span> <span class="entity">thms</span><span class="main">)</span><span class="main">)</span>
›</span>
<span class="quoted">"single-step substitution after solving one separation logic assumption"</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Forward Reasoning›</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> <span class="quoted">"sep_drule"</span> <span class="main">=</span> <span class="quoted">‹
  <span class="entity">Attrib.thms</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thms</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">sep_dtac</span> <span class="entity">ctxt</span> <span class="entity">thms</span><span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"drule after separating conjunction reordering"</span>

<span class="keyword1"><span class="command">method_setup</span></span> <span class="quoted">"sep_frule"</span> <span class="main">=</span> <span class="quoted">‹
  <span class="entity">Attrib.thms</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thms</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">sep_ftac</span> <span class="entity">ctxt</span> <span class="entity">thms</span><span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"frule after separating conjunction reordering"</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Backward Reasoning›</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> <span class="quoted">"sep_rule"</span> <span class="main">=</span> <span class="quoted">‹
  <span class="entity">Attrib.thms</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thms</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">sep_rtac</span> <span class="entity">ctxt</span> <span class="entity">thms</span><span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"applies rule after separating conjunction reordering"</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Cancellation of Common Conjuncts via Elimination Rules›</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> sep_cancel

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The basic <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sep_cancel_tac›</span></span></span></span> is minimal. It only eliminates
  erule-derivable conjuncts between an assumption and the conclusion.

  To have a more useful tactic, we augment it with more logic, to proceed as
  follows:
  \begin{itemize}
  \item try discharge the goal first using <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>tac›</span></span></span></span>
  \item if that fails, invoke <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sep_cancel_tac›</span></span></span></span>
  \item if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sep_cancel_tac›</span></span></span></span> succeeds
    \begin{itemize}
    \item try to finish off with tac (but ok if that fails)
    \item try to finish off with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sep_true</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (but ok if that fails)
    \end{itemize}
  \end{itemize}
›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_cancel_smart_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">TRY'</span> <span class="entity">tac</span> <span class="main">=</span> <span class="entity">tac</span> ORELSE' <span class="main">(</span>K all_tac<span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">tac</span>
      ORELSE' <span class="main">(</span><span class="entity">sep_cancel_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span>
               THEN' <span class="entity">TRY'</span> <span class="entity">tac</span>
               THEN' <span class="entity">TRY'</span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> TrueI<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span>
      ORELSE' <span class="main">(</span>eresolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> sep_conj_sep_emptyE<span class="antiquote">}</span></span></span>
               THEN' <span class="entity">sep_cancel_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span>
               THEN' <span class="entity">TRY'</span> <span class="entity">tac</span>
               THEN' <span class="entity">TRY'</span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> TrueI<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_cancel_smart_tac_rules</span> <span class="entity">ctxt</span> <span class="entity">etacs</span> <span class="main">=</span>
      <span class="entity">sep_cancel_smart_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>FIRST' <span class="main">(</span><span class="main">[</span>assume_tac <span class="entity">ctxt</span><span class="main">]</span> @ <span class="entity">etacs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sep_cancel_syntax</span> <span class="main">=</span> <span class="entity">Method.sections</span> <span class="main">[</span>
    Args.add -- Args.colon &gt;&gt;
      K <span class="main">(</span><span class="entity">Method.modifier</span> <span class="main">(</span><span class="entity">Named_Theorems.add</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> sep_cancel<span class="antiquote">}</span></span><span class="main">)</span> <span class="antiquoted"><span class="operator"><span class="entity">⌂</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">method_setup</span></span> sep_cancel <span class="main">=</span> <span class="quoted">‹
  <span class="entity">sep_cancel_syntax</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">etacs</span> <span class="main">=</span> map <span class="main">(</span>eresolve_tac <span class="entity">ctxt</span> o single<span class="main">)</span>
        <span class="main">(</span>rev <span class="main">(</span><span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> sep_cancel<span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">sep_cancel_smart_tac_rules</span> <span class="entity">ctxt</span> <span class="entity">etacs</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
›</span> <span class="quoted">"Separating conjunction conjunct cancellation"</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As above, but use blast with a depth limit to figure out where cancellation
  can be done.›</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> sep_cancel_blast <span class="main">=</span> <span class="quoted">‹
  <span class="entity">sep_cancel_syntax</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rules</span> <span class="main">=</span> rev <span class="main">(</span><span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> sep_cancel<span class="antiquote">}</span></span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span> <span class="entity">Blast.depth_tac</span> <span class="main">(</span><span class="entity">ctxt</span> <span class="entity">addIs</span> <span class="entity">rules</span><span class="main">)</span> <span class="inner_numeral">10</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">sep_cancel_smart_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
›</span> <span class="quoted">"Separating conjunction conjunct cancellation using blast"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/sep_tactics.ML">
<div class="head">
<h1>File ‹sep_tactics.ML›</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Tactics for abstract separation algebras
   Authors: Gerwin Klein and Rafal Kolanski, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="comment1">(* Separating Conjunction (and Top, AKA sep_true) {{{

  This defines all the constants and theorems necessary for the conjunct
  selection and cancelling tactic, as well as utility functions.
*)</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">SepConj</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sep_conj_term</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">sep_conj</span><span class="antiquote">}</span></span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sep_conj_str</span> <span class="main">=</span> <span class="inner_quoted">"**"</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sep_conj_ac</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> sep_conj_ac<span class="antiquote">}</span></span></span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sep_conj_impl</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sep_conj_impl<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_sep_conj_const</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> sep_conj<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_sep_conj_const</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_sep_conj_term</span>
      <span class="main">(</span>Const <span class="entity">t</span> $ <span class="main">_</span> $ <span class="main">_</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">is_sep_conj_const</span> <span class="main">(</span>Const <span class="entity">t</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">is_sep_conj_term</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_sep_conj_prop</span>
      <span class="main">(</span>Const <span class="entity">Trueprop</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">is_sep_conj_term</span> <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">is_sep_conj_prop</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">break_sep_conj</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> sep_conj<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ <span class="entity">t1</span> $ <span class="entity">t2</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">[</span><span class="entity">t1</span><span class="main">]</span> @ <span class="main">(</span><span class="entity">break_sep_conj</span> <span class="entity">t2</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">break_sep_conj</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> sep_conj<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ <span class="entity">t1</span> $ <span class="entity">t2</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">[</span><span class="entity">t1</span><span class="main">]</span> @ <span class="main">(</span><span class="entity">break_sep_conj</span> <span class="entity">t2</span><span class="main">)</span>
  <span class="comment1">(* dig through eta exanded terms: *)</span>
  <span class="main">|</span> <span class="entity">break_sep_conj</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">t</span> $ Bound <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">break_sep_conj</span> <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">break_sep_conj</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_sep_true_term</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> True<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_sep_true_term</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* }}} *)</span>

<span class="comment1">(* Convenience functions for lists {{{ *)</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">ListExtra</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init</span> <span class="entity">l</span> <span class="main">=</span> List.take <span class="main">(</span><span class="entity">l</span><span class="main">,</span> List.length <span class="entity">l</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">range</span> <span class="main">_</span> <span class="inner_numeral">0</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">range</span> <span class="entity">from</span> <span class="entity">howmany</span> <span class="main">=</span> <span class="entity">from</span> :: <span class="main">(</span><span class="entity">range</span> <span class="main">(</span><span class="entity">from</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span><span class="entity">howmany</span>-<span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* move nth element in list to the front *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">nth_to_front</span> <span class="entity">i</span> <span class="entity">xs</span> <span class="main">=</span>
      <span class="main">(</span>nth <span class="entity">xs</span> <span class="entity">i</span><span class="main">)</span> :: <span class="main">(</span>List.take <span class="main">(</span><span class="entity">xs</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> @ <span class="main">(</span>List.drop <span class="main">(</span><span class="entity">xs</span><span class="main">,</span><span class="entity">i</span>+<span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="comment1">(* assign all members of list an index in the list *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">index_list</span> <span class="entity">xs</span> <span class="main">=</span> ListPair.zip <span class="main">(</span><span class="entity">range</span> <span class="inner_numeral">0</span> <span class="main">(</span>length <span class="entity">xs</span><span class="main">)</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span> <span class="comment1">(* }}} *)</span>

<span class="comment1">(* Function application terms {{{ *)</span>
<span class="comment1">(* Dealing with function applications of the type
     Const/Free(name,type) $ arg1 $ arg2 $ ... $ last_arg *)</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">FunApp</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="comment1">(* apply a transformation to the args in a function application term *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">app_args_op</span> <span class="entity">f</span> <span class="entity">t</span> <span class="main">=</span> strip_comb <span class="entity">t</span> |&gt; apsnd <span class="entity">f</span> |&gt; list_comb<span class="main">;</span>

<span class="comment1">(* remove last argument *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">app_del_last_arg</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">app_args_op</span> <span class="entity">ListExtra.init</span> <span class="entity">t</span><span class="main">;</span>

<span class="comment1">(* apply a function term to a Free with given name *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fun_app_free</span> <span class="entity">t</span> <span class="entity">free_name</span> <span class="main">=</span> <span class="entity">t</span> $ Free <span class="main">(</span><span class="entity">free_name</span><span class="main">,</span> type_of <span class="entity">t</span> |&gt; domain_type<span class="main">)</span><span class="main">;</span>

<span class="comment1">(* fold two-argument function over a list of arg names using fun_app_free *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fun_app_foldr</span> <span class="entity">f</span> <span class="main">[</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">]</span> <span class="main">=</span> <span class="entity">fun_app_free</span> <span class="main">(</span><span class="entity">fun_app_free</span> <span class="entity">f</span> <span class="entity">a</span><span class="main">)</span> <span class="entity">b</span>
  <span class="main">|</span> <span class="entity">fun_app_foldr</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">fun_app_free</span> <span class="entity">f</span> <span class="entity">x</span><span class="main">)</span> $ <span class="main">(</span><span class="entity">fun_app_foldr</span> <span class="entity">f</span> <span class="entity">xs</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">fun_app_foldr</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"fun_app_foldr"</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span> <span class="comment1">(* }}} *)</span>

<span class="comment1">(* Selecting Conjuncts in Premise or Conclusion {{{ *)</span>

<span class="comment1">(* Constructs a rearrangement lemma of the kind:
   (A ** B ** C) s ==&gt; (C ** A ** B) s
   When cjt_select = 2 (0-based index of C) and
   cjt_select = 3 (number of conjuncts to use), conclusion = true
   "conclusion" specifies whether the rearrangement occurs in conclusion
   (for dtac) or the premise (for rtac) of the rule.
*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_sep_select_rule</span> <span class="entity">ctxt</span> <span class="entity">conclusion</span> <span class="main">(</span><span class="entity">cjt_count</span><span class="main">,</span> <span class="entity">cjt_select</span><span class="main">)</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">variants</span> <span class="entity">nctxt</span> <span class="entity">names</span> <span class="main">=</span> fold_map Name.variant <span class="entity">names</span> <span class="entity">nctxt</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">state</span><span class="main">,</span> <span class="entity">nctxt0</span><span class="main">)</span> <span class="main">=</span> Name.variant <span class="inner_quoted">"s"</span> <span class="main">(</span>Variable.names_of <span class="entity">ctxt</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_conj_prop</span> <span class="entity">cjts</span> <span class="main">=</span>
        <span class="entity">FunApp.fun_app_free</span>
          <span class="main">(</span><span class="entity">FunApp.fun_app_foldr</span> <span class="entity">SepConj.sep_conj_term</span> <span class="entity">cjts</span><span class="main">)</span> <span class="entity">state</span>
        |&gt; <span class="entity">HOLogic.mk_Trueprop</span><span class="main">;</span>

  <span class="comment1">(* concatenate string and string of an int *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">conc_str_int</span> <span class="entity">str</span> <span class="entity">int</span> <span class="main">=</span> <span class="entity">str</span> ^ Int.toString <span class="entity">int</span><span class="main">;</span>

  <span class="comment1">(* make the conjunct names *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">cjts</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">ListExtra.range</span> <span class="inner_numeral">1</span> <span class="entity">cjt_count</span>
                  |&gt; map <span class="main">(</span><span class="entity">conc_str_int</span> <span class="inner_quoted">"a"</span><span class="main">)</span> |&gt; <span class="entity">variants</span> <span class="entity">nctxt0</span><span class="main">;</span>

  <span class="comment1">(* make normal-order separation conjunction terms *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">orig</span> <span class="main">=</span> <span class="entity">sep_conj_prop</span> <span class="entity">cjts</span><span class="main">;</span>

  <span class="comment1">(* make reordered separation conjunction terms *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">reordered</span> <span class="main">=</span> <span class="entity">sep_conj_prop</span> <span class="main">(</span><span class="entity">ListExtra.nth_to_front</span> <span class="entity">cjt_select</span> <span class="entity">cjts</span><span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> Logic.mk_implies
               <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">conclusion</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">orig</span><span class="main">,</span> <span class="entity">reordered</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">reordered</span><span class="main">,</span> <span class="entity">orig</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

  <span class="comment1">(* simp add: sep_conj_ac *)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sep_conj_ac_tac</span> <span class="main">=</span> <span class="entity">Simplifier.asm_full_simp_tac</span>
                          <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="entity">SepConj.sep_conj_ac</span><span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">in</span></span>
  <span class="comment1">(* XXX: normally you'd want to keep track of what variables we want to make
     schematic and which ones are bound, but we don't use fixed names for
     the rules we make, so we use Drule.export_without_context to schematise
     all. *)</span>
  Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">goal</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">sep_conj_ac_tac</span> <span class="inner_numeral">1</span><span class="main">)</span>
  |&gt; Drule.export_without_context
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* }}} *)</span>

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="comment1">(* Common tactic functionality {{{ *)</span>

  <span class="comment1">(* given two terms of some 'a to bool, can you prove
     ⋀s. t1 s ⟹ t2 s
     using the supplied proof method?
     NOTE: t1 and t2 MUST have a function type with one argument,
     or TYPE dest_Type is raised
     NOTE: if asm or concl is sep_true, returns false
  *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">can_prove</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="entity">asm</span> <span class="entity">concl</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">variant</span> <span class="entity">name</span> <span class="main">=</span> Name.variant <span class="entity">name</span> <span class="main">(</span>Variable.names_of <span class="entity">ctxt</span><span class="main">)</span> |&gt; fst<span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">arg_name</span> <span class="main">=</span> <span class="entity">variant</span> <span class="inner_quoted">"s"</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">left</span> <span class="main">=</span> <span class="entity">FunApp.fun_app_free</span> <span class="entity">asm</span> <span class="entity">arg_name</span> |&gt; <span class="entity">HOLogic.mk_Trueprop</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">right</span> <span class="main">=</span> <span class="entity">FunApp.fun_app_free</span> <span class="entity">concl</span> <span class="entity">arg_name</span> |&gt; <span class="entity">HOLogic.mk_Trueprop</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> Logic.mk_implies <span class="main">(</span><span class="entity">left</span><span class="main">,</span> <span class="entity">right</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">SepConj.is_sep_true_term</span> <span class="entity">asm</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="main">(</span><span class="entity">SepConj.is_sep_true_term</span> <span class="entity">concl</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">then</span></span> false
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">goal</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">tac</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">;</span> true<span class="main">)</span>
            <span class="keyword3"><span class="keyword">handle</span></span> ERROR <span class="main">_</span> <span class="main">=&gt;</span> false
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="comment1">(* apply function in list until it returns SOME *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_some</span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">)</span> <span class="entity">f</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">f</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">v</span> <span class="main">=&gt;</span> SOME <span class="entity">v</span>
               <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="entity">find_some</span> <span class="entity">xs</span> <span class="entity">f</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">find_some</span> <span class="main">[</span><span class="main">]</span> <span class="main">_</span> <span class="main">=</span> NONE<span class="main">;</span>

  <span class="comment1">(* Given indices into the separating conjunctions in the assumption and
     conclusion, rewrite them so that the targeted conjuncts are at the
     front, then remove them. *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eliminate_target_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span>
                           <span class="main">(</span><span class="main">(</span><span class="entity">prem_total</span><span class="main">,</span><span class="entity">prem_idx</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">concl_total</span><span class="main">,</span><span class="entity">concl_idx</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">asm_select</span> <span class="main">=</span> <span class="entity">mk_sep_select_rule</span> <span class="entity">ctxt</span> true <span class="main">(</span><span class="entity">prem_total</span><span class="main">,</span><span class="entity">prem_idx</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl_select</span> <span class="main">=</span> <span class="entity">mk_sep_select_rule</span> <span class="entity">ctxt</span> false
                           <span class="main">(</span><span class="entity">concl_total</span><span class="main">,</span><span class="entity">concl_idx</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      dresolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">asm_select</span><span class="main">]</span> THEN'
      resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">concl_select</span><span class="main">]</span> THEN'
      eresolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">SepConj.sep_conj_impl</span><span class="main">]</span> THEN' <span class="entity">tac</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_target</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="entity">cprem</span> <span class="entity">cconcl</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prem_cjts</span> <span class="main">=</span> <span class="entity">cprem</span> |&gt; Thm.term_of |&gt; <span class="entity">SepConj.break_sep_conj</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl_cjts</span> <span class="main">=</span> <span class="entity">cconcl</span> |&gt; Thm.term_of |&gt; <span class="entity">SepConj.break_sep_conj</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">iprems</span> <span class="main">=</span> <span class="entity">ListExtra.index_list</span> <span class="entity">prem_cjts</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">iconcls</span> <span class="main">=</span> <span class="entity">ListExtra.index_list</span> <span class="entity">concl_cjts</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">can_prove'</span> <span class="main">(</span><span class="entity">pi</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">ci</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">can_prove</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="entity">p</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="main">(</span><span class="entity">pi</span><span class="main">,</span> <span class="entity">ci</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> NONE<span class="main">;</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">target</span> <span class="main">=</span> <span class="entity">find_some</span> <span class="entity">iconcls</span>
                     <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">c</span> <span class="main">=&gt;</span> <span class="entity">find_some</span> <span class="entity">iprems</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">can_prove'</span> <span class="entity">p</span> <span class="entity">c</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">target</span>
        <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="main">(</span><span class="entity">pi</span><span class="main">,</span><span class="entity">ci</span><span class="main">)</span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="main">(</span>List.length <span class="entity">prem_cjts</span><span class="main">,</span> <span class="entity">pi</span><span class="main">)</span><span class="main">,</span>
                                 <span class="main">(</span>List.length <span class="entity">concl_cjts</span><span class="main">,</span> <span class="entity">ci</span><span class="main">)</span><span class="main">)</span>
         <span class="main">|</span> NONE <span class="main">=&gt;</span> NONE
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_cprop</span> <span class="entity">ct</span> <span class="main">=</span> <span class="main">(</span><span class="entity">HOLogic.dest_Trueprop</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span><span class="main">;</span> Thm.dest_arg <span class="entity">ct</span><span class="main">)</span><span class="main">;</span>

  <span class="comment1">(* }}} *)</span>
<span class="keyword2"><span class="keyword">in</span></span>

  <span class="comment1">(* Tactic: Select nth conjunct in assumption {{{ *)</span>
  <span class="keyword2"><span class="keyword">local</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_select_asm_tac'</span> <span class="entity">ctxt</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">ct</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="comment1">(* digging out prems *)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ct'</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Variable.focus_cterm NONE <span class="entity">ct</span> <span class="entity">ctxt</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> Drule.strip_imp_prems <span class="entity">ct'</span><span class="main">;</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prem_ok</span> <span class="entity">ct</span> <span class="main">=</span> <span class="entity">SepConj.is_sep_conj_prop</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_tac</span> <span class="entity">prem</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prem</span> <span class="main">=</span> <span class="entity">HOLogic.dest_Trueprop</span> <span class="main">(</span>Thm.term_of <span class="entity">prem</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> length <span class="main">(</span><span class="entity">SepConj.break_sep_conj</span> <span class="entity">prem</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">mk_sep_select_rule</span> <span class="entity">ctxt</span> true <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span>
                  <span class="keyword3"><span class="keyword">handle</span></span> Subscript <span class="main">=&gt;</span> error <span class="inner_quoted">"Conjunct index out of range"</span>
             <span class="keyword2"><span class="keyword">in</span></span>
               dresolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">th</span><span class="main">]</span> <span class="entity">i</span>
             <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> length <span class="entity">prems</span> <span class="main">=</span> <span class="inner_numeral">0</span>
        <span class="keyword2"><span class="keyword">then</span></span> error <span class="main">(</span><span class="inner_quoted">"No assumption of form: (_ "</span> ^ <span class="entity">SepConj.sep_conj_str</span> ^
                    <span class="inner_quoted">" _) _"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="comment1">(* backtrack until first premise that does something *)</span>
          map <span class="entity">mk_tac</span> <span class="main">(</span>filter <span class="entity">prem_ok</span> <span class="entity">prems</span><span class="main">)</span> |&gt; FIRST
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_select_asm_tac</span> <span class="entity">ctxt</span> <span class="entity">n</span> <span class="main">=</span> CSUBGOAL <span class="main">(</span><span class="entity">sep_select_asm_tac'</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span> <span class="comment1">(* }}} *)</span>

  <span class="comment1">(* Tactic: Select nth conjunct in conclusion {{{ *)</span>
  <span class="keyword2"><span class="keyword">local</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_select_tac'</span> <span class="entity">ctxt</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">ct</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="comment1">(* digging out conclusions *)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ct'</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Variable.focus_cterm NONE <span class="entity">ct</span> <span class="entity">ctxt</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> <span class="entity">ct'</span> |&gt; Drule.strip_imp_concl |&gt; Thm.term_of<span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">concl</span> |&gt; <span class="entity">HOLogic.dest_Trueprop</span> |&gt; <span class="entity">SepConj.break_sep_conj</span>
                |&gt; length<span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th</span> <span class="main">=</span> <span class="entity">mk_sep_select_rule</span> <span class="entity">ctxt</span> false <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span>
                 <span class="keyword3"><span class="keyword">handle</span></span> Subscript <span class="main">=&gt;</span> error <span class="inner_quoted">"Conjunct index out of range"</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">SepConj.is_sep_conj_prop</span> <span class="entity">concl</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">then</span></span> error <span class="main">(</span><span class="inner_quoted">"Goal not of form: (_ "</span> ^ <span class="entity">SepConj.sep_conj_str</span> ^ <span class="inner_quoted">" _) _"</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">th</span><span class="main">]</span> <span class="entity">i</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_select_tac</span> <span class="entity">ctxt</span> <span class="entity">n</span> <span class="main">=</span> CSUBGOAL <span class="main">(</span><span class="entity">sep_select_tac'</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span> <span class="comment1">(* }}} *)</span>

  <span class="comment1">(* Tactic: for all reorderings of the premises try apply tac {{{ *)</span>
    <span class="keyword2"><span class="keyword">local</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_assm_tac'</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">ct</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="comment1">(* digging out prems *)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ct'</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Variable.focus_cterm NONE <span class="entity">ct</span> <span class="entity">ctxt</span><span class="main">;</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> Drule.strip_imp_prems <span class="entity">ct'</span><span class="main">;</span>

          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prem_ok</span> <span class="entity">ct</span> <span class="main">=</span> <span class="entity">SepConj.is_sep_conj_prop</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span>

          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_tac</span> <span class="entity">prem</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prem</span> <span class="main">=</span> <span class="entity">HOLogic.dest_Trueprop</span> <span class="main">(</span>Thm.term_of <span class="entity">prem</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> length <span class="main">(</span><span class="entity">SepConj.break_sep_conj</span> <span class="entity">prem</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ord</span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">mk_sep_select_rule</span> <span class="entity">ctxt</span> true <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ord_thms</span> <span class="main">=</span> map <span class="entity">ord</span> <span class="main">(</span><span class="inner_numeral">0</span> upto <span class="entity">p</span>-<span class="inner_numeral">1</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">in</span></span>
                <span class="main">(</span>dresolve_tac <span class="entity">ctxt</span> <span class="entity">ord_thms</span> THEN' <span class="entity">tac</span><span class="main">)</span> <span class="entity">i</span>
            <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="comment1">(* backtrack until first premise that does something *)</span>
          map <span class="entity">mk_tac</span> <span class="main">(</span>filter <span class="entity">prem_ok</span> <span class="entity">prems</span><span class="main">)</span> |&gt; FIRST
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_assm_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">=</span> CSUBGOAL <span class="main">(</span><span class="entity">sep_assm_tac'</span> <span class="entity">ctxt</span> <span class="entity">tac</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span> <span class="comment1">(* }}} *)</span>

  <span class="comment1">(* Tactic: for all reorderings of the conclusion, try apply tac {{{ *)</span>
  <span class="keyword2"><span class="keyword">local</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_concl_tac'</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">ct</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="comment1">(* digging out conclusion *)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ct'</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Variable.focus_cterm NONE <span class="entity">ct</span> <span class="entity">ctxt</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> <span class="entity">ct'</span> |&gt; Drule.strip_imp_concl |&gt; Thm.term_of<span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">concl</span> |&gt; <span class="entity">HOLogic.dest_Trueprop</span> |&gt; <span class="entity">SepConj.break_sep_conj</span>
                |&gt; length<span class="main">;</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ord</span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">mk_sep_select_rule</span> <span class="entity">ctxt</span> false <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ord_thms</span> <span class="main">=</span> map <span class="entity">ord</span> <span class="main">(</span><span class="inner_numeral">0</span> upto <span class="entity">p</span>-<span class="inner_numeral">1</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">SepConj.is_sep_conj_prop</span> <span class="entity">concl</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>tracing <span class="main">(</span><span class="inner_quoted">"Goal not of form: (_ "</span> ^ <span class="entity">SepConj.sep_conj_str</span> ^
                      <span class="inner_quoted">" _) _"</span><span class="main">)</span><span class="main">;</span>
              no_tac<span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="entity">ord_thms</span> THEN' <span class="entity">tac</span><span class="main">)</span> <span class="entity">i</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_concl_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">=</span> CSUBGOAL <span class="main">(</span><span class="entity">sep_concl_tac'</span> <span class="entity">ctxt</span> <span class="entity">tac</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span> <span class="comment1">(* }}} *)</span>

  <span class="comment1">(* Tactic: Cancel conjuncts of assumption and conclusion via tac {{{ *)</span>
  <span class="keyword2"><span class="keyword">local</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_cancel_tac'</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">ct</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="comment1">(* digging out prems and conclusions *)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">vars</span><span class="main">,</span> <span class="entity">ct'</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt'</span><span class="main">)</span> <span class="main">=</span> Variable.focus_cterm NONE <span class="entity">ct</span> <span class="entity">ctxt</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> Drule.strip_imp_concl <span class="entity">ct'</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> Drule.strip_imp_prems <span class="entity">ct'</span><span class="main">;</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prem_ok</span> <span class="entity">ct</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="comment1">(* name of state in sep conj (should be Free after focus) *)</span>
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">state_get</span> <span class="main">(</span><span class="main">_</span> $ <span class="main">_</span> $ <span class="main">_</span> $ <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="entity">s</span>
              <span class="main">|</span> <span class="entity">state_get</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> Fail <span class="inner_quoted">"prem_ok: state_get"</span><span class="main">;</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">state_get_ct</span> <span class="main">=</span> <span class="entity">state_get</span> o <span class="entity">HOLogic.dest_Trueprop</span> o Thm.term_of<span class="main">;</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl_state</span> <span class="main">=</span> <span class="entity">concl</span> |&gt; <span class="entity">state_get_ct</span><span class="main">;</span>
            <span class="comment1">(* states considered equal if they alpha-convert *)</span>
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">state_ok</span> <span class="entity">ct</span> <span class="main">=</span> <span class="main">(</span><span class="entity">state_get_ct</span> <span class="entity">ct</span><span class="main">)</span> aconv <span class="entity">concl_state</span><span class="main">;</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">SepConj.is_sep_conj_prop</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">state_ok</span> <span class="entity">ct</span>
          <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_tac</span> <span class="entity">prem</span> <span class="main">=</span>
              <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">find_target</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">(</span><span class="entity">prem</span> |&gt; <span class="entity">strip_cprop</span><span class="main">)</span>
                                        <span class="main">(</span><span class="entity">strip_cprop</span> <span class="entity">concl</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">target</span> <span class="main">=&gt;</span> <span class="entity">eliminate_target_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="entity">target</span> <span class="entity">i</span>
                 <span class="main">|</span> NONE <span class="main">=&gt;</span> no_tac<span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>not <span class="main">(</span><span class="entity">concl</span> |&gt; Thm.term_of |&gt; <span class="entity">SepConj.is_sep_conj_prop</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>tracing <span class="main">(</span><span class="inner_quoted">"Goal not of form: (_ "</span> ^ <span class="entity">SepConj.sep_conj_str</span> ^
                       <span class="inner_quoted">" _) _"</span><span class="main">)</span><span class="main">;</span>
              no_tac<span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span>length <span class="entity">prems</span> <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>tracing <span class="main">(</span><span class="inner_quoted">"No assumption of form: (_ "</span> ^ <span class="entity">SepConj.sep_conj_str</span> ^
                       <span class="inner_quoted">" _) _"</span><span class="main">)</span><span class="main">;</span>
              no_tac<span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="comment1">(* backtrack until first premise that does something *)</span>
          map <span class="entity">mk_tac</span> <span class="main">(</span>filter <span class="entity">prem_ok</span> <span class="entity">prems</span><span class="main">)</span> |&gt; FIRST
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_cancel_tac</span> <span class="entity">ctxt</span> <span class="entity">tac</span> <span class="main">=</span> CSUBGOAL <span class="main">(</span><span class="entity">sep_cancel_tac'</span> <span class="entity">ctxt</span> <span class="entity">tac</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  <span class="comment1">(* }}} *)</span>

  <span class="comment1">(* Derived Tactics *)</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_atac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">sep_assm_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>assume_tac <span class="entity">ctxt</span><span class="main">)</span><span class="main">;</span>

  <span class="comment1">(* Substitution *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_subst_tac</span> <span class="entity">ctxt</span> <span class="entity">occs</span> <span class="entity">thms</span> <span class="main">=</span>
        <span class="entity">EqSubst.eqsubst_tac</span> <span class="entity">ctxt</span> <span class="entity">occs</span> <span class="entity">thms</span> THEN' <span class="entity">sep_atac</span> <span class="entity">ctxt</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_subst_asm_tac</span> <span class="entity">ctxt</span> <span class="entity">occs</span> <span class="entity">thms</span> <span class="main">=</span>
        <span class="entity">EqSubst.eqsubst_asm_tac</span> <span class="entity">ctxt</span> <span class="entity">occs</span> <span class="entity">thms</span> THEN' <span class="entity">sep_atac</span> <span class="entity">ctxt</span><span class="main">;</span>

  <span class="comment1">(* Forward reasoning *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_dtac</span> <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">sep_assm_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>dresolve_tac <span class="entity">ctxt</span> <span class="entity">thms</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_ftac</span> <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">sep_assm_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>forward_tac <span class="entity">ctxt</span> <span class="entity">thms</span><span class="main">)</span>

  <span class="comment1">(* Backward reasoning *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sep_rtac</span> <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">sep_concl_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="entity">thms</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="comment1">(* vim: set foldmethod=marker sw=2 sts=2 et: *)</span>

</pre>
</div><div id="Simple_Separation_Example">
<div class="head">
<h1>Theory Simple_Separation_Example</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Adaptation of example from HOL/Hoare/Separation
   Author: Gerwin Klein, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Example from HOL/Hoare/Separation"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Simple_Separation_Example
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Hoare/Hoare_Logic_Abort.html">HOL-Hoare.Hoare_Logic_Abort</a>"</span> <span class="quoted">"<a href="Sep_Heap_Instance.html">../Sep_Heap_Instance</a>"</span>
          <span class="quoted">"<a href="Sep_Tactics.html">../Sep_Tactics</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">syntax_ambiguity_warning</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">type_synonym</span></span> heap <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat option<span class="main">)</span>"</span></span>

<span class="comment1">(* This syntax isn't ideal, but this is what is used in the original *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maps_to</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> heap <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↦</span> _"</span> <span class="main">[</span>56<span class="main">,</span>51<span class="main">]</span> 56<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span>"</span></span>

<span class="comment1">(* If you don't mind syntax ambiguity: *)</span>
<span class="keyword1"><span class="command">notation</span></span> pred_ex  <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">∃</span>"</span> 10<span class="main">)</span>

<span class="comment1">(* could be generated automatically *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maps_to_ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> heap <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↦</span> <span class="keyword1">-</span>"</span> <span class="main">[</span>56<span class="main">]</span> 56<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="main"><span class="free">-</span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="bound">y</span>"</span></span>


<span class="comment1">(* could be generated automatically *)</span>
<span class="keyword1"><span class="command">lemma</span></span> maps_to_maps_to_ex <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="main">-</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> maps_to_ex_def<span class="main">)</span>

<span class="comment1">(* The basic properties of maps_to: *)</span>
<span class="keyword1"><span class="command">lemma</span></span> maps_to_write<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="main">-</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">H</span> <span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_def maps_to_def maps_to_ex_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_disj_fun_def map_convs map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> points_to<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">H</span> <span class="main">⟹</span> the <span class="main">(</span><span class="free">H</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE
           <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_disj_fun_def maps_to_def map_convs map_add_def
           <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>


<span class="comment1">(* This differs from the original and uses separation logic for the definition. *)</span>
<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list <span class="main">⇒</span> heap <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">=</span><span class="main">0</span><span class="main">⟩</span> <span class="keyword1">and</span> <span class="main">□</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">≠</span><span class="main">0</span><span class="main">⟩</span> <span class="keyword1">and</span> <span class="main">(</span><span class="keyword1">EXS</span> <span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">↦</span> <span class="bound">j</span> <span class="main">**</span> <span class="free">list</span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list <span class="main">0</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">□</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* The examples from Hoare/Separation.thy *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span> <span class="bound"><span class="bound">z</span></span> <span class="bound"><span class="bound">w</span></span> <span class="bound"><span class="bound">h</span></span>
 <span class="main">{</span><span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">y</span> <span class="main">**</span> <span class="bound">z</span> <span class="main">↦</span> <span class="bound">w</span><span class="main">)</span> <span class="bound">h</span><span class="main">}</span>
 <span class="keyword1">SKIP</span>
 <span class="main">{</span><span class="bound">x</span> <span class="main">≠</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> maps_to_def sep_disj_fun_def domain_conv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound">H</span></span> <span class="bound"><span class="bound">x</span></span> <span class="bound"><span class="bound">y</span></span> <span class="bound"><span class="bound">z</span></span> <span class="bound"><span class="bound">w</span></span>
 <span class="main">{</span><span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">H</span><span class="main">}</span>
 <span class="keyword1">SKIP</span>
 <span class="main">{</span><span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="bound">H</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_commute<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound">H</span></span></span>
 <span class="main">{</span><span class="free">p</span><span class="main">≠</span><span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="main">-</span> <span class="main">**</span> list <span class="free">q</span> <span class="free">qs</span><span class="main">)</span> <span class="bound">H</span><span class="main">}</span>
 H <span class="main">:=</span> <span class="bound">H</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">q</span><span class="main">)</span>
 <span class="main">{</span>list <span class="free">p</span> <span class="main">(</span><span class="free">p</span><span class="main">#</span><span class="free">qs</span><span class="main">)</span> <span class="bound">H</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> maps_to_write<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">H</span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">p</span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">q</span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">r</span></span></span></span></span></span></span></span></span></span></span></span>
  <span class="main">{</span><span class="main">(</span>list <span class="bound">p</span> <span class="free">Ps</span> <span class="main">**</span> list <span class="bound">q</span> <span class="free">Qs</span><span class="main">)</span> <span class="bound">H</span><span class="main">}</span>
  <span class="keyword1">WHILE</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">0</span>
  <span class="keyword1">INV</span> <span class="main">{</span><span class="main">∃</span><span class="bound">ps</span> <span class="bound">qs</span><span class="main">.</span> <span class="main">(</span>list <span class="bound">p</span> <span class="bound">ps</span> <span class="main">**</span> list <span class="bound">q</span> <span class="bound">qs</span><span class="main">)</span> <span class="bound">H</span> <span class="main">∧</span> rev <span class="bound">ps</span> <span class="main">@</span> <span class="bound">qs</span> <span class="main">=</span> rev <span class="free">Ps</span> <span class="main">@</span> <span class="free">Qs</span><span class="main">}</span>
  <span class="keyword1">DO</span> r <span class="main">:=</span> <span class="bound">p</span><span class="main">;</span> p <span class="main">:=</span> the<span class="main">(</span><span class="bound">H</span> <span class="bound">p</span><span class="main">)</span><span class="main">;</span> H <span class="main">:=</span> <span class="bound">H</span><span class="main">(</span><span class="bound">r</span> <span class="main">↦</span> <span class="bound">q</span><span class="main">)</span><span class="main">;</span> q <span class="main">:=</span> <span class="bound">r</span> <span class="keyword1">OD</span>
  <span class="main">{</span>list <span class="bound">q</span> <span class="main">(</span>rev <span class="free">Ps</span> <span class="main">@</span> <span class="free">Qs</span><span class="main">)</span> <span class="bound">H</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">ps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p ps'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_exists sep_conj_ac<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_subst</span> points_to<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">ps'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">p</span> <span class="main">#</span> <span class="improper">qs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_exists sep_conj_ac<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_rule</span> maps_to_write<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">sep_cancel</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maps_to_maps_to_ex<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sep_Tactics_Test">
<div class="head">
<h1>Theory Sep_Tactics_Test</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: Gerwin Klein and Rafal Kolanski, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Sep_Tactics_Test
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Sep_Tactics.html">../Sep_Tactics</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Substitution and forward/backward reasoning›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> p
<span class="keyword1"><span class="command">typedecl</span></span> val
<span class="keyword1"><span class="command">typedecl</span></span> heap

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> heap_sep_algebra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>heap<span class="main">,</span> sep_algebra_class<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> heap <span class="main">::</span> <span class="quoted">sep_algebra</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> heap_sep_algebra<span class="main">)</span>

<span class="keyword1"><span class="command">axiomatization</span></span>
  <span class="free">points_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"p <span class="main">⇒</span> val <span class="main">⇒</span> heap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"heap <span class="main">⇒</span> p <span class="main">⇒</span> val"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  points_to<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">points_to</span> <span class="free">p</span> <span class="free">v</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="free">val</span> <span class="free">h</span> <span class="free">p</span> <span class="main">=</span> <span class="free">v</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Q2</span> <span class="main">(</span>val <span class="free">h</span> <span class="free">p</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">K</span> <span class="main">**</span> <span class="free">T</span> <span class="main">**</span> <span class="free">blub</span> <span class="main">**</span> <span class="free">P</span> <span class="main">**</span> points_to <span class="free">p</span> <span class="free">v</span> <span class="main">**</span> <span class="free">P</span> <span class="main">**</span> <span class="free">J</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>val <span class="free">h</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>val <span class="free">h</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> points_to<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> points_to<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_subst</span> points_to<span class="main">)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Q2</span> <span class="main">(</span>val <span class="free">h</span> <span class="free">p</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">K</span> <span class="main">**</span> <span class="free">T</span> <span class="main">**</span> <span class="free">blub</span> <span class="main">**</span> <span class="free">P</span> <span class="main">**</span> points_to <span class="free">p</span> <span class="free">v</span> <span class="main">**</span> <span class="free">P</span> <span class="main">**</span> <span class="free">J</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>val <span class="free">h</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>val <span class="free">h</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_drule</span> points_to<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Q2</span> <span class="main">(</span>val <span class="free">h</span> <span class="free">p</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">K</span> <span class="main">**</span> <span class="free">T</span> <span class="main">**</span> <span class="free">blub</span> <span class="main">**</span> <span class="free">P</span> <span class="main">**</span> points_to <span class="free">p</span> <span class="free">v</span> <span class="main">**</span> <span class="free">P</span> <span class="main">**</span> <span class="free">J</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>val <span class="free">h</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>val <span class="free">h</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_frule</span> points_to<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  update <span class="main">::</span> <span class="quoted"><span class="quoted">"p <span class="main">⇒</span> val <span class="main">⇒</span> heap <span class="main">⇒</span> heap"</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="free">stuff</span> <span class="free">p</span> <span class="main">**</span> <span class="bound">P</span><span class="main">)</span> <span class="free">H</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">other_stuff</span> <span class="free">p</span> <span class="free">v</span> <span class="main">**</span> <span class="bound">P</span><span class="main">)</span> <span class="main">(</span>update <span class="free">p</span> <span class="free">v</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">**</span> <span class="free">Y</span> <span class="main">**</span> <span class="free">other_stuff</span> <span class="free">p</span> <span class="var">?v</span><span class="main">)</span> <span class="main">(</span>update <span class="free">p</span> <span class="free">v</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_rule</span> a<span class="main">)</span>
  <span class="keyword1"><span class="command">oops</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Example of low-level rewrites›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">unrelated</span> <span class="free">s</span> <span class="main">;</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">B</span> <span class="main">**</span> <span class="free">Q</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">‹dresolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">mk_sep_select_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> true <span class="main">(</span><span class="inner_numeral">3</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">]</span> <span class="inner_numeral">1</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">‹resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="main">[</span><span class="entity">mk_sep_select_rule</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> false <span class="main">(</span><span class="inner_numeral">4</span><span class="main">,</span> <span class="inner_numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="inner_numeral">1</span>›</span><span class="main">)</span>
  <span class="comment1">(* now sep_conj_impl1 can be used *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sep_conj_impl<span class="main">)</span>
  <span class="keyword1"><span class="command">oops</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Conjunct selection›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">B</span> <span class="main">**</span> <span class="free">Q</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_select</span> 1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_select</span> 3<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_select</span> 4<span class="main">)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">also</span> <span class="free">unrelated</span><span class="main">;</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">B</span> <span class="main">**</span> <span class="free">Q</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">unrelated</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_select_asm</span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">oops</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Test cases for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sep_cancel›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> forward<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">g</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> <span class="free">A</span> <span class="bound">g</span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">AA</span> <span class="bound">g</span> <span class="bound">p</span> <span class="bound">s</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xv</span> <span class="bound">yv</span> <span class="bound">P</span> <span class="bound">s</span> <span class="bound">y</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">yv</span> <span class="main">**</span> <span class="free">A</span> <span class="free">g</span> <span class="bound">y</span> <span class="bound">yv</span> <span class="main">**</span> <span class="bound">P</span><span class="main">)</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">AA</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">**</span> sep_true<span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_cancel</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> forward<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> forward<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">generic</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">instance</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">generic</span> <span class="main">**</span> <span class="free">B</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">instance</span> <span class="main">**</span> sep_true<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_cancel</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> forward<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">B</span><span class="main">)</span> <span class="free">sa</span> <span class="main">;</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">Y</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">X</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_cancel</span><span class="main">)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">B</span><span class="main">)</span> <span class="free">sa</span> <span class="main">;</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">Y</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">X</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_cancel</span><span class="main">)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">B</span> <span class="main">**</span> <span class="free">A</span> <span class="main">**</span> <span class="free">C</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="var">?X</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_cancel</span><span class="main">)</span>

<span class="comment1">(* test backtracking on premises with same state *)</span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> forward<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">generic</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">instance</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">A</span> <span class="main">**</span> <span class="free">B</span><span class="main">)</span> <span class="free">s</span> <span class="main">;</span> <span class="main">(</span><span class="free">generic</span> <span class="main">**</span> <span class="free">Y</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="main">**</span> <span class="free">instance</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_cancel</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> forward<span class="main">)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> forward<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">generic</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">instance</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">generic</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">instance</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_cancel</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> forward<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> forward<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">generic</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">instance</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> forward2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">instance</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">instance2</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">generic</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">instance2</span> <span class="main">**</span> sep_true<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_cancel_blast</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> forward forward2<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Map_Extra">
<div class="head">
<h1>Theory Map_Extra</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Rafal Kolanski, 2008
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹More properties of maps plus map disjuction.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Map_Extra
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A note on naming:
  Anything not involving heap disjuction can potentially be incorporated
  directly into Map.thy, thus uses <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> for map variable names.
  Anything involving heap disjunction is not really mergeable with Map, is
  destined for use in separation logic, and hence uses <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>h›</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Things that could go into Option Type›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Misc option lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> None_not_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>None <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> None_com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>None <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> Some_com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Things that go into Map.thy›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Map intersection: set of all keys for which the maps agree.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">map_inter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∩<span class="hidden">⇩</span><sub>m</sub></span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">∩<span class="hidden">⇩</span><sub>m</sub></span></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Map restriction via domain subtraction›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sub_restrict_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> set <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">`-</span>"</span>  110<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="free">`-</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of maps not related to restriction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_forall_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">=</span> Map.empty<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">m</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_empty2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> Map.empty<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="main">=</span> Map.empty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> dom <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> non_dom_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> non_dom_eval_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="free">x</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_same_left_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_left_cancelI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟹</span> <span class="free">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_empty_is_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>dom <span class="free">m</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="main">=</span> Map.empty<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> Map.empty"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> empty_forall_equiv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_dom_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">=</span> dom <span class="free">m'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">++</span> <span class="free">m'</span> <span class="main">=</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_right_dom_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">;</span> dom <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> dom <span class="free">m<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_add_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fun_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">drule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_same_dom_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> dom <span class="free">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> dom <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ballE<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of map restriction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_cancel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dom <span class="free">m</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> dom <span class="free">m</span> <span class="main">∩</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_cong
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def None_not_eq
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restricted_self <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">++</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict_dom_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">++</span> <span class="free">m'</span><span class="main">)</span> <span class="main">|`</span> dom <span class="free">m'</span> <span class="main">=</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_UNIV <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">|`</span> UNIV <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_dom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> dom <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def None_not_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_subdom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def None_com <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">++</span> <span class="main">(</span><span class="free">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m'</span> <span class="main">|`</span> dom <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_def restrict_map_def None_com <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">|`</span> <span class="free">S</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_remerge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">++</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">T</span> <span class="main">=</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def map_add_def
                         <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict_comp_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">++</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def restrict_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict_comp_right_dom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">++</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">(</span>dom <span class="free">m</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def restrict_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict_comp_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">|`</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">++</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_add_comm<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_self_UNIV<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">|`</span> <span class="main">(</span>dom <span class="free">m</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict_nonmember_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="free">m'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">m</span> <span class="main">++</span> <span class="free">m'</span><span class="main">)</span> <span class="main">|`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict_nonmember_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> dom <span class="free">m</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">m</span> <span class="main">++</span> <span class="free">m'</span><span class="main">)</span> <span class="main">|`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">m'</span> <span class="main">|`</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆</span> dom <span class="free">m'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">m</span> <span class="main">++</span> <span class="free">m'</span><span class="main">)</span> <span class="main">|`</span> <span class="free">x</span> <span class="main">=</span> <span class="free">m'</span> <span class="main">|`</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">T</span> <span class="main">=</span> dom <span class="free">m</span> <span class="main">;</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">++</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">T</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_dom_subset_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m</span><span class="main">;</span> dom <span class="free">m'</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">m</span> <span class="main">|`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def map_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_dom_restrict_sub_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">(</span>dom <span class="free">m</span> <span class="main">-</span> dom <span class="free">m'</span><span class="main">)</span> <span class="main">++</span> <span class="free">m'</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> None_com map_add_def restrict_map_def map_le_def
           <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits
           <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
     <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Some_com<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subset_map_restrict_sub_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">++</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">T</span> <span class="main">=</span> <span class="free">m</span> <span class="main">|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def map_add_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_sub_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">|`</span> <span class="main">(</span>dom <span class="free">m</span> <span class="main">-</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="main">|`</span> <span class="main">(</span>dom <span class="free">m</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> <span class="main">(</span>dom <span class="free">m</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_restrict_map_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">T</span> <span class="main">=</span> <span class="free">U</span><span class="main">;</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">(</span><span class="free">X</span> <span class="main">×</span> <span class="free">S</span><span class="main">)</span> <span class="main">++</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">(</span><span class="free">X</span> <span class="main">×</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">|`</span> <span class="main">(</span><span class="free">X</span> <span class="main">×</span> <span class="free">U</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Things that should not go into Map.thy (separation logic)›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Map disjuction›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">map_disj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊥</span>"</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">h<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main"><span class="free">⊥</span></span> <span class="free"><span class="bound"><span class="entity">h<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">≡</span> dom <span class="free"><span class="bound"><span class="entity">h<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">∩</span> dom <span class="free"><span class="bound"><span class="entity">h<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> None_not_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"sub_restrict_map"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_sub_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">⊥</span> <span class="free">h</span> <span class="main">`-</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sub_restrict_map_def restrict_map_def map_disj_def
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_sub_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">++</span> <span class="free">h</span> <span class="main">`-</span> <span class="free">S</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sub_restrict_map_def restrict_map_def map_add_def
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_split
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of map disjunction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_empty_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊥</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_empty_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Map.empty <span class="main">⊥</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_com<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disjD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∩</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disjI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∩</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Map associativity-commutativity based on map disjuction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_com<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> map_disjD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_add_comm<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_left_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_com map_disj_com map_add_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_disj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_disj'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="free">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We redefine <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"map_add"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> associativity to bind to the right, which
  seems to be the more common case.
  Note that when a theory includes Map again, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>map_add_assoc›</span></span></span></span> will
  return to the simpset and will cause infinite loops if its symmetric
  counterpart is added (e.g. via <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>map_add_ac›</span></span></span></span>)
›</span></span>

<span class="keyword1"><span class="command">declare</span></span> map_add_assoc <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since the associativity-commutativity of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"map_add"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> relies on
  map disjunction, we include some basic rules into the ac set.
›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> map_add_ac <span class="main">=</span>
  map_add_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> map_add_com map_disj_com
  map_add_left_commute map_add_disj map_add_disj'


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic properties›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_None_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_None_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_None_left'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> None "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_None_right'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span> <span class="main">=</span> None "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_common<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v'</span> <span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_disj_None_left'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_eq_dom_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Map disjunction and addition›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_eval_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> dom <span class="free">h</span> <span class="main">;</span> <span class="free">h</span> <span class="main">⊥</span> <span class="free">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">h</span> <span class="main">++</span> <span class="free">h'</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">h</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_disj_None_right <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_eval_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> dom <span class="free">h'</span> <span class="main">;</span> <span class="free">h</span> <span class="main">⊥</span> <span class="free">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">h</span> <span class="main">++</span> <span class="free">h'</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">h'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_disjD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_comm map_add_eval_left map_disj_com<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_eval_left'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∉</span> dom <span class="free">h'</span> <span class="main">;</span> <span class="free">h</span> <span class="main">⊥</span> <span class="free">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">h</span> <span class="main">++</span> <span class="free">h'</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">h</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_eval_right'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∉</span> dom <span class="free">h</span> <span class="main">;</span> <span class="free">h</span> <span class="main">⊥</span> <span class="free">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">h</span> <span class="main">++</span> <span class="free">h'</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">h'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_left_dom_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> etc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> etc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_ac<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> etc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_add_right_dom_eq <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_left_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊥</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_None_left<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disj eq' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_eval_left'<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_right_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">h</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">h</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h</span><span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊥</span> <span class="free">h</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">h</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> map_add_left_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_add_eq_dom_right_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> merge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ab_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cd_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> merge <span class="keyword1"><span class="command">have</span></span> merge_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> d ab_disj cd_disj <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Some_com<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_add_eq_dom_left_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          dom<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add disj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_ac<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dom disj
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> map_disj_add_eq_dom_right_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_com<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_left_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disj
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_None_right map_add_eval_right'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_lr_disj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub>'</span>  <span class="main">⟧</span> <span class="main">⟹</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def map_add_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fun_cong<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Map disjunction and map updates›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_update_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_update_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_disj_com<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_update_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">p</span> <span class="main">∈</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_disj_None_right<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_update_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">p</span> <span class="main">∈</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_disj_None_left<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add3_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>  <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">;</span> <span class="free">p</span> <span class="main">∈</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_update_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_add_ac<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Map disjunction and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"map_le"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_override <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h</span> <span class="main">⊥</span> <span class="free">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h</span> <span class="main">++</span> <span class="free">h'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_def map_add_def map_disj_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_leI_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_leI_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_map_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def map_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_on_disj_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h</span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">h'</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_le_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_eval_left<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_on_disj_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h</span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">h'</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_on_disj_left map_add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_add_cancel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_def map_add_def map_disj_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_override_bothD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disj'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> map_le_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> sumeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subm <span class="keyword1"><span class="command">unfolding</span></span> map_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disj' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_disj_None_right<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a sumeq disj disj'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_eval_left map_add_eval_left'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">≠</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="bound">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊥</span> <span class="bound">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">≠</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_le_def map_disj_def map_add_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∉</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="keyword1">then</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">x</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_conv2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">++</span> <span class="bound">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊥</span> <span class="bound">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">=</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> map_le_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Map.empty</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Map disjunction and restriction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_comp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|`</span> <span class="main">(</span>UNIV <span class="main">-</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_disj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">⊥</span> <span class="free">h</span> <span class="main">|`</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def restrict_map_def dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_disj_restrict_dom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|`</span> <span class="main">(</span>dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">-</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_disj_dom_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊥</span> <span class="free">h'</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">|`</span> dom <span class="free">h'</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_univ_disj_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊥</span> <span class="free">h'</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">|`</span> <span class="main">(</span>UNIV <span class="main">-</span> dom <span class="free">h'</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_disj_dom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">|`</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h</span> <span class="main">|`</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def restrict_map_def dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict_dom_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊥</span> <span class="free">h'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">h</span> <span class="main">++</span> <span class="free">h'</span><span class="main">)</span> <span class="main">|`</span> dom <span class="free">h</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def map_add_def dom_def map_disj_def
                     <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict_dom_left'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">⊥</span> <span class="free">h'</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">=</span> dom <span class="free">h</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">h</span> <span class="main">++</span> <span class="free">h'</span><span class="main">)</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_map_def map_add_def dom_def map_disj_def
                     <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_disj_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">|`</span> <span class="free">S</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_disj_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> restrict_map_disj_both <span class="main">=</span> restrict_map_disj_right restrict_map_disj_left

<span class="keyword1"><span class="command">lemma</span></span> map_dom_disj_restrict_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span> <span class="main">|`</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">|`</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_restrict restrict_map_empty map_disj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_on_disj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">|`</span> dom <span class="free">h<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_disj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_map_on_disj'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def map_add_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_le_sub_dom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">++</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h</span> <span class="main">;</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h</span> <span class="main">|`</span> <span class="main">(</span>dom <span class="free">h</span> <span class="main">-</span> dom <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_le_override_bothD<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> map_le_dom_restrict_sub_add<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> map_add_le_mapE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_submap_break<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h'</span> <span class="main">=</span> <span class="main">(</span><span class="free">h'</span> <span class="main">|`</span> <span class="main">(</span>UNIV <span class="main">-</span> dom <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">++</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_le_restrict restrict_map_def map_le_def map_add_def
                     dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_disj_restrict_both<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊥</span> <span class="free">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">S'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> <span class="free">T</span> <span class="main">∩</span> <span class="free">T'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span>
   <span class="main">⟹</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">|`</span> <span class="free">S</span><span class="main">)</span> <span class="main">++</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|`</span> <span class="free">T</span><span class="main">)</span> <span class="main">⊥</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">|`</span> <span class="free">S'</span><span class="main">)</span> <span class="main">++</span> <span class="main">(</span><span class="free">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|`</span> <span class="free">T'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_add_ac <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> restrict_map_disj_both restrict_map_disj<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="VM_Example">
<div class="head">
<h1>Theory VM_Example</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Adaptation of example from HOL/Hoare/Separation
   Author: Rafal Kolanski, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Separation Algebra for Virtual Memory"</span></span>

<span class="keyword1"><span class="command">theory</span></span> VM_Example
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Sep_Tactics.html">../Sep_Tactics</a>"</span> <span class="quoted">"<a href="Map_Extra.html">../Map_Extra</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Example instantiation of the abstract separation algebra to the sliced-memory
  model used for building a separation logic in ``Verification of Programs in
  Virtual Memory Using Separation Logic'' (PhD Thesis) by Rafal Kolanski.

  We wrap up the concept of physical and virtual pointers as well as value
  (usually a byte), and the page table root, into a datatype for instantiation.
  This avoids having to produce a hierarchy of type classes.

  The result is more general than the original. It does not mention the types
  of pointers or virtual memory addresses. Instead of supporting only
  singleton page table roots, we now support sets so we can identify a single
  0 for the monoid.
  This models multiple page tables in memory, whereas the original logic was
  only capable of one at a time.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'value</span><span class="main">,</span><span class="tfree">'r</span><span class="main">)</span> vm_sep_state
  <span class="main">=</span> VMSepState <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'p</span> <span class="main">×</span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇀</span> <span class="tfree">'value</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'r</span> set<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> vm_sep_state <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">type</span><span class="main">,</span> <span class="quoted">type</span><span class="main">,</span> <span class="quoted">type</span><span class="main">)</span> <span class="quoted">sep_algebra</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">vm_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> vm_sep_state <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇀</span> <span class="tfree">'c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vm_heap</span> <span class="main">(</span>VMSepState <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">vm_root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> vm_sep_state <span class="main">⇒</span> <span class="tfree">'d</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vm_root</span> <span class="main">(</span>VMSepState <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity"><span class="class_parameter">sep_disj_vm_sep_state</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> vm_sep_state
                            <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> vm_sep_state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_disj_vm_sep_state</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> vm_heap <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊥</span> vm_heap <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity"><span class="class_parameter">zero_vm_sep_state</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> vm_sep_state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zero_vm_sep_state</span> <span class="main">≡</span> VMSepState <span class="main">(</span>Map.empty<span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity"><span class="class_parameter">plus_vm_sep_state</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> vm_sep_state
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> vm_sep_state
                        <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> vm_sep_state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_vm_sep_state</span> <span class="main">(</span>VMSepState <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>VMSepState <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="main">=</span> VMSepState <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_vm_sep_state_def sep_disj_vm_sep_state_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_disj_vm_sep_state_def map_disj_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_vm_sep_state_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_disj_vm_sep_state_def map_add_ac<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_disj_vm_sep_state_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_disj_vm_sep_state_def map_add_disj<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_disj_vm_sep_state_def map_add_disj map_disj_com<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Separation_Algebra_Alt">
<div class="head">
<h1>Theory Separation_Algebra_Alt</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Gerwin Klein, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Abstract Separation Logic, Alternative Definition"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Separation_Algebra_Alt
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory contains an alternative definition of speration algebra,
  following Calcagno et al very closely. While some of the abstract
  development is more algebraic, it is cumbersome to instantiate.
  We only use it to prove equivalence and to give an impression of how
  it would look like.
›</span></span>

<span class="comment1">(* The @{text "++"} notation is a horrible choice, but this theory is 
   only intended to show how the development would look like, not to 
   actually use it. We remove the notation for map-add so it doesn't
   conflict.
*)</span>
<span class="keyword1"><span class="command">no_notation</span></span> map_add <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">++</span>"</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">lift2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'b</span> <span class="main">=&gt;</span> <span class="tfree">'c</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">=&gt;</span> <span class="tfree">'b</span> option <span class="main">=&gt;</span> <span class="tfree">'c</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">,</span> Some <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None"</span></span>


<span class="keyword1"><span class="command">class</span></span> sep_algebra_alt <span class="main">=</span> zero <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">add</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> option"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">⊕</span></span></span>"</span> 65<span class="main">)</span>

  <span class="keyword2"><span class="keyword">assumes</span></span> add_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">⊕</span></span> <span class="main">0</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">⊕</span></span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main"><span class="free">⊕</span></span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"lift2 <span class="free">add</span> <span class="free">a</span> <span class="main">(</span>lift2 <span class="free">add</span> <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> lift2 <span class="free">add</span> <span class="main">(</span>lift2 <span class="free">add</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">c</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">disjoint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">##</span>"</span> 60<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">##</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≠</span> None"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> disj_com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">##</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">##</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_def add_comm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> disj_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">##</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> disj_zero2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">##</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> disj_com<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> add_zero2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">⊕</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> add_comm<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">substate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">≼</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">c</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊕</span> <span class="bound">c</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">**</span>"</span> 61<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">**</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">⊕</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">p</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">q</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">emp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">□</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">□</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⟶<span class="hidden">⇧</span><sup>*</sup></span>"</span> 25<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⟶<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="main">∀</span><span class="bound">h'</span> <span class="bound">h''</span><span class="main">.</span> <span class="bound">h</span> <span class="main">⊕</span> <span class="bound">h'</span> <span class="main">=</span> Some <span class="bound">h''</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">h'</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">h''</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_true</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_false</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> False"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">add2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">=&gt;</span> <span class="tfree">'a</span> option <span class="main">=&gt;</span> <span class="tfree">'a</span> option"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">++</span>"</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add2</span> <span class="main">==</span> lift2 add"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> add2_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">++</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">++</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift2_def add_comm <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add2_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">++</span> None <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> None_add2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"None <span class="main">++</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add2_Some_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Some <span class="free">x</span> <span class="main">++</span> Some <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift2_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add2_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Some <span class="free">x</span> <span class="main">++</span> Some <span class="main">0</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add2_Some_Some<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_add2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Some <span class="main">0</span> <span class="main">++</span> Some <span class="free">x</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add2_Some_Some<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> sep_conjE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">p</span><span class="main">;</span> <span class="free">Q</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">p</span> <span class="main">⊕</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conjI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">p</span><span class="main">;</span> <span class="free">Q</span> <span class="free">q</span><span class="main">;</span> <span class="free">p</span> <span class="main">⊕</span> <span class="free">q</span> <span class="main">=</span> Some <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_comI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_comm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_com<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">**</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">**</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conj_comI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lift_to_add2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">z</span> <span class="main">⊕</span> <span class="free">q</span> <span class="main">=</span> Some <span class="free">s</span><span class="main">;</span> <span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> Some <span class="free">z</span> <span class="main">++</span> Some <span class="free">x</span> <span class="main">++</span> Some <span class="free">y</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add2_Some_Some<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lift_to_add2'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">q</span> <span class="main">⊕</span> <span class="free">z</span> <span class="main">=</span> Some <span class="free">s</span><span class="main">;</span> <span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Some <span class="free">x</span> <span class="main">++</span> Some <span class="free">y</span><span class="main">)</span> <span class="main">++</span> Some <span class="free">z</span> <span class="main">=</span> Some <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add2_Some_Some<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add2_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">++</span> Some <span class="free">y</span> <span class="main">=</span> Some <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">x'</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Some_add2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">x</span> <span class="main">++</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y'</span><span class="main">.</span> <span class="free">y</span> <span class="main">=</span> Some <span class="bound">y'</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">⊕</span> <span class="bound">y'</span> <span class="main">=</span> Some <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">**</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="main">**</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sep_conj_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lift_to_add2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> add_assoc<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add2_Some_Some add2_Some<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lift_to_add2'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> add_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add2_Some_Some Some_add2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> sep_true<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sep_true <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_true_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> sep_false<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sep_false <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_false_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> sep_true<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conjI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_true'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span>sep_true <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conjI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> disjoint_submaps_exist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">h<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊕</span> <span class="bound">h<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_true<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">**</span> sep_true<span class="main">)</span> <span class="main">=</span> sep_true"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sep_conj_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> disjoint_submaps_exist<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_false_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> sep_false<span class="main">)</span> <span class="main">=</span> sep_false"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conjE <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_false_left<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_false <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> sep_false"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sep_conj_com<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> sep_conj_false_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_left_com<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> <span class="var">?y</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_com<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="main">(</span><span class="free">R</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sep_conj_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_com<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sep_conj_ac <span class="main">=</span> sep_conj_com sep_conj_assoc sep_conj_left_com

<span class="keyword1"><span class="command">lemma</span></span> empty_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">□</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">□</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_def emp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> sep_conj_empty'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">□</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sep_conj_com<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sep_conj_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_emptyI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">□</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_true_P<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">**</span> <span class="main">(</span>sep_true <span class="main">**</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sep_true <span class="main">**</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_disj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∨</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span> <span class="main">∨</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> <span class="main">(</span><span class="var">?y</span> <span class="main">∨</span> <span class="var">?z</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_conj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conjI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_exists1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">x</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conjI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_exists2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjI ext <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> sep_conj_exists <span class="main">=</span> sep_conj_exists1 sep_conj_exists2

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_forall<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="free">x</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conjI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_impl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="bound">s</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P'</span> <span class="main">**</span> <span class="free">Q'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> sep_conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_conjI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_impl1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">I</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conj_impl P<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_true_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span>sep_true <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> sep_conj_impl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_true_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> sep_true<span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sep_conj_com<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> sep_conj_sep_true_left<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_globalise<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conj_impl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_implI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h'</span> <span class="bound">h''</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">h</span> <span class="main">⊕</span> <span class="bound">h'</span> <span class="main">=</span> Some <span class="bound">h''</span><span class="main">;</span> <span class="free">P</span> <span class="bound">h'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">h''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">⟶<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">Q</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sep_impl_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_implD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⟶<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">y</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">h'</span> <span class="bound">h''</span><span class="main">.</span> <span class="free">h</span> <span class="main">⊕</span> <span class="bound">h'</span> <span class="main">=</span> Some <span class="bound">h''</span> <span class="main">∧</span> <span class="free">x</span> <span class="bound">h'</span> <span class="main">⟶</span> <span class="free">y</span> <span class="bound">h''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_impl_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_impl_sep_true<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">⟶<span class="hidden">⇧</span><sup>*</sup></span> sep_true<span class="main">)</span> <span class="main">=</span> sep_true"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_implI ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_impl_sep_false<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_false <span class="main">⟶<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> sep_true"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sep_implI ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_impl_sep_true_P<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">⟶<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">P</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sep_implD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_impl_sep_true_false<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_true <span class="main">⟶<span class="hidden">⇧</span><sup>*</sup></span> sep_false<span class="main">)</span> <span class="main">=</span> sep_false"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sep_impl_sep_true_P<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_impl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">s</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⟶<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sep_implI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h'</span> <span class="skolem">h</span> <span class="skolem">h''</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">⊕</span> <span class="skolem">h'</span> <span class="main">=</span> Some <span class="skolem">h''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">h'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">h''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sep_conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">h''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_impl2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⟶<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">R</span><span class="main">)</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sep_implD <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sep_conjE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_sep_impl_sep_conj2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">**</span> <span class="main">(</span><span class="free">Q</span> <span class="main">⟶<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sep_conj_impl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sep_conj_sep_impl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_conj_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_conj_triv_strip2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">=</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Q</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">**</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sep_Eq">
<div class="head">
<h1>Theory Sep_Eq</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Gerwin Klein, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Equivalence between Separation Algebra Formulations"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sep_Eq
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Separation_Algebra.html">Separation_Algebra</a> <a href="Separation_Algebra_Alt.html">Separation_Algebra_Alt</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this theory we show that our total formulation of separation algebra is
  equivalent in strength to Calcagno et al's original partial one.

  This theory is not intended to be included in own developments.
›</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> map_add <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">++</span>"</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Total implies Partial"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>sep_algebra <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add2_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"add2 <span class="free">x</span> <span class="main">0</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add2_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add2_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"add2 <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> add2 <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add2_def sep_add_commute sep_disj_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add2_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lift2 add2 <span class="free">a</span> <span class="main">(</span>lift2 add2 <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> lift2 add2 <span class="main">(</span>lift2 add2 <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add2_def lift2_def sep_add_assoc
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sep_disj_addD sep_disj_addI3
                    sep_add_disjD sep_disj_addI2 sep_disj_commuteI
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> total_partial<span class="main">:</span> sep_algebra_alt <span class="quoted"><span class="main">0</span></span> <span class="quoted">add2</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add2_zero add2_comm add2_assoc<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Partial implies Total"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_add'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> sep_algebra_alt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_add'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> disjoint <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> the <span class="main">(</span>add <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_zero'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"disjoint <span class="free">x</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_commuteI'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"disjoint <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> disjoint <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_def add_comm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_add_zero'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sep_add' <span class="free">x</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_add'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_add_commute'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"disjoint <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> sep_add' <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> sep_add' <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_add'_def disjoint_def add_comm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_add_assoc'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> disjoint <span class="free">x</span> <span class="free">y</span><span class="main">;</span> disjoint <span class="free">y</span> <span class="free">z</span><span class="main">;</span> disjoint <span class="free">x</span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span>
  sep_add' <span class="main">(</span>sep_add' <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> sep_add' <span class="free">x</span> <span class="main">(</span>sep_add' <span class="free">y</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_assoc <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Some <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">z</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_def sep_add'_def lift2_def
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_addD1'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"disjoint <span class="free">x</span> <span class="main">(</span>sep_add' <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">⟹</span> disjoint <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> disjoint <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_def sep_add'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊕</span> <span class="free">z</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊕</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">x</span> <span class="main">++</span> <span class="main">(</span>Some <span class="free">y</span> <span class="main">++</span> Some <span class="free">z</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">x</span> <span class="main">++</span> Some <span class="free">y</span><span class="main">)</span> <span class="main">++</span> Some <span class="free">z</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">=</span> Some <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lift2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_disj_addI1'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"disjoint <span class="free">x</span> <span class="main">(</span>sep_add' <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">⟹</span> disjoint <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> disjoint <span class="main">(</span>sep_add' <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_def sep_add'_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> lift_to_add2<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift2_def add_comm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> lift_to_add2<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift2_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">interpretation</span></span> partial_total<span class="main">:</span> sep_algebra <span class="quoted">sep_add'</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted">disjoint</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sep_disj_zero'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sep_disj_commuteI'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sep_add_zero'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sep_add_commute'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sep_add_assoc'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sep_disj_addD1'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sep_disj_addI1'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Types_D">
<div class="head">
<h1>Theory Types_D</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Andrew Boyton, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"A simplified version of the actual capDL specification."</span></span>

<span class="keyword1"><span class="command">theory</span></span> Types_D
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Word.html">HOL-Library.Word</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*
 * Objects are named by 32 bit words. 
 * This name may correspond to the memory address of the object.
 *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> cdl_object_id <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">32</span> word"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> cdl_object_set <span class="main">=</span> <span class="quoted"><span class="quoted">"cdl_object_id set"</span></span>

<span class="comment1">(* The type we use to represent object sizes. *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> cdl_size_bits <span class="main">=</span> <span class="quoted">nat</span>

<span class="comment1">(* An index into a CNode, TCB, or other kernel object that contains caps. *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> cdl_cnode_index <span class="main">=</span> <span class="quoted">nat</span>

<span class="comment1">(* A reference to a capability slot. *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> cdl_cap_ref <span class="main">=</span> <span class="quoted"><span class="quoted">"cdl_object_id <span class="main">×</span> cdl_cnode_index"</span></span>

<span class="comment1">(* The possible access-control rights that exist in the system. *)</span>
<span class="keyword1"><span class="command">datatype</span></span> cdl_right <span class="main">=</span> AllowRead <span class="main">|</span> AllowWrite <span class="main">|</span> AllowGrant


<span class="comment1">(*
 * Kernel capabilities.
 *
 * Such capabilities (or "caps") give the holder particular rights to
 * a kernel object or system hardware.
 *
 * Caps have attributes such as the object they point to, the rights
 * they give the holder, or how the holder is allowed to interact with
 * the target object.
 *
 * This is a simplified, cut-down version of this datatype for 
 * demonstration purposes.
 *)</span>
<span class="keyword1"><span class="command">datatype</span></span> cdl_cap <span class="main">=</span>
    NullCap
  <span class="main">|</span> EndpointCap <span class="quoted">cdl_object_id</span> <span class="quoted"><span class="quoted">"cdl_right set"</span></span>
  <span class="main">|</span> CNodeCap <span class="quoted">cdl_object_id</span>
  <span class="main">|</span> TcbCap <span class="quoted">cdl_object_id</span>

<span class="comment1">(* A mapping from capability identifiers to capabilities. *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> cdl_cap_map <span class="main">=</span> <span class="quoted"><span class="quoted">"cdl_cnode_index <span class="main">⇒</span> cdl_cap option"</span></span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"cdl_cap_map"</span> <span class="main">&lt;=</span> <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"nat <span class="main">⇒</span> cdl_cap option"</span>
  <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"cdl_cap_ref"</span> <span class="main">&lt;=</span> <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"cdl_object_id <span class="main">×</span> nat"</span>

<span class="comment1">(* A user cap pointer. *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> cdl_cptr <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">32</span> word"</span></span>

<span class="comment1">(* Kernel objects *)</span>
<span class="keyword1"><span class="command">record</span></span> cdl_tcb <span class="main">=</span>
  cdl_tcb_caps <span class="main">::</span> <span class="quoted">cdl_cap_map</span>
  cdl_tcb_fault_endpoint <span class="main">::</span> <span class="quoted">cdl_cptr</span>

<span class="keyword1"><span class="command">record</span></span> cdl_cnode <span class="main">=</span>
  cdl_cnode_caps <span class="main">::</span> <span class="quoted">cdl_cap_map</span>
  cdl_cnode_size_bits <span class="main">::</span> <span class="quoted">cdl_size_bits</span>

<span class="comment1">(*
 * Kernel objects.
 *
 * These are in-memory objects that may, over the course of the system
 * execution, be created or deleted by users.
 *
 * Again, a simplified version of the real datatype.
 *)</span>
<span class="keyword1"><span class="command">datatype</span></span> cdl_object <span class="main">=</span>
    Endpoint
  <span class="main">|</span> Tcb <span class="quoted">cdl_tcb</span>
  <span class="main">|</span> CNode <span class="quoted">cdl_cnode</span>

<span class="comment1">(*
 * The current state of the system.
 *
 * The state record contains the following primary pieces of information:
 *
 * objects:
 *   The objects that currently exist in the system.
 *
 * current_thread:
 *   The currently running thread. Operations will always be performed
 *   on behalf of this thread.
 *
 * ghost_state: (Used for separation logic)
 *   Which fields are owned by an object.
 *   In capDL this is all of the fields (or none of them).
 *   In any concrete state, this will be all of the fields.
 *)</span>


<span class="comment1">(* The ghost state tracks which components (fields and slots) are owned by an object.
 * Fields + slots are encoded as None + Some nat.
 *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> cdl_heap <span class="main">=</span> <span class="quoted"><span class="quoted">"cdl_object_id <span class="main">⇒</span> cdl_object option"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> cdl_component  <span class="main">=</span> <span class="quoted"><span class="quoted">"nat option"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> cdl_components <span class="main">=</span> <span class="quoted"><span class="quoted">"cdl_component set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> cdl_ghost_state <span class="main">=</span> <span class="quoted"><span class="quoted">"cdl_object_id <span class="main">⇒</span> cdl_components"</span></span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"cdl_heap"</span> <span class="main">&lt;=</span> <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"cdl_object_id <span class="main">⇒</span> cdl_object option"</span>
  <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"cdl_ghost_state"</span> <span class="main">&lt;=</span> <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"cdl_object_id <span class="main">⇒</span> nat option set"</span>

<span class="keyword1"><span class="command">record</span></span> cdl_state <span class="main">=</span>
  cdl_objects <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_heap"</span></span>
  cdl_current_thread <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object_id option"</span></span>
  cdl_ghost_state <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_ghost_state"</span></span>


<span class="comment1">(* Kernel objects types. *)</span>
<span class="keyword1"><span class="command">datatype</span></span> cdl_object_type <span class="main">=</span>
    EndpointType
  <span class="main">|</span> TcbType
  <span class="main">|</span> CNodeType

<span class="comment1">(* Return the type of an object. *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">object_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object <span class="main">⇒</span> cdl_object_type"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">object_type</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
        Endpoint <span class="main">⇒</span> EndpointType
      <span class="main">|</span> Tcb <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> TcbType
      <span class="main">|</span> CNode <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> CNodeType"</span></span>

<span class="comment1">(*
 * Getters and setters for various data types.
 *)</span>

<span class="comment1">(* Capability getters / setters *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cap_objects</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_cap <span class="main">⇒</span> cdl_object_id set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cap_objects</span> <span class="free"><span class="bound"><span class="entity">cap</span></span></span> <span class="main">≡</span> 
       <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cap</span></span></span> <span class="keyword1">of</span>
           TcbCap <span class="bound">x</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span>
         <span class="main">|</span> CNodeCap <span class="bound">x</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span>
         <span class="main">|</span> EndpointCap <span class="bound">x</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cap_has_object</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_cap <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cap_has_object</span> <span class="free"><span class="bound"><span class="entity">cap</span></span></span> <span class="main">≡</span> 
       <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cap</span></span></span> <span class="keyword1">of</span>
           NullCap          <span class="main">⇒</span> False
         <span class="main">|</span> <span class="main"><span class="bound">_</span></span>                <span class="main">⇒</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cap_object</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_cap <span class="main">⇒</span> cdl_object_id"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cap_object</span> <span class="free"><span class="bound"><span class="entity">cap</span></span></span> <span class="main">≡</span> 
       <span class="keyword1">if</span> cap_has_object <span class="free"><span class="bound"><span class="entity">cap</span></span></span> 
         <span class="keyword1">then</span> <span class="keyword1">THE</span> <span class="bound">obj_id</span><span class="main">.</span> cap_objects <span class="free"><span class="bound"><span class="entity">cap</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">obj_id</span><span class="main">}</span>
         <span class="keyword1">else</span> undefined "</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cap_object_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cap_object <span class="main">(</span>TcbCap <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"cap_object <span class="main">(</span>CNodeCap <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"cap_object <span class="main">(</span>EndpointCap <span class="free">x</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cap_object_def cap_objects_def cap_has_object_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">cap_rights</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_cap <span class="main">⇒</span> cdl_right set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cap_rights</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">of</span>
      EndpointCap <span class="main"><span class="bound">_</span></span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> UNIV"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">update_cap_rights</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_right set <span class="main">⇒</span> cdl_cap <span class="main">⇒</span> cdl_cap"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_cap_rights</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">of</span>
      EndpointCap <span class="bound">f1</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> EndpointCap <span class="bound">f1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="comment1">(* Kernel object getters / setters *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">object_slots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object <span class="main">⇒</span> cdl_cap_map"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">object_slots</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="keyword1">of</span>
    CNode <span class="bound">x</span> <span class="main">⇒</span> cdl_cnode_caps <span class="bound">x</span>
  <span class="main">|</span> Tcb <span class="bound">x</span> <span class="main">⇒</span> cdl_tcb_caps <span class="bound">x</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Map.empty"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">update_slots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_cap_map <span class="main">⇒</span> cdl_object <span class="main">⇒</span> cdl_object"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_slots</span> <span class="free"><span class="bound"><span class="entity">new_val</span></span></span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="keyword1">of</span>
    CNode <span class="bound">x</span> <span class="main">⇒</span> CNode <span class="main">(</span><span class="bound">x</span><span class="main">⦇</span>cdl_cnode_caps <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">new_val</span></span></span><span class="main">⦈</span><span class="main">)</span>
  <span class="main">|</span> Tcb <span class="bound">x</span> <span class="main">⇒</span> Tcb <span class="main">(</span><span class="bound">x</span><span class="main">⦇</span>cdl_tcb_caps <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">new_val</span></span></span><span class="main">⦈</span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span>"</span></span>

<span class="comment1">(* Adds new caps to an object. It won't overwrite on a collision. *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">add_to_slots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_cap_map <span class="main">⇒</span> cdl_object <span class="main">⇒</span> cdl_object"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_to_slots</span> <span class="free"><span class="bound"><span class="entity">new_val</span></span></span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="main">≡</span> update_slots <span class="main">(</span><span class="free"><span class="bound"><span class="entity">new_val</span></span></span> <span class="main">++</span> <span class="main">(</span>object_slots <span class="free"><span class="bound"><span class="entity">obj</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">slots_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_heap <span class="main">⇒</span> cdl_object_id <span class="main">⇒</span> cdl_cap_map"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">slots_of</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">obj_id</span><span class="main">.</span> 
  <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">obj_id</span> <span class="keyword1">of</span> 
    None <span class="main">⇒</span> Map.empty 
  <span class="main">|</span> Some <span class="bound">obj</span> <span class="main">⇒</span> object_slots <span class="bound">obj</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">has_slots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_slots</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="keyword1">of</span>
    CNode <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True
  <span class="main">|</span> Tcb <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">object_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cdl_object <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> cdl_object_id <span class="main">⇒</span> cdl_heap <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">object_at</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">object</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Some <span class="bound">object</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">object</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ko_at</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> object_at <span class="main">(</span><span class="main">(=)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abstract_Separation_D">
<div class="head">
<h1>Theory Abstract_Separation_D</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Andrew Boyton, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Instantiating capDL as a separation algebra."</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abstract_Separation_D
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Sep_Tactics.html">../../Sep_Tactics</a>"</span> <a href="Types_D.html">Types_D</a> <span class="quoted">"<a href="Map_Extra.html">../../Map_Extra</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(**************************************
 * Start of lemmas to move elsewhere. *
 **************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> inter_empty_not_both<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> union_intersection<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> union_intersection1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inf_sup_absorb<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> union_intersection2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(* This lemma is strictly weaker than restrict_map_disj. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> restrict_map_disj'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">⊥</span> <span class="free">h'</span> <span class="main">|`</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_disj_def restrict_map_def dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_restrict_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">|`</span> <span class="free">S</span> <span class="main">++</span> <span class="free">h'</span> <span class="main">|`</span> <span class="free">T</span> <span class="main">=</span> <span class="free">h'</span> <span class="main">|`</span> <span class="free">T</span> <span class="main">++</span> <span class="free">h</span> <span class="main">|`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> restrict_map_disj'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> map_add_com<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(************************************
 * End of lemmas to move elsewhere. *
 ************************************)</span>



<span class="comment1">(* The state for separation logic has:
   * The memory heap.
   * A function for which objects own which fields.
     In capDL, we say that an object either owns all of its fields, or none of them.
   These are both taken from the cdl_state.
 *)</span>

<span class="keyword1"><span class="command">datatype</span></span> sep_state <span class="main">=</span> SepState <span class="quoted">cdl_heap</span> <span class="quoted">cdl_ghost_state</span>

<span class="comment1">(* Functions to get the heap and the ghost_state from the sep_state. *)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sep_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sep_state <span class="main">⇒</span> cdl_heap"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">sep_heap</span> <span class="main">(</span>SepState <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sep_ghost_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sep_state <span class="main">⇒</span> cdl_ghost_state"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">sep_ghost_state</span> <span class="main">(</span>SepState <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">the_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">the_set</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> Some <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> the_set_union <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"the_set <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> the_set <span class="free">A</span> <span class="main">∪</span> the_set <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> the_set_inter <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"the_set <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> the_set <span class="free">A</span> <span class="main">∩</span> the_set <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> the_set_inter_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> the_set <span class="free">A</span> <span class="main">∩</span> the_set <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_set_def<span class="main">)</span>


<span class="comment1">(* As the capDL operations mostly take the state (rather than the heap)
 * we need to redefine some of them again to take just the heap.
 *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">slots_of_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_heap <span class="main">⇒</span> cdl_object_id <span class="main">⇒</span> cdl_cap_map"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">slots_of_heap</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">obj_id</span><span class="main">.</span> 
  <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">obj_id</span> <span class="keyword1">of</span> 
    None <span class="main">⇒</span> Map.empty 
  <span class="main">|</span> Some <span class="bound">obj</span> <span class="main">⇒</span> object_slots <span class="bound">obj</span>"</span></span>

<span class="comment1">(* Adds new caps to an object. It won't overwrite on a collision. *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">add_to_slots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_cap_map <span class="main">⇒</span> cdl_object <span class="main">⇒</span> cdl_object"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_to_slots</span> <span class="free"><span class="bound"><span class="entity">new_val</span></span></span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="main">≡</span> update_slots <span class="main">(</span><span class="free"><span class="bound"><span class="entity">new_val</span></span></span> <span class="main">++</span> <span class="main">(</span>object_slots <span class="free"><span class="bound"><span class="entity">obj</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_to_slots_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"add_to_slots <span class="free">x</span> <span class="main">(</span>add_to_slots <span class="main">(</span><span class="free">y</span> <span class="main">++</span> <span class="free">z</span><span class="main">)</span> <span class="free">obj</span><span class="main">)</span> <span class="main">=</span> 
   add_to_slots <span class="main">(</span><span class="free">x</span> <span class="main">++</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>add_to_slots <span class="free">z</span> <span class="free">obj</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_slots_def update_slots_def object_slots_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_tcb.splits cdl_cnode.splits
                 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* Lemmas about add_to_slots, update_slots and object_slots. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> add_to_slots_twice <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"add_to_slots <span class="free">x</span> <span class="main">(</span>add_to_slots <span class="free">y</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> add_to_slots <span class="main">(</span><span class="free">x</span> <span class="main">++</span> <span class="free">y</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_slots_def update_slots_def object_slots_def
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> slots_of_heap_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"slots_of_heap Map.empty <span class="free">object_id</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slots_of_heap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> slots_of_heap_empty2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">obj_id</span> <span class="main">=</span> None <span class="main">⟹</span> slots_of_heap <span class="free">h</span> <span class="free">obj_id</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slots_of_heap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_slots_add_to_slots_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"update_slots Map.empty <span class="main">(</span>add_to_slots <span class="free">new</span> <span class="free">obj</span><span class="main">)</span> <span class="main">=</span> update_slots Map.empty <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_slots_def add_to_slots_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_object_slots_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"update_slots <span class="main">(</span>object_slots <span class="free">a</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_slots_def object_slots_def
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_slots_of_heap_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">obj_id</span> <span class="main">=</span> Some <span class="free">obj</span> <span class="main">⟹</span> update_slots <span class="main">(</span>slots_of_heap <span class="free">h</span> <span class="free">obj_id</span><span class="main">)</span> <span class="free">obj</span> <span class="main">=</span> <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_slots_def slots_of_heap_def object_slots_def
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_to_slots_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"add_to_slots Map.empty <span class="free">h</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_to_slots_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_slots_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"update_slots <span class="free">a</span> <span class="free">o1</span> <span class="main">=</span> update_slots <span class="free">a</span> <span class="free">o2</span> <span class="main">⟹</span> update_slots <span class="free">b</span> <span class="free">o1</span> <span class="main">=</span> update_slots <span class="free">b</span> <span class="free">o2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_slots_def cdl_tcb.splits cdl_cnode.splits
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>



<span class="comment1">(* If there are not two conflicting objects at a position in two states.
 * Objects conflict if their types are different or their ghost_states collide.
 *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">not_conflicting_objects</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sep_state <span class="main">⇒</span> sep_state <span class="main">⇒</span> cdl_object_id <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">not_conflicting_objects</span> <span class="free"><span class="bound"><span class="entity">state_a</span></span></span> <span class="free"><span class="bound"><span class="entity">state_b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">obj_id</span><span class="main">.</span>
 <span class="keyword1">let</span> <span class="bound">heap_a</span> <span class="main">=</span> sep_heap <span class="free"><span class="bound"><span class="entity">state_a</span></span></span><span class="main">;</span>
     <span class="bound">heap_b</span> <span class="main">=</span> sep_heap <span class="free"><span class="bound"><span class="entity">state_b</span></span></span><span class="main">;</span>
     <span class="bound">gs_a</span> <span class="main">=</span> sep_ghost_state <span class="free"><span class="bound"><span class="entity">state_a</span></span></span><span class="main">;</span>
     <span class="bound">gs_b</span> <span class="main">=</span> sep_ghost_state <span class="free"><span class="bound"><span class="entity">state_b</span></span></span>
 <span class="keyword1">in</span> <span class="keyword1">case</span> <span class="main">(</span><span class="bound">heap_a</span> <span class="bound">obj_id</span><span class="main">,</span> <span class="bound">heap_b</span> <span class="bound">obj_id</span><span class="main">)</span> <span class="keyword1">of</span> 
    <span class="main">(</span>Some <span class="bound">o1</span><span class="main">,</span> Some <span class="bound">o2</span><span class="main">)</span> <span class="main">⇒</span> object_type <span class="bound">o1</span> <span class="main">=</span> object_type <span class="bound">o2</span> <span class="main">∧</span> <span class="bound">gs_a</span> <span class="bound">obj_id</span> <span class="main">∩</span> <span class="bound">gs_b</span> <span class="bound">obj_id</span> <span class="main">=</span> <span class="main">{}</span>
   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>


<span class="comment1">(* "Cleans" slots to conform with the compontents. *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">clean_slots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_cap_map <span class="main">⇒</span> cdl_components <span class="main">⇒</span> cdl_cap_map"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clean_slots</span> <span class="free"><span class="bound"><span class="entity">slots</span></span></span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">slots</span></span></span> <span class="main">|`</span> the_set <span class="free"><span class="bound"><span class="entity">cmp</span></span></span>"</span></span>

<span class="comment1">(* Sets the fields of an object to a "clean" state.
   Because a frame's size is part of it's type, we don't reset it. *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">object_clean_fields</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object <span class="main">⇒</span> cdl_components <span class="main">⇒</span> cdl_object"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">object_clean_fields</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> None <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="keyword1">of</span>
    Tcb <span class="bound">x</span> <span class="main">⇒</span> Tcb <span class="main">(</span><span class="bound">x</span><span class="main">⦇</span>cdl_tcb_fault_endpoint <span class="main">:=</span> undefined<span class="main">⦈</span><span class="main">)</span>
  <span class="main">|</span> CNode <span class="bound">x</span> <span class="main">⇒</span> CNode <span class="main">(</span><span class="bound">x</span><span class="main">⦇</span>cdl_cnode_size_bits <span class="main">:=</span> undefined <span class="main">⦈</span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span>"</span></span>

<span class="comment1">(* Sets the slots of an object to a "clean" state. *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">object_clean_slots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object <span class="main">⇒</span> cdl_components <span class="main">⇒</span> cdl_object"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">object_clean_slots</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span> <span class="main">≡</span> update_slots <span class="main">(</span>clean_slots <span class="main">(</span>object_slots <span class="free"><span class="bound"><span class="entity">obj</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cmp</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span>"</span></span>

<span class="comment1">(* Sets an object to a "clean" state. *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">object_clean</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object <span class="main">⇒</span> cdl_components <span class="main">⇒</span> cdl_object"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">object_clean</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="main">≡</span> object_clean_slots <span class="main">(</span>object_clean_fields <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span>"</span></span>

<span class="comment1">(* Overrides the left object with the attributes of the right, as specified by the ghost state.
   If the components for an object are empty, then this object is treated as empty, and thus ignored.
 *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">object_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object <span class="main">⇒</span> cdl_object <span class="main">⇒</span> cdl_components <span class="main">⇒</span> cdl_components <span class="main">⇒</span> cdl_object"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">object_add</span> <span class="free"><span class="bound"><span class="entity">obj_a</span></span></span> <span class="free"><span class="bound"><span class="entity">obj_b</span></span></span> <span class="free"><span class="bound"><span class="entity">cmps_a</span></span></span> <span class="free"><span class="bound"><span class="entity">cmps_b</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">clean_obj_a</span> <span class="main">=</span> object_clean <span class="free"><span class="bound"><span class="entity">obj_a</span></span></span> <span class="free"><span class="bound"><span class="entity">cmps_a</span></span></span><span class="main">;</span>
      <span class="bound">clean_obj_b</span> <span class="main">=</span> object_clean <span class="free"><span class="bound"><span class="entity">obj_b</span></span></span> <span class="free"><span class="bound"><span class="entity">cmps_b</span></span></span>
  <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cmps_a</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
     <span class="keyword1">then</span> <span class="bound">clean_obj_b</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cmps_b</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
     <span class="keyword1">then</span> <span class="bound">clean_obj_a</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span>None <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">cmps_b</span></span></span><span class="main">)</span>
     <span class="keyword1">then</span> <span class="main">(</span>update_slots <span class="main">(</span>object_slots <span class="bound">clean_obj_a</span> <span class="main">++</span> object_slots <span class="bound">clean_obj_b</span><span class="main">)</span> <span class="bound">clean_obj_b</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="main">(</span>update_slots <span class="main">(</span>object_slots <span class="bound">clean_obj_a</span> <span class="main">++</span> object_slots <span class="bound">clean_obj_b</span><span class="main">)</span> <span class="bound">clean_obj_a</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Heaps are added by adding their repsective objects.
 * The ghost state tells us which object's fields should be taken.
 * Adding objects of the same type adds their caps
 *   (overwrites the left with the right).
 *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">cdl_heap_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sep_state <span class="main">⇒</span> sep_state <span class="main">⇒</span> cdl_heap"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cdl_heap_add</span> <span class="free"><span class="bound"><span class="entity">state_a</span></span></span> <span class="free"><span class="bound"><span class="entity">state_b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">obj_id</span><span class="main">.</span>
 <span class="keyword1">let</span> <span class="bound">heap_a</span> <span class="main">=</span> sep_heap <span class="free"><span class="bound"><span class="entity">state_a</span></span></span><span class="main">;</span>
     <span class="bound">heap_b</span> <span class="main">=</span> sep_heap <span class="free"><span class="bound"><span class="entity">state_b</span></span></span><span class="main">;</span>
     <span class="bound">gs_a</span> <span class="main">=</span> sep_ghost_state <span class="free"><span class="bound"><span class="entity">state_a</span></span></span><span class="main">;</span>
     <span class="bound">gs_b</span> <span class="main">=</span> sep_ghost_state <span class="free"><span class="bound"><span class="entity">state_b</span></span></span>
 <span class="keyword1">in</span> <span class="keyword1">case</span> <span class="bound">heap_b</span> <span class="bound">obj_id</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="bound">heap_a</span> <span class="bound">obj_id</span>
    <span class="main">|</span> Some <span class="bound">obj_b</span> <span class="main">⇒</span> <span class="keyword1">case</span> <span class="bound">heap_a</span> <span class="bound">obj_id</span> <span class="keyword1">of</span>
                     None <span class="main">⇒</span> <span class="bound">heap_b</span> <span class="bound">obj_id</span>
                   <span class="main">|</span> Some <span class="bound">obj_a</span> <span class="main">⇒</span> Some <span class="main">(</span>object_add <span class="bound">obj_a</span> <span class="bound">obj_b</span> <span class="main">(</span><span class="bound">gs_a</span> <span class="bound">obj_id</span><span class="main">)</span> <span class="main">(</span><span class="bound">gs_b</span> <span class="bound">obj_id</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Heaps are added by adding their repsective objects.
 * The ghost state tells us which object's fields should be taken.
 * Adding objects of the same type adds their caps
 *   (overwrites the left with the right).
 *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">cdl_ghost_state_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sep_state <span class="main">⇒</span> sep_state <span class="main">⇒</span> cdl_ghost_state"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cdl_ghost_state_add</span> <span class="free"><span class="bound"><span class="entity">state_a</span></span></span> <span class="free"><span class="bound"><span class="entity">state_b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">obj_id</span><span class="main">.</span>
 <span class="keyword1">let</span> <span class="bound">heap_a</span> <span class="main">=</span> sep_heap <span class="free"><span class="bound"><span class="entity">state_a</span></span></span><span class="main">;</span>
     <span class="bound">heap_b</span> <span class="main">=</span> sep_heap <span class="free"><span class="bound"><span class="entity">state_b</span></span></span><span class="main">;</span>
     <span class="bound">gs_a</span> <span class="main">=</span> sep_ghost_state <span class="free"><span class="bound"><span class="entity">state_a</span></span></span><span class="main">;</span>
     <span class="bound">gs_b</span> <span class="main">=</span> sep_ghost_state <span class="free"><span class="bound"><span class="entity">state_b</span></span></span>
 <span class="keyword1">in</span>      <span class="keyword1">if</span> <span class="bound">heap_a</span> <span class="bound">obj_id</span> <span class="main">=</span> None <span class="main">∧</span> <span class="bound">heap_b</span> <span class="bound">obj_id</span> <span class="main">≠</span> None <span class="keyword1">then</span> <span class="bound">gs_b</span> <span class="bound">obj_id</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">heap_b</span> <span class="bound">obj_id</span> <span class="main">=</span> None <span class="main">∧</span> <span class="bound">heap_a</span> <span class="bound">obj_id</span> <span class="main">≠</span> None <span class="keyword1">then</span> <span class="bound">gs_a</span> <span class="bound">obj_id</span>
    <span class="keyword1">else</span> <span class="bound">gs_a</span> <span class="bound">obj_id</span> <span class="main">∪</span> <span class="bound">gs_b</span> <span class="bound">obj_id</span>"</span></span>


<span class="comment1">(* Adding states adds their heaps,
 *  and each objects owns whichever fields it owned in either heap.
 *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_state_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sep_state <span class="main">⇒</span> sep_state <span class="main">⇒</span> sep_state"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_state_add</span> <span class="free"><span class="bound"><span class="entity">state_a</span></span></span> <span class="free"><span class="bound"><span class="entity">state_b</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span>
    <span class="bound">heap_a</span> <span class="main">=</span> sep_heap <span class="free"><span class="bound"><span class="entity">state_a</span></span></span><span class="main">;</span>
    <span class="bound">heap_b</span> <span class="main">=</span> sep_heap <span class="free"><span class="bound"><span class="entity">state_b</span></span></span><span class="main">;</span>
    <span class="bound">gs_a</span> <span class="main">=</span> sep_ghost_state <span class="free"><span class="bound"><span class="entity">state_a</span></span></span><span class="main">;</span>
    <span class="bound">gs_b</span> <span class="main">=</span> sep_ghost_state <span class="free"><span class="bound"><span class="entity">state_b</span></span></span>
  <span class="keyword1">in</span>
    SepState <span class="main">(</span>cdl_heap_add <span class="free"><span class="bound"><span class="entity">state_a</span></span></span> <span class="free"><span class="bound"><span class="entity">state_b</span></span></span><span class="main">)</span> <span class="main">(</span>cdl_ghost_state_add <span class="free"><span class="bound"><span class="entity">state_a</span></span></span> <span class="free"><span class="bound"><span class="entity">state_b</span></span></span><span class="main">)</span>"</span></span>


<span class="comment1">(* Heaps are disjoint if for all of their objects:
   * the caps of their respective objects are disjoint,
   * their respective objects don't conflict,
   * they don't both own any of the same fields.
*)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_state_disj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sep_state <span class="main">⇒</span> sep_state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_state_disj</span> <span class="free"><span class="bound"><span class="entity">state_a</span></span></span> <span class="free"><span class="bound"><span class="entity">state_b</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span>
    <span class="bound">heap_a</span> <span class="main">=</span> sep_heap <span class="free"><span class="bound"><span class="entity">state_a</span></span></span><span class="main">;</span>
    <span class="bound">heap_b</span> <span class="main">=</span> sep_heap <span class="free"><span class="bound"><span class="entity">state_b</span></span></span><span class="main">;</span>
    <span class="bound">gs_a</span> <span class="main">=</span> sep_ghost_state <span class="free"><span class="bound"><span class="entity">state_a</span></span></span><span class="main">;</span>
    <span class="bound">gs_b</span> <span class="main">=</span> sep_ghost_state <span class="free"><span class="bound"><span class="entity">state_b</span></span></span>
  <span class="keyword1">in</span>
    <span class="main">∀</span><span class="bound">obj_id</span><span class="main">.</span> not_conflicting_objects <span class="free"><span class="bound"><span class="entity">state_a</span></span></span> <span class="free"><span class="bound"><span class="entity">state_b</span></span></span> <span class="bound">obj_id</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_conflicting_objects_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"not_conflicting_objects <span class="free">h1</span> <span class="free">h2</span> <span class="free">obj</span> <span class="main">=</span> not_conflicting_objects <span class="free">h2</span> <span class="free">h1</span> <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_slots_def cdl_tcb.splits cdl_cnode.splits
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> object_clean_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>object_type <span class="free">obj_a</span> <span class="main">=</span> object_type <span class="free">obj_b</span><span class="main">;</span>
    object_slots <span class="free">obj_a</span> <span class="main">++</span> object_slots <span class="free">obj_b</span> <span class="main">=</span> object_slots <span class="free">obj_b</span> <span class="main">++</span> object_slots <span class="free">obj_a</span><span class="main">;</span> None <span class="main">∉</span> <span class="free">cmp</span><span class="main">⟧</span>
  <span class="main">⟹</span> object_clean <span class="main">(</span>add_to_slots <span class="main">(</span>object_slots <span class="free">obj_a</span><span class="main">)</span> <span class="free">obj_b</span><span class="main">)</span> <span class="free">cmp</span> <span class="main">=</span>
      object_clean <span class="main">(</span>add_to_slots <span class="main">(</span>object_slots <span class="free">obj_b</span><span class="main">)</span> <span class="free">obj_a</span><span class="main">)</span> <span class="free">cmp</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_type_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_def object_clean_slots_def object_clean_fields_def
                        add_to_slots_def object_slots_def update_slots_def
                        cdl_tcb.splits cdl_cnode.splits
                 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_to_slots_object_slots<span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_type <span class="free">y</span> <span class="main">=</span> object_type <span class="free">z</span>
 <span class="main">⟹</span> add_to_slots <span class="main">(</span>object_slots <span class="main">(</span>add_to_slots <span class="main">(</span><span class="free">x</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span>
     add_to_slots <span class="main">(</span><span class="free">x</span> <span class="main">++</span> object_slots <span class="free">y</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_slots_def update_slots_def object_slots_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_type_def cdl_tcb.splits cdl_cnode.splits
                 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_conflicting_objects_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"not_conflicting_objects <span class="free">s</span> <span class="main">(</span>SepState Map.empty <span class="main">(</span><span class="main">λ</span><span class="bound">obj_id</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> <span class="free">obj_id</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_not_conflicting_objects <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"not_conflicting_objects <span class="main">(</span>SepState Map.empty <span class="main">(</span><span class="main">λ</span><span class="bound">obj_id</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="free">obj_id</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_conflicting_objects_empty_object <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_heap <span class="free">x</span><span class="main">)</span> <span class="free">obj_id</span> <span class="main">=</span> None <span class="main">⟹</span> not_conflicting_objects <span class="free">x</span> <span class="free">y</span> <span class="free">obj_id</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_object_not_conflicting_objects <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_heap <span class="free">y</span><span class="main">)</span> <span class="free">obj_id</span> <span class="main">=</span> None <span class="main">⟹</span> not_conflicting_objects <span class="free">x</span> <span class="free">y</span> <span class="free">obj_id</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> not_conflicting_objects_empty_object <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_comm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cdl_heap_add_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"cdl_heap_add <span class="main">(</span>SepState <span class="free">h</span> <span class="free">gs</span><span class="main">)</span> <span class="main">(</span>SepState Map.empty <span class="main">(</span><span class="main">λ</span><span class="bound">obj_id</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_cdl_heap_add <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"cdl_heap_add <span class="main">(</span>SepState Map.empty <span class="main">(</span><span class="main">λ</span><span class="bound">obj_id</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>SepState <span class="free">h</span> <span class="free">gs</span><span class="main">)</span><span class="main">=</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_result_empty1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">++</span> <span class="free">b</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">a</span><span class="main">++</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> dom_map_add<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_result_empty2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">++</span> <span class="free">b</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">a</span><span class="main">++</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> dom_map_add<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_add_emptyE <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">++</span> <span class="free">b</span> <span class="main">=</span> Map.empty<span class="main">;</span> <span class="main">⟦</span><span class="free">a</span> <span class="main">=</span> Map.empty<span class="main">;</span> <span class="free">b</span> <span class="main">=</span> Map.empty<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> map_add_result_empty1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> map_add_result_empty2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> clean_slots_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"clean_slots Map.empty <span class="free">cmp</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clean_slots_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_type_update_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_type <span class="main">(</span>update_slots <span class="free">slots</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> object_type <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_type_def update_slots_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_type_object_clean_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_type <span class="main">(</span>object_clean_slots <span class="free">x</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> object_type <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_slots_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_type_object_clean_fields <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_type <span class="main">(</span>object_clean_fields <span class="free">x</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> object_type <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_fields_def object_type_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> object_type_object_clean <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_type <span class="main">(</span>object_clean <span class="free">x</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> object_type <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_type_add_to_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_type <span class="main">(</span>add_to_slots <span class="free">slots</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> object_type <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_type_def add_to_slots_def update_slots_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_slots_update_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_slots <span class="free">obj</span> <span class="main">⟹</span> object_slots <span class="main">(</span>update_slots <span class="free">slots</span> <span class="free">obj</span><span class="main">)</span> <span class="main">=</span> <span class="free">slots</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_slots_def update_slots_def has_slots_def
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_slots_update_slots_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>has_slots <span class="free">obj</span> <span class="main">⟹</span> object_slots <span class="main">(</span>update_slots <span class="free">slots</span> <span class="free">obj</span><span class="main">)</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_slots_def update_slots_def has_slots_def
                 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_slots_no_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>has_slots <span class="free">obj</span> <span class="main">⟹</span> update_slots <span class="free">slots</span> <span class="free">obj</span> <span class="main">=</span> <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_slots_def has_slots_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_slots_update_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"update_slots <span class="free">slots</span> <span class="main">(</span>update_slots <span class="free">slots'</span> <span class="free">obj</span><span class="main">)</span> <span class="main">=</span> update_slots <span class="free">slots</span> <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_slots_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_slots_same_object<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟹</span> update_slots <span class="free">a</span> <span class="free">obj</span> <span class="main">=</span> update_slots <span class="free">b</span> <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> arg_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_type_has_slots<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>has_slots <span class="free">x</span><span class="main">;</span> object_type <span class="free">x</span> <span class="main">=</span> object_type <span class="free">y</span><span class="main">⟧</span> <span class="main">⟹</span> has_slots <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_type_def has_slots_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_slots_object_clean_fields <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_slots <span class="main">(</span>object_clean_fields <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> object_slots <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_slots_def object_clean_fields_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_slots_object_clean_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_slots <span class="main">(</span>object_clean_slots <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> clean_slots <span class="main">(</span>object_slots <span class="free">obj</span><span class="main">)</span> <span class="free">cmp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_slots_def object_slots_def update_slots_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_slots_object_clean <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_slots <span class="main">(</span>object_clean <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> clean_slots <span class="main">(</span>object_slots <span class="free">obj</span><span class="main">)</span> <span class="free">cmp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_slots_add_to_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_type <span class="free">y</span> <span class="main">=</span> object_type <span class="free">z</span> <span class="main">⟹</span> object_slots <span class="main">(</span>add_to_slots <span class="main">(</span>object_slots <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> object_slots <span class="free">y</span> <span class="main">++</span> object_slots <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_slots_def add_to_slots_def update_slots_def object_type_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_slots_object_clean_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"update_slots <span class="free">slots</span> <span class="main">(</span>object_clean_slots <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> update_slots <span class="free">slots</span> <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_slots_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_clean_fields_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_clean_fields <span class="main">(</span>object_clean_fields <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span> <span class="free">cmp</span> <span class="main">=</span> object_clean_fields <span class="free">obj</span> <span class="free">cmp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_fields_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_clean_slots_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_clean_slots <span class="main">(</span>object_clean_slots <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span> <span class="free">cmp</span> <span class="main">=</span> object_clean_slots <span class="free">obj</span> <span class="free">cmp</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span>  <span class="quoted"><span class="quoted">"has_slots <span class="free">obj</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_slots_def clean_slots_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> object_clean_fields_object_clean_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_clean_fields <span class="main">(</span>object_clean_slots <span class="free">obj</span> <span class="free">gs</span><span class="main">)</span> <span class="free">gs</span> <span class="main">=</span> object_clean_slots <span class="main">(</span>object_clean_fields <span class="free">obj</span> <span class="free">gs</span><span class="main">)</span> <span class="free">gs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_fields_def object_clean_slots_def
                     clean_slots_def object_slots_def update_slots_def
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_clean_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_clean <span class="main">(</span>object_clean <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span> <span class="free">cmp</span> <span class="main">=</span> object_clean <span class="free">obj</span> <span class="free">cmp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> has_slots_object_clean_slots<span class="main">:</span>
 <span class="quoted"><span class="quoted">"has_slots <span class="main">(</span>object_clean_slots <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> has_slots <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_slots_def object_clean_slots_def update_slots_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> has_slots_object_clean_fields<span class="main">:</span>
 <span class="quoted"><span class="quoted">"has_slots <span class="main">(</span>object_clean_fields <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> has_slots <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_slots_def object_clean_fields_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> has_slots_object_clean<span class="main">:</span>
 <span class="quoted"><span class="quoted">"has_slots <span class="main">(</span>object_clean <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> has_slots <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_def has_slots_object_clean_slots has_slots_object_clean_fields<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_slots_update_slots_object_clean_fields <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_slots <span class="main">(</span>update_slots <span class="free">slots</span> <span class="main">(</span>object_clean_fields <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> object_slots <span class="main">(</span>update_slots <span class="free">slots</span> <span class="free">obj</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"has_slots <span class="free">obj</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_slots_object_clean_fields<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> object_clean_fields_update_slots <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"object_clean_fields <span class="main">(</span>update_slots <span class="free">slots</span> <span class="free">obj</span><span class="main">)</span> <span class="free">cmp</span> <span class="main">=</span> update_slots <span class="free">slots</span> <span class="main">(</span>object_clean_fields <span class="free">obj</span> <span class="free">cmp</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_fields_def update_slots_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_clean_fields_twice <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>object_clean_fields <span class="main">(</span>object_clean_fields <span class="free">obj</span> <span class="free">cmp'</span><span class="main">)</span> <span class="free">cmp</span><span class="main">)</span> <span class="main">=</span> object_clean_fields <span class="free">obj</span> <span class="main">(</span><span class="free">cmp</span> <span class="main">∩</span> <span class="free">cmp'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_fields_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_slots_object_clean_fields<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>None <span class="main">∉</span> <span class="free">cmps</span><span class="main">;</span> None <span class="main">∉</span> <span class="free">cmps'</span><span class="main">;</span> object_type <span class="free">obj</span> <span class="main">=</span> object_type <span class="free">obj'</span><span class="main">⟧</span>
    <span class="main">⟹</span> update_slots <span class="free">slots</span> <span class="main">(</span>object_clean_fields <span class="free">obj</span> <span class="free">cmps</span><span class="main">)</span> <span class="main">=</span>
        update_slots <span class="free">slots</span> <span class="main">(</span>object_clean_fields <span class="free">obj'</span> <span class="free">cmps'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_slots_def object_clean_fields_def object_type_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_clean_fields_no_slots<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>None <span class="main">∉</span> <span class="free">cmps</span><span class="main">;</span> None <span class="main">∉</span> <span class="free">cmps'</span><span class="main">;</span> object_type <span class="free">obj</span> <span class="main">=</span> object_type <span class="free">obj'</span><span class="main">;</span> <span class="main">¬</span> has_slots <span class="free">obj</span><span class="main">;</span> <span class="main">¬</span> has_slots <span class="free">obj'</span><span class="main">⟧</span>
    <span class="main">⟹</span> object_clean_fields <span class="free">obj</span> <span class="free">cmps</span> <span class="main">=</span> object_clean_fields <span class="free">obj'</span> <span class="free">cmps'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_fields_def object_type_def has_slots_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_slots_object_clean<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>None <span class="main">∉</span> <span class="free">cmps</span><span class="main">;</span> None <span class="main">∉</span> <span class="free">cmps'</span><span class="main">;</span> object_type <span class="free">obj</span> <span class="main">=</span> object_type <span class="free">obj'</span><span class="main">⟧</span>
   <span class="main">⟹</span> update_slots <span class="free">slots</span> <span class="main">(</span>object_clean <span class="free">obj</span> <span class="free">cmps</span><span class="main">)</span> <span class="main">=</span> update_slots <span class="free">slots</span> <span class="main">(</span>object_clean <span class="free">obj'</span> <span class="free">cmps'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_def object_clean_slots_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> update_slots_object_clean_fields<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cdl_heap_add_assoc'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">obj_id</span><span class="main">.</span> not_conflicting_objects <span class="free">x</span> <span class="free">z</span> <span class="bound">obj_id</span> <span class="main">∧</span>
            not_conflicting_objects <span class="free">y</span> <span class="free">z</span> <span class="bound">obj_id</span> <span class="main">∧</span>
            not_conflicting_objects <span class="free">x</span> <span class="free">z</span> <span class="bound">obj_id</span> <span class="main">⟹</span>
   cdl_heap_add <span class="main">(</span>SepState <span class="main">(</span>cdl_heap_add <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>cdl_ghost_state_add <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span>
   cdl_heap_add <span class="free">x</span> <span class="main">(</span>SepState <span class="main">(</span>cdl_heap_add <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">(</span>cdl_ghost_state_add <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> obj_id<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">obj_id</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def cdl_ghost_state_add_def not_conflicting_objects_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_unfold <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> obj_y obj_x obj_z<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_add_def clean_slots_def object_clean_def object_clean_slots_def Let_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"has_slots <span class="improper">obj_z</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"has_slots <span class="improper">obj_y</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"has_slots <span class="improper">obj_x</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_slots_object_clean_fields has_slots_object_clean_slots has_slots_object_clean
                           map_add_restrict union_intersection <span class="main"><span class="keyword3">|</span></span> 
            <span class="operator">drule</span> inter_empty_not_both <span class="main"><span class="keyword3">|</span></span> 
            <span class="operator">erule</span> update_slots_object_clean_fields <span class="main"><span class="keyword3">|</span></span>
            <span class="operator">erule</span> object_type_has_slots<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="main"><span class="keyword3">|</span></span>
            <span class="operator">simp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> has_slots <span class="improper">obj_y</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> has_slots <span class="improper">obj_x</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_slots_object_clean_fields has_slots_object_clean_slots has_slots_object_clean
                           map_add_restrict union_intersection <span class="main"><span class="keyword3">|</span></span> 
            <span class="operator">drule</span> inter_empty_not_both <span class="main"><span class="keyword3">|</span></span> 
            <span class="operator">erule</span> object_clean_fields_no_slots <span class="main"><span class="keyword3">|</span></span>
            <span class="operator">erule</span> object_type_has_slots<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="main"><span class="keyword3">|</span></span>
            <span class="operator">simp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_type_has_slots<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cdl_heap_add_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sep_state_disj <span class="free">x</span> <span class="free">y</span><span class="main">;</span> sep_state_disj <span class="free">y</span> <span class="free">z</span><span class="main">;</span> sep_state_disj <span class="free">x</span> <span class="free">z</span><span class="main">⟧</span>
  <span class="main">⟹</span> cdl_heap_add <span class="main">(</span>SepState <span class="main">(</span>cdl_heap_add <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>cdl_ghost_state_add <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span>
      cdl_heap_add <span class="free">x</span> <span class="main">(</span>SepState <span class="main">(</span>cdl_heap_add <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">(</span>cdl_ghost_state_add <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_state_disj_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> cdl_heap_add_assoc'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cdl_ghost_state_add_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cdl_ghost_state_add <span class="main">(</span>SepState <span class="main">(</span>cdl_heap_add <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>cdl_ghost_state_add <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span>
   cdl_ghost_state_add <span class="free">x</span> <span class="main">(</span>SepState <span class="main">(</span>cdl_heap_add <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">(</span>cdl_ghost_state_add <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def cdl_ghost_state_add_def Let_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> clean_slots_map_add_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cmps_a</span> <span class="main">∩</span> <span class="free">cmps_b</span> <span class="main">=</span> <span class="main">{}</span>
  <span class="main">⟹</span> clean_slots <span class="free">slots_a</span> <span class="free">cmps_a</span> <span class="main">++</span> clean_slots <span class="free">slots_b</span> <span class="free">cmps_b</span> <span class="main">=</span>
      clean_slots <span class="free">slots_b</span> <span class="free">cmps_b</span> <span class="main">++</span> clean_slots <span class="free">slots_a</span> <span class="free">cmps_a</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clean_slots_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> the_set_inter_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> map_add_restrict_comm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> object_clean_all<span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_type <span class="free">obj_a</span> <span class="main">=</span> object_type <span class="free">obj_b</span> <span class="main">⟹</span> object_clean <span class="free">obj_b</span> <span class="main">{}</span> <span class="main">=</span> object_clean <span class="free">obj_a</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_clean_def object_clean_slots_def clean_slots_def the_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> cmps'1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> obj'1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">obj_a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> update_slots_object_clean_fields<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> object_add_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>object_type <span class="free">obj_a</span> <span class="main">=</span> object_type <span class="free">obj_b</span><span class="main">;</span> <span class="free">cmps_a</span> <span class="main">∩</span> <span class="free">cmps_b</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span>
  <span class="main">⟹</span> object_add <span class="free">obj_a</span> <span class="free">obj_b</span> <span class="free">cmps_a</span> <span class="free">cmps_b</span> <span class="main">=</span> object_add <span class="free">obj_b</span> <span class="free">obj_a</span> <span class="free">cmps_b</span> <span class="free">cmps_a</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_add_def Let_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> slots_a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"object_slots <span class="free">obj_a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> slots_b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"object_slots <span class="free">obj_b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> clean_slots_map_add_comm<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> slots_a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"object_slots <span class="free">obj_a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> slots_b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"object_slots <span class="free">obj_b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> clean_slots_map_add_comm<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> object_clean_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> cmps'1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">cmps_b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> obj'1<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">obj_b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> update_slots_object_clean<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> slots_a <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"object_slots <span class="free">obj_a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> slots_b <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"object_slots <span class="free">obj_b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> clean_slots_map_add_comm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_state_add_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sep_state_disj <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> sep_state_add <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> sep_state_add <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_state_add_def sep_state_disj_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> heap_a gs_a heap_b gs_b<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def Let_unfold<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">heap_a</span> <span class="improper">obj_id</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">heap_b</span> <span class="improper">obj_id</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slots_of_heap_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">heap_b</span> <span class="improper">obj_id</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slots_of_heap_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> obj_a obj_b<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">obj_id</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> object_add_comm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_ghost_state_add_def Let_unfold Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_to_slots_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>object_slots <span class="free">y_obj</span> <span class="main">⊥</span> object_slots <span class="free">z_obj</span><span class="main">;</span> update_slots Map.empty <span class="free">y_obj</span> <span class="main">=</span> update_slots Map.empty <span class="free">z_obj</span> <span class="main">⟧</span>
  <span class="main">⟹</span> add_to_slots <span class="main">(</span>object_slots <span class="free">z_obj</span><span class="main">)</span> <span class="free">y_obj</span> <span class="main">=</span> add_to_slots <span class="main">(</span>object_slots <span class="free">y_obj</span><span class="main">)</span> <span class="free">z_obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_slots_def update_slots_def object_slots_def
                     cdl_tcb.splits cdl_cnode.splits
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_add_com
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cdl_object.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cdl_heap_add_none1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cdl_heap_add <span class="free">x</span> <span class="free">y</span> <span class="free">obj_id</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">(</span>sep_heap <span class="free">x</span><span class="main">)</span> <span class="free">obj_id</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def Let_unfold <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cdl_heap_add_none2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cdl_heap_add <span class="free">x</span> <span class="free">y</span> <span class="free">obj_id</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">(</span>sep_heap <span class="free">y</span><span class="main">)</span> <span class="free">obj_id</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def Let_unfold <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_type_object_addL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_type <span class="free">obj</span> <span class="main">=</span> object_type <span class="free">obj'</span>
  <span class="main">⟹</span> object_type <span class="main">(</span>object_add <span class="free">obj</span> <span class="free">obj'</span> <span class="free">cmp</span> <span class="free">cmp'</span><span class="main">)</span> <span class="main">=</span> object_type <span class="free">obj</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_add_def Let_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> object_type_object_addR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"object_type <span class="free">obj</span> <span class="main">=</span> object_type <span class="free">obj'</span>
  <span class="main">⟹</span> object_type <span class="main">(</span>object_add <span class="free">obj</span> <span class="free">obj'</span> <span class="free">cmp</span> <span class="free">cmp'</span><span class="main">)</span> <span class="main">=</span> object_type <span class="free">obj'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> object_add_def Let_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sep_state_add_disjL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sep_state_disj <span class="free">y</span> <span class="free">z</span><span class="main">;</span> sep_state_disj <span class="free">x</span> <span class="main">(</span>sep_state_add <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> sep_state_disj <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_state_disj_def sep_state_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> obj_id<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">obj_id</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def cdl_ghost_state_add_def object_type_object_addR
                 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_state_add_disjR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sep_state_disj <span class="free">y</span> <span class="free">z</span><span class="main">;</span> sep_state_disj <span class="free">x</span> <span class="main">(</span>sep_state_add <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> sep_state_disj <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_state_disj_def sep_state_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> obj_id<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">obj_id</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def cdl_ghost_state_add_def object_type_object_addR
                 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sep_state_add_disj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sep_state_disj <span class="free">y</span> <span class="free">z</span><span class="main">;</span> sep_state_disj <span class="free">x</span> <span class="free">y</span><span class="main">;</span> sep_state_disj <span class="free">x</span> <span class="free">z</span><span class="main">⟧</span> <span class="main">⟹</span> sep_state_disj <span class="free">x</span> <span class="main">(</span>sep_state_add <span class="free">y</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_state_disj_def sep_state_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> obj_id<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">obj_id</span></span></span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def cdl_ghost_state_add_def object_type_object_addR
                 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>




<span class="comment1">(*********************************************)</span>
<span class="comment1">(* Definition of separation logic for capDL. *)</span>
<span class="comment1">(*********************************************)</span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"sep_state"</span> <span class="main">::</span> <span class="quoted">zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≡</span> SepState Map.empty <span class="main">(</span><span class="main">λ</span><span class="bound">obj_id</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"sep_state"</span> <span class="main">::</span> <span class="quoted">stronger_sep_algebra</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(##)</span> <span class="main">≡</span> sep_state_disj"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span> <span class="main">≡</span> sep_state_add"</span></span>



<span class="comment1">(**********************************************
 * The proof that this is a separation logic. *
 **********************************************)</span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
<span class="comment1">(* x ## 0 *)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep_disj_sep_state_def sep_state_disj_def zero_sep_state_def<span class="main">)</span>
<span class="comment1">(* x ## y ⟹ y ## x *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_conflicting_objects_comm sep_disj_sep_state_def sep_state_disj_def Let_unfold
                            map_disj_com not_conflicting_objects_comm Int_commute<span class="main">)</span>
<span class="comment1">(* x + 0 = x *)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_sep_state_def sep_state_add_def zero_sep_state_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_heap_add_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cdl_ghost_state_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_split_asm<span class="main">)</span>
<span class="comment1">(* x ## y ⟹ x + y = y + x *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_sep_state_def sep_disj_sep_state_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sep_state_add_comm<span class="main">)</span>
<span class="comment1">(* (x + y) + z = x + (y + z) *)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_sep_state_def sep_state_add_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_disj_sep_state_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cdl_heap_add_assoc<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cdl_ghost_state_add_assoc<span class="main">)</span>
<span class="comment1">(* x ## y + z = (x ## y ∧ x ## z) *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_sep_state_def sep_disj_sep_state_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="comment1">(* x ## y + z ⟹ (x ## y ∧ x ## z) *)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="comment1">(* x ## y + z ⟹ (x ## y) *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sep_state_add_disjL<span class="main">)</span>
   <span class="comment1">(* x ## y + z ⟹ (x ## z) *)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sep_state_add_disjR<span class="main">)</span>
  <span class="comment1">(* x ## y + z ⟸ (x ## y ∧ x ## z) *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sep_state_add_disj<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Separation_D">
<div class="head">
<h1>Theory Separation_D</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Andrew Boyton, 2012
   Maintainers: Gerwin Klein &lt;kleing at cse.unsw.edu.au&gt;
                Rafal Kolanski &lt;rafal.kolanski at nicta.com.au&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Defining some separation logic maps-to predicates on top of the instantiation."</span></span>

<span class="keyword1"><span class="command">theory</span></span> Separation_D
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Abstract_Separation_D.html">Abstract_Separation_D</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> sep_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"sep_state <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">state_sep_projection</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_state <span class="main">⇒</span> sep_state"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_sep_projection</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> SepState <span class="main">(</span>cdl_objects <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>cdl_ghost_state <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="comment1">(* This turns a separation logic predicate into a predicate on the capDL state. *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">lift'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sep_state <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> cdl_state <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;</span>_<span class="keyword1">&gt;</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>state_sep_projection <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* The generalisation of the maps to operator for separation logic. *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_map_general</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object_id <span class="main">⇒</span> cdl_object <span class="main">⇒</span> cdl_components <span class="main">⇒</span> sep_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_map_general</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> sep_heap <span class="bound">s</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span><span class="main">]</span> <span class="main">∧</span> sep_ghost_state <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span>"</span></span>

<span class="comment1">(* Alternate definition without the [p ↦ obj] notation. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> sep_map_general_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sep_map_general <span class="free">p</span> <span class="free">obj</span> <span class="free">gs</span> <span class="free">s</span> <span class="main">=</span>
   <span class="main">(</span>dom <span class="main">(</span>sep_heap <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> ko_at <span class="free">obj</span> <span class="free">p</span> <span class="main">(</span>sep_heap <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> sep_ghost_state <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="free">gs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sep_map_general_def object_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* There is an object there. *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_map_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object_id <span class="main">⇒</span> cdl_object <span class="main">⇒</span> sep_pred"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↦i</span> _"</span> <span class="main">[</span>76<span class="main">,</span>71<span class="main">]</span> 76<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1"><span class="free">↦i</span></span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="main">≡</span> sep_map_general <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> UNIV"</span></span>

<span class="comment1">(* The fields are there (and there are no caps). *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_map_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_object_id <span class="main">⇒</span> cdl_object <span class="main">⇒</span> sep_pred"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↦f</span> _"</span> <span class="main">[</span>76<span class="main">,</span>71<span class="main">]</span> 76<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1"><span class="free">↦f</span></span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="main">≡</span> sep_map_general <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>update_slots Map.empty <span class="free"><span class="bound"><span class="entity">obj</span></span></span><span class="main">)</span> <span class="main">{</span>None<span class="main">}</span>"</span></span>

<span class="comment1">(* There is that cap there. *)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_map_c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cdl_cap_ref <span class="main">⇒</span> cdl_cap <span class="main">⇒</span> sep_pred"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↦c</span> _"</span> <span class="main">[</span>76<span class="main">,</span>71<span class="main">]</span> 76<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1"><span class="free">↦c</span></span> <span class="free"><span class="bound"><span class="entity">cap</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">obj_id</span><span class="main">,</span> <span class="bound">slot</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span> <span class="bound">heap</span> <span class="main">=</span> sep_heap <span class="bound">s</span> <span class="keyword1">in</span>
  <span class="main">∃</span><span class="bound">obj</span><span class="main">.</span> sep_map_general <span class="bound">obj_id</span> <span class="bound">obj</span> <span class="main">{</span>Some <span class="bound">slot</span><span class="main">}</span> <span class="bound">s</span> <span class="main">∧</span> object_slots <span class="bound">obj</span> <span class="main">=</span> <span class="main">[</span><span class="bound">slot</span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">cap</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sep_any</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> sep_pred<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> sep_pred<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sep_any</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sep_any_map_i</span> <span class="main">≡</span> sep_any sep_map_i"</span></span>
<span class="keyword1"><span class="command">notation</span></span> sep_any_map_i <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↦i</span> <span class="keyword1">-</span>"</span> 76<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sep_any_map_c</span> <span class="main">≡</span> sep_any sep_map_c"</span></span>
<span class="keyword1"><span class="command">notation</span></span> sep_any_map_c <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↦c</span> <span class="keyword1">-</span>"</span> 76<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>