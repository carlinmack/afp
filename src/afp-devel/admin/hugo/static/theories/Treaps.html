<div id="Probability_Misc">
<div class="head">
<h1>Theory Probability_Misc</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:      Probability_Misc.thy
  Authors:   Max Haslbeck, Manuel Eberl

  Miscellaneous facts about measures and probability that are missing from the library and
  should perhaps be moved there at some point.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary material›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Probability_Misc
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measure_eqI_countable_AE'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> Pow <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"sets <span class="free">N</span> <span class="main">=</span> Pow <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ω</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ae<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Ω</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">N</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Ω</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"countable <span class="free">Ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Ω</span> <span class="main">⟹</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="free">N</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">N</span> <span class="skolem">A</span> <span class="main">=</span> emeasure <span class="free">N</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">Ω</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ae subset A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_eq_AE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> emeasure <span class="free">N</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∂</span>count_space <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">Ω</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_countable_singleton<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∂</span>count_space <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">Ω</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">Ω</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_countable_singleton<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ae A subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_eq_AE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="skolem">A</span> <span class="main">=</span> emeasure <span class="free">N</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_le<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>second_countable_topology<span class="main">,</span> linorder_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pred_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> borel_measurable_le assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_eq<span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>second_countable_topology<span class="main">,</span> linorder_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pred_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> borel_measurable_eq assms<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> measure"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> singleton_null_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∈</span> null_sets <span class="free">M</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> countable_null_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"countable <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> space <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> null_sets <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> null_sets <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> null_sets_UN' assms singleton_null_set<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_null_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> space <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> null_sets <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> countable_finite<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> countable_null_set<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_inj_on_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> Measurable.pred <span class="main">(</span><span class="free">M</span> <span class="bound">i</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">I</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inj_on <span class="bound">x</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    
<span class="keyword1"><span class="command">lemma</span></span> almost_everywhere_not_in_countable_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"countable <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> null<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> null_sets <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> space <span class="free">M</span> <span class="main">∈</span> null_sets <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> countable_null_set<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> null<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AE_I'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> AE_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> almost_everywhere_inj_on_PiM<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prob_space<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> prob_space <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> Measurable.pred <span class="main">(</span><span class="free">M</span> <span class="bound">i</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> null<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> null_sets <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> inj_on <span class="bound">f</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> measurable_inj_on_finite
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I'</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="skolem">I'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> pair_sigma_finite <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"PiM <span class="skolem">I</span> <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pair_sigma_finite_def <span class="keyword1"><span class="command">using</span></span> insert.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prob_space_imp_sigma_finite prob_space prob_space_PiM <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> insert.hyps <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"PiM <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">M</span> <span class="main">=</span> distr <span class="main">(</span><span class="free">M</span> <span class="skolem">i</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">I</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="bound">X</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert.prems 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_pair_PiM_eq_PiM <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prob_space<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> <span class="main">…</span><span class="main">.</span> inj_on <span class="bound">f</span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> 
                 <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span> <span class="skolem">i</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">I</span> <span class="free">M</span><span class="main">.</span> inj_on <span class="main">(</span><span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> AE_distr_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">measurable</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span> <span class="skolem">i</span><span class="main">.</span> <span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">I</span> <span class="free">M</span><span class="main">.</span> inj_on <span class="main">(</span><span class="bound">y</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AE_pair_iff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span> <span class="skolem">i</span><span class="main">.</span> <span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">I</span> <span class="free">M</span><span class="main">.</span> inj_on <span class="main">(</span><span class="bound">y</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">∧</span>
                      <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span> <span class="skolem">i</span><span class="main">.</span> <span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">I</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">y</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">I</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="main">…</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">from</span></span> insert.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">I</span> <span class="free">M</span><span class="main">.</span> inj_on <span class="bound">f</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> insert.IH<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">I</span> <span class="free">M</span><span class="main">.</span> inj_on <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">insert</span> insert.hyps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">I</span>›</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="skolem">I</span> <span class="main">∩</span> space <span class="main">(</span><span class="free">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> null_sets <span class="main">(</span><span class="free">M</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_null_set<span class="main">)</span> 
             <span class="main">(</span><span class="operator">insert</span> insert.hyps insert.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> null <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I'_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span> <span class="skolem">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">f</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">I</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AE_I'<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> insert.hyps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span> <span class="skolem">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">f</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span> <span class="skolem">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> AE_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">I</span> <span class="free">M</span><span class="main">.</span> <span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span> <span class="skolem">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span> <span class="skolem">i</span><span class="main">.</span> <span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">I</span> <span class="free">M</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> AE_commute<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> <span class="free">M</span> <span class="skolem">i</span><span class="main">.</span> <span class="keyword1">AE</span> <span class="bound">y</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">I</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">y</span><span class="main">(</span><span class="skolem">i</span> <span class="main">:=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">I</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> AE_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">lemma</span></span> null_sets_uniform_measure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"null_sets <span class="main">(</span>uniform_measure <span class="free">M</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">B</span><span class="main">.</span> <span class="free">A</span> <span class="main">∩</span> <span class="bound">B</span><span class="main">)</span> <span class="main">-`</span> null_sets <span class="free">M</span> <span class="main">∩</span> sets <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> null_sets_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> almost_everywhere_avoid_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> inj_on <span class="bound">f</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> almost_everywhere_inj_on_PiM fin prob_space_uniform_measure<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> null_sets <span class="main">(</span>uniform_measure lborel <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> null_sets_uniform_measure<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> almost_everywhere_avoid_countable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"countable <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> uniform_measure lborel <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> almost_everywhere_not_in_countable_set assms prob_space_uniform_measure<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> null_sets <span class="main">(</span>uniform_measure lborel <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> null_sets_uniform_measure<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> measure_pmf_of_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>pmf_of_set <span class="free">A</span><span class="main">)</span> <span class="main">=</span> uniform_measure <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> emeasure_pmf_of_set divide_ennreal <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> card_gt_0_iff
                  ennreal_of_nat_eq_real_of_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emeasure_distr_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">M'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> sets <span class="free">N'</span>"</span></span> <span class="quoted"><span class="quoted">"sets <span class="free">M'</span> <span class="main">⊆</span> sets <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"sets <span class="free">N'</span> <span class="main">⊆</span> sets <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> sets <span class="free">M'</span> <span class="main">⟹</span> emeasure <span class="free">M</span> <span class="bound">X</span> <span class="main">=</span> emeasure <span class="free">M'</span> <span class="bound">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> sets <span class="free">M</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">⊆</span> space <span class="free">M</span> <span class="main">-</span> space <span class="free">M'</span> <span class="main">⟹</span> emeasure <span class="free">M</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="free">A</span><span class="main">=</span> emeasure <span class="main">(</span>distr <span class="free">M'</span> <span class="free">N'</span> <span class="free">f</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> space_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="free">M'</span> <span class="main">⊆</span> space <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹sets <span class="free">M'</span> <span class="main">⊆</span> sets <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets_le_imp_space_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> space <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> space <span class="free">M</span> <span class="main">=</span> <span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> space <span class="free">M'</span> <span class="main">∪</span> <span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">(</span>space <span class="free">M</span> <span class="main">-</span> space <span class="free">M'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> space_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">…</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> space <span class="free">M'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_Un_null_set<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> space <span class="free">M'</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">(</span>space <span class="free">M</span> <span class="main">-</span> space <span class="free">M'</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_Diff measurable_sets sets.Diff sets.top subsetCE<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">(</span>space <span class="free">M</span> <span class="main">-</span> space <span class="free">M'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> assms<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">(</span>space <span class="free">M</span> <span class="main">-</span> space <span class="free">M'</span><span class="main">)</span> <span class="main">∈</span> null_sets <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> null_sets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="free">M'</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> space <span class="free">M'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> assms<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="main">(</span>distr <span class="free">M'</span> <span class="free">N'</span> <span class="free">f</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distr_uniform_measure_count_space_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"distr <span class="main">(</span>uniform_measure <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span>
             uniform_measure <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">X</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> X_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A'</span> <span class="main">∩</span> <span class="skolem">X</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A'</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> count_space <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_count_space_eq1<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> X_subset <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?lhs</span> <span class="skolem">X</span> <span class="main">=</span> 
                        emeasure <span class="main">(</span>uniform_measure <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms X_subset 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A'</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> emeasure <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span> <span class="free">A'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_uniform_measure<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>card <span class="main">(</span><span class="free">A'</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> of_nat <span class="main">(</span>card <span class="free">A'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> emeasure_count_space<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A'</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A'</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_image <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">A'</span> <span class="main">∩</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A'</span> <span class="main">∩</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>card <span class="free">A'</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="main">(</span>card <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_image<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>card <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A'</span> <span class="main">∩</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">…</span> <span class="main">=</span> 
               emeasure <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A'</span> <span class="main">∩</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">/</span> emeasure <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> emeasure_count_space<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms X_subset <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="var">?rhs</span> <span class="skolem">X</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_uniform_measure <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pair_prob_space<span class="main">)</span> pair_measure_bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">M1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M2</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> subprob_algebra <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M2</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span> <span class="main">←</span> <span class="free">M1</span><span class="main">;</span> <span class="bound">y</span> <span class="main">←</span> <span class="free">M2</span><span class="main">;</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> M1 <span class="main">=</span> M1.prob_space_axioms <span class="keyword2"><span class="keyword">and</span></span> M2 <span class="main">=</span> M2.prob_space_axioms
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M1</span> <span class="main">∈</span> space <span class="main">(</span>subprob_algebra <span class="free">M1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> M1.M_in_subprob<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M2</span> <span class="main">∈</span> space <span class="main">(</span>subprob_algebra <span class="free">M2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> M2.M_in_subprob<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M2</span><span class="main">)</span> <span class="main">=</span> <span class="free">M1</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">M2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return <span class="main">(</span><span class="free">M1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M2</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pair_measure_eq_bind<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">=</span> <span class="free">M1</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">M2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return <span class="main">(</span><span class="free">M1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M2</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bind_assoc<span class="main">)</span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">M1</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">M2</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> return <span class="main">(</span><span class="free">M1</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M2</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl bind_assoc<span class="main">)</span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">x</span> <span class="main">←</span> <span class="free">M1</span><span class="main">;</span> <span class="bound">y</span> <span class="main">←</span> <span class="free">M2</span><span class="main">;</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong refl bind_return<span class="main">)</span>
       <span class="main">(</span><span class="operator">measurable</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_pair_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_space_singleton_conv_return<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"count_space <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> return <span class="main">(</span>count_space <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> sets <span class="main">(</span>count_space <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>count_space <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> emeasure <span class="main">(</span>return <span class="main">(</span>count_space <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> distr_count_space_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> space <span class="free">M</span> <span class="main">⟹</span> distr <span class="main">(</span>count_space <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">M</span> <span class="free">f</span> <span class="main">=</span> return <span class="free">M</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> count_space_singleton_conv_return<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> distr_return<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> uniform_measure_count_space_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"uniform_measure <span class="free">M</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> return <span class="free">M</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> sets <span class="main">(</span>uniform_measure <span class="free">M</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>uniform_measure <span class="free">M</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> emeasure <span class="main">(</span>return <span class="free">M</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> PiM_uniform_measure_permute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"distr <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span>
             PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span>
          distr <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> 
            <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">λ</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong sets_PiM_cong refl<span class="main">)</span> 
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff space_PiM PiE_def extensional_def permutes_in_image<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_PiM_reindex<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_inj_on permutes_in_image<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prob_space_uniform_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ennreal_fact <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ennreal <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">=</span> fact <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> ennreal_mult' ennreal_of_nat_eq_real_of_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inverse_ennreal_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="main">::</span> ennreal<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> inverse <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> divide_ennreal_def ennreal_inverse_1 ennreal_top_eq_mult_iff mult.comm_neutral 
        mult_divide_eq_ennreal mult_eq_0_iff semiring_normalization_rules<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Treap">
<div class="head">
<h1>Theory Treap</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:      Treap.thy
  Authors:   Tobias Nipkow, Max Haslbeck
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Treaps›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Treap
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Tree.html">HOL-Library.Tree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">treap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>linorder <span class="main">*</span> <span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">treap</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>bst <span class="main">(</span>map_tree fst <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span> heap <span class="main">(</span>map_tree snd <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">keys</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> set_tree <span class="main">(</span>map_tree fst <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">prios</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> set_tree <span class="main">(</span>map_tree snd <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">treap_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>linorder <span class="main">*</span> <span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span> <span class="main">*</span> <span class="tfree">'p</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">treap_of</span> <span class="free"><span class="bound"><span class="entity">KP</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> infinite <span class="free"><span class="bound"><span class="entity">KP</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">KP</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> Leaf <span class="keyword1">else</span>
  <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> arg_min_on snd <span class="free"><span class="bound"><span class="entity">KP</span></span></span><span class="main">;</span>
      <span class="bound">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">KP</span></span></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="bound">m</span><span class="main">}</span><span class="main">;</span>
      <span class="bound">R</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">KP</span></span></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&gt;</span> fst <span class="bound">m</span><span class="main">}</span>
  <span class="keyword1">in</span> Node <span class="main">(</span><span class="free">treap_of</span> <span class="bound">L</span><span class="main">)</span> <span class="bound">m</span> <span class="main">(</span><span class="free">treap_of</span> <span class="bound">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure card"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>measure card<span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">KP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">m</span> <span class="skolem">L</span>
  <span class="keyword3"><span class="command">assume</span></span> KP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>infinite <span class="skolem">KP</span> <span class="main">∨</span> <span class="skolem">KP</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> arg_min_on snd <span class="skolem">KP</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">KP</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="skolem">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="skolem">KP</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> KP arg_min_if_finite<span class="main">(</span>1<span class="main">)</span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">L</span><span class="main">,</span> <span class="skolem">KP</span><span class="main">)</span> <span class="main">∈</span> measure card"</span></span> <span class="keyword1"><span class="command">using</span></span> KP L <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> psubset_card_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">KP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">m</span> <span class="skolem">R</span>
  <span class="keyword3"><span class="command">assume</span></span> KP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>infinite <span class="skolem">KP</span> <span class="main">∨</span> <span class="skolem">KP</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> arg_min_on snd <span class="skolem">KP</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">KP</span><span class="main">.</span> fst <span class="skolem">m</span> <span class="main">&lt;</span> fst <span class="bound">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="skolem">KP</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> KP arg_min_if_finite<span class="main">(</span>1<span class="main">)</span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">R</span><span class="main">,</span> <span class="skolem">KP</span><span class="main">)</span> <span class="main">∈</span> measure card"</span></span> <span class="keyword1"><span class="command">using</span></span> KP R <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> psubset_card_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> treap_of.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> treap_of_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> treap <span class="free">t</span><span class="main">;</span>  inj_on snd <span class="main">(</span>set_tree <span class="free">t</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> treap_of <span class="main">(</span>set_tree <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"set_tree <span class="free">t</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> treap_of.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>set_tree <span class="skolem">t</span><span class="main">)</span> <span class="main">∨</span> set_tree <span class="skolem">t</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_of.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"arg_min_on snd <span class="main">(</span>set_tree <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> set_tree <span class="skolem">t</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="var">?m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> set_tree <span class="skolem">t</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&gt;</span> fst <span class="var">?m</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">kp</span> <span class="main">∈</span> set_tree <span class="skolem">t</span><span class="main">.</span> snd <span class="skolem">a</span> <span class="main">≤</span> snd <span class="bound">kp</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t treap_def ball_Un<span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> image_eqI snd_conv tree.set_map<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="var">?m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> False arg_min_if_finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> arg_min_if_finite<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inj_on_def 
          le_neq_trans t tree.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"treap <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"treap <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_def t<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">l</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> set_tree <span class="skolem">t</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="skolem">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def t ball_Un tree.set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">r</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> set_tree <span class="skolem">t</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&gt;</span> fst <span class="skolem">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def t ball_Un tree.set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> treap_of <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="var">?m</span>›</span></span> l r <span class="quoted"><span class="quoted">‹treap <span class="skolem">l</span>›</span></span><span class="main">]</span>
        l <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="var">?m</span>›</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> treap_of <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="var">?m</span>›</span></span> l r <span class="quoted"><span class="quoted">‹treap <span class="skolem">r</span>›</span></span><span class="main">]</span>
        r <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="var">?m</span>›</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Node <span class="main">(</span>treap_of <span class="var">?L</span><span class="main">)</span> <span class="var">?m</span> <span class="main">(</span>treap_of <span class="var">?R</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="var">?m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">=</span> treap_of <span class="var">?L</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> treap_of <span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> t<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> treap_of.simps<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> treap_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> treap <span class="free">t1</span><span class="main">;</span> treap <span class="free">t2</span><span class="main">;</span> set_tree <span class="free">t1</span> <span class="main">=</span> set_tree <span class="free">t2</span><span class="main">;</span> inj_on snd <span class="main">(</span>set_tree <span class="free">t1</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">t1</span> <span class="main">=</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>linorder <span class="main">*</span> <span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> tree"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> treap_of_unique<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'p</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span> <span class="main">×</span> <span class="tfree">'p</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span> <span class="main">×</span> <span class="tfree">'p</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> Leaf <span class="main">=</span> <span class="main">⟨</span>Leaf<span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">,</span> Leaf<span class="main">⟩</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k1</span></span></span> <span class="keyword1">then</span>
     <span class="main">(</span><span class="keyword1">case</span> <span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span>
       <span class="main">⟨</span><span class="bound">l2</span><span class="main">,</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span><span class="main">,</span> <span class="bound">r2</span><span class="main">⟩</span> <span class="main">⇒</span>
         <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">≤</span> <span class="bound">p2</span> <span class="keyword1">then</span> <span class="main">⟨</span><span class="main">⟨</span><span class="bound">l2</span><span class="main">,</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span><span class="main">,</span> <span class="bound">r2</span><span class="main">⟩</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span>
         <span class="keyword1">else</span> <span class="main">⟨</span><span class="bound">l2</span><span class="main">,</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">r2</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span><span class="main">⟩</span><span class="main">)</span>
   <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">k1</span></span></span> <span class="keyword1">then</span>
     <span class="main">(</span><span class="keyword1">case</span> <span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span>
       <span class="main">⟨</span><span class="bound">l2</span><span class="main">,</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span><span class="main">,</span> <span class="bound">r2</span><span class="main">⟩</span> <span class="main">⇒</span>
         <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">≤</span> <span class="bound">p2</span> <span class="keyword1">then</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">l2</span><span class="main">,</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span><span class="main">,</span> <span class="bound">r2</span><span class="main">⟩</span><span class="main">⟩</span>
         <span class="keyword1">else</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">l2</span><span class="main">⟩</span><span class="main">,</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span><span class="main">,</span> <span class="bound">r2</span><span class="main">⟩</span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ins_neq_Leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">k</span> <span class="free">p</span> <span class="free">t</span> <span class="main">≠</span> <span class="main">⟨⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"keys <span class="main">(</span>ins <span class="free">k</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Set.insert <span class="free">k</span> <span class="main">(</span>keys <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_neq_Leaf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split prod.split<span class="main">)</span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prios_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"prios <span class="main">(</span>ins <span class="free">k</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> prios <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_neq_Leaf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prios_ins'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> keys <span class="free">t</span> <span class="main">⟹</span> prios <span class="main">(</span>ins <span class="free">k</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> prios <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_neq_Leaf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_tree_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="main">(</span>ins <span class="free">k</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">p</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> set_tree <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_neq_Leaf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split prod.split<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> set_tree_ins'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> keys <span class="free">t</span> <span class="main">⟹</span>  <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">p</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> set_tree <span class="free">t</span> <span class="main">⊆</span> set_tree <span class="main">(</span>ins <span class="free">k</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_neq_Leaf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_tree_ins_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> keys <span class="free">t</span> <span class="main">⟹</span> set_tree <span class="main">(</span>ins <span class="free">k</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">p</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> set_tree <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_tree_ins set_tree_ins' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> prios_ins_special<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ins <span class="free">k</span> <span class="free">p</span> <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="main">(</span><span class="free">k'</span><span class="main">,</span><span class="free">p'</span><span class="main">)</span> <span class="free">r</span><span class="main">;</span>  <span class="free">p'</span> <span class="main">=</span> <span class="free">p</span><span class="main">;</span> <span class="free">p</span> <span class="main">∈</span> prios <span class="free">r</span> <span class="main">∪</span> prios <span class="free">l</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> prios <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="quoted"><span class="free">p'</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_neq_Leaf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits prod.splits if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> treap_NodeI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> treap <span class="free">l</span><span class="main">;</span> treap <span class="free">r</span><span class="main">;</span>
     <span class="main">∀</span><span class="bound">k'</span> <span class="main">∈</span> keys <span class="free">l</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">;</span> <span class="main">∀</span><span class="bound">k'</span> <span class="main">∈</span> keys <span class="free">r</span><span class="main">.</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="bound">k'</span><span class="main">;</span>
     <span class="main">∀</span><span class="bound">p'</span> <span class="main">∈</span> prios <span class="free">l</span><span class="main">.</span> <span class="free">p</span> <span class="main">≤</span> <span class="bound">p'</span><span class="main">;</span> <span class="main">∀</span><span class="bound">p'</span> <span class="main">∈</span> prios <span class="free">r</span><span class="main">.</span> <span class="free">p</span> <span class="main">≤</span> <span class="bound">p'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> treap <span class="main">(</span>Node <span class="free">l</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> treap_rotate1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"treap <span class="free">l2</span>"</span></span> <span class="quoted"><span class="quoted">"treap <span class="free">r2</span>"</span></span> <span class="quoted"><span class="quoted">"treap <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p1</span> <span class="main">≤</span> <span class="free">p2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">k1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ins<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">k</span> <span class="free">p</span> <span class="free">l</span> <span class="main">=</span> Node <span class="free">l2</span> <span class="main">(</span><span class="free">k2</span><span class="main">,</span><span class="free">p2</span><span class="main">)</span> <span class="free">r2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> treap_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"treap <span class="main">(</span>ins <span class="free">k</span> <span class="free">p</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> treap<span class="main">:</span> <span class="quoted"><span class="quoted">"treap <span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="free">k1</span><span class="main">,</span> <span class="free">p1</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"treap <span class="main">(</span>Node <span class="free">l2</span> <span class="main">(</span><span class="free">k2</span><span class="main">,</span><span class="free">p2</span><span class="main">)</span> <span class="main">(</span>Node <span class="free">r2</span> <span class="main">(</span><span class="free">k1</span><span class="main">,</span><span class="free">p1</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> treap_NodeI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹treap <span class="free">l2</span>›</span></span> treap_NodeI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹treap <span class="free">r2</span>›</span></span> <span class="quoted"><span class="quoted">‹treap <span class="free">r</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> keys_ins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"keys <span class="free">r2</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">∪</span> keys <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> treap <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">∈</span>keys <span class="free">l</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">&lt;</span> <span class="free">k1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">∈</span>keys <span class="free">r2</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">&lt;</span> <span class="free">k1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">k1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> treap <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>prios <span class="free">l</span><span class="main">.</span> <span class="free">p1</span> <span class="main">≤</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>prios <span class="free">r2</span><span class="main">.</span> <span class="free">p1</span> <span class="main">≤</span> <span class="bound">p'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> prios <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∨</span> <span class="skolem">p'</span> <span class="main">∈</span> prios <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prios_ins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> ins <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p2</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∨</span> <span class="free">p2</span> <span class="main">∈</span> prios <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prios_ins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> ins <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p2</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> prios_ins_special<span class="main">[</span><span class="operator">OF</span> ins<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> prios <span class="free">r2</span>›</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p2</span> <span class="main">∈</span> prios <span class="free">l</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">p1</span> <span class="main">≤</span> <span class="free">p2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> prios <span class="free">l</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k2</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∨</span> <span class="free">k2</span> <span class="main">∈</span> keys <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> keys_ins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> ins <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k2</span> <span class="main">&lt;</span> <span class="free">k1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k2</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">k2</span> <span class="main">&lt;</span> <span class="free">k1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">k1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k2</span> <span class="main">∈</span> keys <span class="free">l</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">k2</span> <span class="main">&lt;</span> <span class="free">k1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> treap <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">∈</span>keys <span class="free">r2</span><span class="main">.</span> <span class="free">k2</span> <span class="main">&lt;</span> <span class="bound">k'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> treap_ins <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins treap_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">∈</span>keys <span class="free">r</span><span class="main">.</span> <span class="free">k2</span> <span class="main">&lt;</span> <span class="bound">k'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 treap <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">∈</span>keys <span class="main">⟨</span><span class="free">r2</span><span class="main">,</span> <span class="main">(</span><span class="free">k1</span><span class="main">,</span> <span class="free">p1</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span><span class="main">.</span> <span class="free">k2</span> <span class="main">&lt;</span> <span class="bound">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>prios <span class="main">⟨</span><span class="free">r2</span><span class="main">,</span> <span class="main">(</span><span class="free">k1</span><span class="main">,</span> <span class="free">p1</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span><span class="main">.</span> <span class="free">p2</span> <span class="main">≤</span> <span class="bound">p'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ins treap_ins treap <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">p1</span> <span class="main">≤</span> <span class="free">p2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_def ball_Un<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> ins treap_ins treap <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> treap_def ball_Un›</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> treap_rotate2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"treap <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"treap <span class="free">l2</span>"</span></span> <span class="quoted"><span class="quoted">"treap <span class="free">r2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p1</span> <span class="main">≤</span> <span class="free">p2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k1</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ins<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">k</span> <span class="free">p</span> <span class="free">r</span> <span class="main">=</span> Node <span class="free">l2</span> <span class="main">(</span><span class="free">k2</span><span class="main">,</span><span class="free">p2</span><span class="main">)</span> <span class="free">r2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> treap_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"treap <span class="main">(</span>ins <span class="free">k</span> <span class="free">p</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> treap<span class="main">:</span> <span class="quoted"><span class="quoted">"treap <span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="free">k1</span><span class="main">,</span> <span class="free">p1</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"treap <span class="main">(</span>Node <span class="main">(</span>Node <span class="free">l</span> <span class="main">(</span><span class="free">k1</span><span class="main">,</span><span class="free">p1</span><span class="main">)</span> <span class="free">l2</span><span class="main">)</span> <span class="main">(</span><span class="free">k2</span><span class="main">,</span><span class="free">p2</span><span class="main">)</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> treap_NodeI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> treap_NodeI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹treap <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹treap <span class="free">l2</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹treap <span class="free">r2</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> keys_ins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"keys <span class="free">l2</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">∪</span> keys <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> treap <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">∈</span>keys <span class="free">r</span><span class="main">.</span> <span class="free">k1</span> <span class="main">&lt;</span> <span class="bound">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">∈</span>keys <span class="free">l2</span><span class="main">.</span> <span class="free">k1</span> <span class="main">&lt;</span> <span class="bound">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="quoted"><span class="quoted">‹<span class="free">k1</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> treap <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>prios <span class="free">r</span><span class="main">.</span> <span class="free">p1</span> <span class="main">≤</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>prios <span class="free">l2</span><span class="main">.</span> <span class="free">p1</span> <span class="main">≤</span> <span class="bound">p'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> prios <span class="free">l2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∨</span> <span class="skolem">p'</span> <span class="main">∈</span> prios <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prios_ins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> ins <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p2</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∨</span> <span class="free">p2</span> <span class="main">∈</span> prios <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prios_ins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> ins <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p2</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> prios_ins_special<span class="main">[</span><span class="operator">OF</span> ins<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> prios <span class="free">l2</span>›</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p2</span> <span class="main">∈</span> prios <span class="free">r</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">p1</span> <span class="main">≤</span> <span class="free">p2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> prios <span class="free">r</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k2</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∨</span> <span class="free">k2</span> <span class="main">∈</span> keys <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> keys_ins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> ins <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k1</span> <span class="main">&lt;</span> <span class="free">k2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k2</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">k1</span> <span class="main">&lt;</span> <span class="free">k2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k1</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k2</span> <span class="main">∈</span> keys <span class="free">r</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">k1</span> <span class="main">&lt;</span> <span class="free">k2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> treap <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">∈</span>keys <span class="free">l</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">&lt;</span> <span class="free">k2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 treap <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">∈</span>keys <span class="free">l2</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">&lt;</span> <span class="free">k2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> treap_ins <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins treap_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">∈</span>keys <span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="free">k1</span><span class="main">,</span> <span class="free">p1</span><span class="main">)</span><span class="main">,</span> <span class="free">l2</span><span class="main">⟩</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">&lt;</span> <span class="free">k2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>prios <span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="main">(</span><span class="free">k1</span><span class="main">,</span> <span class="free">p1</span><span class="main">)</span><span class="main">,</span> <span class="free">l2</span><span class="main">⟩</span><span class="main">.</span> <span class="free">p2</span> <span class="main">≤</span> <span class="bound">p'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ins treap_ins treap <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">p1</span> <span class="main">≤</span> <span class="free">p2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_def ball_Un<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> ins treap_ins treap <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> treap_def ball_Un›</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> treap_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"treap <span class="free">t</span> <span class="main">⟹</span> treap <span class="main">(</span>ins <span class="free">k</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">l</span> <span class="skolem">k1</span> <span class="skolem">p1</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"treap <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"treap <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_def tree.set_map<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> ins<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">l</span> <span class="main">=</span> Node <span class="skolem">l2</span> <span class="main">(</span><span class="skolem">k2</span><span class="main">,</span><span class="skolem">p2</span><span class="main">)</span> <span class="skolem">r2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ins_neq_Leaf neq_Leaf_iff prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> treap_ins <span class="main">=</span> <span class="quoted">"2.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>›</span></span> <span class="quoted"><span class="quoted">‹treap <span class="skolem">l</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"treap <span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="quoted">"treap <span class="skolem">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ins <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"treap <span class="main">(</span>Node <span class="main">(</span>Node <span class="skolem">l2</span> <span class="main">(</span><span class="skolem">k2</span><span class="main">,</span><span class="skolem">p2</span><span class="main">)</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k1</span><span class="main">,</span><span class="skolem">p1</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> treap_NodeI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> treap_ins<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ins<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹treap <span class="skolem">r</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ins treap_ins <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>›</span></span> <span class="quoted">"2.prems"</span> keys_ins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def ball_Un order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>›</span></span> ins <span class="quoted"><span class="quoted">‹<span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"treap <span class="main">(</span>Node <span class="skolem">l2</span> <span class="main">(</span><span class="skolem">k2</span><span class="main">,</span><span class="skolem">p2</span><span class="main">)</span> <span class="main">(</span>Node <span class="skolem">r2</span> <span class="main">(</span><span class="skolem">k1</span><span class="main">,</span><span class="skolem">p1</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> treap_rotate1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹treap <span class="skolem">l2</span>›</span></span> <span class="quoted"><span class="quoted">‹treap <span class="skolem">r2</span>›</span></span>  <span class="quoted"><span class="quoted">‹treap <span class="skolem">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>›</span></span> ins treap_ins <span class="quoted">"2.prems"</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>›</span></span> ins <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">k1</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> ins<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="main">=</span> Node <span class="skolem">l2</span> <span class="main">(</span><span class="skolem">k2</span><span class="main">,</span><span class="skolem">p2</span><span class="main">)</span> <span class="skolem">r2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ins_neq_Leaf neq_Leaf_iff prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> treap_ins <span class="main">=</span> <span class="quoted">"2.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">k1</span>›</span></span> <span class="quoted"><span class="quoted">‹treap <span class="skolem">r</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"treap <span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="quoted">"treap <span class="skolem">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ins <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span> <span class="main">∈</span> set_tree <span class="main">(</span>map_tree fst <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                 <span class="bound">k'</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="bound">k'</span> <span class="main">∈</span> set_tree <span class="main">(</span>map_tree fst <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_ins<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"treap <span class="main">(</span>Node <span class="skolem">l</span> <span class="main">(</span><span class="skolem">k1</span><span class="main">,</span><span class="skolem">p1</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> treap_NodeI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹treap <span class="skolem">l</span>›</span></span> treap_ins<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ins treap_ins <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">k1</span>›</span></span> <span class="quoted">"2.prems"</span> keys_ins<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_def ball_Un order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">k1</span>›</span></span> ins <span class="quoted"><span class="quoted">‹<span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"treap <span class="main">(</span>Node <span class="main">(</span>Node <span class="skolem">l</span> <span class="main">(</span><span class="skolem">k1</span><span class="main">,</span><span class="skolem">p1</span><span class="main">)</span> <span class="skolem">l2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k2</span><span class="main">,</span><span class="skolem">p2</span><span class="main">)</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> treap_rotate2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹treap <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹treap <span class="skolem">l2</span>›</span></span> <span class="quoted"><span class="quoted">‹treap <span class="skolem">r2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>›</span></span>
             <span class="quoted"><span class="quoted">‹<span class="skolem">k1</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> ins treap_ins <span class="quoted">"2.prems"</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">k1</span>›</span></span> ins <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p1</span> <span class="main">≤</span> <span class="skolem">p2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">k1</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> treap_of_set_tree_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">A</span><span class="main">;</span> inj_on fst <span class="free">A</span><span class="main">;</span> inj_on snd <span class="free">A</span> <span class="main">⟧</span>
  <span class="main">⟹</span> set_tree <span class="main">(</span>treap_of <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> treap_of.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"infinite <span class="skolem">A</span> <span class="main">∨</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"infinite <span class="skolem">A</span> <span class="main">∨</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_of.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_inf_or_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>infinite <span class="skolem">A</span> <span class="main">∨</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"arg_min_on snd <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="var">?m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&gt;</span> fst <span class="var">?m</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"treap_of <span class="skolem">A</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_inf_or_empty
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"treap_of <span class="skolem">A</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> treap_of.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on fst <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
                 <span class="quoted"><span class="quoted">"inj_on snd <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
                 <span class="quoted"><span class="quoted">"inj_on fst <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="bound">p</span><span class="main">}</span>"</span></span>
                 <span class="quoted"><span class="quoted">"inj_on snd <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="bound">p</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_on_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> lr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> treap_of <span class="var">?L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> treap_of <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> treap_of.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">l</span> <span class="main">=</span> <span class="var">?L</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> not_inf_or_empty IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> treap_of <span class="var">?R</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> treap_of.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">r</span> <span class="main">=</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_inf_or_empty IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="var">?m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> treap_of.elims<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">≠</span> arg_min_on snd <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> that not_inf_or_empty arg_min_if_finite<span class="main">(</span>1<span class="main">)</span> inj_on_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span>"</span></span> 
       <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">≠</span> arg_min_on snd <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">using</span></span> le_neq_trans that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arg_min_on snd <span class="skolem">A</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_inf_or_empty arg_min_if_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="var">?m</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?L</span> <span class="main">∪</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> l r a A t <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> treap_of_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="main">(</span>treap_of <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> treap_of.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"infinite <span class="skolem">A</span> <span class="main">∨</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"infinite <span class="skolem">A</span> <span class="main">∨</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_of.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> not_inf_or_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>infinite <span class="skolem">A</span> <span class="main">∨</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"arg_min_on snd <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="var">?m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&gt;</span> fst <span class="var">?m</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"treap_of <span class="skolem">A</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_inf_or_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"treap_of <span class="skolem">A</span>"</span></span><span class="main">)</span>
                                <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> treap_of.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> treap_of <span class="var">?L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> treap_of <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> treap_of.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">l</span> <span class="main">⊆</span> <span class="var">?L</span>"</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">r</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="main">(</span>treap_of <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
            <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> not_inf_or_empty <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">l</span> <span class="main">⊆</span> <span class="var">?L</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">=</span> treap_of <span class="var">?L</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="main">(</span>treap_of <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="bound">p</span><span class="main">}</span><span class="main">)</span>
            <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="main">(</span>arg_min_on snd <span class="skolem">A</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="bound">p</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> not_inf_or_empty <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="skolem">r</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> treap_of <span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="var">?m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> treap_of.elims <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?m</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?L</span> <span class="main">∪</span> <span class="var">?R</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_inf_or_empty arg_min_if_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> treap_treap_of<span class="main">:</span>
  <span class="quoted"><span class="quoted">"treap <span class="main">(</span>treap_of <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> treap_of.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"infinite <span class="skolem">A</span> <span class="main">∨</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_of.simps treap_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"arg_min_on snd <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="var">?m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&gt;</span> fst <span class="var">?m</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"treap_of <span class="skolem">A</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"treap_of <span class="skolem">A</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> treap_of.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> treap_of <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> treap_of.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> treap_l<span class="main">:</span> <span class="quoted"><span class="quoted">"treap <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> l <span class="keyword1"><span class="command">have</span></span> keys_l<span class="main">:</span> <span class="quoted"><span class="quoted">"keys <span class="skolem">l</span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tree.set_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_mono treap_of_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> treap_of <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> treap_of.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> treap_r<span class="main">:</span> <span class="quoted"><span class="quoted">"treap <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> r <span class="keyword1"><span class="command">have</span></span> keys_r<span class="main">:</span> <span class="quoted"><span class="quoted">"keys <span class="skolem">r</span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tree.set_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_mono treap_of_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> prios<span class="main">:</span> <span class="quoted"><span class="quoted">"prios <span class="skolem">l</span> <span class="main">⊆</span> snd <span class="main">`</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"prios <span class="skolem">r</span> <span class="main">⊆</span> snd <span class="main">`</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l r treap_of_subset image_mono <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tree.set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="var">?m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> treap_of.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> prios_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> prios <span class="skolem">l</span> <span class="main">⟹</span> snd <span class="skolem">a</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ prios<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> arg_min_least a False <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">fast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> prios_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> prios <span class="skolem">r</span> <span class="main">⟹</span> snd <span class="skolem">a</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ prios<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> arg_min_least a False <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">fast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> prios_r prios_l treap_l treap_r keys_l keys_r a 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t treap_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ keys_l<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ keys_r<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> treap_Leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"treap <span class="main">⟨⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_ins_treap<span class="main">:</span> <span class="quoted"><span class="quoted">"treap <span class="free">t</span> <span class="main">⟹</span> treap <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> ins <span class="bound">x</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">)</span> <span class="free">t</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> treap_ins <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_ins_set_tree<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on fst <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on snd <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span> <span class="main">∩</span> keys <span class="free">t</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_tree <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> ins <span class="bound">x</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">)</span> <span class="free">t</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">ys</span> <span class="main">∪</span> set_tree <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta' set_tree_ins_eq keys_ins<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_ins_treap_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on fst <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on snd <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t'</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> ins <span class="bound">x</span> <span class="bound">p</span> <span class="bound">t'</span><span class="main">)</span> Leaf <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> treap_of <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> treap_unique<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> treap_Leaf foldl_ins_treap foldl_ins_set_tree 
                                                  treap_treap_of treap_of_set_tree_unique<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Random_List_Permutation">
<div class="head">
<h1>Theory Random_List_Permutation</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:      Random_List.thy
  Authors:   Manuel Eberl

  Some facts about randomly permuted lists and how to obtain them by drawing i.i.d.
  priorities for every element.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Randomly-permuted lists›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Random_List_Permutation
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Probability_Misc.html">Probability_Misc</a>
  <a href="../Comparison_Sort_Lower_Bound/Linorder_Relations.html">Comparison_Sort_Lower_Bound.Linorder_Relations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General facts about linear orderings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define the set of all linear orderings on a given set and show some properties about it.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">linorders_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">linorders_on</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">R</span><span class="main">.</span> linorder_on <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">R</span><span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> linorders_on_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"linorders_on <span class="main">{}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def linorder_on_def refl_on_def<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> linorders_finite_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorders_on <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> finite_distinct_list<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="main">(</span>linorder_of_list <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  There is an obvious bijection between permutations of a set (i.\,e.\ lists with all elements
  from that set without repetition) and linear orderings on it.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bij_betw_linorders_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bij_betw linorder_of_list <span class="main">(</span>permutations_of_set <span class="free">A</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_betw_linorder_of_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> linorders_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_list_of_set_linorder_of_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sorted_wrt_list_of_set <span class="main">(</span>linorder_of_list <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sorted_wrt_list_of_set_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"set <span class="free"><span class="free"><span class="free">xs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> linorder_of_list_sorted_wrt_list_of_set <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_of_list <span class="main">(</span>sorted_wrt_list_of_set <span class="free">R</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">×</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> subset <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_of_list_def linorder_sorted_wrt_list_of_set sorted_wrt_linorder_index_le_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bij_betw_linorders_on'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> sorted_wrt_list_of_set <span class="bound">R</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span> <span class="main">(</span>permutations_of_set <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_byWitness<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">linorder_of_list</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def permutations_of_set_def
        linorder_sorted_wrt_list_of_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_linorders_on <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>permutations_of_set <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> finite <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_finite <span class="main"><span class="main">[</span></span><span class="operator">OF</span> bij_betw_linorders_on<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we look at the ordering defined by a list that is permuted with some permutation
  function. For this, we first define the composition of a relation with a function.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_relation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_relation</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">x</span></span><span class="main">,</span><span class="bound"><span class="bound">y</span></span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">×</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> index_distinct_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> index_permute_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"index <span class="main">(</span>permute_list <span class="free">π</span> <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> inv <span class="free">π</span> <span class="main">(</span>index <span class="free">xs</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="free">π</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_inv<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms permutes_in_image<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> index_distinct_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_list_nth permutes_inverses<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> linorder_of_list_permute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_of_list <span class="main">(</span>permute_list <span class="free">π</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
             map_relation <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">(!)</span> <span class="free">xs</span> <span class="main">∘</span> inv <span class="free">π</span> <span class="main">∘</span> index <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>linorder_of_list <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> permutes_inv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="free">π</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> permutes_in_image<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_of_list_def map_relation_def index_nth_id index_permute_list less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> inj_on_conv_Ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">.</span> <span class="main">∃!</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bij_betw_conv_Ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="main">∃!</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def inj_on_conv_Ex1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permutesI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> permutes_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ex1I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now show the important lemma that any two linear orderings on a finite set can be
  mapped onto each other by a permutation.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> linorder_permutation_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">=</span> map_relation <span class="free">A</span> <span class="free">π</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> sorted_wrt_list_of_set <span class="free">R</span> <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> sorted_wrt_list_of_set <span class="free">R'</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> xs_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_sorted_wrt_list_of_set xs_def ys_def<span class="main">)</span>
      
  <span class="keyword1"><span class="command">from</span></span> xs_ys <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">ys</span> <span class="main">=</span> mset <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff_mset_eq_distinct <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mset_eq_permutation<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> π <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">note</span></span> π <span class="main">=</span> this
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="skolem">xs</span> <span class="main">!</span> inv <span class="skolem">π</span> <span class="main">(</span>index <span class="skolem">xs</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> π'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> permutesI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(!)</span> <span class="skolem">xs</span> <span class="main">∘</span> inv <span class="skolem">π</span><span class="main">)</span> <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_trans permutes_imp_bij permutes_inv π bij_betw_nth<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs_ys<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(!)</span> <span class="skolem">xs</span> <span class="main">∘</span> inv <span class="skolem">π</span> <span class="main">∘</span> index <span class="skolem">xs</span><span class="main">)</span> <span class="free">A</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_trans <span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> bij_betw_index<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="main">(</span><span class="operator">insert</span> bij_betw_index<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">xs</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs_ys atLeast0LessThan<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(!)</span> <span class="skolem">xs</span> <span class="main">∘</span> inv <span class="skolem">π</span> <span class="main">∘</span> index <span class="skolem">xs</span><span class="main">)</span> <span class="free">A</span> <span class="free">A</span> <span class="main">⟷</span> bij_betw <span class="skolem">π'</span> <span class="free">A</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> π'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π'_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">=</span> linorder_of_list <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ys_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> π <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> permute_list <span class="skolem">π</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linorder_of_list <span class="main">(</span>permute_list <span class="skolem">π</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> 
               map_relation <span class="free">A</span> <span class="main">(</span><span class="main">(!)</span> <span class="skolem">xs</span> <span class="main">∘</span> inv <span class="skolem">π</span> <span class="main">∘</span> index <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>linorder_of_list <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> π <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> linorder_of_list_permute<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs_ys<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linorder_of_list <span class="skolem">xs</span> <span class="main">=</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">=</span> map_relation <span class="free">A</span> <span class="main">(</span><span class="main">(!)</span> <span class="skolem">xs</span> <span class="main">∘</span> inv <span class="skolem">π</span> <span class="main">∘</span> index <span class="skolem">xs</span><span class="main">)</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_relation <span class="free">A</span> <span class="skolem">π'</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_relation_def π'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> π' <span class="keyword2"><span class="keyword">and</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">π'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the linear ordering defined by some priority function, i.\,e.\ a function
  that injectively associates priorities to every element such that elements with lower priority
  are smaller in the resulting ordering.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">linorder_from_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">linorder_from_keys</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">x</span></span><span class="main">,</span><span class="bound"><span class="bound">y</span></span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">×</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> linorder_from_keys_permute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_from_keys <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> map_relation <span class="free">A</span> <span class="free">g</span> <span class="main">(</span>linorder_from_keys <span class="free">A</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> permutes_in_image<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_relation_def linorder_from_keys_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> linorder_on_linorder_from_keys <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="main">(</span>linorder_from_keys <span class="free">A</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def refl_on_def antisym_def linorder_from_keys_def
                    trans_def total_on_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> linorder_from_keys_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"linorder_from_keys <span class="main">{}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_from_keys_def fun_eq_iff<span class="main">)</span>
    

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now show another important fact, namely that when we draw $n$ values i.\,i.\,d.\ uniformly
  from a non-trivial real interval, we almost surely get distinct values.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> emeasure_PiM_diagonal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">h</span></span><span class="main">∈</span><span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> UNIV<span class="main">.</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"prob_space <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prob_space_uniform_measure<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> product_prob_space <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="free">A</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> product_prob_space_def product_prob_space_axioms_def product_sigma_finite_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prob_space_imp_sigma_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> M <span class="keyword1"><span class="command">interpret</span></span> pair_sigma_finite <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">M</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">h</span></span><span class="main">∈</span>extensional <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">h</span></span><span class="main">∈</span>extensional <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">h</span></span> <span class="main">∈</span> space <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extensional_def space_PiM<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">∈</span> sets <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>PiM <span class="skolem">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>PiM <span class="skolem">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sets_PiM_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sets_M_M<span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>borel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sets_pair_measure_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> measurable_split_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_cong_sets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sets_M_M refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_If measurable_const measurable_equality_set<span class="main">)</span>
      
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">h</span></span><span class="main">∈</span><span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> UNIV<span class="main">.</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="bound"><span class="bound">h</span></span><span class="main">∈</span>extensional <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span><span class="main">}</span> <span class="main">∩</span> space <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span> <span class="main">::</span> real measure<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_PiM PiE_def extensional_def M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">…</span> <span class="main">=</span> 
               emeasure <span class="main">(</span>distr <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PiM <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel <span class="main">::</span> real measure<span class="main">)</span><span class="main">)</span> 
                 <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">h</span></span><span class="main">∈</span>extensional <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_distr <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_restrict_subset<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sets_PiM_cong measurable_cong_sets refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">h</span></span><span class="main">∈</span>extensional <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PiM <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel <span class="main">::</span> real measure<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
               distr <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PiM <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> restrict <span class="bound">h</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong refl sets_PiM_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_restrict <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">…</span> <span class="main">{</span><span class="bound"><span class="bound">h</span></span><span class="main">∈</span>extensional <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span>
    nn_integral <span class="main">…</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> indicator <span class="main">{</span><span class="bound"><span class="bound">h</span></span><span class="main">∈</span>extensional <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span><span class="main">}</span> <span class="bound">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_indicator <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nn_integral <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">h</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def space_PiM PiE_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="bound">z</span> <span class="main">=</span> snd <span class="bound">z</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">∂</span><span class="main">(</span><span class="free">M</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> product_nn_integral_pair<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> M.nn_integral_fst <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">y</span><span class="main">.</span> indicator <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="bound">y</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def eq_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_indicator<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong_AE refl AE_uniform_measureI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>      

<span class="keyword1"><span class="command">lemma</span></span> measurable_linorder_from_keys_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"linorder_from_keys <span class="free">A</span> <span class="main">∈</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> borel <span class="main">::</span> real measure<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">:</span> <span class="var">?M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> measurable_count_space_eq2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fin linorder_from_keys_def<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> fin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">×</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linorder_from_keys <span class="free">A</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">R</span><span class="main">}</span> <span class="main">∩</span> space <span class="var">?M</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">f</span></span> <span class="main">∈</span> space <span class="var">?M</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span> <span class="main">⟷</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">f</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorder_from_keys_def set_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> sets <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linorder_from_keys <span class="free">A</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">R</span><span class="main">}</span> <span class="main">∩</span> space <span class="var">?M</span> <span class="main">∈</span> sets <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_count_space_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_space <span class="free">A</span> <span class="main">=</span> restrict_space <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> restrict_count_space<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measurable_restrict_space2_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> measurable_linorder_from_keys_restrict'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"linorder_from_keys <span class="free">A</span> <span class="main">∈</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> borel <span class="main">::</span> real measure<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_count_space_extend<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measurable_linorder_from_keys_restrict<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">M</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> distr <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> 
                  <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorder_from_keys <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_linorder_from_keys <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"linorder_from_keys <span class="free">A</span> <span class="main">∈</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> borel <span class="main">::</span> real measure<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_linorder_from_keys_restrict'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fin B<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The ordering defined by randomly-chosen priorities is almost surely linear:
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> almost_everywhere_linorder<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">R</span> <span class="keyword1">in</span> <span class="free">M</span><span class="main">.</span> linorder_on <span class="free">A</span> <span class="bound">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sets_PiM_cong<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M_A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel <span class="main">::</span> real measure<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">h</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> UNIV<span class="main">.</span> <span class="bound">h</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">h</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">∈</span> sets <span class="var">?M_A</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">h</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> UNIV<span class="main">.</span> <span class="bound">h</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">h</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">h</span></span> <span class="main">∈</span> space <span class="var">?M_A</span><span class="main">.</span> <span class="bound">h</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">h</span> <span class="skolem">j</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_PiM<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">∈</span> sets <span class="var">?M_A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">h</span></span><span class="main">∈</span><span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> UNIV<span class="main">.</span> <span class="bound">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">h</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> <span class="skolem">N</span><span class="main">.</span> inj_on <span class="bound">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AE_I<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">f</span></span> <span class="main">∈</span> space <span class="skolem">N</span><span class="main">.</span> <span class="main">¬</span> inj_on <span class="bound">f</span> <span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def X_def space_PiM N_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def N_def
      <span class="keyword1"><span class="command">using</span></span> meas <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> countable_finite fin sets.countable_UN'<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="skolem">N</span> <span class="skolem">X</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> emeasure <span class="skolem">N</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">h</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> UNIV<span class="main">.</span> <span class="bound">h</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">h</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> X_def N_def <span class="keyword1"><span class="command">using</span></span> fin meas
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_subadditive_finite<span class="main">)</span> 
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_family_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sets.countable_UN' countable_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="bound">i</span><span class="main">}</span><span class="main">.</span> emeasure <span class="skolem">N</span> <span class="main">{</span><span class="bound"><span class="bound">h</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> UNIV<span class="main">.</span> <span class="bound">h</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">h</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">using</span></span> fin meas
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_subadditive_finite sum_mono<span class="main">)</span> 
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_family_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sets.countable_UN' countable_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">A</span><span class="main">-</span><span class="main">{</span><span class="bound">i</span><span class="main">}</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">using</span></span> fin ab
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl emeasure_PiM_diagonal<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="skolem">N</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> <span class="skolem">N</span><span class="main">.</span> linorder_on <span class="free">A</span> <span class="main">(</span>linorder_from_keys <span class="free">A</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def N_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> AE_distr_iff<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Furthermore, this is equivalent to choosing one of the $|A|!$ linear orderings uniformly
  at random.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> random_linorder_by_prios<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> uniform_measure <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> linorders_finite_nonempty<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R</span><span class="main">}</span> <span class="main">≤</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="skolem">R'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">R</span> <span class="skolem">R'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> linorder_permutation_exists<span class="main">[</span><span class="operator">OF</span> fin that<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> π<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="keyword1">permutes</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">=</span> map_relation <span class="free">A</span> <span class="skolem">π</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">∈</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel <span class="main">::</span> real measure<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel <span class="main">::</span> real measure<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_PiM_single' measurable_PiM_component_rev
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def permutes_in_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> π<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> space_PiM PiE_def extensional_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">N</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cong_sets refl sets_PiM_cong<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">∈</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>    
        
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="skolem">N</span> <span class="skolem">X</span> <span class="main">=</span> measurable <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set measure"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_cong_sets refl sets_PiM_cong<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"measurable <span class="free">M</span> <span class="skolem">X</span> <span class="main">=</span> measurable <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set measure"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      
    <span class="keyword1"><span class="command">have</span></span> M_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> distr <span class="skolem">N</span> <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorder_from_keys <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> M_def N_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> distr <span class="skolem">N</span> <span class="main">(</span>PiM <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> PiM_uniform_measure_permute <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">…</span> <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorder_from_keys <span class="free">A</span><span class="main">)</span> <span class="main">=</span> 
                 distr <span class="skolem">N</span> <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorder_from_keys <span class="free">A</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> <span class="skolem">π</span><span class="main">)</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_distr<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="skolem">N</span> <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_relation <span class="free">A</span> <span class="skolem">π</span> <span class="main">∘</span> linorder_from_keys <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_from_keys_permute<span class="main"><span class="main">[</span></span><span class="operator">OF</span> π<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="free">M</span> <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_relation <span class="free">A</span> <span class="skolem">π</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M_eq <span class="keyword1"><span class="command">using</span></span> B
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_distr <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_relation_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> M_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"distr <span class="free">M</span> <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_relation <span class="free">A</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> subset'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">×</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">×</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder_on_def refl_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R</span><span class="main">}</span> <span class="main">≤</span> emeasure <span class="free">M</span> <span class="main">(</span>map_relation <span class="free">A</span> <span class="skolem">π</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">R'</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subset' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def π <span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="main">(</span>distr <span class="free">M</span> <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_relation <span class="free">A</span> <span class="skolem">π</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="skolem">R'</span><span class="main">}</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_distr <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> subset' B<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_relation_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> M_eq'
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> same_prob<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R'</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="free">A</span> <span class="skolem">R'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">R'</span>
    <span class="keyword1"><span class="command">using</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">R</span></span> <span class="quoted"><span class="skolem">R'</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">R'</span></span> <span class="quoted"><span class="skolem">R</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> R <span class="keyword2"><span class="keyword">and</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">from</span></span> ab <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob_space <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prob_space.prob_space_distr prob_space_PiM prob_space_uniform_measure<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> prob_space.emeasure_space_1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prob_space <span class="free">M</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> linorders_on <span class="free">A</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">-</span>linorders_on <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def linorder_on_def refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">…</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span> <span class="main">+</span> emeasure <span class="free">M</span> <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">-</span>linorders_on <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> plus_emeasure<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def linorders_on_def linorder_on_def refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">-</span>linorders_on <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> almost_everywhere_linorder 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> AE_iff_measurable<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">R'</span><span class="main">∈</span>linorders_on <span class="free">A</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound">R'</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_eq_sum_singleton<span class="main">)</span> 
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def  linorders_on_def linorder_on_def refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">R'</span><span class="main">∈</span>linorders_on <span class="free">A</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorders_on_def same_prob<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fact <span class="main">(</span>card <span class="free">A</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorders_on_def card_finite_linorders<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R</span><span class="main">}</span> <span class="main">=</span> inverse <span class="main">(</span>fact <span class="main">(</span>card <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inverse_ennreal_unique<span class="main">)</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI_countable_AE'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> Pow <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"countable <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> countable_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">R</span> <span class="keyword1">in</span> uniform_measure <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
            <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">R</span> <span class="main">∈</span> linorders_on <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> AE_uniform_measureI<span class="main">)</span> 
         <span class="main">(</span><span class="operator">insert</span> B<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def linorder_on_def refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R'</span> <span class="keyword3"><span class="command">assume</span></span> R'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">∈</span> linorders_on <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"linorders_on <span class="free">A</span> <span class="main">⊆</span> Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def linorder_on_def refl_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>uniform_measure <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
           <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="skolem">R'</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">R'</span><span class="main">}</span><span class="main">)</span> <span class="main">/</span>
                                      emeasure <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R' B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_uniform_measure<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def linorder_on_def refl_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> emeasure <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R' B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_count_space<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def linorder_on_def refl_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> fact <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fin finite_linorders_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_count_space <span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> divide_ennreal <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> linorders_on_def card_finite_linorders<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> divide_ennreal_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R'</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> same_prob <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="skolem">R'</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="main">(</span>uniform_measure <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                    <span class="main">(</span>linorders_on <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="skolem">R'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linorders_on <span class="free">A</span> <span class="main">⊆</span> Pow <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorders_on_def linorder_on_def refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def linorders_on_def almost_everywhere_linorder<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Treap_Sort_and_BSTs">
<div class="head">
<h1>Theory Treap_Sort_and_BSTs</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:      Treap_Sort_and_BSTs.thy
  Authors:   Max Haslbeck
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relationship between treaps and BSTs›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Treap_Sort_and_BSTs
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Treap.html">Treap</a>
  <a href="Random_List_Permutation.html">Random_List_Permutation</a>
  <span class="quoted">"<a href="../Random_BSTs/Random_BSTs.html">Random_BSTs.Random_BSTs</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here, we will show that if we ``forget'' the priorities of a treap, we essentially get a
  BST into which the elements have been inserted by ascending priority.

  First, we show some facts about sorting that we will need.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following two lemmas are only important for measurability later.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> insort_key_conv_rec_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"insort_key <span class="free">f</span> <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span>
     rec_list <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="keyword1">else</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> insort_key_conv_rec_list'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"insort_key <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span>
     rec_list <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">f</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="keyword1">else</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insort_key_conv_rec_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bst_of_list_trees<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bst_of_list <span class="free">ys</span> <span class="main">∈</span> trees <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bst_of_list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> insort_wrt_insort_key<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span>
   set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span>
   insert_wrt <span class="main">(</span>linorder_from_keys <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> insort_key <span class="free">f</span> <span class="free">a</span> <span class="free">xs</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> linorder_from_keys_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insort_wrt_sort_key<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insort_wrt <span class="main">(</span>linorder_from_keys <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> sort_key <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insort_wrt_def insort_wrt_insort_key<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following is an important recurrence for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"sort_key"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that states that for distinct
  priorities, sorting a list w.\,r.\,t.\ those priorities can be seen as selection sort, i.\,e.\ 
  we can first choose the (unique) element with minimum priority as the first element and then
  sort the rest of the list and append it.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sort_key_arg_min_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>  <span class="quoted"><span class="quoted">"inj_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sort_key <span class="free">p</span> <span class="main">(</span><span class="free">zs</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder list<span class="main">)</span> <span class="main">=</span> 
         <span class="main">(</span><span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span> <span class="keyword1">in</span> <span class="bound">z</span> <span class="main">#</span> sort_key <span class="free">p</span> <span class="main">(</span>remove1 <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">zs</span> <span class="main">=</span> mset <span class="main">(</span><span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span> <span class="keyword1">in</span> <span class="bound">z</span> <span class="main">#</span> sort_key <span class="free">p</span> <span class="main">(</span>remove1 <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_min_if_finite<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linorder_class.sorted
                 <span class="main">(</span>map <span class="free">p</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span> <span class="keyword1">in</span> <span class="bound">z</span> <span class="main">#</span> sort_key <span class="free">p</span> <span class="main">(</span>remove1 <span class="bound">z</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="free">p</span> <span class="main">(</span>sort_key <span class="free">p</span> <span class="main">(</span>remove1 <span class="main">(</span>arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">p</span> <span class="main">`</span> set <span class="free">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_remove1_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">`</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">(</span>arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> arg_min_least assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linorder_class.sorted
        <span class="main">(</span><span class="free">p</span> <span class="main">(</span>arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> map <span class="free">p</span> <span class="main">(</span>sort_key <span class="free">p</span> <span class="main">(</span>remove1 <span class="main">(</span>arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sort_key_inj_key_eq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arg_min_on_image_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">::</span> linorder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"arg_min_on <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span>arg_min_on <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> arg_min_if_finite<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹finite <span class="free"><span class="free">B</span></span>›</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">B</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">{}</span></span>›</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">f</span></span> <span class="main"><span class="main">∘</span></span> <span class="free"><span class="free">g</span></span>›</span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms * arg_min_inj_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> arg_min_if_finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> arg_min_least 
        comp_apply finite_imageI imageE image_eqI image_is_empty inj_onD less_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fst_snd_arg_min_on<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">p</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="main">(</span>arg_min_on snd <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> arg_min_on <span class="free">p</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> arg_min_on_image_finite <span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_on_imageI<span class="main"><span class="main">]</span></span><span class="main">)</span> 
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def assms<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following is now the main result:
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> treap_of_bst_of_list'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">p</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> sort_key <span class="free">p</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_tree fst <span class="main">(</span>treap_of <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bst_of_list <span class="free">xs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bst_of_list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">=</span> sort_key <span class="free">p</span> <span class="skolem">xs</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_of.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 2<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> assms <span class="main">=</span> 2<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> arg_min_on snd <span class="main">(</span>set <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">z</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">z</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&lt;</span> fst <span class="skolem">m</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">&gt;</span> fst <span class="skolem">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">p</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> set <span class="skolem">zs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">z</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">p</span> <span class="main">(</span>set <span class="main">(</span>filter <span class="main">(</span><span class="main">(&lt;)</span> <span class="skolem">z</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"inj_on <span class="free">p</span> <span class="main">(</span>set <span class="skolem">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">p</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_on_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">in</span> <span class="bound">z</span> <span class="main">#</span> sort_key <span class="free">p</span> <span class="main">(</span>remove1 <span class="bound">z</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sort_key_arg_min_on<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> sort_key <span class="free">p</span> <span class="main">(</span>remove1 <span class="skolem">z</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"sort_key <span class="free">p</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linorder_class.sorted <span class="main">(</span>map <span class="free">p</span> <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linorder_class.sorted <span class="main">(</span>map <span class="free">p</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> h1 h2 sort_key_inj_key_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> helpers <span class="main">=</span> h1 h2 h3 h4
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">m</span> <span class="main">=</span> arg_min_on <span class="free">p</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fst_snd_arg_min_on<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> helpers <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_tree fst <span class="main">(</span>treap_of <span class="skolem">L</span><span class="main">)</span> <span class="main">=</span> bst_of_list <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">z</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> set <span class="skolem">ls</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> L_def ls_def <span class="quoted"><span class="quoted">‹fst <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> helpers assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_tree fst <span class="main">(</span>treap_of <span class="main">(</span>set <span class="skolem">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bst_of_list <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">z</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ls_def <span class="keyword1"><span class="command">using</span></span> helpers 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">←</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">zs</span></span></span> <span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span> <span class="main"><span class="main"><span class="main">&lt;</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">z</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_sort<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_tree fst <span class="main">(</span>treap_of <span class="skolem">R</span><span class="main">)</span> <span class="main">=</span> bst_of_list <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="skolem">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> set <span class="skolem">rs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> R_def rs_def <span class="quoted"><span class="quoted">‹fst <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> helpers assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_tree fst <span class="main">(</span>treap_of <span class="main">(</span>set <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bst_of_list <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="skolem">z</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rs_def <span class="keyword1"><span class="command">using</span></span> helpers
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">←</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">zs</span></span></span> <span class="main"><span class="main"><span class="main">.</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">z</span></span></span> <span class="main"><span class="main"><span class="main">&lt;</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_sort<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"treap_of <span class="main">(</span>set <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>treap_of <span class="skolem">L</span><span class="main">,</span> <span class="skolem">m</span><span class="main">,</span> treap_of <span class="skolem">R</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_def m_def R_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_of.simps Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> treap_of_bst_of_list<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span>
   map_tree fst <span class="main">(</span>treap_of <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bst_of_list <span class="main">(</span>sort_key <span class="free">p</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> treap_of_bst_of_list' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> treap_of_bst_of_list''<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span>
   map_tree fst <span class="main">(</span>treap_of <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bst_of_list <span class="main">(</span>sort_key <span class="free">p</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> treap_of_bst_of_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> fold_ins_bst_of_list<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">zs</span> <span class="main">⟹</span> inj_on <span class="free">p</span> <span class="main">(</span>set <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span>
   map_tree fst <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> ins <span class="bound">x</span> <span class="bound">p</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟨⟩</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bst_of_list <span class="main">(</span>sort_key <span class="free">p</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_ins_treap_of distinct_map inj_on_def inj_on_convol_ident
                     treap_of_bst_of_list''<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Random_Treap">
<div class="head">
<h1>Theory Random_Treap</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:      Random_Treap.thy
  Authors:   Max Haslbeck
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Random treaps›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Random_Treap
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Probability_Misc.html">Probability_Misc</a>
  <a href="Treap_Sort_and_BSTs.html">Treap_Sort_and_BSTs</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Measurability›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemmas are only relevant for measurability.
›</span></span>

<span class="comment1">(* TODO Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> tree_sigma_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sets <span class="free">M</span> <span class="main">=</span> sets <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"tree_sigma <span class="free">M</span> <span class="main">=</span> tree_sigma <span class="free">M'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sets_eq_imp_space_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tree_sigma_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distr_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sets <span class="free">N</span> <span class="main">=</span> sets <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"sets <span class="free">K</span> <span class="main">⊆</span> sets <span class="free">M</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> sets <span class="free">K</span> <span class="main">⟹</span> emeasure <span class="free">M</span> <span class="bound">X</span> <span class="main">=</span> emeasure <span class="free">K</span> <span class="bound">X</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> sets <span class="free">M</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">⊆</span> space <span class="free">M</span> <span class="main">-</span> space <span class="free">K</span> <span class="main">⟹</span> emeasure <span class="free">M</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">K</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"distr <span class="free">M</span> <span class="free">N</span> <span class="free">f</span> <span class="main">=</span> distr <span class="free">K</span> <span class="free">L</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>distr <span class="free">M</span> <span class="free">N</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">=</span> emeasure <span class="main">(</span>distr <span class="free">K</span> <span class="free">L</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_distr_restrict assms<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="comment1">(* END TODO *)</span>

<span class="keyword1"><span class="command">lemma</span></span> sets_tree_sigma_count_space<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"countable <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sets <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Pow <span class="main">(</span>trees <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> Pow <span class="main">(</span>trees <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">t</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> trees <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">l</span> <span class="skolem">r</span> <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">⟨</span><span class="bound">la</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">ra</span><span class="main">⟩</span> <span class="main">|</span><span class="bound">la</span> <span class="bound">v</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">la</span><span class="main">,</span> <span class="bound">ra</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">l</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">r</span><span class="main">}</span><span class="main">}</span>
               <span class="main">∈</span> sets <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Node_in_tree_sigma pair_measureI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sets.countable_UN' countable_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ countable_trees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> <span class="main">{</span><span class="bound">t</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> sets <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> sets.sets_into_space<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> Pow <span class="main">(</span>trees <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_tree_sigma<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> height_primrec<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="main">=</span> rec_tree <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> Suc <span class="main">(</span>max <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">t</span> <span class="main">=</span> rec_tree <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> Suc <span class="main">(</span>max <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipl_primrec<span class="main">:</span> <span class="quoted"><span class="quoted">"ipl <span class="main">=</span> rec_tree <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="main"><span class="bound">_</span></span> <span class="bound">r</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> size <span class="bound">l</span> <span class="main">+</span> size <span class="bound">r</span> <span class="main">+</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipl <span class="skolem">t</span> <span class="main">=</span> rec_tree <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="main"><span class="bound">_</span></span> <span class="bound">r</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> size <span class="bound">l</span> <span class="main">+</span> size <span class="bound">r</span> <span class="main">+</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_primrec<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">=</span> rec_tree <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">t</span> <span class="main">=</span> rec_tree <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipl_map_tree<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ipl <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ipl <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_pmf_random_bst<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> set_pmf <span class="main">(</span>random_bst <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> trees <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> random_bst_altdef<span class="main">)</span> 
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bst_of_list_trees <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bst_of_list_trees permutations_of_setD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trees_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> trees <span class="free">A</span> <span class="main">⊆</span> trees <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> trees <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> trees <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ins_primrec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ins <span class="free">k</span> <span class="main">(</span><span class="free">p</span><span class="main">::</span>real<span class="main">)</span> <span class="free">t</span> <span class="main">=</span> rec_tree 
    <span class="main">(</span>Node Leaf <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> Leaf<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">z</span> <span class="bound">r</span> <span class="bound">l'</span> <span class="bound">r'</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">z</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">k1</span><span class="main">,</span> <span class="bound">p1</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="bound">k1</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="bound">l'</span> <span class="keyword1">of</span>
          Leaf <span class="main">⇒</span> Leaf
        <span class="main">|</span> Node <span class="bound">l2</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span> <span class="bound">r2</span> <span class="main">⇒</span> 
            <span class="keyword1">if</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">p2</span> <span class="main">-</span> <span class="bound">p1</span> <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="bound">l2</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">(</span><span class="bound">k1</span><span class="main">,</span><span class="bound">p1</span><span class="main">)</span> <span class="bound">r</span>
            <span class="keyword1">else</span> Node <span class="bound">l2</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span> <span class="main">(</span>Node <span class="bound">r2</span> <span class="main">(</span><span class="bound">k1</span><span class="main">,</span><span class="bound">p1</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="bound">k1</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="bound">r'</span> <span class="keyword1">of</span>
          Leaf <span class="main">⇒</span> Leaf
        <span class="main">|</span> Node <span class="bound">l2</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span> <span class="bound">r2</span> <span class="main">⇒</span>
            <span class="keyword1">if</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">p2</span> <span class="main">-</span> <span class="bound">p1</span> <span class="keyword1">then</span> Node <span class="bound">l</span> <span class="main">(</span><span class="bound">k1</span><span class="main">,</span><span class="bound">p1</span><span class="main">)</span> <span class="main">(</span>Node <span class="bound">l2</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span>
            <span class="keyword1">else</span> Node <span class="main">(</span>Node <span class="bound">l</span> <span class="main">(</span><span class="bound">k1</span><span class="main">,</span><span class="bound">p1</span><span class="main">)</span> <span class="bound">l2</span><span class="main">)</span> <span class="main">(</span><span class="bound">k2</span><span class="main">,</span><span class="bound">p2</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span>
      <span class="keyword1">else</span> Node <span class="bound">l</span> <span class="main">(</span><span class="bound">k1</span><span class="main">,</span><span class="bound">p1</span><span class="main">)</span> <span class="bound">r</span>
      <span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">l</span> <span class="skolem">k1</span> <span class="skolem">p1</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta ins_neq_Leaf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_less_count_space <span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"countable <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">B</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="main">(</span>count_space <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&lt;</span> snd <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_space <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_measure_countable<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Measurable.pred <span class="free">B</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&lt;</span> snd <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">,</span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_ins <span class="main">[</span><span class="operator">measurable</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">raw</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"countable <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>lborel <span class="main">::</span> real measure<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> ins <span class="main">(</span><span class="free">k</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">B</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ins_primrec <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1"><span class="command">lemma</span></span> map_tree_primrec<span class="main">:</span> <span class="quoted"><span class="quoted">"map_tree <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> rec_tree <span class="main">⟨⟩</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="bound">l'</span> <span class="bound">r'</span><span class="main">.</span>  <span class="main">⟨</span><span class="bound">l'</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">𝒰</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒰</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">::</span>real<span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="bound">a</span><span class="main">..</span><span class="bound">b</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> 𝒰_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insR</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> real<span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> real<span class="main">)</span> tree measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insR</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>  <span class="main">=</span> distr <span class="main">(</span>𝒰 <span class="main">0</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ins <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rinss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> real<span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> real<span class="main">)</span> tree measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rinss</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span>  return <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rinss</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> insR <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">rinss</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sets_rinss'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"countable <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> trees <span class="main">(</span><span class="free">B</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">⟹</span> sets <span class="main">(</span>rinss <span class="free">ys</span> <span class="free">t</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> sets <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">B</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rinss.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sets_bind<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_tree_sigma space_pair_measure<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_foldl <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> space <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free">g</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> foldl <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span> <span class="main">=</span> Cons.prems<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free">g</span> <span class="bound">a</span> <span class="bound">b</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_comp<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> Cons.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">g</span> <span class="bound">a</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> foldl <span class="main">(</span><span class="free">g</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">xa</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">xa</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> Cons.prems <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ins_trees<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> trees <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> ins <span class="free">x</span> <span class="free">y</span> <span class="free">t</span> <span class="main">∈</span> trees <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ins.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins_neq_Leaf<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main result›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In our setting, we have some countable set of values that may appear in the input and
  a concrete list consisting only of those elements with no repeated elements.

  We further define an abbreviation for the uniform distribution of permutations of that lists.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">random_perm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list measure"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> con_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"countable <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">random_perm</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> uniform_measure <span class="main">(</span>count_space <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                 <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Again, we first need some facts about measurability.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sets_rinss <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> trees <span class="main">(</span><span class="free">A</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sets <span class="main">(</span>rinss <span class="free">xs</span> <span class="free">t</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>lborel<span class="main">::</span>real measure<span class="main">)</span><span class="main">)</span> <span class="main">=</span> tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> tree_sigma_cong sets_pair_measure_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms con_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sets_rinss'<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bst_of_list_measurable <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bst_of_list <span class="main">∈</span> measurable <span class="main">(</span>count_space <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> measurable_count_space_eq1<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_tree_sigma <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bst_of_list_trees<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insort_wrt_measurable <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> insort_wrt <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bst_of_list_sort_meaurable <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bst_of_list <span class="main">(</span>sort_key <span class="bound">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> 
     Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> borel<span class="main">::</span>real measure<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> measurable_linorder_from_keys_restrict'<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> bst_of_list <span class="main">(</span>insort_wrt <span class="main">(</span>linorder_from_keys <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">∈</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> borel <span class="main">::</span> real measure<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> insort_wrt_sort_key<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">measurable</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In a first step, we convert the bulk insertion operation to first choosing the
  priorities i.\,i.\,d.\ ahead of time and then inserting all the elements deterministically
  with their associated priority.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> random_treap_fold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> space <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rinss <span class="free">xs</span> <span class="free">t</span> <span class="free">A</span> <span class="main">=</span> distr <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> 𝒰 <span class="main">0</span> <span class="main">1</span><span class="main">)</span>
                              <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span>
                              <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"uniform_measure lborel <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> space <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="skolem">c</span> <span class="main">∈</span> space <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="skolem">t</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span>
    Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> space <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
   <span class="keyword1"><span class="command">using</span></span> that con_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">have</span></span> insR'<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"insR <span class="skolem">x</span> <span class="skolem">t</span> <span class="free">A</span> <span class="main">=</span> <span class="var">?U</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> return <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="bound">u</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> space <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> con_assms assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_return_distr' 𝒰_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rinss <span class="free">xs</span> <span class="free">t</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span> <span class="main">⤜</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> return <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con_assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measure_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_PiM_empty emeasure_distr bind_return_distr'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> insR.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?treap_sigma</span></span></span>  <span class="main">=</span> <span class="quoted"><span class="quoted">"tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> space <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
                     <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="skolem">c</span> <span class="main">∈</span> space <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="skolem">k</span> <span class="skolem">p</span> <span class="skolem">t</span> <span class="main">∈</span> space <span class="var">?treap_sigma</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> space <span class="var">?treap_sigma</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">t</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ins_trees <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_tree_sigma space_pair_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>prob_algebra <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> space_prob_algebra <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prob_space_uniform_measure prob_space_PiM<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>subprob_algebra <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> space_subprob_algebra
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prob_space_imp_subprob_space prob_space_uniform_measure prob_space_PiM<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="var">?treap_sigma</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="var">?treap_sigma</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span>
            <span class="main">(</span><span class="var">?treap_sigma</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> borel<span class="main">)</span><span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="var">?treap_sigma</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_ident_sets sets_pair_measure_cong sets_PiM_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒰_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span> <span class="main">⤜</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> return <span class="var">?treap_sigma</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">w</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">∈</span> <span class="var">?treap_sigma</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> subprob_algebra <span class="var">?treap_sigma</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">∈</span> space <span class="main">(</span>prob_algebra <span class="main">(</span><span class="var">?U</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prob_space_uniform_measure space_prob_algebra<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> rinss <span class="skolem">xs</span> <span class="bound">t</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?treap_sigma</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> subprob_algebra <span class="var">?treap_sigma</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="var">?U</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?treap_sigma</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> <span class="var">?U</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> <span class="var">?treap_sigma</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 𝒰_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> distr <span class="main">(</span><span class="var">?U</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ins <span class="skolem">x</span> <span class="bound">p</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∈</span> <span class="var">?treap_sigma</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> subprob_algebra <span class="var">?treap_sigma</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> measurable_prob_algebraD<span class="main">)</span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rinss.simps insR.simps 𝒰_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> return <span class="var">?treap_sigma</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="bound">u</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?U</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> subprob_algebra <span class="var">?treap_sigma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con_assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span><span class="var">?U</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prob_space.not_empty prob_space_PiM prob_space_pair prob_space_uniform_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rinss <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">t</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="var">?U</span> <span class="main">⤜</span>
                                       <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> return <span class="var">?treap_sigma</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="bound">u</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span>
                                       <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> rinss <span class="skolem">xs</span> <span class="bound">t</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insR'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?U</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> return <span class="var">?treap_sigma</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="bound">u</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> rinss <span class="skolem">xs</span> <span class="bound">t</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con_assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_assoc<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?U</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> rinss <span class="skolem">xs</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="bound">u</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con_assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_return<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?U</span> <span class="main">⤜</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span> <span class="main">⤜</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> return <span class="var">?treap_sigma</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="bound">u</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Cons<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> treap_ins keys_ins<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?U</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span> <span class="main">⤜</span>
                  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> return <span class="var">?treap_sigma</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="bound">u</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pair_prob_space <span class="main">(</span><span class="var">?U</span><span class="main">)</span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒰_def pair_prob_space_def pair_sigma_finite.intro prob_space_PiM 
          prob_space_imp_sigma_finite prob_space_uniform_measure<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> this<span class="main">[</span><span class="operator">unfolded</span> 𝒰_def<span class="main">,</span> <span class="operator">measurable</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> con_assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pair_prob_space.pair_measure_bind<span class="main">)</span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="main">(</span><span class="var">?U</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="bound">u</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span>snd <span class="bound">xa</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="main">(</span>fst <span class="bound">xa</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="bound">u</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> con_assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> case_prod_beta'<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bind_return_distr'<span class="main">)</span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="main">(</span><span class="var">?U</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span><span class="main">)</span> <span class="var">?treap_sigma</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">y</span><span class="main">.</span> ins <span class="bound">y</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> fst <span class="bound">f</span> <span class="keyword1">else</span> snd <span class="bound">f</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="main">(</span>fst <span class="bound">f</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">y</span><span class="main">.</span> ins <span class="bound">y</span> <span class="main">(</span>snd <span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="main">(</span>fst <span class="skolem">f</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span>
          foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">y</span><span class="main">.</span> ins <span class="bound">y</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> fst <span class="skolem">f</span> <span class="keyword1">else</span> snd <span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="main">(</span>fst <span class="skolem">f</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> foldl_cong<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="main">(</span><span class="var">?U</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span><span class="main">)</span> 
                          <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span>
                          <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> return <span class="var">?treap_sigma</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="main">(</span><span class="bound">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con_assms  Cons 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_distr_return<span class="main">)</span> <span class="main">(</span><span class="operator">measurable</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?U</span><span class="main">)</span> <span class="main">⤜</span>
                  <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> return <span class="var">?treap_sigma</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>ins <span class="skolem">x</span> <span class="main">(</span><span class="bound">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_pair_PiM_eq_PiM<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prob_space_uniform_measure<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bind_return_distr'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_return_distr'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> random_treap_fold_Leaf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rinss <span class="free">xs</span> Leaf <span class="free">A</span> <span class="main">=</span>
         distr <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> 𝒰 <span class="main">0</span> <span class="main">1</span><span class="main">)</span>
               <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span> <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel<span class="main">)</span><span class="main">)</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> Leaf <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_treap_fold<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we show that additionally forgetting the priorities in the end will yield
  the same distribution as inserting the elements into a BST by ascending priority.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> rinss_bst_of_list<span class="main">:</span>
      <span class="quoted"><span class="quoted">"distr <span class="main">(</span>rinss <span class="free">xs</span> Leaf <span class="free">A</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_tree fst<span class="main">)</span> <span class="main">=</span>
       distr <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> 𝒰 <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> bst_of_list <span class="main">(</span>sort_key <span class="bound">p</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> space <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="skolem">c</span> <span class="main">∈</span> space <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_tree fst <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟨⟩</span> <span class="free">xs</span><span class="main">)</span>
                <span class="main">∈</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span>
                  tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 𝒰_def map_tree_primrec <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> 𝒰 <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> inj_on <span class="bound">f</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 𝒰_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> almost_everywhere_avoid_finite<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> 𝒰 <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span>
             map_tree fst <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> ins <span class="bound">k</span> <span class="bound">p</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟨⟩</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             bst_of_list <span class="main">(</span>sort_key <span class="bound">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">eventually_elim</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> con_assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> fold_ins_bst_of_list›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">f</span> <span class="keyword1">in</span> Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> 𝒰 <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span>
             map_tree fst <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">k</span><span class="main">.</span> ins <span class="bound">k</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟨⟩</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> bst_of_list <span class="main">(</span>sort_key <span class="bound">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> distr <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> 𝒰 <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">(</span>map_tree fst <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">x</span><span class="main">.</span> ins <span class="bound">x</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟨⟩</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> random_treap_fold_Leaf 𝒰_def map_tree_primrec <span class="keyword1"><span class="command">using</span></span> con_assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong_AE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒰_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This in turn is the same as choosing a random permutation of the input list and
  inserting the elements into a BST in that order.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lborel_permutations_of_set_bst_of_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> 𝒰 <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> bst_of_list <span class="main">(</span>sort_key <span class="bound">p</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         distr <span class="main">(</span><span class="free">random_perm</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span> bst_of_list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insort_wrt <span class="skolem">R</span> <span class="free">xs</span> <span class="main">=</span> insort_wrt <span class="skolem">R</span> <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">R</span>
    <span class="keyword1"><span class="command">using</span></span> con_assms distinct_remdups_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"insort_wrt <span class="skolem">R</span> <span class="free">xs</span> <span class="main">=</span> sorted_wrt_list_of_set <span class="skolem">R</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"linorder_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">R</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sorted_wrt_list_set<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> count_space <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con_assms permutations_of_setD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> insort_wrt <span class="bound">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span>
                      count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> count_space <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutations_of_setI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> 
   <span class="main">=</span> distr <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> 𝒰 <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> bst_of_list <span class="main">(</span>insort_wrt <span class="main">(</span>linorder_from_keys <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insort_wrt_sort_key<span class="main">)</span>
 <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> 
  distr <span class="main">(</span>distr <span class="main">(</span>Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> uniform_measure lborel <span class="main">{</span><span class="main">0</span><span class="main">::</span>real<span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorder_from_keys <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> bst_of_list <span class="main">(</span>insort_wrt <span class="bound">R</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> 𝒰_def <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span> <span class="main">(</span><span class="operator">measurable</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> comp_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> 
  distr <span class="main">(</span>uniform_measure <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> bst_of_list <span class="main">(</span>insort_wrt <span class="bound">R</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> random_linorder_by_prios<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="main">(</span>distr <span class="main">(</span>uniform_measure <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                               <span class="main">(</span>count_space <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> insort_wrt <span class="bound">R</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span> bst_of_list"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> distr_distr<span class="main">)</span> <span class="main">(</span><span class="operator">measurable</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> comp_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="main">(</span>uniform_measure <span class="main">(</span>count_space <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> insort_wrt <span class="bound">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">`</span> linorders_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span> bst_of_list"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> insort_wrt <span class="bound">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bij_betw_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * linorders_on_def bij_betw_cong<span class="main">)</span>
         <span class="main">(</span><span class="operator">use</span> bij_betw_linorders_on' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> insort_wrt <span class="bound">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_imp_inj_on<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>uniform_measure <span class="main">(</span>count_space <span class="main">(</span>Pow <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linorders_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">(</span>count_space <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> insort_wrt <span class="bound">R</span> <span class="free">xs</span><span class="main">)</span>
               <span class="main">=</span> uniform_measure <span class="main">(</span>count_space <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                 <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> insort_wrt <span class="bound">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">`</span> linorders_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_uniform_measure_count_space_inj<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorders_on_def linorder_on_def refl_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="main">(</span><span class="free">random_perm</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span> bst_of_list"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">R</span><span class="main">.</span> insort_wrt <span class="bound">R</span> <span class="free">xs</span><span class="main">)</span> <span class="main">`</span> linorders_on <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betw_imp_surj_on<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> bij_betw_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> *<span class="main">)</span>
         <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linorders_on_def<span class="main"><span class="keyword3">,</span></span>  <span class="operator">use</span> bij_betw_linorders_on' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> random_perm_def<span class="main">)</span>
 <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distr_bst_of_list_tree_sigma_count_space<span class="main">:</span> <span class="quoted"><span class="quoted">"
   distr <span class="main">(</span><span class="free">random_perm</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span> bst_of_list <span class="main">=</span>
     distr <span class="main">(</span><span class="free">random_perm</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>count_space <span class="main">(</span>trees <span class="free">A</span><span class="main">)</span><span class="main">)</span> bst_of_list"</span></span>
  <span class="keyword1"><span class="command">using</span></span> con_assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_cong<span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sets_tree_sigma_count_space<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is the same as a \emph{random BST}.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> distr_bst_of_list_random_bst<span class="main">:</span> <span class="quoted"><span class="quoted">"
  distr <span class="main">(</span><span class="free">random_perm</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>count_space <span class="main">(</span>trees <span class="free">A</span><span class="main">)</span><span class="main">)</span> bst_of_list <span class="main">=</span>
    restrict_space <span class="main">(</span>random_bst <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>trees <span class="free">A</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> restrict_space <span class="main">(</span>distr <span class="main">(</span>uniform_measure <span class="main">(</span>count_space UNIV<span class="main">)</span>
                 <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> bst_of_list<span class="main">)</span> <span class="main">(</span>trees <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> random_bst_altdef measure_pmf_of_set map_pmf_rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>uniform_measure <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span>permutations_of_set <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                   <span class="main">(</span>count_space UNIV<span class="main">)</span> bst_of_list <span class="main">=</span> 
               distr <span class="main">(</span><span class="free">random_perm</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>count_space UNIV<span class="main">)</span> bst_of_list"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> distr_restrict<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> random_perm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict_space <span class="main">…</span> <span class="main">(</span>trees <span class="free">A</span><span class="main">)</span> <span class="main">=</span>
               distr <span class="main">(</span><span class="free">random_perm</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>count_space <span class="main">(</span>trees <span class="free">A</span><span class="main">)</span><span class="main">)</span> bst_of_list"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con_assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> restrict_distr<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> random_perm_def bst_of_list_trees restrict_count_space permutations_of_setD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We put everything together and obtain our main result:
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> rinss_random_bst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distr <span class="main">(</span>rinss <span class="free">xs</span> <span class="main">⟨⟩</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>tree_sigma <span class="main">(</span>count_space <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_tree fst<span class="main">)</span> <span class="main">=</span>
     restrict_space <span class="main">(</span>measure_pmf <span class="main">(</span>random_bst <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>trees <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rinss_bst_of_list lborel_permutations_of_set_bst_of_list
                 distr_bst_of_list_tree_sigma_count_space distr_bst_of_list_random_bst<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>