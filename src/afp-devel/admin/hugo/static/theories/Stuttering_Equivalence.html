<div id="Samplers">
<div class="head">
<h1>Theory Samplers</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Samplers
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Omega_Words_Fun.html">HOL-Library.Omega_Words_Fun</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Utility Lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemmas about strictly monotonic functions could go
  to the standard library of Isabelle/HOL.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Strongly monotonic functions over the integers grow without bound.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> strict_mono_exceeds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="free">f</span><span class="main">::</span>nat <span class="main">⇒</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_monoD<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_monoD<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> Suc <span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  More precisely, any natural number <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n ≥ f 0›</span></span></span></span> lies in the interval
  between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f k›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f (Suc k)›</span></span></span></span>, for some <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> strict_mono_interval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="free">f</span><span class="main">::</span>nat <span class="main">⇒</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> f<span class="main">[</span><span class="operator">THEN</span> strict_mono_exceeds<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> m n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> m <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> m' <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="var">?k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="var">?k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?k</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> k n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Least_le<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> 1 that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strict_mono_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="free">g</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>order<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>order<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strict_mono_def<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stuttering Sampling Functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given an <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ω›</span></span></span></span>-sequence <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span>, a stuttering sampling function 
  is a strictly monotonic function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f::nat ⇒ nat›</span></span></span></span> such that
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f 0 = 0›</span></span></span></span> and for all <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> and all <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f i ≤ k &lt; f (i+1)›</span></span></span></span>,
  the elements <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ k›</span></span></span></span> are the same. In other words, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> skips some
  (but not necessarily all) stuttering steps, but never skips a non-stuttering step.
  Given such <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span>, the (stuttering-)sampled
  reduction of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> is the sequence of elements of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> at the
  indices <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f i›</span></span></span></span>, which can simply be written as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ ∘ f›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition and elementary properties›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stutter_sampler</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹f is a stuttering sampling function for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"σ"</span><span class="antiquote">}</span></span>›</span>
  <span class="quoted"><span class="quoted">"<span class="free">stutter_sampler</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">::</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span>
     <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>
   <span class="main">∧</span> strict_mono <span class="free"><span class="bound"><span class="entity">f</span></span></span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">n</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_sampler_0<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stutter_sampler_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_sampler_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span> <span class="main">⟹</span> strict_mono <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stutter_sampler_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_sampler_between<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">n</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_sampler_def less_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_sampler_interval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> f<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> strict_mono_interval<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stutter_sampler_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The identity function is a stuttering sampling function for any <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> id_stutter_sampler <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler id <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_sampler_def strict_mono_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Stuttering sampling functions compose, sort of.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> stutter_sampler_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">g</span> <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_sampler_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f g <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stutter_sampler_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> g<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span> f<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_mono_comp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">assume</span></span> lo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_interval<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> lo 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> f<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strict_mono_less<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 hi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> f<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">g</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strict_mono_less<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> g 4 5 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Stuttering sampling functions can be extended to suffixes.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> stutter_sampler_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>suffix <span class="main">(</span><span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_sampler_def strict_mono_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> mono<span class="main">[</span><span class="operator">THEN</span> strict_mono_mono<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monoD<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> mono<span class="main">[</span><span class="operator">THEN</span> strict_mono_mono<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monoD<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> mono ij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> strict_monoD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">assume</span></span> lo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> lo <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> hi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> f<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">,</span> <span class="operator">THEN</span> strict_mono_mono<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monoD<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> stutter_sampler_between<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preservation of properties through stuttering sampling›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Stuttering sampling preserves the initial element of the sequence, as well as
  the presence and relative ordering of different elements.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_sampled_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_sampled_in_range<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> range <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> range <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_interval<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_sampled_range<span class="main">:</span>
  <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> range <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that stutter_sampled_in_range <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_sampled_precedence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_interval<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">i</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_interval<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">j</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> k l ij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> f<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strict_mono_less<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 2 that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Maximal stuttering sampling›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define a particular sampling function that is maximal in the sense that it
  eliminates all finite stuttering. If a sequence ends with infinite stuttering
  then it behaves as the identity over the (maximal such) suffix.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">max_stutter_sampler</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_stutter_sampler</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_stutter_sampler</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">prev</span> <span class="main">=</span> <span class="free">max_stutter_sampler</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>
     <span class="keyword1">in</span>  <span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="bound">prev</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">prev</span><span class="main">)</span>
         <span class="keyword1">then</span> Suc <span class="bound">prev</span>
         <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">prev</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">k</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">prev</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>max_stutter_sampler›</span></span></span></span> is indeed a stuttering sampling function.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> max_stutter_sampler<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span>max_stutter_sampler <span class="free">σ</span><span class="main">)</span> <span class="free">σ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="var">?ms</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ms</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="var">?ms</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="var">?ms</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ms</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?ms</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prev</span> <span class="main">&lt;</span> <span class="var">?next</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="var">?prev</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">σ</span> <span class="var">?prev</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="var">?prev</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="free">σ</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">σ</span> <span class="var">?prev</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">THEN</span> LeastI_ex<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prev</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="var">?prev</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="free">σ</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">σ</span> <span class="var">?prev</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="var">?ms</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> strict_mono_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lift_Suc_mono_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">k</span><span class="main">.</span> <span class="var">?ms</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="var">?ms</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">σ</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?ms</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> lo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ms</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prev</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
       <span class="keyword2"><span class="keyword">and</span></span> hi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="var">?ms</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="var">?next</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">σ</span> <span class="var">?prev</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="var">?prev</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">σ</span> <span class="var">?prev</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?next</span> <span class="main">=</span> Suc <span class="var">?prev</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> lo hi <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  <span class="comment1">― ‹no room for intermediate index›</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?next</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="var">?prev</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="free">σ</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">σ</span> <span class="var">?prev</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> lo hi <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> not_less_Least<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> stutter_sampler_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We write <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>♮σ›</span></span></span></span> for the sequence <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> sampled by the
  maximal stuttering sampler. Also, a sequence is \emph{stutter free}
  if it contains no finite stuttering: whenever two subsequent
  elements are equal then all subsequent elements are the same.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stutter_reduced</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">♮</span>_"</span> <span class="main">[</span>100<span class="main">]</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">♮</span></span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">∘</span> <span class="main">(</span>max_stutter_sampler <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stutter_free</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stutter_free</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">k</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">n</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">k</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_freeI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span><span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="bound">k</span><span class="main">;</span> <span class="bound">n</span><span class="main">&gt;</span><span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">σ</span> <span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stutter_free <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_freeD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stutter_free <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">&gt;</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">n</span> <span class="main">=</span> <span class="free">σ</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Any suffix of a stutter free sequence is itself stutter free.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> stutter_free_suffix<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_free <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stutter_free <span class="main">(</span>suffix <span class="free">k</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_freeI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>suffix <span class="free">k</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>suffix <span class="free">k</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">+</span><span class="skolem">n</span> <span class="main">&gt;</span> <span class="free">k</span><span class="main">+</span><span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_freeD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sigma<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>suffix <span class="free">k</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span>suffix <span class="free">k</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_reduced_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stutter_reduced_def stutter_sampled_0 max_stutter_sampler<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_free_reduced<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_free <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">♮</span><span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_stutter_sampler <span class="free">σ</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ms</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ms</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ms</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ms</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?ms</span> <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> sigma <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">σ</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> stutter_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">&gt;</span><span class="skolem">n</span> <span class="main">∧</span> <span class="free">σ</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?ms</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Least_equality<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> ih False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_reduced_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Whenever two sequence elements at two consecutive sampling points of the 
  maximal stuttering sampler are equal then the sequence stutters infinitely 
  from the first sampling point onwards. In particular, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>♮σ›</span></span></span></span> is
  stutter free.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> max_stutter_sampler_nostuttering<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> stut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span>max_stutter_sampler <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span>max_stutter_sampler <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> max_stutter_sampler <span class="free">σ</span> <span class="free">k</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">&gt;</span> <span class="var">?ms</span> <span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">n</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?ms</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ms</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">σ</span> <span class="free">n</span> <span class="main">≠</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?ms</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?diff</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?diff</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?diff</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> contr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="var">?ms</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?ms</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this stut <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_reduced_stutter_free<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_free <span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_freeI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_stutter_sampler <span class="free">σ</span> <span class="skolem">k</span> <span class="main">&lt;</span> max_stutter_sampler <span class="free">σ</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> max_stutter_sampler<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">,</span> <span class="operator">THEN</span> strict_monoD<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stutter_reduced_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> max_stutter_sampler_nostuttering 
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> max_stutter_sampler.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_reduced_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">♮</span> <span class="main">(</span>suffix <span class="free">k</span> <span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> suffix <span class="free">k</span> <span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_free_reduced<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stutter_free <span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_reduced_stutter_free<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"stutter_free <span class="main">(</span>suffix <span class="free">k</span> <span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_free_suffix<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_reduced_reduced<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">♮</span><span class="main">♮</span><span class="free">σ</span> <span class="main">=</span> <span class="main">♮</span><span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> stutter_reduced_suffix<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">σ</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  One can define a partial order on sampling functions for a given sequence
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> by saying that function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> is better than function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span>
  if the reduced sequence induced by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> can be further reduced to obtain
  the reduced sequence corresponding to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span>, i.e. if there exists a
  stuttering sampling function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>h›</span></span></span></span> for the reduced sequence <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ ∘ f›</span></span></span></span>
  such that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ ∘ f ∘ h = σ ∘ g›</span></span></span></span>. (Note that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f ∘ h›</span></span></span></span> is indeed a stuttering
  sampling function for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span>, by theorem <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>stutter_sampler_comp›</span></span></span></span>.)

  We do not formalize this notion but prove that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>max_stutter_sampler σ›</span></span></span></span>
  is the best sampling function according to this order.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> sample_max_sample<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">♮</span><span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">♮</span><span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"max_stutter_sampler <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mssf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"max_stutter_sampler <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> mssf<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="var">?mssf</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stutter_sampler_comp max_stutter_sampler<span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹
    The following is the core invariant of the proof: the sampling functions
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>max_stutter_sampler σ›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f ∘ (max_stutter_sampler (σ ∘ f))›</span></span></span></span>
    work in lock-step (i.e., sample the same points), except if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> ends
    in infinite stuttering, at which point function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> may make larger
    steps than the maximal sampling functions.
›</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"  <span class="var">?mss</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span><span class="main">)</span>
          <span class="main">∨</span> <span class="var">?mss</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">≥</span> <span class="var">?mss</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="var">?B</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> f mssf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_stutter_sampler stutter_sampler_0<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="skolem">k</span> <span class="main">⟶</span> <span class="var">?B</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="comment1">(* NB: For some reason "... hence 1: ... and 2: ..." cannot be proved *)</span>
        <span class="keyword1"><span class="command">from</span></span> 0 <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">≥</span> <span class="var">?mss</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">&gt;</span> <span class="var">?mss</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">&gt;</span> <span class="var">?mss</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> max_stutter_sampler.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> sym<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 2 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">≥</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">.</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="bound">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> max_stutter_sampler.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> mssf<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">,</span> <span class="operator">THEN</span> strict_monoD<span class="main">]</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> max_stutter_sampler.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 1 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> max_stutter_sampler.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">&gt;</span> <span class="var">?mss</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">≥</span> <span class="var">?mss</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> b <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> max_stutter_sampler.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> max_stutter_sampler_nostuttering<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">from</span></span> mssf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="var">?mssf</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main">)</span>
                <span class="keyword1"><span class="command">from</span></span> max_stutter_sampler<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span>"</span></span><span class="main">,</span> <span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_monoD<span class="main">)</span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="var">?mssf</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> max_stutter_sampler.simps<span class="main">)</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword1"><span class="command">from</span></span> contr <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="var">?mssf</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> max_stutter_sampler.simps<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> diff <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">..</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span> <span class="main">&gt;</span> <span class="var">?mssf</span> <span class="skolem">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">=</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mss</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
                  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> max_stutter_sampler<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span>"</span></span><span class="main">,</span> <span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span> 
                       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_monoD<span class="main">)</span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
                  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">i</span>"</span></span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
                    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
                    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> 
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
                    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> contr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le<span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main">)</span>
                      <span class="keyword1"><span class="command">from</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> 
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword1"><span class="command">from</span></span> i <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">qed</span></span>
                    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> max_stutter_sampler <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main">)</span>
                      <span class="keyword1"><span class="command">from</span></span> f<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">,</span> <span class="operator">THEN</span> strict_mono_mono<span class="main">]</span>
                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monoD<span class="main">)</span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
                    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main">)</span>
                    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> diff
                    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> bounded <span class="main">=</span> this
              <span class="keyword1"><span class="command">from</span></span> f<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span> 
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strict_mono_def<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> strict_mono_exceeds<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> bounded <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">with</span></span> i <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> max_stutter_sampler.simps<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="var">?mssf</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">m</span> <span class="main">=</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?mss</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">from</span></span> mssf<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="var">?mssf</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="var">?mssf</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_monoD<span class="main">)</span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mss</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> this contr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="var">?mssf</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="var">?mss</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main"><span class="main">[</span></span><span class="operator">OF</span> max_stutter_sampler<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> stut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?mssf</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> this m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?mssf</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max_stutter_sampler_nostuttering<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> diff m' a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> b <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> max_stutter_sampler.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">♮</span><span class="free">σ</span> <span class="main">=</span> <span class="main">♮</span><span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> stutter_reduced_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>  <span class="comment1">(* theory Samplers *)</span>

</pre>
</div><div id="StutterEquivalence">
<div class="head">
<h1>Theory StutterEquivalence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> StutterEquivalence
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Samplers.html">Samplers</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stuttering Equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Stuttering equivalence of two sequences is formally defined as the equality
  of their maximally reduced versions.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stutter_equiv</span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">≡</span> <span class="main">♮</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">♮</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Stuttering equivalence is an equivalence relation.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_equiv_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stutter_equiv_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_equiv_sym <span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">τ</span> <span class="main">≈</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stutter_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_equiv_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≈</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">ρ</span> <span class="main">≈</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stutter_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In particular, any sequence sampled by a stuttering sampler
  is stuttering equivalent to the original one.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sampled_stutter_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">≈</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sample_max_sample<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_reduced_equivalent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">♮</span><span class="free">σ</span> <span class="main">≈</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stutter_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_reduced_reduced<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For proving stuttering equivalence of two sequences, it is enough
  to exhibit two arbitrary sampling functions that equalize the reductions
  of the sequences. This can be more convenient than computing the
  maximal stutter-reduced version of the sequences.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_equivI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">g</span> <span class="free">τ</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">∘</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">♮</span><span class="free">σ</span> <span class="main">=</span> <span class="main">♮</span><span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sample_max_sample<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">♮</span><span class="main">(</span><span class="free">τ</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">♮</span><span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sample_max_sample<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> stutter_equiv_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The corresponding elimination rule is easy to prove, given that the
  maximal stuttering sampling function is a stuttering sampling function.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_equivE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">⟦</span> stutter_sampler <span class="bound">f</span> <span class="free">σ</span><span class="main">;</span> stutter_sampler <span class="bound">g</span> <span class="free">τ</span><span class="main">;</span> <span class="free">σ</span> <span class="main">∘</span> <span class="bound">f</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">∘</span> <span class="bound">g</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> p<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∘</span> <span class="main">(</span>max_stutter_sampler <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">∘</span> <span class="main">(</span>max_stutter_sampler <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> stutter_equiv_def stutter_reduced_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> max_stutter_sampler<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Therefore we get the following alternative characterization: two
  sequences are stuttering equivalent iff there are stuttering sampling
  functions that equalize the two sequences.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> stutter_equiv_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> stutter_sampler <span class="bound">f</span> <span class="free">σ</span> <span class="main">∧</span> stutter_sampler <span class="bound">g</span> <span class="free">τ</span> <span class="main">∧</span> <span class="free">σ</span> <span class="main">∘</span> <span class="bound">f</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">∘</span> <span class="bound">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stutter_equivI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stutter_equivE<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The initial elements of stutter equivalent sequences are equal.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> stutter_equiv_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">0</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_reduced_0<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> stutter_equiv_def<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stutter_reduced_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">suffix_notation</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">[</span>_<span class="keyword1">..]</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">suffix_notation</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> suffix <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given any stuttering sampling function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> for sequence <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span>,
  any suffix of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> starting at index <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f n›</span></span></span></span> is stuttering
  equivalent to the suffix of the stutter-reduced version of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span>
  starting at <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> suffix_stutter_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"suffix <span class="main">(</span><span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="free">σ</span> <span class="main">≈</span> suffix <span class="free">n</span> <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span><span class="main">[</span><span class="free">f</span> <span class="free">n</span> <span class="main">..]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_suffix<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stutter_sampler id <span class="main">(</span><span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">[</span><span class="free">n</span> <span class="main">..]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> id_stutter_sampler<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">[</span><span class="free">f</span> <span class="free">n</span> <span class="main">..]</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">[</span><span class="free">n</span> <span class="main">..]</span><span class="main">)</span> <span class="main">∘</span> id"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">from</span></span> f<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">,</span> <span class="operator">THEN</span> strict_mono_mono<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monoD<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equivI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a stuttering sampling function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> and a point <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>
  within the interval from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f k›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f (k+1)›</span></span></span></span>, the suffix
  starting at <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> is stuttering equivalent to the suffix starting
  at <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f k›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> stutter_equiv_within_interval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="free">f</span> <span class="free">σ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">[</span><span class="free">n</span> <span class="main">..]</span> <span class="main">≈</span> <span class="free">σ</span><span class="main">[</span><span class="free">f</span> <span class="free">k</span> <span class="main">..]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stutter_sampler id <span class="main">(</span><span class="free">σ</span><span class="main">[</span><span class="free">n</span> <span class="main">..]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> id_stutter_sampler<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> lo <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">σ</span><span class="main">[</span><span class="free">f</span> <span class="free">k</span> <span class="main">..]</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="var">?f</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_sampler_def strict_mono_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">-</span> <span class="free">f</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> f <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> i hi <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">[</span><span class="free">n</span> <span class="main">..]</span><span class="main">)</span> <span class="main">∘</span> id <span class="main">=</span> <span class="main">(</span><span class="free">σ</span><span class="main">[</span><span class="free">f</span> <span class="free">k</span> <span class="main">..]</span><span class="main">)</span> <span class="main">∘</span> <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> f lo hi <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">n</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_between<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">from</span></span> lo <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">-</span> <span class="free">f</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equivI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given two stuttering equivalent sequences <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>τ›</span></span></span></span>,
  we obtain a zig-zag relationship as follows: for any suffix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>τ[n..]›</span></span></span></span>
  there is a suffix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ[m..]›</span></span></span></span> such that:
  \begin{enumerate}
  \item <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ[m..] ≈ τ[n..]›</span></span></span></span> and
  \item for every suffix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ[j..]›</span></span></span></span> where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j&lt;m›</span></span></span></span> there is a
    corresponding suffix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>τ[k..]›</span></span></span></span> for some <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k&lt;n›</span></span></span></span>.
  \end{enumerate}
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> stutter_equiv_suffixes_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">[</span><span class="free">m</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="free">n</span><span class="main">..]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">σ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equivE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span>
  <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="skolem">f</span> <span class="free">σ</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_sampler <span class="skolem">g</span> <span class="free">τ</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∘</span> <span class="skolem">f</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">∘</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> g <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_interval<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span><span class="main">[</span><span class="free">n</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="skolem">g</span> <span class="skolem">i</span> <span class="main">..]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_within_interval<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≈</span> <span class="main">(</span><span class="free">τ</span> <span class="main">∘</span> <span class="skolem">g</span><span class="main">)</span><span class="main">[</span><span class="skolem">i</span> <span class="main">..]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> suffix_stutter_equiv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span><span class="main">[</span><span class="skolem">i</span> <span class="main">..]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≈</span> <span class="free">σ</span><span class="main">[</span><span class="skolem">f</span> <span class="skolem">i</span> <span class="main">..]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> suffix_stutter_equiv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> stutter_equiv_sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">[</span><span class="skolem">f</span> <span class="skolem">i</span> <span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="free">n</span> <span class="main">..]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> f <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_sampler_interval<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">f</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> f<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strict_mono_less<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> g<span class="main">[</span><span class="operator">THEN</span> stutter_sampler_mono<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">g</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strict_mono_less<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">a</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> f a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">[</span><span class="skolem">j</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">σ</span><span class="main">[</span><span class="skolem">f</span> <span class="skolem">a</span> <span class="main">..]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_within_interval<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≈</span> <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span><span class="main">[</span><span class="skolem">a</span> <span class="main">..]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> suffix_stutter_equiv<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">∘</span> <span class="skolem">g</span><span class="main">)</span><span class="main">[</span><span class="skolem">a</span> <span class="main">..]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="skolem">g</span> <span class="skolem">a</span> <span class="main">..]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> suffix_stutter_equiv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> stutter_equiv_sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">[</span><span class="skolem">j</span> <span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="skolem">g</span> <span class="skolem">a</span> <span class="main">..]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">σ</span><span class="main">[</span><span class="skolem">j</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="bound">k</span> <span class="main">..]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> that
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> stutter_equiv_suffixes_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">[</span><span class="free">m</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="free">n</span><span class="main">..]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="free">σ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">≈</span> <span class="free">σ</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span><span class="main">[</span><span class="skolem">n</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">σ</span><span class="main">[</span><span class="free">m</span><span class="main">..]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="free">τ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">σ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_suffixes_left<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> stutter_equiv_sym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In particular, if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>τ›</span></span></span></span> are stutter equivalent then
  every element that occurs in one sequence also occurs in the other.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> stutter_equiv_element_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">m</span> <span class="main">=</span> <span class="free">τ</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">[</span><span class="skolem">m</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="free">n</span><span class="main">..]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">σ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_suffixes_left<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> stutter_equiv_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_equiv_element_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">m</span> <span class="main">=</span> <span class="free">τ</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">[</span><span class="free">m</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="skolem">n</span><span class="main">..]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">m</span><span class="main">.</span> <span class="free">σ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span> <span class="main">≈</span> <span class="free">τ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_suffixes_right<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> stutter_equiv_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PLTL">
<div class="head">
<h1>Theory PLTL</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> PLTL
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="../LTL/LTL.html">LTL.LTL</a> <a href="Samplers.html">Samplers</a> <a href="StutterEquivalence.html">StutterEquivalence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stuttering Invariant LTL Formulas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We show that the next-free fragment of propositional linear-time
  temporal logic PLTL is invariant to finite stuttering.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finite Conjunctions and Disjunctions in PLTL›</span></span>

<span class="comment1">(* It would be tempting to define these operators as follows:

definition OR where "OR Φ = Finite_Set.fold or false Φ"
definition AND where "AND Φ = Finite_Set.fold and true Φ"

However, this would only work if "or" and "and" were left-commutative,
which they are not (syntactically). We must therefore resort to
the more general fold_graph predicate, effectively picking a
conjunction (or disjunction) in arbitrary order. 

An alternative would be to define these generalized operators
over lists of formulas, but working with sets is more natural
in the following.
*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OR</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">OR</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">φ</span><span class="main">.</span> fold_graph Or_ltlp False_ltlp <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="bound">φ</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AND</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AND</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">φ</span><span class="main">.</span> fold_graph And_ltlp True_ltlp <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="bound">φ</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fold_graph_OR<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Φ</span> <span class="main">⟹</span> fold_graph Or_ltlp False_ltlp <span class="free">Φ</span> <span class="main">(</span>OR <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OR_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_imp_fold_graph<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_graph_AND<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Φ</span> <span class="main">⟹</span> fold_graph And_ltlp True_ltlp <span class="free">Φ</span> <span class="main">(</span>AND <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> AND_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_imp_fold_graph<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> holds_of_OR <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">Φ</span><span class="main">::</span><span class="tfree">'a</span> pltl set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> OR <span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> <span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fold_graph Or_ltlp False_ltlp <span class="free">Φ</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> <span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fold_graph.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> fold_graph_OR<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> holds_of_AND <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">Φ</span><span class="main">::</span><span class="tfree">'a</span> pltl set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> AND <span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> <span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fold_graph And_ltlp True_ltlp <span class="free">Φ</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> <span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fold_graph.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> fold_graph_AND<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Next-Free PLTL Formulas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A PLTL formula is called \emph{next-free} if it does not contain any
  subformula.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">next_free</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_free</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">next_free</span> <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">next_free</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">implies<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">next_free</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">next_free</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">next_free</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">next_free</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="keyword1">not<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> next_free <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Not_ltlp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_true <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"next_free <span class="keyword1">true<span class="hidden">⇩</span><sub>p</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True_ltlp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_or <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="free">φ</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>next_free <span class="free">φ</span> <span class="main">∧</span> next_free <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Or_ltlp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_and <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="free">φ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>next_free <span class="free">φ</span> <span class="main">∧</span> next_free <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> And_ltlp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_eventually <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> next_free <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Eventually_ltlp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_always <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> next_free <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Always_ltlp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_release <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="free">φ</span> <span class="keyword1">R<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>next_free <span class="free">φ</span> <span class="main">∧</span> next_free <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Release_ltlp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_weak_until <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="free">φ</span> <span class="keyword1">W<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>next_free <span class="free">φ</span> <span class="main">∧</span> next_free <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> WeakUntil_ltlp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_strong_release <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="free">φ</span> <span class="keyword1">M<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>next_free <span class="free">φ</span> <span class="main">∧</span> next_free <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> StrongRelease_ltlp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_OR <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">Φ</span><span class="main">::</span><span class="tfree">'a</span> pltl set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"next_free <span class="main">(</span>OR <span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> next_free <span class="bound">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fold_graph Or_ltlp False_ltlp <span class="free">Φ</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"next_free <span class="skolem">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> next_free <span class="bound">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fold_graph.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> fold_graph_OR<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> next_free_AND <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">Φ</span><span class="main">::</span><span class="tfree">'a</span> pltl set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"next_free <span class="main">(</span>AND <span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> next_free <span class="bound">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fold_graph And_ltlp True_ltlp <span class="free">Φ</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"next_free <span class="skolem">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> next_free <span class="bound">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fold_graph.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> fold_graph_AND<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stuttering Invariance of PLTL Without ``Next''›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A PLTL formula is \emph{stuttering invariant} if for any stuttering equivalent
  state sequences <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ ≈ τ›</span></span></span></span>, the formula holds of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> iff it
  holds of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>τ›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stutter_invariant</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stutter_invariant</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">≈</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since stuttering equivalence is symmetric, it is enough to show an
  implication in the above definition instead of an equivalence.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_invariantI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">σ</span> <span class="main">≈</span> <span class="bound">τ</span><span class="main">;</span> <span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span>
    <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">≈</span> <span class="skolem">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span>
    <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">≈</span> <span class="skolem">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">≈</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_sym<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_invariant_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_invariantD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≈</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_invariant_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We first show that next-free PLTL formulas are indeed stuttering invariant.
  The proof proceeds by straightforward induction on the syntax of PLTL formulas.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> next_free_stutter_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"next_free <span class="free">φ</span> <span class="main">⟹</span> stutter_invariant <span class="main">(</span><span class="free">φ</span><span class="main">::</span><span class="tfree">'a</span> pltl<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="keyword1">false<span class="hidden">⇩</span><sub>p</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">≈</span> <span class="skolem">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stutter_equiv_0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"next_free <span class="skolem">φ</span> <span class="main">⟹</span> stutter_invariant <span class="skolem">φ</span>"</span></span>
             <span class="quoted"><span class="quoted">"next_free <span class="skolem">ψ</span> <span class="main">⟹</span> stutter_invariant <span class="skolem">ψ</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">implies<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">implies<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>  <span class="comment1">― ‹hence contradiction›</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"next_free <span class="skolem">φ</span> <span class="main">⟹</span> stutter_invariant <span class="skolem">φ</span>"</span></span>
             <span class="quoted"><span class="quoted">"next_free <span class="skolem">ψ</span> <span class="main">⟹</span> stutter_invariant <span class="skolem">ψ</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"next_free <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword1"><span class="command">have</span></span> stinv<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span>
    <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">≈</span> <span class="skolem">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> unt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> unt <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="skolem">m</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> st <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="skolem">m</span><span class="main">..]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">[</span><span class="skolem">n</span><span class="main">..]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">m</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">[</span><span class="bound">i</span><span class="main">..]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_equiv_suffixes_right<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1 3 stinv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span><span class="main">[</span><span class="skolem">n</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> 2 4 stinv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">[</span><span class="bound">i</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Atoms, Canonical State Sequences, and Characteristic Formulas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now address the converse implication: any stutter invariant PLTL
  formula <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>φ›</span></span></span></span> can be equivalently expressed by a next-free formula.
  The construction of that formula requires attention to the atomic
  formulas that appear in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>φ›</span></span></span></span>. We will also prove that the
  next-free formula does not need any new atoms beyond those present
  in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>φ›</span></span></span></span>.

  The following function collects the atoms (of type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a ⇒ bool›</span></span></span></span>)
  of a PLTL formula.
›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> atoms_pltl_OR <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">Φ</span><span class="main">::</span><span class="tfree">'a</span> pltl set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="main">(</span>OR <span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> atoms_pltl <span class="bound">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fold_graph Or_ltlp False_ltlp <span class="free">Φ</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="skolem">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> atoms_pltl <span class="bound">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fold_graph.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> fold_graph_OR<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_pltl_AND <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">Φ</span><span class="main">::</span><span class="tfree">'a</span> pltl set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="main">(</span>AND <span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> atoms_pltl <span class="bound">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pltl"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fold_graph And_ltlp True_ltlp <span class="free">Φ</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="skolem">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span><span class="free">Φ</span><span class="main">.</span> atoms_pltl <span class="bound">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fold_graph.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> fold_graph_AND<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a set of atoms <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> as above, we say that two states
  are <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>-similar if they agree on all atoms in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>.
  Two state sequences <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>τ›</span></span></span></span> are <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>-similar
  if corresponding states are <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>-equal.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">state_sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> set<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> bool"</span></span> 
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">~</span>_<span class="keyword1">~</span> _"</span> <span class="main">[</span>70<span class="main">,</span>100<span class="main">,</span>70<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">~</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main"><span class="free">~</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">seq_sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> set<span class="main">,</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≃</span>_<span class="keyword1">≃</span> _"</span> <span class="main">[</span>70<span class="main">,</span>100<span class="main">,</span>70<span class="main">]</span> 50<span class="main">)</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main"><span class="free">≃</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">n</span><span class="main">)</span> <span class="main">~</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">~</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  These relations are (indexed) equivalence relations. Moreover
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s ~A~ t›</span></span></span></span> implies <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s ~B~ t›</span></span></span></span> for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B ⊆ A›</span></span></span></span>,
  and similar for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ ≃A≃ τ›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ ≃B≃ τ›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> state_sim_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_sim_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> state_sim_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_sim_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> state_sim_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_sim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> state_sim_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">~</span><span class="free">B</span><span class="main">~</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> state_sim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> seq_sim_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≃</span><span class="free">A</span><span class="main">≃</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> seq_sim_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> seq_sim_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≃</span><span class="free">A</span><span class="main">≃</span> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">τ</span> <span class="main">≃</span><span class="free">A</span><span class="main">≃</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seq_sim_def state_sim_sym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> seq_sim_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≃</span><span class="free">A</span><span class="main">≃</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">≃</span><span class="free">A</span><span class="main">≃</span> <span class="free">τ</span> <span class="main">⟹</span> <span class="free">ρ</span> <span class="main">≃</span><span class="free">A</span><span class="main">≃</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> seq_sim_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> state_sim_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> seq_sim_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≃</span><span class="free">A</span><span class="main">≃</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≃</span><span class="free">B</span><span class="main">≃</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> seq_sim_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> state_sim_mono<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  State sequences that are similar w.r.t. the atoms of a PLTL formula
  evaluate that formula to the same value.  
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pltl_seq_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≃</span> atoms_pltl <span class="free">φ</span> <span class="main">≃</span> <span class="free">τ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sim</span> <span class="free">σ</span> <span class="free">φ</span> <span class="free">τ</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="free">σ</span> <span class="free">φ</span> <span class="free">τ</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">τ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">τ</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">σ</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">σ</span> <span class="skolem">τ</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sim</span> <span class="skolem">σ</span> <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">τ</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">σ</span> <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seq_sim_def state_sim_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">σ</span> <span class="skolem">τ</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> <span class="var">?sim</span> <span class="bound">σ</span> <span class="skolem">φ</span> <span class="bound">τ</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">σ</span> <span class="skolem">φ</span> <span class="bound">τ</span>"</span></span> 
             <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> <span class="var">?sim</span> <span class="bound">σ</span> <span class="skolem">ψ</span> <span class="bound">τ</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">σ</span> <span class="skolem">ψ</span> <span class="bound">τ</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sim</span> <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">implies<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">τ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> sim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sim</span> <span class="skolem">σ</span> <span class="skolem">φ</span> <span class="skolem">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sim</span> <span class="skolem">σ</span> <span class="skolem">ψ</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> seq_sim_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">implies<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">σ</span> <span class="skolem">τ</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> <span class="var">?sim</span> <span class="bound">σ</span> <span class="skolem">φ</span> <span class="bound">τ</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">σ</span> <span class="skolem">φ</span> <span class="bound">τ</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">≃</span> atoms_pltl <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">≃</span> <span class="skolem">τ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> sim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span><span class="main">)</span> <span class="main">≃</span> atoms_pltl <span class="skolem">φ</span> <span class="main">≃</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seq_sim_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">σ</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">σ</span> <span class="skolem">τ</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> <span class="var">?sim</span> <span class="bound">σ</span> <span class="skolem">φ</span> <span class="bound">τ</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">σ</span> <span class="skolem">φ</span> <span class="bound">τ</span>"</span></span> 
             <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> <span class="var">?sim</span> <span class="bound">σ</span> <span class="skolem">ψ</span> <span class="bound">τ</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">σ</span> <span class="skolem">ψ</span> <span class="bound">τ</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sim</span> <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">τ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> sim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">i</span><span class="main">..]</span><span class="main">)</span> <span class="main">≃</span> atoms_pltl <span class="skolem">φ</span> <span class="main">≃</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">[</span><span class="bound">i</span><span class="main">..]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span><span class="main">)</span> <span class="main">≃</span> atoms_pltl <span class="skolem">ψ</span> <span class="main">≃</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seq_sim_def state_sim_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ih <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">i</span><span class="main">..]</span><span class="main">)</span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">[</span><span class="bound">i</span><span class="main">..]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span><span class="main">)</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">[</span><span class="bound">j</span><span class="main">..]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> semantics_pltl.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following function picks an arbitrary representative among
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>-similar states. Because the choice is functional,
  any two <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>-similar states are mapped to the same state.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">canonize</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">canonize</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">~</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">~</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> canonize_state_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"canonize <span class="free">A</span> <span class="free">s</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> canonize_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> state_sim_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> canonize_canonical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"canonize <span class="free">A</span> <span class="free">s</span> <span class="main">=</span> canonize <span class="free">A</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">u</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> state_sim_sym state_sim_trans<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> canonize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> canonize_idempotent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonize <span class="free">A</span> <span class="main">(</span>canonize <span class="free">A</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> canonize <span class="free">A</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> canonize_canonical<span class="main"><span class="main">[</span></span><span class="operator">OF</span> canonize_state_sim<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In a canonical state sequence, any two <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>-similar states
  are in fact equal.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">canonical_sequence</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">canonical_sequence</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">m</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">m</span> <span class="main">~</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">~</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">n</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">m</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">n</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Every suffix of a canonical sequence is canonical, as is any
  (sampled) subsequence, in particular any stutter-sampling.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> canonical_suffix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical_sequence <span class="free">A</span> <span class="free">σ</span> <span class="main">⟹</span> canonical_sequence <span class="free">A</span> <span class="main">(</span><span class="free">σ</span><span class="main">[</span><span class="free">k</span><span class="main">..]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> canonical_sequence_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> canonical_sampled<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical_sequence <span class="free">A</span> <span class="free">σ</span> <span class="main">⟹</span> canonical_sequence <span class="free">A</span> <span class="main">(</span><span class="free">σ</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> canonical_sequence_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> canonical_reduced<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical_sequence <span class="free">A</span> <span class="free">σ</span> <span class="main">⟹</span> canonical_sequence <span class="free">A</span> <span class="main">(</span><span class="main">♮</span><span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stutter_reduced_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> canonical_sampled<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For any sequence <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> there exists a canonical
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>-similar sequence <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>τ›</span></span></span></span>. Such a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>τ›</span></span></span></span>
  can be obtained by canonizing all states of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> canonical_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">τ</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">≃</span><span class="free">A</span><span class="main">≃</span> <span class="free">σ</span>"</span></span> <span class="quoted"><span class="quoted">"canonical_sequence <span class="free">A</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>canonize <span class="free">A</span> <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="main">≃</span><span class="free">A</span><span class="main">≃</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> seq_sim_def canonize_state_sim<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"canonical_sequence <span class="free">A</span> <span class="main">(</span>canonize <span class="free">A</span> <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> canonical_sequence_def canonize_idempotent
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> canonize_canonical<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> and a set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> of atoms, we define
  the characteristic formula of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> as the conjunction of
  all atoms in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> that hold of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> and the negation of
  the atoms in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> that do not hold of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">characteristic_formula</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">characteristic_formula</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
   <span class="main">(</span><span class="main">(</span>AND <span class="main">{</span> <span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="bound">p</span><span class="main">)</span> <span class="main">|</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">}</span><span class="main">)</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span>AND <span class="main">{</span> <span class="keyword1">not<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> characteristic_holds<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> characteristic_formula <span class="free">A</span> <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> characteristic_formula_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> characteristic_state_sim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="main">0</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">τ</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> characteristic_formula <span class="free">A</span> <span class="main">(</span><span class="free">σ</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">0</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">τ</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> sim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="free">τ</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_sim_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> fin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> characteristic_formula <span class="free">A</span> <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> characteristic_formula_def<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> characteristic_formula <span class="free">A</span> <span class="main">(</span><span class="free">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> fin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">0</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="free">τ</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> characteristic_formula_def state_sim_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stuttering Invariant PLTL Formulas Don't Need Next›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following is the main lemma used in the proof of the
  completeness theorem: for any PLTL formula <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>φ›</span></span></span></span> there
  exists a next-free formula <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ψ›</span></span></span></span> such that the two
  formulas evaluate to the same value over stutter-free and
  canonical sequences (w.r.t. some <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A ⊇ atoms_pltl φ›</span></span></span></span>).
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_next_free_stutter_free_canonical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="free">φ</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> next_free <span class="bound">ψ</span> <span class="main">∧</span> atoms_pltl <span class="bound">ψ</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span>
             <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> stutter_free <span class="bound">σ</span> <span class="main">∧</span> canonical_sequence <span class="free">A</span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="var">?P</span> <span class="free">φ</span> <span class="bound">ψ</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The cases of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>false›</span></span></span></span> and atomic formulas are trivial.›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>p</sub></span> <span class="keyword1">false<span class="hidden">⇩</span><sub>p</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="var">?P</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">ψ</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="bound">ψ</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Implication is easy, using the induction hypothesis.›</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">ψ</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="skolem">φ</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">φ'</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">φ</span> <span class="bound">φ'</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="skolem">ψ</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ψ'</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">ψ</span> <span class="bound">ψ'</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">implies<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="skolem"><span class="skolem">ψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">φ</span> <span class="skolem">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">ψ</span> <span class="skolem">ψ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">implies<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">φ'</span> <span class="keyword1">implies<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">χ</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">implies<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="bound">χ</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The case of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>until›</span></span></span></span> follows similarly.›</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">ψ</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="skolem">φ</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">φ'</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">φ</span> <span class="bound">φ'</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="skolem">ψ</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ψ'</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">ψ</span> <span class="bound">ψ'</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="skolem"><span class="skolem">ψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">φ</span> <span class="skolem">φ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">ψ</span> <span class="skolem">ψ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span>
    <span class="keyword3"><span class="command">assume</span></span> sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_free <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"canonical_sequence <span class="free">A</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> stutter_free <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> canonical_sequence <span class="free">A</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_free_suffix canonical_suffix<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 1 2 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">k</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ'</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">φ'</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">χ</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="bound">χ</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The interesting case is the one of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>next›</span></span></span></span>-operator.›</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="skolem">φ</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">φ</span> <span class="bound">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> at<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> psi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">φ</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹A valuation (over <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span>) is a set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>val ⊆ A›</span></span></span></span> of atoms. We
    define some auxiliary notions: the valuation corresponding to a state and
    the characteristic formula for a valuation. Finally, we define the formula
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>psi'›</span></span></span></span> that we will prove to be equivalent to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X<span class="hidden">⇩</span><sub>p</sub> φ›</span></span></span></span> over
    the stutter-free and canonical sequence <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span>.›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">stval</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">stval</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">A</span> <span class="main">.</span> <span class="bound">p</span> <span class="bound">s</span> <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">chi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">chi</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">val</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>AND <span class="main">{</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="bound">p</span><span class="main">)</span> <span class="main">|</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">val</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>p</sub></span>
                        <span class="main">(</span>AND <span class="main">{</span><span class="keyword1">not<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="bound">val</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">psi'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ψ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span>OR <span class="main">{</span><span class="keyword1">G<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="skolem">chi</span> <span class="bound">val</span><span class="main">)</span> <span class="main">|</span> <span class="bound">val</span> <span class="main">.</span> <span class="bound">val</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>p</sub></span>
                  <span class="main">(</span>OR <span class="main">{</span><span class="main">(</span><span class="skolem">chi</span> <span class="bound">val</span><span class="main">)</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="main">(</span><span class="skolem">chi</span> <span class="bound">val</span><span class="main">)</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span> <span class="skolem">ψ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="skolem">chi</span> <span class="bound">val'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">val</span> <span class="bound">val'</span><span class="main">.</span>
                        <span class="bound">val</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">val'</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">val'</span> <span class="main">≠</span> <span class="bound">val</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span> <span class="main">_</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span>OR <span class="var">?ALW</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">or<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span>OR <span class="var">?UNT</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="keyword1">not<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="skolem">stval</span> <span class="bound">s</span><span class="main">}</span>
           <span class="main">=</span> <span class="main">{</span><span class="keyword1">not<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="keyword1">atom<span class="hidden">⇩</span><sub>p</sub>(</span><span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">p</span> <span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="bound">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stval_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> chi1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">chi</span> <span class="main">(</span><span class="skolem">stval</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> characteristic_formula <span class="free">A</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chi_def stval_def characteristic_formula_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">val</span> <span class="skolem">τ</span>
    <span class="keyword3"><span class="command">assume</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">val</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tau<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val</span> <span class="main">=</span> <span class="skolem">stval</span> <span class="main">(</span><span class="skolem">τ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stval_def chi_def finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> chi2 <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?UNT</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">val</span><span class="main">,</span><span class="bound">val'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">chi</span> <span class="bound">val</span><span class="main">)</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="main">(</span><span class="skolem">chi</span> <span class="bound">val</span><span class="main">)</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="skolem">ψ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="skolem">chi</span> <span class="bound">val'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">`</span> <span class="main">(</span>Pow <span class="free">A</span> <span class="main">×</span> Pow <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> fin <span class="keyword1"><span class="command">have</span></span> fin_UNT<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?UNT</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> nf<span class="main">:</span> <span class="quoted"><span class="quoted">"next_free <span class="skolem">psi'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">val</span><span class="main">.</span> <span class="bound">val</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> next_free <span class="main">(</span><span class="skolem">chi</span> <span class="bound">val</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chi_def finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fin fin_UNT psi <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> psi'_def finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> atoms_pltl<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="skolem">psi'</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> at_chi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">val</span><span class="main">.</span> <span class="bound">val</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> atoms_pltl <span class="main">(</span><span class="skolem">chi</span> <span class="bound">val</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chi_def finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fin psi <span class="keyword1"><span class="command">have</span></span> at_alw<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="main">(</span><span class="skolem">ψ</span> <span class="keyword1">and<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span>OR <span class="var">?ALW</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span><span class="main"><span class="keyword3">?</span></span>    <span class="comment1">(** FRAGILE: auto leaves trivial goal about subset **)</span>
    <span class="keyword1"><span class="command">from</span></span> fin fin_UNT psi at_chi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="main">(</span>OR <span class="var">?UNT</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span> <span class="comment1">(** FRAGILE: even more left-over goals here **)</span>
    <span class="keyword1"><span class="command">with</span></span> at_alw <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> psi'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span>
    <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_free <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> can<span class="main">:</span> <span class="quoted"><span class="quoted">"canonical_sequence <span class="free">A</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">psi'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹In the case of a stuttering transition at the beginning, we must have
        infinite stuttering, and the first disjunct of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>psi'›</span></span></span></span> holds,
        whereas the second does not.›</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> Suc
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> True st <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> stutter_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">note</span></span> alleq <span class="main">=</span> this
      <span class="keyword1"><span class="command">have</span></span> suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">σ</span><span class="main">[</span><span class="bound">n</span><span class="main">..]</span> <span class="main">=</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="skolem">n</span><span class="main">..]</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alleq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> alleq<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="skolem">n</span><span class="main">..]</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> st can psi <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="main">(</span><span class="skolem">stval</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chi1 characteristic_holds<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> suffix <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="keyword1">G<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="skolem">chi</span> <span class="main">(</span><span class="skolem">stval</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="var">?alw</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?alw</span> <span class="main">∈</span> <span class="var">?ALW</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stval_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> OR <span class="var">?ALW</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> semantics_pltl_sugar<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> OR <span class="var">?UNT</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> unt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> OR <span class="var">?UNT</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> fin_UNT <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="skolem"><span class="skolem">val'</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">val</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="main">≠</span> <span class="skolem">val</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          now<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="skolem">val</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="skolem">k</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="skolem">val'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>  <span class="comment1">(* FRAGILE: similar as above *)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">val</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span> now <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val</span> <span class="main">=</span> <span class="skolem">stval</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> chi2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">val'</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span> k suffix <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="main">=</span> <span class="skolem">stval</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chi2<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">val'</span> <span class="main">≠</span> <span class="skolem">val</span>›</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">from</span></span> 1 2 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi'_def<span class="main">)</span>

    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Otherwise, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ ⊨<span class="hidden">⇩</span><sub>p</sub> X<span class="hidden">⇩</span><sub>p</sub> φ›</span></span></span></span> is equivalent to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> satisfying
        the second disjunct of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>psi'›</span></span></span></span>. We show both implications separately.›</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?val</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">stval</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?val'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">stval</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> False can <span class="keyword1"><span class="command">have</span></span> vals<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?val'</span> <span class="main">≠</span> <span class="var">?val</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> canonical_sequence_def state_sim_def stval_def<span class="main">)</span>
        
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> phi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="var">?val</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chi1 characteristic_holds<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> st can <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stutter_free <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"canonical_sequence <span class="free">A</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_free_suffix canonical_suffix<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> phi psi <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> characteristic_formula <span class="free">A</span> <span class="main">(</span><span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> characteristic_holds<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="var">?val'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chi1<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> 1 2 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> And_ltlp <span class="main">(</span><span class="skolem">chi</span> <span class="var">?val</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">chi</span> <span class="var">?val</span><span class="main">)</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span>And_ltlp <span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">chi</span> <span class="var">?val'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="var">?unt</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> vals <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?unt</span> <span class="main">∈</span> <span class="var">?UNT</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stval_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> OR <span class="var">?UNT</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fin_UNT<span class="main">[</span><span class="operator">THEN</span> holds_of_OR<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">psi'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi'_def<span class="main">)</span>

      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> psi'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">psi'</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> OR <span class="var">?ALW</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> OR <span class="var">?ALW</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> fin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">val</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">n</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="skolem">val</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="main">0</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="skolem">val</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val</span> <span class="main">=</span> <span class="var">?val</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chi2<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="skolem">val</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val</span> <span class="main">=</span> <span class="var">?val'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> chi2<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> vals <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> psi' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> OR <span class="var">?UNT</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi'_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> fin_UNT <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="skolem"><span class="skolem">val'</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">val</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="main">≠</span> <span class="skolem">val</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          now<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="skolem">val</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="skolem">k</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="skolem">k</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="skolem">val'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="bound">i</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="skolem">val</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>  <span class="comment1">(* FRAGILE: similar as above *)</span>

        <span class="keyword1"><span class="command">from</span></span> val now <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">val</span> <span class="main">=</span> <span class="var">?val</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chi2<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">=</span><span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> val k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="main">=</span> <span class="var">?val</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chi2<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> 1 <span class="quoted"><span class="quoted">‹<span class="skolem">val'</span> <span class="main">≠</span> <span class="skolem">val</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">k</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">chi</span> <span class="skolem">val</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> characteristic_formula <span class="free">A</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chi1<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span> <span class="main">0</span><span class="main">)</span> <span class="main">~</span><span class="free">A</span><span class="main">~</span> <span class="main">(</span><span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> characteristic_state_sim<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">with</span></span> can <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canonical_sequence_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">σ</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">from</span></span> 2 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">=</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> st can <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stutter_free <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"canonical_sequence <span class="free">A</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">[</span><span class="main">1</span><span class="main">..]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_free_suffix canonical_suffix<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span><span class="main">[</span><span class="skolem">k</span><span class="main">..]</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span>›</span></span> psi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> nf atoms_pltl <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ'</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">φ</span><span class="main">)</span> <span class="bound">ψ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Comparing the definition of the next-free formula in the case of
  formulas <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X<span class="hidden">⇩</span><sub>p</sub> φ›</span></span></span></span> with the one that appears in~\cite{peled:ltl-x},
  there is a subtle difference. Peled and Wilke define the second disjunct as
  a disjunction of formulas
%
  \begin{center}\(
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(chi val) U<span class="hidden">⇩</span><sub>p</sub> (ψ and<span class="hidden">⇩</span><sub>p</sub> (chi val'))›</span></span></span></span>
  \)\end{center}
%
  for subsets <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>val, val' ⊆ A›</span></span></span></span> whereas we conjoin the formula
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>chi val›</span></span></span></span> to the ``until'' formula. This conjunct is indeed
  necessary in order to rule out the case of the ``until'' formula
  being true because of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>chi val'›</span></span></span></span> being true immediately.
  The subtle error in the definition of the formula was acknowledged 
  by Peled and Wilke and apparently had not been noticed since the 
  publication of~\cite{peled:ltl-x} in 1996 (which has been cited more
  than a hundred times according to Google Scholar). Although the error
  was corrected easily, the fact that authors, reviewers, and readers
  appear to have missed it for so long underscores the usefulness of
  formal proofs.

  We now show that any stuttering invariant PLTL formula
  can be expressed without the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X<span class="hidden">⇩</span><sub>p</sub>›</span></span></span></span> operator.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> stutter_invariant_next_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> phi<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ψ</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"next_free <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="free">ψ</span> <span class="main">⊆</span> atoms_pltl <span class="free">φ</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="free">φ</span> <span class="main">⊆</span> atoms_pltl <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>atoms_pltl <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    psi<span class="main">:</span> <span class="quoted"><span class="quoted">"next_free <span class="skolem">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"atoms_pltl <span class="skolem">ψ</span> <span class="main">⊆</span> atoms_pltl <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> stutter_free <span class="bound">σ</span> <span class="main">∧</span> canonical_sequence <span class="main">(</span>atoms_pltl <span class="free">φ</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ex_next_free_stutter_free_canonical<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹next_free <span class="skolem">ψ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> sinv<span class="main">:</span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> next_free_stutter_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">≃</span> atoms_pltl <span class="free">φ</span> <span class="main">≃</span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"canonical_sequence <span class="main">(</span>atoms_pltl <span class="free">φ</span><span class="main">)</span> <span class="skolem">τ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> canonical_exists<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="quoted"><span class="quoted">‹atoms_pltl <span class="skolem">ψ</span> <span class="main">⊆</span> atoms_pltl <span class="free">φ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">≃</span> atoms_pltl <span class="skolem">ψ</span> <span class="main">≃</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> seq_sim_mono<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pltl_seq_sim<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> phi stutter_reduced_equivalent <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">♮</span><span class="skolem">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 2<span class="main">[</span><span class="operator">THEN</span> canonical_reduced<span class="main">]</span> equiv stutter_reduced_stutter_free 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">♮</span><span class="skolem">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sinv stutter_reduced_equivalent <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pltl_seq_sim<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> psi that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Combining theorems <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>next_free_stutter_invariant›</span></span></span></span> and
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>stutter_invariant_next_free›</span></span></span></span>, it follows that a PLTL
  formula is stuttering invariant iff it is equivalent to a next-free
  formula.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> pltl_stutter_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stutter_invariant <span class="free">φ</span> <span class="main">⟷</span> 
   <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> next_free <span class="bound">ψ</span> <span class="main">∧</span> atoms_pltl <span class="bound">ψ</span> <span class="main">⊆</span> atoms_pltl <span class="free">φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">ψ</span> <span class="main">⟷</span> <span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> next_free <span class="bound">ψ</span> <span class="main">∧</span> atoms_pltl <span class="bound">ψ</span> <span class="main">⊆</span> atoms_pltl <span class="free">φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">ψ</span> <span class="main">⟷</span> <span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_invariant_next_free<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"next_free <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">ψ</span> <span class="main">⟷</span> <span class="bound">σ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> next_free_stutter_invariant<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stutter_invariant <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stutter Invariance for LTL with Syntactic Sugar›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We lift the results for PLTL to an extensive version of LTL.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ltlc_next_free</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltlc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">=</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">=</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="keyword1">prop<span class="hidden">⇩</span><sub>c</sub>(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="keyword1">not<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">implies<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="keyword1">F<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="keyword1">G<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltlc_next_free</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">ltlc_next_free</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltlc_next_free_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"next_free <span class="main">(</span>ltlc_to_pltl <span class="free">φ</span><span class="main">)</span> <span class="main">⟷</span> ltlc_next_free <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A next free formula cannot distinguish between stutter-equivalent runs.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ltlc_next_free_stutter_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> next_free<span class="main">:</span> <span class="quoted"><span class="quoted">"ltlc_next_free <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≈</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">r'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≈</span> <span class="skolem">r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> holds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span>ltlc_to_pltl <span class="free">φ</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> next_free_stutter_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ltlc_to_pltl <span class="free">φ</span>"</span></span><span class="main">]</span> next_free
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"PLTL.stutter_invariant <span class="main">(</span>ltlc_to_pltl <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> stutter_invariantD<span class="main">[</span><span class="operator">OF</span> this eq<span class="main">]</span> holds <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux<span class="main">=</span>this

  <span class="keyword1"><span class="command">from</span></span> aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">r'</span></span><span class="main">]</span> aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r'</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> eq stutter_equiv_sym<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>