<div id="Dynamic_Array">
<div class="head">
<h1>Theory Dynamic_Array</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Arrays with Dynamic Resizing›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Dynamic_Array
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Refine_Imperative_HOL/IICF_List.html">Refine_Imperative_HOL.IICF_List</a>"</span> <span class="quoted">"<a href="../Separation_Logic_Imperative_HOL/Array_Blit.html">Separation_Logic_Imperative_HOL.Array_Blit</a>"</span> <span class="quoted">"<a href="../Refine_Imperative_HOL/IICF_Array.html">Refine_Imperative_HOL.IICF_Array</a>"</span> <span class="quoted">"<a href="../Refine_Imperative_HOL/IICF_Map.html">Refine_Imperative_HOL.IICF_Map</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: Move to Array_Blit *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">array_grow'</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">l</span><span class="main">←</span>Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
  <span class="bound">a'</span><span class="main">←</span>Array.new <span class="main">(</span><span class="bound">l</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
  blit <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span> <span class="bound">a'</span> <span class="main">0</span> <span class="bound">l</span><span class="main">;</span>
  return <span class="bound">a'</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Dynamic_Array-array_grow'_rule"><span class="command">lemma</span></span> array_grow'_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
    <span class="main">&lt;</span> <span class="free">a</span><span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span><span class="free">la</span> <span class="main">&gt;</span> 
      array_grow' <span class="free">a</span> <span class="free">n</span> <span class="free">x</span> 
    <span class="main">&lt;</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="bound">a'</span><span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span><span class="free">la</span> <span class="main">@</span> replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> array_grow'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="comment1">(* TODO: Move to IICF_List *)</span>
<span class="keyword1"><span class="command">sepref_decl_op</span></span> list_grow<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span> <span class="bound">n</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">xs</span><span class="main">@</span>replicate <span class="bound">n</span> <span class="bound">x</span>"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel <span class="main">→</span> nat_rel <span class="main">→</span> <span class="free">A</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel"</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nff_α</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_nff</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span><span class="bound">l</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound">l</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> nff_α <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dyn_array_new_sz</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> Array.new <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span>"</span></span>

<span class="keyword1" id="Dynamic_Array-dyn_array_new_sz_rl"><span class="command">lemma</span></span> dyn_array_new_sz_rl<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> dyn_array_new_sz <span class="free">dflt</span> <span class="free">n</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_nff <span class="free">dflt</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">dflt</span><span class="main">)</span> <span class="bound">r</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dyn_array_new_sz_def is_nff_def nff_α_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">array_get_dyn</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="comment1">⌦‹‹nth_oo dflt a i››</span>
  <span class="bound">l</span> <span class="main">←</span> Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&lt;</span><span class="bound">l</span> <span class="keyword1">then</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> return <span class="free"><span class="bound"><span class="entity">dflt</span></span></span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Dynamic_Array-array_get_dyn_rule"><span class="command">lemma</span></span> array_get_dyn_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">&lt;</span> is_nff <span class="free">dflt</span> <span class="free">f</span> <span class="free">a</span> <span class="main">&gt;</span> 
    array_get_dyn <span class="free">dflt</span> <span class="free">a</span> <span class="free">i</span> 
  <span class="main">&lt;</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_nff <span class="free">dflt</span> <span class="free">f</span> <span class="free">a</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> array_get_dyn_def nth_oo_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nff_α_def is_nff_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">array_set_dyn</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">l</span> <span class="main">←</span> Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&lt;</span><span class="bound">l</span> <span class="keyword1">then</span> 
    Array.upd <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> 
  <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">ns</span> <span class="main">=</span> max <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">a</span> <span class="main">←</span> array_grow <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">ns</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span><span class="main">;</span>
    Array.upd <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">a</span>
  <span class="main">}</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Dynamic_Array-nff_α_upd"><span class="command">lemma</span></span> nff_α_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> nff_α <span class="free">dflt</span> <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nff_α <span class="free">dflt</span> <span class="free">l</span><span class="main">)</span><span class="main">(</span><span class="free">i</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nff_α_def<span class="main">)</span>

<span class="keyword1" id="Dynamic_Array-nff_α_append_default"><span class="command">lemma</span></span> nff_α_append_default<span class="main">:</span> <span class="quoted"><span class="quoted">"nff_α <span class="free">dflt</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span>replicate <span class="free">n</span> <span class="free">dflt</span><span class="main">)</span> <span class="main">=</span> nff_α <span class="free">dflt</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nff_α_def nth_append <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1" id="Dynamic_Array-array_set_dyn_rule"><span class="command">lemma</span></span> array_set_dyn_rule<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">&lt;</span> is_nff <span class="free">dflt</span> <span class="free">f</span> <span class="free">a</span> <span class="main">&gt;</span>
    array_set_dyn <span class="free">dflt</span> <span class="free">a</span> <span class="free">i</span> <span class="free">v</span>
  <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> is_nff <span class="free">dflt</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>  
  "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> array_set_dyn_def is_nff_def upd_oo_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nff_α_upd nff_α_append_default<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="DRAT_Misc">
<div class="head">
<h1>Theory DRAT_Misc</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> DRAT_Misc
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Refine_Imperative_HOL/IICF.html">Refine_Imperative_HOL.IICF</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
  <span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Word.slice

    
    
<span class="comment1">(** NOT MOVED **)</span>    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Maybe-Head Insertion into Distinct List›</span></span>    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Insertion into distinct list, where the inserted element is either the head of the list, or
  not contained into the list. Useful to avoid duplicate insertions into the 
  literal-&gt;clause map.
›</span></span>  
    
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mbhd_invar</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> distinct <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">∉</span>set <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">mbhd_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">=</span><span class="main">[]</span> <span class="keyword1">then</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1" id="DRAT_Misc-mbhd_insert_invar"><span class="command">lemma</span></span> mbhd_insert_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"mbhd_invar <span class="free">x</span> <span class="free">l</span> <span class="main">⟹</span> mbhd_invar <span class="free">x</span> <span class="main">(</span>mbhd_insert <span class="free">x</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mbhd_invar_def mbhd_insert_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="DRAT_Misc-mbhd_insert_correct"><span class="command">lemma</span></span> mbhd_insert_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>mbhd_insert <span class="free">x</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mbhd_insert_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DRAT_Misc-mbhd_invar_init"><span class="command">lemma</span></span> mbhd_invar_init<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">l</span> <span class="main">∧</span> <span class="free">x</span><span class="main">∉</span>set <span class="free">l</span> <span class="main">⟹</span> mbhd_invar <span class="free">x</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mbhd_invar_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="DRAT_Misc-mbhd_invar_exit"><span class="command">lemma</span></span> mbhd_invar_exit<span class="main">:</span> <span class="quoted"><span class="quoted">"mbhd_invar <span class="free">x</span> <span class="free">l</span> <span class="main">⟹</span> distinct <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mbhd_invar_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Array_Map_Default">
<div class="head">
<h1>Theory Array_Map_Default</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Options and Maps with Default Value for None›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Array_Map_Default
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Dynamic_Array.html">Dynamic_Array</a> <a href="DRAT_Misc.html">DRAT_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Implements maps from natural numbers to any value type that has an 
    unused default value in its implementation type. 
    Internally, uses a dynamic array.
    ›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_unused_elem</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
  <span class="keyword1" id="Array_Map_Default-is_unused_elem_pure"><span class="command">lemma</span></span> is_unused_elem_pure<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"is_unused_elem <span class="free">dflt</span> <span class="main">(</span>pure <span class="free">R</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">dflt</span> <span class="main">∉</span> Domain <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_unused_elem_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_rel_eq_false_iff<span class="main">)</span>
  
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dflt_option_rel_aux</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> 
    <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dflt</span></span></span><span class="main">,</span>None<span class="main">)</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> Some <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">≠</span><span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dflt_option_assn</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> 
    <span class="main">≡</span> pure <span class="main">(</span>dflt_option_rel_aux <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="keyword1">O</span> <span class="main">⟨</span>the_pure <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟩</span>option_rel<span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Function-Level Map Operations›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We justify the map operations implemented by a function›</span></span>
  <span class="keyword1" id="Array_Map_Default-amd1_empty_refine"><span class="command">lemma</span></span> amd1_empty_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry0 <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">dflt</span><span class="main">)</span><span class="main">,</span> uncurry0 op_map_empty<span class="main">)</span> 
    <span class="main">∈</span> Id <span class="keyword1">→<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span>Id <span class="main">→</span> dflt_option_rel_aux <span class="free">dflt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dflt_option_rel_aux_def fref_def<span class="main">)</span>
  
  <span class="keyword1" id="Array_Map_Default-amd1_lookup_refine"><span class="command">lemma</span></span> amd1_lookup_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">,</span> op_map_lookup<span class="main">)</span> 
    <span class="main">∈</span> Id <span class="main">→</span> <span class="main">(</span>Id <span class="main">→</span> dflt_option_rel_aux <span class="free">dflt</span><span class="main">)</span> <span class="main">→</span> dflt_option_rel_aux <span class="free">dflt</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  
  <span class="keyword1" id="Array_Map_Default-amd1_update_refine"><span class="command">lemma</span></span> amd1_update_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry2 <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">v</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">k</span><span class="main">:=</span><span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> uncurry2 op_map_update<span class="main">)</span> 
    <span class="main">∈</span> <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span><span class="main">≠</span><span class="free">dflt</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub></span> 
      <span class="main">(</span><span class="main">(</span>Id <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> Id<span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span>Id <span class="main">→</span> dflt_option_rel_aux <span class="free">dflt</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">→</span> <span class="main">(</span>Id <span class="main">→</span> dflt_option_rel_aux <span class="free">dflt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> op_map_update_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frefI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">applyS</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dflt_option_rel_aux_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">applyS</span></span></span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">amd1_delete</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> fun_upd <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span>"</span></span>
  <span class="keyword1" id="Array_Map_Default-amd1_delete_refine"><span class="command">lemma</span></span> amd1_delete_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry <span class="main">(</span>amd1_delete <span class="free">dflt</span><span class="main">)</span><span class="main">,</span> uncurry op_map_delete<span class="main">)</span> 
    <span class="main">∈</span> Id <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span>Id <span class="main">→</span> dflt_option_rel_aux <span class="free">dflt</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span>Id <span class="main">→</span> dflt_option_rel_aux <span class="free">dflt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> op_map_delete_def PR_CONST_def amd1_delete_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> frefI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dflt_option_rel_aux_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Map Operations, array-level›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We use dynamic arrays to implement the function, and combine both to 
      implement the map interface.›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">amd_empty</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="main">≡</span> dyn_array_new_sz <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="numeral">16</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">amd_lookup</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> array_get_dyn <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">amd_update</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> array_set_dyn <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">amd_delete</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> array_set_dyn <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span>"</span></span>
 
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">amd_assn</span> <span class="free"><span class="bound"><span class="entity">dflt</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> 
    <span class="main">≡</span> hr_comp <span class="main">(</span>hr_comp 
        <span class="main">(</span>is_nff <span class="free"><span class="bound"><span class="entity">dflt</span></span></span><span class="main">)</span> 
        <span class="main">(</span>nat_rel <span class="keyword1">→<span class="hidden">⇩</span><sub>f</sub></span> dflt_option_rel_aux <span class="free"><span class="bound"><span class="entity">dflt</span></span></span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span><span class="main">⟨</span>the_pure <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> the_pure <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">⟩</span>map_rel<span class="main">)</span>"</span></span>
    
  <span class="keyword1" id="Array_Map_Default-amd_assn_fold2"><span class="command">lemma</span></span> amd_assn_fold2<span class="main">:</span> <span class="quoted"><span class="quoted">"hr_comp <span class="main">(</span>hr_comp 
      <span class="main">(</span>is_nff <span class="free">dflt</span><span class="main">)</span> 
      <span class="main">(</span>nat_rel <span class="main">→</span> dflt_option_rel_aux <span class="free">dflt</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">⟨</span>the_pure <span class="free">K</span><span class="main">,</span> the_pure <span class="free">V</span><span class="main">⟩</span>map_rel<span class="main">)</span> 
    <span class="main">=</span> amd_assn <span class="free">dflt</span> <span class="free">K</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> amd_assn_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fo_rule</span> fun_cong arg_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fref_def fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="comment1">(* TODO: Move *)</span>
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">intf_of_assn</span><span class="main">]</span> 
    <span class="main">=</span> intf_of_assnI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"amd_assn <span class="free">dflt</span> <span class="free">K</span> <span class="free">V</span>"</span></span> 
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span><span class="tfree">'vv</span><span class="main">)</span> i_map"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">dflt</span> <span class="free">K</span> <span class="free">V</span><span class="main">]</span>
  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span> 
    <span class="main">=</span> CN_FALSEI<span class="main">[</span><span class="operator">of</span> <span class="quoted">is_pure</span> <span class="quoted"><span class="quoted">"amd_assn <span class="free">dflt</span> <span class="free">K</span> <span class="free">V</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">dflt</span> <span class="free">K</span> <span class="free">V</span><span class="main">]</span>
    
    
<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">fcomp_norm_unfold</span><span class="main">]</span> <span class="main">=</span> 
    amd_assn_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> dflt_option_assn_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> amd_assn_fold2
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span> <span class="main">=</span> hfrefI hn_refineI<span class="main">[</span><span class="operator">THEN</span> hn_refine_preI<span class="main">]</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> pure_def hn_ctxt_def invalid_assn_def 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dflt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>  
  <span class="keyword1" id="Array_Map_Default-amd2_empty_refine"><span class="command">lemma</span></span> amd2_empty_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry0 <span class="main">(</span>amd_empty <span class="free">dflt</span><span class="main">)</span><span class="main">,</span> uncurry0 <span class="main">(</span>RETURN <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">dflt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∈</span> unit_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> is_nff <span class="free">dflt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> amd_empty_def<span class="main">)</span>

  <span class="keyword1" id="Array_Map_Default-amd2_lookup_refine"><span class="command">lemma</span></span> amd2_lookup_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry <span class="main">(</span>amd_lookup <span class="free">dflt</span><span class="main">)</span><span class="main">,</span> uncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∈</span> id_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span><span class="main">(</span>is_nff <span class="free">dflt</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> id_assn"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> amd_lookup_def<span class="main">)</span>

  <span class="keyword1" id="Array_Map_Default-amd2_update_refine"><span class="command">lemma</span></span> amd2_update_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry2 <span class="main">(</span>amd_update <span class="free">dflt</span><span class="main">)</span><span class="main">,</span> uncurry2 <span class="main">(</span>RETURN <span class="keyword1">ooo</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">v</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="bound">k</span><span class="main">:=</span><span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∈</span> id_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span>id_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span><span class="main">(</span>is_nff <span class="free">dflt</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> is_nff <span class="free">dflt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> amd_update_def<span class="main">)</span>

  <span class="keyword1" id="Array_Map_Default-amd2_delete_refine"><span class="command">lemma</span></span> amd2_delete_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry <span class="main">(</span>amd_delete <span class="free">dflt</span><span class="main">)</span><span class="main">,</span> uncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> <span class="main">(</span>amd1_delete <span class="free">dflt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∈</span> id_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span><span class="main">(</span>is_nff <span class="free">dflt</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> is_nff <span class="free">dflt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> amd_delete_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">sepref_decl_impl</span></span> <span class="main">(</span>no_register<span class="main">)</span> amd_empty<span class="main">:</span> 
    amd2_empty_refine<span class="main">[</span><span class="operator">FCOMP</span> amd1_empty_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> dflt<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">dflt</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_amd_empty</span> <span class="main">≡</span> op_map_empty"</span></span>    
    
  <span class="keyword1"><span class="command">sepref_decl_impl</span></span> 
    amd2_lookup_refine<span class="main">[</span><span class="operator">FCOMP</span> amd1_lookup_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> dflt<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">dflt</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">sepref_decl_impl</span></span> 
    amd2_delete_refine<span class="main">[</span><span class="operator">FCOMP</span> amd1_delete_refine<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> dflt<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">dflt</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The only complication arises for the update operation, where we have 
    to use the fact that the default element is invalid, which forces us to do
    a manual composition proof.›</span></span>
  <span class="keyword1" id="Array_Map_Default-amd2_update_hnr_aux"><span class="command">lemma</span></span> amd2_update_hnr_aux<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CONSTRAINT <span class="main">(</span>IS_PURE single_valued<span class="main">)</span> <span class="free">K</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"CONSTRAINT <span class="main">(</span>IS_PURE IS_LEFT_UNIQUE<span class="main">)</span> <span class="free">K</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"CONSTRAINT is_pure <span class="free">V</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"CONSTRAINT <span class="main">(</span>is_unused_elem <span class="free">dflt</span><span class="main">)</span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry2 <span class="main">(</span>amd_update <span class="free">dflt</span><span class="main">)</span><span class="main">,</span> uncurry2 <span class="main">(</span>RETURN <span class="main">∘∘∘</span> op_map_update<span class="main">)</span><span class="main">)</span>
           <span class="main">∈</span>  <span class="free">K</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">V</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>amd_assn <span class="free">dflt</span> <span class="free">K</span> <span class="free">V</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> amd_assn <span class="free">dflt</span> <span class="free">K</span> <span class="free">V</span>"</span></span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 
        hfref_cons<span class="main"><span class="main">[</span></span>
          <span class="operator">OF</span> amd2_update_refine<span class="main"><span class="main"><span class="main">[</span></span></span>
                <span class="operator">FCOMP</span> amd1_update_refine<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> dflt<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span><span class="quoted"><span class="free">dflt</span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> 
                <span class="operator">FCOMP</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">no_prenorm</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> op_map_update.fref<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free">K</span></span> <span class="quoted"><span class="free">V</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IS_PURE_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IS_PURE_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IS_PURE_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IS_PURE_def IS_LEFT_UNIQUE_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> pure_def
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_PRE_def IS_PURE_def is_unused_elem_def is_pure_conv 
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_rel_eq_false_iff 
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod_relE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">applyS</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">applyS</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">applyS</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="comment1">(* TODO: Somewhat of a hack. Perhaps add a flag to switch of 
      automatic parameterization on sepref_decl_impl? *)</span>
  <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Array_Map_Default-op_map_update_id_param"><span class="command">lemma</span></span> op_map_update_id_param<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry2 <span class="main">(</span>RETURN <span class="main">∘∘∘</span> op_map_update<span class="main">)</span><span class="main">,</span> uncurry2 <span class="main">(</span>RETURN <span class="main">∘∘∘</span> op_map_update<span class="main">)</span><span class="main">)</span> 
    <span class="main">∈</span> <span class="main">(</span>Id<span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span>Id<span class="main">)</span><span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span>Id <span class="keyword1">→<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟨</span>Id<span class="main">⟩</span>nres_rel"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fref_def nres_rel_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">sepref_decl_impl</span></span> amd2_update_hnr_aux <span class="keyword2"><span class="keyword">uses</span></span> op_map_update_id_param <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>  

<span class="keyword1"><span class="command">interpretation</span></span> amd<span class="main">:</span> map_custom_empty <span class="quoted">op_amd_empty</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span> amd_empty_hnr<span class="main">[</span><span class="operator">folded</span> op_amd_empty_def<span class="main">]</span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations on Options›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We give own names to constructors, otherwise, we will get confusions 
  with the default option refinement.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dflt_None</span> <span class="main">≡</span> None"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dflt_Some</span> <span class="main">≡</span> Some"</span></span>
<span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">dflt_None</span> <span class="quoted">dflt_Some</span>

<span class="keyword1" id="Array_Map_Default-doa_None_hnr"><span class="command">lemma</span></span> doa_None_hnr<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry0 <span class="main">(</span>return <span class="free">dflt</span><span class="main">)</span><span class="main">,</span> uncurry0 <span class="main">(</span>RETURN dflt_None<span class="main">)</span><span class="main">)</span> 
  <span class="main">∈</span> unit_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> dflt_option_assn <span class="free">dflt</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_def dflt_option_rel_aux_def dflt_option_assn_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1" id="Array_Map_Default-doa_Some_hnr"><span class="command">lemma</span></span> doa_Some_hnr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CONSTRAINT <span class="main">(</span>is_unused_elem <span class="free">dflt</span><span class="main">)</span> <span class="free">A</span><span class="main">;</span> CONSTRAINT is_pure <span class="free">A</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>return <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> RETURN <span class="keyword1">o</span> dflt_Some<span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> dflt_option_assn <span class="free">dflt</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_pure_conv dflt_option_assn_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dflt_option_rel_aux_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1" id="Array_Map_Default-doa_is_None_hnr"><span class="command">lemma</span></span> doa_is_None_hnr<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>return <span class="keyword1">o</span> <span class="main">(</span><span class="main">(=)</span> <span class="free">dflt</span><span class="main">)</span><span class="main">,</span> RETURN <span class="keyword1">o</span> is_None<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span>dflt_option_assn <span class="free">dflt</span> <span class="free">A</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> bool_assn"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> 
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dflt_option_assn_def pure_def dflt_option_rel_aux_def 
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="Array_Map_Default-doa_the_hnr"><span class="command">lemma</span></span> doa_the_hnr<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CONSTRAINT is_pure <span class="free">A</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>return <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> RETURN <span class="keyword1">o</span> the<span class="main">)</span> 
      <span class="main">∈</span> <span class="main">[</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">≠</span>None<span class="keyword1">]<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>dflt_option_assn <span class="free">dflt</span> <span class="free">A</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="main">→</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sepref_to_hoare</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_pure_conv dflt_option_assn_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_def dflt_option_rel_aux_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* TODO: Add proper rule for case distinction *)</span>

<span class="comment1">(* Workaround for case-distinction: Rewrite with abstract-level rule: *)</span>
<span class="keyword1" id="Array_Map_Default-cnv_option_case_2_if"><span class="command">lemma</span></span> cnv_option_case_2_if<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">fn</span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">fv</span> <span class="bound">v</span><span class="main">)</span> 
  <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> is_None <span class="free">x</span> <span class="keyword1">then</span> <span class="free">fn</span> <span class="keyword1">else</span> <span class="free">fv</span> <span class="main">(</span>the <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="comment1">(* TODO: Hack:
  Due to lack of recursive generic algorithms with specialization, 
  we have instantiated equality on options as combinator rule. 
  This allows no backtracking or alternatives.
  Thus, we do a type-based rewriting of option-equalities for dflt-option 
  types in operator-id phase.
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dflt_option_eq</span> <span class="main">≡</span> <span class="main">(=)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> dflt_option <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> assn"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dflt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool Heap"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unused_dflt<span class="main">[</span><span class="operator">safe_constraint_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>is_unused_elem <span class="free">dflt</span><span class="main">)</span> <span class="free">A</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> eq_op<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry <span class="free">eq</span><span class="main">,</span> uncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> <span class="main">(=)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span><span class="free">A</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span>bool_assn"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_dflt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span><span class="main">=</span><span class="free">dflt</span> <span class="main">∨</span> <span class="bound">b</span><span class="main">=</span><span class="free">dflt</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> <span class="free">eq</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="bound">a</span><span class="main">=</span><span class="bound">b</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="comment1">(* Type-based rewrites. 
      TODO: We would prefer type-based specializations in translate-phase! *)</span>
  <span class="keyword1" id="Array_Map_Default-fold_dflt_option"><span class="command">lemma</span></span> fold_dflt_option<span class="main">[</span><span class="operator">def_pat_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>None<span class="main">::</span><span class="tfree">'a</span> option<span class="main">)</span> <span class="main">≡</span> dflt_None"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Some<span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="main">_</span><span class="main">)</span> <span class="main">≡</span> dflt_Some"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span><span class="main">::</span><span class="tfree">'a</span> option <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">≡</span> dflt_option_eq"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(* Constructors *)</span>
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span> 
    doa_None_hnr<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> dflt <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">dflt</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    doa_Some_hnr<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> dflt <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">dflt</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">A</span></span><span class="main">]</span>

  <span class="keyword1" id="Array_Map_Default-eq_option_refine"><span class="command">lemma</span></span> eq_option_refine<span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CONSTRAINT is_pure <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry <span class="free">eq</span><span class="main">,</span>uncurry <span class="main">(</span>RETURN <span class="keyword1">oo</span> dflt_option_eq<span class="main">)</span><span class="main">)</span> 
      <span class="main">∈</span> <span class="main">(</span>dflt_option_assn <span class="free">dflt</span> <span class="free">A</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>dflt_option_assn <span class="free">dflt</span> <span class="free">A</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> bool_assn"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> pure <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_pure_conv<span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span> eq_op <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">x'</span><span class="main">)</span><span class="main">∈</span><span class="skolem">R</span><span class="main">;</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">y'</span><span class="main">)</span><span class="main">∈</span><span class="skolem">R</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> <span class="free">eq</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">⟷</span> <span class="skolem">x'</span><span class="main">=</span><span class="skolem">y'</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">y</span> <span class="skolem">y'</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> hfrefD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span><span class="skolem">y'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> hn_refineD<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Hoare_Triple.cons_post_rule<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sep_auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simplified</span><span class="main">,</span><span class="operator">sep_heap_rules</span><span class="main">]</span> 
      <span class="main">=</span> eq_dflt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">dflt</span></span> <span class="quoted"><span class="free">dflt</span></span><span class="main">]</span> eq_dflt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">dflt</span></span><span class="main">]</span> eq_dflt<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">dflt</span></span><span class="main">]</span> 
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_to_hoare</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dflt_option_assn_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pure_def dflt_option_rel_aux_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option_relE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>  
    
    
    
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Synth_Definition">
<div class="head">
<h1>Theory Synth_Definition</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Synth_Definition
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Automatic_Refinement/Refine_Lib.html">Automatic_Refinement.Refine_Lib</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Rewrite.html">HOL-Library.Rewrite</a>"</span>
  <span class="quoted">"<a href="../Refine_Imperative_HOL/Sepref_Misc.html">Refine_Imperative_HOL.Sepref_Misc</a>"</span> <span class="comment1">(* FIXME: Some stuff we depend on has not yet been moved out from there! *)</span>
<span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"synth_definition"</span> <span class="main">::</span> thy_goal
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="comment1">(*
    Provides the command synth_definition, which proves a schematic goal with a hole, and defines
    the hole as a constant.
  *)</span>
  <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Synth_Definition</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="comment1">(*val cfg_prep_code = Attrib.setup_config_bool @{binding synth_definition_prep_code} (K false)*)</span>
      
    <span class="keyword2"><span class="keyword">local</span></span> 
      <span class="keyword3"><span class="keyword">open</span></span> Refine_Util
      <span class="comment1">(*val flags = parse_bool_config' "prep_code" cfg_prep_code
      val parse_flags = parse_paren_list' flags  *)</span>

    <span class="keyword2"><span class="keyword">in</span></span>       
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sd_parser</span> <span class="main">=</span> <span class="comment1">(*parse_flags --*)</span> Parse.binding -- Parse.opt_attribs --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">is</span>"<span class="antiquote">}</span></span></span> 
        -- Scan.optional <span class="main">(</span>Parse.attribs --| Parse.$$$ <span class="inner_quoted">":"</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> -- Parse.term 
    <span class="keyword2"><span class="keyword">end</span></span>  

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prep_term</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nidx</span> <span class="main">=</span> maxidx_of_term <span class="entity">t</span> + <span class="inner_numeral">1</span>
    
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> map_aterms <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> 
            <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">mpat</span> <span class="main">(</span><span class="quasi_keyword">typs</span><span class="main">)</span> <span class="quoted">"<span class="main">⌑</span><span class="main">::</span><span class="tvar">?'v_T</span>"</span><span class="antiquote">}</span></span></span> <span class="main">=&gt;</span> Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"HOLE"</span><span class="main">,</span><span class="entity">nidx</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">v</span> <span class="keyword1"><span class="keyword">as</span></span> Var <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> String.isPrefix <span class="inner_quoted">"_"</span> <span class="entity">name</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">v</span> <span class="keyword2"><span class="keyword">else</span></span> Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"_"</span>^<span class="entity">name</span><span class="main">,</span><span class="entity">nidx</span><span class="main">)</span><span class="main">,</span><span class="entity">T</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">t</span>
        <span class="main">)</span> <span class="entity">t</span>
      |&gt; Term_Subst.zero_var_indexes
    
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">t</span>
    <span class="keyword2"><span class="keyword">end</span></span>


    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sd_cmd</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="entity">attribs_raw</span><span class="main">)</span><span class="main">,</span><span class="entity">attribs2_raw</span><span class="main">)</span><span class="main">,</span><span class="entity">t_raw</span><span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword2"><span class="keyword">local</span></span>
        <span class="comment1">(*val ctxt = Refine_Util.apply_configs flags lthy*)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="comment1">(*val flag_prep_code = Config.get ctxt cfg_prep_code*)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read</span> <span class="main">=</span> Syntax.read_prop <span class="main">(</span>Proof_Context.set_mode Proof_Context.mode_pattern <span class="entity">lthy</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t_raw</span> |&gt; <span class="entity">read</span> |&gt; <span class="entity">prep_term</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Variable.declare_term <span class="entity">t</span> <span class="entity">lthy</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pat</span><span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">t</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span><span class="main">=</span><span class="entity">t</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">attribs2</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">Attrib.check_src</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">attribs2_raw</span><span class="main">;</span>
      
      
      <span class="keyword1"><span class="keyword">fun</span></span> 
        <span class="entity">after_qed</span> <span class="main">[</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> singleton <span class="main">(</span>Variable.export <span class="entity">ctxt</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">thm</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> 
              <span class="main">=</span> Local_Theory.note 
                 <span class="main">(</span><span class="main">(</span><span class="entity">Refine_Automation.mk_qualified</span> <span class="main">(</span>Binding.name_of <span class="entity">name</span><span class="main">)</span> <span class="inner_quoted">"refine_raw"</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span> 
                 <span class="entity">lthy</span><span class="main">;</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">dthm</span><span class="main">,</span><span class="entity">rthm</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Refine_Automation.define_concrete_fun</span> NONE <span class="entity">name</span> <span class="entity">attribs_raw</span> <span class="main">[</span><span class="main">]</span> <span class="entity">thm</span> <span class="main">[</span><span class="entity">pat</span><span class="main">]</span> <span class="entity">lthy</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> Local_Theory.note <span class="main">(</span><span class="main">(</span>Binding.empty<span class="main">,</span><span class="entity">attribs2</span><span class="main">)</span><span class="main">,</span><span class="main">[</span><span class="entity">rthm</span><span class="main">]</span><span class="main">)</span> <span class="entity">lthy</span>
            
            <span class="comment1">(* FIXME: Does not work, as we cannot see the default extraction patterns!
            val lthy = lthy 
              |&gt; flag_prep_code ? Refine_Automation.extract_recursion_eqs 
                [Sepref_Extraction.heap_extraction] (Binding.name_of name) dthm
            *)</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Thm.pretty_thm <span class="entity">lthy</span> <span class="entity">dthm</span> |&gt; Pretty.string_of |&gt; writeln
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Thm.pretty_thm <span class="entity">lthy</span> <span class="entity">rthm</span> |&gt; Pretty.string_of |&gt; writeln
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="entity">lthy</span>
          <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="entity">after_qed</span> <span class="entity">thmss</span> <span class="main">_</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"After-qed: Wrong thmss structure"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span>flat <span class="entity">thmss</span><span class="main">)</span>

    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">Proof.theorem</span> NONE <span class="entity">after_qed</span> <span class="main">[</span><span class="main">[</span> <span class="main">(</span><span class="entity">goal</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">]</span><span class="main">]</span> <span class="entity">ctxt</span>
    <span class="keyword2"><span class="keyword">end</span></span>



    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> "<span class="keyword1">synth_definition</span>"<span class="antiquote">}</span></span></span>
      <span class="inner_quoted">"Synthesis of constant"</span>
      <span class="main">(</span><span class="entity">sd_parser</span> &gt;&gt; <span class="entity">sd_cmd</span><span class="main">)</span>
      
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Exc_Nres_Monad">
<div class="head">
<h1>Theory Exc_Nres_Monad</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Exception Monad for Refine-Monadic›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Exc_Nres_Monad
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Refine_Monadic/Refine_Monadic.html">Refine_Monadic.Refine_Monadic</a>"</span> <a href="DRAT_Misc.html">DRAT_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*
  TODO:
    * Integrate with sepref --- currently, it's "integrated" by providing 
        some support to translate the program in to a plain nres monad before 
        sepref is invoked.
    * Move to Refine_Monadic.
*)</span>
  
<span class="keyword1"><span class="command">declare</span></span> TrueI<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> enres <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> nres"</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> enres_unfolds <span class="quoted">‹Unfolding theorems from enres to nres›</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ERETURN</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> RETURN <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ebind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> enres <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> enres<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> enres"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ebind</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span>
    <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="bound">e</span> <span class="main">⇒</span> RETURN <span class="main">(</span>Inl <span class="bound">e</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span>
  <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">THROW</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">==</span> RETURN <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ESPEC</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">Ψ</span></span></span> <span class="main">≡</span> SPEC <span class="main">(</span><span class="main">λ</span>Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="bound">e</span> <span class="main">|</span> Inr <span class="bound">r</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">Ψ</span></span></span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CATCH</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">r</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span> <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">e</span> <span class="main">|</span> Inr <span class="bound">r</span> <span class="main">⇒</span> RETURN <span class="main">(</span>Inr <span class="bound">r</span><span class="main">)</span> <span class="main">}</span>"</span></span>



<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>do_notation<span class="main">)</span> <span class="entity">bind_doE</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bind_doE</span> <span class="main">≡</span> ebind"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> bind_doE <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⤜</span>"</span> 54<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>ASCII <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> bind_doE <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&gt;&gt;=</span>"</span> 54<span class="main">)</span>


<span class="keyword1"><span class="command">nonterminal</span></span> doE_binds <span class="keyword2"><span class="keyword">and</span></span> doE_bind
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_doE_block"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"doE_binds <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">doE</span> <span class="keyword1">{</span><span class="keyword3">//</span><span class="keyword3">(2</span>  _<span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">}</span>"</span> <span class="main">[</span>12<span class="main">]</span> 62<span class="main">)</span>
  <span class="quoted">"_doE_bind"</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> doE_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">←</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> 13<span class="main">)</span>
  <span class="quoted">"_doE_let"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> doE_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">let</span> _ <span class="keyword1">=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 13<span class="main">]</span> 13<span class="main">)</span>
  <span class="quoted">"_doE_then"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> doE_bind"</span></span> <span class="main">(</span><span class="quoted">"_"</span> <span class="main">[</span>14<span class="main">]</span> 13<span class="main">)</span>
  <span class="quoted">"_doE_final"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> doE_binds"</span></span> <span class="main">(</span><span class="quoted">"_"</span><span class="main">)</span>
  <span class="quoted">"_doE_cons"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>doE_bind<span class="main">,</span> doE_binds<span class="main">]</span> <span class="main">⇒</span> doE_binds"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">;</span><span class="keyword3">//</span>_"</span> <span class="main">[</span>13<span class="main">,</span> 12<span class="main">]</span> 12<span class="main">)</span>
  <span class="quoted">"_thenM"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⪢</span>"</span> 54<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_doE_bind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> doE_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">&lt;-</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> 13<span class="main">)</span>
  <span class="quoted">"_thenM"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&gt;&gt;</span>"</span> 54<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_doE_block <span class="main">(</span>_doE_cons <span class="main">(</span>_doE_then <span class="free">t</span><span class="main">)</span> <span class="main">(</span>_doE_final <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span>
    <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> bind_doE <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="main">_</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span>"</span>
  <span class="quoted">"_doE_block <span class="main">(</span>_doE_cons <span class="main">(</span>_doE_bind <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>_doE_final <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span>
    <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> bind_doE <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="free">p</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span>"</span>
  <span class="quoted">"_doE_block <span class="main">(</span>_doE_cons <span class="main">(</span>_doE_let <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="free">bs</span><span class="main">)</span>"</span>
    <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">let</span> <span class="free">p</span> <span class="main">=</span> <span class="free">t</span> <span class="keyword1">in</span> _doE_block <span class="free">bs</span>"</span>
  <span class="quoted">"_doE_block <span class="main">(</span>_doE_cons <span class="free">b</span> <span class="main">(</span>_doE_cons <span class="free">c</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span>"</span>
    <span class="main">⇌</span> <span class="quoted">"_doE_block <span class="main">(</span>_doE_cons <span class="free">b</span> <span class="main">(</span>_doE_final <span class="main">(</span>_doE_block <span class="main">(</span>_doE_cons <span class="free">c</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span>
  <span class="quoted">"_doE_cons <span class="main">(</span>_doE_let <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>_doE_final <span class="free">s</span><span class="main">)</span>"</span>
    <span class="main">⇌</span> <span class="quoted">"_doE_final <span class="main">(</span><span class="keyword1">let</span> <span class="free">p</span> <span class="main">=</span> <span class="free">t</span> <span class="keyword1">in</span> <span class="free">s</span><span class="main">)</span>"</span>
  <span class="quoted">"_doE_block <span class="main">(</span>_doE_final <span class="free">e</span><span class="main">)</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="free">e</span>"</span>
  <span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">⪢</span> <span class="free">n</span><span class="main">)</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">_</span><span class="main">.</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CHECK</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="keyword1">then</span> ERETURN <span class="main">()</span> <span class="keyword1">else</span> THROW <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">EASSUME</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="keyword1">then</span> ERETURN <span class="main">()</span> <span class="keyword1">else</span> SUCCEED"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">EASSERT</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="keyword1">then</span> ERETURN <span class="main">()</span> <span class="keyword1">else</span> FAIL"</span></span>

<span class="keyword1" id="Exc_Nres_Monad-EASSUME_simps"><span class="command">lemma</span></span> EASSUME_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"EASSUME True <span class="main">=</span> ERETURN <span class="main">()</span>"</span></span>
  <span class="quoted"><span class="quoted">"EASSUME False <span class="main">=</span> SUCCEED"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EASSUME_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-EASSERT_simps"><span class="command">lemma</span></span> EASSERT_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"EASSERT True <span class="main">=</span> ERETURN <span class="main">()</span>"</span></span>
  <span class="quoted"><span class="quoted">"EASSERT False <span class="main">=</span> FAIL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EASSERT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-CHECK_simps"><span class="command">lemma</span></span> CHECK_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"CHECK True <span class="free">e</span> <span class="main">=</span> ERETURN <span class="main">()</span>"</span></span> 
  <span class="quoted"><span class="quoted">"CHECK False <span class="free">e</span> <span class="main">=</span> THROW <span class="free">e</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> CHECK_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-pw_ESPEC"><span class="command">lemma</span></span> pw_ESPEC<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Φ</span> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Ψ</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-pw_ERETURN"><span class="command">lemma</span></span> pw_ERETURN<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>ERETURN <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>inres <span class="main">(</span>ERETURN <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>ERETURN <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-pw_ebind"><span class="command">lemma</span></span> pw_ebind<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>ebind <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> nofail <span class="free">m</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> nofail <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>ebind <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> inres <span class="free">m</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> inres <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>ebind <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> nofail <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inr <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> inres <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> sum.exhaust_sel <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> sum.exhaust_sel <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exc_Nres_Monad-pw_THROW"><span class="command">lemma</span></span> pw_THROW<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>THROW <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>THROW <span class="free">e</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">f</span><span class="main">=</span><span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>inres <span class="main">(</span>THROW <span class="free">e</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-pw_CHECK"><span class="command">lemma</span></span> pw_CHECK<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>CHECK <span class="free">Φ</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>CHECK <span class="free">Φ</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span><span class="free">Φ</span> <span class="main">∧</span> <span class="free">f</span><span class="main">=</span><span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>CHECK <span class="free">Φ</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">u</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
<span class="keyword1" id="Exc_Nres_Monad-pw_EASSUME"><span class="command">lemma</span></span> pw_EASSUME<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>EASSUME <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>inres <span class="main">(</span>EASSUME <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>EASSUME <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">u</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EASSUME_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-pw_EASSERT"><span class="command">lemma</span></span> pw_EASSERT<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>EASSERT <span class="free">Φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>EASSERT <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>EASSERT <span class="free">Φ</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span><span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EASSERT_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-pw_CATCH"><span class="command">lemma</span></span> pw_CATCH<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>CATCH <span class="free">m</span> <span class="free">h</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">m</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inl <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> nofail <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>CATCH <span class="free">m</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e'</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inl <span class="bound">e'</span><span class="main">)</span> <span class="main">∧</span> inres <span class="main">(</span><span class="free">h</span> <span class="bound">e'</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span>CATCH <span class="free">m</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> inres <span class="free">m</span> <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inl <span class="bound">e</span><span class="main">)</span> <span class="main">∧</span> inres <span class="main">(</span><span class="free">h</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CATCH_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>  
  <span class="keyword1"><span class="command">using</span></span> sum.exhaust_sel <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> sum.exhaust_sel <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="Exc_Nres_Monad-pw_ele_iff"><span class="command">lemma</span></span> pw_ele_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">n</span> <span class="main">⟶</span> 
    nofail <span class="free">m</span> 
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inl <span class="bound">e</span><span class="main">)</span> <span class="main">⟶</span> inres <span class="free">n</span> <span class="main">(</span>Inl <span class="bound">e</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> inres <span class="free">n</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_le_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum.exhaust_sel<span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-pw_eeq_iff"><span class="command">lemma</span></span> pw_eeq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟷</span> 
    <span class="main">(</span>nofail <span class="free">m</span> <span class="main">⟷</span> nofail <span class="free">n</span><span class="main">)</span> 
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inl <span class="bound">e</span><span class="main">)</span> <span class="main">⟷</span> inres <span class="free">n</span> <span class="main">(</span>Inl <span class="bound">e</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> inres <span class="free">n</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum.exhaust_sel<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  


<span class="keyword1" id="Exc_Nres_Monad-enres_monad_laws"><span class="command">lemma</span></span> enres_monad_laws<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ebind <span class="main">(</span>ERETURN <span class="free">x</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"ebind <span class="free">m</span> <span class="main">(</span>ERETURN<span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"ebind <span class="main">(</span>ebind <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> ebind <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ebind <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eeq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
<span class="keyword1" id="Exc_Nres_Monad-enres_additional_laws"><span class="command">lemma</span></span> enres_additional_laws<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ebind <span class="main">(</span>THROW <span class="free">e</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> THROW <span class="free">e</span>"</span></span>
  
  <span class="quoted"><span class="quoted">"CATCH <span class="main">(</span>THROW <span class="free">e</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> <span class="free">h</span> <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"CATCH <span class="main">(</span>ERETURN <span class="free">x</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> ERETURN <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"CATCH <span class="free">m</span> THROW <span class="main">=</span> <span class="free">m</span>"</span></span>
  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eeq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1"><span class="command">lemmas</span></span> ESPEC_trans <span class="main">=</span> order_trans<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> z<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ESPEC <span class="free">Error_Postcond</span> <span class="free">Normal_Postcond</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Error_Postcond</span> <span class="free">Normal_Postcond</span><span class="main">,</span> <span class="operator">zero_var_indexes</span><span class="main">]</span>

<span class="keyword1" id="Exc_Nres_Monad-ESPEC_cons"><span class="command">lemma</span></span> ESPEC_cons<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="free">E</span> <span class="bound">e</span> <span class="main">⟹</span> <span class="free">E'</span> <span class="bound">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> ESPEC <span class="free">E'</span> <span class="free">Q'</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff<span class="main">)</span>
  
  
<span class="keyword1" id="Exc_Nres_Monad-ebind_rule_iff"><span class="command">lemma</span></span> ebind_rule_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">doE</span> <span class="main">{</span> <span class="bound">x</span><span class="main">←</span><span class="free">m</span><span class="main">;</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">}</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> ebind_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> ebind_rule_iff<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">]</span>

<span class="keyword1" id="Exc_Nres_Monad-ERETURN_rule_iff"><span class="command">lemma</span></span> ERETURN_rule_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ERETURN <span class="free">x</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span> <span class="main">⟷</span> <span class="free">Ψ</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> ERETURN_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> ERETURN_rule_iff<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">]</span>

<span class="keyword1" id="Exc_Nres_Monad-ESPEC_rule_iff"><span class="command">lemma</span></span> ESPEC_rule_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"ESPEC <span class="free">Φ</span> <span class="free">Ψ</span> <span class="main">≤</span> ESPEC <span class="free">Φ'</span> <span class="free">Ψ'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">e</span> <span class="main">⟶</span> <span class="free">Φ'</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">Ψ</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">Ψ'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> ESPEC_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> ESPEC_rule_iff<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">]</span>

<span class="keyword1" id="Exc_Nres_Monad-THROW_rule_iff"><span class="command">lemma</span></span> THROW_rule_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"THROW <span class="free">e</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span> <span class="main">⟷</span> <span class="free">Φ</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> THROW_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> THROW_rule_iff<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">]</span>

<span class="keyword1" id="Exc_Nres_Monad-CATCH_rule_iff"><span class="command">lemma</span></span> CATCH_rule_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"CATCH <span class="free">m</span> <span class="free">h</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> ESPEC <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">h</span> <span class="bound">e</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">)</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> CATCH_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> CATCH_rule_iff<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">]</span>



<span class="keyword1" id="Exc_Nres_Monad-CHECK_rule_iff"><span class="command">lemma</span></span> CHECK_rule_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"CHECK <span class="free">c</span> <span class="free">e</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">c</span> <span class="main">⟶</span> <span class="free">Ψ</span> <span class="main">()</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span><span class="free">c</span> <span class="main">⟶</span> <span class="free">Φ</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-CHECK_rule"><span class="command">lemma</span></span> CHECK_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⟹</span> <span class="free">Ψ</span> <span class="main">()</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">c</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CHECK <span class="free">c</span> <span class="free">e</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHECK_rule_iff<span class="main">)</span>



<span class="keyword1" id="Exc_Nres_Monad-EASSUME_rule"><span class="command">lemma</span></span> EASSUME_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span> <span class="main">⟹</span> <span class="free">Ψ</span> <span class="main">()</span><span class="main">⟧</span> <span class="main">⟹</span> EASSUME <span class="free">Φ</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-EASSERT_rule"><span class="command">lemma</span></span> EASSERT_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Φ</span><span class="main">;</span> <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">Ψ</span> <span class="main">()</span><span class="main">⟧</span> <span class="main">⟹</span> EASSERT <span class="free">Φ</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-eprod_rule"><span class="command">lemma</span></span> eprod_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">p</span><span class="main">=</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">S</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">p</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">S</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="comment1">(* TODO: Add a simplifier setup that normalizes nested case-expressions to
  the vcg! *)</span>
<span class="keyword1" id="Exc_Nres_Monad-eprod2_rule"><span class="command">lemma</span></span> eprod2_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="main">⟦</span><span class="free">ab</span><span class="main">=</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">;</span> <span class="free">cd</span><span class="main">=</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">)</span> <span class="free">ab</span> <span class="free">cd</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-eif_rule"><span class="command">lemma</span></span> eif_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">S1</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">;</span> <span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">S2</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">S1</span> <span class="keyword1">else</span> <span class="free">S2</span><span class="main">)</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-eoption_rule"><span class="command">lemma</span></span> eoption_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span><span class="main">=</span>None <span class="main">⟹</span> <span class="free">S1</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">v</span><span class="main">=</span>Some <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f2</span> <span class="bound">x</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">⟧</span> 
  <span class="main">⟹</span> case_option <span class="free">S1</span> <span class="free">f2</span> <span class="free">v</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-eLet_rule"><span class="command">lemma</span></span> eLet_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">v</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span><span class="main">=</span><span class="free">v</span> <span class="keyword1">in</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Exc_Nres_Monad-eLet_rule'"><span class="command">lemma</span></span> eLet_rule'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">v</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> ESPEC <span class="free">Φ</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">EWHILEIT</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> WHILEIT 
  <span class="main">(</span><span class="main">λ</span>Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span><span class="main">)</span> 
  <span class="main">(</span><span class="main">λ</span>Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> ASSERT <span class="main">(</span><span class="main">¬</span>isl <span class="bound">s</span><span class="main">)</span> <span class="main">⪢</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> projr <span class="bound">s</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">EWHILET</span> <span class="main">≡</span> EWHILEIT <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>

<span class="keyword1" id="Exc_Nres_Monad-EWHILEIT_rule"><span class="command">lemma</span></span> EWHILEIT_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span><span class="main">;</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IMP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span><span class="main">;</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"EWHILEIT <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EWHILEIT_def ESPEC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEIT_weaken<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span>Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free">E</span> <span class="bound">e</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"inv_image <span class="main">(</span>less_than <span class="keyword1">&lt;*lex*&gt;</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span>Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span>undefined<span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> WF <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> I0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ESPEC_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IS<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ESPEC_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> IMP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="Exc_Nres_Monad-EWHILET_rule"><span class="command">lemma</span></span> EWHILET_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span><span class="main">;</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IMP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span><span class="main">;</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"EWHILET <span class="free">b</span> <span class="free">f</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EWHILET_def EWHILEIT_def ESPEC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WHILEIT_weaken<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span>Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free">E</span> <span class="bound">e</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"inv_image <span class="main">(</span>less_than <span class="keyword1">&lt;*lex*&gt;</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span>Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span>undefined<span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> WF <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> I0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ESPEC_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IS<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ESPEC_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> IMP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="Exc_Nres_Monad-EWHILEIT_weaken"><span class="command">lemma</span></span> EWHILEIT_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">I'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"EWHILEIT <span class="free">I'</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> EWHILEIT <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WHILEIT_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Explicitly specify a different invariant. ›</span></span>    
<span class="keyword1" id="Exc_Nres_Monad-EWHILEIT_expinv_rule"><span class="command">lemma</span></span> EWHILEIT_expinv_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span><span class="main">;</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IMP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span><span class="main">;</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> INVIMP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I'</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"EWHILEIT <span class="free">I'</span> <span class="free">b</span> <span class="free">f</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> EWHILEIT_weaken<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> INVIMP <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> EWHILEIT_rule<span class="main"><span class="keyword3">;</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">enfoldli</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> 
  nfoldli <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">λ</span>Inl <span class="bound">e</span><span class="main">⇒</span>False <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>ASSERT <span class="main">(</span><span class="main">¬</span>isl <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="keyword1">let</span> <span class="bound">s</span><span class="main">=</span>projr <span class="bound">s</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Exc_Nres_Monad-enfoldli_simps"><span class="command">lemma</span></span> enfoldli_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"enfoldli <span class="main">[]</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> ERETURN <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"enfoldli <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ls</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="free">s</span> <span class="keyword1">then</span> <span class="keyword1">doE</span> <span class="main">{</span> <span class="bound">s</span><span class="main">←</span><span class="free">f</span> <span class="free">x</span> <span class="free">s</span><span class="main">;</span> enfoldli <span class="free">ls</span> <span class="free">c</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span> <span class="keyword1">else</span> ERETURN <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Refine_Basic.bind <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> ext<span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-enfoldli_rule"><span class="command">lemma</span></span> enfoldli_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">[]</span> <span class="free">l0</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">l1</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">l2</span><span class="main">)</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">σ</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">l1</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="bound">l2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FNC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">l0</span><span class="main">=</span><span class="bound">l1</span><span class="main">@</span><span class="bound">l2</span><span class="main">;</span> <span class="free">I</span> <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="free">l0</span> <span class="main">[]</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enfoldli <span class="free">l0</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> enfoldli_def ESPEC_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nfoldli_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l1</span> <span class="bound">l2</span><span class="main">.</span> <span class="main">λ</span>Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free">E</span> <span class="bound">e</span> <span class="main">|</span> Inr <span class="bound">σ</span> <span class="main">⇒</span> <span class="free">I</span> <span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">σ</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IS<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ESPEC_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> FNC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> FC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


    
    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data Refinement›</span></span>

<span class="keyword1" id="Exc_Nres_Monad-sum_rel_conv"><span class="command">lemma</span></span> sum_rel_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Inl <span class="free">l</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>sum_rel <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> <span class="free">s'</span><span class="main">=</span>Inl <span class="bound">l'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="bound">l'</span><span class="main">)</span><span class="main">∈</span><span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Inr <span class="free">r</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>sum_rel <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r'</span><span class="main">.</span> <span class="free">s'</span><span class="main">=</span>Inr <span class="bound">r'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> Inl <span class="free">l'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>sum_rel <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">s</span><span class="main">=</span>Inl <span class="bound">l</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="free">l'</span><span class="main">)</span><span class="main">∈</span><span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> Inr <span class="free">r'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>sum_rel <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">s</span><span class="main">=</span>Inr <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">.</span> <span class="free">s</span> <span class="main">≠</span> Inl <span class="bound">l</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">s</span><span class="main">=</span>Inr <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="free">s</span> <span class="main">≠</span> Inr <span class="bound">r</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">s</span><span class="main">=</span>Inl <span class="bound">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">econc_fun</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">econc_fun</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">⇓</span><span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">⟩</span>sum_rel<span class="main">)</span>"</span></span>

<span class="keyword1" id="Exc_Nres_Monad-RELATES_pat_erefine"><span class="command">lemma</span></span> RELATES_pat_erefine<span class="main">[</span><span class="operator">refine_dref_pattern</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>RELATES <span class="free">R</span><span class="main">;</span> <span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Exc_Nres_Monad-pw_econc_iff"><span class="command">lemma</span></span> pw_econc_iff<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">ei</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inl <span class="bound">e</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">ei</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"inres <span class="main">(</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">xi</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>nofail <span class="free">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> inres <span class="free">m</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nofail <span class="main">(</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟷</span> nofail <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> econc_fun_def sum_rel_conv<span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-econc_fun_id"><span class="command">lemma</span></span> econc_fun_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> Id Id <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eeq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-econc_fun_ESPEC"><span class="command">lemma</span></span> econc_fun_ESPEC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">)</span> <span class="main">=</span> ESPEC <span class="main">(</span><span class="main">λ</span><span class="bound">ei</span><span class="main">.</span> <span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="bound">ei</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span> <span class="main">∧</span> <span class="free">Φ</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ri</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">ri</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">Ψ</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eeq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-econc_fun_ERETURN"><span class="command">lemma</span></span> econc_fun_ERETURN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>ERETURN <span class="free">x</span><span class="main">)</span> <span class="main">=</span> ESPEC <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xi</span><span class="main">.</span> <span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eeq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-econc_fun_univ_id"><span class="command">lemma</span></span> econc_fun_univ_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> UNIV Id <span class="main">(</span>ESPEC <span class="free">Φ</span> <span class="free">Ψ</span><span class="main">)</span> <span class="main">=</span> ESPEC <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Ex <span class="free">Φ</span><span class="main">)</span> <span class="free">Ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eeq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-erefine_same_sup_Id"><span class="command">lemma</span></span> erefine_same_sup_Id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Id<span class="main">⊆</span><span class="free">E</span><span class="main">;</span> Id<span class="main">⊆</span><span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-econc_mono3"><span class="command">lemma</span></span> econc_mono3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≤</span><span class="free">m'</span> <span class="main">⟹</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="comment1">(* Order of these two is important! *)</span>    
<span class="keyword1" id="Exc_Nres_Monad-econc_x_trans"><span class="command">lemma</span></span> econc_x_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1" id="Exc_Nres_Monad-econc_econc_trans"><span class="command">lemma</span></span> econc_econc_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E1</span> <span class="free">R1</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E2</span> <span class="free">R2</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="main">(</span><span class="free">E1</span> <span class="keyword1">O</span> <span class="free">E2</span><span class="main">)</span> <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="free">z</span>"</span></span>    
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
    
    
<span class="keyword1" id="Exc_Nres_Monad-ERETURN_refine"><span class="command">lemma</span></span> ERETURN_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xi</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ERETURN <span class="free">xi</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span><span class="free">E</span> <span class="free">R</span> <span class="main">(</span>ERETURN <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-EASSERT_bind_refine_right"><span class="command">lemma</span></span> EASSERT_bind_refine_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="keyword1">doE</span> <span class="main">{</span>EASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
<span class="keyword1" id="Exc_Nres_Monad-EASSERT_bind_refine_left"><span class="command">lemma</span></span> EASSERT_bind_refine_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">doE</span> <span class="main">{</span>EASSERT <span class="free">Φ</span><span class="main">;</span> <span class="free">mi</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Exc_Nres_Monad-EASSUME_bind_refine_right"><span class="command">lemma</span></span> EASSUME_bind_refine_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="keyword1">doE</span> <span class="main">{</span>EASSUME <span class="free">Φ</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-EASSUME_bind_refine_left"><span class="command">lemma</span></span> EASSUME_bind_refine_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">doE</span> <span class="main">{</span>EASSUME <span class="free">Φ</span><span class="main">;</span> <span class="free">mi</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-ebind_refine"><span class="command">lemma</span></span> ebind_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R'</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xi</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">doE</span> <span class="main">{</span> <span class="bound">xi</span> <span class="main">←</span> <span class="free">mi</span><span class="main">;</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="main">}</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="keyword1">doE</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">←</span> <span class="free">m</span><span class="main">;</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Order of this lemmas matters!›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span> <span class="main">=</span> 
  ebind_refine
  EASSERT_bind_refine_left EASSUME_bind_refine_right
  EASSUME_bind_refine_left EASSERT_bind_refine_right

<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">refine</span></span><span class="main">(</span>1-10<span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-ebind_refine'"><span class="command">lemma</span></span> ebind_refine'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R'</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xi</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">;</span> inres <span class="free">mi</span> <span class="main">(</span>Inr <span class="bound">xi</span><span class="main">)</span><span class="main">;</span> inres <span class="free">m</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span><span class="main">;</span> nofail <span class="free">mi</span><span class="main">;</span> nofail <span class="free">m</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">doE</span> <span class="main">{</span> <span class="bound">xi</span> <span class="main">←</span> <span class="free">mi</span><span class="main">;</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="main">}</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="keyword1">doE</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">←</span> <span class="free">m</span><span class="main">;</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1" id="Exc_Nres_Monad-THROW_refine"><span class="command">lemma</span></span> THROW_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ei</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span> <span class="main">⟹</span> THROW <span class="free">ei</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>THROW <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-CATCH_refine'"><span class="command">lemma</span></span> CATCH_refine'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E'</span> <span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ei</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">ei</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">∈</span><span class="free">E'</span><span class="main">;</span> inres <span class="free">mi</span> <span class="main">(</span>Inl <span class="bound">ei</span><span class="main">)</span><span class="main">;</span> inres <span class="free">m</span> <span class="main">(</span>Inl <span class="bound">e</span><span class="main">)</span><span class="main">;</span> nofail <span class="free">mi</span><span class="main">;</span> nofail <span class="free">m</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">hi</span> <span class="bound">ei</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CATCH <span class="free">mi</span> <span class="free">hi</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>CATCH <span class="free">m</span> <span class="free">h</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> <span class="operator">blast</span>
  
<span class="keyword1" id="Exc_Nres_Monad-CATCH_refine"><span class="command">lemma</span></span> CATCH_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E'</span> <span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ei</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">ei</span><span class="main">,</span><span class="bound">e</span><span class="main">)</span><span class="main">∈</span><span class="free">E'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">hi</span> <span class="bound">ei</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">h</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CATCH <span class="free">mi</span> <span class="free">hi</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>CATCH <span class="free">m</span> <span class="free">h</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms CATCH_refine' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Exc_Nres_Monad-CHECK_refine"><span class="command">lemma</span></span> CHECK_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φi</span> <span class="main">⟷</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">Φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">msgi</span><span class="main">,</span><span class="free">msg</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CHECK <span class="free">Φi</span> <span class="free">msgi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> Id <span class="main">(</span>CHECK <span class="free">Φ</span> <span class="free">msg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This must be declared after <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> CHECK_refine<span class="antiquote"><span class="antiquote">}</span></span></span></span>!›</span></span>
<span class="keyword1" id="Exc_Nres_Monad-CHECK_bind_refine"><span class="command">lemma</span></span> CHECK_bind_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φi</span> <span class="main">⟷</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">Φ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">msgi</span><span class="main">,</span><span class="free">msg</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">⟹</span> <span class="free">mi</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">doE</span> <span class="main">{</span>CHECK <span class="free">Φi</span> <span class="free">msgi</span><span class="main">;</span><span class="free">mi</span><span class="main">}</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="keyword1">doE</span> <span class="main">{</span>CHECK <span class="free">Φ</span> <span class="free">msg</span><span class="main">;</span> <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    
<span class="keyword1" id="Exc_Nres_Monad-Let_unfold_refine"><span class="command">lemma</span></span> Let_unfold_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">x</span> <span class="free">f</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>Let <span class="free">x'</span> <span class="free">f'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-Let_refine"><span class="command">lemma</span></span> Let_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">m'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>Let <span class="free">m'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-eif_refine"><span class="command">lemma</span></span> eif_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">b'</span><span class="main">)</span><span class="main">∈</span>bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">b</span><span class="main">;</span><span class="free">b'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S1</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">S1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="free">b</span><span class="main">;</span><span class="main">¬</span><span class="free">b'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">S2</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">S2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">S1</span> <span class="keyword1">else</span> <span class="free">S2</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b'</span> <span class="keyword1">then</span> <span class="free">S1'</span> <span class="keyword1">else</span> <span class="free">S2'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>




<span class="comment1">(* TODO: Also add enfoldli_invar_refine *)</span>
<span class="keyword1" id="Exc_Nres_Monad-enfoldli_refine"><span class="command">lemma</span></span> enfoldli_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">li</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">si</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> CR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ci</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> FR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xi</span> <span class="bound">x</span> <span class="bound">si</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">xi</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="bound">si</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">c</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">xi</span> <span class="bound">si</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enfoldli <span class="free">li</span> <span class="free">ci</span> <span class="free">fi</span> <span class="free">si</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>enfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nfoldli_refine<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> CR<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">applyS</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FR<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exc_Nres_Monad-EWHILET_refine"><span class="command">lemma</span></span> EWHILET_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"EWHILET <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>EWHILET <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> econc_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">thm</span></span> WHILEIT_refine

<span class="keyword1" id="Exc_Nres_Monad-EWHILEIT_refine"><span class="command">lemma</span></span> EWHILEIT_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">x</span>"</span></span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> COND_REF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b'</span> <span class="bound">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP_REF<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">b</span> <span class="bound">x</span><span class="main">;</span> <span class="free">b'</span> <span class="bound">x'</span><span class="main">;</span> <span class="free">I</span> <span class="bound">x</span><span class="main">;</span> <span class="free">I'</span> <span class="bound">x'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"EWHILEIT <span class="free">I</span> <span class="free">b</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>EWHILEIT <span class="free">I'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> econc_fun_def<span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refine2- heuristics›</span></span>

<span class="keyword1" id="Exc_Nres_Monad-remove_eLet_refine"><span class="command">lemma</span></span> remove_eLet_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-intro_eLet_refine"><span class="command">lemma</span></span> intro_eLet_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">x</span> <span class="free">f</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">M'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Exc_Nres_Monad-ebind2let_refine"><span class="command">lemma</span></span> ebind2let_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ERETURN <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R'</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">x</span> <span class="free">f</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>ebind <span class="free">M'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exc_Nres_Monad-ebind_Let_refine2"><span class="command">lemma</span></span> ebind_Let_refine2<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="free">m'</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R'</span> <span class="main">(</span>ERETURN <span class="free">x</span><span class="main">)</span><span class="main">;</span>
    <span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">⟦</span>inres <span class="free">m'</span> <span class="main">(</span>Inr <span class="bound">x'</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> ebind <span class="free">m'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>Let <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exc_Nres_Monad-ebind2letRETURN_refine"><span class="command">lemma</span></span> ebind2letRETURN_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ERETURN <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R'</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">x'</span><span class="main">)</span><span class="main">∈</span><span class="free">R'</span> <span class="main">⟹</span> ERETURN <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ERETURN <span class="main">(</span>Let <span class="free">x</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>ebind <span class="free">M'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Exc_Nres_Monad-ERETURN_as_SPEC_refine"><span class="command">lemma</span></span> ERETURN_as_SPEC_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RELATES <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> ESPEC <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span>ERETURN <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Exc_Nres_Monad-if_ERETURN_refine"><span class="command">lemma</span></span> if_ERETURN_refine<span class="main">[</span><span class="operator">refine2</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟷</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">b</span><span class="main">;</span><span class="free">b'</span><span class="main">⟧</span> <span class="main">⟹</span> ERETURN <span class="free">S1</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">S1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="free">b</span><span class="main">;</span><span class="main">¬</span><span class="free">b'</span><span class="main">⟧</span> <span class="main">⟹</span> ERETURN <span class="free">S2</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="free">S2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ERETURN <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">S1</span> <span class="keyword1">else</span> <span class="free">S2</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">E</span> <span class="free">R</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b'</span> <span class="keyword1">then</span> <span class="free">S1'</span> <span class="keyword1">else</span> <span class="free">S2'</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* this is nice to have for small functions, hence keep it in refine2 *)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Breaking down enres-monad ›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enres_lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nres <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> enres"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">enres_lift</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span> RETURN <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Exc_Nres_Monad-enres_lift_rule"><span class="command">lemma</span></span> enres_lift_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≤</span>SPEC <span class="free">Φ</span> <span class="main">⟹</span> enres_lift <span class="free">m</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> enres_lift_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">named_theorems_rev</span></span> enres_breakdown  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ERETURN <span class="free">x</span> <span class="main">=</span> enres_lift <span class="main">(</span>RETURN <span class="free">x</span><span class="main">)</span>"</span></span>  
  <span class="quoted"><span class="quoted">"EASSERT <span class="free">Φ</span> <span class="main">=</span> enres_lift <span class="main">(</span>ASSERT <span class="free">Φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">doE</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">←</span> enres_lift <span class="free">m</span><span class="main">;</span> <span class="free">ef</span> <span class="bound">x</span> <span class="main">}</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">←</span> <span class="free">m</span><span class="main">;</span> <span class="free">ef</span> <span class="bound">x</span> <span class="main">}</span>"</span></span>
  <span class="comment1">(*"NO_MATCH (enres_lift m) em ⟹ doE { x ← em; ef x } = do { ex ← em; case ex of Inl e ⇒ RETURN (Inl e) | Inr x ⇒ ef x }"*)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span> enres_lift_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">←</span> <span class="free">m</span><span class="main">;</span> enres_lift <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">}</span> <span class="main">=</span> enres_lift <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">←</span> <span class="free">m</span><span class="main">;</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span> <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v</span><span class="main">;</span> enres_lift <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">}</span> <span class="main">=</span> enres_lift <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span> <span class="keyword1">let</span> <span class="bound">x</span><span class="main">=</span><span class="free">v</span><span class="main">;</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span> enres_lift_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"CATCH <span class="main">(</span>enres_lift <span class="free">m</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> enres_lift <span class="free">m</span>"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span> enres_lift_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="Exc_Nres_Monad-enres_lift_fail"><span class="command">lemma</span></span> enres_lift_fail<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"enres_lift FAIL <span class="main">=</span> FAIL"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> enres_lift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="comment1">(* TODO: Also do breakdown-thm for RECT. It's exactly the same approach! *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"EWHILEIT <span class="free">I</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> enres_lift <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> enres_lift <span class="main">(</span>WHILEIT <span class="free">I</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span> WHILEIT_def WHILET_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_transfer_rel'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> Inr <span class="bound">a</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> while.WHILEI_body_trimono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> while.WHILEI_body_trimono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> WHILEI_body_def enres_lift_def pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">≤</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span> WHILEIT_def WHILET_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_transfer_rel'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> Inr <span class="bound">a</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> while.WHILEI_body_trimono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> while.WHILEI_body_trimono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> WHILEI_body_def enres_lift_def pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>    



<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"EWHILET <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> enres_lift <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> enres_lift <span class="main">(</span>WHILET <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> EWHILET_def WHILET_def <span class="dynamic"><span class="dynamic">enres_breakdown</span></span> <span class="keyword1"><span class="command">..</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"enfoldli <span class="free">l</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> enres_lift <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> enres_lift <span class="main">(</span>nfoldli <span class="free">l</span> <span class="free">c</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">enres_breakdown</span></span><span class="main">)</span>  
    
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> enres_lift <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> enres_lift <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span> <span class="main">=</span> nres_monad_laws nres_bind_let_law

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">doE</span> <span class="main">{</span> CHECK <span class="free">Φ</span> <span class="free">e</span><span class="main">;</span> <span class="free">m</span> <span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">Φ</span> <span class="keyword1">then</span> <span class="free">m</span> <span class="keyword1">else</span> THROW <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> enres_lift <span class="free">m</span> <span class="keyword1">else</span> enres_lift <span class="free">n</span><span class="main">)</span> <span class="main">=</span> enres_lift <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">m</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Exc_Nres_Monad-option_case_enbd"><span class="command">lemma</span></span> option_case_enbd<span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"case_option <span class="main">(</span>enres_lift <span class="free">fn</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> enres_lift <span class="main">(</span><span class="free">fs</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> enres_lift <span class="main">(</span>case_option <span class="free">fn</span> <span class="free">fs</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    
    
    
<span class="keyword1"><span class="command">named_theorems</span></span> enres_inline
    
<span class="keyword1"><span class="command">method</span></span> opt_enres_unfold <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="operator">unfold</span> <span class="dynamic"><span class="dynamic">enres_inline</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">unfold</span> enres_monad_laws<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">unfold</span> <span class="dynamic"><span class="dynamic">enres_breakdown</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">unfold</span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span> enres_lift_def nres_monad_laws<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>

  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹More Combinators›</span></span>  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹CHECK-Monadic›</span></span>
    
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CHECK_monadic</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="keyword1">doE</span> <span class="main">{</span> <span class="bound">b</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span> CHECK <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">}</span>"</span></span>
  
  <span class="keyword1" id="Exc_Nres_Monad-CHECK_monadic_rule_iff"><span class="command">lemma</span></span> CHECK_monadic_rule_iff<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>CHECK_monadic <span class="free">c</span> <span class="free">e</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">c</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">()</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span><span class="bound">r</span> <span class="main">⟶</span> <span class="free">E</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff CHECK_monadic_def <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
  <span class="keyword1" id="Exc_Nres_Monad-CHECK_monadic_pw"><span class="command">lemma</span></span> CHECK_monadic_pw<span class="main">[</span><span class="operator">refine_pw_simps</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"nofail <span class="main">(</span>CHECK_monadic <span class="free">c</span> <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> nofail <span class="free">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"inres <span class="main">(</span>CHECK_monadic <span class="free">c</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">ee</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>inres <span class="free">c</span> <span class="main">(</span>Inl <span class="free">ee</span><span class="main">)</span> <span class="main">∨</span> inres <span class="free">c</span> <span class="main">(</span>Inr False<span class="main">)</span> <span class="main">∧</span> <span class="free">ee</span><span class="main">=</span><span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"inres <span class="main">(</span>CHECK_monadic <span class="free">c</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>inres <span class="free">c</span> <span class="main">(</span>Inr True<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> CHECK_monadic_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
  <span class="keyword1" id="Exc_Nres_Monad-CHECK_monadic_rule"><span class="command">lemma</span></span> CHECK_monadic_rule<span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">()</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span><span class="bound">r</span> <span class="main">⟶</span> <span class="free">E</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CHECK_monadic <span class="free">c</span> <span class="free">e</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHECK_monadic_rule_iff<span class="main">)</span>  
  
  <span class="keyword1" id="Exc_Nres_Monad-CHECK_monadic_refine"><span class="command">lemma</span></span> CHECK_monadic_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ci</span> <span class="main">≤</span> <span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">ER</span> bool_rel <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ei</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">∈</span><span class="free">ER</span>"</span></span>  
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CHECK_monadic <span class="free">ci</span> <span class="free">ei</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">ER</span> unit_rel <span class="main">(</span>CHECK_monadic <span class="free">c</span> <span class="free">e</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> assms  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
  <span class="keyword1" id="Exc_Nres_Monad-CHECK_monadic_CHECK_refine"><span class="command">lemma</span></span> CHECK_monadic_CHECK_refine<span class="main">[</span><span class="operator">refine</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ci</span> <span class="main">≤</span> ESPEC <span class="main">(</span><span class="main">λ</span><span class="bound">e'</span><span class="main">.</span> <span class="main">(</span><span class="bound">e'</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">∈</span><span class="free">ER</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">⟷</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ei</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">∈</span><span class="free">ER</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CHECK_monadic <span class="free">ci</span> <span class="free">ei</span> <span class="main">≤</span><span class="keyword1">⇓<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">ER</span> unit_rel <span class="main">(</span>CHECK <span class="free">c</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_ele_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
  
  <span class="keyword1" id="Exc_Nres_Monad-CHECK_monadic_endb"><span class="command">lemma</span></span> CHECK_monadic_endb<span class="main">[</span><span class="operator">enres_breakdown</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"CHECK_monadic <span class="main">(</span>enres_lift <span class="free">c</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> 
    <span class="keyword1">do</span> <span class="main">{</span><span class="bound">b</span> <span class="main">←</span> <span class="free">c</span><span class="main">;</span> CHECK <span class="bound">b</span> <span class="free">e</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">enres_unfolds</span></span> enres_lift_def<span class="main">)</span>
  
  
  
  
  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="VTcomp">
<div class="head">
<h1>Theory VTcomp</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹VT-Comp Library Setup›</span></span>
<span class="keyword1"><span class="command">theory</span></span> VTcomp
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Array_Map_Default.html">Array_Map_Default</a>
  <a href="Dynamic_Array.html">Dynamic_Array</a>
  <span class="comment1">(*Impl_List_Set_Ndj*)</span>
  <a href="Synth_Definition.html">Synth_Definition</a>
  <a href="Exc_Nres_Monad.html">Exc_Nres_Monad</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: Move these stuff to AFP! *)</span>


<span class="keyword1"><span class="command">no_notation</span></span> Ref.lookup <span class="main">(</span><span class="quoted">"<span class="keyword1">!</span>_"</span> 61<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> Ref.update <span class="main">(</span><span class="quoted">"_ <span class="keyword1">:=</span> _"</span> 62<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Extra Stuff›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We added this stuff as preparation for the competition. ›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specialized Rules for Foreach Loops›</span></span>
<span class="keyword1" id="VTcomp-nfoldli_upt_rule"><span class="command">lemma</span></span> nfoldli_upt_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INTV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lb</span><span class="main">≤</span><span class="free">ub</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">lb</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">lb</span><span class="main">≤</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">ub</span><span class="main">;</span> <span class="free">I</span> <span class="bound">i</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FNC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">lb</span><span class="main">≤</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">≤</span><span class="free">ub</span><span class="main">;</span> <span class="free">I</span> <span class="bound">i</span> <span class="bound">σ</span><span class="main">;</span> <span class="main">¬</span><span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="free">ub</span> <span class="bound">σ</span><span class="main">;</span> <span class="free">c</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nfoldli <span class="main">[</span><span class="free">lb</span><span class="main">..&lt;</span><span class="free">ub</span><span class="main">]</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nfoldli_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="main"><span class="bound">_</span></span> <span class="bound">σ</span><span class="main">.</span> <span class="free">I</span> <span class="main">(</span><span class="free">lb</span><span class="main">+</span>length <span class="bound">l</span><span class="main">)</span> <span class="bound">σ</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> IS
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 add_diff_cancel_left' eq_diff_iff le_add1 length_upt upt_eq_lel_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l1 l2 σ 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FNC<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">lb</span> <span class="main">+</span> length <span class="skolem">l1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INTV<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> INTV upt_eq_append_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> FC<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> INTV 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  


<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">efor</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lb</span></span></span><span class="main">::</span>int<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="keyword1">doE</span> <span class="main">{</span>
  EASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lb</span></span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">ub</span></span></span><span class="main">)</span><span class="main">;</span>
  <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span> <span class="main">←</span> EWHILET <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">ub</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">doE</span> <span class="main">{</span> <span class="bound">σ</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span> <span class="bound">σ</span><span class="main">;</span> ERETURN <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lb</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">;</span>
  ERETURN <span class="bound">σ</span>
<span class="main">}</span>"</span></span>  
  
<span class="keyword1" id="VTcomp-efor_rule"><span class="command">lemma</span></span> efor_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INTV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lb</span><span class="main">≤</span><span class="free">ub</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">lb</span> <span class="free">σ0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> IS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">lb</span><span class="main">≤</span><span class="bound">i</span><span class="main">;</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">ub</span><span class="main">;</span> <span class="free">I</span> <span class="bound">i</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">σ</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="free">ub</span> <span class="bound">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"efor <span class="free">lb</span> <span class="free">ub</span> <span class="free">f</span> <span class="free">σ0</span> <span class="main">≤</span> ESPEC <span class="free">E</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> efor_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> EWHILET_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> nat <span class="main">(</span><span class="free">ub</span><span class="main">-</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span><span class="main">.</span> <span class="free">lb</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">≤</span><span class="free">ub</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">i</span> <span class="bound">σ</span>"</span></span><span class="main">,</span> <span class="operator">refine_vcg</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nicer do-notation for the nres-monad›</span></span>  
    
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>do_notation<span class="main">)</span> <span class="entity">bind_doN</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bind_doN</span> <span class="main">≡</span> Refine_Basic.bind"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> bind_doN <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⤜</span>"</span> 54<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>ASCII <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span> bind_doN <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&gt;&gt;=</span>"</span> 54<span class="main">)</span>

<span class="keyword1"><span class="command">nonterminal</span></span> doN_binds <span class="keyword2"><span class="keyword">and</span></span> doN_bind
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_doN_block"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"doN_binds <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">doN</span> <span class="keyword1">{</span><span class="keyword3">//</span><span class="keyword3">(2</span>  _<span class="keyword3">)</span><span class="keyword3">//</span><span class="keyword1">}</span>"</span> <span class="main">[</span>12<span class="main">]</span> 62<span class="main">)</span>
  <span class="quoted">"_doN_bind"</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> doN_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">←</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> 13<span class="main">)</span>
  <span class="quoted">"_doN_let"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> doN_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">let</span> _ <span class="keyword1">=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 13<span class="main">]</span> 13<span class="main">)</span>
  <span class="quoted">"_doN_then"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> doN_bind"</span></span> <span class="main">(</span><span class="quoted">"_"</span> <span class="main">[</span>14<span class="main">]</span> 13<span class="main">)</span>
  <span class="quoted">"_doN_final"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> doN_binds"</span></span> <span class="main">(</span><span class="quoted">"_"</span><span class="main">)</span>
  <span class="quoted">"_doN_cons"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>doN_bind<span class="main">,</span> doN_binds<span class="main">]</span> <span class="main">⇒</span> doN_binds"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">;</span><span class="keyword3">//</span>_"</span> <span class="main">[</span>13<span class="main">,</span> 12<span class="main">]</span> 12<span class="main">)</span>
  <span class="quoted">"_thenM"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⪢</span>"</span> 54<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="main">(</span>ASCII<span class="main">)</span>
  <span class="quoted">"_doN_bind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> doN_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span>_ <span class="keyword1">&lt;-</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> 13<span class="main">)</span>
  <span class="quoted">"_thenM"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&gt;&gt;</span>"</span> 54<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_doN_block <span class="main">(</span>_doN_cons <span class="main">(</span>_doN_then <span class="free">t</span><span class="main">)</span> <span class="main">(</span>_doN_final <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span>
    <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> bind_doN <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="main">_</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span>"</span>
  <span class="quoted">"_doN_block <span class="main">(</span>_doN_cons <span class="main">(</span>_doN_bind <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>_doN_final <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span>
    <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> bind_doN <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="free">p</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span>"</span>
  <span class="quoted">"_doN_block <span class="main">(</span>_doN_cons <span class="main">(</span>_doN_let <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="free">bs</span><span class="main">)</span>"</span>
    <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">let</span> <span class="free">p</span> <span class="main">=</span> <span class="free">t</span> <span class="keyword1">in</span> _doN_block <span class="free">bs</span>"</span>
  <span class="quoted">"_doN_block <span class="main">(</span>_doN_cons <span class="free">b</span> <span class="main">(</span>_doN_cons <span class="free">c</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span>"</span>
    <span class="main">⇌</span> <span class="quoted">"_doN_block <span class="main">(</span>_doN_cons <span class="free">b</span> <span class="main">(</span>_doN_final <span class="main">(</span>_doN_block <span class="main">(</span>_doN_cons <span class="free">c</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span>
  <span class="quoted">"_doN_cons <span class="main">(</span>_doN_let <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>_doN_final <span class="free">s</span><span class="main">)</span>"</span>
    <span class="main">⇌</span> <span class="quoted">"_doN_final <span class="main">(</span><span class="keyword1">let</span> <span class="free">p</span> <span class="main">=</span> <span class="free">t</span> <span class="keyword1">in</span> <span class="free">s</span><span class="main">)</span>"</span>
  <span class="quoted">"_doN_block <span class="main">(</span>_doN_final <span class="free">e</span><span class="main">)</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="free">e</span>"</span>
  <span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">⪢</span> <span class="free">n</span><span class="main">)</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">_</span><span class="main">.</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Array Blit exposed to Sepref (Added after Competition)›</span></span>  

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">op_list_blit</span> <span class="free"><span class="bound"><span class="entity">src</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="free"><span class="bound"><span class="entity">di</span></span></span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">≡</span> 
    <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">di</span></span></span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span> <span class="main">@</span> take <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">src</span></span></span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span><span class="free"><span class="bound"><span class="entity">di</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">dst</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">context</span></span> 
    <span class="keyword2"><span class="keyword">notes</span></span> op_list_blit_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> 
  <span class="keyword2"><span class="keyword">begin</span></span>  
    <span class="keyword1"><span class="command">sepref_decl_op</span></span> <span class="main">(</span>no_def<span class="main">)</span> list_blit <span class="main">:</span> 
      <span class="quoted"><span class="quoted">"op_list_blit"</span></span> 
      <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">src</span><span class="main">,</span><span class="bound">si</span><span class="main">)</span><span class="main">,</span><span class="bound">dst</span><span class="main">)</span><span class="main">,</span><span class="bound">di</span><span class="main">)</span><span class="main">,</span><span class="bound">len</span><span class="main">)</span><span class="main">.</span> <span class="bound">si</span><span class="main">+</span><span class="bound">len</span> <span class="main">≤</span> length <span class="bound">src</span> <span class="main">∧</span> <span class="bound">di</span><span class="main">+</span><span class="bound">len</span> <span class="main">≤</span> length <span class="bound">dst</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub></span>  
        <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> nat_rel<span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel<span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> nat_rel<span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> nat_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1" id="VTcomp-blit_len"><span class="command">lemma</span></span> blit_len<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">+</span> <span class="free">len</span> <span class="main">≤</span> length <span class="free">src</span> <span class="main">∧</span> <span class="free">di</span> <span class="main">+</span> <span class="free">len</span> <span class="main">≤</span> length <span class="free">dst</span> 
    <span class="main">⟹</span> length <span class="main">(</span>op_list_blit <span class="free">src</span> <span class="free">si</span> <span class="free">dst</span> <span class="free">di</span> <span class="free">len</span><span class="main">)</span> <span class="main">=</span> length <span class="free">dst</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> op_list_blit_def<span class="main">)</span>
  
    
  <span class="keyword1"><span class="command">context</span></span> 
    <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">fcomp_norm_unfold</span><span class="main">]</span> <span class="main">=</span> array_assn_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">begin</span></span>    
    <span class="keyword1" id="VTcomp-array_blit_hnr_aux"><span class="command">lemma</span></span> array_blit_hnr_aux<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span>uncurry4 <span class="main">(</span><span class="main">λ</span><span class="bound">src</span> <span class="bound">si</span> <span class="bound">dst</span> <span class="bound">di</span> <span class="bound">len</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span> blit <span class="bound">src</span> <span class="bound">si</span> <span class="bound">dst</span> <span class="bound">di</span> <span class="bound">len</span><span class="main">;</span> return <span class="bound">dst</span> <span class="main">}</span><span class="main">)</span><span class="main">,</span> 
            uncurry4 mop_list_blit<span class="main">)</span> 
      <span class="main">∈</span> is_array<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span>nat_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span>is_array<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span>nat_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span>nat_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> is_array"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">sepref_to_hoare</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_array_def op_list_blit_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
    <span class="keyword1"><span class="command">sepref_decl_impl</span></span> <span class="main">(</span>ismop<span class="main">)</span> array_blit<span class="main">:</span> array_blit_hnr_aux <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DF_System">
<div class="head">
<h1>Theory DF_System</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Deadlock Free Transition Systems›</span></span>
<span class="keyword1"><span class="command">theory</span></span> DF_System
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Theories to describe deadlock free transitions system and 
    simulations between them.
  
    We added these locales after the competition, in order to get a cleaner
    solution for Challenge~3. This theory provides not much more than what is 
    needed for solving the challenge.
  ›</span></span>

  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Transition System›</span></span>
  <span class="keyword1"><span class="command">locale</span></span> system <span class="main">=</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">lstep</span> <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="main">≡</span> <span class="main">(</span>step<span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>

    <span class="keyword1" id="DF_System-reachable0"><span class="command">lemma</span></span> reachable0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_invar</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> reachable <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span> <span class="main">∧</span> step <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1" id="DF_System-is_invarI"><span class="command">lemma</span></span> is_invarI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> reachable <span class="bound">s</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> step <span class="bound">s</span> <span class="bound">s'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> is_invar <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_invar_def<span class="main">)</span>
    
    <span class="keyword1" id="DF_System-invar_reachable"><span class="command">lemma</span></span> invar_reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"is_invar <span class="free">I</span> <span class="main">⟹</span> reachable <span class="free">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">s</span>"</span></span>  
      <span class="keyword1"><span class="command">unfolding</span></span> reachable_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span><span class="main">)</span> <span class="comment1">(** Seriously? *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_invar_def reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">can_step</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="free">lstep</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">s'</span>"</span></span>
            
  <span class="keyword2"><span class="keyword">end</span></span>  

  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deadlock Free Transition System›</span></span>
  <span class="keyword1"><span class="command">locale</span></span> df_system <span class="main">=</span> system <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> no_deadlock<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> step <span class="free">s</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
  
    <span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Runs›</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lrun</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">lstep</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_run</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">l</span><span class="main">.</span> is_lrun <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
      
    <span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Weak Fairness›</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lfair</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">l</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span>can_step <span class="bound">l</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">l</span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_fair_run</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">l</span><span class="main">.</span> is_lrun <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> is_lfair <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
      
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definitions of runs. Used e.g. to clarify TCB of lemmas over systems.›</span></span>
    <span class="keyword1"><span class="command">lemmas</span></span> run_definitions <span class="main">=</span> is_lrun_def is_run_def is_lfair_def is_fair_run_def  
      
    <span class="keyword1" id="DF_System-is_run_alt"><span class="command">lemma</span></span> is_run_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="free">s</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">0</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> step <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_run_def is_lrun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
      
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rstep</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="free">lstep</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1" id="DF_System-fair_run_is_run"><span class="command">lemma</span></span> fair_run_is_run<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fair_run <span class="free">s</span> <span class="main">⟹</span> is_run <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_fair_run_def is_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Weaker fairness criterion, used internally in proofs only.›</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_fair'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">l</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span>can_step <span class="bound">l</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> rstep <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">j</span>"</span></span>

    <span class="keyword1" id="DF_System-fair_run_is_fair'"><span class="command">lemma</span></span> fair_run_is_fair'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fair_run <span class="free">s</span> <span class="main">⟹</span> is_fair' <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_fair_run_def is_run_def is_lrun_def is_fair'_def is_lfair_def rstep_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Run›</span></span>    
  <span class="keyword1"><span class="command">locale</span></span> run <span class="main">=</span> df_system <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RUN<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>  
    <span class="keyword1" id="DF_System-run0"><span class="command">lemma</span></span> run0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">0</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RUN
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_run_alt<span class="main">)</span>
    
    <span class="keyword1" id="DF_System-run_reachable"><span class="command">lemma</span></span> run_reachable<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> RUN
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_run_alt reachable_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span>
          
    <span class="keyword1" id="DF_System-run_invar"><span class="command">lemma</span></span> run_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"is_invar <span class="free">I</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> run_reachable invar_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
    <span class="keyword1" id="DF_System-stepE"><span class="command">lemma</span></span> stepE<span class="main">:</span> <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lstep</span> <span class="free">l</span> <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> RUN <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_run_alt<span class="main">)</span>
      
  <span class="keyword2"><span class="keyword">end</span></span>  
      
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fair Run›</span></span>    
  <span class="keyword1"><span class="command">locale</span></span> fair_run <span class="main">=</span> df_system <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FAIR<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fair_run <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">sublocale</span></span> run
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">using</span></span> FAIR fair_run_is_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">next_step_of</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≥</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span>can_step <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free">s</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> rstep <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free">s</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      
    <span class="keyword1" id="DF_System-next_step_step"><span class="command">lemma</span></span> next_step_step<span class="main">:</span> 
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="free">l</span>
      <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≡</span>next_step_of <span class="free">l</span> <span class="free">i</span>"</span></span> 
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span>can_step <span class="free">l</span> <span class="main">(</span><span class="free">s</span> <span class="free">j</span><span class="main">)</span> <span class="main">∨</span> rstep <span class="free">l</span> <span class="free">s</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fair_run_is_fair'<span class="main">[</span><span class="operator">OF</span> FAIR<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> is_fair'_def
      <span class="keyword1"><span class="command">unfolding</span></span> next_step_of_def j_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≥</span><span class="free">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span>can_step <span class="free">l</span> <span class="main">(</span><span class="free">s</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> rstep <span class="free">l</span> <span class="free">s</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dist_step</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> next_step_of <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>  
    
    <span class="keyword1" id="DF_System-nso_nostep"><span class="command">lemma</span></span> nso_nostep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>rstep <span class="free">l</span> <span class="free">s</span> <span class="free">i</span><span class="main">;</span> can_step <span class="free">l</span> <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span><span class="main">⟧</span> 
      <span class="main">⟹</span> next_step_of <span class="free">l</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> next_step_of <span class="free">l</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> next_step_of_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Suc_leD dual_order.antisym not_less_eq_eq<span class="main">)</span>
    
    <span class="keyword1" id="DF_System-rstep_cases"><span class="command">lemma</span></span> rstep_cases<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"can_step <span class="free">l</span> <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">obtains</span></span>
        <span class="main">(</span>other<span class="main">)</span> <span class="free">l'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≠</span><span class="free">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>rstep <span class="free">l</span> <span class="free">s</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"rstep <span class="free">l'</span> <span class="free">s</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"dist_step <span class="free">l</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> dist_step <span class="free">l</span> <span class="free">i</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>this<span class="main">)</span> <span class="quoted"><span class="quoted">"rstep <span class="free">l</span> <span class="free">s</span> <span class="free">i</span>"</span></span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"rstep <span class="free">l</span> <span class="free">s</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> nso_nostep<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> dist_step_def <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> RUN diff_commute diff_diff_cancel is_run_alt less_Suc_eq next_step_step rstep_def that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_diff<span class="main">)</span>
    
  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Simulation›</span></span>  
  <span class="keyword1"><span class="command">locale</span></span> simulation <span class="main">=</span>
    A<span class="main">:</span> df_system <span class="quoted"><span class="free">as<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">alstep</span></span> <span class="main">+</span> C<span class="main">:</span> df_system <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">clstep</span></span> 
      <span class="keyword2"><span class="keyword">for</span></span> <span class="free">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="free">clstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> xfer_reachable_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"C.reachable <span class="free">c</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">R</span> <span class="bound">a</span> <span class="free">c</span> <span class="main">∧</span> A.reachable <span class="bound">a</span>"</span></span> <span class="comment1">(* TODO: Redundant, can be derived from xfer_run. *)</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> xfer_run_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_run <span class="free">cs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">as</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> A.is_run <span class="bound">as</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> xfer_fair_run_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_fair_run <span class="free">cs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">as</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> A.is_fair_run <span class="bound">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1" id="DF_System-xfer_reachable"><span class="command">lemma</span></span> xfer_reachable<span class="main">:</span> 
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"C.reachable <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">as</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">as</span> <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"A.reachable <span class="free">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms xfer_reachable_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1" id="DF_System-xfer_run"><span class="command">lemma</span></span> xfer_run<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> CRUN<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_run <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">as</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"A.is_run <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">as</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xfer_run_aux assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
    <span class="keyword1" id="DF_System-xfer_fair_run"><span class="command">lemma</span></span> xfer_fair_run<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> FAIR<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_fair_run <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">as</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"A.is_fair_run <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">as</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xfer_fair_run_aux assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
  <span class="keyword2"><span class="keyword">end</span></span>
  
  <span class="keyword1" id="DF_System-sim_trans"><span class="command">lemma</span></span> sim_trans<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"simulation <span class="free">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">alstep</span> <span class="free">bs<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">blstep</span> <span class="free">R<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"simulation <span class="free">bs<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">blstep</span> <span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">clstep</span> <span class="free">R<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simulation <span class="free">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">alstep</span> <span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">clstep</span> <span class="main">(</span><span class="free">R<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">OO</span> <span class="free">R<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> simulation_def simulation_axioms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OO_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span><span class="main">)</span>
  
  <span class="comment1">(* Locale to introduce simulation by local argument *)</span>  
  <span class="keyword1"><span class="command">locale</span></span> simulationI <span class="main">=</span>
    A<span class="main">:</span> df_system <span class="quoted"><span class="free">as<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">alstep</span></span> <span class="main">+</span> C<span class="main">:</span> system <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">clstep</span></span> 
      <span class="keyword2"><span class="keyword">for</span></span> <span class="free">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="free">clstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'l</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> sim0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> sims<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>A.reachable <span class="free">as</span><span class="main">;</span> C.reachable <span class="free">cs</span><span class="main">;</span> <span class="free">R</span> <span class="free">as</span> <span class="free">cs</span><span class="main">;</span> <span class="free">clstep</span> <span class="free">l</span> <span class="free">cs</span> <span class="free">cs'</span><span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">∃</span><span class="bound">as'</span><span class="main">.</span> <span class="free">R</span> <span class="bound">as'</span> <span class="free">cs'</span> <span class="main">∧</span> <span class="free">alstep</span> <span class="free">l</span> <span class="free">as</span> <span class="bound">as'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> simb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>A.reachable <span class="free">as</span><span class="main">;</span> C.reachable <span class="free">cs</span><span class="main">;</span> <span class="free">R</span> <span class="free">as</span> <span class="free">cs</span><span class="main">;</span> A.can_step <span class="free">l</span> <span class="free">as</span><span class="main">⟧</span> <span class="main">⟹</span> C.can_step <span class="free">l</span> <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="DF_System-simb'"><span class="command">lemma</span></span> simb'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>A.reachable <span class="free">as</span><span class="main">;</span> C.reachable <span class="free">cs</span><span class="main">;</span> <span class="free">R</span> <span class="free">as</span> <span class="free">cs</span><span class="main">⟧</span> <span class="main">⟹</span> C.can_step <span class="free">l</span> <span class="free">cs</span> <span class="main">⟷</span> A.can_step <span class="free">l</span> <span class="free">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> simb sims 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A.can_step_def C.can_step_def<span class="main">)</span>

    <span class="keyword1" id="DF_System-xfer_reachable_aux2"><span class="command">lemma</span></span> xfer_reachable_aux2<span class="main">:</span> 
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"C.reachable <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">as</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">as</span> <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"A.reachable <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as</span><span class="main">.</span> <span class="free">R</span> <span class="bound">as</span> <span class="free">cs</span> <span class="main">∧</span> A.reachable <span class="bound">as</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> C.reachable_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> sim0 A.reachable0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> cs cs' l as
          <span class="keyword1"><span class="command">using</span></span> sims<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">cs'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C.reachable_def A.reachable_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>  

    <span class="keyword1"><span class="command">sublocale</span></span> C<span class="main">:</span> df_system <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">clstep</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A.no_deadlock xfer_reachable_aux2 simb system.can_step_def<span class="main">)</span>
    
    <span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
      <span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">arun</span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">arun</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free">as<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arun</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">as</span><span class="main">.</span> C.rstep <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="free">alstep</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">arun</span> <span class="free"><span class="bound"><span class="entity">cl</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="bound">as</span>  <span class="main">∧</span> <span class="free">R</span> <span class="bound">as</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
      <span class="keyword1" id="DF_System-xfer_lrun_aux2"><span class="command">lemma</span></span> xfer_lrun_aux2<span class="main">:</span>
        <span class="keyword2"><span class="keyword">assumes</span></span> CRUN<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_lrun <span class="free">cl</span> <span class="free">cs</span>"</span></span>
        <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">as</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"A.is_lrun <span class="free">cl</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">as</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> CRUN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"C.is_run <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C.is_run_def<span class="main">)</span>
      
        <span class="keyword1"><span class="command">interpret</span></span> C<span class="main">:</span> run <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">clstep</span></span> <span class="quoted"><span class="free">cs</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span>
      
      
        <span class="keyword1"><span class="command">have</span></span> X1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alstep</span> <span class="main">(</span><span class="free">cl</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>arun <span class="free">cl</span> <span class="free">cs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>arun <span class="free">cl</span> <span class="free">cs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> A.reachable <span class="main">(</span>arun <span class="free">cl</span> <span class="free">cs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">R</span> <span class="main">(</span>arun <span class="free">cl</span> <span class="free">cs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
          
          <span class="keyword1"><span class="command">have</span></span> CR<span class="main">:</span> <span class="quoted"><span class="quoted">"C.reachable <span class="main">(</span><span class="free">cs</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C.run_reachable <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">have</span></span> CS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">clstep</span> <span class="main">(</span><span class="free">cl</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> CRUN <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C.is_lrun_def<span class="main">)</span>
          
          <span class="keyword1"><span class="command">have</span></span> AX<span class="main">:</span> <span class="quoted"><span class="quoted">"A.reachable <span class="main">(</span>arun <span class="free">cl</span> <span class="free">cs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="free">R</span> <span class="main">(</span>arun <span class="free">cl</span> <span class="free">cs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> 0
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CRUN sim0<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
            
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"1.IH"</span><span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i'</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> arun.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A.reachable_def 
                <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
            
          <span class="keyword1"><span class="command">from</span></span> sims<span class="main">[</span><span class="operator">OF</span> _ CR _ CS<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"arun <span class="free">cl</span> <span class="free">cs</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> AX <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">asi</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">asi</span> <span class="main">(</span><span class="free">cs</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">alstep</span> <span class="main">(</span><span class="free">cl</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>arun <span class="free">cl</span> <span class="free">cs</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">asi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> someI2<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> CS <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C.rstep_def AX<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>        
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span>arun <span class="free">cl</span> <span class="free">cs</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> sim0
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> CRUN<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> X1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"arun <span class="free"><span class="free">cl</span></span> <span class="free"><span class="free">cs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A.is_lrun_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>    
    <span class="keyword2"><span class="keyword">end</span></span>
      
    <span class="keyword1" id="DF_System-xfer_run_aux2"><span class="command">lemma</span></span> xfer_run_aux2<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> CRUN<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_run <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">as</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"A.is_run <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">as</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> A.is_run_def C.is_run_def assms xfer_lrun_aux2<span class="main">)</span>
    
    <span class="keyword1" id="DF_System-xfer_fair_run_aux2"><span class="command">lemma</span></span> xfer_fair_run_aux2<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> FAIR<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_fair_run <span class="free">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">as</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"A.is_fair_run <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">as</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> FAIR <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        CLRUN<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_lrun <span class="skolem">cl</span> <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        CFAIR<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_lfair <span class="skolem">cl</span> <span class="free">cs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C.is_fair_run_def<span class="main">)</span>
    
      <span class="keyword1"><span class="command">from</span></span> xfer_lrun_aux2<span class="main">[</span><span class="operator">OF</span> CLRUN<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        ALRUN<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_lrun <span class="skolem">cl</span> <span class="skolem">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> SIM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="skolem">as</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

      <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> run <span class="quoted"><span class="free">as<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">alstep</span></span> <span class="quoted"><span class="skolem">as</span></span>
              <span class="main">+</span> C<span class="main">:</span> run <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">clstep</span></span> <span class="quoted"><span class="free">cs</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>        
        <span class="keyword1"><span class="command">using</span></span> ALRUN CLRUN
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A.is_run_def C.is_run_def<span class="main">)</span>
        
                
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A.is_lfair <span class="skolem">cl</span> <span class="skolem">as</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> A.is_lfair_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A.run_reachable C.is_lfair_def C.run_reachable CFAIR SIM simb'<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ALRUN SIM that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> A.is_fair_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>    
    
    <span class="keyword1"><span class="command">sublocale</span></span> simulation
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">using</span></span> xfer_reachable_aux2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> xfer_run_aux2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> xfer_fair_run_aux2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Snippets">
<div class="head">
<h1>Theory Snippets</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Code Snippets›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Snippets
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="VTcomp.html">lib/VTcomp</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Find Element in Array (Arrays)›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">find_elem</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>int<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="keyword1">doN</span> <span class="main">{</span>
    WHILEIT <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≤</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">∉</span>set <span class="main">(</span>take <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">≠</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> RETURN <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>
  <span class="main">}</span>"</span></span>
  
  <span class="keyword1" id="Snippets-find_elem_correct"><span class="command">lemma</span></span> find_elem_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"find_elem <span class="free">x</span> <span class="free">xs</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≤</span>length <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free">xs</span> <span class="main">⟶</span> <span class="free">xs</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_elem_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_measure<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> length <span class="free">xs</span> <span class="main">-</span> <span class="bound">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="comment1">(*sledgehammer*)</span>
    <span class="keyword1"><span class="command">using</span></span> less_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">find_elem_impl</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"uncurry find_elem"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>array_assn int_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> nat_assn"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_elem_def short_circuit_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
  
  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">find_elem_impl</span></span> <span class="keyword2"><span class="keyword">in</span></span> Haskell <span class="keyword2"><span class="keyword">module_name</span></span> test

  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Combined Correctness Theorem›</span></span>  
  <span class="keyword1" id="Snippets-find_elem_r1"><span class="command">lemma</span></span> find_elem_r1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>find_elem<span class="main">,</span> <span class="main">λ</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≤</span>length <span class="bound">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="bound">xs</span> <span class="main">⟶</span> <span class="bound">xs</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_elem_correct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nres_relI<span class="main">)</span>
  
  <span class="keyword1"><span class="command">thm</span></span> find_elem_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> find_elem_r1<span class="main">]</span>
  

  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Check Prefix (Arrays, Exceptions: Check)›</span></span>
    
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">check_prefix</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> <span class="keyword1">doE</span> <span class="main">{</span>
    CHECK <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">()</span><span class="main">;</span>
    EWHILEIT <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≤</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> take <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> take <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">doE</span> <span class="main">{</span> 
      EASSERT <span class="main">(</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">;</span> 
      CHECK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span> 
      ERETURN <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> 
    <span class="main">}</span> <span class="main">)</span> <span class="main">0</span><span class="main">;</span>
    ERETURN <span class="main">()</span>
  <span class="main">}</span>"</span></span>
  
  <span class="comment1">(* ESPEC Exc Normal ! *)</span>
  <span class="keyword1" id="Snippets-check_prefix_correct"><span class="command">lemma</span></span> check_prefix_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"check_prefix <span class="free">xs</span> <span class="free">ys</span> <span class="main">≤</span> ESPEC <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">xs</span> <span class="main">≠</span> take <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> check_prefix_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> EWHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> length <span class="free">xs</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_take<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">synth_definition</span></span> <span class="entity">check_prefix_bd</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"check_prefix <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">⌑</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> CNV_eqD<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> check_prefix_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">opt_enres_unfold</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> CNV_I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">check_prefix_impl</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"uncurry check_prefix_bd"</span></span> 
    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>array_assn int_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>array_assn int_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>unit_assn <span class="keyword1">+<span class="hidden">⇩</span><sub>a</sub></span> unit_assn<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> check_prefix_bd_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
  
  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">check_prefix_impl</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML_imp

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Modularity›</span></span>
    
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_vcg</span><span class="main">]</span> <span class="main">=</span> check_prefix_correct<span class="main">[</span><span class="operator">THEN</span> ESPEC_trans<span class="main">]</span>
  <span class="keyword1"><span class="command">thm</span></span> SPEC_trans <span class="comment1">(* for plain nres-monad without exceptions *)</span>
    
  <span class="comment1">(* TODO: I remember to have automated the order_trans transformation, but cannot find it right now. *)</span>
  

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_prefix'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> CATCH <span class="main">(</span><span class="keyword1">doE</span> <span class="main">{</span>check_prefix <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">;</span> ERETURN True <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> ERETURN False<span class="main">)</span>"</span></span>  
  
  <span class="keyword1" id="Snippets-is_prefix'_correct"><span class="command">lemma</span></span> is_prefix'_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix' <span class="free">xs</span> <span class="free">ys</span> <span class="main">≤</span> ESPEC <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_prefix'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">sepref_fr_rules</span><span class="main">]</span> <span class="main">=</span> check_prefix_impl.refine  
  <span class="keyword1"><span class="command">sepref_register</span></span> <span class="quoted">check_prefix_bd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span>unit<span class="main">+</span>unit<span class="main">)</span> nres"</span></span>
    <span class="comment1">(* Optional interface type. Required if interfaces used that do not match Isabelle types, e.g. i_map, i_mtx, …*)</span>

  <span class="keyword1"><span class="command">synth_definition</span></span> <span class="entity">is_prefix_bd'</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix' <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">⌑</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> CNV_eqD<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_prefix'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">opt_enres_unfold</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> CNV_I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">is_prefix_impl'</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"uncurry is_prefix_bd'"</span></span> 
    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>array_assn int_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>array_assn int_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>unit_assn <span class="keyword1">+<span class="hidden">⇩</span><sub>a</sub></span> bool_assn<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_prefix_bd'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
  
  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">is_prefix_impl'</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML_imp
  
  
      

  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Is Prefix (Arrays, Exceptions: Catch)›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_prefix</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> CATCH <span class="main">(</span><span class="keyword1">doE</span> <span class="main">{</span>
    CHECK <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> False<span class="main">;</span>
    EWHILEIT <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≤</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> take <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> take <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">doE</span> <span class="main">{</span> 
      EASSERT <span class="main">(</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">;</span> 
      CHECK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> False<span class="main">;</span>
      ERETURN <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> 
    <span class="main">}</span> <span class="main">)</span> <span class="main">0</span><span class="main">;</span>
    THROW True
  <span class="main">}</span><span class="main">)</span> <span class="main">(</span>ERETURN<span class="main">)</span>"</span></span>
  
  <span class="comment1">(* ESPEC Exc Normal ! *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">xs</span> <span class="free">ys</span> <span class="main">≤</span> ESPEC <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_prefix_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> EWHILEIT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> length <span class="free">xs</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_take<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">synth_definition</span></span> <span class="entity">is_prefix_bd</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="main">[</span><span class="operator">enres_unfolds</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_prefix <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">⌑</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> CNV_eqD<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_prefix_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">opt_enres_unfold</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> CNV_I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">is_prefix_impl</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"uncurry is_prefix_bd"</span></span> 
    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>array_assn int_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>array_assn int_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">(</span>unit_assn <span class="keyword1">+<span class="hidden">⇩</span><sub>a</sub></span> bool_assn<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_prefix_bd_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
  
  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">is_prefix_impl</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML_imp
  
  
  
  
  
  
  
  
  
  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Copy Array (Arrays, For i=l..u)›</span></span>  
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cp_array</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="keyword1">doN</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> op_array_replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">;</span>   <span class="comment1">― ‹Use proper constructors›</span>
    
    <span class="bound">ys</span> <span class="main">←</span> nfoldli <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">ys</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>  <span class="comment1">― ‹Ensure linearity! <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>ys←…›</span></span>›</span>
      ASSERT <span class="main">(</span><span class="bound">i</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="bound">ys</span><span class="main">)</span><span class="main">;</span> 
      RETURN <span class="main">(</span><span class="bound">ys</span><span class="main">[</span><span class="bound">i</span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> 
    <span class="main">}</span><span class="main">)</span> <span class="bound">ys</span><span class="main">;</span>
    
    RETURN <span class="bound">ys</span>
  <span class="main">}</span>"</span></span>

  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"cp_array <span class="free">xs</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span><span class="main">=</span><span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cp_array_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> nfoldli_rule nfoldli_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>set <span class="bound">l1</span><span class="main">.</span> <span class="bound">ys</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">refine_vcg</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> upt_eq_lel_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> upt_eq_lel_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_list_update<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
    

  <span class="keyword1"><span class="command">term</span></span> <span class="quoted">arl_assn</span>  
    
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nfoldli_upt_rule›</span></span></span></span>›</span></span>  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"cp_array <span class="free">xs</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span><span class="main">=</span><span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cp_array_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> nfoldli_upt_rule nfoldli_upt_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> <span class="bound">ys</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">refine_vcg</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> less_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      
  
    
  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">cp_array_impl</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">cp_array</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>array_assn nat_assn<span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> array_assn nat_assn"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cp_array_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
  
  
  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Challenge1">
<div class="head">
<h1>Theory Challenge1</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Gap Buffer›</span></span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Challenge›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹{\upshape
A gap buffer is a data structure for the implementation of text editors,
which can efficiently move the cursor, as well add and delete characters.

The idea is simple: the editor's content is represented as a character array~$a$
of length~$n$,
which has a gap of unused entries $a[l], \ldots, a[r-1]$,
with respect to two indices $l \le r$.
The data it represents is composed as $a[0], \ldots, a[l-1], a[r], ..., a[n-1]$.

The current cursor position is at the left index $l$, and if we type a character, it is
written to $a[l]$ and $l$ is increased.
When the gap becomes empty, the array is enlarged and the data from $r$ is shifted to the right.

\paragraph{Implementation task.}
Implement the following four operations in the language of your tool:
Procedures \verb|left()| and \verb|right()| move the cursor by one character;
\verb|insert()| places a character at the beginning of the gap $a[l]$;
\verb|delete()| removes the character at $a[l]$ from the range of text.

\begin{multicols}{2}
\begin{lstlisting}[language=C,morekeywords={procedure,function,end,to,in,var,then,not,mod}]
procedure left()
    if l != 0 then
        l := l - 1
        r := r - 1
        a[r] := a[l]
    end-if
end-procedure


procedure right()
    // your task: similar to left()
    // but pay attention to the
    // order of statements
end-procedure
\end{lstlisting}

\begin{lstlisting}[language=C,morekeywords={procedure,function,end,to,in,var,then,not,mod}]
procedure insert(x: char)
    if l == r then
        // see extended task
        grow()
    end-if
    a[l] := x
    l := l + 1
end-procedure

procedure delete()
    if l != 0 then
        l := l - 1
    end-if
end-procedure
\end{lstlisting}
\end{multicols}

\paragraph{Verification task.}
Specify the intended behavior of the buffer in terms of a contiguous
representation of the editor content.
This can for example be based on strings, functional arrays, sequences, or lists.
Verify that the gap buffer implementation satisfies this specification,
and that every access to the array is within bounds.

\emph{Hint:}
For this task you may assume that \verb|insert()| has the
precondition $l &lt; r$ and remove the call to \verb|grow()|.
Alternatively, assume a contract for \verb|grow()| that ensures
that this call does not change the abstract representation.

\paragraph{Extended verification task.}
Implement the operation \verb|grow()|, specify its behavior in a way that lets
you verify \verb|insert()| in a modular way
(i.e. not by referring to the implementation of \verb|grow()|),
and verify that \verb|grow()| satisfies this specification.

\emph{Hint}: You may assume that the allocation of the new buffer always succeeds.
If~your tool/language supports copying array ranges (such as
\verb|System.arraycopy()| in Java),
consider using these primitives instead of the loops in the
pseudo-code below.

\begin{lstlisting}[language=C,morekeywords={procedure,function,end,to,in,new,var,then,not,mod}]
procedure grow()
    var b := new char[a.length + K]

    // b[0..l] := a[0..l]
    for i = 0 to l - 1 do
        b[i] := a[i]
    end-for

    // b[r + K..] := a[r..]
    for i = r to a.length - 1 do
        b[i + K] := a[i]
    end-for

    r := r + K
    a := b
end-procedure
\end{lstlisting}

\paragraph{Resources}
\begin{itemize}
\item \url{https://en.wikipedia.org/wiki/Gap_buffer}
\item \url{http://scienceblogs.com/goodmath/2009/02/18/gap-buffers-or-why-bother-with-1}
\end{itemize}
}
\clearpage  
›</span></span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Solution›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Challenge1
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="VTcomp.html">lib/VTcomp</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Fully fledged specification of textbuffer ADT,
    and its implementation by a gap buffer.
  ›</span></span>
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract Specification›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Initially, we modelled the abstract text as a cursor position and a list.
    However, this gives you an invariant on the abstract level. An isomorphic
    but invariant free formulation is a pair of lists, representing the text 
    before and after the cursor.
  ›</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> textbuffer <span class="main">=</span> BUF <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The primitive operations are the empty textbuffer, 
    and to extract the text and the cursor position›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> textbuffer"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">=</span> BUF <span class="main">[]</span> <span class="main">[]</span>"</span></span>  
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">get_text</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> textbuffer <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_text</span> <span class="main">(</span>BUF <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">get_pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> textbuffer <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_pos</span> <span class="main">(</span>BUF <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These are the operations that were specified in the challenge›</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">move_left</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> textbuffer <span class="main">⇒</span> <span class="tfree">'a</span> textbuffer"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">move_left</span> <span class="main">(</span>BUF <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">≠</span><span class="main">[]</span> <span class="keyword1">then</span> BUF <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="keyword1">else</span> BUF <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">move_right</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> textbuffer <span class="main">⇒</span> <span class="tfree">'a</span> textbuffer"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">move_right</span> <span class="main">(</span>BUF <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">≠</span><span class="main">[]</span> <span class="keyword1">then</span> BUF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">@</span><span class="main">[</span>hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="keyword1">else</span> BUF <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> textbuffer <span class="main">⇒</span> <span class="tfree">'a</span> textbuffer"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>BUF <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> BUF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> textbuffer <span class="main">⇒</span> <span class="tfree">'a</span> textbuffer"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="main">(</span>BUF <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> BUF <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> 
   <span class="comment1">― ‹Note that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">lemma</span> <span class="quoted">‹butlast <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>›</span> <span class="keyword1"><span class="keyword">by</span></span> <span class="operator">simp</span><span class="antiquote">}</span></span> in Isabelle›</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can also assign them a meaning wrt position and text›</span></span>  
  
  <span class="keyword1" id="Challenge1-empty_pos"><span class="command">lemma</span></span> empty_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"get_pos empty <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> empty_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Challenge1-empty_text"><span class="command">lemma</span></span> empty_text<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"get_text empty <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> empty_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Challenge1-move_left_pos"><span class="command">lemma</span></span> move_left_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"get_pos <span class="main">(</span>move_left <span class="free">b</span><span class="main">)</span> <span class="main">=</span> get_pos <span class="free">b</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="comment1">― ‹Note that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">lemma</span> <span class="quoted">‹<span class="main">0</span><span class="main">-</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">=</span><span class="main">0</span>›</span> <span class="keyword1"><span class="keyword">by</span></span> <span class="operator">simp</span><span class="antiquote">}</span></span> in Isabelle›</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1" id="Challenge1-move_left_text"><span class="command">lemma</span></span> move_left_text<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"get_text <span class="main">(</span>move_left <span class="free">b</span><span class="main">)</span> <span class="main">=</span> get_text <span class="free">b</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Challenge1-move_right_pos"><span class="command">lemma</span></span> move_right_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"get_pos <span class="main">(</span>move_right <span class="free">b</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>get_pos <span class="free">b</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span>get_text <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1" id="Challenge1-move_right_text"><span class="command">lemma</span></span> move_right_text<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"get_text <span class="main">(</span>move_right <span class="free">b</span><span class="main">)</span> <span class="main">=</span> get_text <span class="free">b</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>
    
  <span class="keyword1" id="Challenge1-insert_pos"><span class="command">lemma</span></span> insert_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"get_pos <span class="main">(</span>insert <span class="free">x</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> get_pos <span class="free">b</span> <span class="main">+</span> <span class="main">1</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1" id="Challenge1-insert_text"><span class="command">lemma</span></span> insert_text<span class="main">:</span> <span class="quoted"><span class="quoted">"get_text <span class="main">(</span>insert <span class="free">x</span> <span class="free">b</span><span class="main">)</span> 
    <span class="main">=</span> take <span class="main">(</span>get_pos <span class="free">b</span><span class="main">)</span> <span class="main">(</span>get_text <span class="free">b</span><span class="main">)</span><span class="main">@</span><span class="free">x</span><span class="main">#</span>drop <span class="main">(</span>get_pos <span class="free">b</span><span class="main">)</span> <span class="main">(</span>get_text <span class="free">b</span><span class="main">)</span>"</span></span>    
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>
    
  <span class="keyword1" id="Challenge1-delete_pos"><span class="command">lemma</span></span> delete_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"get_pos <span class="main">(</span>delete <span class="free">b</span><span class="main">)</span> <span class="main">=</span> get_pos <span class="free">b</span> <span class="main">-</span> <span class="main">1</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1" id="Challenge1-delete_text"><span class="command">lemma</span></span> delete_text<span class="main">:</span> <span class="quoted"><span class="quoted">"get_text <span class="main">(</span>delete <span class="free">b</span><span class="main">)</span> 
    <span class="main">=</span> take <span class="main">(</span>get_pos <span class="free">b</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>get_text <span class="free">b</span><span class="main">)</span><span class="main">@</span>drop <span class="main">(</span>get_pos <span class="free">b</span><span class="main">)</span> <span class="main">(</span>get_text <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the zero case, we can prove a simpler (equivalent) lemma›</span></span>  
  <span class="keyword1" id="Challenge1-delete_text0"><span class="command">lemma</span></span> delete_text0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"get_pos <span class="free">b</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> get_text <span class="main">(</span>delete <span class="free">b</span><span class="main">)</span> <span class="main">=</span> get_text <span class="free">b</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹To fully exploit the capabilities of our tool, we can (optionally) show 
    that the operations of a text buffer are parametric in its content. 
    Then, we can automatically refine the representation of the content.
  ›</span></span>    
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">textbuffer_rel</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>BUF <span class="bound">a</span> <span class="bound">b</span><span class="main">,</span> BUF <span class="bound">a'</span> <span class="bound">b'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">a'</span> <span class="bound">b'</span><span class="main">.</span> 
                           <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟩</span>list_rel <span class="main">∧</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">b'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟩</span>list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>BUF<span class="main">,</span>BUF<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> textbuffer_rel_def<span class="main">)</span>        
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rec_textbuffer<span class="main">,</span>rec_textbuffer<span class="main">)</span>
    <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel<span class="main">→</span><span class="free">B</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel <span class="main">→</span> <span class="free">B</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> textbuffer_rel_def<span class="main">)</span> <span class="operator">parametricity</span>


  <span class="keyword1"><span class="command">context</span></span> 
    <span class="keyword2"><span class="keyword">notes</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> 
      empty_def get_text_def get_pos_def move_left_def move_right_def 
      insert_def delete_def conv_to_is_Nil
  <span class="keyword2"><span class="keyword">begin</span></span>      
    <span class="keyword1"><span class="command">sepref_decl_op</span></span> <span class="main">(</span>no_def<span class="main">)</span> <span class="quoted">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">sepref_decl_op</span></span> <span class="main">(</span>no_def<span class="main">)</span> <span class="quoted">get_text</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">sepref_decl_op</span></span> <span class="main">(</span>no_def<span class="main">)</span> <span class="quoted">get_pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel <span class="main">→</span> nat_rel"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">sepref_decl_op</span></span> <span class="main">(</span>no_def<span class="main">)</span> <span class="quoted">move_left</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">sepref_decl_op</span></span> <span class="main">(</span>no_def<span class="main">)</span> <span class="quoted">move_right</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">sepref_decl_op</span></span> <span class="main">(</span>no_def<span class="main">)</span> <span class="quoted">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">→</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">sepref_decl_op</span></span> <span class="main">(</span>no_def<span class="main">)</span> <span class="quoted">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>textbuffer_rel"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>    
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement 1: List with Gap›</span></span>  
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation on List-Level›</span></span>  
  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> gap_buffer <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat <span class="main">×</span> <span class="tfree">'a</span> list"</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Abstraction Relation›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Also called coupling relation sometimes. 
    Can be any relation, here we define it by an invariant and an 
    abstraction function.  ›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gap_α</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> BUF <span class="main">(</span>take <span class="bound">l</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">(</span>drop <span class="bound">r</span> <span class="bound">buf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gap_invar</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="bound">l</span><span class="main">≤</span><span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span><span class="main">≤</span>length <span class="bound">buf</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gap_rel</span> <span class="main">≡</span> br gap_α gap_invar"</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Empty›</span></span>
      
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty1</span> <span class="main">≡</span> RETURN <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1" id="Challenge1-empty1_correct"><span class="command">lemma</span></span> empty1_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>empty1<span class="main">,</span> RETURN empty<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>gap_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> empty1_def empty_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv gap_α_def gap_invar_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Left›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">move_left1</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>
    <span class="keyword1">if</span> <span class="bound">l</span><span class="main">≠</span><span class="main">0</span> <span class="keyword1">then</span> <span class="keyword1">doN</span> <span class="main">{</span>
      ASSERT<span class="main">(</span><span class="bound">r</span><span class="main">-</span><span class="main">1</span><span class="main">&lt;</span>length <span class="bound">buf</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">-</span><span class="main">1</span><span class="main">&lt;</span>length <span class="bound">buf</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="main">(</span><span class="bound">l</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="bound">r</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="bound">buf</span><span class="main">[</span><span class="bound">r</span><span class="main">-</span><span class="main">1</span><span class="main">:=</span><span class="bound">buf</span><span class="main">!</span><span class="main">(</span><span class="bound">l</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

  <span class="keyword1" id="Challenge1-move_left1_correct"><span class="command">lemma</span></span> move_left1_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>move_left1<span class="main">,</span> RETURN <span class="keyword1">o</span> move_left<span class="main">)</span> <span class="main">∈</span> gap_rel <span class="main">→</span> <span class="main">⟨</span>gap_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> move_left1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv gap_α_def gap_invar_def move_left1_def 
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_take<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Cons_nth_drop_Suc One_nat_def Suc_pred diff_Suc_less 
        drop_update_cancel last_take_nth_conv le_trans length_list_update 
        less_le_trans neq0_conv nth_list_update_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Right›</span></span>        
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">move_right1</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>
    <span class="keyword1">if</span> <span class="bound">r</span><span class="main">&lt;</span>length <span class="bound">buf</span> <span class="keyword1">then</span> <span class="keyword1">doN</span> <span class="main">{</span>
      ASSERT <span class="main">(</span><span class="bound">l</span><span class="main">&lt;</span>length <span class="bound">buf</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="main">(</span><span class="bound">l</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="bound">r</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="bound">buf</span><span class="main">[</span><span class="bound">l</span><span class="main">:=</span><span class="bound">buf</span><span class="main">!</span><span class="bound">r</span><span class="main">]</span><span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
    
  <span class="keyword1" id="Challenge1-move_right1_correct"><span class="command">lemma</span></span> move_right1_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>move_right1<span class="main">,</span>RETURN <span class="keyword1">o</span> move_right<span class="main">)</span> <span class="main">∈</span> gap_rel <span class="main">→</span> <span class="main">⟨</span>gap_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> move_right1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command">unfolding</span></span> gap_α_def gap_invar_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv hd_drop_conv_nth take_update_last
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_Suc tl_drop<span class="main">)</span>
        
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insert and Grow›</span></span>
     
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">can_insert</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="bound">l</span><span class="main">&lt;</span><span class="bound">r</span>"</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">grow1</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> op_array_replicate <span class="main">(</span>length <span class="bound">buf</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span> default<span class="main">;</span>
    <span class="bound">b</span> <span class="main">←</span> mop_list_blit <span class="bound">buf</span> <span class="main">0</span> <span class="bound">b</span> <span class="main">0</span> <span class="bound">l</span><span class="main">;</span>
    <span class="bound">b</span> <span class="main">←</span> mop_list_blit <span class="bound">buf</span> <span class="bound">r</span> <span class="bound">b</span> <span class="main">(</span><span class="bound">r</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span> <span class="main">(</span>length <span class="bound">buf</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span><span class="bound">b</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
  
  <span class="keyword1" id="Challenge1-grow1_correct"><span class="command">lemma</span></span> grow1_correct<span class="main">[</span><span class="operator">THEN</span> SPEC_trans<span class="main">,</span> <span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gap_invar <span class="free">gb</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"grow1 <span class="free">K</span> <span class="free">gb</span>  <span class="main">≤</span> <span class="main">(</span>SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">gb'</span><span class="main">.</span> 
          gap_invar <span class="bound">gb'</span> 
        <span class="main">∧</span> gap_α <span class="bound">gb'</span> <span class="main">=</span> gap_α <span class="free">gb</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="free">K</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">⟶</span> can_insert <span class="bound">gb'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grow1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>    
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> gap_α_def gap_invar_def can_insert_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> op_list_blit_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span> <span class="main">←</span> 
      <span class="keyword1">if</span> <span class="main">(</span><span class="bound">l</span><span class="main">=</span><span class="bound">r</span><span class="main">)</span> <span class="keyword1">then</span> grow1 <span class="main">(</span>length <span class="bound">buf</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span><span class="bound">l</span><span class="main">&lt;</span>length <span class="bound">buf</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">l</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">[</span><span class="bound">l</span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>
  <span class="main">}</span>"</span></span> 
  
  <span class="keyword1" id="Challenge1-insert1_correct"><span class="command">lemma</span></span> insert1_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>insert1<span class="main">,</span>RETURN <span class="keyword1">oo</span> insert<span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> gap_rel <span class="main">→</span> <span class="main">⟨</span>gap_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> insert1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> insert_def gap_α_def gap_invar_def can_insert_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv take_update_last <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Delete›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">delete1</span> 
    <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span><span class="main">&gt;</span><span class="main">0</span> <span class="keyword1">then</span> RETURN <span class="main">(</span><span class="bound">l</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span>"</span></span> 
  <span class="keyword1" id="Challenge1-delete1_correct"><span class="command">lemma</span></span> delete1_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>delete1<span class="main">,</span>RETURN <span class="keyword1">o</span> delete<span class="main">)</span> <span class="main">∈</span> gap_rel <span class="main">→</span> <span class="main">⟨</span>gap_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> delete1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command">unfolding</span></span> gap_α_def gap_invar_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv butlast_take <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Imperative Arrays and Executable Code›</span></span>  
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gap_impl_assn</span> <span class="main">≡</span> nat_assn <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> nat_assn <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> array_assn id_assn"</span></span>  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gap_assn</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> 
    <span class="main">≡</span> hr_comp <span class="main">(</span>hr_comp gap_impl_assn gap_rel<span class="main">)</span> <span class="main">(</span><span class="main">⟨</span>the_pure <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟩</span>textbuffer_rel<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">context</span></span> 
    <span class="keyword2"><span class="keyword">notes</span></span> gap_assn_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">fcomp_norm_unfold</span><span class="main">]</span> 
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">empty_impl</span> 
      <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"uncurry0 empty1"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> empty1_def array.fold_custom_empty
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
    <span class="keyword1"><span class="command">sepref_decl_impl</span></span> empty_impl<span class="main">:</span> empty_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> empty1_correct<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  
    <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">move_left_impl</span> 
      <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">move_left1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"gap_impl_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span><span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> move_left1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
    <span class="keyword1"><span class="command">sepref_decl_impl</span></span> move_left_impl<span class="main">:</span> move_left_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> move_left1_correct<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  
    <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">move_right_impl</span> 
      <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">move_right1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"gap_impl_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span><span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> move_right1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
    <span class="keyword1"><span class="command">sepref_decl_impl</span></span> move_right_impl<span class="main">:</span> move_right_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> move_right1_correct<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    
    <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">insert_impl</span> 
      <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"uncurry insert1"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span><span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> insert1_def grow1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span> 
      <span class="comment1">― ‹We inline <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> grow1<span class="antiquote">}</span></span> here›</span>
    <span class="keyword1"><span class="command">sepref_decl_impl</span></span> insert_impl<span class="main">:</span> insert_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> insert1_correct<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    
    <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">delete_impl</span> 
      <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">delete1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"gap_impl_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span><span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> delete1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
    <span class="keyword1"><span class="command">sepref_decl_impl</span></span> delete_impl<span class="main">:</span> delete_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> delete1_correct<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The above setup generated the following refinement theorems, connecting the implementations
  with our abstract specification:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display]
    empty_impl_hnr move_left_impl_hnr move_right_impl_hnr insert_impl_hnr delete_impl_hnr
  <span class="antiquote"><span class="antiquote">}</span></span></span></span>
  ›</span></span>

  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">move_left_impl</span></span> <span class="quoted"><span class="quoted">move_right_impl</span></span> <span class="quoted"><span class="quoted">insert_impl</span></span> <span class="quoted"><span class="quoted">delete_impl</span></span>  
    <span class="keyword2"><span class="keyword">in</span></span> SML_imp <span class="keyword2"><span class="keyword">module_name</span></span> Gap_Buffer
    <span class="keyword2"><span class="keyword">in</span></span> OCaml_imp <span class="keyword2"><span class="keyword">module_name</span></span> Gap_Buffer
    <span class="keyword2"><span class="keyword">in</span></span> Haskell <span class="keyword2"><span class="keyword">module_name</span></span> Gap_Buffer
    <span class="keyword2"><span class="keyword">in</span></span> Scala <span class="keyword2"><span class="keyword">module_name</span></span> Gap_Buffer
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Simple Client›</span></span>
    
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">client</span> <span class="main">≡</span> RETURN <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">)</span> <span class="main">[</span>
    insert <span class="main">(</span><span class="main">1</span><span class="main">::</span>int<span class="main">)</span><span class="main">,</span>
    insert <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>int<span class="main">)</span><span class="main">,</span>
    insert <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>int<span class="main">)</span><span class="main">,</span>
    insert <span class="main">(</span><span class="numeral">5</span><span class="main">::</span>int<span class="main">)</span><span class="main">,</span>
    move_left<span class="main">,</span>
    insert <span class="main">(</span><span class="numeral">4</span><span class="main">::</span>int<span class="main">)</span><span class="main">,</span>
    move_right<span class="main">,</span>
    insert <span class="main">(</span><span class="numeral">6</span><span class="main">::</span>int<span class="main">)</span><span class="main">,</span>
    delete
  <span class="main">]</span> empty<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"client <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> get_text <span class="bound">r</span><span class="main">=</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> client_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_text insert_text<span class="main">)</span>
  
  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">client_impl</span> 
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"uncurry0 client"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> gap_assn id_assn"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> client_def fold.simps id_def comp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

  <span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">client_impl</span><span class="antiquote">}</span></span></span> <span class="main">(</span><span class="main">)</span> 
  ›</span>      
        
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Challenge1_short">
<div class="head">
<h1>Theory Challenge1_short</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Shorter Solution›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Challenge1_short
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="VTcomp.html">lib/VTcomp</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Small specification of textbuffer ADT,
  and its implementation by a gap buffer.
  
  Annotated and elaborated version of just the challenge requirements.
›</span></span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract Specification›</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> textbuffer <span class="main">=</span> BUF <span class="main">(</span><span class="quoted">"<span class="free"><span class="entity">pos</span></span>"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nat"</span></span><span class="main">)</span> <span class="main">(</span><span class="quoted">"<span class="free"><span class="entity">text</span></span>"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span><span class="main">)</span>
  <span class="comment1">― ‹Note that we do not model the abstract invariant --- pos in range --- here,
    as it is not strictly required for the challenge spec.›</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These are the operations that were specified in the challenge.
    Note: Isabelle has type inference, so we do not need to specify types.
    Note: We exploit that, in Isabelle, we have <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>nat<span class="main"><span class="main">)</span></span><span class="main"><span class="main">-</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">=</span></span><span class="main"><span class="main">0</span></span>"</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="operator"><span class="operator">simp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  ›</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">move_left</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">move_left</span> <span class="main">(</span>BUF <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> BUF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> 
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">move_right</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">move_right</span> <span class="main">(</span>BUF <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> BUF <span class="main">(</span>min <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">insert</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>BUF <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> BUF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span>drop <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">delete</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="main">(</span>BUF <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> BUF <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">@</span>drop <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement 1: List with Gap›</span></span>  
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation on List-Level›</span></span>  
  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> gap_buffer <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat <span class="main">×</span> <span class="tfree">'a</span> list"</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Abstraction Relation›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define an invariant on the concrete gap-buffer, and its mapping to the
    abstract model. From these two, we define a relation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>gap_rel›</span></span></span></span> between
    concrete and abstract buffers. ›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gap_α</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> BUF <span class="bound">l</span> <span class="main">(</span>take <span class="bound">l</span> <span class="bound">buf</span> <span class="main">@</span> drop <span class="bound">r</span> <span class="bound">buf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gap_invar</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="bound">l</span><span class="main">≤</span><span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span><span class="main">≤</span>length <span class="bound">buf</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gap_rel</span> <span class="main">≡</span> br gap_α gap_invar"</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Left›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the operations, we insert assertions. These are not required to prove
    the list-level specification correct (during the proof, they are inferred easily).
    However, they are required in the subsequent automatic refinement step to arrays,
    to give our tool the information that all indexes are, indeed, in bounds.›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">move_left1</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>
    <span class="keyword1">if</span> <span class="bound">l</span><span class="main">≠</span><span class="main">0</span> <span class="keyword1">then</span> <span class="keyword1">doN</span> <span class="main">{</span>
      ASSERT<span class="main">(</span><span class="bound">r</span><span class="main">-</span><span class="main">1</span><span class="main">&lt;</span>length <span class="bound">buf</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">-</span><span class="main">1</span><span class="main">&lt;</span>length <span class="bound">buf</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="main">(</span><span class="bound">l</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="bound">r</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="bound">buf</span><span class="main">[</span><span class="bound">r</span><span class="main">-</span><span class="main">1</span><span class="main">:=</span><span class="bound">buf</span><span class="main">!</span><span class="main">(</span><span class="bound">l</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

  <span class="keyword1" id="Challenge1_short-move_left1_correct"><span class="command">lemma</span></span> move_left1_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>move_left1<span class="main">,</span> RETURN <span class="keyword1">o</span> move_left<span class="main">)</span> <span class="main">∈</span> gap_rel <span class="main">→</span> <span class="main">⟨</span>gap_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> move_left1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv gap_α_def gap_invar_def move_left1_def 
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="comment1">(* sledgehammer! *)</span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Cons_nth_drop_Suc Suc_pred append.assoc append_Cons append_Nil 
      diff_Suc_less drop_update_cancel hd_drop_conv_nth length_list_update 
      less_le_trans nth_list_update_eq take_hd_drop<span class="main">)</span>  

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Right›</span></span>        
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">move_right1</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>
    <span class="keyword1">if</span> <span class="bound">r</span><span class="main">&lt;</span>length <span class="bound">buf</span> <span class="keyword1">then</span> <span class="keyword1">doN</span> <span class="main">{</span>
      ASSERT <span class="main">(</span><span class="bound">l</span><span class="main">&lt;</span>length <span class="bound">buf</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="main">(</span><span class="bound">l</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="bound">r</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="bound">buf</span><span class="main">[</span><span class="bound">l</span><span class="main">:=</span><span class="bound">buf</span><span class="main">!</span><span class="bound">r</span><span class="main">]</span><span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
    
  <span class="keyword1" id="Challenge1_short-move_right1_correct"><span class="command">lemma</span></span> move_right1_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>move_right1<span class="main">,</span>RETURN <span class="keyword1">o</span> move_right<span class="main">)</span> <span class="main">∈</span> gap_rel <span class="main">→</span> <span class="main">⟨</span>gap_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> move_right1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command">unfolding</span></span> gap_α_def gap_invar_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_nth_drop_Suc take_update_last<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insert and Grow›</span></span>
     
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">can_insert</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="bound">l</span><span class="main">&lt;</span><span class="bound">r</span>"</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">grow1</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> op_array_replicate <span class="main">(</span>length <span class="bound">buf</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span> default<span class="main">;</span>
    <span class="bound">b</span> <span class="main">←</span> mop_list_blit <span class="bound">buf</span> <span class="main">0</span> <span class="bound">b</span> <span class="main">0</span> <span class="bound">l</span><span class="main">;</span>
    <span class="bound">b</span> <span class="main">←</span> mop_list_blit <span class="bound">buf</span> <span class="bound">r</span> <span class="bound">b</span> <span class="main">(</span><span class="bound">r</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span> <span class="main">(</span>length <span class="bound">buf</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span><span class="bound">b</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
  <span class="comment1">― ‹Note: Most operations have also a variant prefixed with <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>mop›</span></span>.
    These are defined in the refinement monad and already contain the assertion 
    of their precondition. The backside is that they cannot be easily used in as part
    of expressions, e.g., in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">buf</span><span class="main">[</span><span class="free">l</span><span class="main">:=</span><span class="free">buf</span><span class="main">!</span><span class="free">r</span><span class="main">]</span>"</span><span class="antiquote">}</span></span>, we would have to explicitly bind
    each intermediate value: <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="keyword1">doN</span> <span class="main">{</span> <span class="bound">v</span> <span class="main">←</span> mop_list_get <span class="free">buf</span> <span class="free">r</span><span class="main">;</span> mop_list_set <span class="free">buf</span> <span class="free">l</span> <span class="bound">v</span> <span class="main">}</span>"</span><span class="antiquote">}</span></span>.
  ›</span>
  
  <span class="keyword1" id="Challenge1_short-grow1_correct"><span class="command">lemma</span></span> grow1_correct<span class="main">[</span><span class="operator">THEN</span> SPEC_trans<span class="main">,</span> <span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
    <span class="comment1">― ‹Declares this as a rule to be used by the VCG›</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gap_invar <span class="free">gb</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"grow1 <span class="free">K</span> <span class="free">gb</span> <span class="main">≤</span> <span class="main">(</span>SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">gb'</span><span class="main">.</span> 
        gap_invar <span class="bound">gb'</span> 
      <span class="main">∧</span> gap_α <span class="bound">gb'</span> <span class="main">=</span> gap_α <span class="free">gb</span> 
      <span class="main">∧</span> <span class="main">(</span><span class="free">K</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">⟶</span> can_insert <span class="bound">gb'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grow1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>    
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> gap_α_def gap_invar_def can_insert_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> op_list_blit_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span> <span class="main">←</span> 
      <span class="keyword1">if</span> <span class="main">(</span><span class="bound">l</span><span class="main">=</span><span class="bound">r</span><span class="main">)</span> <span class="keyword1">then</span> grow1 <span class="main">(</span>length <span class="bound">buf</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span><span class="bound">l</span><span class="main">&lt;</span>length <span class="bound">buf</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">l</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">[</span><span class="bound">l</span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>
  <span class="main">}</span>"</span></span> 
  
  <span class="keyword1" id="Challenge1_short-insert1_correct"><span class="command">lemma</span></span> insert1_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>insert1<span class="main">,</span>RETURN <span class="keyword1">oo</span> insert<span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> gap_rel <span class="main">→</span> <span class="main">⟨</span>gap_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> insert1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span> <span class="comment1">― ‹VCG knows the rule for grow1 already›</span>
    <span class="keyword1"><span class="command">unfolding</span></span> insert_def gap_α_def gap_invar_def can_insert_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv take_update_last <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Delete›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">delete1</span> 
    <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span><span class="main">&gt;</span><span class="main">0</span> <span class="keyword1">then</span> RETURN <span class="main">(</span><span class="bound">l</span><span class="main">-</span><span class="main">1</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">,</span><span class="bound">buf</span><span class="main">)</span>"</span></span> 
  <span class="keyword1" id="Challenge1_short-delete1_correct"><span class="command">lemma</span></span> delete1_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>delete1<span class="main">,</span>RETURN <span class="keyword1">o</span> delete<span class="main">)</span> <span class="main">∈</span> gap_rel <span class="main">→</span> <span class="main">⟨</span>gap_rel<span class="main">⟩</span>nres_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> delete1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command">unfolding</span></span> gap_α_def gap_invar_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv butlast_take <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Imperative Arrays›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following indicates how we will further refine the gap-buffer:
    The list will become an array, the indices and the content will not be 
    refined (expressed by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> nat_assn<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> id_assn<span class="antiquote"><span class="antiquote">}</span></span></span></span>).
  ›</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gap_impl_assn</span> <span class="main">≡</span> nat_assn <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> nat_assn <span class="keyword1">×<span class="hidden">⇩</span><sub>a</sub></span> array_assn id_assn"</span></span>  
  
  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">move_left_impl</span> 
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">move_left1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"gap_impl_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span><span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> move_left1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">move_right_impl</span> 
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">move_right1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"gap_impl_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span><span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> move_right1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
  
  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">insert_impl</span> 
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"uncurry insert1"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"id_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span><span class="keyword1">*<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span><span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> insert1_def grow1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span> 
    <span class="comment1">― ‹We inline <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> grow1<span class="antiquote">}</span></span> here›</span>
    
  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">delete_impl</span> 
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">delete1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"gap_impl_assn<span class="keyword1"><span class="hidden">⇧</span><sup>d</sup></span><span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span>gap_impl_assn"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> delete1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>
  
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we combine the two refinement steps, to get overall correctness theorems›</span></span>  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gap_assn</span> <span class="main">≡</span> hr_comp gap_impl_assn gap_rel"</span></span> 
    <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> hr_comp<span class="antiquote">}</span></span> is composition of refinement relations›</span>
  <span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> gap_assn_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">fcomp_norm_unfold</span><span class="main">]</span> <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">lemmas</span></span> move_left_impl_correct <span class="main">=</span> move_left_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> move_left1_correct<span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> move_right_impl_correct <span class="main">=</span> move_right_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> move_right1_correct<span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> insert_impl_correct <span class="main">=</span> insert_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> insert1_correct<span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> delete_impl_correct <span class="main">=</span> delete_impl.refine<span class="main">[</span><span class="operator">FCOMP</span> delete1_correct<span class="main">]</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proves:
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] move_left_impl_correct<span class="antiquote"><span class="antiquote">}</span></span></span></span>
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] move_right_impl_correct<span class="antiquote"><span class="antiquote">}</span></span></span></span>
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] insert_impl_correct<span class="antiquote"><span class="antiquote">}</span></span></span></span>
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] delete_impl_correct<span class="antiquote"><span class="antiquote">}</span></span></span></span>
    ›</span></span>
       
  
  <span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Executable Code›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Isabelle/HOL can generate code in various target languages.›</span></span>

  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">move_left_impl</span></span> <span class="quoted"><span class="quoted">move_right_impl</span></span> <span class="quoted"><span class="quoted">insert_impl</span></span> <span class="quoted"><span class="quoted">delete_impl</span></span>  
    <span class="keyword2"><span class="keyword">in</span></span> SML_imp <span class="keyword2"><span class="keyword">module_name</span></span> Gap_Buffer
    <span class="keyword2"><span class="keyword">in</span></span> OCaml_imp <span class="keyword2"><span class="keyword">module_name</span></span> Gap_Buffer
    <span class="keyword2"><span class="keyword">in</span></span> Haskell <span class="keyword2"><span class="keyword">module_name</span></span> Gap_Buffer
    <span class="keyword2"><span class="keyword">in</span></span> Scala <span class="keyword2"><span class="keyword">module_name</span></span> Gap_Buffer
    
        
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Challenge2">
<div class="head">
<h1>Theory Challenge2</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Colored Tiles›</span></span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Challenge›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹{\upshape
This problem is based on Project Euler problem \#114.

Alice and Bob are decorating their kitchen, and they want to add
a single row of fifty tiles on the edge of the kitchen counter.
Tiles can be either red or black, and for aesthetic reasons,
Alice and Bob insist that red tiles come by blocks of
at least three consecutive tiles.
Before starting, they wish to know how many ways
there are of doing this.
They come up with the following algorithm:
\begin{lstlisting}[language=C,morekeywords={procedure,function,end,to,in,var,then,not,mod}]
var count[51]   // count[i] is the number of valid rows of size i
count[0] := 1   // []
count[1] := 1   // [B] - cannot have a single red tile
count[2] := 1   // [BB] - cannot have one or two red tiles
count[3] := 2   // [BBB] or [RRR]
for n = 4 to 50 do
    count[n] := count[n-1]  // either the row starts with a black tile
    for k = 3 to n-1 do     // or it starts with a block of k red tiles
        count[n] := count[n] + count[n-k-1]  // followed by a black one
    end-for
    count[n] := count[n]+1  // or the entire row is red
end-for
\end{lstlisting}

\paragraph{Verification tasks.}
You should verify that at the end, \texttt{count[50]} will contain the right number.

\bigskip
\noindent\emph{Hint:}
Since the algorithm works by enumerating the valid colorings, we expect you to give
a nice specification of a valid coloring and to prove the following properties:
\begin{enumerate}
\item Each coloring counted by the algorithm is valid.
\item No coloring is counted twice.
\item No valid coloring is missed.
\end{enumerate}
}
\clearpage
›</span></span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Solution›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Challenge2
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="VTcomp.html">lib/VTcomp</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The algorithm describes a dynamic programming scheme. 
    
    Instead of proving the 3 properties stated in the challenge separately,
    we approach the problem by
    
    <span class="antiquoted"><span class="antiquoted">▸</span></span> Giving a natural specification of a valid tiling as a grammar
    <span class="antiquoted"><span class="antiquoted">▸</span></span> Deriving a recursion equation for the number of valid tilings
    <span class="antiquoted"><span class="antiquoted">▸</span></span> Verifying that the program returns the correct number 
      (which obviously implies all three properties stated in the challenge)
  ›</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Problem Specification›</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Colors›</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> color <span class="main">=</span> R <span class="main">|</span> B

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Direct Natural Definition of a Valid Line›</span></span>

  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">valid</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">valid</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">valid</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">valid</span> <span class="main">(</span>B <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">valid</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">⟹</span> <span class="free">valid</span> <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> R <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lcount</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> card <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derivation of Recursion Equations›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This alternative variant helps us to prove the split lemma below.›</span></span>
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">valid'</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">valid'</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">⟹</span> <span class="free">valid'</span> <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> R<span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">valid'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">valid'</span> <span class="main">(</span>B <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">valid'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">⟹</span> <span class="free">valid'</span> <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> R <span class="main">@</span> B <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Challenge2-valid_valid'"><span class="command">lemma</span></span> valid_valid'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"valid <span class="free">l</span> <span class="main">⟹</span> valid' <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid.induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid'.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> valid'.cases
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> replicate_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
       <span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> valid_red <span class="main">=</span> valid.intros<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> valid.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

  <span class="keyword1" id="Challenge2-valid'_valid"><span class="command">lemma</span></span> valid'_valid<span class="main">:</span>
    <span class="quoted"><span class="quoted">"valid' <span class="free">l</span> <span class="main">⟹</span> valid <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid'.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid.intros valid_red<span class="main">)</span>

  <span class="keyword1" id="Challenge2-valid_eq_valid'"><span class="command">lemma</span></span> valid_eq_valid'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"valid' <span class="free">l</span> <span class="main">=</span> valid <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_valid' valid'_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>


  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additional Facts on Replicate›</span></span>

  <span class="keyword1" id="Challenge2-replicate_iff"><span class="command">lemma</span></span> replicate_iff<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="free">l</span> <span class="main">=</span> replicate <span class="bound">n</span> R<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> in_set_conv_nth replicate_eqI<span class="main">)</span>

  <span class="keyword1" id="Challenge2-replicate_iff2"><span class="command">lemma</span></span> replicate_iff2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">l'</span><span class="main">.</span> <span class="free">l</span> <span class="main">=</span> replicate <span class="free">n</span> R <span class="main">@</span> <span class="bound">l'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq nth_append <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">l</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="Challenge2-replicate_Cons_eq"><span class="command">lemma</span></span> replicate_Cons_eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"replicate <span class="free">n</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">n'</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Suc <span class="bound">n'</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> replicate <span class="bound">n'</span> <span class="free">x</span> <span class="main">=</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>


  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Main Case Analysis on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>@term valid›</span></span></span></span>›</span></span>

  <span class="keyword1" id="Challenge2-valid_split"><span class="command">lemma</span></span> valid_split<span class="main">:</span>
    <span class="quoted"><span class="quoted">"valid <span class="free">l</span> <span class="main">⟷</span>
    <span class="free">l</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span>
    <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> B <span class="main">∧</span> valid <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    length <span class="free">l</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> B <span class="main">∧</span> valid <span class="main">(</span>drop <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> valid_eq_valid'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> valid'.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid'.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> replicate_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE1<span class="main">)</span>
         <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid'.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv replicate_iff2 nth_append<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Base cases›</span></span>

  <span class="keyword1" id="Challenge2-lc0_aux"><span class="command">lemma</span></span> lc0_aux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid.intros<span class="main">)</span>

  <span class="keyword1" id="Challenge2-lc0"><span class="command">lemma</span></span> lc0<span class="main">:</span> <span class="quoted"><span class="quoted">"lcount <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lc0_aux lcount_def<span class="main">)</span>

  <span class="keyword1" id="Challenge2-lc1aux"><span class="command">lemma</span></span> lc1aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span><span class="main">=</span><span class="main">1</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span>B<span class="main">]</span><span class="main">}</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> valid.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> replicate_Cons_eq<span class="main">)</span>

  <span class="keyword1" id="Challenge2-lc2aux"><span class="command">lemma</span></span> lc2aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span><span class="main">=</span><span class="numeral">2</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span>B<span class="main">,</span>B<span class="main">]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> valid.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> replicate_Cons_eq<span class="main">)</span>

  <span class="keyword1" id="Challenge2-valid_3R"><span class="command">lemma</span></span> valid_3R<span class="main">:</span> <span class="quoted"><span class="quoted">‹valid <span class="main">[</span>R<span class="main">,</span> R<span class="main">,</span> R<span class="main">]</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid.intros<span class="main">(</span>3<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span>›</span></span> <span class="quoted"><span class="numeral">3</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc valid.intros<span class="main">)</span>

  <span class="keyword1" id="Challenge2-lc3_aux"><span class="command">lemma</span></span> lc3_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span><span class="main">=</span><span class="numeral">3</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span>B<span class="main">,</span>B<span class="main">,</span>B<span class="main">]</span><span class="main">,</span> <span class="main">[</span>R<span class="main">,</span>R<span class="main">,</span>R<span class="main">]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid.intros valid_3R <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> valid.cases
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> replicate_Cons_eq<span class="main">)</span>


  <span class="keyword1" id="Challenge2-lcounts_init"><span class="command">lemma</span></span> lcounts_init<span class="main">:</span> <span class="quoted"><span class="quoted">"lcount <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"lcount <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"lcount <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"lcount <span class="numeral">3</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lc0 lc1aux lc2aux lc3_aux <span class="keyword1"><span class="command">unfolding</span></span> lcount_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>


  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The Recursion Case›</span></span>

  <span class="keyword1" id="Challenge2-finite_valid_length"><span class="command">lemma</span></span> finite_valid_length<span class="main">:</span>
    <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> lists <span class="main">{</span>R<span class="main">,</span> B<span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> color.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lists_of_len_fin1<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Challenge2-valid_line_just_B"><span class="command">lemma</span></span> valid_line_just_B<span class="main">:</span>
    <span class="quoted"><span class="quoted">"valid <span class="main">(</span>replicate <span class="free">n</span> B<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid.intros<span class="main">)</span>

  <span class="keyword1" id="Challenge2-valid_line_aux"><span class="command">lemma</span></span> valid_line_aux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> valid_line_just_B<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1" id="Challenge2-replicate_unequal_aux"><span class="command">lemma</span></span> replicate_unequal_aux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"replicate <span class="free">x</span> R <span class="main">@</span> B <span class="main">#</span> <span class="free">l</span> <span class="main">≠</span> replicate <span class="free">y</span> R <span class="main">@</span> B <span class="main">#</span> <span class="free">l'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≠</span> <span class="var">?r</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">l</span> <span class="free">l'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">!</span> <span class="free">x</span> <span class="main">=</span> B"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">!</span> <span class="free">x</span> <span class="main">=</span> R"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Challenge2-valid_prepend_B_iff"><span class="command">lemma</span></span> valid_prepend_B_iff<span class="main">:</span>
    <span class="quoted"><span class="quoted">"valid <span class="main">(</span>B <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> valid <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> valid.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons_replicate_eq Cons_eq_append_conv<span class="main">)</span>

  <span class="keyword1" id="Challenge2-lcrec"><span class="command">lemma</span></span> lcrec<span class="main">:</span> <span class="quoted"><span class="quoted">"lcount <span class="free">n</span> <span class="main">=</span> lcount <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="numeral">3</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> lcount <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span><span class="main">&gt;</span><span class="numeral">3</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span>
          <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> valid <span class="main">(</span>tl <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">!</span><span class="main">0</span><span class="main">=</span>B<span class="main">}</span>
          <span class="main">∪</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">l</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> B <span class="main">∧</span> valid <span class="main">(</span>drop <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
          <span class="main">∪</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="bound">l</span><span class="main">!</span><span class="bound">i</span><span class="main">=</span>R<span class="main">)</span><span class="main">}</span>
          "</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span> <span class="main">∪</span> <span class="var">?D</span> <span class="main">∪</span> <span class="var">?C</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> valid_split<span class="main">)</span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(#)</span> B<span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> <span class="var">?B1</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_prepend_B_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?B1</span> <span class="main">=</span> lcount <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lcount_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">=</span> <span class="main">{</span>replicate <span class="free">n</span> R<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span>replicate <span class="free">n</span> R<span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D1</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">3</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> replicate <span class="bound">i</span> R <span class="main">@</span> B <span class="main">#</span> <span class="bound">l</span><span class="main">)</span><span class="main">`</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">3</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">l</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> B <span class="main">∧</span> valid <span class="main">(</span>drop <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">.</span> <span class="bound">l</span><span class="main">!</span><span class="bound">k</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> B <span class="main">∧</span> valid <span class="main">(</span>drop <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>
              <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> replicate <span class="skolem">i</span> R <span class="main">@</span> B <span class="main">#</span> <span class="bound">l</span><span class="main">)</span><span class="main">`</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">l</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> that
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_Cons nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> add_diff_inverse_nat <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> D_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?D</span> <span class="main">=</span> <span class="var">?D1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?D</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> replicate <span class="skolem">x</span> R <span class="main">@</span> B <span class="main">#</span> <span class="bound">l</span><span class="main">)</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">x</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> replicate <span class="skolem">x</span> R <span class="main">@</span> B <span class="main">#</span> <span class="bound">l</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">x</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span> <span class="main">∩</span>
         <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> replicate <span class="skolem">y</span> R <span class="main">@</span> B <span class="main">#</span> <span class="bound">l</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> length <span class="bound">l</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">y</span> <span class="main">∧</span> valid <span class="bound">l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> that replicate_unequal_aux<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?D1</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="numeral">3</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> lcount <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> card_Union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def disjnt_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> linorder_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> *<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Int_commute<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> *<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> inj_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> valid_line_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">x</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> linorder_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcount_def card_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_valid_length<span class="main"><span class="main">]</span></span><span class="main">)</span>
  
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lcount_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?A</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?B</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?C</span> <span class="main">=</span> <span class="main">_</span>›</span></span> D_eq
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> card_Un_disjoint<span class="main">)</span>
        <span class="comment1">(* Finiteness *)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_valid_length<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="comment1">(* Disjointness *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons_replicate_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted">B</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted">R</span><span class="main">]</span> replicate_unequal_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> card_Un_disjoint<span class="main">)</span>
        <span class="comment1">(* Finiteness *)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_valid_length<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="comment1">(* Disjointness &amp; final rewriting *)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> 1 2 3
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons_replicate_eq Cons_eq_append_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verification of Program›</span></span>  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Inner Loop: Summation›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sum_prog</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> 
    nfoldli <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>
      ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span> 
      RETURN <span class="main">(</span><span class="bound">s</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">0</span>"</span></span>
   
  <span class="keyword1" id="Challenge2-sum_spec"><span class="command">lemma</span></span> sum_spec<span class="main">[</span><span class="operator">THEN</span> SPEC_trans<span class="main">,</span> <span class="operator">refine_vcg</span><span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≤</span><span class="free">u</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">l</span><span class="main">≤</span><span class="bound">i</span> <span class="main">⟹</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">u</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="bound">i</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_prog <span class="free">Φ</span> <span class="free">l</span> <span class="free">u</span> <span class="free">f</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">=</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_prog_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> nfoldli_upt_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">l</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">refine_vcg</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>    

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Main Program›</span></span>    
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">icount</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="keyword1">doN</span> <span class="main">{</span>
    ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">&gt;</span><span class="numeral">2</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> op_array_replicate <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">c</span><span class="main">[</span><span class="main">0</span><span class="main">:=</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">:=</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">:=</span><span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">:=</span><span class="numeral">2</span><span class="main">]</span><span class="main">;</span>
    
    ASSERT <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="numeral">4</span><span class="main">.</span> <span class="bound">c</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> lcount <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
    
    <span class="bound">c</span><span class="main">←</span>nfoldli <span class="main">[</span><span class="numeral">4</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">c</span><span class="main">.</span> <span class="keyword1">doN</span> <span class="main">{</span>
      <span class="comment1">⌦‹‹let sum =    (∑i=3..&lt;n. c!(n-i-1));››</span>
      <span class="bound">sum</span> <span class="main">←</span> sum_prog <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">n</span><span class="main">-</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span> <span class="main">&lt;</span> length <span class="bound">c</span><span class="main">)</span> <span class="numeral">3</span> <span class="bound">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">c</span><span class="main">!</span><span class="main">(</span><span class="bound">n</span><span class="main">-</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      ASSERT <span class="main">(</span><span class="bound">n</span><span class="main">-</span><span class="main">1</span><span class="main">&lt;</span>length <span class="bound">c</span> <span class="main">∧</span> <span class="bound">n</span><span class="main">&lt;</span>length <span class="bound">c</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="main">(</span><span class="bound">c</span><span class="main">[</span><span class="bound">n</span> <span class="main">:=</span> <span class="bound">c</span><span class="main">!</span><span class="main">(</span><span class="bound">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">sum</span><span class="main">]</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="bound">c</span><span class="main">;</span>
    
    ASSERT <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="bound">c</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> lcount <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
    
    ASSERT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">&lt;</span> length <span class="bound">c</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">c</span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">}</span>"</span></span>  
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract Correctness Statement›</span></span>    
  <span class="keyword1"><span class="command">theorem</span></span> icount_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">&gt;</span><span class="numeral">2</span> <span class="main">⟹</span> icount <span class="free">M</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">=</span>lcount <span class="free">M</span><span class="main">)</span>"</span></span>    
    <span class="keyword1"><span class="command">unfolding</span></span> icount_def
    <span class="keyword1"><span class="command">thm</span></span> nfoldli_upt_rule
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> nfoldli_upt_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
      I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">c</span><span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">M</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="main">(</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="bound">c</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> lcount <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">refine_vcg</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> lcounts_init
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i c j
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">=</span><span class="skolem">j</span>"</span></span><span class="main">)</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lcrec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>            


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement to Imperative Code›</span></span>  
  <span class="keyword1"><span class="command">sepref_definition</span></span> <span class="entity">icount_impl</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"icount"</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat_assn<span class="keyword1"><span class="hidden">⇧</span><sup>k</sup></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>a</sub></span> nat_assn"</span></span>  
    <span class="keyword1"><span class="command">unfolding</span></span> icount_def sum_prog_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sepref</span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Main Correctness Statement›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As the main theorem, we prove the following Hoare triple, stating:
  starting from the empty heap, our program will compute the correct result (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"lcount <span class="free"><span class="free">M</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).
  ›</span></span>
  <span class="keyword1"><span class="command">theorem</span></span> icount_impl_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">&gt;</span><span class="numeral">2</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="keyword1">emp</span><span class="main">&gt;</span> icount_impl <span class="free">M</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">↑</span><span class="main">(</span><span class="bound">r</span> <span class="main">=</span> lcount <span class="free">M</span><span class="main">)</span><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> icount_impl.refine<span class="main">[</span><span class="operator">to_hnr</span><span class="main">,</span> <span class="operator">THEN</span> hn_refineD<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> A<span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> A<span class="main">[</span><span class="operator">unfolded</span> hn_ctxt_def pure_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span> <span class="main">=</span> A

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">&gt;</span><span class="numeral">2</span>"</span></span>
        
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> icount_correct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">M</span><span class="main">&gt;</span><span class="numeral">2</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_le_iff<span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>  

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Code Export›</span></span>    
  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">icount_impl</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML_imp <span class="keyword2"><span class="keyword">module_name</span></span> Tiling    
  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">icount_impl</span></span> <span class="keyword2"><span class="keyword">in</span></span> OCaml_imp <span class="keyword2"><span class="keyword">module_name</span></span> Tiling   
  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">icount_impl</span></span> <span class="keyword2"><span class="keyword">in</span></span> Haskell <span class="keyword2"><span class="keyword">module_name</span></span> Tiling   
  <span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">icount_impl</span></span> <span class="keyword2"><span class="keyword">in</span></span> Scala_imp <span class="keyword2"><span class="keyword">module_name</span></span> Tiling   


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Alternative Problem Specification›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Alternative definition of a valid line that we used in the competition›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"color list"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">valid_point</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="numeral">2</span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">;</span> <span class="free">l</span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">=</span>R<span class="main">;</span> <span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> R<span class="main">;</span> <span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> R <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">valid_point</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">1</span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">;</span> <span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">=</span>R<span class="main">;</span> <span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> R<span class="main">;</span> <span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> R <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">valid_point</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="numeral">2</span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">;</span> <span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span><span class="main">=</span>R<span class="main">;</span> <span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> R<span class="main">;</span> <span class="free">l</span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> R <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">valid_point</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">;</span> <span class="free">l</span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">=</span>B<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">valid_point</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>


  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_line</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">l</span><span class="main">.</span> valid_point <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Challenge2-valid_lineI"><span class="command">lemma</span></span> valid_lineI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> valid_point <span class="free">l</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_line <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> valid_line_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Challenge2-valid_B_first"><span class="command">lemma</span></span> valid_B_first<span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_point <span class="free">xs</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> valid_point <span class="main">(</span>B <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_point.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> valid_point.cases<span class="main">)</span>

<span class="keyword1" id="Challenge2-valid_line_prepend_B"><span class="command">lemma</span></span> valid_line_prepend_B<span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_line <span class="main">(</span>B <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"valid_line <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> valid_lineI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_B_first<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> valid_point.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_line_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Challenge2-valid_drop_B"><span class="command">lemma</span></span> valid_drop_B<span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_point <span class="free">xs</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"valid_point <span class="main">(</span>B <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">cases</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_point.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_point.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> numeral_nat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_point.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_point.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Challenge2-valid_line_drop_B"><span class="command">lemma</span></span> valid_line_drop_B<span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_line <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"valid_line <span class="main">(</span>B <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> valid_line_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> valid_drop_B<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Challenge2-valid_line_prepend_B_iff"><span class="command">lemma</span></span> valid_line_prepend_B_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_line <span class="main">(</span>B <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> valid_line <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_line_prepend_B valid_line_drop_B <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Challenge2-cases_valid_line"><span class="command">lemma</span></span> cases_valid_line<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span>
    <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> B <span class="main">∧</span> valid_line <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    length <span class="free">l</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> B <span class="main">∧</span> valid_line <span class="main">(</span>drop <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∨</span> <span class="var">?b</span> <span class="main">∨</span> <span class="var">?c</span> <span class="main">∨</span> <span class="var">?d</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_line <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>empty<span class="main">)</span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">|</span> <span class="main">(</span>B<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?a</span> <span class="main">∧</span> <span class="var">?b</span>"</span></span> <span class="main">|</span> <span class="main">(</span>all_red<span class="main">)</span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">|</span> <span class="main">(</span>R_B<span class="main">)</span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_line_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> B
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_line_prepend_B_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> all_red
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valid_lineI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_point <span class="free">l</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_point.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> R_B
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span>length <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> B"</span></span> <span class="quoted"><span class="quoted">"valid_line <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valid_lineI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≥</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="numeral">3</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_point <span class="free">l</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 5
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹valid_line <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_point <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> valid_line_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_point.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> j <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">:</span> valid_point.intros›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Challenge2-valid_line_cases"><span class="command">lemma</span></span> valid_line_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span>
  <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> B <span class="main">∧</span> valid_line <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
  length <span class="free">l</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> B <span class="main">∧</span> valid_line <span class="main">(</span>drop <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"valid_line <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_line_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> B"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> B <span class="main">#</span> tl <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹valid_line <span class="free">l</span>›</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_line_prepend_B_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹valid_line <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_point <span class="free">l</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> valid_line_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> red_start<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> R"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="main">1</span> <span class="main">=</span> R"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">!</span><span class="numeral">2</span> <span class="main">=</span> R"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> valid_point.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">l</span> <span class="main">≥</span> <span class="numeral">3</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> B<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> B_ge_3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> B"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> red_start <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> B›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> B"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> B_ge_3 color.exhaust<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="var">?j</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> B"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> B_ge_3<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> B›</span></span> red_start <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">∈</span> <span class="var">?S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Min_le<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> color.exhaust<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?j</span> <span class="main">∈</span> <span class="var">?S</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> B"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_line <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valid_lineI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> j <span class="quoted"><span class="quoted">‹valid_line <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_point <span class="free">l</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> valid_line_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_point <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> 2
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_point.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> prems<span class="main">:</span> 3
          <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> j prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_point.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_point.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Challenge2-valid_line_split"><span class="command">lemma</span></span> valid_line_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_line <span class="free">l</span> <span class="main">⟷</span>
  <span class="free">l</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span>
  <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> B <span class="main">∧</span> valid_line <span class="main">(</span>tl <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
  length <span class="free">l</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free">l</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">.</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> R<span class="main">)</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> B <span class="main">∧</span> valid_line <span class="main">(</span>drop <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_line_cases cases_valid_line <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Connection to the easier definition given above›</span></span>
<span class="keyword1" id="Challenge2-valid_valid_line"><span class="command">lemma</span></span> valid_valid_line<span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid <span class="free">l</span> <span class="main">⟷</span> valid_line <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> valid_line_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> valid_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Challenge3">
<div class="head">
<h1>Theory Challenge3</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Array-Based Queuing Lock›</span></span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Challenge›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹{\upshape
Array-Based Queuing Lock (ABQL)
is a variation of the Ticket Lock algorithm with a bounded number
of concurrent threads and improved scalability due to better cache
behaviour.
%(\url{https://en.wikipedia.org/wiki/Array_Based_Queuing_Locks})

We assume that there are \texttt{N} threads and we
allocate a shared Boolean array \texttt{pass[]} of length \texttt{N}.
We also allocate a shared integer value \texttt{next}.
In practice, \texttt{next} is an unsigned bounded
integer that wraps to 0 on overflow, and
we assume that the maximal value of \texttt{next} is
of the form $k\mathtt{N} - 1$.
Finally, we assume at our disposal
an atomic \texttt{fetch\_and\_add} instruction,
such that \texttt{fetch\_and\_add(next,1)} increments the value
of \texttt{next} by 1 and returns the original value of \texttt{next}.

The elements of \texttt{pass[]} are spinlocks, assigned
individually to each thread in the waiting queue.
Initially, each element of \texttt{pass[]} is set to
\texttt{false}, except \texttt{pass[0]} which is set to
\texttt{true}, allowing the first coming thread to acquire
the lock.
Variable \texttt{next} contains the number of the first available
place in the waiting queue and is initialized to 0.

Here is an implementation of the locking algorithm in pseudocode:
\begin{lstlisting}[language=C,morekeywords={procedure,function,end,to,in,var,then,not,mod}]
procedure abql_init()
    for i = 1 to N - 1 do
        pass[i] := false
    end-for
    pass[0] := true
    next := 0
end-procedure

function abql_acquire()
    var my_ticket := fetch_and_add(next,1) mod N
    while not pass[my_ticket] do
    end-while
    return my_ticket
end-function

procedure abql_release(my_ticket)
    pass[my_ticket] := false
    pass[(my_ticket + 1) mod N] := true
end-procedure
\end{lstlisting}
Each thread that acquires the lock must eventually release it
by calling \texttt{abql\_release(my\_ticket)}, where \texttt{my\_ticket}
is the return value of the earlier call of \texttt{abql\_acquire()}.
We assume that no thread tries to re-acquire the lock while already
holding it, neither it attempts to release the lock which it does not possess.

Notice that the first
assignment in \texttt{abql\_release()} can be moved at the end
of \texttt{abql\_acquire()}.

\bigskip
\noindent\textbf{Verification task~1.}~Verify
the safety of ABQL
under the given assumptions. Specifically, you should prove that no two
threads can hold the lock at any given time.

\bigskip
\noindent\textbf{Verification task~2.}~Verify
the fairness, namely that the threads acquire the lock
in order of request.

\bigskip
\noindent\textbf{Verification task~3.}~Verify
the liveness under a fair scheduler, namely that
each thread requesting the lock will eventually acquire it.

\bigskip
You have liberty of adapting the implementation and specification
of the concurrent setting as best suited for your verification tool.
In particular, solutions with a fixed value of \texttt{N} are acceptable.
We expect, however, that the general idea of the algorithm and
the non-deterministic behaviour of the scheduler shall be preserved.
}
\clearpage
›</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Solution›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Challenge3
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="VTcomp.html">lib/VTcomp</a>"</span> <span class="quoted">"<a href="DF_System.html">lib/DF_System</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Isabelle Refinement Framework does not support concurrency.
    However, Isabelle is a general purpose theorem prover, thus we can model
    the problem as a state machine, and prove properties over runs.
    
    For this polished solution, we make use of a small library for
    transition systems and simulations: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="DF_System.html"></a><a href="DF_System.html">VerifyThis2018.DF_System</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
    Note, however, that our definitions are still quite ad-hoc, 
    and there are lots of opportunities to define libraries that make similar 
    proofs simpler and more canonical.
    
    
    We approach the final ABQL with three refinement steps:
      <span class="antiquoted"><span class="antiquoted">▸</span></span> We model a ticket lock with unbounded counters, and prove safety, fairness, and liveness.
      <span class="antiquoted"><span class="antiquoted">▸</span></span> We bound the counters by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mod N›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mod (k*N) respectively›</span></span></span></span>
      <span class="antiquoted"><span class="antiquoted">▸</span></span> We implement the current counter by an array, 
        yielding exactly the algorithm described in the challenge.

    With a simulation argument, we transfer the properties of the abstract 
    system over the refinements.
    
    The final theorems proving safety, fairness, and liveness can be found at 
    the end of this chapter, in Subsection~\ref{sec:main_theorems}.
  ›</span></span>  

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General Definitions›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We fix a positive number <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span> of threads›</span></span>
  <span class="keyword1"><span class="command">consts</span></span> N <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">N</span><span class="main">)</span> N_not0<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"N<span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Challenge3-N_gt0"><span class="command">lemma</span></span> N_gt0<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span>N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">N</span><span class="main">)</span> <span class="operator">auto</span> 

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A thread's state, representing the sequence points in the given algorithm.
    This will not change over the refinements.›</span></span>
  <span class="keyword1"><span class="command">datatype</span></span> thread <span class="main">=</span> 
    INIT 
  <span class="main">|</span> <span class="entity">is_WAIT</span><span class="main">:</span> WAIT <span class="main">(</span><span class="free"><span class="entity">ticket</span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> 
  <span class="main">|</span> <span class="entity">is_HOLD</span><span class="main">:</span> HOLD <span class="main">(</span>ticket<span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> 
  <span class="main">|</span> <span class="entity">is_REL</span><span class="main">:</span> REL <span class="main">(</span>ticket<span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span>
  
  
    
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement 1: Ticket Lock with Unbounded Counters›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹System's state: Current ticket, next ticket, thread states›</span></span>
  <span class="keyword1"><span class="command">type_synonym</span></span> astate <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat <span class="main">×</span> <span class="main">(</span>nat <span class="main">⇒</span> thread<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">cc</span> <span class="main">≡</span> fst"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">nn</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">tts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
  
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The step relation of a single thread›</span></span>  
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">astep_sng</span> <span class="keyword2"><span class="keyword">where</span></span>
    enter_wait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">astep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>INIT<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">,</span>WAIT <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> loop_wait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">≠</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟹</span> <span class="free">astep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>WAIT <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>WAIT <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> exit_wait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">astep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>WAIT <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>HOLD <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> start_release<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">astep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>HOLD <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>REL <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> release<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">astep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>REL <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>INIT<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The step relation of the system›</span></span>
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">alstep</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span><span class="main">&lt;</span>N<span class="main">;</span> astep_sng <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">alstep</span> <span class="free">t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">(</span><span class="free">t</span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
      
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initial state of the system›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≡</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> INIT<span class="main">)</span>"</span></span>
    
  <span class="keyword1"><span class="command">interpretation</span></span> A<span class="main">:</span> system <span class="quoted">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">alstep</span> <span class="keyword1"><span class="command">.</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In our system, each thread can always perform a step›</span></span>
  <span class="keyword1" id="Challenge3-never_blocked"><span class="command">lemma</span></span> never_blocked<span class="main">:</span> <span class="quoted"><span class="quoted">"A.can_step <span class="free">l</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">l</span><span class="main">&lt;</span>N"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="free">s</span> <span class="free">l</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> A.can_step_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alstep.simps astep_sng.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Thus, our system is in particular deadlock free›</span></span>
  <span class="keyword1"><span class="command">interpretation</span></span> A<span class="main">:</span> df_system <span class="quoted">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">alstep</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command">using</span></span> never_blocked<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> A.can_step_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Safety: Mutual Exclusion›</span></span>  
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Predicates to express that a thread uses or holds a ticket›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">has_ticket</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">=</span>WAIT <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">=</span>HOLD <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">=</span>REL <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
  <span class="keyword1" id="Challenge3-has_ticket_simps"><span class="command">lemma</span></span> has_ticket_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>has_ticket INIT <span class="free">k</span>"</span></span>
    <span class="quoted"><span class="quoted">"has_ticket <span class="main">(</span>WAIT <span class="free">k</span><span class="main">)</span> <span class="free">k'</span><span class="main">⟷</span> <span class="free">k'</span><span class="main">=</span><span class="free">k</span>"</span></span>
    <span class="quoted"><span class="quoted">"has_ticket <span class="main">(</span>HOLD <span class="free">k</span><span class="main">)</span> <span class="free">k'</span><span class="main">⟷</span> <span class="free">k'</span><span class="main">=</span><span class="free">k</span>"</span></span>
    <span class="quoted"><span class="quoted">"has_ticket <span class="main">(</span>REL <span class="free">k</span><span class="main">)</span> <span class="free">k'</span><span class="main">⟷</span> <span class="free">k'</span><span class="main">=</span><span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> has_ticket_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">locks_ticket</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">=</span>HOLD <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">=</span>REL <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>  
  <span class="keyword1" id="Challenge3-locks_ticket_simps"><span class="command">lemma</span></span> locks_ticket_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>locks_ticket INIT <span class="free">k</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>locks_ticket <span class="main">(</span>WAIT <span class="free">k</span><span class="main">)</span> <span class="free">k'</span>"</span></span>
    <span class="quoted"><span class="quoted">"locks_ticket <span class="main">(</span>HOLD <span class="free">k</span><span class="main">)</span> <span class="free">k'</span><span class="main">⟷</span> <span class="free">k'</span><span class="main">=</span><span class="free">k</span>"</span></span>
    <span class="quoted"><span class="quoted">"locks_ticket <span class="main">(</span>REL <span class="free">k</span><span class="main">)</span> <span class="free">k'</span><span class="main">⟷</span> <span class="free">k'</span><span class="main">=</span><span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> locks_ticket_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Challenge3-holds_imp_uses"><span class="command">lemma</span></span> holds_imp_uses<span class="main">:</span> <span class="quoted"><span class="quoted">"locks_ticket <span class="free">s</span> <span class="free">k</span> <span class="main">⟹</span> has_ticket <span class="free">s</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> locks_ticket_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show the following invariant.
    Intuitively, it can be read as follows:
      <span class="antiquoted"><span class="antiquoted">▪</span></span> Current lock is less than or equal next lock
      <span class="antiquoted"><span class="antiquoted">▪</span></span> For all threads that use a ticket (i.e., are waiting, holding, or releasing):
        <span class="antiquoted"><span class="antiquoted">▪</span></span> The ticket is in between current and next
        <span class="antiquoted"><span class="antiquoted">▪</span></span> No other thread has the same ticket
        <span class="antiquoted"><span class="antiquoted">▪</span></span> Only the current ticket can be held (or released)
  ›</span></span>    

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">invar1</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">c</span> <span class="main">≤</span> <span class="bound">n</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">t</span><span class="main">&lt;</span>N <span class="main">∧</span> has_ticket <span class="main">(</span><span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">k</span> <span class="main">⟶</span> 
      <span class="bound">c</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">n</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t'</span> <span class="bound">k'</span><span class="main">.</span> <span class="bound">t'</span><span class="main">&lt;</span>N <span class="main">∧</span> has_ticket <span class="main">(</span><span class="bound">ts</span> <span class="bound">t'</span><span class="main">)</span> <span class="bound">k'</span> <span class="main">∧</span> <span class="bound">t</span><span class="main">≠</span><span class="bound">t'</span> <span class="main">⟶</span> <span class="bound">k</span><span class="main">≠</span><span class="bound">k'</span><span class="main">)</span>  
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≠</span><span class="bound">c</span> <span class="main">⟶</span> <span class="main">¬</span>locks_ticket <span class="main">(</span><span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span>
    <span class="main">)</span>
  "</span></span>  
    
  <span class="keyword1" id="Challenge3-is_invar1"><span class="command">lemma</span></span> is_invar1<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_invar invar1"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar1_def as<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alstep.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> astep_sng.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp_all</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar1_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_le_eq holds_imp_uses locks_ticket_def le_neq_implies_less<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹From the above invariant, it's straightforward to show mutual exclusion›</span></span>
  <span class="keyword1"><span class="command">theorem</span></span> mutual_exclusion<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>A.reachable <span class="free">s</span><span class="main">;</span> 
      <span class="free">t</span><span class="main">&lt;</span>N<span class="main">;</span> <span class="free">t'</span><span class="main">&lt;</span>N<span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">t'</span><span class="main">;</span> is_HOLD <span class="main">(</span>tts <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">;</span> is_HOLD <span class="main">(</span>tts <span class="free">s</span> <span class="free">t'</span><span class="main">)</span>
    <span class="main">⟧</span> <span class="main">⟹</span> False"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="free">s</span> <span class="free">t</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="free">s</span> <span class="free">t'</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> A.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> locks_ticket_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> has_ticket_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      
  <span class="keyword1" id="Challenge3-mutual_exclusion'"><span class="command">lemma</span></span> mutual_exclusion'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>A.reachable <span class="free">s</span><span class="main">;</span> 
      <span class="free">t</span><span class="main">&lt;</span>N<span class="main">;</span> <span class="free">t'</span><span class="main">&lt;</span>N<span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">t'</span><span class="main">;</span> 
      locks_ticket <span class="main">(</span>tts <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="free">tk</span><span class="main">;</span> locks_ticket <span class="main">(</span>tts <span class="free">s</span> <span class="free">t'</span><span class="main">)</span> <span class="free">tk'</span>
    <span class="main">⟧</span> <span class="main">⟹</span> False"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="free">s</span> <span class="free">t</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="free">s</span> <span class="free">t'</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="free">s</span> <span class="free">t'</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> A.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp_all</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> locks_ticket_def has_ticket_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Fairness: Ordered Lock Acquisition›</span></span>      
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first show an auxiliary lemma: 
    Consider a segment of a run from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span>. Every thread that waits for
    a ticket in between the current ticket at <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> and the current ticket at <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span>
    will be granted the lock in between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span>.
  ›</span></span>      
  
  <span class="keyword1" id="Challenge3-fair_aux"><span class="command">lemma</span></span> fair_aux<span class="main">:</span>  
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_run <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"cc <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> cc <span class="main">(</span><span class="free">s</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t</span><span class="main">=</span>WAIT <span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">i</span><span class="main">≤</span><span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">&lt;</span><span class="free">j</span> <span class="main">∧</span> tts <span class="main">(</span><span class="free">s</span> <span class="bound">l</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> HOLD <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> run <span class="quoted">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">alstep</span> <span class="quoted"><span class="free">s</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span>
  
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">-</span><span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
      
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span><span class="main">=</span><span class="free">j</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH<span class="main">=</span>Suc.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"alstep <span class="skolem">t'</span> <span class="main">(</span><span class="free">s</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> A.stepE<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">c</span> <span class="skolem">n</span> <span class="skolem">ts</span> <span class="skolem">c'</span> <span class="skolem">n'</span> <span class="skolem">s'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
        
        <span class="keyword1"><span class="command">from</span></span> A.run_invar<span class="main">[</span><span class="operator">OF</span> is_invar1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invar1 <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> I1 <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> invar1_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"1"</span><span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> astep_sng.cases<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> enter_wait
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> IH Suc.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_leD Suc_lessI fst_conv leD thread.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>loop_wait <span class="skolem">k</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
            <span class="keyword1"><span class="command">using</span></span> IH Suc.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_leD Suc_lessI fst_conv leD<span class="main">)</span>
          
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> exit_wait
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">=</span><span class="free">t</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_leD Suc_lessI fst_conv fun_upd_same leD 
                less_or_eq_imp_le snd_conv<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">using</span></span> Suc.prems IH
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_leD Suc_lessI fst_conv leD<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>start_release <span class="skolem">k</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> IH Suc.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_leD Suc_lessI fst_conv leD thread.distinct<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>release <span class="skolem">k</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">=</span><span class="free">t</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> I1 IH Suc.prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc_leD Suc_leI Suc_lessI fst_conv 
              locks_ticket_simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> le_antisym not_less_eq_eq 
              has_ticket_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> has_ticket_simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>  
  
  <span class="keyword1" id="Challenge3-s_case_expand"><span class="command">lemma</span></span> s_case_expand<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">n</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">n</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span> <span class="main">(</span>cc <span class="free">s</span><span class="main">)</span> <span class="main">(</span>nn <span class="free">s</span><span class="main">)</span> <span class="main">(</span>tts <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    A version of the fairness lemma which is very detailed on the 
    actual ticket numbers. We will weaken this later.
  ›</span></span>  
  <span class="keyword1" id="Challenge3-fair_aux2"><span class="command">lemma</span></span> fair_aux2<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RUN<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_run <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ACQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t</span><span class="main">=</span>INIT"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">=</span>WAIT <span class="free">k</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> HOLD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">j</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> HOLD <span class="free">k</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> WAIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t'</span> <span class="main">=</span> WAIT <span class="free">k'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">l</span><span class="main">)</span> <span class="free">t'</span> <span class="main">=</span> HOLD <span class="free">k'</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> run <span class="quoted">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">alstep</span> <span class="quoted"><span class="free">s</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span>
  
    <span class="keyword1"><span class="command">from</span></span> ACQ WAIT <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">≠</span><span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span><span class="main">≠</span><span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ACQ <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"nn <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> nn <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">k</span> 
    <span class="main">∧</span> cc <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cc <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> tts <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">t</span><span class="main">:=</span>WAIT <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> A.stepE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alstep.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> astep_sng.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_list_update <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      
    <span class="keyword1"><span class="command">from</span></span> A.run_invar<span class="main">[</span><span class="operator">OF</span> is_invar1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invar1 <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> I1 <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> invar1_def<span class="main">,</span> <span class="operator">unfolded</span> s_case_expand<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    
    <span class="keyword1"><span class="command">from</span></span> WAIT I1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> ACQ HOLD <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">with</span></span> HOLD <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
    <span class="keyword1"><span class="command">have</span></span> X1<span class="main">:</span> <span class="quoted"><span class="quoted">"cc <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I1 WAIT <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> X2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> cc <span class="main">(</span><span class="free">s</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> A.run_invar<span class="main">[</span><span class="operator">OF</span> is_invar1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main">,</span> <span class="operator">unfolded</span> invar1_def s_case_expand<span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main">&lt;</span>N›</span></span> HOLD<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> locks_ticket_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> has_ticket_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span> fair_aux<span class="main">[</span><span class="operator">OF</span> RUN <span class="quoted"><span class="quoted">‹Suc <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">k'</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≥</span>Suc <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="skolem">l</span><span class="main">)</span> <span class="free">t'</span> <span class="main">=</span> HOLD <span class="free">k'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> WAIT X1 X2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
  <span class="keyword1"><span class="command">qed</span></span>        

  <span class="keyword1" id="Challenge3-find_hold_position"><span class="command">lemma</span></span> find_hold_position<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RUN<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_run <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> WAIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> WAIT <span class="free">tk</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NWAIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">j</span><span class="main">)</span> <span class="free">t</span> <span class="main">≠</span> WAIT <span class="free">tk</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≤</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">l</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> HOLD <span class="free">tk</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> run <span class="quoted">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">alstep</span> <span class="quoted"><span class="free">s</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span>
  
    <span class="keyword1"><span class="command">from</span></span> WAIT<span class="main">(</span>2<span class="main">)</span> NWAIT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">i</span><span class="main">&lt;</span><span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span><span class="main">≤</span><span class="free">j</span> <span class="main">∧</span> tts <span class="main">(</span><span class="free">s</span> <span class="bound">l</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> HOLD <span class="free">tk</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">-</span><span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
      
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span><span class="main">=</span><span class="free">j</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH<span class="main">=</span>Suc.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"alstep <span class="skolem">t'</span> <span class="main">(</span><span class="free">s</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> A.stepE<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span><span class="skolem">t'</span>"</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">erule</span> alstep.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> astep_sng.cases<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">using</span></span> IH Suc.prems Suc.hyps<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD Suc_lessI fun_upd_same snd_conv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD Suc_lessI fun_upd_other snd_conv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_lessD Suc_lessI fun_upd_triv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD Suc_lessI fun_upd_other snd_conv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD Suc_lessI fun_upd_other snd_conv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD Suc_lessI fun_upd_other snd_conv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>    
  
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Finally we can show fairness, which we state as follows:
      Whenever a thread <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> gets a ticket, all other threads <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t'›</span></span></span></span> waiting for the lock
      will be granted the lock before <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span>.
  ›</span></span>  
  <span class="keyword1"><span class="command">theorem</span></span> fair<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RUN<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_run <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ACQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t</span><span class="main">=</span>INIT"</span></span> <span class="quoted"><span class="quoted">"is_WAIT <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
      <span class="comment1">― ‹Thread <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>t›</span></span> calls <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>acquire›</span></span> in step <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>i›</span></span>›</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> HOLD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"is_HOLD <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="free">j</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
      <span class="comment1">― ‹Thread <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>t›</span></span> holds lock in step <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>j›</span></span>›</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> WAIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"is_WAIT <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t'</span><span class="main">)</span>"</span></span> 
      <span class="comment1">― ‹Thread <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>t'›</span></span> waits for lock at step <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>i›</span></span>›</span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"is_HOLD <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="free">l</span><span class="main">)</span> <span class="free">t'</span><span class="main">)</span>"</span></span> 
      <span class="comment1">― ‹Then, <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>t'›</span></span> gets lock earlier›</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> Wk<span class="main">:</span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> WAIT <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ACQ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Wk'<span class="main">:</span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t'</span> <span class="main">=</span> WAIT <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WAIT
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      
    <span class="keyword1"><span class="command">from</span></span> ACQ HOLD <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">with</span></span> HOLD <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="skolem">j'</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> HOLD <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> find_hold_position<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RUN <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main">&lt;</span>N›</span></span> Wk <span class="quoted"><span class="quoted">‹Suc <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> HOLD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fair_aux2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RUN ACQ<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> Wk _ H'<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> WAIT<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> Wk'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> H'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> that<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> H'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>    
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Liveness›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For all tickets in between the current and the next ticket, 
    there is a thread that has this ticket›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">invar2</span> 
    <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">c</span><span class="main">≤</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span><span class="main">&lt;</span><span class="bound">n</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t</span></span><span class="main">&lt;</span>N<span class="main">.</span> has_ticket <span class="main">(</span><span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Challenge3-is_invar2"><span class="command">lemma</span></span> is_invar2<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_invar invar2"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar2_def as<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar2_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alstep.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> astep_sng.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_antisym has_ticket_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> has_ticket_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> has_ticket_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> has_ticket_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> A.invar_reachable<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_invar1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> invar1_def 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leD locks_ticket_simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> 
          not_less_eq_eq has_ticket_simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a thread t is waiting for a lock, the current lock is also used by a thread›</span></span> 
  <span class="keyword1"><span class="command">corollary</span></span> current_lock_used<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"A.reachable <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> WAIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="free">t</span> <span class="main">=</span> WAIT <span class="free">k</span>"</span></span> 
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span><span class="main">&lt;</span>N"</span></span>  <span class="quoted"><span class="quoted">"has_ticket <span class="main">(</span><span class="free">ts</span> <span class="free">t'</span><span class="main">)</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar2 R<span class="main">]</span> 
      <span class="keyword2"><span class="keyword">and</span></span> A.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar1 R<span class="main">]</span> WAIT
    <span class="keyword1"><span class="command">unfolding</span></span> invar1_def invar2_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> le_neq_implies_less not_le order_mono_setup.refl 
      has_ticket_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Used tickets are unique (Corollary from invariant 1)›</span></span>  
  <span class="keyword1" id="Challenge3-has_ticket_unique"><span class="command">lemma</span></span> has_ticket_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>A.reachable <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span><span class="main">;</span> 
      <span class="free">t</span><span class="main">&lt;</span>N<span class="main">;</span> has_ticket <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="free">k</span><span class="main">;</span> <span class="free">t'</span><span class="main">&lt;</span>N<span class="main">;</span> has_ticket <span class="main">(</span><span class="free">ts</span> <span class="free">t'</span><span class="main">)</span> <span class="free">k</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t'</span><span class="main">=</span><span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> A.invar_reachable<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_invar1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar1_def<span class="main">)</span> 
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the thread that holds a specified ticket›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tkt_thread</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ts</span> <span class="bound">k</span><span class="main">.</span> <span class="keyword1">THE</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">&lt;</span>N <span class="main">∧</span> has_ticket <span class="main">(</span><span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1" id="Challenge3-tkt_thread_eq"><span class="command">lemma</span></span> tkt_thread_eq<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"A.reachable <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span>"</span></span>  
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"has_ticket <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tkt_thread <span class="free">ts</span> <span class="free">k</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_ticket_unique<span class="main">[</span><span class="operator">OF</span> R<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tkt_thread_def
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1" id="Challenge3-holds_only_current"><span class="command">lemma</span></span> holds_only_current<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"A.reachable <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span>"</span></span>  
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"locks_ticket <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">=</span><span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar1 R<span class="main">]</span> A <span class="keyword1"><span class="command">unfolding</span></span> invar1_def
    <span class="keyword1"><span class="command">using</span></span> holds_imp_uses <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the inductive argument, we will use this measure, that decreases as a
    single thread progresses through its phases.
  ›</span></span>  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tweight</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> WAIT <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="numeral">3</span><span class="main">::</span>nat <span class="main">|</span> HOLD <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="numeral">2</span> <span class="main">|</span> REL <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> INIT <span class="main">⇒</span> <span class="main">0</span>"</span></span>  

  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show progress: Every thread that waits for the lock
    will eventually hold the lock.›</span></span>
  <span class="keyword1"><span class="command">theorem</span></span> progress<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FRUN<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_fair_run <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"is_WAIT <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="free">i</span><span class="main">.</span> is_HOLD <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="bound">j</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> fair_run <span class="quoted">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">alstep</span> <span class="quoted"><span class="free">s</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fact</span>
  
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> Wk<span class="main">:</span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> WAIT <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We use the following induction scheme:
      <span class="antiquoted"><span class="antiquoted">▪</span></span> Either the current thread increases (if we reach <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>, we are done)
      <span class="antiquoted"><span class="antiquoted">▪</span></span> (lex) the thread using the current ticket makes a step
      <span class="antiquoted"><span class="antiquoted">▪</span></span> (lex) another thread makes a step
    ›</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lrel</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lrel</span> <span class="main">≡</span> 
      inv_image <span class="main">(</span>measure id <span class="keyword1">&lt;*lex*&gt;</span> measure id <span class="keyword1">&lt;*lex*&gt;</span> measure id<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>
        <span class="skolem">k</span><span class="main">-</span>cc <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span>
        tweight <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>tkt_thread <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cc <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        A.dist_step <span class="main">(</span>tkt_thread <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cc <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span>
      <span class="main">)</span><span class="main">)</span>"</span></span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="skolem">lrel</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lrel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>1<span class="main">)</span> Wk   
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span><span class="main">)</span>

      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We name the components of this and the next state›</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> A.run_reachable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"A.reachable <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">ts'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">,</span><span class="skolem">ts'</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> A.run_reachable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> R'<span class="main">:</span> <span class="quoted"><span class="quoted">"A.reachable <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">,</span><span class="skolem">ts'</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            
      <span class="keyword1"><span class="command">from</span></span> less.prems <span class="keyword1"><span class="command">have</span></span> WAIT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="free">t</span> <span class="main">=</span> WAIT <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If thread <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> left waiting state, we are done›</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="free">t</span> <span class="main">≠</span> WAIT <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="free">t</span> <span class="main">=</span> HOLD <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less.prems
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> A.stepE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alstep.cases astep_sng.cases <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="free">t</span> <span class="main">=</span> WAIT <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Otherwise, we obtain the thread <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>tt›</span></span></span></span> that holds the current lock›</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tt</span></span> <span class="keyword2"><span class="keyword">where</span></span> UTT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tt</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"has_ticket <span class="main">(</span><span class="skolem">ts</span> <span class="skolem">tt</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> current_lock_used<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> 
            <span class="keyword2"><span class="keyword">and</span></span> less.prems A.run_reachable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
        <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tkt_thread <span class="skolem">ts</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">tt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tkt_thread_eq<span class="main">[</span><span class="operator">OF</span> R UTT<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">tt</span><span class="main">&lt;</span>N›</span></span>
          
        
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A.can_step <span class="skolem">tt</span> <span class="main">(</span><span class="free">s</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> never_blocked<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> A.rstep_cases<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>other <span class="skolem">t'</span><span class="main">)</span> <span class="comment1">― ‹Another thread than <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>tt›</span></span> makes a step.›</span>
          
          <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The current ticket and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>tt›</span></span></span></span>'s state remain the same›</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">ts'</span> <span class="skolem">tt</span> <span class="main">=</span> <span class="skolem">ts</span> <span class="skolem">tt</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> has_ticket_unique<span class="main">[</span><span class="operator">OF</span> R UTT<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> A.rstep_def
            <span class="keyword1"><span class="command">using</span></span> holds_only_current<span class="main">[</span><span class="operator">OF</span> R<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alstep.cases astep_sng.cases<span class="main">)</span>

          <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Thus, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>tt›</span></span></span></span> is still using the current ticket›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tkt_thread <span class="skolem">ts'</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">tt</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> UTT tkt_thread_eq<span class="main">[</span><span class="operator">OF</span> R'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">tt</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Only the distance to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>tt›</span></span></span></span>'s next step has decreased›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">lrel</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> lrel_def tweight_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> other<span class="main">)</span>
          
          <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And we can apply the induction hypothesis›</span></span>
          <span class="keyword1"><span class="command">with</span></span> less.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main">&lt;</span>N›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Suc_lessD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> THIS<span class="main">:</span> this <span class="comment1">― ‹The thread <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>tt›</span></span> that uses the current ticket makes a step›</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k'</span><span class="main">.</span> <span class="skolem">ts</span> <span class="skolem">tt</span> <span class="main">=</span> REL <span class="bound">k'</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>tt›</span></span> has finished releasing the lock ›</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="skolem">tt</span> <span class="main">=</span> REL <span class="skolem">c</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> UTT <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            
            <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Thus, current increases›</span></span>  
            <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Suc <span class="skolem">c</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> THIS <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">unfolding</span></span> A.rstep_def
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alstep.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> astep_sng.cases<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
            <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹But is still less than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>›</span></span>  
            <span class="keyword1"><span class="command">from</span></span> A.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar1 R<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">&gt;</span><span class="skolem">c</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar1_def<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UTT WAIT <span class="quoted"><span class="quoted">‹<span class="skolem">ts</span> <span class="skolem">tt</span> <span class="main">=</span> REL <span class="skolem">c</span>›</span></span> le_neq_implies_less 
                less.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> thread.distinct<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> has_ticket_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
              
            <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And we can apply the induction hypothesis›</span></span>  
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">lrel</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> lrel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> less.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main">&lt;</span>N›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Suc_lessD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>tt›</span></span> has acquired the lock, or started releasing it›</span>
            
            <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hence, current remains the same, but the weight of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>tt›</span></span></span></span> decreases›</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
              <span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c</span> 
            <span class="main">∧</span> tweight <span class="main">(</span><span class="skolem">ts</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">&gt;</span> tweight <span class="main">(</span><span class="skolem">ts'</span> <span class="skolem">tt</span><span class="main">)</span> 
            <span class="main">∧</span> has_ticket <span class="main">(</span><span class="skolem">ts'</span> <span class="skolem">tt</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> THIS UTT <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">unfolding</span></span> A.rstep_def
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alstep.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> astep_sng.cases<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_ticket_def tweight_def<span class="main">)</span>
            
            <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>tt›</span></span></span></span> still holds the current lock›</span></span>    
            <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tkt_thread <span class="skolem">ts'</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">tt</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tkt_thread_eq<span class="main">[</span><span class="operator">OF</span> R' <span class="quoted"><span class="quoted">‹<span class="skolem">tt</span><span class="main">&lt;</span>N›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

            <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And we can apply the IH›</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">lrel</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lrel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> less.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main">&lt;</span>N›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Suc_lessD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>  
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>      
  
  
      
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement 2: Bounding the Counters›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We fix the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> from the task description, which must be positive›</span></span>
  <span class="keyword1"><span class="command">consts</span></span> k<span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">k</span><span class="main">)</span> k_not0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"k<span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Challenge3-k_gt0"><span class="command">lemma</span></span> k_gt0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span>k"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">k</span><span class="main">)</span> <span class="operator">auto</span>  

  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹System's state: Current ticket, next ticket, thread states›</span></span>
  <span class="keyword1"><span class="command">type_synonym</span></span> bstate <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat <span class="main">×</span> <span class="main">(</span>nat <span class="main">⇒</span> thread<span class="main">)</span>"</span></span> 
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The step relation of a single thread›</span></span>  
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">bstep_sng</span> <span class="keyword2"><span class="keyword">where</span></span>
    enter_wait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bstep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>INIT<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>k<span class="main">*</span>N<span class="main">)</span><span class="main">,</span>WAIT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> N<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> loop_wait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">≠</span><span class="free"><span class="bound"><span class="entity">tk</span></span></span> <span class="main">⟹</span> <span class="free">bstep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>WAIT <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>WAIT <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> exit_wait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bstep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>WAIT <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>HOLD <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> start_release<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bstep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>HOLD <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>REL <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> release<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bstep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>REL <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> N<span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>INIT<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The step relation of the system, labeled with the thread <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> that performs the step›</span></span>
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">blstep</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span><span class="main">&lt;</span>N<span class="main">;</span> bstep_sng <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">blstep</span> <span class="free">t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">(</span><span class="free">t</span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initial state of the system›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≡</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> INIT<span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">interpretation</span></span> B<span class="main">:</span> system <span class="quoted">bs<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">blstep</span> <span class="keyword1"><span class="command">.</span></span>
        
  <span class="keyword1" id="Challenge3-b_never_blocked"><span class="command">lemma</span></span> b_never_blocked<span class="main">:</span> <span class="quoted"><span class="quoted">"B.can_step <span class="free">l</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">l</span><span class="main">&lt;</span>N"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="free">s</span> <span class="free">l</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> B.can_step_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> blstep.simps bstep_sng.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">interpretation</span></span> B<span class="main">:</span> df_system <span class="quoted">bs<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">blstep</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command">using</span></span> b_never_blocked<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> B.can_step_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that the abstract system simulates the concrete one.›</span></span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A few lemmas to ease the automation further below›</span></span>  
  <span class="keyword1" id="Challenge3-nat_sum_gtZ_iff"><span class="command">lemma</span></span> nat_sum_gtZ_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"finite <span class="free">s</span> <span class="main">⟹</span> sum <span class="free">f</span> <span class="free">s</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span>    
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
  <span class="keyword1" id="Challenge3-n_eq_Suc_sub1_conv"><span class="command">lemma</span></span> n_eq_Suc_sub1_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">n</span><span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1" id="Challenge3-mod_mult_mod_eq"><span class="command">lemma</span></span> mod_mult_mod_eq<span class="main">[</span><span class="operator">mod_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="main">(</span>k <span class="main">*</span> N<span class="main">)</span> <span class="keyword1">mod</span> N <span class="main">=</span> <span class="free">x</span> <span class="keyword1">mod</span> N"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dvd_eq_mod_eq_0 mod_mod_cancel mod_mult_self2_is_0<span class="main">)</span>

<span class="keyword1" id="Challenge3-mod_eq_imp_eq_aux"><span class="command">lemma</span></span> mod_eq_imp_eq_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">mod</span> N <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">mod</span> N <span class="main">⟹</span> <span class="free">a</span><span class="main">≤</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span><span class="main">&lt;</span><span class="free">a</span><span class="main">+</span>N <span class="main">⟹</span> <span class="free">b</span><span class="main">=</span><span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nat_mod_eq_lemma <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    
  <span class="keyword1" id="Challenge3-mod_eq_imp_eq"><span class="command">lemma</span></span> mod_eq_imp_eq<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">b</span> <span class="main">≤</span> <span class="free">x</span><span class="main">;</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">+</span> N<span class="main">;</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">y</span><span class="main">;</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">+</span> N<span class="main">;</span> <span class="free">x</span> <span class="keyword1">mod</span> N <span class="main">=</span> <span class="free">y</span> <span class="keyword1">mod</span> N <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">+</span> N"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">+</span> N"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> N <span class="main">=</span> <span class="free">y</span> <span class="keyword1">mod</span> N"</span></span>
    <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">+</span> N"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a4 a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">+</span> N"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a3 a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f6 a5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> mod_eq_imp_eq_aux nat_le_linear<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
    

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Map the ticket of a thread›</span></span>  
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_ticket</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">map_ticket</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> INIT <span class="main">=</span> INIT"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_ticket</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>WAIT <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span> <span class="main">=</span> WAIT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_ticket</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>HOLD <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span> <span class="main">=</span> HOLD <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_ticket</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>REL <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span> <span class="main">=</span> REL <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Challenge3-map_ticket_addsimps"><span class="command">lemma</span></span> map_ticket_addsimps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"map_ticket <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> INIT <span class="main">⟷</span> <span class="free">t</span><span class="main">=</span>INIT"</span></span>  
    <span class="quoted"><span class="quoted">"map_ticket <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> WAIT <span class="free">tk</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">tk'</span><span class="main">.</span> <span class="free">tk</span><span class="main">=</span><span class="free">f</span> <span class="bound">tk'</span> <span class="main">∧</span> <span class="free">t</span><span class="main">=</span>WAIT <span class="bound">tk'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"map_ticket <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> HOLD <span class="free">tk</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">tk'</span><span class="main">.</span> <span class="free">tk</span><span class="main">=</span><span class="free">f</span> <span class="bound">tk'</span> <span class="main">∧</span> <span class="free">t</span><span class="main">=</span>HOLD <span class="bound">tk'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"map_ticket <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> REL <span class="free">tk</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">tk'</span><span class="main">.</span> <span class="free">tk</span><span class="main">=</span><span class="free">f</span> <span class="bound">tk'</span> <span class="main">∧</span> <span class="free">t</span><span class="main">=</span>REL <span class="bound">tk'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the number of threads that use a ticket›</span></span>  
    
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">ni_weight</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"thread <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ni_weight</span> INIT <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ni_weight</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  
  <span class="keyword1" id="Challenge3-ni_weight_le1"><span class="command">lemma</span></span> ni_weight_le1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ni_weight <span class="free">s</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>
      
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">num_ni</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">≡</span> <span class="main">∑</span> <span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..&lt;</span>N<span class="main">.</span> ni_weight <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1" id="Challenge3-num_ni_init"><span class="command">lemma</span></span> num_ni_init<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_ni <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> INIT<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> num_ni_def<span class="main">)</span>
  
  <span class="keyword1" id="Challenge3-num_ni_upd"><span class="command">lemma</span></span> num_ni_upd<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N <span class="main">⟹</span> num_ni <span class="main">(</span><span class="free">ts</span><span class="main">(</span><span class="free">t</span><span class="main">:=</span><span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> num_ni <span class="free">ts</span> <span class="main">-</span> ni_weight <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="main">+</span> ni_weight <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> num_ni_def if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">ni_weight</span><span class="main"><span class="main">]</span></span> sum.If_cases <span class="dynamic"><span class="dynamic">algebra_simps</span></span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_diff1_nat
      <span class="main">)</span>
      
  <span class="keyword1" id="Challenge3-num_ni_nz_if"><span class="command">lemma</span></span> num_ni_nz_if<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t</span> <span class="main">&lt;</span> N<span class="main">;</span> <span class="free">ts</span> <span class="free">t</span> <span class="main">≠</span> INIT<span class="main">⟧</span> <span class="main">⟹</span> num_ni <span class="free">ts</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="free">t</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> num_ni_def<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1" id="Challenge3-num_ni_leN"><span class="command">lemma</span></span> num_ni_leN<span class="main">:</span> <span class="quoted"><span class="quoted">"num_ni <span class="free">ts</span> <span class="main">≤</span> N"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> num_ni_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_bounded_above<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We provide an additional invariant, considering the distance of 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>. Although we could probably get this from the previous 
    invariants, it is easy enough to prove directly.
  ›</span></span>        
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">invar3</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">c</span> <span class="main">+</span> num_ni <span class="bound">ts</span>"</span></span>
  
  <span class="keyword1" id="Challenge3-is_invar3"><span class="command">lemma</span></span> is_invar3<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_invar invar3"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar3_def as<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> alstep.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> astep_sng.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar3_def num_ni_upd<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> holds_only_current <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We establish a simulation relation: The concrete counters are 
    the abstract ones, wrapped around.
  ›</span></span>  
      
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sim_rel1</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span> <span class="main">(</span><span class="bound">ci</span><span class="main">,</span><span class="bound">ni</span><span class="main">,</span><span class="bound">tsi</span><span class="main">)</span><span class="main">.</span> 
    <span class="bound">ci</span> <span class="main">=</span> <span class="bound">c</span> <span class="keyword1">mod</span> N
  <span class="main">∧</span> <span class="bound">ni</span> <span class="main">=</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="main">(</span>k<span class="main">*</span>N<span class="main">)</span>
  <span class="main">∧</span> <span class="bound">tsi</span> <span class="main">=</span> <span class="main">(</span>map_ticket <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">mod</span> N<span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> <span class="bound">ts</span>
  "</span></span>

  <span class="keyword1" id="Challenge3-sraux"><span class="command">lemma</span></span> sraux<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"sim_rel1 <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span> <span class="main">(</span><span class="free">ci</span><span class="main">,</span><span class="free">ni</span><span class="main">,</span><span class="free">tsi</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ci</span> <span class="main">=</span> <span class="free">c</span> <span class="keyword1">mod</span> N <span class="main">∧</span> <span class="free">ni</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="main">(</span>k<span class="main">*</span>N<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def<span class="main">)</span>
    
  <span class="keyword1" id="Challenge3-sraux2"><span class="command">lemma</span></span> sraux2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sim_rel1 <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span> <span class="main">(</span><span class="free">ci</span><span class="main">,</span><span class="free">ni</span><span class="main">,</span><span class="free">tsi</span><span class="main">)</span><span class="main">;</span> <span class="free">t</span><span class="main">&lt;</span>N<span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">tsi</span> <span class="free">t</span> <span class="main">=</span> map_ticket <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> N<span class="main">)</span> <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def<span class="main">)</span>
    
    
  <span class="keyword1"><span class="command">interpretation</span></span> sim1<span class="main">:</span> simulationI <span class="quoted">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">alstep</span> <span class="quoted">bs<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">blstep</span> <span class="quoted">sim_rel1</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_rel1 as<span class="hidden">⇩</span><sub>0</sub> bs<span class="hidden">⇩</span><sub>0</sub>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def as<span class="hidden">⇩</span><sub>0</sub>_def bs<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span> <span class="skolem">bs</span> <span class="skolem">t</span> <span class="skolem">bs'</span>  
    <span class="keyword3"><span class="command">assume</span></span> Ra_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"A.reachable <span class="skolem">as</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> Rc_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"B.reachable <span class="skolem">bs</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> SIM<span class="main">:</span> <span class="quoted"><span class="quoted">"sim_rel1 <span class="skolem">as</span> <span class="skolem">bs</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> CS<span class="main">:</span> <span class="quoted"><span class="quoted">"blstep <span class="skolem">t</span> <span class="skolem">bs</span> <span class="skolem">bs'</span>"</span></span>
  
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">=</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ci</span></span> <span class="skolem"><span class="skolem">ni</span></span> <span class="skolem"><span class="skolem">tsi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span><span class="main">=</span><span class="main">(</span><span class="skolem">ci</span><span class="main">,</span><span class="skolem">ni</span><span class="main">,</span><span class="skolem">tsi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ci'</span></span> <span class="skolem"><span class="skolem">ni'</span></span> <span class="skolem"><span class="skolem">tsi'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs'</span><span class="main">=</span><span class="main">(</span><span class="skolem">ci'</span><span class="main">,</span><span class="skolem">ni'</span><span class="main">,</span><span class="skolem">tsi'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Ra_aux <span class="keyword1"><span class="command">have</span></span> Ra<span class="main">:</span> <span class="quoted"><span class="quoted">"A.reachable <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Rc_aux <span class="keyword1"><span class="command">have</span></span> Rc<span class="main">:</span> <span class="quoted"><span class="quoted">"B.reachable <span class="main">(</span><span class="skolem">ci</span><span class="main">,</span><span class="skolem">ni</span><span class="main">,</span><span class="skolem">tsi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       
    <span class="keyword1"><span class="command">from</span></span> CS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">&lt;</span>N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">+</span> num_ni <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar3 Ra<span class="main">,</span> <span class="operator">unfolded</span> invar3_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">have</span></span> AUX1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">≤</span><span class="skolem">tk</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tk</span><span class="main">&lt;</span><span class="skolem">c</span><span class="main">+</span>N"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="skolem">t</span> <span class="main">=</span> WAIT <span class="skolem">tk</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tk</span>
      <span class="keyword1"><span class="command">using</span></span> that A.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar1 Ra<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">&lt;</span>N›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">&lt;</span>N›</span></span> num_ni_leN<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      
    <span class="keyword1"><span class="command">from</span></span> SIM CS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as'</span><span class="main">.</span> alstep <span class="skolem">t</span> <span class="skolem">as</span> <span class="bound">as'</span> <span class="main">∧</span> sim_rel1 <span class="bound">as'</span> <span class="skolem">bs'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> blstep.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> bstep_sng.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alstep.intros<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sraux sraux2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> astep_sng.enter_wait<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_rel1_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> conjI ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sraux sraux2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alstep.intros<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> astep_sng.loop_wait<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sraux sraux2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> tk'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">tk'</span><span class="main">=</span><span class="skolem">c</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alstep.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> astep_sng.exit_wait<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> mod_eq_imp_eq_aux<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AUX1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sraux sraux2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alstep.intros<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> astep_sng.start_release<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sraux sraux2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alstep.intros<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> astep_sng.release<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def Let_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as'</span><span class="main">.</span> sim_rel1 <span class="bound">as'</span> <span class="skolem">bs'</span> <span class="main">∧</span> alstep <span class="skolem">t</span> <span class="skolem">as</span> <span class="bound">as'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>  
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span> <span class="skolem">bs</span> <span class="skolem">l</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"A.reachable <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="quoted">"B.reachable <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"sim_rel1 <span class="skolem">as</span> <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"A.can_step <span class="skolem">l</span> <span class="skolem">as</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"B.can_step <span class="skolem">l</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_never_blocked never_blocked <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>      


  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer of Properties›</span></span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We transfer a few properties over the simulation,
    which we need for the next refinement step.
  ›</span></span>
  
  <span class="keyword1" id="Challenge3-xfer_locks_ticket"><span class="command">lemma</span></span> xfer_locks_ticket<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"locks_ticket <span class="main">(</span>map_ticket <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">mod</span> N<span class="main">)</span> <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">tki</span>"</span></span>  
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">tk</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">tki</span><span class="main">=</span><span class="free">tk</span> <span class="keyword1">mod</span> N"</span></span> <span class="quoted"><span class="quoted">"locks_ticket <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="free">tk</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> locks_ticket_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  
  <span class="keyword1" id="Challenge3-b_holds_only_current"><span class="command">lemma</span></span> b_holds_only_current<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>B.reachable <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">ts</span><span class="main">)</span><span class="main">;</span> <span class="free">t</span> <span class="main">&lt;</span> N<span class="main">;</span> locks_ticket <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="free">tk</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">tk</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sim1.xfer_reachable<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> xfer_locks_ticket<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> holds_only_current 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1" id="Challenge3-b_mutual_exclusion'"><span class="command">lemma</span></span> b_mutual_exclusion'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>B.reachable <span class="free">s</span><span class="main">;</span> 
      <span class="free">t</span><span class="main">&lt;</span>N<span class="main">;</span> <span class="free">t'</span><span class="main">&lt;</span>N<span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">t'</span><span class="main">;</span> locks_ticket <span class="main">(</span>tts <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="free">tk</span><span class="main">;</span> locks_ticket <span class="main">(</span>tts <span class="free">s</span> <span class="free">t'</span><span class="main">)</span> <span class="free">tk'</span>
    <span class="main">⟧</span> <span class="main">⟹</span> False"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sim1.xfer_reachable<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> xfer_locks_ticket<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mutual_exclusion'<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1" id="Challenge3-xfer_has_ticket"><span class="command">lemma</span></span> xfer_has_ticket<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_ticket <span class="main">(</span>map_ticket <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">mod</span> N<span class="main">)</span> <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">tki</span>"</span></span>  
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">tk</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">tki</span><span class="main">=</span><span class="free">tk</span> <span class="keyword1">mod</span> N"</span></span> <span class="quoted"><span class="quoted">"has_ticket <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="free">tk</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> has_ticket_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1" id="Challenge3-has_ticket_in_range"><span class="command">lemma</span></span> has_ticket_in_range<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> Ra<span class="main">:</span> <span class="quoted"><span class="quoted">"A.reachable <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="keyword2"><span class="keyword">and</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"has_ticket <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="free">tk</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">≤</span><span class="free">tk</span> <span class="main">∧</span> <span class="free">tk</span><span class="main">&lt;</span><span class="free">c</span><span class="main">+</span>N"</span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">=</span><span class="free">c</span> <span class="main">+</span> num_ni <span class="free">ts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar3 Ra<span class="main">,</span> <span class="operator">unfolded</span> invar3_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">≤</span><span class="free">tk</span> <span class="main">∧</span> <span class="free">tk</span><span class="main">&lt;</span><span class="free">c</span><span class="main">+</span>N"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> A.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar1 Ra<span class="main">]</span> U
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main">&lt;</span>N›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main">&lt;</span>N›</span></span> num_ni_leN<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ts</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>  
    
  <span class="keyword1" id="Challenge3-b_has_ticket_unique"><span class="command">lemma</span></span> b_has_ticket_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>B.reachable <span class="main">(</span><span class="free">ci</span><span class="main">,</span><span class="free">ni</span><span class="main">,</span><span class="free">tsi</span><span class="main">)</span><span class="main">;</span> 
      <span class="free">t</span><span class="main">&lt;</span>N<span class="main">;</span> has_ticket <span class="main">(</span><span class="free">tsi</span> <span class="free">t</span><span class="main">)</span> <span class="free">tki</span><span class="main">;</span> <span class="free">t'</span><span class="main">&lt;</span>N<span class="main">;</span> has_ticket <span class="main">(</span><span class="free">tsi</span> <span class="free">t'</span><span class="main">)</span> <span class="free">tki</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t'</span><span class="main">=</span><span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sim1.xfer_reachable<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> c n ts
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> xfer_has_ticket<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> tk tk'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">tk</span><span class="main">=</span><span class="skolem">tk'</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> has_ticket_unique<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> has_ticket_in_range<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> tk<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">tk</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> has_ticket_in_range<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> tk<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">tk'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mod_eq_imp_eq<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
        
        
  
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement 3: Using an Array›</span></span><span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:refine3}›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we use an array instead of a counter, thus obtaining
    the exact data structures from the challenge assignment.
    
    Note that we model the array by a list of Booleans here.
  ›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹System's state: Current ticket array, next ticket, thread states›</span></span>
  <span class="keyword1"><span class="command">type_synonym</span></span> cstate <span class="main">=</span> <span class="quoted"><span class="quoted">"bool list <span class="main">×</span> nat <span class="main">×</span> <span class="main">(</span>nat <span class="main">⇒</span> thread<span class="main">)</span>"</span></span> 
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The step relation of a single thread›</span></span>  
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">cstep_sng</span> <span class="keyword2"><span class="keyword">where</span></span>
    enter_wait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cstep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>INIT<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>k<span class="main">*</span>N<span class="main">)</span><span class="main">,</span>WAIT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> N<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> loop_wait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">tk</span></span></span> <span class="main">⟹</span> <span class="free">cstep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>WAIT <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>WAIT <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> exit_wait<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">tk</span></span></span> <span class="main">⟹</span> <span class="free">cstep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>WAIT <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>HOLD <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> start_release<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cstep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>HOLD <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">:=</span>False<span class="main">]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>REL <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> release<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cstep_sng</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>REL <span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">tk</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> N <span class="main">:=</span> True<span class="main">]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>INIT<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The step relation of the system, labeled with the thread <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> that performs the step›</span></span>
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">clstep</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span><span class="main">&lt;</span>N<span class="main">;</span> cstep_sng <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">clstep</span> <span class="free">t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">(</span><span class="free">t</span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initial state of the system›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cs<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span>replicate N False<span class="main">)</span><span class="main">[</span><span class="main">0</span><span class="main">:=</span>True<span class="main">]</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> INIT<span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">interpretation</span></span> C<span class="main">:</span> system <span class="quoted">cs<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">clstep</span> <span class="keyword1"><span class="command">.</span></span>
        
  <span class="keyword1" id="Challenge3-c_never_blocked"><span class="command">lemma</span></span> c_never_blocked<span class="main">:</span> <span class="quoted"><span class="quoted">"C.can_step <span class="free">l</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">l</span><span class="main">&lt;</span>N"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="free">s</span> <span class="free">l</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> C.can_step_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp_all</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> clstep.simps cstep_sng.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword1"><span class="command">interpretation</span></span> C<span class="main">:</span> df_system <span class="quoted">cs<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">clstep</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command">using</span></span> c_never_blocked<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> C.can_step_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We establish another invariant that states that the ticket numbers are bounded.›</span></span>  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">invar4</span> 
    <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span><span class="main">&lt;</span>N <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&lt;</span>N<span class="main">.</span> <span class="main">∀</span><span class="bound">tk</span><span class="main">.</span> has_ticket <span class="main">(</span><span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tk</span> <span class="main">⟶</span> <span class="bound">tk</span><span class="main">&lt;</span>N<span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Challenge3-is_invar4"><span class="command">lemma</span></span> is_invar4<span class="main">:</span> <span class="quoted"><span class="quoted">"B.is_invar invar4"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar4_def bs<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> blstep.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bstep_sng.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> invar4_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> N_gt0 fun_upd_apply has_ticket_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mod_less_divisor<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_triv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other fun_upd_same has_ticket_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other fun_upd_same has_ticket_def has_ticket_simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> mod_less_divisor <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>  
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_apply thread.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> thread.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
          thread.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> has_ticket_def<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a predicate that describes that
    a thread of the system is at the release sequence point --- in this case,
    the array does not have a set bit, otherwise, the set bit corresponds to the 
    current ticket.›</span></span>
      
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_REL_state</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ts</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">t</span></span><span class="main">&lt;</span>N<span class="main">.</span> <span class="main">∃</span><span class="bound">tk</span><span class="main">.</span> <span class="bound">ts</span> <span class="bound">t</span> <span class="main">=</span> REL <span class="bound">tk</span>"</span></span>  
    
  <span class="keyword1" id="Challenge3-is_REL_state_simps"><span class="command">lemma</span></span> is_REL_state_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N <span class="main">⟹</span> is_REL_state <span class="main">(</span><span class="free">ts</span><span class="main">(</span><span class="free">t</span><span class="main">:=</span>REL <span class="free">tk</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N <span class="main">⟹</span> <span class="main">¬</span>is_REL <span class="main">(</span><span class="free">ts</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>is_REL <span class="free">s'</span> 
      <span class="main">⟹</span> is_REL_state <span class="main">(</span><span class="free">ts</span><span class="main">(</span><span class="free">t</span><span class="main">:=</span><span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> is_REL_state <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_REL_state_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> thread.disc<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span><span class="main">)</span>
  
  <span class="keyword1" id="Challenge3-is_REL_state_aux1"><span class="command">lemma</span></span> is_REL_state_aux1<span class="main">:</span>  
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"B.reachable <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> REL<span class="main">:</span> <span class="quoted"><span class="quoted">"is_REL_state <span class="free">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="free">t</span> <span class="main">=</span> WAIT <span class="free">tk</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">tk</span><span class="main">≠</span><span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> REL <span class="keyword1"><span class="command">unfolding</span></span> is_REL_state_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t' tk'
      <span class="keyword1"><span class="command">using</span></span> b_has_ticket_unique<span class="main">[</span><span class="operator">OF</span> R <span class="quoted"><span class="quoted">‹<span class="free">t</span><span class="main">&lt;</span>N›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">tk</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> b_holds_only_current<span class="main">[</span><span class="operator">OF</span> R<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">tk'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1" id="Challenge3-is_REL_state_aux2"><span class="command">lemma</span></span> is_REL_state_aux2<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"B.reachable <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="free">t</span> <span class="main">=</span> REL <span class="free">tk</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_REL_state <span class="main">(</span><span class="free">ts</span><span class="main">(</span><span class="free">t</span><span class="main">:=</span>INIT<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b_holds_only_current<span class="main">[</span><span class="operator">OF</span> R<span class="main">]</span> A
    <span class="keyword1"><span class="command">using</span></span> b_mutual_exclusion'<span class="main">[</span><span class="operator">OF</span> R<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_REL_state_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation that implements current ticket by array›</span></span>      
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sim_rel2</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">n</span><span class="main">,</span><span class="bound">ts</span><span class="main">)</span> <span class="main">(</span><span class="bound">ci</span><span class="main">,</span><span class="bound">ni</span><span class="main">,</span><span class="bound">tsi</span><span class="main">)</span><span class="main">.</span> 
    <span class="main">(</span><span class="keyword1">if</span> is_REL_state <span class="bound">ts</span> <span class="keyword1">then</span> 
      <span class="bound">ci</span> <span class="main">=</span> replicate N False 
    <span class="keyword1">else</span>   
      <span class="bound">ci</span> <span class="main">=</span> <span class="main">(</span>replicate N False<span class="main">)</span><span class="main">[</span><span class="bound">c</span><span class="main">:=</span>True<span class="main">]</span>
    <span class="main">)</span>
  <span class="main">∧</span> <span class="bound">ni</span> <span class="main">=</span> <span class="bound">n</span>
  <span class="main">∧</span> <span class="bound">tsi</span> <span class="main">=</span> <span class="bound">ts</span>
  "</span></span>
  
  <span class="keyword1"><span class="command">interpretation</span></span> sim2<span class="main">:</span> simulationI <span class="quoted">bs<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">blstep</span> <span class="quoted">cs<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">clstep</span> <span class="quoted">sim_rel2</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sim_rel2 bs<span class="hidden">⇩</span><sub>0</sub> cs<span class="hidden">⇩</span><sub>0</sub>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel2_def bs<span class="hidden">⇩</span><sub>0</sub>_def cs<span class="hidden">⇩</span><sub>0</sub>_def is_REL_state_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bs</span> <span class="skolem">cs</span> <span class="skolem">t</span> <span class="skolem">cs'</span>  
    <span class="keyword3"><span class="command">assume</span></span> Rc_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"B.reachable <span class="skolem">bs</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> Rd_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"C.reachable <span class="skolem">cs</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> SIM<span class="main">:</span> <span class="quoted"><span class="quoted">"sim_rel2 <span class="skolem">bs</span> <span class="skolem">cs</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> CS<span class="main">:</span> <span class="quoted"><span class="quoted">"clstep <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">cs'</span>"</span></span>
  
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span><span class="main">=</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ci</span></span> <span class="skolem"><span class="skolem">ni</span></span> <span class="skolem"><span class="skolem">tsi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span><span class="main">=</span><span class="main">(</span><span class="skolem">ci</span><span class="main">,</span><span class="skolem">ni</span><span class="main">,</span><span class="skolem">tsi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ci'</span></span> <span class="skolem"><span class="skolem">ni'</span></span> <span class="skolem"><span class="skolem">tsi'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span><span class="main">=</span><span class="main">(</span><span class="skolem">ci'</span><span class="main">,</span><span class="skolem">ni'</span><span class="main">,</span><span class="skolem">tsi'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cs'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Rc_aux <span class="keyword1"><span class="command">have</span></span> Rc<span class="main">:</span> <span class="quoted"><span class="quoted">"B.reachable <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Rd_aux <span class="keyword1"><span class="command">have</span></span> Rd<span class="main">:</span> <span class="quoted"><span class="quoted">"C.reachable <span class="main">(</span><span class="skolem">ci</span><span class="main">,</span><span class="skolem">ni</span><span class="main">,</span><span class="skolem">tsi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       
    <span class="keyword1"><span class="command">from</span></span> CS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">&lt;</span>N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tk</span><span class="main">&lt;</span>N"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="skolem">t</span> <span class="main">=</span> WAIT <span class="skolem">tk</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tk</span>
      <span class="keyword1"><span class="command">using</span></span> B.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar4 Rc<span class="main">]</span> that <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">&lt;</span>N›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar4_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> HOLD_AUX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tk</span><span class="main">=</span><span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="skolem">t</span> <span class="main">=</span> HOLD <span class="skolem">tk</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tk</span>
      <span class="keyword1"><span class="command">using</span></span> b_holds_only_current<span class="main">[</span><span class="operator">OF</span> Rc <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">&lt;</span>N›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">tk</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> REL_AUX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tk</span><span class="main">=</span><span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="skolem">t</span> <span class="main">=</span> REL <span class="skolem">tk</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">&lt;</span>N"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">tk</span>
      <span class="keyword1"><span class="command">using</span></span> b_holds_only_current<span class="main">[</span><span class="operator">OF</span> Rc <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">&lt;</span>N›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">tk</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">&lt;</span>N"</span></span> <span class="keyword1"><span class="command">using</span></span> B.invar_reachable<span class="main">[</span><span class="operator">OF</span> is_invar4 Rc<span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar4_def<span class="main">)</span>
      
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"replicate N False <span class="main">≠</span> <span class="main">(</span>replicate N False<span class="main">)</span><span class="main">[</span><span class="skolem">c</span> <span class="main">:=</span> True<span class="main">]</span>"</span></span>  
      <span class="quoted"><span class="quoted">"<span class="main">(</span>replicate N False<span class="main">)</span><span class="main">[</span><span class="skolem">c</span> <span class="main">:=</span> True<span class="main">]</span> <span class="main">≠</span> replicate N False"</span></span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq nth_list_update<span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">&lt;</span> N›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>replicate N False<span class="main">)</span><span class="main">[</span><span class="skolem">c</span> <span class="main">:=</span> True<span class="main">]</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">⟷</span> <span class="skolem">d</span><span class="main">=</span><span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">&lt;</span>N"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq nth_list_update<span class="main">)</span> 
      
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>replicate N False<span class="main">)</span><span class="main">[</span><span class="skolem">tk</span> <span class="main">:=</span> False<span class="main">]</span> <span class="main">=</span> replicate N False"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">tk</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq nth_list_update'<span class="main">)</span> 
      
    <span class="keyword1"><span class="command">from</span></span> SIM CS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs'</span><span class="main">.</span> blstep <span class="skolem">t</span> <span class="skolem">bs</span> <span class="bound">bs'</span> <span class="main">∧</span> sim_rel2 <span class="bound">bs'</span> <span class="skolem">cs'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sim_rel2_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> clstep.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> cstep_sng.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> blstep.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bstep_sng.enter_wait<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> tk'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> blstep.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bstep_sng.loop_wait<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_REL_state_aux1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Rc<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> blstep.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bstep_sng.exit_wait<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> blstep.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bstep_sng.start_release<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel2_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HOLD_AUX <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> blstep.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bstep_sng.release<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sim_rel2_def 
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_REL_state_aux2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Rc<span class="main"><span class="main">]</span></span> 
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_triv is_REL_state_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bs'</span><span class="main">.</span> sim_rel2 <span class="bound">bs'</span> <span class="skolem">cs'</span> <span class="main">∧</span> blstep <span class="skolem">t</span> <span class="skolem">bs</span> <span class="bound">bs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
  <span class="keyword1"><span class="command">next</span></span>  
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bs</span> <span class="skolem">cs</span> <span class="skolem">l</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"B.reachable <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"C.reachable <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"sim_rel2 <span class="skolem">bs</span> <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"B.can_step <span class="skolem">l</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"C.can_step <span class="skolem">l</span> <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_never_blocked b_never_blocked <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>        

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer Setup›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We set up the final simulation relation, and the transfer of the 
    concepts used in the correctness statements. ›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sim_rel</span> <span class="main">≡</span> sim_rel1 <span class="keyword1">OO</span> sim_rel2"</span></span>
  <span class="keyword1"><span class="command">interpretation</span></span> sim<span class="main">:</span> simulation <span class="quoted">as<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">alstep</span> <span class="quoted">cs<span class="hidden">⇩</span><sub>0</sub></span> <span class="quoted">clstep</span> <span class="quoted">sim_rel</span>
    <span class="keyword1"><span class="command">unfolding</span></span> sim_rel_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim_trans<span class="main">)</span> <span class="operator">unfold_locales</span>
  

  <span class="keyword1" id="Challenge3-xfer_holds"><span class="command">lemma</span></span> xfer_holds<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sim_rel <span class="free">s</span> <span class="free">cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_HOLD <span class="main">(</span>tts <span class="free">cs</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> is_HOLD <span class="main">(</span>tts <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sim_rel_def sim_rel1_def sim_rel2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="free">cs</span> <span class="free">t</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Challenge3-xfer_waits"><span class="command">lemma</span></span> xfer_waits<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sim_rel <span class="free">s</span> <span class="free">cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_WAIT <span class="main">(</span>tts <span class="free">cs</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> is_WAIT <span class="main">(</span>tts <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sim_rel_def sim_rel1_def sim_rel2_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tts <span class="free">cs</span> <span class="free">t</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    
  <span class="keyword1" id="Challenge3-xfer_init"><span class="command">lemma</span></span> xfer_init<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sim_rel <span class="free">s</span> <span class="free">cs</span>"</span></span>  
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tts <span class="free">cs</span> <span class="free">t</span> <span class="main">=</span> INIT <span class="main">⟷</span> tts <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> INIT"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sim_rel_def sim_rel1_def sim_rel2_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main Theorems›</span></span> <span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:main_theorems}›</span></span> 

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Trusted Code Base›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹  
    Note that the trusted code base for these theorems is only the 
    formalization of the concrete system as defined in Section~\ref{sec:refine3}. 
    The simulation setup and the 
    abstract systems are only auxiliary constructions for the proof.
    
    For completeness, we display the relevant definitions of
    reachability, runs, and fairness here:
    
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> [display, source] <span class="quoted"><span class="quoted">"C.step <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">s'</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">.</span></span> clstep <span class="bound"><span class="bound">l</span></span> <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">s'</span></span><span class="main"><span class="main">)</span></span>"</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="operator"><span class="operator">simp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [display] C.reachable_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span> C.run_definitions<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  ›</span></span>
  
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Safety›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that there is no reachable state in which two different 
    threads hold the lock.›</span></span>
  <span class="comment1">(* ALWAYS (NOT (HOLD ** HOLD)) *)</span>
  <span class="keyword1"><span class="command">theorem</span></span> final_mutual_exclusion<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>C.reachable <span class="free">s</span><span class="main">;</span> 
      <span class="free">t</span><span class="main">&lt;</span>N<span class="main">;</span> <span class="free">t'</span><span class="main">&lt;</span>N<span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">t'</span><span class="main">;</span> is_HOLD <span class="main">(</span>tts <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">;</span> is_HOLD <span class="main">(</span>tts <span class="free">s</span> <span class="free">t'</span><span class="main">)</span>
    <span class="main">⟧</span> <span class="main">⟹</span> False"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sim.xfer_reachable<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xfer_holds<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> mutual_exclusion<span class="main">)</span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Fairness›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that, whenever a thread <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> draws a ticket, all other 
    threads <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t'›</span></span></span></span> waiting for the lock will be granted the lock before <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span>. ›</span></span>  
    
  <span class="comment1">(* ALWAYS (INIT t<span class="hidden">⇩</span><sub>1</sub> ∧ WAIT t<span class="hidden">⇩</span><sub>2</sub> ∧ X (WAIT t<span class="hidden">⇩</span><sub>1</sub>) ⟶ HOLD t<span class="hidden">⇩</span><sub>2</sub> BEFORE HOLD t<span class="hidden">⇩</span><sub>1</sub> ) *)</span>  
  <span class="keyword1"><span class="command">theorem</span></span> final_fair<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RUN<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_run <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ACQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t</span><span class="main">=</span>INIT"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_WAIT <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
      <span class="comment1">― ‹Thread <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>t›</span></span> draws ticket in step <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>i›</span></span>›</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> HOLD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_HOLD <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="free">j</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
      <span class="comment1">― ‹Thread <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>t›</span></span> holds lock in step <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>j›</span></span>›</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> WAIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span><span class="main">&lt;</span>N"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_WAIT <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t'</span><span class="main">)</span>"</span></span> 
      <span class="comment1">― ‹Thread <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>t'›</span></span> waits for lock at step <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>i›</span></span>›</span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_HOLD <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="free">l</span><span class="main">)</span> <span class="free">t'</span><span class="main">)</span>"</span></span> 
      <span class="comment1">― ‹Then, <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>t'›</span></span> gets lock earlier›</span>
    <span class="keyword1"><span class="command">using</span></span> RUN
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sim.xfer_run<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
    <span class="keyword3"><span class="command">assume</span></span> Ra<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_run <span class="skolem">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> SIM<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> sim_rel <span class="main">(</span><span class="skolem">as</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">note</span></span> XFER <span class="main">=</span> xfer_init<span class="main">[</span><span class="operator">OF</span> SIM<span class="main">]</span> xfer_holds<span class="main">[</span><span class="operator">OF</span> SIM<span class="main">]</span> xfer_waits<span class="main">[</span><span class="operator">OF</span> SIM<span class="main">]</span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> XFER<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> fair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Ra<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> that<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> XFER<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Liveness›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that, for a fair run, every thread that waits for the lock 
    will eventually hold the lock.›</span></span>
  <span class="comment1">(* ALWAYS (WAIT  ⟶ EVENTUALLY HOLD) *)</span>  
  <span class="keyword1"><span class="command">theorem</span></span> final_progress<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FRUN<span class="main">:</span> <span class="quoted"><span class="quoted">"C.is_fair_run <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> WAIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">&lt;</span>N"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_WAIT <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="free">i</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="free">i</span><span class="main">.</span> is_HOLD <span class="main">(</span>tts <span class="main">(</span><span class="free">s</span> <span class="bound">j</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FRUN
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sim.xfer_fair_run<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
    <span class="keyword3"><span class="command">assume</span></span> Ra<span class="main">:</span> <span class="quoted"><span class="quoted">"A.is_fair_run <span class="skolem">as</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> SIM<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> sim_rel <span class="main">(</span><span class="skolem">as</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">note</span></span> XFER <span class="main">=</span> xfer_init<span class="main">[</span><span class="operator">OF</span> SIM<span class="main">]</span> xfer_holds<span class="main">[</span><span class="operator">OF</span> SIM<span class="main">]</span> xfer_waits<span class="main">[</span><span class="operator">OF</span> SIM<span class="main">]</span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> XFER<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> progress<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Ra<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>