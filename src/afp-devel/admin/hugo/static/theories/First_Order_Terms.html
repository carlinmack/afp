<div id="Transitive_Closure_More">
<div class="head">
<h1>Theory Transitive_Closure_More</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Results›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reflexive Transitive Closures of Orders›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transitive_Closure_More
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> rtranclp_less_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(≤)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="main">(≤)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> tranclp_less <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> <span class="main">(&lt;)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> tranclp_induct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> rtranclp_greater_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(≥)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="main">(≥)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> tranclp_greater <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(&gt;)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> <span class="main">(&gt;)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> tranclp_induct<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Seq_More">
<div class="head">
<h1>Theory Seq_More</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Results on Infinite Sequences›</span></span>

<span class="comment1">(* TODO: Move to Abstract-Rewriting.Seq -- maybe this is of very general interest... *)</span>
<span class="keyword1"><span class="command">theory</span></span> Seq_More
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../Abstract-Rewriting/Seq.html">Abstract-Rewriting.Seq</a>"</span>
    <a href="Transitive_Closure_More.html">Transitive_Closure_More</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Seq_More-down_chain_imp_eq"><span class="command">lemma</span></span> down_chain_imp_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat seq"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">≥</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="bound">N</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wf_less <span class="main">[</span><span class="operator">unfolded</span> wf_eq_minimal<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="var">?F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">N</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?F</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">N</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="var">?F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">N</span><span class="main">.</span> <span class="main">¬</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">N</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">N</span> <span class="main">≥</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chainp_imp_rtranclp <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(≥)</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">N</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">N</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> less_SucI order.not_eq_order_implies_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Seq_More-inc_seq_greater"><span class="command">lemma</span></span> inc_seq_greater<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat seq"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> neq0_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Fun_More">
<div class="head">
<h1>Theory Fun_More</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Results on Bijections›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Fun_More <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Fun_More-finite_card_eq_imp_bij_betw"><span class="command">lemma</span></span> finite_card_eq_imp_bij_betw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="free">A</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inj_on_iff_eq_card <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_imp_bij_betw<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every bijective function between two subsets of a set can be turned
into a compatible renaming (with finite domain) on the full set.›</span></span>
<span class="keyword1" id="Fun_More-bij_betw_extend"><span class="command">lemma</span></span> bij_betw_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">.</span> finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>UNIV <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
    bij_betw <span class="bound">g</span> <span class="free">V</span> <span class="free">V</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> card <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> * bij_betw_same_card<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> card <span class="free">A</span> <span class="main">-</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> card_Diff_subset_Int finite_Int<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="free">B</span> <span class="main">-</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> card_Diff_subset_Int finite_Int inf_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">g</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span> bij_betw_iff_card finite_Diff<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="skolem">g</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">h</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> * bij_betw_cong h_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">h</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def h_def inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∩</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">h</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_combine<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∪</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∪</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> <span class="free">V</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">⊆</span> <span class="free">V</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">h</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">h</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def h_def inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">h</span> <span class="main">(</span><span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_combine<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> <span class="free">V</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">⊆</span> <span class="free">V</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">h</span> <span class="free">V</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>UNIV <span class="main">-</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Merging Functions›</span></span>
<span class="comment1">(* Copied and canonized from IsaFoR's Term theory and Polynomial Factorization in the AFP. *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fun_merge</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1" id="Fun_More-fun_merge_eq_nth"><span class="command">lemma</span></span> fun_merge_eq_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ident<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">as</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">as</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fun_merge <span class="free">fs</span> <span class="free">as</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">as</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i a<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fun_merge_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ident<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ i _ a<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fun_More-fun_merge_part"><span class="command">lemma</span></span> fun_merge_part<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">as</span><span class="main">.</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free">as</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">as</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">as</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fun_merge <span class="free">fs</span> <span class="free">as</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> fun_merge_eq_nth <span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span> 3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Fun_More-fun_merge"><span class="command">lemma</span></span> fun_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">Xs</span><span class="main">.</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free">Xs</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">Xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">Xs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">Xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span> <span class="free">Xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">i</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?τ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="free">τ</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">Xs</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fun_merge <span class="var">?τ</span> <span class="free">Xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?σ</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI ballI<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">insert</span> fun_merge_part<span class="main"><span class="main">[</span></span><span class="operator">OF</span> part<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?τ</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Option_Monad">
<div class="head">
<h1>Theory Option_Monad</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Option Monad›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Option_Monad
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> Option.bind_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> unit option"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">guard</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> Some <span class="main">()</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="Option_Monad-guard_cong"><span class="command">lemma</span></span> guard_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> guard <span class="free">b</span> <span class="main">&gt;&gt;</span> <span class="free">m</span> <span class="main">=</span> guard <span class="free">c</span> <span class="main">&gt;&gt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guard_def<span class="main">)</span>

<span class="keyword1" id="Option_Monad-guard_simps"><span class="command">lemma</span></span> guard_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"guard <span class="free">b</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟷</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"guard <span class="free">b</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="main">¬</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guard_def<span class="main">)</span>

<span class="keyword1" id="Option_Monad-guard_elims"><span class="command">lemma</span></span> guard_elims<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"guard <span class="free">b</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"guard <span class="free">b</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guard_simps<span class="main">)</span>

<span class="keyword1" id="Option_Monad-guard_intros"><span class="command">lemma</span></span> guard_intros <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⟹</span> guard <span class="free">b</span> <span class="main">=</span> Some <span class="main">()</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> guard <span class="free">b</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> guard_simps<span class="main">)</span>

<span class="keyword1" id="Option_Monad-guard_True"><span class="command">lemma</span></span> guard_True <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"guard True <span class="main">=</span> Some <span class="main">()</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Option_Monad-guard_False"><span class="command">lemma</span></span> guard_False <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"guard False <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Option_Monad-guard_and_to_bind"><span class="command">lemma</span></span> guard_and_to_bind<span class="main">:</span> <span class="quoted"><span class="quoted">"guard <span class="main">(</span><span class="free">a</span> <span class="main">∧</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> guard <span class="free">a</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> guard <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">zip_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list option"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">zip_option</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> Some <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">zip_option</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">zs</span> <span class="main">←</span> <span class="free">zip_option</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">;</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">zip_option</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">zip_option</span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹induction scheme for zip›</span></span>
<span class="keyword1" id="Option_Monad-zip_induct"><span class="command">lemma</span></span> zip_induct <span class="main">[</span><span class="operator">case_names</span> Cons_Cons Nil1 Nil2<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="main">[]</span> <span class="bound">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction_schema</span><span class="main">)</span> <span class="main">(</span><span class="operator">pat_completeness</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">lexicographic_order</span><span class="main">)</span>

<span class="keyword1" id="Option_Monad-zip_option_zip_conv"><span class="command">lemma</span></span> zip_option_zip_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Some <span class="free">zs</span> <span class="main">⟷</span> length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> length <span class="free">zs</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">zs</span> <span class="main">=</span> zip <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Some <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> length <span class="free">zs</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">zs</span> <span class="main">=</span> zip <span class="free">xs</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_option.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"zip_option <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">=</span> Some <span class="skolem">zs'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">zs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"zip_option <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">=</span> zip <span class="free">xs</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Some <span class="free">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_induct<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Option_Monad-zip_option_None"><span class="command">lemma</span></span> zip_option_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> None <span class="main">⟷</span> length <span class="free">xs</span> <span class="main">≠</span> length <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≠</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> length <span class="free">xs</span> <span class="main">≠</span> length <span class="free">ys</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Some <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_option_zip_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> None›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≠</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> zip_option.induct<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> zip_option.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span><span class="main">]</span>

<span class="keyword1" id="Option_Monad-zip_option_intros"><span class="command">lemma</span></span> zip_option_intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">;</span> length <span class="free">zs</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">;</span> <span class="free">zs</span> <span class="main">=</span> zip <span class="free">xs</span> <span class="free">ys</span><span class="main">⟧</span>
    <span class="main">⟹</span> zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Some <span class="free">zs</span>"</span></span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≠</span> length <span class="free">ys</span> <span class="main">⟹</span> zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_option_zip_conv zip_option_None<span class="main">)</span>

<span class="keyword1" id="Option_Monad-zip_option_elims"><span class="command">lemma</span></span> zip_option_elims <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Some <span class="free">zs</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⟦</span>length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">;</span> length <span class="free">zs</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">;</span> <span class="free">zs</span> <span class="main">=</span> zip <span class="free">xs</span> <span class="free">ys</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">≠</span> length <span class="free">ys</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_option_zip_conv zip_option_None<span class="main">)</span>

<span class="keyword1" id="Option_Monad-zip_option_simps"><span class="command">lemma</span></span> zip_option_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> None <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span> False"</span></span>
  <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> None <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">≠</span> length <span class="free">ys</span>"</span></span>
  <span class="quoted"><span class="quoted">"zip_option <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Some <span class="free">zs</span> <span class="main">⟹</span> <span class="free">zs</span> <span class="main">=</span> zip <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_option_None zip_option_zip_conv<span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mapM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list option"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> Some <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">y</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
      <span class="bound">ys</span> <span class="main">←</span> <span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
      Some <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1" id="Option_Monad-mapM_None"><span class="command">lemma</span></span> mapM_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="skolem">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Option_Monad-mapM_Some"><span class="command">lemma</span></span> mapM_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">ys</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>   
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="skolem">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Option_Monad-mapM_Some_idx"><span class="command">lemma</span></span> mapM_Some_idx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> some<span class="main">:</span> <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> m <span class="main">=</span> mapM_Some <span class="main">[</span><span class="operator">OF</span> some<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> m<span class="main">[</span><span class="operator">unfolded</span> set_conv_nth<span class="main">]</span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">y</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> m <span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Option_Monad-mapM_cong"><span class="command">lemma</span></span> mapM_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> mapM <span class="free">g</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Option_Monad-mapM_map"><span class="command">lemma</span></span> mapM_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> None<span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="free">xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mapM_None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mapM_Some <span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Option_Monad-mapM_mono"><span class="command">lemma</span></span> mapM_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> option"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_option <span class="main">(</span><span class="free">C</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_option <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> mapM <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mapM.simps 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> option.const_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mapM.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bind_mono <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C bind_mono <span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons option.const_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Term">
<div class="head">
<h1>Theory Term</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹First-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Term
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>funs_term <span class="main">:</span> <span class="tfree">'f</span><span class="main">,</span> vars_term <span class="main">:</span> <span class="tfree">'v</span><span class="main">)</span> <span class="quoted">"term"</span> <span class="main">=</span>
  <span class="entity">is_Var</span><span class="main">:</span> Var <span class="main">(</span><span class="free"><span class="free"><span class="entity">the_Var</span></span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'v</span></span></span><span class="main">)</span> <span class="main">|</span>
  Fun <span class="tfree"><span class="quoted"><span class="tfree">'f</span></span></span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">args</span></span></span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term list"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">args</span> <span class="main">(</span>Var <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_Fun</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">¬</span> is_Var <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Term-is_VarE"><span class="command">lemma</span></span> is_VarE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_Var <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Var <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-is_FunE"><span class="command">lemma</span></span> is_FunE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_Fun <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">f</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Fun <span class="bound">f</span> <span class="bound">ts</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reorient equations of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Var <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free"><span class="free">f</span></span> <span class="free"><span class="free">ss</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to facilitate
  simplification.›</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹
  <span class="entity">Reorient_Proc.add</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Var<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span>
  #&gt; <span class="entity">Reorient_Proc.add</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Fun<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> reorient_Var <span class="main">(</span><span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">=</span> <span class="free">t</span>"</span></span><span class="main">)</span> <span class="main">=</span> <span class="entity">Reorient_Proc.proc</span>
<span class="keyword1"><span class="command">simproc_setup</span></span> reorient_Fun <span class="main">(</span><span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">t</span>"</span></span><span class="main">)</span> <span class="main">=</span> <span class="entity">Reorient_Proc.proc</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The \emph{root symbol} of a term is defined by:›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">×</span> nat<span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term-finite_vars_term"><span class="command">lemma</span></span> finite_vars_term <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>vars_term <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Term-finite_Union_vars_term"><span class="command">lemma</span></span> finite_Union_vars_term<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> vars_term <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A substitution is a mapping <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>σ›</span></span></span></span> from variables to terms. We call a substitution that
  alters the type of variables a generalized substitution, since it does not have all properties
  that are expected of (standard) substitutions (e.g., there is no empty substitution).›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> gsubst"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_apply_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 67<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⋅</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main"><span class="free">⋅</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main"><span class="free">⋅</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">subst_compose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'u</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> gsubst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'u</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span>"</span> 75<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1"><span class="free">∘<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term-subst_subst_compose"><span class="command">lemma</span></span> subst_subst_compose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_apply_term.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_compose_def<span class="main">)</span>

<span class="keyword1" id="Term-subst_compose_assoc"><span class="command">lemma</span></span> subst_compose_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">μ</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">μ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">μ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">μ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">μ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">σ</span><span class="main">(</span><span class="skolem">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⋅</span> <span class="free">μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_compose_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">σ</span><span class="main">(</span><span class="skolem">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">τ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_compose_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term-subst_apply_term_empty"><span class="command">lemma</span></span> subst_apply_term_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> Var <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> map_ext <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="main">_</span> <span class="quoted">id</span><span class="main">,</span> <span class="operator">OF</span> Fun<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">interpretation</span></span> subst_monoid_mult<span class="main">:</span> monoid_mult <span class="quoted"><span class="quoted">"Var"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(∘<span class="hidden">⇩</span><sub>s</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_compose_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_compose_def<span class="main">)</span>

<span class="keyword1" id="Term-term_subst_eq"><span class="command">lemma</span></span> term_subst_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> vars_term <span class="free">t</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Term-term_subst_eq_rev"><span class="command">lemma</span></span> term_subst_eq_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> vars_term <span class="free">t</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Term-term_subst_eq_conv"><span class="command">lemma</span></span> term_subst_eq_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> vars_term <span class="free">t</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> term_subst_eq <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">τ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> term_subst_eq_rev <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">τ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term-subst_term_eqI"><span class="command">lemma</span></span> subst_term_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Var <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">x</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_domain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">subst_domain</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">x</span> <span class="main">≠</span> Var <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_range</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">subst_range</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">`</span> subst_domain <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The variables introduced by a substitution.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">range_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">range_vars</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>vars_term <span class="main">`</span> subst_range <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_renaming</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_renaming</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> is_Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> inj_on <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>subst_domain <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term-vars_term_subst"><span class="command">lemma</span></span> vars_term_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_term <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>vars_term <span class="main">`</span> <span class="free">σ</span> <span class="main">`</span> vars_term <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Term-range_varsE"><span class="command">lemma</span></span> range_varsE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> range_vars <span class="free">σ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> vars_term <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> subst_range <span class="free">σ</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> range_vars_def<span class="main">)</span>

<span class="keyword1" id="Term-range_vars_subst_compose_subset"><span class="command">lemma</span></span> range_vars_subst_compose_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"range_vars <span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>range_vars <span class="free">σ</span> <span class="main">-</span> subst_domain <span class="free">τ</span><span class="main">)</span> <span class="main">∪</span> range_vars <span class="free">τ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> subst_domain <span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="main">(</span><span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> range_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> subst_domain <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="main">(</span><span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> vars_term <span class="main">(</span><span class="free">σ</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="main">(</span><span class="free">τ</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_compose_def vars_term_subst<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> subst_domain <span class="free">τ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> range_vars_def subst_domain_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> range_vars_def subst_compose_def subst_domain_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term-subst_simps"><span class="command">lemma</span></span> subst_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst <span class="free">x</span> <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"subst <span class="free">x</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Var"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>

<span class="keyword1" id="Term-subst_subst_domain"><span class="command">lemma</span></span> subst_subst_domain <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_domain <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">t</span> <span class="main">=</span> Var <span class="free">x</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> subst <span class="free">x</span> <span class="free">t</span> <span class="bound">y</span> <span class="main">≠</span> Var <span class="bound">y</span><span class="main">}</span> <span class="main">⟷</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">t</span> <span class="main">=</span> Var <span class="free">x</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_domain_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term-subst_subst_range"><span class="command">lemma</span></span> subst_subst_range <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_range <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">t</span> <span class="main">=</span> Var <span class="free">x</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Var <span class="free">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_domain_def subst_def<span class="main">)</span>

<span class="keyword1" id="Term-subst_apply_left_idemp"><span class="command">lemma</span></span> subst_apply_left_idemp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅</span> subst <span class="free">x</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>

<span class="keyword1" id="Term-subst_compose_left_idemp"><span class="command">lemma</span></span> subst_compose_left_idemp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst_term_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1" id="Term-subst_ident"><span class="command">lemma</span></span> subst_ident <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars_term <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> subst <span class="free">x</span> <span class="free">u</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> subst <span class="free">x</span> <span class="free">u</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> Var"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> term_subst_eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms subst_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term-subst_self_idemp"><span class="command">lemma</span></span> subst_self_idemp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars_term <span class="free">t</span> <span class="main">⟹</span> subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> subst <span class="free">x</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subst_compose_left_idemp subst_ident<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> terms <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term set"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Applying a substitution to every term of a given set.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">subst_apply_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> terms <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> terms"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>t</sub></span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1"><span class="free">⋅<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Composition of substitutions›</span></span>
<span class="keyword1" id="Term-subst_compose"><span class="command">lemma</span></span> subst_compose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">σ</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_compose_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> subst_subst <span class="main">=</span> subst_subst_compose <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1" id="Term-subst_domain_Var"><span class="command">lemma</span></span> subst_domain_Var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_domain Var <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_domain_def<span class="main">)</span>

<span class="keyword1" id="Term-subst_apply_eq_Var"><span class="command">lemma</span></span> subst_apply_eq_Var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> Var <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> Var <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">y</span> <span class="main">=</span> Var <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-subst_domain_subst_compose"><span class="command">lemma</span></span> subst_domain_subst_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_domain <span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>subst_domain <span class="free">σ</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> Var <span class="bound">y</span> <span class="main">∧</span> <span class="free">τ</span> <span class="bound">y</span> <span class="main">=</span> Var <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span>
    <span class="main">(</span>subst_domain <span class="free">τ</span> <span class="main">-</span> subst_domain <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_domain_def subst_compose_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> subst_apply_eq_Var<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A substitution is idempotent iff the variables in its range are disjoint from its domain.
  (See also "Term Rewriting and All That" \cite[Lemma 4.5.7]{AllThat}.)›</span></span>
<span class="keyword1" id="Term-subst_idemp_iff"><span class="command">lemma</span></span> subst_idemp_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">⟷</span> subst_domain <span class="free">σ</span> <span class="main">∩</span> range_vars <span class="free">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">⋅</span> Var"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> subst_compose_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>vars_term <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">y</span> <span class="main">=</span> Var <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> term_subst_eq_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">x</span> <span class="main">≠</span> Var <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="main">(</span><span class="free">σ</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="free">σ</span> <span class="main">∩</span> range_vars <span class="free">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_domain_def range_vars_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="free">σ</span> <span class="main">∩</span> range_vars <span class="free">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> Var <span class="bound">x</span> <span class="main">∨</span> <span class="free">σ</span> <span class="bound">y</span> <span class="main">=</span> Var <span class="bound">y</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∉</span> vars_term <span class="main">(</span><span class="free">σ</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_domain_def range_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>vars_term <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">y</span> <span class="main">=</span> Var <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> vars_term <span class="main">(</span><span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">y</span> <span class="main">=</span> Var <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_compose_def term_subst_eq_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">num_funs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">num_funs</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">num_funs</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>sum_list <span class="main">(</span>map <span class="free">num_funs</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term-num_funs_0"><span class="command">lemma</span></span> num_funs_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"num_funs <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Var <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-num_funs_subst"><span class="command">lemma</span></span> num_funs_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"num_funs <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">≥</span> num_funs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> comp_apply sum_list_mono<span class="main">)</span>

<span class="keyword1" id="Term-sum_list_map_num_funs_subst"><span class="command">lemma</span></span> sum_list_map_num_funs_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="main">(</span>num_funs <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map num_funs <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ts</span><span class="main">.</span> num_funs <span class="main">(</span><span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> num_funs <span class="main">(</span><span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_funs <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="main">(</span>num_funs <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="main">=</span> num_funs <span class="skolem">t</span> <span class="main">+</span> sum_list <span class="main">(</span>map num_funs <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_funs <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">≥</span> num_funs <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> num_funs_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="main">(</span>num_funs <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">≥</span> sum_list <span class="main">(</span>map num_funs <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> num_funs_subst <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-is_Fun_num_funs_less"><span class="command">lemma</span></span> is_Fun_num_funs_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> vars_term <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_Fun <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"num_funs <span class="main">(</span><span class="free">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> num_funs <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> vars_term <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_funs <span class="main">(</span><span class="skolem">u</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">≤</span> sum_list <span class="main">(</span>map <span class="main">(</span>num_funs <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> member_le_sum_list<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_funs <span class="main">(</span><span class="free">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> num_funs <span class="main">(</span><span class="skolem">u</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Fun.hyps <span class="main">[</span><span class="operator">OF</span> u<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> u  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-finite_subst_domain_subst"><span class="command">lemma</span></span> finite_subst_domain_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>subst_domain <span class="main">(</span>subst <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-subst_domain_compose"><span class="command">lemma</span></span> subst_domain_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_domain <span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> subst_domain <span class="free">σ</span> <span class="main">∪</span> subst_domain <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_domain_def subst_compose_def<span class="main">)</span>

<span class="keyword1" id="Term-vars_term_disjoint_imp_unifier"><span class="command">lemma</span></span> vars_term_disjoint_imp_unifier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vars_term <span class="free">s</span> <span class="main">∩</span> vars_term <span class="free">t</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">μ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst<span class="main">.</span> <span class="free">s</span> <span class="main">⋅</span> <span class="bound">μ</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="bound">μ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?μ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> vars_term <span class="free">s</span> <span class="keyword1">then</span> <span class="free">σ</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">τ</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋅</span> <span class="var">?μ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> term_subst_eq_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">τ</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="var">?μ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> term_subst_eq_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅</span> <span class="var">?μ</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="var">?μ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term-vars_term_subset_subst_eq"><span class="command">lemma</span></span> vars_term_subset_subst_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vars_term <span class="free">t</span> <span class="main">⊆</span> vars_term <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Term_Pair_Multiset">
<div class="head">
<h1>Theory Term_Pair_Multiset</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multisets of Pairs of Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Term_Pair_Multiset
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Term.html">Term</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Multisets of pairs of terms are used in abstract inference systems for
matching and unification.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Size›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Make sure that every pair has size at least <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span>nat"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair_size</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> size <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">+</span> size <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Compute the number of symbols in a multiset of term pairs.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">size_mset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> fold_mset <span class="main">(</span><span class="main">(+)</span> <span class="main">∘</span> pair_size<span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> size_mset_fun<span class="main">:</span>
  comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">(+)</span> <span class="main">∘</span> pair_size"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Pair_Multiset-fold_pair_size_plus"><span class="command">lemma</span></span> fold_pair_size_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold_mset <span class="main">(</span><span class="main">(+)</span> <span class="main">∘</span> pair_size<span class="main">)</span> <span class="main">0</span> <span class="free">M</span> <span class="main">+</span> <span class="free">n</span> <span class="main">=</span> fold_mset <span class="main">(</span><span class="main">(+)</span> <span class="main">∘</span> pair_size<span class="main">)</span> <span class="free">n</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_mset_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term_Pair_Multiset-size_mset_union"><span class="command">lemma</span></span> size_mset_union <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_mset <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> size_mset <span class="free">N</span> <span class="main">+</span> size_mset <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_mset_def fold_pair_size_plus<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-size_mset_add_mset"><span class="command">lemma</span></span> size_mset_add_mset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_mset <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> pair_size <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>size_mset <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_mset_def<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-nonempty_size_mset"><span class="command">lemma</span></span> nonempty_size_mset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size_mset <span class="free">M</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_mset_def pair_size_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term_Pair_Multiset-size_mset_singleton"><span class="command">lemma</span></span> size_mset_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_mset <span class="main">{#</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">#}</span> <span class="main">=</span> size <span class="free">l</span> <span class="main">+</span> size <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_mset_def pair_size_def<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-size_mset_empty"><span class="command">lemma</span></span> size_mset_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_mset <span class="main">{#}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_mset_def<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-size_mset_set_zip_leq"><span class="command">lemma</span></span> size_mset_set_zip_leq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_mset <span class="main">(</span>mset <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> size_list size <span class="free">ss</span> <span class="main">+</span> size_list size <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_SucI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_size_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Pair_Multiset-size_mset_Fun_less"><span class="command">lemma</span></span> size_mset_Fun_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_mset <span class="main">{#</span><span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">,</span> Fun <span class="free">g</span> <span class="free">ts</span><span class="main">)</span><span class="main">#}</span> <span class="main">&gt;</span> size_mset <span class="main">(</span>mset <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_size_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_le_less_trans size_mset_set_zip_leq<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-decomp_size_mset_less"><span class="command">lemma</span></span> decomp_size_mset_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size_mset <span class="main">(</span><span class="free">M</span> <span class="main">+</span> mset <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> size_mset <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">,</span> Fun <span class="free">f</span> <span class="free">ts</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> size_mset_Fun_less <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Substitutions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Applying a substitution to a multiset of term pairs.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_mset</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> snd <span class="bound">p</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>
<span class="keyword1" id="Term_Pair_Multiset-subst_mset_empty"><span class="command">lemma</span></span> subst_mset_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_mset <span class="free">σ</span> <span class="main">{#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_mset_def<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-subst_mset_union"><span class="command">lemma</span></span> subst_mset_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_mset <span class="free">σ</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> subst_mset <span class="free">σ</span> <span class="free">M</span> <span class="main">+</span> subst_mset <span class="free">σ</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_mset_def<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-subst_mset_Var"><span class="command">lemma</span></span> subst_mset_Var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_mset Var <span class="free">M</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_mset_def<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-subst_mset_subst_compose"><span class="command">lemma</span></span> subst_mset_subst_compose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_mset <span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span> <span class="free">M</span> <span class="main">=</span> subst_mset <span class="free">τ</span> <span class="main">(</span>subst_mset <span class="free">σ</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_mset_def image_mset.compositionality o_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Variables›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Compute the set of variables occurring in a multiset of term pairs.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vars_mset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set_mset <span class="main">(</span>image_mset <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> vars_term <span class="main">(</span>fst <span class="bound">r</span><span class="main">)</span> <span class="main">∪</span> vars_term <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Pair_Multiset-vars_mset_singleton"><span class="command">lemma</span></span> vars_mset_singleton <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_mset <span class="main">{#</span><span class="free">p</span><span class="main">#}</span> <span class="main">=</span> vars_term <span class="main">(</span>fst <span class="free">p</span><span class="main">)</span> <span class="main">∪</span> vars_term <span class="main">(</span>snd <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mset_def<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-vars_mset_union"><span class="command">lemma</span></span> vars_mset_union <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> vars_mset <span class="free">A</span> <span class="main">∪</span> vars_mset <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mset_def<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-vars_mset_add_mset"><span class="command">lemma</span></span> vars_mset_add_mset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> vars_term <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">∪</span> vars_term <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">∪</span> vars_mset <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mset_def<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-vars_mset_set_zip"><span class="command">lemma</span></span> vars_mset_set_zip <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>mset <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span><span class="main">.</span> vars_term <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mset_def<span class="main">)</span>

<span class="keyword1" id="Term_Pair_Multiset-not_in_vars_mset_subst_mset"><span class="command">lemma</span></span> not_in_vars_mset_subst_mset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars_term <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars_mset <span class="main">(</span>subst_mset <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mset_def subst_mset_def vars_term_subst subst_def<span class="main">)</span>
<span class="keyword1" id="Term_Pair_Multiset-vars_mset_subst_mset_subset"><span class="command">lemma</span></span> vars_mset_subst_mset_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>subst_mset <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="main">⊆</span> vars_mset <span class="free">M</span> <span class="main">∪</span> vars_term <span class="free">t</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> vars_term <span class="main">(</span><span class="skolem">u</span> <span class="main">⋅</span> subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">∪</span> vars_term <span class="main">(</span><span class="skolem">v</span> <span class="main">⋅</span> subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mset_def subst_mset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> vars_term <span class="skolem">u</span> <span class="main">∪</span> vars_term <span class="skolem">v</span> <span class="main">∪</span> vars_term <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vars_term_subst subst_def fun_upd_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> empty_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Pair_Multiset-Var_left_vars_mset_less"><span class="command">lemma</span></span> Var_left_vars_mset_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars_term <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>subst_mset <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="main">⊂</span> vars_mset <span class="main">(</span>add_mset <span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊂</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vars_mset_subst_mset_subset <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">≠</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Pair_Multiset-Var_right_vars_mset_less"><span class="command">lemma</span></span> Var_right_vars_mset_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars_term <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>subst_mset <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="main">⊂</span> vars_mset <span class="main">(</span>add_mset <span class="main">(</span><span class="free">t</span><span class="main">,</span> Var <span class="free">x</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Var_left_vars_mset_less <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Pair_Multiset-mem_vars_mset_subst_mset"><span class="command">lemma</span></span> mem_vars_mset_subst_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> vars_mset <span class="main">(</span>subst_mset <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> vars_term <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> vars_mset <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vars_mset_subst_mset_subset <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Term_Pair_Multiset-finite_vars_mset"><span class="command">lemma</span></span> finite_vars_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>vars_mset <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vars_mset_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Abstract_Matching">
<div class="head">
<h1>Theory Abstract_Matching</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Matching›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abstract_Matching
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Term_Pair_Multiset.html">Term_Pair_Multiset</a>
    <span class="quoted">"<a href="../Abstract-Rewriting/Abstract_Rewriting.html">Abstract-Rewriting.Abstract_Rewriting</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*FIXME: move(?)*)</span>
<span class="keyword1" id="Abstract_Matching-singleton_eq_union_iff"><span class="command">lemma</span></span> singleton_eq_union_iff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multi_self_add_other_not_self single_eq_single single_is_union<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Turning functional maps into substitutions.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_of_map</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
  <span class="main">|</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Abstract_Matching-size_mset_mset_less"><span class="command">lemma</span></span> size_mset_mset_less <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size_mset <span class="main">(</span>mset <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">3</span> <span class="main">+</span> <span class="main">(</span>size_list size <span class="free">ss</span> <span class="main">+</span> size_list size <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_size_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matchers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">matchers</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> snd <span class="bound">e</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Abstract_Matching-matchers_vars_term_eq"><span class="command">lemma</span></span> matchers_vars_term_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> matchers <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">∈</span> matchers <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>vars_term <span class="free">s</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">τ</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> term_subst_eq_conv <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchers_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-matchers_empty"><span class="command">lemma</span></span> matchers_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"matchers <span class="main">{}</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matchers_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-matchers_insert"><span class="command">lemma</span></span> matchers_insert <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"matchers <span class="main">(</span>insert <span class="free">e</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> fst <span class="free">e</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> snd <span class="free">e</span><span class="main">}</span> <span class="main">∩</span> matchers <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchers_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-matchers_Un"><span class="command">lemma</span></span> matchers_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"matchers <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">P'</span><span class="main">)</span> <span class="main">=</span> matchers <span class="free">P</span> <span class="main">∩</span> matchers <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchers_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-matchers_set_zip"><span class="command">lemma</span></span> matchers_set_zip <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchers <span class="main">(</span>set <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="bound">σ</span><span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">ts</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchers_map</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> matchers <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">,</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> Map.dom <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Abstract_Matching-matchers_map_empty"><span class="command">lemma</span></span> matchers_map_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"matchers_map Map.empty <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matchers_map_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-matchers_map_upd"><span class="command">lemma</span></span> matchers_map_upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> Some <span class="free">t</span> <span class="keyword1">else</span> <span class="free">σ</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span>
    matchers_map <span class="free">σ</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊇</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchers_map_def matchers_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchers_map_def matchers_def dom_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Matching-matchers_map_upd'"><span class="command">lemma</span></span> matchers_map_upd' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="main">(</span><span class="free">σ</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> matchers_map <span class="free">σ</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> matchers_map_upd <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matchers_map_def matchers_def dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">MATCH1</span> <span class="keyword2"><span class="keyword">where</span></span>
  Var <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span>
    <span class="free">MATCH1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Fun <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟹</span>
    <span class="free">MATCH1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">,</span> Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">+</span> mset <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1" id="Abstract_Matching-MATCH1_matchers"><span class="command">lemma</span></span> MATCH1_matchers <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"MATCH1 <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    matchers_map <span class="main">(</span>snd <span class="free">y</span><span class="main">)</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchrel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> MATCH1 <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Abstract_Matching-MATCH1_matchrel_conv"><span class="command">lemma</span></span> MATCH1_matchrel_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"MATCH1 <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> matchrel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matchrel_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-matchrel_rtrancl_matchers"><span class="command">lemma</span></span> matchrel_rtrancl_matchers <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    matchers_map <span class="main">(</span>snd <span class="free">y</span><span class="main">)</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matchrel_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-subst_of_map_in_matchers_map"><span class="command">lemma</span></span> subst_of_map_in_matchers_map <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_of_map <span class="free">d</span> <span class="free">m</span> <span class="main">∈</span> matchers_map <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_of_map_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> matchers_map_def matchers_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-matchrel_sound"><span class="command">lemma</span></span> matchrel_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_of_map <span class="free">d</span> <span class="free">σ</span> <span class="main">∈</span> matchers <span class="main">(</span>set_mset <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> matchrel_rtrancl_matchers <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Matching-MATCH1_size_mset"><span class="command">lemma</span></span> MATCH1_size_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"MATCH1 <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size_mset <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> size_mset <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_size_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchless</span> <span class="main">=</span> inv_image <span class="main">(</span>measure size_mset<span class="main">)</span> fst"</span></span>

<span class="keyword1" id="Abstract_Matching-wf_matchless"><span class="command">lemma</span></span> wf_matchless<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf matchless"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchless_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-MATCH1_matchless"><span class="command">lemma</span></span> MATCH1_matchless<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"MATCH1 <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> matchless"</span></span>
  <span class="keyword1"><span class="command">using</span></span> MATCH1_size_mset <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matchless_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-converse_matchrel_subset_matchless"><span class="command">lemma</span></span> converse_matchrel_subset_matchless<span class="main">:</span>
  <span class="quoted"><span class="quoted">"matchrel<span class="main">¯</span> <span class="main">⊆</span> matchless"</span></span>
  <span class="keyword1"><span class="command">using</span></span> MATCH1_matchless <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchrel_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-wf_converse_matchrel"><span class="command">lemma</span></span> wf_converse_matchrel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="main">(</span>matchrel<span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset <span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_matchless converse_matchrel_subset_matchless<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-MATCH1_singleton_Var"><span class="command">lemma</span></span> MATCH1_singleton_Var <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> None <span class="main">⟹</span> MATCH1 <span class="main">(</span><span class="main">{#</span><span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="free">σ</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">t</span> <span class="main">⟹</span> MATCH1 <span class="main">(</span><span class="main">{#</span><span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="free">σ</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> MATCH1.Var <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Abstract_Matching-MATCH1_singleton_Fun"><span class="command">lemma</span></span> MATCH1_singleton_Fun <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span> <span class="main">⟹</span> MATCH1 <span class="main">(</span><span class="main">{#</span><span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">,</span> Fun <span class="free">f</span> <span class="free">ts</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>mset <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> MATCH1.Fun <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Matching-not_MATCH1_singleton_Var"><span class="command">lemma</span></span> not_MATCH1_singleton_Var <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> MATCH1 <span class="main">(</span><span class="main">{#</span><span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="free">σ</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="free">x</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="free">σ</span> <span class="free">x</span> <span class="main">≠</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Abstract_Matching-not_matchrelD"><span class="command">lemma</span></span> not_matchrelD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">{#</span><span class="free">e</span><span class="main">#}</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">ss</span> <span class="bound">x</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span>Fun <span class="bound">f</span> <span class="bound">ss</span><span class="main">,</span> Var <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">t</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">≠</span> Some <span class="bound">t</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">ss</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span>Fun <span class="bound">f</span> <span class="bound">ss</span><span class="main">,</span> Fun <span class="bound">g</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">f</span> <span class="main">≠</span> <span class="bound">g</span> <span class="main">∨</span> length <span class="bound">ss</span> <span class="main">≠</span> length <span class="bound">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchrel_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Matching-ne_matchers_imp_matchrel"><span class="command">lemma</span></span> ne_matchers_imp_matchrel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="free">σ</span> <span class="main">∩</span> matchers <span class="main">{</span><span class="free">e</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">{#</span><span class="free">e</span><span class="main">#}</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> matchrel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> not_matchrelD <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchers_map_def matchers_def dom_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Matching-MATCH1_mono"><span class="command">lemma</span></span> MATCH1_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"MATCH1 <span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">P'</span><span class="main">,</span> <span class="free">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"MATCH1 <span class="main">(</span><span class="free">P</span> <span class="main">+</span> <span class="free">M</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="free">P'</span> <span class="main">+</span> <span class="free">M</span><span class="main">,</span> <span class="free">σ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Var <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">using</span></span> Var <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">using</span></span> Fun
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.assoc add_mset_add_single<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-matchrel_mono"><span class="command">lemma</span></span> matchrel_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> matchrel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">+</span> <span class="free">M</span><span class="main">,</span> snd <span class="free">x</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">+</span> <span class="free">M</span><span class="main">,</span> snd <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> MATCH1_mono <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MATCH1_matchrel_conv<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-matchrel_rtrancl_mono"><span class="command">lemma</span></span> matchrel_rtrancl_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">+</span> <span class="free">M</span><span class="main">,</span> snd <span class="free">x</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">+</span> <span class="free">M</span><span class="main">,</span> snd <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  matchrel_mono <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">M</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-ne_matchers_imp_empty_or_matchrel"><span class="command">lemma</span></span> ne_matchers_imp_empty_or_matchrel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="free">σ</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="free">P</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">e</span> <span class="skolem">P'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="skolem">P'</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">e</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="free">σ</span> <span class="main">∩</span> matchers <span class="main">{</span><span class="skolem">e</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ne_matchers_imp_matchrel <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P''</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"MATCH1 <span class="main">(</span><span class="main">{#</span><span class="skolem">e</span><span class="main">#}</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P''</span><span class="main">,</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchrel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MATCH1_mono <span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">P'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MATCH1 <span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P'</span> <span class="main">+</span> <span class="skolem">P''</span><span class="main">,</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchrel_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Matching-matchrel_imp_converse_matchless"><span class="command">lemma</span></span> matchrel_imp_converse_matchless <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> matchrel <span class="main">⟹</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> matchless"</span></span>
  <span class="keyword1"><span class="command">using</span></span> MATCH1_matchless <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchrel_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-ne_matchers_imp_empty"><span class="command">lemma</span></span> ne_matchers_imp_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term<span class="main">)</span> multiset"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="free">σ</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="free">P</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct <span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_measure <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">size_mset</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term<span class="main">)</span> multiset"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">σ</span>
  <span class="keyword3"><span class="command">presume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P'</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">P'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> measure size_mset<span class="main">;</span> matchers_map <span class="bound">σ</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="bound">P'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">P'</span><span class="main">,</span> <span class="bound">σ</span><span class="main">)</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"matchers_map <span class="skolem">σ</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="skolem">P</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">,</span> <span class="main">{#}</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> ne_matchers_imp_empty_or_matchrel <span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">P'</span><span class="main">,</span> <span class="skolem">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P'</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> measure size_mset"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="skolem">σ'</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="skolem">P'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> MATCH1_matchers <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P'</span><span class="main">,</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchrel_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> MATCH1_size_mset<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> IH <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> **
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> converse_rtrancl_into_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Matching-empty_not_reachable_imp_matchers_empty"><span class="command">lemma</span></span> empty_not_reachable_imp_matchers_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="free">σ</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ne_matchers_imp_empty <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Abstract_Matching-irreducible_reachable_imp_matchers_empty"><span class="command">lemma</span></span> irreducible_reachable_imp_matchers_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">y</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="free">σ</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">τ</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span>  <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> NF_not_suc fst_conv normalizability_E<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> empty_not_reachable_imp_matchers_empty
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="main">(</span>snd <span class="free">y</span><span class="main">)</span> <span class="main">∩</span> matchers <span class="main">(</span>set_mset <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> matchrel_rtrancl_matchers <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Matching-matchers_map_not_empty"><span class="command">lemma</span></span> matchers_map_not_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"matchers_map <span class="free">σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">≠</span> matchers_map <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchers_map_def matchers_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Matching-matchers_empty_imp_not_empty_NF"><span class="command">lemma</span></span> matchers_empty_imp_not_empty_NF<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchers <span class="main">(</span>set_mset <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> fst <span class="bound">y</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>!</sup></span> <span class="main">⟹</span> fst <span class="bound">y</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN matchrel"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_converse_matchrel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SN_iff_wf<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SN_imp_WN UNIV_I WN_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> matchrel_rtrancl_matchers <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Unifiers">
<div class="head">
<h1>Theory Unifiers</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Unification›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unifiers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition and properties of (most general) unifiers›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Unifiers
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Term.html">Term</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*TODO: move*)</span>
<span class="keyword1" id="Unifiers-map_eq_set_zipD"><span class="command">lemma</span></span> map_eq_set_zipD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equations <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation set"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of unifiers for a given set of equations.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unifiers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equations <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">unifiers</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> snd <span class="bound">p</span> <span class="main">⋅</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Check whether a set of equations is unifiable.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">unifiable</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> unifiers <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Unifiers-in_unifiersE"><span class="command">lemma</span></span> in_unifiersE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">σ</span> <span class="main">∈</span> unifiers <span class="free">E</span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> fst <span class="bound">e</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> snd <span class="bound">e</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Applying a substitution to a set of equations.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equations <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equations"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">subst_set</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">e</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> snd <span class="bound">e</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Check whether a substitution is a most-general unifier (mgu) of a set of equations.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_mgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equations <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_mgu</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">∈</span> unifiers <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span> <span class="main">∈</span> unifiers <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">γ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">γ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following property characterizes idempotent mgus, that is,
  mgus <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">σ</span></span>›</span></span></span></span> for which <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">σ</span></span> <span class="keyword1"><span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="free">σ</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">σ</span></span>›</span></span></span></span> holds.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_imgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equations <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_imgu</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">∈</span> unifiers <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">τ</span> <span class="main">∈</span> unifiers <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">.</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">τ</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of sets of unifiers›</span></span>

<span class="keyword1" id="Unifiers-unifiers_Un"><span class="command">lemma</span></span> unifiers_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unifiers <span class="main">(</span><span class="free">s</span> <span class="main">∪</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> unifiers <span class="free">s</span> <span class="main">∩</span> unifiers <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def<span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_empty"><span class="command">lemma</span></span> unifiers_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unifiers <span class="main">{}</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def<span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_insert"><span class="command">lemma</span></span> unifiers_insert<span class="main">:</span> <span class="comment1">(* "simp not added for readability (and termination)" *)</span>
  <span class="quoted"><span class="quoted">"unifiers <span class="main">(</span>insert <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> fst <span class="free">p</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> snd <span class="free">p</span> <span class="main">⋅</span> <span class="bound">σ</span><span class="main">}</span> <span class="main">∩</span> unifiers <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def<span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_insert_ident"><span class="command">lemma</span></span> unifiers_insert_ident <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unifiers <span class="main">(</span>insert <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> unifiers <span class="free">E</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_insert<span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_insert_swap"><span class="command">lemma</span></span> unifiers_insert_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unifiers <span class="main">(</span>insert <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> unifiers <span class="main">(</span>insert <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_insert<span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_insert_Var_swap"><span class="command">lemma</span></span> unifiers_insert_Var_swap <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unifiers <span class="main">(</span>insert <span class="main">(</span><span class="free">t</span><span class="main">,</span> Var <span class="free">x</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> unifiers <span class="main">(</span>insert <span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> unifiers_insert_swap<span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_subst_set"><span class="command">lemma</span></span> unifiers_subst_set <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">∈</span> unifiers <span class="main">(</span>subst_set <span class="free">σ</span> <span class="free">E</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span> <span class="main">∈</span> unifiers <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def subst_set_def<span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_insert_VarD"><span class="command">lemma</span></span> unifiers_insert_VarD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> unifiers <span class="main">(</span>insert <span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">⟹</span> subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> unifiers <span class="main">(</span>insert <span class="main">(</span><span class="free">t</span><span class="main">,</span> Var <span class="free">x</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">⟹</span> subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def<span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_insert_Var_left"><span class="command">lemma</span></span> unifiers_insert_Var_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> unifiers <span class="main">(</span>insert <span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">∈</span> unifiers <span class="main">(</span>subst_set <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def subst_set_def<span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_set_zip"><span class="command">lemma</span></span> unifiers_set_zip <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unifiers <span class="main">(</span>set <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="bound">σ</span><span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="bound">σ</span><span class="main">)</span> <span class="free">ts</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def<span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_Fun"><span class="command">lemma</span></span> unifiers_Fun <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> unifiers <span class="main">{</span><span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">,</span> Fun <span class="free">g</span> <span class="free">ts</span><span class="main">)</span><span class="main">}</span> <span class="main">⟷</span>
    length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∧</span> <span class="free">σ</span> <span class="main">∈</span> unifiers <span class="main">(</span>set <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_eq_imp_length_eq<span class="main">)</span>
    <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Unifiers-unifiers_occur_left_is_Fun"><span class="command">lemma</span></span> unifiers_occur_left_is_Fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> vars_term <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_Fun <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unifiers <span class="main">(</span>insert <span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> is_Fun_num_funs_less <span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Unifiers-unifiers_occur_left_not_Var"><span class="command">lemma</span></span> unifiers_occur_left_not_Var<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> vars_term <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Var <span class="free">x</span> <span class="main">⟹</span> unifiers <span class="main">(</span>insert <span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unifiers_occur_left_is_Fun <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Unifiers-unifiers_occur_left_Fun"><span class="command">lemma</span></span> unifiers_occur_left_Fun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> vars_term <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> unifiers <span class="main">(</span>insert <span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> Fun <span class="free">f</span> <span class="free">ts</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unifiers_occur_left_is_Fun <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">f</span> <span class="free">ts</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> unifiers_occur_left_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  unifiers_occur_left_is_Fun
  unifiers_occur_left_not_Var
  unifiers_occur_left_Fun


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of unifiability›</span></span>

<span class="keyword1" id="Unifiers-in_vars_is_Fun_not_unifiable"><span class="command">lemma</span></span> in_vars_is_Fun_not_unifiable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> vars_term <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_Fun <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">{</span><span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">{</span><span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> unifiers <span class="main">{</span><span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_funs <span class="main">(</span><span class="skolem">σ</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> num_funs <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_Fun_num_funs_less <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Unifiers-unifiable_insert_swap"><span class="command">lemma</span></span> unifiable_insert_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>insert <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> unifiable <span class="main">(</span>insert <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def unifiers_insert_swap<span class="main">)</span>

<span class="keyword1" id="Unifiers-subst_set_reflects_unifiable"><span class="command">lemma</span></span> subst_set_reflects_unifiable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>subst_set <span class="free">σ</span> <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="free">E</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">τ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">E</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">τ</span> <span class="main">=</span> snd <span class="bound">p</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst<span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">E</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> snd <span class="bound">p</span> <span class="main">⋅</span> <span class="bound">σ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">σ</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">τ</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def unifiers_def subst_set_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹is_mgu›</span></span></span></span>›</span></span>

<span class="keyword1" id="Unifiers-is_mgu_empty"><span class="command">lemma</span></span> is_mgu_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_mgu Var <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_mgu_def<span class="main">)</span>

<span class="keyword1" id="Unifiers-is_mgu_insert_trivial"><span class="command">lemma</span></span> is_mgu_insert_trivial <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_mgu <span class="free">σ</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> is_mgu <span class="free">σ</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_mgu_def<span class="main">)</span>

<span class="keyword1" id="Unifiers-is_mgu_insert_decomp"><span class="command">lemma</span></span> is_mgu_insert_decomp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_mgu <span class="free">σ</span> <span class="main">(</span>insert <span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">,</span> Fun <span class="free">f</span> <span class="free">ts</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">⟷</span>
    is_mgu <span class="free">σ</span> <span class="main">(</span><span class="free">E</span> <span class="main">∪</span> set <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_mgu_def unifiers_insert<span class="main">)</span>

<span class="keyword1" id="Unifiers-is_mgu_insert_swap"><span class="command">lemma</span></span> is_mgu_insert_swap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_mgu <span class="free">σ</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> is_mgu <span class="free">σ</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_mgu_def unifiers_def<span class="main">)</span>

<span class="keyword1" id="Unifiers-is_mgu_insert_Var_swap"><span class="command">lemma</span></span> is_mgu_insert_Var_swap <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_mgu <span class="free">σ</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">t</span><span class="main">,</span> Var <span class="free">x</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> is_mgu <span class="free">σ</span> <span class="main">(</span>insert <span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_mgu_insert_swap<span class="main">)</span>

<span class="keyword1" id="Unifiers-is_mgu_subst_set_subst"><span class="command">lemma</span></span> is_mgu_subst_set_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars_term <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_mgu <span class="free">σ</span> <span class="main">(</span>subst_set <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"is_mgu <span class="free">σ</span> <span class="var">?E</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_mgu <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"is_mgu <span class="var">?σ</span> <span class="var">?E'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹is_mgu <span class="free">σ</span> <span class="var">?E</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?σ</span> <span class="main">∈</span> unifiers <span class="free">E</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∈</span> unifiers <span class="free">E</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">μ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_mgu_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?σ</span> <span class="main">∈</span> unifiers <span class="var">?E'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unifiers_insert subst_compose<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">τ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">∈</span> unifiers <span class="var">?E'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">μ</span><span class="main">.</span> <span class="bound">τ</span> <span class="main">=</span> <span class="var">?σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">μ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">τ</span>
    <span class="keyword3"><span class="command">assume</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> unifiers <span class="var">?E'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> unifiers_insert_VarD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> unifiers_insert_Var_left <span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">τ</span> <span class="main">∈</span> unifiers <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">τ</span> <span class="main">=</span> subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">μ</span><span class="main">.</span> <span class="skolem">τ</span> <span class="main">=</span> subst <span class="free">x</span> <span class="free">t</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">μ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_mgu <span class="var">?σ</span> <span class="var">?E'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_mgu_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Unifiers-is_imgu_imp_is_mgu"><span class="command">lemma</span></span> is_imgu_imp_is_mgu<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_imgu <span class="free">σ</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_mgu <span class="free">σ</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_imgu_def is_mgu_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abstract_Unification">
<div class="head">
<h1>Theory Abstract_Unification</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract Unification›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We formalize an inference system for unification.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abstract_Unification
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Unifiers.html">Unifiers</a>
    <a href="Term_Pair_Multiset.html">Term_Pair_Multiset</a>
    <span class="quoted">"<a href="../Abstract-Rewriting/Abstract_Rewriting.html">Abstract-Rewriting.Abstract_Rewriting</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*TODO: move*)</span>
<span class="keyword1" id="Abstract_Unification-foldr_assoc"><span class="command">lemma</span></span> foldr_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="free">b</span> <span class="main">(</span><span class="free">b</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span> <span class="bound">h</span> <span class="main">=</span> <span class="free">b</span> <span class="bound">f</span> <span class="main">(</span><span class="free">b</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldr <span class="free">b</span> <span class="free">xs</span> <span class="main">(</span><span class="free">b</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span> <span class="main">(</span>foldr <span class="free">b</span> <span class="free">xs</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="comment1">(*TODO: move*)</span>
<span class="keyword1" id="Abstract_Unification-union_commutes"><span class="command">lemma</span></span> union_commutes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">+</span> <span class="free">N</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="free">N</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">+</span> mset <span class="free">xs</span> <span class="main">+</span> <span class="free">N</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="free">N</span> <span class="main">+</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Inference Rules›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inference rules with explicit substitutions.›</span></span>
<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">UNIF1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation multiset <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  trivial <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">UNIF1</span> Var <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span>"</span></span> <span class="main">|</span>
  decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">UNIF1</span> Var <span class="main">(</span>add_mset <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">,</span> Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">+</span> mset <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Var_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> vars_term <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">UNIF1</span> <span class="main">(</span>subst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>add_mset <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="main">(</span>subst_mset <span class="main">(</span>subst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Var_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> vars_term <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">UNIF1</span> <span class="main">(</span>subst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="main">(</span>subst_mset <span class="main">(</span>subst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relation version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> UNIF1<span class="antiquote"><span class="antiquote">}</span></span></span></span> with implicit substitutions.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">unif</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> UNIF1 <span class="bound">σ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Abstract_Unification-unif_UNIF1_conv"><span class="command">lemma</span></span> unif_UNIF1_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> UNIF1 <span class="bound">σ</span> <span class="free">E</span> <span class="free">E'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-UNIF1_unifD"><span class="command">lemma</span></span> UNIF1_unifD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"UNIF1 <span class="free">σ</span> <span class="free">E</span> <span class="free">E'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A termination order for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> UNIF1<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unifless</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation multiset <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation multiset<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unifless</span> <span class="main">=</span> inv_image <span class="main">(</span>finite_psubset <span class="keyword1">&lt;*lex*&gt;</span> measure size_mset<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>vars_mset <span class="bound">x</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Abstract_Unification-wf_unifless"><span class="command">lemma</span></span> wf_unifless<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf unifless"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifless_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-UNIF1_vars_mset_leq"><span class="command">lemma</span></span> UNIF1_vars_mset_leq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="free">σ</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vars_mset <span class="free">E'</span> <span class="main">⊆</span> vars_mset <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mem_vars_mset_subst_mset<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-vars_mset_subset_size_mset_uniflessI"><span class="command">lemma</span></span> vars_mset_subset_size_mset_uniflessI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_mset <span class="free">M</span> <span class="main">⊆</span> vars_mset <span class="free">N</span> <span class="main">⟹</span> size_mset <span class="free">M</span> <span class="main">&lt;</span> size_mset <span class="free">N</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> unifless"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifless_def finite_vars_mset<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-vars_mset_psubset_uniflessI"><span class="command">lemma</span></span> vars_mset_psubset_uniflessI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_mset <span class="free">M</span> <span class="main">⊂</span> vars_mset <span class="free">N</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> unifless"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifless_def finite_vars_mset<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-UNIF1_unifless"><span class="command">lemma</span></span> UNIF1_unifless<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="free">σ</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E'</span><span class="main">,</span> <span class="free">E</span><span class="main">)</span> <span class="main">∈</span> unifless"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars_mset <span class="free">E'</span> <span class="main">⊆</span> vars_mset <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> UNIF1_vars_mset_leq <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">cases</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_size_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Var_left_vars_mset_less Var_right_vars_mset_less<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vars_mset_subset_size_mset_uniflessI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> size_mset_Fun_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Unification-converse_unif_subset_unifless"><span class="command">lemma</span></span> converse_unif_subset_unifless<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unif<span class="main">¯</span> <span class="main">⊆</span> unifless"</span></span>
  <span class="keyword1"><span class="command">using</span></span> UNIF1_unifless <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Termination of the Inference Rules›</span></span>

<span class="keyword1" id="Abstract_Unification-wf_converse_unif"><span class="command">lemma</span></span> wf_converse_unif<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="main">(</span>unif<span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset <span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_unifless converse_unif_subset_unifless<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexive and transitive closure of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> UNIF1<span class="antiquote"><span class="antiquote">}</span></span></span></span> collecting substitutions
produced by single steps.›</span></span>
<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">UNIF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation multiset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation multiset <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  empty <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">UNIF</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span>"</span></span> <span class="main">|</span>
  step <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"UNIF1 <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">E'</span></span></span> <span class="main">⟹</span> <span class="free">UNIF</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">E'</span></span></span> <span class="free"><span class="bound"><span class="entity">E''</span></span></span> <span class="main">⟹</span> <span class="free">UNIF</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">E''</span></span></span>"</span></span>

<span class="keyword1" id="Abstract_Unification-unif_rtrancl_UNIF_conv"><span class="command">lemma</span></span> unif_rtrancl_UNIF_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ss</span><span class="main">.</span> UNIF <span class="bound">ss</span> <span class="free">E</span> <span class="free">E'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ss</span><span class="main">.</span> UNIF <span class="bound">ss</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_UNIF1_conv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ss</span><span class="main">.</span> UNIF <span class="bound">ss</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="skolem">ss</span> <span class="free">E</span> <span class="free">E'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> UNIF1_unifD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Compose a list of substitutions.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">compose</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> List.foldr <span class="keyword1">(∘<span class="hidden">⇩</span><sub>s</sub>)</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> Var"</span></span>

<span class="keyword1" id="Abstract_Unification-compose_simps"><span class="command">lemma</span></span> compose_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"compose <span class="main">[]</span> <span class="main">=</span> Var"</span></span>
  <span class="quoted"><span class="quoted">"compose <span class="main">(</span>Var <span class="main">#</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> compose <span class="free">ss</span>"</span></span>
  <span class="quoted"><span class="quoted">"compose <span class="main">(</span><span class="free">σ</span> <span class="main">#</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> compose <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compose_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-compose_append"><span class="command">lemma</span></span> compose_append <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"compose <span class="main">(</span><span class="free">ss</span> <span class="main">@</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> compose <span class="free">ss</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> compose <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldr_assoc <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(∘<span class="hidden">⇩</span><sub>s</sub>)</span>"</span></span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted">Var</span> <span class="quoted"><span class="quoted">"foldr <span class="keyword1">(∘<span class="hidden">⇩</span><sub>s</sub>)</span> <span class="free">ts</span> Var"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compose_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-set_mset_subst_mset"><span class="command">lemma</span></span> set_mset_subst_mset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>subst_mset <span class="free">σ</span> <span class="free">E</span><span class="main">)</span> <span class="main">=</span> subst_set <span class="free">σ</span> <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_set_def subst_mset_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-UNIF1_subst_domain_Int"><span class="command">lemma</span></span> UNIF1_subst_domain_Int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="free">σ</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="free">σ</span> <span class="main">∩</span> vars_mset <span class="free">E'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Abstract_Unification-UNIF1_subst_domain_subset"><span class="command">lemma</span></span> UNIF1_subst_domain_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="free">σ</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="free">σ</span> <span class="main">⊆</span> vars_mset <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Abstract_Unification-UNIF_subst_domain_subset"><span class="command">lemma</span></span> UNIF_subst_domain_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="free">ss</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="main">(</span>compose <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> vars_mset <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> UNIF1_subst_domain_subset UNIF1_vars_mset_leq <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_domain_subst_compose<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-UNIF1_range_vars_subset"><span class="command">lemma</span></span> UNIF1_range_vars_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="free">σ</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"range_vars <span class="free">σ</span> <span class="main">⊆</span> vars_mset <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> range_vars_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-UNIF1_subst_domain_range_vars_Int"><span class="command">lemma</span></span> UNIF1_subst_domain_range_vars_Int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="free">σ</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="free">σ</span> <span class="main">∩</span> range_vars <span class="free">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Abstract_Unification-UNIF_range_vars_subset"><span class="command">lemma</span></span> UNIF_range_vars_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="free">ss</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"range_vars <span class="main">(</span>compose <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> vars_mset <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> UNIF1_range_vars_subset UNIF1_vars_mset_leq
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> range_vars_subst_compose_subset <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-UNIF_subst_domain_range_vars_Int"><span class="command">lemma</span></span> UNIF_subst_domain_range_vars_Int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="free">ss</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="main">(</span>compose <span class="free">ss</span><span class="main">)</span> <span class="main">∩</span> range_vars <span class="main">(</span>compose <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">σ</span> <span class="skolem">E</span> <span class="skolem">E'</span> <span class="skolem">ss</span> <span class="skolem">E''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> UNIF1_subst_domain_Int <span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> UNIF_subst_domain_subset <span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> UNIF1_subst_domain_range_vars_Int <span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> UNIF_range_vars_subset <span class="main">[</span><span class="operator">OF</span> step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="skolem">σ</span> <span class="main">∩</span> range_vars <span class="skolem">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="main">(</span>compose <span class="skolem">ss</span><span class="main">)</span> <span class="main">∩</span> subst_domain <span class="skolem">σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="skolem">σ</span> <span class="main">∩</span> range_vars <span class="main">(</span>compose <span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst_domain <span class="skolem">σ</span> <span class="main">∪</span> subst_domain <span class="main">(</span>compose <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span>
    <span class="main">(</span><span class="main">(</span>range_vars <span class="skolem">σ</span> <span class="main">-</span> subst_domain <span class="main">(</span>compose <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> range_vars <span class="main">(</span>compose <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_domain_subst_compose <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="quoted">"compose <span class="skolem">ss</span>"</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> range_vars_subst_compose_subset <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="quoted">"compose <span class="skolem">ss</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The inference rules generate idempotent substitutions.›</span></span>
<span class="keyword1" id="Abstract_Unification-UNIF_idemp"><span class="command">lemma</span></span> UNIF_idemp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="free">ss</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compose <span class="free">ss</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> compose <span class="free">ss</span> <span class="main">=</span> compose <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> UNIF_subst_domain_range_vars_Int <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> subst_idemp_iff<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-UNIF1_mono"><span class="command">lemma</span></span> UNIF1_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="free">σ</span> <span class="free">E</span> <span class="free">E'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="free">σ</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="free">E'</span> <span class="main">+</span> subst_mset <span class="free">σ</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UNIF1.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_commutes subst_mset_union <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-unif_mono"><span class="command">lemma</span></span> unif_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="free">M</span><span class="main">,</span> <span class="free">E'</span> <span class="main">+</span> subst_mset <span class="bound">σ</span> <span class="free">M</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_UNIF1_conv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UNIF1_mono<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-unif_rtrancl_mono"><span class="command">lemma</span></span> unif_rtrancl_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="free">M</span><span class="main">,</span> <span class="free">E'</span> <span class="main">+</span> subst_mset <span class="bound">σ</span> <span class="free">M</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E'</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">,</span> <span class="free">E'</span> <span class="main">+</span> subst_mset Var <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">E</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">E</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">F</span> <span class="main">+</span> subst_mset <span class="skolem">σ</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unif_mono <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">E</span><span class="main">,</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">∈</span> unif›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">F</span> <span class="main">+</span> subst_mset <span class="skolem">σ</span> <span class="skolem">M</span><span class="main">,</span> <span class="free">E'</span> <span class="main">+</span> subst_mset <span class="skolem">τ</span> <span class="main">(</span>subst_mset <span class="skolem">σ</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">E</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">,</span> <span class="free">E'</span> <span class="main">+</span> subst_mset <span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness of the Inference Rules›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The inference rules of unification are sound in the sense that
  when the empty set of equations is reached, a most general unifier
  is obtained.›</span></span>
<span class="keyword1" id="Abstract_Unification-UNIF_empty_imp_is_mgu_compose"><span class="command">lemma</span></span> UNIF_empty_imp_is_mgu_compose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation multiset"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="free">ss</span> <span class="free">E</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_mgu <span class="main">(</span>compose <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span><span class="main">::</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation multiset"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">σ</span> <span class="skolem">E</span> <span class="skolem">E'</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_mgu_subst_set_subst<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Completeness of the Inference Rules›</span></span>

<span class="keyword1" id="Abstract_Unification-UNIF1_singleton_decomp"><span class="command">lemma</span></span> UNIF1_singleton_decomp <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"UNIF1 Var <span class="main">{#</span><span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">,</span> Fun <span class="free">f</span> <span class="free">ts</span><span class="main">)</span><span class="main">#}</span> <span class="main">(</span>mset <span class="main">(</span>zip <span class="free">ss</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> UNIF1.decomp <span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Unification-UNIF1_singleton_Var_left"><span class="command">lemma</span></span> UNIF1_singleton_Var_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars_term <span class="free">t</span> <span class="main">⟹</span> UNIF1 <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">{#</span><span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">#}</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> UNIF1.Var_left <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Unification-UNIF1_singleton_Var_right"><span class="command">lemma</span></span> UNIF1_singleton_Var_right <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> vars_term <span class="free">t</span> <span class="main">⟹</span> UNIF1 <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">{#</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> Var <span class="free">x</span><span class="main">)</span><span class="main">#}</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> UNIF1.Var_right <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Unification-not_UNIF1_singleton_Var_right"><span class="command">lemma</span></span> not_UNIF1_singleton_Var_right <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> UNIF1 Var <span class="main">{#</span><span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> Var <span class="free">y</span><span class="main">)</span><span class="main">#}</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> UNIF1 <span class="main">(</span>subst <span class="free">x</span> <span class="main">(</span>Var <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">{#</span><span class="main">(</span>Var <span class="free">x</span><span class="main">,</span> Var <span class="free">y</span><span class="main">)</span><span class="main">#}</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Abstract_Unification-not_unifD"><span class="command">lemma</span></span> not_unifD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">E'</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="free">e</span><span class="main">#}</span><span class="main">,</span> <span class="bound">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">e</span> <span class="main">=</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∨</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> Var <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> vars_term <span class="bound">t</span> <span class="main">∧</span> is_Fun <span class="bound">t</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">ss</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span>Fun <span class="bound">f</span> <span class="bound">ss</span><span class="main">,</span> Fun <span class="bound">g</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">f</span> <span class="main">≠</span> <span class="bound">g</span> <span class="main">∨</span> length <span class="bound">ss</span> <span class="main">≠</span> length <span class="bound">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> term.simps<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">succeed</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Unification-unifiable_imp_unif"><span class="command">lemma</span></span> unifiable_imp_unif<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">E'</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="free">e</span><span class="main">#}</span><span class="main">,</span> <span class="bound">E'</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> not_unifD <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Unification-unifiable_imp_empty_or_unif"><span class="command">lemma</span></span> unifiable_imp_empty_or_unif<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">E'</span><span class="main">.</span> <span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="bound">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">E</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>add <span class="skolem">e</span> <span class="skolem">E'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">{</span><span class="skolem">e</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def unifiers_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> unifiable_imp_unif <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">e</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">E''</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="skolem">σ</span> <span class="main">{#</span><span class="skolem">e</span><span class="main">#}</span> <span class="skolem">E''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_UNIF1_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> UNIF1_mono <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="skolem">σ</span> <span class="free">E</span> <span class="main">(</span><span class="skolem">E''</span> <span class="main">+</span> subst_mset <span class="skolem">σ</span> <span class="skolem">E'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_UNIF1_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Unification-UNIF1_preserves_unifiers"><span class="command">lemma</span></span> UNIF1_preserves_unifiers<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"UNIF1 <span class="free">σ</span> <span class="free">E</span> <span class="free">E'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">∈</span> unifiers <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> unifiers <span class="main">(</span>set_mset <span class="free">E'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiers_def subst_mset_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-unif_preserves_unifiable"><span class="command">lemma</span></span> unif_preserves_unifiable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set_mset <span class="free">E'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> UNIF1_preserves_unifiers <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">E'</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_UNIF1_conv unifiable_def<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-unif_imp_converse_unifless"><span class="command">lemma</span></span> unif_imp_converse_unifless <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> unif <span class="main">⟹</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> unifless"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIF1_unifless unif_UNIF1_conv<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every unifiable set of equations can be reduced to the empty
  set by applying the inference rules of unification.›</span></span>

<span class="keyword1" id="Abstract_Unification-unifiable_imp_empty"><span class="command">lemma</span></span> unifiable_imp_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">E</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct <span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_unifless<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation multiset"</span></span>
  <span class="keyword3"><span class="command">presume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">E'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">E'</span><span class="main">,</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">∈</span> unifless<span class="main">;</span> unifiable <span class="main">(</span>set_mset <span class="bound">E'</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="bound">E'</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set_mset <span class="skolem">E</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">E</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> unifiable_imp_empty_or_unif <span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">E</span><span class="main">,</span> <span class="skolem">E'</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">E'</span><span class="main">,</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">∈</span> unifless"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set_mset <span class="skolem">E'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> unif_preserves_unifiable<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> IH <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">E</span><span class="main">,</span> <span class="skolem">E'</span><span class="main">)</span> <span class="main">∈</span> unif›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Unification-unif_rtrancl_empty_imp_unifiable"><span class="command">lemma</span></span> unif_rtrancl_empty_imp_unifiable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_rtrancl_UNIF_conv unifiable_def is_mgu_def
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> UNIF_empty_imp_is_mgu_compose<span class="main">)</span>

<span class="keyword1" id="Abstract_Unification-not_unifiable_imp_not_empty_NF"><span class="command">lemma</span></span> not_unifiable_imp_not_empty_NF<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">E'</span><span class="main">.</span> <span class="bound">E'</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="bound">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">E'</span><span class="main">.</span> <span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="bound">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span> <span class="main">⟹</span> <span class="bound">E'</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SN unif"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_converse_unif <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SN_iff_wf<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="skolem">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SN_imp_WN UNIV_I WN_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> unif_rtrancl_empty_imp_unifiable <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Unification-unif_rtrancl_preserves_unifiable"><span class="command">lemma</span></span> unif_rtrancl_preserves_unifiable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set_mset <span class="free">E'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_preserves_unifiable<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The inference rules for unification are complete in the
  sense that whenever it is not possible to reduce a set of equations
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the empty set, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not unifiable.›</span></span>

<span class="keyword1" id="Abstract_Unification-empty_not_reachable_imp_not_unifiable"><span class="command">lemma</span></span> empty_not_reachable_imp_not_unifiable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∉</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unifiable_imp_empty <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">E</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is enough to reach an irreducible set of equations
  to conclude non-unifiability.›</span></span>
<span class="keyword1" id="Abstract_Unification-irreducible_reachable_imp_not_unifiable"><span class="command">lemma</span></span> irreducible_reachable_imp_not_unifiable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">E'</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">(</span>set_mset <span class="free">E</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E</span><span class="main">,</span> <span class="free">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">E'</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∉</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> NF_not_suc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> empty_not_reachable_imp_not_unifiable
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">(</span>set_mset <span class="free">E'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> unif_rtrancl_preserves_unifiable <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Unification">
<div class="head">
<h1>Theory Unification</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A Concrete Unification Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Unification
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Abstract_Unification.html">Abstract_Unification</a>
    <a href="Option_Monad.html">Option_Monad</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decompose</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>Fun <span class="bound">f</span> <span class="bound">ss</span><span class="main">,</span> Fun <span class="bound">g</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">g</span> <span class="keyword1">then</span> zip_option <span class="bound">ss</span> <span class="bound">ts</span> <span class="keyword1">else</span> None
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="Unification-decompose_Some"><span class="command">lemma</span></span> decompose_Some <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"decompose <span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>Fun <span class="free">g</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">E</span> <span class="main">⟹</span>
    <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∧</span> length <span class="free">ss</span> <span class="main">=</span> length <span class="free">ts</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> zip <span class="free">ss</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> decompose_def<span class="main">)</span>

<span class="keyword1" id="Unification-decompose_None"><span class="command">lemma</span></span> decompose_None <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"decompose <span class="main">(</span>Fun <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>Fun <span class="free">g</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">f</span> <span class="main">≠</span> <span class="free">g</span> <span class="main">∨</span> length <span class="free">ss</span> <span class="main">≠</span> length <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> decompose_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Applying a substitution to a list of equations.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">subst_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">subst_list</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">,</span> snd <span class="bound">p</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="keyword1" id="Unification-mset_subst_list"><span class="command">lemma</span></span> mset_subst_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">(</span>subst_list <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> subst_mset <span class="main">(</span>subst <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_mset_def subst_list_def<span class="main">)</span>

<span class="keyword1" id="Unification-subst_list_append"><span class="command">lemma</span></span> subst_list_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_list <span class="free">σ</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> subst_list <span class="free">σ</span> <span class="free">xs</span> <span class="main">@</span> subst_list <span class="free">σ</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_list_def<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span>
  <span class="entity">unify</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> equation list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term<span class="main">)</span> list option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unify</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unify</span> <span class="main">(</span><span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">,</span> Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> decompose <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="bound">us</span> <span class="main">⇒</span> <span class="free">unify</span> <span class="main">(</span><span class="bound">us</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unify</span> <span class="main">(</span><span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">unify</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> vars_term <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> None
    <span class="keyword1">else</span> <span class="free">unify</span> <span class="main">(</span>subst_list <span class="main">(</span>subst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unify</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> vars_term <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> None
    <span class="keyword1">else</span> <span class="free">unify</span> <span class="main">(</span>subst_list <span class="main">(</span>subst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wf_inv_image <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"unif<span class="main"><span class="main"><span class="main">¯</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">∘</span></span></span> fst"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> wf_converse_unif<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UNIF1.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_def union_commute<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">subst_of</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> List.foldr <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="bound">x</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> Var"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Computing the mgu of two terms.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> subst option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mgu</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> unify <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">[]</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="bound">res</span> <span class="main">⇒</span> Some <span class="main">(</span>subst_of <span class="bound">res</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Unification-subst_of_simps"><span class="command">lemma</span></span> subst_of_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_of <span class="main">[]</span> <span class="main">=</span> Var"</span></span>
  <span class="quoted"><span class="quoted">"subst_of <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> Var <span class="free">x</span><span class="main">)</span> <span class="main">#</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> subst_of <span class="free">ss</span>"</span></span>
  <span class="quoted"><span class="quoted">"subst_of <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> subst_of <span class="free">ss</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="main">(</span>fst <span class="free">b</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_of_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="Unification-subst_of_append"><span class="command">lemma</span></span> subst_of_append <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst_of <span class="main">(</span><span class="free">ss</span> <span class="main">@</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> subst_of <span class="free">ts</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> subst_of <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The concrete algorithm <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>unify›</span></span></span></span> can be simulated by the inference
  rules of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>UNIF›</span></span></span></span>.›</span></span>
<span class="keyword1" id="Unification-unify_Some_UNIF"><span class="command">lemma</span></span> unify_Some_UNIF<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unify <span class="free">E</span> <span class="free">bs</span> <span class="main">=</span> Some <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ds</span> <span class="bound">ss</span><span class="main">.</span> <span class="free">cs</span> <span class="main">=</span> <span class="bound">ds</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">∧</span> subst_of <span class="bound">ds</span> <span class="main">=</span> compose <span class="bound">ss</span> <span class="main">∧</span> UNIF <span class="bound">ss</span> <span class="main">(</span>mset <span class="free">E</span><span class="main">)</span> <span class="main">{#}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unify.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">g</span> <span class="skolem">ts</span> <span class="skolem">E</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"decompose <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">us</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span> <span class="main">=</span> length <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">=</span> zip <span class="skolem">ss</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unify <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">E</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">=</span> Some <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"2.IH"</span> <span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span> 5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_of <span class="skolem">xs</span> <span class="main">=</span> compose <span class="skolem">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"UNIF <span class="skolem">ys</span> <span class="main">(</span>mset <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="main">(</span>Var <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span>mset <span class="main">(</span><span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">,</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UNIF1.decomp <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_of <span class="skolem">xs</span> <span class="main">=</span> compose <span class="main">(</span>Var <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">t</span> <span class="skolem">E</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Var <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Var <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> UNIF.step compose_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> UNIF1.trivial<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≠</span> Var <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_of <span class="skolem">ys</span> <span class="main">=</span> compose <span class="skolem">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars_term <span class="skolem">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="skolem">xs</span> <span class="main">(</span>mset <span class="main">(</span>subst_list <span class="main">(</span>subst <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">{#}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="main">(</span>subst <span class="skolem">x</span> <span class="skolem">t</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>mset <span class="main">(</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UNIF1.Var_left <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_of <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> compose <span class="main">(</span>subst <span class="skolem">x</span> <span class="skolem">t</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">x</span> <span class="skolem">E</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_of <span class="skolem">ys</span> <span class="main">=</span> compose <span class="skolem">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars_term <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="skolem">xs</span> <span class="main">(</span>mset <span class="main">(</span>subst_list <span class="main">(</span>subst <span class="skolem">x</span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="main">(</span>subst <span class="skolem">x</span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>mset <span class="main">(</span><span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UNIF1.Var_right <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_of <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> compose <span class="main">(</span>subst <span class="skolem">x</span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span>

<span class="keyword1" id="Unification-unify_sound"><span class="command">lemma</span></span> unify_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unify <span class="free">E</span> <span class="main">[]</span> <span class="main">=</span> Some <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_imgu <span class="main">(</span>subst_of <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>set <span class="free">E</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> unify_Some_UNIF <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"subst_of <span class="free">cs</span> <span class="main">=</span> compose <span class="skolem">ss</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="skolem">ss</span> <span class="main">(</span>mset <span class="free">E</span><span class="main">)</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> UNIF_empty_imp_is_mgu_compose <span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> UNIF_idemp <span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_imgu_def is_mgu_def<span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> subst_compose_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>unify›</span></span></span></span> gives up, then the given set of equations
  cannot be reduced to the empty set by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>UNIF›</span></span></span></span>.›</span></span>
<span class="keyword1" id="Unification-unify_None"><span class="command">lemma</span></span> unify_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unify <span class="free">E</span> <span class="free">ss</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">E'</span><span class="main">.</span> <span class="bound">E'</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="main">(</span>mset <span class="free">E</span><span class="main">,</span> <span class="bound">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unify.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">g</span> <span class="skolem">ts</span> <span class="skolem">E</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set <span class="skolem">E</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="skolem">E</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unifiable_imp_empty<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> unif_rtrancl_mono <span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">,</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">#}</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="skolem">E</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">,</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">,</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_mset_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">,</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">#}</span> <span class="main">∈</span> NF unif"</span></span>
        <span class="keyword1"><span class="command">using</span></span> decompose_None <span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> single_is_union NF_def unif_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> UNIF1.cases<span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> normalizability_I add_mset_not_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">{</span><span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">,</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">(</span>set <span class="main">(</span><span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">,</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def unifiers_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_unifiable_imp_not_empty_NF<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">us</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">us</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unify <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">E</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"2.IH"</span> <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">E</span><span class="main">)</span><span class="main">,</span> <span class="skolem">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="main">(</span><span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">,</span> Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">,</span> mset <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span> <span class="main">=</span> length <span class="skolem">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">=</span> zip <span class="skolem">ss</span> <span class="skolem">ts</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UNIF1.decomp <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">t</span> <span class="skolem">E</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Var <span class="skolem">x</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="skolem">E</span><span class="main">,</span> <span class="skolem">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="main">(</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">,</span> mset <span class="skolem">E</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UNIF1.trivial <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≠</span> Var <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars_term <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="main">(</span>subst_list <span class="main">(</span>subst <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span><span class="main">,</span> <span class="skolem">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="main">(</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">,</span> mset <span class="main">(</span>subst_list <span class="main">(</span>subst <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UNIF1.Var_left <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≠</span> Var <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"is_Fun <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">{</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_vars_is_Fun_not_unifiable<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">{</span><span class="main">(</span>Var <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> subst"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subst_set_reflects_unifiable <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set <span class="skolem">E</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="skolem">E</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unifiable_imp_empty<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> unif_rtrancl_mono <span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">#}</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="skolem">E</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="main">(</span>Var <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_mset_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">(</span>Var <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_unifiable_imp_not_empty_NF <span class="keyword2"><span class="keyword">and</span></span> **
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_mset_single<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">{</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">(</span>set <span class="main">(</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def unifiers_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_unifiable_imp_not_empty_NF<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">x</span> <span class="skolem">E</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> vars_term <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="main">(</span>subst_list <span class="main">(</span>subst <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span><span class="main">,</span> <span class="skolem">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">,</span> mset <span class="main">(</span>subst_list <span class="main">(</span>subst <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> unif"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UNIF1.Var_right <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unif_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≠</span> Var <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"is_Fun <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">{</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_vars_is_Fun_not_unifiable<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">{</span><span class="main">(</span>Var <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> subst"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subst_set_reflects_unifiable <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unifiable <span class="main">(</span>set <span class="skolem">E</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="skolem">E</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unifiable_imp_empty<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> unif_rtrancl_mono <span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">)</span><span class="main">#}</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="skolem">E</span> <span class="main">+</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">,</span> Var <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_mset_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">,</span> Var <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_unifiable_imp_not_empty_NF <span class="keyword2"><span class="keyword">and</span></span> **
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> unifiable_insert_swap set_mset_single<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">{</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unifiable_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span> Var <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">E</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def unifiers_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_unifiable_imp_not_empty_NF t_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Unification-unify_complete"><span class="command">lemma</span></span> unify_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unify <span class="free">E</span> <span class="free">bs</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unifiers <span class="main">(</span>set <span class="free">E</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> unify_None <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E'</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">E</span><span class="main">,</span> <span class="skolem">E'</span><span class="main">)</span> <span class="main">∈</span> unif<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> unifiable <span class="main">(</span>set <span class="free">E</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> irreducible_reachable_imp_not_unifiable <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unifiable_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Unification-mgu_complete"><span class="command">lemma</span></span> mgu_complete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mgu <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> None <span class="main">⟹</span> unifiers <span class="main">{</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mgu <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unify <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unify <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span> <span class="main">[]</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unifiers <span class="main">(</span>set <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> unify_complete<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Unification-finite_subst_domain_subst_of"><span class="command">lemma</span></span> finite_subst_domain_subst_of<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>subst_domain <span class="main">(</span>subst_of <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>subst_domain <span class="main">(</span>subst <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subst_domain_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_domain_compose <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"subst_of <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_subst_domain<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> finite_subset infinite_Un<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Unification-mgu_subst_domain"><span class="command">lemma</span></span> mgu_subst_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mgu <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst_domain <span class="free">σ</span> <span class="main">⊆</span> vars_term <span class="free">s</span> <span class="main">∪</span> vars_term <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"unify <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span> <span class="main">[]</span> <span class="main">=</span> Some <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_of <span class="skolem">xs</span> <span class="main">=</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> unify_Some_UNIF <span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"compose <span class="skolem">ss</span> <span class="main">=</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"UNIF <span class="skolem">ss</span> <span class="main">{#</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">#}</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> UNIF_subst_domain_subset <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> vars_mset_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Unification-mgu_finite_subst_domain"><span class="command">lemma</span></span> mgu_finite_subst_domain<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mgu <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">σ</span> <span class="main">⟹</span> finite <span class="main">(</span>subst_domain <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unify <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subst_domain_subst_of<span class="main">)</span>

<span class="keyword1" id="Unification-mgu_sound"><span class="command">lemma</span></span> mgu_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mgu <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_imgu <span class="free">σ</span> <span class="main">{</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"unify <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span> <span class="main">[]</span> <span class="main">=</span> Some <span class="skolem">ss</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> subst_of <span class="skolem">ss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_imgu <span class="free">σ</span> <span class="main">(</span>set <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> unify_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Matching">
<div class="head">
<h1>Theory Matching</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Matching›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Matching
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Abstract_Matching.html">Abstract_Matching</a>
    <a href="Unification.html">Unification</a> <span class="comment1">(* for decompose *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">match_term_list</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">match_term_list</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">match_term_list</span> <span class="main">(</span><span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> <span class="free">match_term_list</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">match_term_list</span> <span class="main">(</span><span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">,</span> Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> decompose <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="bound">us</span> <span class="main">⇒</span> <span class="free">match_term_list</span> <span class="main">(</span><span class="bound">us</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">match_term_list</span> <span class="main">(</span><span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">,</span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pat_completeness</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wf_inv_image <span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_measure <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">size_mset</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mset <span class="main"><span class="main"><span class="main">∘</span></span></span> fst"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pair_size_def<span class="main">)</span>

<span class="keyword1" id="Matching-match_term_list_Some_matchrel"><span class="command">lemma</span></span> match_term_list_Some_matchrel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match_term_list <span class="free">P</span> <span class="free">σ</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>mset <span class="free">P</span><span class="main">,</span> <span class="free">σ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_term_list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"2.prems"</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"match_term_list <span class="skolem">P</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MATCH1.Var <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">P</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> *<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>mset <span class="main">(</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">P</span><span class="main">)</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="skolem">P</span><span class="main">,</span> <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MATCH1_matchrel_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"2.IH"</span> <span class="main">[</span><span class="operator">OF</span> * **<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rtrancl_trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">g</span> <span class="skolem">ts</span> <span class="skolem">P</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span> <span class="main">=</span> length <span class="skolem">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose <span class="var">?s</span> <span class="var">?t</span> <span class="main">=</span> Some <span class="main">(</span>zip <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"match_term_list <span class="main">(</span>zip <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="main">@</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MATCH1.Fun <span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>mset <span class="main">(</span><span class="main">(</span><span class="var">?s</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">P</span><span class="main">)</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>mset <span class="main">(</span>zip <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="main">@</span> <span class="skolem">P</span><span class="main">)</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MATCH1_matchrel_conv <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"3.IH"</span> <span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rtrancl_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Matching-match_term_list_None"><span class="command">lemma</span></span> match_term_list_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match_term_list <span class="free">P</span> <span class="free">σ</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="free">σ</span> <span class="main">∩</span> matchers <span class="main">(</span>set <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_term_list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">t</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> match_term_list <span class="skolem">P</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">{#</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">presume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"MATCH1 <span class="main">(</span><span class="main">{#</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MATCH1_matchrel_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">{#</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">{#</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">{#</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">{#</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> matchrel<span class="main"><span class="hidden">⇧</span><sup>!</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> NF_I normalizability_I<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> irreducible_reachable_imp_matchers_empty <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="skolem">σ</span> <span class="main">∩</span> matchers <span class="main">{</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">presume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"match_term_list <span class="skolem">P</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"2.IH"</span> <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matchers_map <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> matchers <span class="main">(</span>set <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> MATCH1_matchers <span class="main">[</span><span class="operator">OF</span> MATCH1.Var <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">P</span>"</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">ss</span> <span class="skolem">g</span> <span class="skolem">ts</span> <span class="skolem">P</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">f</span> <span class="skolem">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun <span class="skolem">g</span> <span class="skolem">ts</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decompose <span class="var">?s</span> <span class="var">?t</span> <span class="main">=</span> None <span class="main">∨</span>
    decompose <span class="var">?s</span> <span class="var">?t</span> <span class="main">=</span> Some <span class="main">(</span>zip <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∧</span> match_term_list <span class="main">(</span>zip <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="main">@</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"decompose <span class="var">?s</span> <span class="var">?t</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">presume</span></span> <span class="quoted"><span class="quoted">"decompose <span class="var">?s</span> <span class="var">?t</span> <span class="main">=</span> Some <span class="main">(</span>zip <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"match_term_list <span class="main">(</span>zip <span class="skolem">ss</span> <span class="skolem">ts</span> <span class="main">@</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"3.IH"</span> <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Compute a matching substitution for a list of term pairs <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
where left-hand sides are "patterns" against which the right-hand sides are matched.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">match_list</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> gsubst option"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">match_list</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> map_option <span class="main">(</span>subst_of_map <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">(</span>match_term_list <span class="free"><span class="bound"><span class="entity">P</span></span></span> Map.empty<span class="main">)</span>"</span></span>

<span class="keyword1" id="Matching-match_list_sound"><span class="command">lemma</span></span> match_list_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match_list <span class="free">d</span> <span class="free">P</span> <span class="main">=</span> Some <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> matchers <span class="main">(</span>set <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> matchrel_sound <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mset <span class="free">P</span>"</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> match_term_list_Some_matchrel <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted">Map.empty</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> match_list_def<span class="main">)</span>

<span class="keyword1" id="Matching-match_list_matches"><span class="command">lemma</span></span> match_list_matches<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match_list <span class="free">d</span> <span class="free">P</span> <span class="main">=</span> Some <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">P</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match_list_sound <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchers_def<span class="main">)</span>

<span class="keyword1" id="Matching-match_list_complete"><span class="command">lemma</span></span> match_list_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match_list <span class="free">d</span> <span class="free">P</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchers <span class="main">(</span>set <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match_term_list_None <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted">Map.empty</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> match_list_def<span class="main">)</span>

<span class="keyword1" id="Matching-match_list_None_conv"><span class="command">lemma</span></span> match_list_None_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"match_list <span class="free">d</span> <span class="free">P</span> <span class="main">=</span> None <span class="main">⟷</span> matchers <span class="main">(</span>set <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match_list_sound <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> match_list_complete <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff not_None_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> match_list Var <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Matching-match_sound"><span class="command">lemma</span></span> match_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> matchers <span class="main">{</span><span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match_list_sound <span class="main">[</span><span class="operator">of</span> <span class="quoted">Var</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> match_def<span class="main">)</span>

<span class="keyword1" id="Matching-match_matches"><span class="command">lemma</span></span> match_matches<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match_sound <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchers_def<span class="main">)</span>

<span class="keyword1" id="Matching-match_complete"><span class="command">lemma</span></span> match_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchers <span class="main">{</span><span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match_list_complete <span class="main">[</span><span class="operator">of</span> <span class="quoted">Var</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> match_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> match_list <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">]</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>

<span class="keyword1" id="Matching-matches_iff"><span class="command">lemma</span></span> matches_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"matches <span class="free">t</span> <span class="free">p</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">p</span> <span class="main">⋅</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> match_list_sound <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>  
  <span class="keyword2"><span class="keyword">and</span></span> match_list_complete <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> matches_def matchers_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Matching-match_complete'"><span class="command">lemma</span></span> match_complete'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> match <span class="free">t</span> <span class="free">p</span> <span class="main">=</span> Some <span class="bound">τ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>vars_term <span class="free">p</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">τ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> matchers <span class="main">{</span><span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matchers_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> match_complete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"match <span class="free">t</span> <span class="free">p</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> match_sound<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> matchers <span class="main">{</span><span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> matchers_vars_term_eq<span class="main">[</span><span class="operator">OF</span> σ this<span class="main">]</span> match <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lvars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">×</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'w</span><span class="main">)</span> term<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lvars</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">(</span>vars_term <span class="main">∘</span> fst<span class="main">)</span> <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Matching-match_list_complete'"><span class="command">lemma</span></span> match_list_complete'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">P</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">=</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> match_list <span class="free">d</span> <span class="free">P</span> <span class="main">=</span> Some <span class="bound">τ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>lvars <span class="free">P</span><span class="main">.</span> <span class="free">σ</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">τ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> matchers <span class="main">(</span>set <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchers_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> match_list_complete <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match_list <span class="free">d</span> <span class="free">P</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> match_list_sound <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> matchers <span class="main">(</span>set <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> match_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> matchers_vars_term_eq <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="quoted">"set <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Subsumption">
<div class="head">
<h1>Theory Subsumption</h1>
</div>
<pre class="source"><span class="comment1">(*
Author:  Christian Sternagel &lt;c.sternagel@gmail.com&gt;
Author:  René Thiemann &lt;rene.thiemann@uibk.ac.at&gt;
License: LGPL
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Subsumption›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the subsumption relation on terms and prove its well-foundedness.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Subsumption
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Term.html">Term</a>
    <span class="quoted">"<a href="../Abstract-Rewriting/Seq.html">Abstract-Rewriting.Seq</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Adhoc_Overloading.html">HOL-Library.Adhoc_Overloading</a>"</span>
    <a href="Fun_More.html">Fun_More</a>
    <a href="Seq_More.html">Seq_More</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  SUBSUMESEQ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≤⋅</span>"</span> 50<span class="main">)</span> 
  SUBSUMES <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&lt;⋅</span>"</span> 50<span class="main">)</span>
  LITSIM <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≐</span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">INSTANCEQ</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⋅≥</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⋅≥</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≤⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">INSTANCE</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⋅&gt;</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⋅&gt;</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">INSTANCEEQ_SET</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{⋅≥}</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{⋅≥}</span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤⋅</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">INSTANCE_SET</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{⋅&gt;}</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{⋅&gt;}</span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;⋅</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SUBSUMESEQ_SET</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{≤⋅}</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{≤⋅}</span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤⋅</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SUBSUMES_SET</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{&lt;⋅}</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{&lt;⋅}</span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;⋅</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">LITSIM_SET</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">{≐}</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{≐}</span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≐</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> subsumable <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subsumeseq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subsumeseq</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subsumeseq</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">subsumeseq</span> <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">subsumeseq</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  SUBSUMESEQ <span class="quoted"><span class="free">subsumeseq</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">subsumes</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≤⋅</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤⋅</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">litsim</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤⋅</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≤⋅</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  SUBSUMES <span class="quoted">subsumes</span> <span class="keyword2"><span class="keyword">and</span></span>
  LITSIM <span class="quoted">litsim</span>

<span class="keyword1" id="Subsumption-litsim_refl"><span class="command">lemma</span></span> litsim_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≐</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> litsim_def refl<span class="main">)</span>

<span class="keyword1" id="Subsumption-litsim_sym"><span class="command">lemma</span></span> litsim_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≐</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≐</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> litsim_def<span class="main">)</span>

<span class="keyword1" id="Subsumption-litsim_trans"><span class="command">lemma</span></span> litsim_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≐</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≐</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">≐</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> litsim_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> subsumable <span class="main">⊆</span> subsumption<span class="main">:</span> preorder <span class="quoted"><span class="quoted">"<span class="main">(≤⋅)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;⋅)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subsumes_def refl <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trans<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">subsumeseq_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> term <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> term <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟹</span> <span class="free">subsumeseq_term</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  SUBSUMESEQ <span class="quoted">subsumeseq_term</span>

<span class="keyword1" id="Subsumption-subsumeseq_termE"><span class="command">lemma</span></span> subsumeseq_termE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤⋅</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">σ</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>

<span class="keyword1" id="Subsumption-subsumeseq_term_refl"><span class="command">lemma</span></span> subsumeseq_term_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> term"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤⋅</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsumeseq_term.intros <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">Var</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Subsumption-subsumeseq_term_trans"><span class="command">lemma</span></span> subsumeseq_term_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="free">t</span> <span class="free">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> term"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤⋅</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤⋅</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤⋅</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">τ</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsumeseq_term.intros <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">σ</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">τ</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> term_subsumable<span class="main">:</span> subsumable <span class="quoted">subsumeseq_term</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subsumeseq_term_refl <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsumeseq_term_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  SUBSUMES <span class="quoted">term_subsumable.subsumes</span> <span class="keyword2"><span class="keyword">and</span></span>
  LITSIM <span class="quoted">term_subsumable.litsim</span>

<span class="keyword1" id="Subsumption-subsumeseq_term_iff"><span class="command">lemma</span></span> subsumeseq_term_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅≥</span> <span class="free">t</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">num_syms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">num_syms</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">num_syms</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>sum_list <span class="main">(</span>map <span class="free">num_syms</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">num_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">num_vars</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">num_vars</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="free">num_vars</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">num_unique_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">num_unique_vars</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> card <span class="main">(</span>vars_term <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Subsumption-num_syms_1"><span class="command">lemma</span></span> num_syms_1<span class="main">:</span> <span class="quoted"><span class="quoted">"num_syms <span class="free">t</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Subsumption-num_syms_subst"><span class="command">lemma</span></span> num_syms_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"num_syms <span class="main">(</span><span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">≥</span> num_syms <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> num_syms_1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> comp_apply sum_list_mono<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equality of terms modulo variables›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">emv</span> <span class="keyword2"><span class="keyword">where</span></span>
  Var <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">emv</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Fun <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span> length <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">;</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="free">emv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">emv</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Subsumption-sum_list_map_num_syms_subst"><span class="command">lemma</span></span> sum_list_map_num_syms_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="main">(</span>num_syms <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map num_syms <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ts</span><span class="main">.</span> num_syms <span class="main">(</span><span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> num_syms <span class="main">(</span><span class="free">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_syms <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="main">(</span>num_syms <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="main">=</span> num_syms <span class="skolem">t</span> <span class="main">+</span> sum_list <span class="main">(</span>map num_syms <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_syms <span class="main">(</span><span class="skolem">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span> <span class="main">≥</span> num_syms <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> num_syms_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="main">(</span>num_syms <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">⋅</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">≥</span> sum_list <span class="main">(</span>map num_syms <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> num_syms_subst <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Subsumption-subst_size_emv"><span class="command">lemma</span></span> subst_size_emv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"num_syms <span class="free">s</span> <span class="main">=</span> num_syms <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"num_funs <span class="free">s</span> <span class="main">=</span> num_funs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emv <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> num_funs_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">g</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Fun <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">(</span>2-<span class="main">)</span> <span class="main">[</span><span class="operator">unfolded</span> Fun<span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> sum_list_map_num_syms_subst <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">τ</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> sum_list_map_num_funs_subst <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">τ</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ts</span><span class="main">.</span> num_syms <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="bound">i</span>  <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> num_syms <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ts</span><span class="main">.</span> num_funs <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⋅</span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> num_funs <span class="main">(</span><span class="skolem">ts</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Fun <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Subsumption-subsumeseq_term_size_emv"><span class="command">lemma</span></span> subsumeseq_term_size_emv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅≥</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"num_syms <span class="free">s</span> <span class="main">=</span> num_syms <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"num_funs <span class="free">s</span> <span class="main">=</span> num_funs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emv <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> subst_size_emv <span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Subsumption-emv_subst_vars_term"><span class="command">lemma</span></span> emv_subst_vars_term<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"emv <span class="free">s</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vars_term <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>the_Var <span class="main">∘</span> <span class="free">σ</span><span class="main">)</span> <span class="main">`</span> vars_term <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="main">[</span><span class="operator">unfolded</span> subsumeseq_term_iff<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply imageI nth_mem<span class="main">)</span>

<span class="keyword1" id="Subsumption-emv_subst_imp_num_unique_vars_le"><span class="command">lemma</span></span> emv_subst_imp_num_unique_vars_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"emv <span class="free">s</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"num_unique_vars <span class="free">s</span> <span class="main">≤</span> num_unique_vars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emv_subst_vars_term <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> num_unique_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image_le finite_vars_term<span class="main">)</span>

<span class="keyword1" id="Subsumption-emv_subsumeseq_term_imp_num_unique_vars_le"><span class="command">lemma</span></span> emv_subsumeseq_term_imp_num_unique_vars_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"emv <span class="free">s</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⋅≥</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"num_unique_vars <span class="free">s</span> <span class="main">≤</span> num_unique_vars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> emv_subst_imp_num_unique_vars_le <span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Subsumption-num_syms_geq_num_vars"><span class="command">lemma</span></span> num_syms_geq_num_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"num_syms <span class="free">t</span> <span class="main">≥</span> num_vars <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sum_list_mono <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted">num_vars</span> <span class="quoted">num_syms</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map num_vars <span class="skolem">ts</span><span class="main">)</span> <span class="main">≤</span> sum_list <span class="main">(</span>map num_syms <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Subsumption-num_unique_vars_Fun_Cons"><span class="command">lemma</span></span> num_unique_vars_Fun_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"num_unique_vars <span class="main">(</span>Fun <span class="free">f</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> num_unique_vars <span class="free">t</span> <span class="main">+</span> num_unique_vars <span class="main">(</span>Fun <span class="free">f</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> num_unique_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> card_Un_Int <span class="main">[</span><span class="operator">OF</span> finite_vars_term finite_Union_vars_term<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Subsumption-sum_list_map_unique_vars"><span class="command">lemma</span></span> sum_list_map_unique_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map num_unique_vars <span class="free">ts</span><span class="main">)</span> <span class="main">≥</span> num_unique_vars <span class="main">(</span>Fun <span class="free">f</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> num_unique_vars_Fun_Cons <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> num_unique_vars_def<span class="main">)</span>

<span class="keyword1" id="Subsumption-num_unique_vars_Var_1"><span class="command">lemma</span></span> num_unique_vars_Var_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"num_unique_vars <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> num_unique_vars_def<span class="main">)</span>

<span class="keyword1" id="Subsumption-num_vars_geq_num_unique_vars"><span class="command">lemma</span></span> num_vars_geq_num_unique_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"num_vars <span class="free">t</span> <span class="main">≥</span> num_unique_vars <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span>
    sum_list_mono <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">num_unique_vars</span> <span class="quoted">num_vars</span><span class="main">,</span> <span class="operator">THEN</span> sum_list_map_unique_vars <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> le_trans<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Subsumption-num_syms_ge_num_unique_vars"><span class="command">lemma</span></span> num_syms_ge_num_unique_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"num_syms <span class="free">t</span> <span class="main">≥</span> num_unique_vars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_trans num_syms_geq_num_vars num_vars_geq_num_unique_vars<span class="main">)</span>

<span class="keyword1" id="Subsumption-num_syms_num_unique_vars_clash"><span class="command">lemma</span></span> num_syms_num_unique_vars_clash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> num_syms <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> num_syms <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> num_unique_vars <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> num_unique_vars <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> num_syms <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> num_syms <span class="main">(</span><span class="free">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"num_syms <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> num_syms <span class="main">(</span><span class="free">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_diff diff_zero less_eq_Suc_le order.not_eq_order_implies_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> num_unique_vars <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> num_syms <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inc_seq_greater <span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"num_syms <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"num_unique_vars <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≥</span> num_syms <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_unique_vars <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> num_syms <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le0 le_antisym num_syms_ge_num_unique_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_Suc_eq_le not_less_eq num_syms_ge_num_unique_vars<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Subsumption-emv_subst_imp_is_Var"><span class="command">lemma</span></span> emv_subst_imp_is_Var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"emv <span class="free">s</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">⋅</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> vars_term <span class="free">t</span><span class="main">.</span> is_Var <span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>

<span class="keyword1" id="Subsumption-bij_Var_subst_compose_Var"><span class="command">lemma</span></span> bij_Var_subst_compose_Var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>Var <span class="main">∘</span> inv <span class="free">g</span><span class="main">)</span> <span class="main">=</span> Var"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Var <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>Var <span class="main">∘</span> inv <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Var <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_compose_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I bij_is_inj inv_into_f_f<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-foundedness›</span></span>

<span class="keyword1" id="Subsumption-wf_subsumes"><span class="command">lemma</span></span> wf_subsumes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="main">{&lt;⋅}</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term rel<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term seq"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> strict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">⋅&gt;</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq case_prodD wf_iff_no_infinite_down_chain<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">⋅≥</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> term_subsumable.subsumption.less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> num_syms <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> num_syms <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subsumeseq_term_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> num_syms_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> down_chain_imp_eq <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> N_syms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">N</span><span class="main">.</span> num_syms <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> num_syms <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> num_funs <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> num_funs <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subsumeseq_term_iff g_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> num_funs_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> down_chain_imp_eq <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">K</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> K_funs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">K</span><span class="main">.</span> num_funs <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> num_funs <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> max <span class="skolem">K</span> <span class="skolem">N</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> strict_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">M</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">⋅&gt;</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> strict <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">M</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">⋅≥</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">M</span><span class="main">.</span> num_funs <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> num_funs <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> K_funs <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> max_less_iff_conj<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> syms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">M</span><span class="main">.</span> num_syms <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> num_syms <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> N_syms <span class="keyword1"><span class="command">unfolding</span></span> M_def g_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right add_lessD1 add_strict_left_mono add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> emv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">M</span><span class="main">.</span> emv <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subsumeseq_term_size_emv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">M</span><span class="main">.</span> num_unique_vars <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> num_unique_vars <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> emv_subsumeseq_term_imp_num_unique_vars_le <span class="keyword2"><span class="keyword">and</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nuv<span class="main">:</span> <span class="quoted"><span class="quoted">"num_unique_vars <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> num_unique_vars <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> num_syms_num_unique_vars_clash <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> Suc <span class="skolem">M</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> syms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right add_Suc_shift le_eq_less_or_eq less_add_Suc2<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> nuv <span class="keyword1"><span class="command">have</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>vars_term <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>vars_term <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> num_unique_vars_def s_def t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> g <span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">THEN</span> mp<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">M</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_def t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emv <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"vars_term <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span>the_Var <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">`</span> vars_term <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> emv_subst_vars_term <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> emv <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_def t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> card <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span>the_Var <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">`</span> vars_term <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>vars_term <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> finite_card_eq_imp_bij_betw <span class="main">[</span><span class="operator">OF</span> finite_vars_term this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>the_Var <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span>vars_term <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>the_Var <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">`</span> vars_term <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> bij_betw_extend <span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">UNIV</span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>vars_term <span class="skolem">t</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>the_Var <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bij <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>vars_term <span class="skolem">t</span><span class="main">.</span> <span class="main">(</span>Var <span class="main">∘</span> <span class="skolem">h</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>the_Var <span class="main">∘</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> emv_subst_imp_is_Var <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹emv <span class="skolem">s</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="skolem">σ</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> vars_term <span class="skolem">t</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="main">∘</span> <span class="skolem">h</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">⋅</span> <span class="main">(</span>Var <span class="main">∘</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⋅</span> <span class="skolem">σ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_subst_eq_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">⋅</span> <span class="main">(</span>Var <span class="main">∘</span> <span class="skolem">h</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>Var <span class="main">∘</span> inv <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">⋅</span> <span class="main">(</span>Var <span class="main">∘</span> inv <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">⋅</span> <span class="main">(</span>Var <span class="main">∘</span> inv <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_Var_subst_compose_Var <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bij <span class="skolem">h</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">⋅≥</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> strict_g <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">M</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_def t_def term_subsumable.subsumes_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>