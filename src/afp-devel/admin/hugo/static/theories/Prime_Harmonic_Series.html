<div id="Prime_Harmonic_Misc">
<div class="head">
<h1>Theory Prime_Harmonic_Misc</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:   Prime_Harmonic_Misc.thy
  Author: Manuel Eberl &lt;eberlm@in.tum.de&gt;

*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary lemmas›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Prime_Harmonic_Misc
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Number_Theory.html">HOL-Number_Theory.Number_Theory</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> sum_list <span class="free">xs</span> <span class="main">≥</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ordered_ab_group_add<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_telescope'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> Suc <span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ab_group_add<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dec_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dvd_prodI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="keyword1">dvd</span> prod <span class="free">f</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="main">*</span> prod <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.remove<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dvd_prodD<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> prod <span class="free">f</span> <span class="free">A</span> <span class="keyword1">dvd</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> dvd_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dvd_prodI<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> multiplicity_power_nat<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> multiplicity <span class="free">p</span> <span class="main">(</span><span class="free">n</span> <span class="main">^</span> <span class="free">k</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="free">k</span> <span class="main">*</span> multiplicity <span class="free">p</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_elem_multiplicity_mult_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> multiplicity_prod_prime_powers_nat'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">⟹</span> prime <span class="free">p</span> <span class="main">⟹</span> 
     multiplicity <span class="free">p</span> <span class="main">(</span><span class="main">∏</span><span class="free">S</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> multiplicity_prod_prime_powers<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_prime_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> prime <span class="main">(</span><span class="bound">x</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> prime <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="free">A</span> <span class="keyword1">dvd</span> <span class="main">∏</span><span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ballI notI<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> x assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> multiplicity <span class="skolem">x</span> <span class="main">(</span><span class="main">∏</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> multiplicity_prod_prime_powers_nat'<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms nonzero <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> multiplicity <span class="skolem">x</span> <span class="main">(</span><span class="main">∏</span><span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dvd_imp_multiplicity_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">x</span> <span class="main">(</span><span class="main">∏</span><span class="free">B</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> multiplicity_prod_prime_powers_nat'<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_prime_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> prime <span class="main">(</span><span class="bound">x</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> prime <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="free">A</span> <span class="main">=</span> <span class="main">∏</span><span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI prod_prime_subset<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> ln_ln_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ln <span class="main">(</span>ln <span class="free">x</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span>  exp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>exp <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span><span class="numeral">3</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ln <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">1</span> <span class="main">≤</span> ln <span class="main">(</span>ln <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Squarefree_Nat">
<div class="head">
<h1>Theory Squarefree_Nat</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:   Squarefree_Nat.thy
  Author: Manuel Eberl &lt;eberlm@in.tum.de&gt;

  The unique decomposition of a natural number into a squarefree part and a square.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Squarefree decomposition of natural numbers›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Squarefree_Nat
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Number_Theory.html">HOL-Number_Theory.Number_Theory</a>"</span>
  <a href="Prime_Harmonic_Misc.html">Prime_Harmonic_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The squarefree part of a natural number is the set of all prime factors that appear 
  with odd multiplicity. The square part, correspondingly, is what remains after dividing
  by the squarefree part.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">squarefree_part</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">squarefree_part</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span><span class="main">∈</span>prime_factors <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> odd <span class="main">(</span>multiplicity <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">square_part</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">square_part</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> <span class="main">(</span>multiplicity <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_part_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"squarefree_part <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> squarefree_part_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> square_part_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"square_part <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> square_part_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_decompose<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span> <span class="main">*</span> square_part <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> squarefree_part <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> square_part <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> <span class="main">(</span>multiplicity <span class="bound">p</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def squarefree_part_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">n</span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> <span class="main">(</span>multiplicity <span class="bound">p</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.mono_neutral_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def  squarefree_part_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> <span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_def square_part_def prod.distrib <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> power_add <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> 
                  power_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prime_factorization_nat <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span>
                  prod_power_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="skolem">A</span> <span class="main">*</span> <span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_part_pos <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_gt_0_nat <span class="keyword1"><span class="command">unfolding</span></span> squarefree_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">lemma</span></span> squarefree_part_ge_Suc_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> squarefree_part_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_part_subset <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"squarefree_part <span class="free">n</span> <span class="main">⊆</span> prime_factors <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> squarefree_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_part_finite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> squarefree_part_subset<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_part_dvd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> squarefree_decompose <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_part_dvd' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> squarefree_part <span class="free">n</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_prodD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ squarefree_part_dvd<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> square_part_dvd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"square_part <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> squarefree_decompose <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> square_part_dvd' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"square_part <span class="free">n</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> squarefree_decompose <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_part_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> squarefree_part <span class="free">n</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> square_part_le<span class="main">:</span> <span class="quoted"><span class="quoted">"square_part <span class="free">n</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> square_part_le_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"square_part <span class="free">n</span> <span class="main">≤</span> nat <span class="main">⌊</span>sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">⌋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> square_part <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">∏</span><span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span> <span class="main">*</span> square_part <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_right_mono<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> squarefree_decompose<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>square_part <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_le_iff<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span>real <span class="main">(</span>square_part <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> real_sqrt_le_iff<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span>real <span class="main">(</span>square_part <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span>square_part <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> square_part_pos <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> square_part <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> square_part_def <span class="keyword1"><span class="command">using</span></span> prime_gt_0_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">lemma</span></span> square_part_ge_Suc_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> square_part <span class="free">n</span> <span class="main">≥</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> square_part_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_not_in_squarefree_part <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> squarefree_part <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> squarefree_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> multiplicity_squarefree_part<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> multiplicity <span class="free">p</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">∈</span> squarefree_part <span class="free">n</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> squarefree_part_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> multiplicity_prod_prime_powers_nat'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The squarefree part really is square, its only square divisor is 1.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> square_dvd_squarefree_part_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="main">∏</span><span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> multiplicity_eq_nat<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="main">∏</span><span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> squarefree_part_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> prime_gt_0_nat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> multiplicity <span class="skolem">p</span> <span class="free">x</span> <span class="main">=</span> multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="free">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiplicity_power_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dvd_imp_multiplicity_le<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> multiplicity_squarefree_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="free">x</span> <span class="main">=</span> multiplicity <span class="skolem">p</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">lemma</span></span> squarefree_decomposition_unique1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"squarefree_part <span class="free">m</span> <span class="main">=</span> squarefree_part <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_part <span class="free">m</span> <span class="main">=</span> square_part <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> squarefree_decompose <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_decomposition_unique2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="free">A2</span> <span class="main">*</span> <span class="free">s2</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A2</span> <span class="main">⟹</span> prime <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s2_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">=</span> squarefree_part <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> square_part <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A1</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">=</span> squarefree_part <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> square_part <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> fin <span class="main">=</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A1</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A2</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">⊆</span> prime_factors <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A1_def <span class="keyword1"><span class="command">using</span></span> squarefree_part_subset <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> subset <span class="main">=</span> this prime

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="skolem">A1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="free">A2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset<span class="main">(</span>1<span class="main">)</span>  prime_gt_0_nat 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod_pos <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> pos <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="main">∏</span><span class="skolem">A1</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∏</span><span class="free">A2</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s1</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s2</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>

  <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="skolem">s1</span> <span class="main">=</span> multiplicity <span class="skolem">p</span> <span class="free">s2</span>"</span></span> 
            <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">A1</span><span class="main">)</span> <span class="main">=</span> multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="main">∏</span><span class="free">A2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">if</span></span>   p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> multiplicity <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> decomp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">A1</span> <span class="main">*</span> <span class="skolem">s1</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">∏</span><span class="free">A2</span> <span class="main">*</span> <span class="free">s2</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A1_def s1_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A1_def s1_def squarefree_decompose<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p pos <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">A1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span> <span class="skolem">s1</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">∏</span><span class="free">A2</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span> <span class="free">s2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def prime_elem_multiplicity_mult_distrib multiplicity_power_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fin subset p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">A1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span><span class="main">∏</span><span class="free">A2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> m_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> multiplicity_prod_prime_powers_nat'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">s1</span> <span class="main">=</span> <span class="skolem">m</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">(</span><span class="main">∏</span><span class="skolem">A1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">∏</span><span class="free">A2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> square_part <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiplicity_eq_nat<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> pos eq'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="free">A2</span> <span class="main">=</span> <span class="main">∏</span><span class="main">(</span>squarefree_part <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiplicity_eq_nat<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> pos eq'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fin subset <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">=</span> squarefree_part <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A1_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_prime_eq<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> squarefree_decomposition_unique2'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="free">A1</span> <span class="main">*</span> <span class="free">s1</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="free">A2</span> <span class="main">*</span> <span class="free">s2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A1</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A1</span> <span class="main">⟹</span> prime <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A2</span> <span class="main">⟹</span> prime <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≡</span> <span class="main">∏</span><span class="free">A1</span> <span class="main">*</span> <span class="free">s1</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">=</span> <span class="free">A2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="free">s2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_gt_0_nat 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod_pos <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subset<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">=</span> squarefree_part <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> square_part <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> squarefree_decomposition_unique2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A1</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s1</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms n<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">=</span> squarefree_part <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> square_part <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> squarefree_decomposition_unique2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A2</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s2</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms n<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">=</span> <span class="free">A2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following is a nice and simple lower bound on the number of prime numbers less than 
  a given number due to Erd\H{o}s. In particular, it implies that there are infinitely many primes.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> primes_lower_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> card <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">π</span> <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">/</span> ln <span class="numeral">4</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">=</span> real <span class="main">(</span>card <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">∏</span><span class="bound">A</span> <span class="main">*</span> <span class="bound">b</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>squarefree_part <span class="bound">n</span><span class="main">,</span> square_part <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_comp o_def squarefree_decompose case_prod_unfold fst_conv snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>squarefree_part <span class="bound">n</span><span class="main">,</span> square_part <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image_le<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>squarefree_part <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">×</span> square_part <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">…</span> <span class="main">=</span> real <span class="main">(</span>card <span class="main">(</span>squarefree_part <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span>card <span class="main">(</span>square_part <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">π</span> <span class="free">n</span> <span class="main">*</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>squarefree_part <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>Pow <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> squarefree_part_subset squarefree_part_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">π</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def card_Pow<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>card <span class="main">(</span>squarefree_part <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">π</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_part <span class="skolem">k</span> <span class="main">≤</span> nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> square_part_le_sqrt<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">insert</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nat_mono floor_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>square_part <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">{</span><span class="main">1</span><span class="main">..</span>nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> square_part_le_sqrt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">…</span> <span class="main">≤</span> sqrt <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>card <span class="main">(</span>square_part <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">π</span> <span class="free">n</span> <span class="main">*</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">π</span> <span class="free">n</span> <span class="main">*</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> real <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_realpow <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_mult ln_realpow<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="free">n</span>"</span></span><span class="main"><span class="main">]</span></span> ln_sqrt <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Prime_Harmonic">
<div class="head">
<h1>Theory Prime_Harmonic</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:   Prime_Harmonic.thy
  Author: Manuel Eberl &lt;eberlm@in.tum.de&gt;

  A lower bound for the partial sums of the prime harmonic series, and a proof of its divergence.
  (#81 on the list of 100 mathematical theorems)
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Prime Harmonic Series›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Prime_Harmonic
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Analysis/Analysis.html">HOL-Analysis.Analysis</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Number_Theory.html">HOL-Number_Theory.Number_Theory</a>"</span>
  <a href="Prime_Harmonic_Misc.html">Prime_Harmonic_Misc</a>
  <a href="Squarefree_Nat.html">Squarefree_Nat</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary equalities and inequalities›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  First of all, we prove the following result about rearranging a product over a set into a sum
  over all subsets of that set.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prime_harmonic_aux1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>Pow <span class="free">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">∏</span><span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>Pow <span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">∏</span><span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword2"><span class="keyword">and</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>Pow <span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">∏</span><span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>Pow <span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="main">∏</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> IH<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_divide_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fin a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>Pow <span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="main">∏</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>Pow <span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">∏</span><span class="main">(</span>insert <span class="skolem">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> prod.insert<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>insert <span class="skolem">a</span> <span class="main">`</span> Pow <span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">∏</span><span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fin a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>Pow <span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">∏</span><span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>Pow <span class="skolem">A</span> <span class="main">∪</span> insert <span class="skolem">a</span> <span class="main">`</span> Pow <span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">∏</span><span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.union_disjoint <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pow <span class="skolem">A</span> <span class="main">∪</span> insert <span class="skolem">a</span> <span class="main">`</span> Pow <span class="skolem">A</span> <span class="main">=</span> Pow <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Pow_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>Pow <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">∏</span><span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we prove a simple and reasonably accurate upper bound for the sum of the squares of any
  subset of the natural numbers, derived by simple telescoping. Our upper bound is approximately
  1.67; the exact value is $\frac{\pi^2}{6} \approx 1.64$. (cf. Basel problem)
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prime_harmonic_aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> nat set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> max <span class="numeral">2</span> <span class="main">(</span>Max <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> Max <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_ge<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span>Suc <span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span>Suc <span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span>Suc <span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">k</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">4</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono divide_left_mono mult_pos_pos<span class="main">)</span>
       <span class="main">(</span><span class="operator">linarith</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> less_1_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span>Suc <span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> real <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_telescope'<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">…</span> <span class="main">≤</span> <span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Estimating the partial sums of the Prime Harmonic Series›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We are now ready to show our main result: the value of the partial prime harmonic sum over
  all primes no greater than $n$ is bounded from below by the $n$-th harmonic number
  $H_n$ minus some constant.

  In our case, this constant will be $\frac{5}{3}$. As mentioned before, using a
  proof of the Basel problem can improve this to $\frac{\pi^2}{6}$, but the improvement is very
  small and the proof of the Basel problem is a very complex one.

  The exact asymptotic behaviour of the partial sums is actually $\ln (\ln n) + M$, where $M$
  is the Meissel--Mertens constant (approximately 0.261).
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> prime_harmonic_lower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">←</span>primes_upto <span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="main">≥</span> ln <span class="main">(</span>harm <span class="free">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹the set of primes that we will allow in the squarefree part›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">n</span> <span class="main">=</span> set <span class="main">(</span>primes_upto <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">P</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this

  <span class="comment1">― ‹The function that combines the squarefree part and the square part›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">R</span><span class="main">,</span> <span class="bound">s</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">∏</span><span class="bound">R</span> <span class="main">*</span> <span class="bound">s</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">f</span></span><span class="antiquote">}</span></span> is injective if the squarefree part contains only primes
      and the square part is positive.›</span>
  <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> <span class="main">(</span>Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span><span class="main">×</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A1</span> <span class="skolem">A2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">⊆</span> <span class="skolem">P</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A2</span> <span class="main">⊆</span> <span class="skolem">P</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="skolem">A1</span><span class="main">,</span> <span class="skolem">s1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">A2</span><span class="main">,</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A1</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> finite_subset<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">=</span> <span class="skolem">A2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> <span class="skolem">s2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> squarefree_decomposition_unique2'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A1</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s1</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A2</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s2</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">insert</span> A fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def P_def set_primes_upto<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">f</span></span><span class="antiquote">}</span></span> hits every number between <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">1</span><span class="main">::</span>nat"</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">n</span>"</span><span class="antiquote">}</span></span>. It also hits a lot
      of other numbers, but we do not care about those, since we only need a lower bound.›</span>
  <span class="keyword1"><span class="command">have</span></span> surj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span>Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span><span class="main">×</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>squarefree_part <span class="skolem">x</span><span class="main">,</span> square_part <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def squarefree_decompose<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"squarefree_part <span class="skolem">x</span> <span class="main">∈</span> Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> squarefree_part_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def set_primes_upto <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> squarefree_part_le<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_part <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> square_part_le<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span>Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span><span class="main">×</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹We now show the main result by rearranging the sum over all primes to a product over all
      all squarefree parts times a sum over all square parts, and then applying some simple-minded
      approximation›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"harm <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> harm_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> surj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span><span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span>Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span><span class="main">×</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2 finite_imageI finite_cartesian_product<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> inj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span><span class="main">×</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">A</span><span class="main">∈</span>Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span><span class="main">∏</span><span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">k</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_product<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sum.cartesian_product<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">A</span><span class="main">∈</span>Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span><span class="main">∏</span><span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono prime_harmonic_aux2 sum_nonneg<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">A</span><span class="main">∈</span>Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span><span class="main">∏</span><span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">A</span><span class="main">∈</span><span class="main">(</span><span class="main">(`)</span> real<span class="main">)</span> <span class="main">`</span> Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">∏</span><span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def inj_image_eq_iff prod.reindex<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(`)</span> real<span class="main">)</span> <span class="main">`</span> Pow <span class="main">(</span><span class="skolem">P</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Pow <span class="main">(</span>real <span class="main">`</span> <span class="skolem">P</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> image_Pow_surj refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">A</span><span class="main">∈</span>Pow <span class="main">(</span>real <span class="main">`</span> <span class="skolem">P</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">∏</span><span class="bound">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">∈</span>real <span class="main">`</span> <span class="skolem">P</span> <span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_harmonic_aux1 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> finite_imageI<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">P</span> <span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.reindex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">P</span> <span class="free">n</span><span class="main">.</span> exp <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> exp <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">P</span> <span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>harm <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span><span class="main">…</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>harm <span class="free">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">P</span> <span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ln_mult<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sum.distinct_set_conv_list<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can use the inequality $\ln (n + 1) \le H_n$ to estimate the asymptotic growth of the partial
  prime harmonic series. Note that $H_n \sim \ln n + \gamma$ where $\gamma$ is the
  Euler--Mascheroni constant (approximately 0.577), so we lose some accuracy here.
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> prime_harmonic_lower'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">←</span>primes_upto <span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="main">≥</span> ln <span class="main">(</span>ln <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms ln_le_harm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>ln <span class="main">(</span>real <span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span>harm <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">-</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">←</span>primes_upto <span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_harmonic_lower<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* TODO: Not needed in Isabelle 2016 *)</span>
<span class="keyword1"><span class="command">lemma</span></span> Bseq_eventually_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">g</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> sequentially"</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Bseq <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="skolem">N</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">g</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_top_linorder<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="free">g</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> BseqE<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> max <span class="skolem">K</span> <span class="main">(</span>Max <span class="main">{</span>norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">|</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="skolem">N</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">N</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> max.coboundedI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Max.coboundedI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> max.coboundedI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> N K<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> BseqI'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Bseq_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span><span class="free">f</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_vector<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Bseq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> norm <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> norm_triangle_ineq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> K<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">K</span> <span class="main">+</span> norm <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> BseqI'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> convergent_imp_Bseq<span class="main">:</span> <span class="quoted"><span class="quoted">"convergent <span class="free">f</span> <span class="main">⟹</span> Bseq <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cauchy_Bseq convergent_Cauchy<span class="main">)</span>

<span class="comment1">(* END TODO *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now use our last estimate to show that the prime harmonic series diverges. This is obvious,
  since it is bounded from below by $\ln (\ln (n + 1))$ minus some constant, which obviously
  tends to infinite.

  Directly using the divergence of the harmonic series would also be possible and shorten this
  proof a bit..
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> prime_harmonic_series_unbounded<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>Bseq <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">p</span><span class="main">←</span>primes_upto <span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Bseq <span class="var">?f</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">n</span> <span class="main">+</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Bseq_add<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>ln <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bseq_eventually_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">::</span>nat"</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>ln <span class="main">(</span>ln <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="var">?f</span> <span class="bound">n</span> <span class="main">+</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> sequentially"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>ln <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ln <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ln_ln_nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?f</span> <span class="skolem">n</span> <span class="main">+</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_harmonic_lower'<span class="main">[</span><span class="operator">OF</span> n<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">n</span> <span class="main">+</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_nonneg_nonneg sum_list_nonneg<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">n</span> <span class="main">+</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span> <span class="main">=</span> norm <span class="main">(</span><span class="var">?f</span> <span class="skolem">n</span> <span class="main">+</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>ln <span class="main">(</span>ln <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span><span class="var">?f</span> <span class="skolem">n</span> <span class="main">+</span> ln <span class="main">(</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>ln <span class="main">(</span>ln <span class="main">(</span>real <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> BseqE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> nat <span class="main">⌈</span>exp <span class="main">(</span>exp <span class="skolem">k</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> N_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">N</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&gt;</span> exp <span class="main">(</span>exp <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="skolem">N</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> ln <span class="main">(</span>exp <span class="main">(</span>exp <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_less_cancel_iff<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> N_pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">N</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> ln <span class="main">(</span>exp <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_less_cancel_iff<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> ln <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">N</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> norm <span class="main">(</span>ln <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">N</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> k<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">N</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> prime_harmonic_series_diverges<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>convergent <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">p</span><span class="main">←</span>primes_upto <span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_harmonic_series_unbounded convergent_imp_Bseq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>