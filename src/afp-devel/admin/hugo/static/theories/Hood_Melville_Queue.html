<div id="Hood_Melville_Queue">
<div class="head">
<h1>Theory Hood_Melville_Queue</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Hood_Melville_Queue
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Queue_Spec.html">HOL-Data_Structures.Queue_Spec</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* All the possible states a queue can be in *)</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> status <span class="main">=</span>
  <span class="comment1">(* front ≥ rear the queue operates like a normal split queue *)</span>
  Idle
  <span class="comment1">(* The queue is performing the first step to create the new front *)</span>
  <span class="main">|</span> Rev <span class="quoted">nat</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="comment1">(* Finishing creating the new front  *)</span>
  <span class="main">|</span> App <span class="quoted">nat</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="comment1">(* The new front is ready *)</span>
  <span class="main">|</span> Done <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>

<span class="comment1">(* A queue with constant time dequeue and enqueue *)</span>
<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> queue <span class="main">=</span> lenf   <span class="main">::</span> <span class="quoted">nat</span>            <span class="comment1">(* length of the front *)</span>
                  front  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>      <span class="comment1">(* front of the queue *)</span>
                  status <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> status"</span></span>    <span class="comment1">(* status representing intermediate operations *)</span>
                  rear   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>      <span class="comment1">(* rear of the queue *)</span>
                  lenr   <span class="main">::</span> <span class="quoted">nat</span>            <span class="comment1">(* length of the rear *)</span>

<span class="comment1">(* exec performs a single step towards creating the new front
   by reversing the rear and appending the front
*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> status <span class="main">⇒</span> <span class="tfree">'a</span> status"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Rev <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">=</span> Rev <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ok</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Rev <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">[]</span>    <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span>   <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">=</span> App <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>App <span class="main">0</span>  <span class="free"><span class="bound"><span class="entity">f'</span></span></span>     <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>         <span class="main">=</span> Done <span class="free"><span class="bound"><span class="entity">r'</span></span></span> "</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>         <span class="main">=</span> App <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ok</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>                          <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="comment1">(* When a deq is performed decreases the number keeping track of
   how many element of the original queue should be used
*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invalidate</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">invalidate</span> <span class="main">(</span>Rev <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">=</span> Rev <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ok</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">invalidate</span> <span class="main">(</span>App <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span><span class="main">)</span>  <span class="main">=</span> Done <span class="free"><span class="bound"><span class="entity">r'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">invalidate</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>     <span class="main">=</span> App <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ok</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">invalidate</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="comment1">(* Performs 2 steps and deals with the result *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec2</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> exec <span class="main">(</span>exec <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
     Done <span class="bound">newf</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">⦇</span>status <span class="main">:=</span> Idle<span class="main">,</span>front <span class="main">:=</span> <span class="bound">newf</span><span class="main">⦈</span> <span class="main">|</span>
     <span class="bound">newstate</span>  <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">⦇</span>status <span class="main">:=</span> <span class="bound">newstate</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Checks if the rear has became greater than the front,
   in which case the rear is cleared and a process to generate
   a new front is started, otherwise the queue functions normally
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> lenr <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≤</span> lenf <span class="free"><span class="bound"><span class="entity">q</span></span></span>
            <span class="keyword1">then</span> exec2 <span class="free"><span class="bound"><span class="entity">q</span></span></span>
            <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">newstate</span> <span class="main">=</span> Rev <span class="main">0</span> <span class="main">(</span>front <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span>rear <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">[]</span>
                 <span class="keyword1">in</span>  exec2 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">⦇</span>lenf <span class="main">:=</span> lenf <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">+</span> lenr <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> status <span class="main">:=</span> <span class="bound">newstate</span><span class="main">,</span> rear <span class="main">:=</span> <span class="main">[]</span><span class="main">,</span> lenr <span class="main">:=</span> <span class="main">0</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* empty queue *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">=</span> queue.make <span class="main">0</span> <span class="main">[]</span> Idle <span class="main">[]</span> <span class="main">0</span>"</span></span>

<span class="comment1">(* Enqueue operation *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enq</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enq</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> check <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">⦇</span>rear <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="main">(</span>rear <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">,</span> lenr <span class="main">:=</span> lenr <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Dequeue opertion *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">deq</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deq</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> check <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">⦇</span> lenf  <span class="main">:=</span> lenf <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">-</span> <span class="main">1</span>
                  <span class="main">,</span> front  <span class="main">:=</span> tl <span class="main">(</span>front <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>
                  <span class="main">,</span> status <span class="main">:=</span> invalidate <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Computes the "true" front of a queue *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">front_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">front_list</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> status <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">of</span>
                     Idle   <span class="main">⇒</span> front <span class="free"><span class="bound"><span class="entity">q</span></span></span>
                   <span class="main">|</span> Done <span class="bound">f</span> <span class="main">⇒</span> <span class="bound">f</span>
                   <span class="main">|</span> Rev <span class="bound">ok</span> <span class="bound">f</span> <span class="bound">f'</span> <span class="bound">r</span> <span class="bound">r'</span> <span class="main">⇒</span> rev <span class="main">(</span>take <span class="bound">ok</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">@</span> <span class="bound">f</span> <span class="main">@</span> rev <span class="bound">r</span> <span class="main">@</span> <span class="bound">r'</span>
                   <span class="main">|</span> App <span class="bound">ok</span> <span class="bound">f'</span> <span class="bound">r'</span>     <span class="main">⇒</span> rev <span class="main">(</span>take <span class="bound">ok</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">@</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Rear of the queue in the proper order (oldest element in head) *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rear_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rear_list</span> <span class="main">=</span> rev <span class="keyword1">o</span> rear"</span></span>

<span class="comment1">(* Queue to list projection *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> front_list <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">@</span> rear_list <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="comment1">(* Query operation (irrelevant) *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">first</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">first</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> hd <span class="main">(</span>front <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* How many applications of exec are needed to reach Idle or Done status *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rem_steps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> status <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rem_steps</span> <span class="main">(</span>Rev <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>length <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rem_steps</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">ok</span></span></span>   <span class="free"><span class="bound"><span class="entity">f'</span></span></span>   <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rem_steps</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="comment1">(* Status invariants *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inv_st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> status <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_st</span> <span class="main">(</span>Rev <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span>
                                      length <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">r'</span></span></span>   <span class="main">∧</span>
                                      <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inv_st</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ok</span></span></span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inv_st</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">steps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> status <span class="main">⇒</span> <span class="tfree">'a</span> status"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">steps</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span>exec <span class="main">^^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="comment1">(* unused *)</span>
<span class="keyword1" id="Hood_Melville_Queue-rev_steps_app"><span class="command">lemma</span></span> rev_steps_app<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_st <span class="main">(</span>Rev <span class="free">ok</span> <span class="free">f</span> <span class="free">f'</span> <span class="free">r</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span>length <span class="free">f</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Rev <span class="free">ok</span> <span class="free">f</span> <span class="free">f'</span> <span class="free">r</span> <span class="free">r'</span><span class="main">)</span> <span class="main">=</span> App <span class="main">(</span>length <span class="free">f</span> <span class="main">+</span> <span class="free">ok</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">f</span> <span class="main">@</span> <span class="free">f'</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">r</span> <span class="main">@</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ok</span></span> <span class="quoted"><span class="free">f'</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">r'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv add.right_neutral add_Suc_right length_0_conv inv_st.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">f</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv add_Suc_right inv_st.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> r_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons Nat.funpow_add <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nat.funpow_swap1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* unused *)</span>
<span class="keyword1" id="Hood_Melville_Queue-inv_st_steps"><span class="command">lemma</span></span> inv_st_steps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv      <span class="main">:</span> <span class="quoted"><span class="quoted">"inv_st <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_idle <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> Idle"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>              <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> steps <span class="main">(</span>rem_steps <span class="free">s</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> Done <span class="bound">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?reach_done</span> <span class="free">s</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?steps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> steps <span class="main">(</span>rem_steps <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> app_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_st <span class="main">(</span>App <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?reach_done</span> <span class="main">(</span>App <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">r</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ok</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">f'</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nat.funpow_swap1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">ok</span> <span class="skolem">f'</span> <span class="skolem">r'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv app_inv <span class="keyword1"><span class="command">unfolding</span></span> App <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rev <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">r</span> <span class="skolem">r'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> rep_split<span class="main">:</span> <span class="quoted"><span class="quoted">"rem_steps <span class="main">(</span>Rev <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">r</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="skolem">f</span> <span class="main">+</span> <span class="skolem">ok</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>length <span class="skolem">f</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">stp</span><span class="main">.</span> <span class="var">?steps</span> <span class="main">(</span>Rev <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">r</span> <span class="skolem">r'</span><span class="main">)</span> <span class="bound">stp</span> <span class="main">=</span> <span class="main">(</span>steps <span class="main">(</span>length <span class="skolem">f</span> <span class="main">+</span> <span class="skolem">ok</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>steps <span class="main">(</span>length <span class="skolem">f</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">stp</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rep_split Nat.funpow_add steps.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_st <span class="main">(</span>App <span class="main">(</span>length <span class="skolem">f</span> <span class="main">+</span> <span class="skolem">ok</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">f</span> <span class="main">@</span> <span class="skolem">f'</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">r</span> <span class="main">@</span> <span class="skolem">r'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Rev inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv f<span class="main">[</span><span class="operator">THEN</span> app_inv<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Rev split inv<span class="main">[</span><span class="operator">simplified</span> Rev<span class="main">,</span><span class="operator">THEN</span> rev_steps_app<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_idle<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Preservation of the status invariants by exec2 *)</span>
<span class="keyword1" id="Hood_Melville_Queue-inv_st_exec"><span class="command">lemma</span></span> inv_st_exec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv_st<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_st <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv_st <span class="main">(</span>exec <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rev <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">r</span> <span class="skolem">r'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_st <span class="keyword1"><span class="command">unfolding</span></span> Rev
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">f'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> C_a<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv_st <span class="keyword1"><span class="command">unfolding</span></span> Rev Cons
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def length_Suc_conv list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> inv_st.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> r_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_st <span class="keyword1"><span class="command">unfolding</span></span> Rev C_a Nil r_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_st <span class="keyword1"><span class="command">unfolding</span></span> Rev C_a r_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ok'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv_st <span class="keyword1"><span class="command">unfolding</span></span> App Suc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_le_D Zero_not_Suc list.exhaust list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inv_st.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_st <span class="keyword1"><span class="command">unfolding</span></span> App Suc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="comment1">(* Preservation of the status invariants by exec2 *)</span>
<span class="keyword1" id="Hood_Melville_Queue-inv_st_exec2"><span class="command">lemma</span></span> inv_st_exec2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv_st<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_st <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv_st <span class="main">(</span>exec <span class="main">(</span>exec <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_st inv_st_exec
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Hood_Melville_Queue-inv_st_invalidate"><span class="command">lemma</span></span> inv_st_invalidate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv_st<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_st <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv_st <span class="main">(</span>invalidate <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rev <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">r</span> <span class="skolem">r'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_st <span class="keyword1"><span class="command">unfolding</span></span> Rev <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> inv_st <span class="keyword1"><span class="command">unfolding</span></span> App
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="comment1">(* Queue invariants *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invar</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">invar</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>lenf <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> length <span class="main">(</span>front_list <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">∧</span>
              lenr <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> length <span class="main">(</span>rear_list <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>  <span class="main">∧</span>
              lenr <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≤</span> lenf <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span>
              <span class="main">(</span><span class="keyword1">case</span> status <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">of</span>
                 Rev <span class="bound">ok</span> <span class="bound">f</span> <span class="bound">f'</span> <span class="bound">r</span> <span class="bound">r'</span> <span class="main">⇒</span> <span class="numeral">2</span><span class="main">*</span>lenr <span class="free"><span class="bound"><span class="entity">q</span></span></span>  <span class="main">≤</span> length <span class="bound">f'</span> <span class="main">∧</span> <span class="bound">ok</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span>length <span class="bound">f</span> <span class="main">+</span> <span class="bound">ok</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span>length <span class="main">(</span>front <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>
               <span class="main">|</span> App <span class="bound">ok</span> <span class="bound">f</span> <span class="bound">r</span>       <span class="main">⇒</span> <span class="numeral">2</span><span class="main">*</span>lenr <span class="free"><span class="bound"><span class="entity">q</span></span></span>  <span class="main">≤</span> length <span class="bound">r</span> <span class="main">∧</span> <span class="bound">ok</span> <span class="main">+</span> <span class="main">1</span>  <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span>length <span class="main">(</span>front <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>
               <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound">rest</span><span class="main">.</span> front_list <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> front <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">@</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">fr</span><span class="main">.</span> status <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> Done <span class="bound">fr</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
              inv_st <span class="main">(</span>status <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* The empty list satisfies the invariant *)</span>
<span class="keyword1" id="Hood_Melville_Queue-invar_empty"><span class="command">lemma</span></span> invar_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"invar empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def empty_def make_def rear_list_def<span class="main">)</span>

<span class="comment1">(* List lemmas *)</span>

<span class="keyword1" id="Hood_Melville_Queue-tl_rev_take"><span class="command">lemma</span></span> tl_rev_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> <span class="free">ok</span><span class="main">;</span> <span class="free">ok</span> <span class="main">≤</span> length <span class="free">f</span><span class="main">⟧</span> <span class="main">⟹</span> rev <span class="main">(</span>take <span class="free">ok</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>rev <span class="main">(</span>take <span class="free">ok</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_take Suc_diff_le drop_Suc tl_drop<span class="main">)</span>

<span class="keyword1" id="Hood_Melville_Queue-tl_rev_take_Suc"><span class="command">lemma</span></span> tl_rev_take_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="free">l</span> <span class="main">⟹</span> rev <span class="main">(</span>take <span class="free">n</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>rev <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_take tl_drop Suc_diff_Suc <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> drop_Suc<span class="main">)</span>

<span class="comment1">(* Dequeue operations preserve the invariants *)</span>
<span class="keyword1" id="Hood_Melville_Queue-invar_deq"><span class="command">lemma</span></span> invar_deq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invar <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>deq <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fields <span class="skolem">lenf</span> <span class="skolem">front</span> <span class="skolem">status</span> <span class="skolem">rear</span> <span class="skolem">lenr</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> pre_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rest</span><span class="main">.</span> <span class="skolem">front</span> <span class="main">@</span> <span class="bound">rest</span> <span class="main">=</span> front_list <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">status</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def Let_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tl_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">status</span> <span class="main">≠</span> Idle <span class="main">⟹</span> <span class="main">∀</span><span class="bound">l</span><span class="main">.</span> tl <span class="skolem">front</span> <span class="main">@</span> <span class="bound">l</span> <span class="main">=</span> tl <span class="main">(</span><span class="skolem">front</span> <span class="main">@</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">status</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">front</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def Let_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">status</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">ok</span> <span class="skolem">x</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">y</span> <span class="skolem">r</span> <span class="skolem">r'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rest</span><span class="main">.</span> front_list <span class="main">(</span>deq <span class="free">q</span><span class="main">)</span> <span class="main">=</span> tl <span class="skolem">front</span> <span class="main">@</span> <span class="bound">rest</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv pre_inv <span class="keyword1"><span class="command">unfolding</span></span> fields st Nil
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def Let_def rear_list_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">rest</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_app st tl_rev_take<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st Nil
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_absorb2 invar_def rear_list_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pre_inv inv
        <span class="keyword1"><span class="command">unfolding</span></span> fields st Nil 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def inv <span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def inv min_absorb2 rear_list_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">rest</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_app st tl_rev_take<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> ok<span class="main">:</span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ok'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fx</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">fx</span> <span class="main">#</span> <span class="skolem">fs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inv lessI less_le_trans not_less_zero
        <span class="keyword1"><span class="command">unfolding</span></span> fields st Suc invar_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> select_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inv_st.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> f_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">fx</span> <span class="main">#</span> <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rx</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">rx</span> <span class="main">#</span> <span class="skolem">rs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inv lessI less_le_trans not_less_zero
        <span class="keyword1"><span class="command">unfolding</span></span> fields st Suc invar_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> select_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inv_st.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> r_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">rx</span> <span class="main">#</span> <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pre_inv inv <span class="keyword1"><span class="command">unfolding</span></span> fields st Suc invar_def rear_list_def r_x f_x
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ok'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def min_absorb2<span class="main">)</span>       
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">rest</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_app st tl_rev_take_Suc<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_le_length_iff length_take list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> min_absorb2 n_not_Suc_n rev_is_Nil_conv take_tl tl_Nil tl_append2<span class="main">)</span>        
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">ok</span> <span class="skolem">x</span> <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st invar_def rear_list_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ok'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pre_inv inv <span class="keyword1"><span class="command">unfolding</span></span> fields st invar_def rear_list_def Suc
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ok'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def rear_list_def check_def min_absorb2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">rest</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_app st tl_rev_take_Suc<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_take list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> min.absorb2 nat.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rev.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rev_rev_ident tl_append2<span class="main">)</span>                
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_1"</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">lenr</span> <span class="main">≤</span> <span class="skolem">lenf</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> st fields
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def rear_list_def invar_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> overflows<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">front</span> <span class="main">=</span> length <span class="skolem">rear</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> st fields
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_antisym rear_list_def invar_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">front</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Nil
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rear</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rear_list_def check_def Let_def invar_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> C_a <span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rear</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Cons invar_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f_eq_r length_Suc_conv C_a<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> rear_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rear</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> Nil
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Nil rear_x C_a
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def Let_def rear_list_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Cons rear_x C_a invar_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def Let_def rear_list_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_2"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def inv fields st<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_3"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_4"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_5"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span><span class="quoted">"5_6"</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Enqueue operation preserv the invariants *)</span>
<span class="keyword1" id="Hood_Melville_Queue-invar_enq"><span class="command">lemma</span></span> invar_enq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invar <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>enq <span class="free">x</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fields <span class="skolem">lenf</span> <span class="skolem">front</span> <span class="skolem">status</span> <span class="skolem">rear</span> <span class="skolem">lenr</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">status</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">ok</span> <span class="skolem">x</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">y</span> <span class="skolem">r</span> <span class="skolem">r'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st Nil
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_absorb2 invar_def rear_list_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv check_def rear_list_def
        <span class="keyword1"><span class="command">unfolding</span></span> fields st Nil invar_def check_def rear_list_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_absorb2 check_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> ok<span class="main">:</span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ok'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fx</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">fx</span> <span class="main">#</span> <span class="skolem">fs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inv lessI less_le_trans not_less_zero
        <span class="keyword1"><span class="command">unfolding</span></span> fields st Suc invar_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> select_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inv_st.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> f_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">fx</span> <span class="main">#</span> <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rx</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">rx</span> <span class="main">#</span> <span class="skolem">rs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inv lessI less_le_trans not_less_zero
        <span class="keyword1"><span class="command">unfolding</span></span> fields st Suc invar_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> select_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inv_st.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> r_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">rx</span> <span class="main">#</span> <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st Suc invar_def rear_list_def r_x f_x
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ok'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def min_absorb2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  check_def rear_list_def Let_def invar_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">list</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  check_def rear_list_def Let_def invar_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">ok</span> <span class="skolem">x</span> <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st invar_def rear_list_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ok'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st invar_def rear_list_def Suc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ok'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def rear_list_def check_def min_absorb2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_1"</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">lenr</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">lenf</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> st fields
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def rear_list_def invar_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> overflows<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">front</span> <span class="main">=</span> length <span class="skolem">rear</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> st fields
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_antisym rear_list_def invar_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">front</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Nil
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rear</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rear_list_def check_def Let_def invar_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> C_a <span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rear</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Cons invar_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f_eq_r length_Suc_conv C_a<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> rear_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rear</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> Nil
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Nil rear_x C_a
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def Let_def rear_list_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Cons rear_x C_a invar_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def Let_def rear_list_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_2"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_3"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_4"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_5"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_6"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Correctness proof of the dequeue operation *)</span>
<span class="keyword1" id="Hood_Melville_Queue-queue_correct_deq"><span class="command">lemma</span></span> queue_correct_deq <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invar <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list <span class="main">(</span>deq <span class="free">q</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>list <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fields <span class="skolem">lenf</span> <span class="skolem">front</span> <span class="skolem">status</span> <span class="skolem">rear</span> <span class="skolem">lenr</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inv_deq<span class="main">:</span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>deq <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv invar_deq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">status</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">ok</span> <span class="skolem">x</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">y</span> <span class="skolem">r</span> <span class="skolem">r'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def min_absorb2 tl_rev_take<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_zero_eq length_take list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> min.absorb2 not_le rev_is_Nil_conv tl_append2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> ok<span class="main">:</span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ok'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> fields st Suc invar_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ok'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def min_absorb2 rear_list_def tl_rev_take_Suc<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> length_greater_0_conv less_le_trans old.nat.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rev_is_Nil_conv take_eq_Nil tl_append2 zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">ok</span> <span class="skolem">x</span> <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> fields st invar_def rear_list_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def rear_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ok'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> fields st invar_def rear_list_def Suc
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ok'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rear_list_def check_def min_absorb2 tl_rev_take_Suc<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nitpick.size_list_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_rev length_take min.absorb2 nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tl_append2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_1"</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">lenr</span> <span class="main">≤</span> <span class="skolem">lenf</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> inv inv_deq Nil_is_rev_conv append_Nil diff_is_0_eq diff_zero length_0_conv
        <span class="keyword1"><span class="command">unfolding</span></span> st fields
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def rear_list_def invar_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span>  list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tl_append2<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> overflows<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">front</span> <span class="main">=</span> length <span class="skolem">rear</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> st fields
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_antisym rear_list_def invar_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">front</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields Nil
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rear</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rear_list_def check_def Let_def invar_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> C_a <span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rear</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Cons invar_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f_eq_r length_Suc_conv C_a<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> rear_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rear</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> Nil
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Nil rear_x C_a
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def Let_def rear_list_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Cons rear_x C_a invar_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def Let_def rear_list_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_2"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_3"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_4"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_5"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_6"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Correctness proof of the enqueue operation *)</span>
<span class="keyword1" id="Hood_Melville_Queue-queue_correct_enq"><span class="command">lemma</span></span> queue_correct_enq <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"invar <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list <span class="main">(</span>enq <span class="free">x</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>list <span class="free">q</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fields <span class="skolem">lenf</span> <span class="skolem">front</span> <span class="skolem">status</span> <span class="skolem">rear</span> <span class="skolem">lenr</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inv_deq<span class="main">:</span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>enq <span class="free">x</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv invar_enq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">status</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">ok</span> <span class="skolem">x</span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">y</span> <span class="skolem">r</span> <span class="skolem">r'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def min_absorb2 tl_rev_take<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">ok</span> <span class="skolem">f</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> ok<span class="main">:</span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> fields st
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ok'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> fields st Suc invar_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ok'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def min_absorb2 rear_list_def tl_rev_take_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="main">(</span>4 <span class="skolem">ok</span> <span class="skolem">x</span> <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ok</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> fields st invar_def rear_list_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def rear_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ok'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> fields st invar_def rear_list_def Suc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ok'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rear_list_def check_def min_absorb2 tl_rev_take_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_1"</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">lenr</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">lenf</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> inv inv_deq Nil_is_rev_conv append_Nil diff_is_0_eq diff_zero length_0_conv
        <span class="keyword1"><span class="command">unfolding</span></span> st fields
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def rear_list_def invar_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span>  list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tl_append2<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> overflows<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_eq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">front</span> <span class="main">=</span> length <span class="skolem">rear</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> st fields
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_antisym rear_list_def invar_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">front</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields Nil
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rear</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rear_list_def check_def Let_def invar_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> C_a <span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rear</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Cons invar_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f_eq_r length_Suc_conv C_a<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> rear_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rear</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> Nil
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Nil rear_x C_a
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def Let_def rear_list_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv overflows <span class="keyword1"><span class="command">unfolding</span></span> st fields Cons rear_x C_a invar_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def Let_def rear_list_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_2"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_3"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_4"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_5"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> st<span class="main">:</span> <span class="quoted">"5_6"</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv inv_deq <span class="keyword1"><span class="command">unfolding</span></span> st fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def check_def rear_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Constructive approach *)</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> action <span class="main">=</span> Deq <span class="main">|</span> Enq <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> actions <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> action list"</span></span>

<span class="comment1">(* Perform a given action on the queue *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">do_act</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> action <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">do_act</span> Deq <span class="free"><span class="bound"><span class="entity">q</span></span></span>     <span class="main">=</span> deq <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">do_act</span> <span class="main">(</span>Enq <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> enq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>

<span class="comment1">(* Create a queue from a list of actions *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">qfa</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> actions <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">qfa</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">acts</span><span class="main">.</span> foldr do_act <span class="bound">acts</span> empty<span class="main">)</span>"</span></span>

<span class="comment1">(* Any queue created from list of actions satisfies the invariants *)</span>
<span class="keyword1" id="Hood_Melville_Queue-invar_qfa"><span class="command">lemma</span></span> invar_qfa <span class="main">:</span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>qfa <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qfa_def invar_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qfa_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"qfa <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> do_act <span class="skolem">x</span> <span class="main">(</span>qfa <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qfa_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Deq
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> invar_deq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"qfa <span class="skolem">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> qfa_cons
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Enq <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> invar_enq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"qfa <span class="skolem">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> qfa_cons
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Correctness proof *)</span>
<span class="keyword1" id="Hood_Melville_Queue-qfa_deq_correct"><span class="command">lemma</span></span> qfa_deq_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"list <span class="main">(</span>deq <span class="main">(</span>qfa <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>list <span class="main">(</span>qfa <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> invar_qfa queue_correct_deq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Hood_Melville_Queue-qfa_enq_correct"><span class="command">lemma</span></span> qfa_enq_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"list <span class="main">(</span>enq <span class="free">x</span> <span class="main">(</span>qfa <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>list <span class="main">(</span>qfa <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> invar_qfa queue_correct_enq<span class="main">)</span>

<span class="keyword1" id="Hood_Melville_Queue-first_correct"><span class="command">lemma</span></span> first_correct <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span>      <span class="quoted"><span class="quoted">"invar <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_nil <span class="main">:</span> <span class="quoted"><span class="quoted">"list <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>             <span class="quoted"><span class="quoted">"first <span class="free">q</span> <span class="main">=</span> hd <span class="main">(</span>list <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"front <span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rest</span></span> <span class="keyword2"><span class="keyword">where</span></span> front_l<span class="main">:</span> <span class="quoted"><span class="quoted">"front_list <span class="free">q</span> <span class="main">=</span> front <span class="free">q</span> <span class="main">@</span> <span class="skolem">rest</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> front_list.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> front_nil<span class="main">:</span> Nil
  <span class="keyword1"><span class="command">have</span></span> rear_nil<span class="main">:</span> <span class="quoted"><span class="quoted">"rear_list <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> invar_def rear_list_def front_nil
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"status <span class="free">q</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> front_nil<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> front_nil<span class="main">:</span> <span class="quoted"><span class="quoted">"front_list <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> invar_def rear_list_def front_nil
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"status <span class="free">q</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> front_nil<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_nil <span class="keyword1"><span class="command">unfolding</span></span>  list.simps rear_nil front_nil
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> front_cons<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> list.simps first.simps front_cons front_list.simps    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def rear_list_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons front_cons list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>list <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> HMQ<span class="main">:</span> Queue <span class="keyword2"><span class="keyword">where</span></span>
  empty    <span class="main">=</span> <span class="quoted">empty</span>    <span class="keyword2"><span class="keyword">and</span></span>
  enq      <span class="main">=</span> <span class="quoted">enq</span>      <span class="keyword2"><span class="keyword">and</span></span>
  first    <span class="main">=</span> <span class="quoted">first</span>    <span class="keyword2"><span class="keyword">and</span></span>
  deq      <span class="main">=</span> <span class="quoted">deq</span>      <span class="keyword2"><span class="keyword">and</span></span>
  is_empty <span class="main">=</span> <span class="quoted">is_empty</span> <span class="keyword2"><span class="keyword">and</span></span>
  list     <span class="main">=</span> <span class="quoted">list</span>  <span class="keyword2"><span class="keyword">and</span></span>
  invar    <span class="main">=</span> <span class="quoted">invar</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def make_def rear_list_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> queue_correct_enq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> queue_correct_deq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> first_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def invar_def make_def rear_list_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 7 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> invar_enq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 8 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> invar_deq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>