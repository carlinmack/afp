<div id="Behaviour">
<div class="head">
<h1>Theory Behaviour</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Behaviour
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'state</span> behaviour <span class="main">=</span>
  Terminates <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span> <span class="main">|</span> Diverges <span class="main">|</span> <span class="entity">is_wrong</span><span class="main">:</span> Goes_wrong <span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Terminating behaviours are annotated with the last state of the execution in order to compare the result of two executions with the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rel_behaviour<span class="antiquote"><span class="antiquote">}</span></span></span></span> relation.

The exact meaning of the three behaviours is defined in the semantics locale
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Well_founded">
<div class="head">
<h1>Theory Well_founded</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Well-foundedness of Relations Defined as Predicate Functions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Well_founded
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> well_founded <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊏</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main"><span class="free">(⊏)</span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> induct <span class="main">=</span> wfP_induct_rule<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unit›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wfP_unit<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="main">()</span> <span class="main">()</span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nitpick.case_unit_unfold wfP_eq_minimal<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> well_founded <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">()</span> <span class="main">()</span><span class="main">.</span> False"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wfP_unit<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lexicographic product›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">r1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">r2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lex_prodp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lex_prodp</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free">r1</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∨</span> fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free">r2</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_prodp_lex_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lex_prodp <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> lex_prod <span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">r1</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">}</span> <span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">r2</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_prod_def lex_prodp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_prodp_wfP<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"wfP <span class="free">r1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"wfP <span class="free">r2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wfP lex_prodp"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wfPUNIVI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> lex_prodp <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> lex_prodp <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> hyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y1</span> <span class="bound">y2</span><span class="main">.</span> lex_prodp <span class="main">(</span><span class="bound">y1</span><span class="main">,</span> <span class="bound">y2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">P</span> <span class="main">(</span><span class="bound">y1</span><span class="main">,</span> <span class="bound">y2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x1</span> <span class="skolem">x2</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">atomize</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfP_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">b</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">b</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfP_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">b</span></span><span class="main"><span class="main">.</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">b</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> hyps<span class="main">[</span><span class="operator">unfolded</span> lex_prodp_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_prodp_well_founded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"well_founded <span class="free">r1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"well_founded <span class="free">r2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"well_founded <span class="main">(</span>lex_prodp <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> well_founded.intro lex_prodp_wfP assms<span class="main">[</span><span class="operator">THEN</span> well_founded.wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lexicographic list›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">lexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  lexp_head<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">order</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟹</span> <span class="free">lexp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  lexp_tail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lexp</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟹</span> <span class="free">lexp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexp_prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"lexp <span class="free">order</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟹</span> lexp <span class="free">order</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lexp_tail<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexp_lex<span class="main">:</span> <span class="quoted"><span class="quoted">"lexp <span class="free">order</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> lex <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">order</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lexp <span class="free">order</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> lex <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">order</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lexp.induct<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> lex <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">order</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lexp <span class="free">order</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lexp_prepend <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lexp_head <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lex_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lex_list_wfP<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="free">order</span> <span class="main">⟹</span> wfP <span class="main">(</span>lexp <span class="free">order</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lexp_lex wf_lex wfP_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lex_list_well_founded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"well_founded <span class="free">order</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"well_founded <span class="main">(</span>lexp <span class="free">order</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> well_founded.intro assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> well_founded.wf<span class="main">,</span> <span class="operator">THEN</span> lex_list_wfP<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Inf">
<div class="head">
<h1>Theory Inf</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Infinitely Transitive Closure›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Inf
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Well_founded.html">Well_founded</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">inf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">where</span></span>
  inf_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">inf</span> <span class="free">r</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">inf</span> <span class="free">r</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">inf_wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">r</span> <span class="entity">order</span> <span class="keyword2"><span class="keyword">where</span></span>
  inf_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">order</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟹</span> <span class="free">inf_wf</span> <span class="free">r</span> <span class="free">order</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">inf_wf</span> <span class="free">r</span> <span class="free">order</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  inf_wf_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">inf_wf</span> <span class="free">r</span> <span class="free">order</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">inf_wf</span> <span class="free">r</span> <span class="free">order</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inf_wf_to_step_inf_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"well_founded <span class="free">order</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inf_wf <span class="free">r</span> <span class="free">order</span> <span class="free">n</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span> <span class="bound">m</span><span class="main">.</span> <span class="free">r</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">∧</span> inf_wf <span class="free">r</span> <span class="free">order</span> <span class="bound">m</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> well_founded.induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inf_wf.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>inf_wf <span class="skolem">m</span> <span class="skolem">n'</span> <span class="skolem">x'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>inf_wf_step <span class="skolem">x'</span> <span class="skolem">y</span> <span class="skolem">m</span> <span class="skolem">n'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_tranclpE inf_wf.inf_wf_step<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inf_wf_to_inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"well_founded <span class="free">order</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inf_wf <span class="free">r</span> <span class="free">order</span> <span class="free">n</span> <span class="free">x</span> <span class="main">⟹</span> inf <span class="free">r</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inf.coinduct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>inf <span class="skolem">x</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inf_wf <span class="free">r</span> <span class="free">order</span> <span class="skolem">m</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf_wf_to_step_inf_wf<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> inf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> inf <span class="free">r</span> <span class="free">x</span> <span class="main">⟹</span> inf <span class="free">r</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> deterministic inf.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">r</span> <span class="bound">x</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> inf <span class="free">r</span> <span class="free">x</span> <span class="main">⟹</span> inf <span class="free">r</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> step_inf deterministic <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Semantics">
<div class="head">
<h1>Theory Semantics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Dynamic Representation of a Language›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Semantics
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Behaviour.html">Behaviour</a> <a href="Inf.html">Inf</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The definition of programming languages is separated into two parts: an abstract semantics and a concrete program representation.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finished</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finished</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∄</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finished_star<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">r</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finished_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> semantics <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    final_finished<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="free">s</span> <span class="main">⟹</span> finished <span class="free">step</span> <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The semantics locale represents the semantics as an abstract machine.
It is expressed by a transition system with a transition relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">step</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>---usually written as an infix <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">→</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> arrow---and final states <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">final</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finished_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">¬</span>finished <span class="free">step</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finished_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇧</span><sup>*</sup></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="main">≡</span> <span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">inf_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inf_step</span> <span class="main">≡</span> inf <span class="free">step</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span>
  inf_step <span class="main">(</span><span class="quoted">"<span class="keyword1">'(→<span class="hidden">⇧</span><sup>∞</sup>')</span>"</span> <span class="main">[</span><span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  inf_step <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→<span class="hidden">⇧</span><sup>∞</sup></span>"</span> <span class="main">[</span>55<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finished_inf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">→<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⟹</span> <span class="main">¬</span> finished <span class="free">step</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inf.cases finished_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_deterministic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">step</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">step</span> <span class="bound">x</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">s1</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">s3</span> <span class="main">⟹</span> finished <span class="free">step</span> <span class="free">s2</span> <span class="main">⟹</span> finished <span class="free">step</span> <span class="free">s3</span> <span class="main">⟹</span> <span class="free">s2</span> <span class="main">=</span> <span class="free">s3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s3</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtranclp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finished_star<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_rtranclpE deterministic finished_step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Behaviour of a dynamic execution›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">sem_behaves</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> behaviour <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↓</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  state_terminates<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟹</span> finished <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟹</span> <span class="free">final</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="main">(</span>Terminates <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  state_diverges<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">→<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="free">↓</span></span> Diverges"</span></span> <span class="main">|</span>
  state_goes_wrong<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟹</span> finished <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">final</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="main">(</span>Goes_wrong <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Even though the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">step</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> transition relation in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> semantics<span class="antiquote"><span class="antiquote">}</span></span></span></span> locale need not be deterministic, if it happens to be, then the behaviour of a program becomes deterministic too.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sem_behaves_deterministic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">step</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">step</span> <span class="bound">x</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">↓</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">↓</span> <span class="free">b2</span> <span class="main">⟹</span> <span class="free">b1</span> <span class="main">=</span> <span class="free">b2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">b1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sem_behaves.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_terminates <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> state_terminates.prems state_terminates.hyps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s1</span></span> <span class="quoted"><span class="free">b2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sem_behaves.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_terminates <span class="skolem">s1</span> <span class="skolem">s3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_deterministic deterministic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_diverges <span class="skolem">s1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> deterministic star_inf<span class="main">[</span><span class="operator">THEN</span> finished_inf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_goes_wrong <span class="skolem">s1</span> <span class="skolem">s3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_deterministic deterministic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_diverges <span class="skolem">s1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> state_diverges.prems state_diverges.hyps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s1</span></span> <span class="quoted"><span class="free">b2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sem_behaves.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_terminates <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> deterministic star_inf<span class="main">[</span><span class="operator">THEN</span> finished_inf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_diverges <span class="skolem">s1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_goes_wrong <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> deterministic star_inf<span class="main">[</span><span class="operator">THEN</span> finished_inf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_goes_wrong <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> state_goes_wrong.prems state_goes_wrong.hyps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s1</span></span> <span class="quoted"><span class="free">b2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sem_behaves.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_terminates <span class="skolem">s1</span> <span class="skolem">s3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> eval_deterministic deterministic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_diverges <span class="skolem">s1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> deterministic star_inf<span class="main">[</span><span class="operator">THEN</span> finished_inf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_goes_wrong <span class="skolem">s1</span> <span class="skolem">s3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_deterministic deterministic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Language">
<div class="head">
<h1>Theory Language</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Static Representation of a Language›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Language
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Semantics.html">Semantics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> language <span class="main">=</span>
  semantics <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">final</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">load</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">context</span></span> language <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The language locale represents the concrete program representation (type variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'prog</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), which can be transformed into a program state (type variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'state</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) by the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">load</span></span></span></span> <span class="antiquote"><span class="antiquote">}</span></span></span></span> function.
The set of initial states of the transition system is implicitly defined by the codomain of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">load</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Behaviour of a dynamic execution›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">behaves</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog</span> <span class="main">⇒</span> <span class="tfree">'state</span> behaviour <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇓</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">behaves</span> <span class="main">=</span> <span class="free">load</span> <span class="keyword1">OO</span> sem_behaves"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If both the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">load</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">step</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> relations are deterministic, then so is the behaviour of a program.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> behaves_deterministic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    load_deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">load</span> <span class="bound">p</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">load</span> <span class="bound">p</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    step_deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">step</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">step</span> <span class="bound">x</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    behaves<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⇓</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⇓</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">b'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">load</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">↓</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">↓</span> <span class="free">b'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> behaves load_deterministic
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> behaves_def<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> step_deterministic sem_behaves_deterministic<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">↓</span> <span class="free">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">↓</span> <span class="free">b'</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Simulation">
<div class="head">
<h1>Theory Simulation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Simulations Between Dynamic Executions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Simulation
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Semantics.html">Semantics</a> <a href="Inf.html">Inf</a> <a href="Well_founded.html">Well_founded</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> backward_simulation <span class="main">=</span>
  L1<span class="main">:</span> semantics <span class="quoted"><span class="free">step1</span></span> <span class="quoted"><span class="free">final1</span></span> <span class="main">+</span>
  L2<span class="main">:</span> semantics <span class="quoted"><span class="free">step2</span></span> <span class="quoted"><span class="free">final2</span></span> <span class="main">+</span>
  well_founded <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(⊏)</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">final1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">final2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'index</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊏</span>"</span> 70<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    match_final<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free">i</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">final2</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">final1</span> <span class="free">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    simulation<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free">i1</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">step2</span> <span class="free">s2</span> <span class="free">s2'</span> <span class="main">⟹</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">i2</span> <span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">i2</span> <span class="bound">s1'</span> <span class="free">s2'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i2</span><span class="main">.</span> <span class="free">match</span> <span class="bound">i2</span> <span class="free">s1</span> <span class="free">s2'</span> <span class="main">∧</span> <span class="bound">i2</span> <span class="main"><span class="free">⊏</span></span> <span class="free">i1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A simulation is defined between two <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> semantics<span class="antiquote"><span class="antiquote">}</span></span></span></span> L1 and L2.
A <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">match</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> predicate expresses that two states from L1 and L2 are equivalent.
The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">match</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> predicate is also parameterized with an ordering used to avoid stuttering.
The only two assumptions of a backward simulation are that a final state in L2 will also be a final in L1,and that a step in L2 will either represent a non-empty sequence of steps in L1 or will result in an equivalent state.
Stuttering is ruled out by the requirement that the index on the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">match</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> predicate decreases with respect to the well-founded <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">order</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> ordering.
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> forward_simulation <span class="main">=</span>
  L1<span class="main">:</span> semantics <span class="quoted"><span class="free">step1</span></span> <span class="quoted"><span class="free">final1</span></span> <span class="main">+</span>
  L2<span class="main">:</span> semantics <span class="quoted"><span class="free">step2</span></span> <span class="quoted"><span class="free">final2</span></span> <span class="main">+</span>
  well_founded <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(⊏)</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">final1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">final2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'index</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊏</span>"</span> 70<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    match_final<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free">i</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">final1</span> <span class="free">s1</span> <span class="main">⟹</span> <span class="free">final2</span> <span class="free">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    simulation<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free">i1</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">step1</span> <span class="free">s1</span> <span class="free">s1'</span> <span class="main">⟹</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span> <span class="bound">s2'</span><span class="main">.</span> <span class="free">step2</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">s2</span> <span class="bound">s2'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">i'</span> <span class="free">s1'</span> <span class="bound">s2'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> <span class="free">match</span> <span class="bound">i'</span> <span class="free">s1</span> <span class="free">s2'</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main"><span class="free">⊏</span></span> <span class="free">i1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> bisimulation <span class="main">=</span>
  forward_simulation <span class="quoted"><span class="free">step1</span></span> <span class="quoted"><span class="free">step2</span></span> <span class="quoted"><span class="free">final1</span></span> <span class="quoted"><span class="free">final2</span></span> <span class="quoted"><span class="free">order</span></span> <span class="quoted"><span class="free">match</span></span> <span class="main">+</span>
  backward_simulation <span class="quoted"><span class="free">step1</span></span> <span class="quoted"><span class="free">step2</span></span> <span class="quoted"><span class="free">final1</span></span> <span class="quoted"><span class="free">final2</span></span> <span class="quoted"><span class="free">order</span></span> <span class="quoted"><span class="free">match</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">final1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">final2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'index</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">context</span></span> backward_simulation <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_simulation_plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">step2</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">s2</span> <span class="free">s2'</span> <span class="main">⟹</span> <span class="free">match</span> <span class="free">i1</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">i2</span> <span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">i2</span> <span class="bound">s1'</span> <span class="free">s2'</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">i2</span><span class="main">.</span> <span class="free">match</span> <span class="bound">i2</span> <span class="free">s1</span> <span class="free">s2'</span> <span class="main">∧</span> <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i2</span> <span class="free">i1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">thm</span></span> tranclp_induct
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s2'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i1</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tranclp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">s2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> simulation<span class="main">[</span><span class="operator">OF</span> base.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> base.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">s2'</span> <span class="skolem">s2''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> step.IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">match</span> <span class="skolem">i1</span> <span class="skolem">s1</span> <span class="free">s2</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i2</span> <span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">i2</span> <span class="bound">s1'</span> <span class="skolem">s2'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="skolem">s1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i2</span> <span class="skolem">s1'</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> simulation<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">match</span> <span class="skolem">i2</span> <span class="skolem">s1'</span> <span class="skolem">s2'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">step2</span> <span class="skolem">s2'</span> <span class="skolem">s2''</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i3</span> <span class="bound">s1''</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1'</span> <span class="bound">s1''</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">i3</span> <span class="bound">s1''</span> <span class="skolem">s2''</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i3</span></span> <span class="skolem"><span class="skolem">s1''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1'</span> <span class="skolem">s1''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i3</span> <span class="skolem">s1''</span> <span class="skolem">s2''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> tranclp_trans<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="skolem">s1'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i3</span><span class="main">.</span> <span class="free">match</span> <span class="bound">i3</span> <span class="skolem">s1'</span> <span class="skolem">s2''</span> <span class="main">∧</span> <span class="bound">i3</span> <span class="main"><span class="free">⊏</span></span> <span class="skolem">i2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i3</span> <span class="skolem">s1'</span> <span class="skolem">s2''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i3</span> <span class="main"><span class="free">⊏</span></span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="skolem">s1'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i2</span><span class="main">.</span> <span class="free">match</span> <span class="bound">i2</span> <span class="skolem">s1</span> <span class="skolem">s2'</span> <span class="main">∧</span> <span class="main"><span class="free">(⊏)</span></span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i2</span> <span class="skolem">i1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i3</span> <span class="skolem">s1</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(⊏)</span></span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">i3</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> simulation<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">match</span> <span class="skolem">i3</span> <span class="skolem">s1</span> <span class="skolem">s2'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">step2</span> <span class="skolem">s2'</span> <span class="skolem">s2''</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_simulation_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"L2.eval <span class="free">s2</span> <span class="free">s2'</span> <span class="main">⟹</span> <span class="free">match</span> <span class="free">i1</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i2</span> <span class="bound">s1'</span><span class="main">.</span> L1.eval <span class="free">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">i2</span> <span class="bound">s1'</span> <span class="free">s2'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i1</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtranclp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">s2</span> <span class="skolem">s2''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> simulation<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">match</span> <span class="skolem">i1</span> <span class="skolem">s1</span> <span class="skolem">s2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">step2</span> <span class="skolem">s2</span> <span class="skolem">s2''</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i2</span> <span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">i2</span> <span class="bound">s1'</span> <span class="skolem">s2''</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> rtranclp_trans step.IH tranclp_into_rtranclp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i2</span><span class="main">.</span> <span class="free">match</span> <span class="bound">i2</span> <span class="skolem">s1</span> <span class="skolem">s2''</span> <span class="main">∧</span> <span class="bound">i2</span> <span class="main"><span class="free">⊏</span></span> <span class="skolem">i1</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> backward_simulation_inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free">i</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"inf <span class="free">step2</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inf <span class="free">step1</span> <span class="free">s1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inf_wf <span class="free">step1</span> <span class="free">order</span> <span class="free">i</span> <span class="free">s1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> inf_wf
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step2</span> <span class="skolem">s2</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inf <span class="free">step2</span> <span class="skolem">s2'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inf_wf<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> inf.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> simulation<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">match</span> <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">step2</span> <span class="skolem">s2</span> <span class="skolem">s2'</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹inf <span class="free">step2</span> <span class="skolem">s2'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inf_wf_to_inf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inf_wf_to_inf well_founded_axioms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preservation of behaviour›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The main correctness theorem states that, for any two matching programs, any not wrong behaviour of the later is also a behaviour of the former.
In other words, if the compiled program does not crash, then its behaviour, whether it terminates or not, is a also a valid behaviour of the source program.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> simulation_behaviour <span class="main">:</span>
  <span class="quoted"><span class="quoted">"L2.sem_behaves <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">¬</span>is_wrong <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">match</span> <span class="free">i</span> <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">i'</span><span class="main">.</span> L1.sem_behaves <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> rel_behaviour <span class="main">(</span><span class="free">match</span> <span class="bound">i'</span><span class="main">)</span> <span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> L2.sem_behaves.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_terminates <span class="skolem">s2</span> <span class="skolem">s2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"L1.eval <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">s1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i'</span> <span class="skolem">s1'</span> <span class="skolem">s2'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lift_simulation_eval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">final1</span> <span class="skolem">s1'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> state_terminates.hyps match_final<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"L1.sem_behaves <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Terminates <span class="skolem">s1'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L1.final_finished
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L1.state_terminates <span class="quoted"><span class="quoted">‹L1.eval <span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">s1'</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_behaviour <span class="main">(</span><span class="free">match</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>Terminates <span class="skolem">s1'</span><span class="main">)</span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">match</span> <span class="skolem">i'</span> <span class="skolem">s1'</span> <span class="skolem">s2'</span>›</span></span> state_terminates.hyps<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_diverges <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> backward_simulation_inf L1.state_diverges <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>state_goes_wrong <span class="skolem">s2</span> <span class="skolem">s2'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>is_wrong <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Composition of backward simulations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_comp</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_comp</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">OO</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> backward_simulation_composition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"backward_simulation <span class="free">step1</span> <span class="free">step2</span> <span class="free">final1</span> <span class="free">final2</span> <span class="free">order1</span> <span class="free">match1</span>"</span></span>
    <span class="quoted"><span class="quoted">"backward_simulation <span class="free">step2</span> <span class="free">step3</span> <span class="free">final2</span> <span class="free">final3</span> <span class="free">order2</span> <span class="free">match2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"backward_simulation <span class="free">step1</span> <span class="free">step3</span> <span class="free">final1</span> <span class="free">final3</span>
      <span class="main">(</span>lex_prodp <span class="free">order1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">order2</span><span class="main">)</span> <span class="main">(</span>rel_comp <span class="free">match1</span> <span class="free">match2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">intro_locales</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="free">step1</span> <span class="free">final1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> backward_simulation.axioms assms<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="free">step3</span> <span class="free">final3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> backward_simulation.axioms assms<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"well_founded <span class="main">(</span>lex_prodp <span class="free">order1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">order2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">THEN</span> backward_simulation.axioms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lex_prodp_well_founded well_founded.intro well_founded.wf wfP_trancl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"backward_simulation_axioms <span class="free">step1</span> <span class="free">step3</span> <span class="free">final1</span> <span class="free">final3</span>
    <span class="main">(</span>lex_prodp <span class="free">order1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">order2</span><span class="main">)</span> <span class="main">(</span>rel_comp <span class="free">match1</span> <span class="free">match2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s3</span>
    <span class="keyword3"><span class="command">assume</span></span>
      match<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_comp <span class="free">match1</span> <span class="free">match2</span> <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      final<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">final3</span> <span class="skolem">s3</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">match1</span> <span class="skolem">i1</span> <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match2</span> <span class="skolem">i2</span> <span class="skolem">s2</span> <span class="skolem">s3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i1</span><span class="main">,</span> <span class="skolem">i2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> match <span class="keyword1"><span class="command">unfolding</span></span> rel_comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">final1</span> <span class="skolem">s1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> final assms<span class="main">[</span><span class="operator">THEN</span> backward_simulation.match_final<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s3</span> <span class="skolem">s3'</span>
    <span class="keyword3"><span class="command">assume</span></span>
      match<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_comp <span class="free">match1</span> <span class="free">match2</span> <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">step3</span> <span class="skolem">s3</span> <span class="skolem">s3'</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">match1</span> <span class="skolem">i1</span> <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match2</span> <span class="skolem">i2</span> <span class="skolem">s2</span> <span class="skolem">s3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i1</span><span class="main">,</span> <span class="skolem">i2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> match <span class="keyword1"><span class="command">unfolding</span></span> rel_comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> backward_simulation.simulation<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">match2</span> <span class="skolem">i2</span> <span class="skolem">s2</span> <span class="skolem">s3</span>›</span></span> step<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i'</span> <span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> rel_comp <span class="free">match1</span> <span class="free">match2</span> <span class="bound">i'</span> <span class="bound">s1'</span> <span class="skolem">s3'</span><span class="main">)</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> rel_comp <span class="free">match1</span> <span class="free">match2</span> <span class="bound">i'</span> <span class="skolem">s1</span> <span class="skolem">s3'</span> <span class="main">∧</span> lex_prodp <span class="free">order1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">order2</span> <span class="bound">i'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i'</span> <span class="bound">s1'</span><span class="main">.</span> <span class="var">?STEPS</span> <span class="bound">i'</span> <span class="bound">s1'</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?STALL</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i2'</span> <span class="bound">s2'</span><span class="main">.</span> <span class="free">step2</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s2</span> <span class="bound">s2'</span> <span class="main">∧</span> <span class="free">match2</span> <span class="bound">i2'</span> <span class="bound">s2'</span> <span class="skolem">s3'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2'</span></span> <span class="skolem"><span class="skolem">s2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step2</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s2</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match2</span> <span class="skolem">i2'</span> <span class="skolem">s2'</span> <span class="skolem">s3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> backward_simulation.lift_simulation_plus<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">step2</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s2</span> <span class="skolem">s2'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">match1</span> <span class="skolem">i1</span> <span class="skolem">s1</span> <span class="skolem">s2</span>›</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i2</span> <span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match1</span> <span class="bound">i2</span> <span class="bound">s1'</span> <span class="skolem">s2'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="skolem">s1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match1</span> <span class="skolem">i2</span> <span class="skolem">s1'</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?STEPS</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="skolem">i2'</span><span class="main">)</span> <span class="skolem">s1'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">match2</span> <span class="skolem">i2'</span> <span class="skolem">s2'</span> <span class="skolem">s3'</span>›</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_comp_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i2</span><span class="main">.</span> <span class="free">match1</span> <span class="bound">i2</span> <span class="skolem">s1</span> <span class="skolem">s2'</span> <span class="main">∧</span> <span class="free">order1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i2</span> <span class="skolem">i1</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">match1</span> <span class="skolem">i2''</span> <span class="skolem">s1</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">order1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">i2''</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?STALL</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> rel_comp_def i_def lex_prodp_def
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">match2</span> <span class="skolem">i2'</span> <span class="skolem">s2'</span> <span class="skolem">s3'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i2'</span><span class="main">.</span> <span class="free">match2</span> <span class="bound">i2'</span> <span class="skolem">s2</span> <span class="skolem">s3'</span> <span class="main">∧</span> <span class="free">order2</span> <span class="bound">i2'</span> <span class="skolem">i2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">match2</span> <span class="skolem">i2'</span> <span class="skolem">s2</span> <span class="skolem">s3'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">order2</span> <span class="skolem">i2'</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?STALL</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rel_comp_def i_def lex_prodp_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">match1</span> <span class="skolem">i1</span> <span class="skolem">s1</span> <span class="skolem">s2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rel_comp_pow</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_comp_pow</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_comp_pow</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free">r</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_comp_pow</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">r</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">rel_comp_pow</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> backward_simulation_pow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"backward_simulation <span class="free">step</span> <span class="free">step</span> <span class="free">final</span> <span class="free">final</span> <span class="free">order</span> <span class="free">match</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"backward_simulation <span class="free">step</span> <span class="free">step</span> <span class="free">final</span> <span class="free">final</span> <span class="main">(</span>lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span>rel_comp_pow <span class="free">match</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">intro_locales</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semantics <span class="free">step</span> <span class="free">final</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> backward_simulation.axioms assms<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"well_founded <span class="main">(</span>lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> backward_simulation.axioms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> lex_list_well_founded
    <span class="keyword1"><span class="command">using</span></span> well_founded.intro well_founded.wf wfP_trancl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"backward_simulation_axioms <span class="free">step</span> <span class="free">step</span> <span class="free">final</span> <span class="free">final</span> <span class="main">(</span>lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span>rel_comp_pow <span class="free">match</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">s1</span> <span class="skolem">s2</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rel_comp_pow <span class="free">match</span> <span class="skolem">is</span> <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="skolem">s2</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="skolem">s1</span>"</span></span> <span class="keyword1"><span class="command">thm</span></span> rel_comp_pow.induct
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span> <span class="quoted"><span class="skolem">s1</span></span> <span class="quoted"><span class="skolem">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rel_comp_pow.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> backward_simulation.match_final<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i1</span> <span class="skolem">i2</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">x</span> <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"3.prems"</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i1</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_comp_pow <span class="free">match</span> <span class="main">(</span><span class="skolem">i2</span> <span class="main">#</span> <span class="skolem">is</span><span class="main">)</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> match backward_simulation.match_final<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">s1</span> <span class="skolem">s3</span> <span class="skolem">s3'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rel_comp_pow <span class="free">match</span> <span class="skolem">is</span> <span class="skolem">s1</span> <span class="skolem">s3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">s3</span> <span class="skolem">s3'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">is'</span> <span class="bound">s1'</span><span class="main">.</span> <span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> length <span class="bound">is'</span> <span class="main">=</span> length <span class="skolem">is</span> <span class="main">∧</span> rel_comp_pow <span class="free">match</span> <span class="bound">is'</span> <span class="bound">s1'</span> <span class="skolem">s3'</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">is'</span><span class="main">.</span> rel_comp_pow <span class="free">match</span> <span class="bound">is'</span> <span class="skolem">s1</span> <span class="skolem">s3'</span> <span class="main">∧</span> lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">is'</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span> <span class="quoted"><span class="skolem">s1</span></span> <span class="quoted"><span class="skolem">s3</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s3'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rel_comp_pow.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s3</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> backward_simulation.simulation<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"2.prems"</span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span> <span class="bound">s1'</span><span class="main">.</span> <span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">i'</span> <span class="bound">s1'</span> <span class="skolem">s3'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="skolem">s1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i'</span> <span class="skolem">s1'</span> <span class="skolem">s3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="skolem">s1'</span> <span class="main">∧</span> rel_comp_pow <span class="free">match</span> <span class="main">[</span><span class="skolem">i'</span><span class="main">]</span> <span class="skolem">s1'</span> <span class="skolem">s3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> <span class="free">match</span> <span class="bound">i'</span> <span class="skolem">s1</span> <span class="skolem">s3'</span> <span class="main">∧</span> <span class="free">order</span> <span class="bound">i'</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i'</span> <span class="skolem">s1</span> <span class="skolem">s3'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">order</span> <span class="skolem">i'</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_comp_pow <span class="free">match</span> <span class="main">[</span><span class="skolem">i'</span><span class="main">]</span> <span class="skolem">s1</span> <span class="skolem">s3'</span> <span class="main">∧</span> lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">[</span><span class="skolem">i'</span><span class="main">]</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lexp_head tranclp.r_into_trancl<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">i1</span> <span class="skolem">i2</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">s1</span> <span class="skolem">s3</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"3.prems"</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i1</span> <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_comp_pow <span class="free">match</span> <span class="main">(</span><span class="skolem">i2</span> <span class="main">#</span> <span class="skolem">is</span><span class="main">)</span> <span class="skolem">s2</span> <span class="skolem">s3</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"3.IH"</span><span class="main">[</span><span class="operator">OF</span> 0 <span class="quoted">"3.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">is'</span> <span class="bound">s2'</span><span class="main">.</span> <span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s2</span> <span class="bound">s2'</span> <span class="main">∧</span> length <span class="bound">is'</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">i2</span> <span class="main">#</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">∧</span>
          rel_comp_pow <span class="free">match</span> <span class="bound">is'</span> <span class="bound">s2'</span> <span class="skolem">s3'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2'</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="skolem"><span class="skolem">s2'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s2</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">is'</span> <span class="main">=</span> length <span class="skolem">is</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_comp_pow <span class="free">match</span> <span class="main">(</span><span class="skolem">i2'</span> <span class="main">#</span> <span class="skolem">is'</span><span class="main">)</span> <span class="skolem">s2'</span> <span class="skolem">s3'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_length_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> backward_simulation.lift_simulation_plus<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s2</span> <span class="skolem">s2'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">match</span> <span class="skolem">i1</span> <span class="skolem">s1</span> <span class="skolem">s2</span>›</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i2</span> <span class="bound">s1'</span><span class="main">.</span> <span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">i2</span> <span class="bound">s1'</span> <span class="skolem">s2'</span>"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_comp_pow <span class="free">match</span> <span class="main">(</span><span class="skolem">i2'</span> <span class="main">#</span> <span class="skolem">is'</span><span class="main">)</span> <span class="skolem">s2'</span> <span class="skolem">s3'</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">is'</span> <span class="main">=</span> length <span class="skolem">is</span>›</span></span> length_Cons rel_comp_pow.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i2</span><span class="main">.</span> <span class="free">match</span> <span class="bound">i2</span> <span class="skolem">s1</span> <span class="skolem">s2'</span> <span class="main">∧</span> <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i2</span> <span class="skolem">i1</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i1'</span> <span class="skolem">s1</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">i1'</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_comp_pow <span class="free">match</span> <span class="main">(</span><span class="skolem">i1'</span> <span class="main">#</span> <span class="skolem">i2'</span> <span class="main">#</span> <span class="skolem">is'</span><span class="main">)</span> <span class="skolem">s1</span> <span class="skolem">s3'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_comp_pow <span class="free">match</span> <span class="main">(</span><span class="skolem">i2'</span> <span class="main">#</span> <span class="skolem">is'</span><span class="main">)</span> <span class="skolem">s2'</span> <span class="skolem">s3'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span><span class="skolem">i1'</span> <span class="main">#</span> <span class="skolem">i2'</span> <span class="main">#</span> <span class="skolem">is'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i1</span> <span class="main">#</span> <span class="skolem">i2</span> <span class="main">#</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">i1'</span> <span class="skolem">i1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">is'</span> <span class="main">=</span> length <span class="skolem">is</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lexp_head<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> rel_comp_pow <span class="free">match</span> <span class="bound">i'</span> <span class="skolem">s2</span> <span class="skolem">s3'</span> <span class="main">∧</span> lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">i'</span> <span class="main">(</span><span class="skolem">i2</span> <span class="main">#</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i2'</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"rel_comp_pow <span class="free">match</span> <span class="main">(</span><span class="skolem">i2'</span> <span class="main">#</span> <span class="skolem">is'</span><span class="main">)</span> <span class="skolem">s2</span> <span class="skolem">s3'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span><span class="skolem">i2'</span> <span class="main">#</span> <span class="skolem">is'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i2</span> <span class="main">#</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lexp.simps<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">match</span> <span class="skolem">i1</span> <span class="skolem">s1</span> <span class="skolem">s2</span>›</span></span> lexp.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rel_comp_pow.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">is'</span> <span class="bound">s1'</span><span class="main">.</span> <span class="free">step</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> rel_comp_pow <span class="free">match</span> <span class="bound">is'</span> <span class="bound">s1'</span> <span class="skolem">s3'</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">is'</span><span class="main">.</span> rel_comp_pow <span class="free">match</span> <span class="bound">is'</span> <span class="skolem">s1</span> <span class="skolem">s3'</span> <span class="main">∧</span> lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">is'</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lockstep_backward_simulation</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lockstep_backward_simulation</span> <span class="free"><span class="bound"><span class="entity">step1</span></span></span> <span class="free"><span class="bound"><span class="entity">step2</span></span></span> <span class="free"><span class="bound"><span class="entity">match</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s2'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">match</span></span></span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">step2</span></span></span> <span class="bound">s2</span> <span class="bound">s2'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">step1</span></span></span> <span class="bound">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">match</span></span></span> <span class="bound">s1'</span> <span class="bound">s2'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">plus_backward_simulation</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_backward_simulation</span> <span class="free"><span class="bound"><span class="entity">step1</span></span></span> <span class="free"><span class="bound"><span class="entity">step2</span></span></span> <span class="free"><span class="bound"><span class="entity">match</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s2'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">match</span></span></span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">step2</span></span></span> <span class="bound">s2</span> <span class="bound">s2'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">step1</span></span></span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">match</span></span></span> <span class="bound">s1'</span> <span class="bound">s2'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lockstep_backward_simulation <span class="free">step1</span> <span class="free">step2</span> <span class="free">match</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plus_backward_simulation <span class="free">step1</span> <span class="free">step2</span> <span class="free">match</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> plus_backward_simulation_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s2'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">step2</span> <span class="skolem">s2</span> <span class="skolem">s2'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step1</span> <span class="skolem">s1</span> <span class="skolem">s1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">s1'</span> <span class="skolem">s2'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> lockstep_backward_simulation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">s1'</span> <span class="skolem">s2'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lockstep_to_plus_backward_simulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    lockstep_simulation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s2'</span><span class="main">.</span> <span class="free">match</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="main">⟹</span> <span class="free">step2</span> <span class="bound">s2</span> <span class="bound">s2'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span> <span class="bound">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">s1'</span> <span class="bound">s2'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">step2</span> <span class="free">s2</span> <span class="free">s2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">s1'</span> <span class="free">s2'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step1</span> <span class="free">s1</span> <span class="skolem">s1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">s1'</span> <span class="free">s2'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lockstep_simulation<span class="main">[</span><span class="operator">OF</span> match step<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lockstep_to_option_backward_simulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    lockstep_simulation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s2'</span><span class="main">.</span> <span class="free">match</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="main">⟹</span> <span class="free">step2</span> <span class="bound">s2</span> <span class="bound">s2'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span> <span class="bound">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">s1'</span> <span class="bound">s2'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">step2</span> <span class="free">s2</span> <span class="free">s2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span> <span class="free">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">s1'</span> <span class="free">s2'</span><span class="main">)</span> <span class="main">∨</span> <span class="free">match</span> <span class="free">s1</span> <span class="free">s2'</span> <span class="main">∧</span> <span class="free">measure</span> <span class="free">s2'</span> <span class="main">&lt;</span> <span class="free">measure</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lockstep_simulation<span class="main">[</span><span class="operator">OF</span> match step<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_to_star_backward_simulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    star_simulation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s2'</span><span class="main">.</span> <span class="free">match</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="main">⟹</span> <span class="free">step2</span> <span class="bound">s2</span> <span class="bound">s2'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">s1'</span> <span class="bound">s2'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">step2</span> <span class="free">s2</span> <span class="free">s2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">s1'</span><span class="main">.</span> <span class="free">step1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">s1</span> <span class="bound">s1'</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">s1'</span> <span class="free">s2'</span><span class="main">)</span> <span class="main">∨</span> <span class="free">match</span> <span class="free">s1</span> <span class="free">s2'</span> <span class="main">∧</span> <span class="free">measure</span> <span class="free">s2'</span> <span class="main">&lt;</span> <span class="free">measure</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> star_simulation<span class="main">[</span><span class="operator">OF</span> match step<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lockstep_to_plus_forward_simulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state1</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state2</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    lockstep_simulation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">s2'</span><span class="main">.</span> <span class="free">match</span> <span class="bound">s1</span> <span class="bound">s2</span> <span class="main">⟹</span> <span class="free">step1</span> <span class="bound">s1</span> <span class="free">s1'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s2'</span><span class="main">.</span> <span class="free">step2</span> <span class="bound">s2</span> <span class="bound">s2'</span> <span class="main">∧</span> <span class="free">match</span> <span class="free">s1'</span> <span class="bound">s2'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">step1</span> <span class="free">s1</span> <span class="free">s1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s2'</span><span class="main">.</span> <span class="free">step2</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">s2</span> <span class="bound">s2'</span> <span class="main">∧</span> <span class="free">match</span> <span class="free">s1'</span> <span class="bound">s2'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step2</span> <span class="free">s2</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free">s1'</span> <span class="skolem">s2'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lockstep_simulation<span class="main">[</span><span class="operator">OF</span> match step<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Compiler">
<div class="head">
<h1>Theory Compiler</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Compiler Between Static Representations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Compiler
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Language.html">Language</a> <a href="Simulation.html">Simulation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">option_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇚</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">⇚</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> Option.bind <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">option_comp_pow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">option_comp_pow</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">option_comp_pow</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">option_comp_pow</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">option_comp_pow</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⇚</span> <span class="free">f</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> compiler <span class="main">=</span>
  L1<span class="main">:</span> language <span class="quoted"><span class="free">step1</span></span> <span class="quoted"><span class="free">final1</span></span> <span class="quoted"><span class="free">load1</span></span> <span class="main">+</span>
  L2<span class="main">:</span> language <span class="quoted"><span class="free">step2</span></span> <span class="quoted"><span class="free">final2</span></span> <span class="quoted"><span class="free">load2</span></span> <span class="main">+</span>
  backward_simulation <span class="quoted"><span class="free">step1</span></span> <span class="quoted"><span class="free">step2</span></span> <span class="quoted"><span class="free">final1</span></span> <span class="quoted"><span class="free">final2</span></span> <span class="quoted"><span class="free">order</span></span> <span class="quoted"><span class="free">match</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">step1</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">step2</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">final1</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">final2</span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">load1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog1</span> <span class="main">⇒</span> <span class="tfree">'state1</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">load2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog2</span> <span class="main">⇒</span> <span class="tfree">'state2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">⇒</span> <span class="tfree">'index</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">match</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">compile</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prog1</span> <span class="main">⇒</span> <span class="tfree">'prog2</span> option"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    compile_load<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="free">p1</span> <span class="main">=</span> Some <span class="free">p2</span> <span class="main">⟹</span> <span class="free">load2</span> <span class="free">p2</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s1</span> <span class="bound">i</span><span class="main">.</span> <span class="free">load1</span> <span class="free">p1</span> <span class="bound">s1</span> <span class="main">∧</span> <span class="free">match</span> <span class="bound">i</span> <span class="bound">s1</span> <span class="free">s2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> compiler<span class="antiquote"><span class="antiquote">}</span></span></span></span> locale relates two languages, L1 and L2, by a backward simulation and provides a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">compile</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> partial function from a concrete program in L1 to a concrete program in L2.
The only assumption is that a successful compilation results in a program which, when loaded, is equivalent to the loaded initial program.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preservation of behaviour›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> behaviour_preservation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    compiles<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="free">p1</span> <span class="main">=</span> Some <span class="free">p2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    behaves<span class="main">:</span> <span class="quoted"><span class="quoted">"L2.behaves <span class="free">p2</span> <span class="free">b2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    not_wrong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_wrong <span class="free">b2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b1</span> <span class="bound">i</span><span class="main">.</span>  L1.behaves <span class="free">p1</span> <span class="bound">b1</span> <span class="main">∧</span> rel_behaviour <span class="main">(</span><span class="free">match</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">b1</span> <span class="free">b2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">load2</span> <span class="free">p2</span> <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"L2.sem_behaves <span class="skolem">s2</span> <span class="free">b2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> behaves L2.behaves_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">load1</span> <span class="free">p1</span> <span class="skolem">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> compile_load<span class="main">[</span><span class="operator">OF</span> compiles <span class="quoted"><span class="quoted">‹<span class="free">load2</span> <span class="free">p2</span> <span class="skolem">s2</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> simulation_behaviour<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹L2.sem_behaves <span class="skolem">s2</span> <span class="free">b2</span>›</span></span> not_wrong <span class="quoted"><span class="quoted">‹<span class="free">match</span> <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s2</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> L1.behaves_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Composition of compilers›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compiler_composition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"compiler <span class="free">step1</span> <span class="free">step2</span> <span class="free">final1</span> <span class="free">final2</span> <span class="free">load1</span> <span class="free">load2</span> <span class="free">order1</span> <span class="free">match1</span> <span class="free">compile1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"compiler <span class="free">step2</span> <span class="free">step3</span> <span class="free">final2</span> <span class="free">final3</span> <span class="free">load2</span> <span class="free">load3</span> <span class="free">order2</span> <span class="free">match2</span> <span class="free">compile2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compiler <span class="free">step1</span> <span class="free">step3</span> <span class="free">final1</span> <span class="free">final3</span> <span class="free">load1</span> <span class="free">load3</span>
    <span class="main">(</span>lex_prodp <span class="free">order1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">order2</span><span class="main">)</span> <span class="main">(</span>rel_comp <span class="free">match1</span> <span class="free">match2</span><span class="main">)</span> <span class="main">(</span><span class="free">compile2</span> <span class="main">⇚</span> <span class="free">compile1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> compiler.intro<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"language <span class="free">step1</span> <span class="free">final1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> compiler.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"language <span class="free">step3</span> <span class="free">final3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> compiler.axioms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"backward_simulation <span class="free">step1</span> <span class="free">step3</span> <span class="free">final1</span> <span class="free">final3</span>
     <span class="main">(</span>lex_prodp <span class="free">order1</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">order2</span><span class="main">)</span> <span class="main">(</span>rel_comp <span class="free">match1</span> <span class="free">match2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> backward_simulation_composition<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> compiler.axioms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compiler_axioms <span class="free">load1</span> <span class="free">load3</span> <span class="main">(</span>rel_comp <span class="free">match1</span> <span class="free">match2</span><span class="main">)</span> <span class="main">(</span><span class="free">compile2</span> <span class="main">⇚</span> <span class="free">compile1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p1</span> <span class="skolem">p3</span> <span class="skolem">s3</span>
    <span class="keyword3"><span class="command">assume</span></span>
      compile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">compile2</span> <span class="main">⇚</span> <span class="free">compile1</span><span class="main">)</span> <span class="skolem">p1</span> <span class="main">=</span> Some <span class="skolem">p3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      load<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">load3</span> <span class="skolem">p3</span> <span class="skolem">s3</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">compile1</span> <span class="skolem">p1</span> <span class="main">=</span> Some <span class="skolem">p2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">compile2</span> <span class="skolem">p2</span> <span class="main">=</span> Some <span class="skolem">p3</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> compile <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_eq_Some_conv option_comp_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> l2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">load2</span> <span class="skolem">p2</span> <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match2</span> <span class="skolem">i'</span> <span class="skolem">s2</span> <span class="skolem">s3</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> compiler.compile_load<span class="main">,</span> <span class="operator">OF</span> c2 load<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">load1</span> <span class="skolem">p1</span> <span class="skolem">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match1</span> <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> compiler.compile_load<span class="main">,</span> <span class="operator">OF</span> c1 l2<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s1</span> <span class="bound">i</span><span class="main">.</span> <span class="free">load1</span> <span class="skolem">p1</span> <span class="bound">s1</span> <span class="main">∧</span> rel_comp <span class="free">match1</span> <span class="free">match2</span> <span class="bound">i</span> <span class="bound">s1</span> <span class="skolem">s3</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compiler_composition_pow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"compiler <span class="free">step</span> <span class="free">step</span> <span class="free">final</span> <span class="free">final</span> <span class="free">load</span> <span class="free">load</span> <span class="free">order</span> <span class="free">match</span> <span class="free">compile</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compiler <span class="free">step</span> <span class="free">step</span> <span class="free">final</span> <span class="free">final</span> <span class="free">load</span> <span class="free">load</span>
    <span class="main">(</span>lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span>rel_comp_pow <span class="free">match</span><span class="main">)</span> <span class="main">(</span>option_comp_pow <span class="free">compile</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> option_comp_pow.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> compiler.axioms compiler.intro compiler_axioms.intro backward_simulation_pow<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> compiler.intro<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compiler_axioms <span class="free">load</span> <span class="free">load</span> <span class="main">(</span>rel_comp_pow <span class="free">match</span><span class="main">)</span> <span class="main">(</span>option_comp_pow <span class="free">compile</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="skolem">s2</span>
      <span class="keyword3"><span class="command">assume</span></span>
        <span class="quoted"><span class="quoted">"option_comp_pow <span class="free">compile</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">p1</span> <span class="main">=</span> Some <span class="skolem">p2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">load</span> <span class="skolem">p2</span> <span class="skolem">s2</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s1</span> <span class="bound">i</span><span class="main">.</span> <span class="free">load</span> <span class="skolem">p1</span> <span class="bound">s1</span> <span class="main">∧</span> rel_comp_pow <span class="free">match</span> <span class="bound">i</span> <span class="bound">s1</span> <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> compiler.compile_load<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option_comp_pow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rel_comp_pow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms compiler.axioms backward_simulation_pow<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> compiler.intro<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compiler_axioms <span class="free">load</span> <span class="free">load</span> <span class="main">(</span>rel_comp_pow <span class="free">match</span><span class="main">)</span> <span class="main">(</span>option_comp_pow <span class="free">compile</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p1</span> <span class="skolem">p3</span> <span class="skolem">s3</span>
      <span class="keyword3"><span class="command">assume</span></span>
        <span class="quoted"><span class="quoted">"option_comp_pow <span class="free">compile</span>  <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p1</span> <span class="main">=</span> Some <span class="skolem">p3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">load</span> <span class="skolem">p3</span> <span class="skolem">s3</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="skolem">p1</span> <span class="main">=</span> Some <span class="skolem">p2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        comp_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"option_comp_pow <span class="free">compile</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span> <span class="skolem">p2</span> <span class="main">=</span> Some <span class="skolem">p3</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_comp_def bind_eq_Some_conv<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">load</span> <span class="skolem">p2</span> <span class="skolem">s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rel_comp_pow <span class="free">match</span> <span class="skolem">i'</span> <span class="skolem">s2</span> <span class="skolem">s3</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> compiler.compile_load<span class="main">[</span><span class="operator">OF</span> <span class="quoted">"3.IH"</span> comp_IH <span class="quoted"><span class="quoted">‹<span class="free">load</span> <span class="skolem">p3</span> <span class="skolem">s3</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">load</span> <span class="skolem">p1</span> <span class="skolem">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> compiler.compile_load<span class="main">[</span><span class="operator">OF</span> assms comp <span class="quoted"><span class="quoted">‹<span class="free">load</span> <span class="skolem">p2</span> <span class="skolem">s2</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_comp_pow <span class="free">match</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">#</span> <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">s1</span> <span class="skolem">s3</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rel_comp_pow <span class="free">match</span> <span class="skolem">i'</span> <span class="skolem">s2</span> <span class="skolem">s3</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">match</span> <span class="skolem">i</span> <span class="skolem">s1</span> <span class="skolem">s2</span>›</span></span> rel_comp_pow.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s1</span> <span class="bound">i</span><span class="main">.</span> <span class="free">load</span> <span class="skolem">p1</span> <span class="bound">s1</span> <span class="main">∧</span> rel_comp_pow <span class="free">match</span> <span class="bound">i</span> <span class="bound">s1</span> <span class="skolem">s3</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms compiler.axioms backward_simulation_pow<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Fixpoint">
<div class="head">
<h1>Theory Fixpoint</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fixpoint of Converging Program Transformations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Fixpoint
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Compiler.html">Compiler</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">fixpoint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fixpoint</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> <span class="free">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None <span class="main">|</span>
      Some <span class="bound">x'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free">m</span> <span class="bound">x'</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">fixpoint</span> <span class="bound">x'</span> <span class="keyword1">else</span> Some <span class="bound">x'</span>
  <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="free">m</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>measure <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">x'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">x'</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> measure <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fixpoint_to_comp_pow<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fixpoint <span class="free">m</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> option_comp_pow <span class="free">f</span> <span class="bound">n</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fixpoint.induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fixpoint.simps option.case_eq_if option_comp_pow.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">a</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fixpoint <span class="free">m</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">[</span><span class="operator">OF</span> Some True<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Some bind.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> old.nat.exhaust option_comp_def option_comp_pow.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> Some
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option_comp_pow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fixpoint_eq_comp_pow<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> fixpoint <span class="free">m</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> option_comp_pow <span class="free">f</span> <span class="bound">n</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fixpoint_to_comp_pow<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compiler_composition_fixpoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"compiler <span class="free">step</span> <span class="free">step</span> <span class="free">final</span> <span class="free">final</span> <span class="free">load</span> <span class="free">load</span> <span class="free">order</span> <span class="free">match</span> <span class="free">compile</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compiler <span class="free">step</span> <span class="free">step</span> <span class="free">final</span> <span class="free">final</span> <span class="free">load</span> <span class="free">load</span>
    <span class="main">(</span>lexp <span class="free">order</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span>rel_comp_pow <span class="free">match</span><span class="main">)</span> <span class="main">(</span>fixpoint <span class="free">m</span> <span class="free">compile</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> compiler.intro<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compiler_axioms <span class="free">load</span> <span class="free">load</span> <span class="main">(</span>rel_comp_pow <span class="free">match</span><span class="main">)</span> <span class="main">(</span>fixpoint <span class="free">m</span> <span class="free">compile</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="skolem">s2</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fixpoint <span class="free">m</span> <span class="free">compile</span> <span class="skolem">p1</span> <span class="main">=</span> Some <span class="skolem">p2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">load</span> <span class="skolem">p2</span> <span class="skolem">s2</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fixpoint <span class="free">m</span> <span class="free">compile</span> <span class="skolem">p1</span> <span class="main">=</span> option_comp_pow <span class="free">compile</span> <span class="skolem">n</span> <span class="skolem">p1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fixpoint_eq_comp_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s1</span> <span class="bound">i</span><span class="main">.</span> <span class="free">load</span> <span class="skolem">p1</span> <span class="bound">s1</span> <span class="main">∧</span> rel_comp_pow <span class="free">match</span> <span class="bound">i</span> <span class="bound">s1</span> <span class="skolem">s2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fixpoint <span class="free">m</span> <span class="free">compile</span> <span class="skolem">p1</span> <span class="main">=</span> Some <span class="skolem">p2</span>›</span></span> assms compiler.compile_load compiler_composition_pow
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">load</span> <span class="skolem">p2</span> <span class="skolem">s2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms compiler.axioms backward_simulation_pow<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>