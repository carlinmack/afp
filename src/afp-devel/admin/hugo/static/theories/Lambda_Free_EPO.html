<div id="Embeddings">
<div class="head">
<h1>Theory Embeddings</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Embedding Relation for Lambda-Free Higher-Order Terms
    Author:      Alexander Bentkamp &lt;a.bentkamp at vu.nl&gt;, 2018
    Maintainer:  Alexander Bentkamp &lt;a.bentkamp at vu.nl&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Embedding Relation for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Embeddings
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Lambda_Free_RPOs/Lambda_Free_Term.html">Lambda_Free_RPOs.Lambda_Free_Term</a> <a href="../Lambda_Free_RPOs/Extension_Orders.html">Lambda_Free_RPOs.Extension_Orders</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Positions of terms›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> dir <span class="main">=</span> Left <span class="main">|</span> Right

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">position_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> dir list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  position_of_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">position_of</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  position_of_Hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">position_of</span> <span class="main">(</span>Hd <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">#</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
  position_of_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">position_of</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>Left <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">position_of</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span>"</span></span> <span class="main">|</span>
  position_of_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">position_of</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>Right <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">position_of</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dir <span class="main">⇒</span> dir"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opp</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> Right <span class="keyword1">then</span> Left <span class="keyword1">else</span> Right<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> opp_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"opp Right <span class="main">=</span> Left"</span></span> 
  <span class="quoted"><span class="quoted">"opp Left <span class="main">=</span> Right"</span></span>
  <span class="keyword1"><span class="command">using</span></span> opp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> shallower_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="free">q</span> <span class="main">@</span> <span class="main">[</span><span class="free">dq</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">dp</span><span class="main">]</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> position_of_Hd Nil_is_append_conv list.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> position_of_Nil position_of_left
        position_of_right dir.exhaust self_append_conv2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> position_of_Hd position_of_left append_Cons args.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> position_of_Hd position_of_right append_Cons args.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_position_replicate_num_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> position_of <span class="free">t</span> <span class="main">(</span>replicate <span class="main">(</span>num_args <span class="free">t</span><span class="main">)</span> Left <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"num_args <span class="free">t</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_Hd <span class="skolem">t</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.hyps"</span> args_Nil_iff_is_Hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> position_of.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snoc_eq_iff_butlast tm.discI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">t</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> args_Nil_iff_is_Hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> position_of <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> dir.Left <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">t</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc Suc_inject args.elims length_0_conv length_append_singleton nat.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ds</span><span class="main">.</span> replicate <span class="main">(</span>num_args <span class="skolem">t</span><span class="main">)</span> dir.Left <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span> <span class="main">≠</span> dir.Right <span class="main">#</span> <span class="bound">ds</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> args_Nil_iff_is_Hd dir.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hd_append hd_replicate length_0_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> replicate_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> position_of.elims<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>replicate <span class="main">(</span>num_args <span class="skolem">t</span><span class="main">)</span> dir.Left <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> position_of_left <span class="quoted"><span class="quoted">‹<span class="main">¬</span> position_of <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> dir.Left <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>›</span></span> 
    <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> append_Cons args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_append_singleton replicate_Suc tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> shorten_position<span class="main">:</span><span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> position_of <span class="free">t</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> position_of_Nil append_assoc append_butlast_last_id shallower_pos<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Embedding step›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Embedding step at a given position. If the position is not present, default to identity.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">emb_step_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dir list <span class="main">⇒</span> dir <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  emb_step_at_left<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">emb_step_at</span> <span class="main">[]</span> Left <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> emb_step_at_right<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">emb_step_at</span> <span class="main">[]</span> Right <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> emb_step_at_left_context<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">emb_step_at</span> <span class="main">(</span>Left <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> App <span class="main">(</span><span class="free">emb_step_at</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> emb_step_at_right_context<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">emb_step_at</span> <span class="main">(</span>Right <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free">emb_step_at</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> emb_step_at_head<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">emb_step_at</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> Hd <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">emb_step_at'</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> emb_step_at <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> emb_step_at_induct <span class="main">=</span> emb_step_at.induct<span class="main">[</span><span class="operator">case_names</span> left right left_context right_context head<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_at_is_App<span class="main">:</span><span class="quoted"><span class="quoted">"emb_step_at <span class="free">p</span> <span class="free">d</span> <span class="free">u</span> <span class="main">≠</span> <span class="free">u</span> <span class="main">⟹</span> is_App <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> is_Hd_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of an embedding step without using positions.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">emb_step</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>"</span></span> <span class="main">|</span>
  right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span> <span class="main">|</span>
  context_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  context_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The two definitions of an embedding step are equivalent:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"emb_step <span class="free">t</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> emb_step_at <span class="bound">p</span> <span class="bound">d</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> emb_step_at <span class="bound">p</span> <span class="bound">d</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>emb_step.induct<span class="main">)</span> 
    <span class="keyword3"><span class="command">case</span></span> left
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right emb_step_at.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> leD le_add_same_cancel1 le_imp_less_Suc tm.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> zero_order<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> right
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral add_le_cancel_left antisym emb_step_at.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> le_add_same_cancel2 le_imp_less_Suc length_greater_0_conv list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tm.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> zero_order<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>context_left <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> context_left.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> emb_step_at <span class="main">(</span>Left <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">(</span>App <span class="skolem">t</span> <span class="bound">u</span><span class="main">)</span> <span class="main">=</span> App <span class="skolem">s</span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> context_left.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>context_right <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> context_right.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> emb_step_at <span class="main">(</span>Right <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">(</span>App <span class="bound">u</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> App <span class="bound">u</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> context_right.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> emb_step_at <span class="bound">p</span> <span class="bound">d</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> emb_step_at <span class="bound">p</span> <span class="bound">d</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>emb_step_at_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">u1</span> <span class="skolem">u2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> left<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> emb_step_at.elims<span class="main">)</span> 
        <span class="keyword1"><span class="command">using</span></span> emb_step.left <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right <span class="skolem">u1</span> <span class="skolem">u2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">using</span></span> right<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> emb_step_at.elims<span class="main">)</span> 
        <span class="keyword1"><span class="command">using</span></span> emb_step.right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left_context <span class="skolem">u1</span> <span class="skolem">u2</span> <span class="skolem">t'</span> <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_left_context emb_step.simps emb_step_at_is_App left_context.hyps left_context.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> left_context.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
            tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right_context <span class="skolem">u1</span> <span class="skolem">u2</span> <span class="skolem">t'</span> <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_right_context emb_step.simps emb_step_at_is_App right_context.hyps right_context.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> right_context.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>          
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>head <span class="skolem">uu</span> <span class="skolem">uv</span> <span class="skolem">h</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> head<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> emb_step_at.elims<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> emb_step.left <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">using</span></span> emb_step.right <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">using</span></span> head.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span>arg <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_hsize<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> hsize <span class="free">t</span> <span class="main">&gt;</span> hsize <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> emb_step.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> emb_step_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> vars <span class="free">s</span> <span class="main">⊆</span> vars <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> emb_step.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_equiv'<span class="main">:</span> <span class="quoted"><span class="quoted">"emb_step <span class="free">t</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> emb_step_at' <span class="bound">p</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> butlast_snoc emb_step_equiv last_snoc
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snoc_eq_iff_butlast<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> position_if_emb_step_at<span class="main">:</span> <span class="quoted"><span class="quoted">"emb_step_at <span class="free">p</span> <span class="free">d</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">u</span> <span class="main">⟹</span> position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_head position_of_Nil append_self_conv2 list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> position_of.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_at_if_position<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> emb_step_at <span class="free">p</span> <span class="free">d</span> <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emb_step.left emb_step.right<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> context_left context_right<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> context_left context_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Embedding relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of an embedding as a sequence of embedding steps at given positions:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">emb_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dir list <span class="main">×</span> dir<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  emb_at_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">emb_at</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  emb_at_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">emb_at</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> emb_step_at <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="free">emb_at</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of an embedding without using positions:›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">emb</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">emb_neq</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊳<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">emb_neq</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The two definitions coincide:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ps</span><span class="main">.</span> emb_at <span class="bound">ps</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ps</span><span class="main">.</span> emb_at <span class="bound">ps</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ps</span><span class="main">.</span> emb_at <span class="bound">ps</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"emb_at <span class="skolem">ps</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emb.refl<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ps</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> emb_at.elims<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps emb.simps emb_step_equiv list.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ps</span><span class="main">.</span> emb_at <span class="bound">ps</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> emb.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> emb_at_Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_at_Cons emb_step_equiv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_at_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"emb_at <span class="free">ps</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> emb_at <span class="free">qs</span> <span class="free">u</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟹</span> emb_at <span class="main">(</span><span class="free">qs</span> <span class="main">@</span> <span class="free">ps</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_at_trans emb_equiv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_is_emb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> emb.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_hsize<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> hsize <span class="free">t</span> <span class="main">≥</span> hsize <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> emb.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> emb_step_hsize <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_prepend_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emb_step_is_emb emb_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_emb<span class="main">:</span> <span class="quoted"><span class="quoted">"sub <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>sub.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_refl <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emb.refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_fun <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> emb_prepend_step right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_arg <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> emb_prepend_step left <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sequence_emb_steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">us</span><span class="main">.</span> <span class="bound">us</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">us</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∧</span> last <span class="bound">us</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">us</span> <span class="main">⟶</span> <span class="bound">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">us</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">us</span><span class="main">.</span> <span class="bound">us</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">us</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∧</span> last <span class="bound">us</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">us</span> <span class="main">⟶</span> <span class="bound">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">us</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>emb.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc_less_eq add.right_neutral add_Suc_right append_Nil last_snoc list.sel<span class="main">(</span>1<span class="main">)</span> list.size<span class="main">(</span>3<span class="main">)</span> list.size<span class="main">(</span>4<span class="main">)</span> not_less_zero
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
      <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> 
      <span class="quoted"><span class="quoted">"last <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">us</span> <span class="main">⟶</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">us</span> <span class="main">!</span> Suc <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_less_eq <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">us</span> <span class="main">⟶</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">us</span> <span class="main">!</span> Suc <span class="bound">i</span>›</span></span> <span class="quoted"><span class="quoted">‹last <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> 
           append_butlast_last_id length_append_singleton less_antisym nth_append nth_append_length step.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span><span class="main">.</span> <span class="bound">us</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">us</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∧</span> last <span class="bound">us</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">us</span> <span class="main">⟶</span> <span class="bound">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">us</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span><span class="main">.</span> <span class="bound">us</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">us</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∧</span> last <span class="bound">us</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">us</span> <span class="main">⟶</span> <span class="bound">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">us</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">us</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">us</span> <span class="main">⟶</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">us</span> <span class="main">!</span> Suc <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> emb.refl emb_step_is_emb emb_trans hd_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_induct_reverse <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> refl step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
emb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">u</span> <span class="main">⟹</span> <span class="bound">u</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">u</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> 
<span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">us</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">us</span> <span class="main">⟶</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">us</span> <span class="main">!</span> Suc <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> emb sequence_emb_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">us'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us'</span> <span class="main">==</span> tl <span class="skolem">us</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">us'</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">us'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">us'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span><span class="main">[</span><span class="free">t</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">us'</span><span class="main">)</span> <span class="main">!</span> Suc <span class="bound">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">us</span> <span class="main">=</span> <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹last <span class="skolem">us</span> <span class="main">=</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">us</span> <span class="main">⟶</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">us</span> <span class="main">!</span> Suc <span class="bound">i</span>›</span></span> <span class="quoted"><span class="quoted">‹hd <span class="skolem">us</span> <span class="main">=</span> <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">us</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> us'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">us'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">us'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">a</span> <span class="free">s</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_mono append_Cons append_Nil last.simps length_Cons list.discI nth_Cons_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">a</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sequence_emb_steps 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil last_append list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> local.Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_Cons_Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">a</span> <span class="free">s</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_cases_reverse <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> refl step<span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">t'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">t'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">t'</span> <span class="bound">u</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">t'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="bound">t'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">u</span> <span class="main">⟹</span> <span class="bound">u</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>emb_induct_reverse<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> vars <span class="free">s</span> <span class="main">⊆</span> vars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> emb.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> emb_step_vars <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_emb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> ground <span class="free">t</span> <span class="main">⟹</span> ground <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emb_vars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> arg_emb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sub_args sub_emb<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_at_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"emb_step_at <span class="free">p</span> <span class="free">d</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">ρ</span> <span class="main">(</span>emb_step_at <span class="free">p</span> <span class="free">d</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> App <span class="skolem">t1</span> <span class="skolem">t2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> position_of_Hd append_Nil tm.collapse<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> App <span class="skolem">t1</span> <span class="skolem">t2</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> App <span class="skolem">t1</span> <span class="skolem">t2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> position_of.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst <span class="free">ρ</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> subst <span class="free">ρ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>emb_step.induct<span class="main"><span class="keyword3">;</span></span>
      <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emb_step.left emb_step.right context_left context_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span>  <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst <span class="free">ρ</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> subst <span class="free">ρ</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>emb.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emb.refl<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> emb.step emb_step_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> emb_hsize_neq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"hsize <span class="free">t</span> <span class="main">&gt;</span> hsize <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> emb_cases_reverse emb_hsize emb_step_hsize leD le_imp_less_or_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹How are positions preserved under embedding steps?›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Disjunct positions are preserved: For example, [L,R] is a position of f a (g b). When performing
an embedding step at [R,R] to obtain f a b, the position [L,R] still exists. (More precisely, it even
contains the same subterm, namely a.)›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_emb_step_at_disjunct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
<span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">q</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>"</span></span>
<span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d1</span><span class="main">]</span><span class="main">)</span> <span class="main">⟷</span> position_of  <span class="main">(</span>emb_step_at <span class="free">q</span> <span class="free">d2</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d1</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">+</span> length <span class="free">q</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_Hd <span class="skolem">t</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_is_App less.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> take_eq_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="skolem"><span class="skolem">p0</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">q0</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> App <span class="skolem">t1</span> <span class="skolem">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p0</span> <span class="main">#</span> <span class="skolem">p'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q0</span> <span class="main">#</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.collapse tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p0</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">q0</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> less.hyps less.prems<span class="main">(</span>1<span class="main">)</span> less.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Even if only the last element of a position differs from the position of an embedding step, that
position is preserved. For example, [L] is a position of f (g b). After performing an embedding step
at [R,R] to obtain f b, the position [L] still exists. (More precisely, it even
contains the same subterm, namely f.)›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_emb_step_at_opp<span class="main">:</span>
    <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span><span class="main">@</span><span class="main">[</span><span class="free">d1</span><span class="main">]</span><span class="main">)</span> <span class="main">⟷</span> position_of <span class="main">(</span>emb_step_at <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span>opp <span class="free">d1</span><span class="main">]</span> <span class="main">@</span> <span class="free">q</span><span class="main">)</span> <span class="free">d2</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">@</span><span class="main">[</span><span class="free">d1</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">d1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_left_context position_of_left append_Cons emb_step_at_is_App tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_right_context position_of_right append_Cons emb_step_at_is_App tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Positions are preserved under embedding steps below them:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_emb_step_at_nested<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"position_of <span class="main">(</span>emb_step_at <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d1</span><span class="main">]</span> <span class="main">@</span> <span class="free">q</span><span class="main">)</span> <span class="free">d2</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d1</span><span class="main">]</span><span class="main">)</span> <span class="main">⟷</span> position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d1</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">d1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Swapping embedding steps"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The order of embedding steps at disjunct position can be changed freely:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_disjunct_emb_step_at<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">≤</span> length <span class="free">q</span> <span class="main">⟹</span> take <span class="main">(</span>length <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">q</span> <span class="main">≤</span> length <span class="free">p</span> <span class="main">⟹</span>take <span class="main">(</span>length <span class="free">q</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"emb_step_at <span class="free">q</span> <span class="free">d2</span> <span class="main">(</span>emb_step_at <span class="free">p</span> <span class="free">d1</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> emb_step_at <span class="free">p</span> <span class="free">d1</span> <span class="main">(</span>emb_step_at <span class="free">q</span> <span class="free">d2</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">+</span> length <span class="free">q</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_Hd <span class="skolem">t</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> emb_step_at_is_App less.prems<span class="main">(</span>1<span class="main">)</span> less.prems<span class="main">(</span>2<span class="main">)</span> list.size<span class="main">(</span>3<span class="main">)</span> take_eq_Nil 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_zero_eq nat_le_linear<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="skolem"><span class="skolem">p0</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">q0</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> App <span class="skolem">t1</span> <span class="skolem">t2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p0</span> <span class="main">#</span> <span class="skolem">p'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q0</span> <span class="main">#</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.collapse tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p0</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">q0</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> less.hyps less.prems<span class="main">(</span>1<span class="main">)</span> less.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An embedding step inside the branch that is removed in a second embedding step is useless. 
For example, the embedding f (g b) -&gt;emb f b -&gt;emb f can achieved using a single step f (g b) -&gt;emb f.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_emb_step_at<span class="main">:</span>
  <span class="quoted"><span class="quoted">"emb_step_at <span class="free">p</span> <span class="free">d1</span> <span class="main">(</span>emb_step_at <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span>opp <span class="free">d1</span><span class="main">]</span> <span class="main">@</span> <span class="free">q</span><span class="main">)</span> <span class="free">d2</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> emb_step_at <span class="free">p</span> <span class="free">d1</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">d1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> emb_step_at_left_context append_Cons emb_step_at_is_App tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> emb_step_at_right_context append_Cons emb_step_at_is_App tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When swapping two embedding steps of a position below another, one of the positions has to be
slightly changed:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_nested_emb_step_at<span class="main">:</span>
    <span class="quoted"><span class="quoted">"emb_step_at <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="free">q</span><span class="main">)</span> <span class="free">d2</span> <span class="main">(</span>emb_step_at <span class="free">p</span> <span class="free">d1</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> emb_step_at <span class="free">p</span> <span class="free">d1</span> <span class="main">(</span>emb_step_at <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d1</span><span class="main">]</span> <span class="main">@</span> <span class="free">q</span><span class="main">)</span> <span class="free">d2</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">d1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Performing embedding steps in order of a given priority"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We want to perform all embedding steps first that modify the head or the number of arguments
of a term. To this end we define the function prio\_emb\_step that performs the embedding step with
the highest priority possible. The priority is given by a function "prio" from positions to nats, where 
the lowest number has the highest priority.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prio_emb_pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dir list <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> dir list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prio_emb_pos</span> <span class="free"><span class="bound"><span class="entity">prio</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> <span class="free"><span class="bound"><span class="entity">prio</span></span></span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> position_of <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">p</span> <span class="main">∧</span> emb_step_at' <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prio_emb_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dir list <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prio_emb_step</span> <span class="free"><span class="bound"><span class="entity">prio</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> emb_step_at' <span class="main">(</span>prio_emb_pos <span class="free"><span class="bound"><span class="entity">prio</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prio_emb_posI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">⟹</span> prio_emb_pos <span class="free">prio</span> <span class="free">t</span> <span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> position_of <span class="free">t</span> <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> emb_step_at' <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>emb_induct_reverse<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> position_of <span class="skolem">t</span> <span class="skolem">p</span> <span class="main">∧</span> emb_step_at' <span class="skolem">p</span> <span class="skolem">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> emb_step_equiv' step.hyps<span class="main">(</span>1<span class="main">)</span> append_butlast_last_id position_if_emb_step_at
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prio_emb_pos <span class="free">prio</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> position_of <span class="skolem">t</span> <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∧</span> emb_step_at' <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span>  <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prio_emb_pos_def step.hyps<span class="main">(</span>2<span class="main">)</span> arg_min_natI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prio_emb_pos_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"emb_step_at' <span class="free">p</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">prio</span> <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">prio</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arg_min_nat_le assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prio_emb_pos_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We want an embedding step sequence in which the priority numbers monotonely increase. We can
get such a sequence if the priority function assigns greater values to deeper positions.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prio_emb_pos_increase<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"prio_emb_step <span class="free">prio</span> <span class="free">t</span> <span class="free">s</span> <span class="main">≠</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    valid_prio<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">dp</span> <span class="bound">dq</span><span class="main">.</span> <span class="free">prio</span> <span class="main">(</span><span class="bound">p</span> <span class="main">@</span> <span class="main">[</span><span class="bound">dp</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">prio</span> <span class="main">(</span><span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="bound">dq</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> take <span class="main">(</span>length <span class="bound">p</span><span class="main">)</span> <span class="bound">q</span> <span class="main">≠</span> <span class="bound">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">prio</span> <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">prio</span> <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="main">(</span>prio_emb_step <span class="free">prio</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">prio</span> <span class="var">?p1</span> <span class="main">≤</span> <span class="free">prio</span> <span class="var">?p2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">prio</span> <span class="var">?p1</span> <span class="main">≤</span> <span class="free">prio</span> <span class="var">?p2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="main">(</span>butlast <span class="var">?p1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="var">?p2</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>butlast <span class="var">?p1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> contr valid_prio
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_le_imp_less prio_emb_posI prio_emb_step_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> butlast_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="var">?p2</span> <span class="main">≠</span> butlast <span class="var">?p1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> prio_emb_step <span class="free">prio</span> <span class="main">(</span>prio_emb_step <span class="free">prio</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prio_emb_posI prio_emb_step_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> butlast <span class="var">?p2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="main">(</span>butlast <span class="var">?p2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="var">?p1</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dp</span> <span class="main">=</span> last <span class="var">?p2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dq</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dq</span> <span class="main">=</span> last <span class="var">?p1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> butlast <span class="var">?p1</span> <span class="main">!</span> length <span class="main">(</span>butlast <span class="var">?p2</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> position<span class="main">:</span> <span class="quoted"><span class="quoted">"position_of <span class="main">(</span>prio_emb_step <span class="free">prio</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="var">?p2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prio_emb_posI prio_emb_step_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>butlast <span class="var">?p1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>butlast <span class="var">?p1</span><span class="main">)</span> <span class="main">≠</span> length <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> butlast_neq 
      <span class="keyword1"><span class="command">using</span></span> True p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>butlast <span class="var">?p1</span><span class="main">)</span> <span class="main">&gt;</span> length <span class="skolem">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> nat_le_linear True nat_neq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">@</span> <span class="skolem">f</span> <span class="main">#</span> <span class="skolem">q</span> <span class="main">=</span> butlast <span class="var">?p1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True f_def id_take_nth_drop p_def q_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> u1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="main">(</span>emb_step_at <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="skolem">f</span> <span class="main">#</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">dq</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">unfolding</span></span> p_def u_def dp_def dq_def prio_emb_step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">dp</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> emb_step_at <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="skolem">q</span><span class="main">)</span> <span class="skolem">dq</span> <span class="main">(</span>emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> swap_nested_emb_step_at<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">dq</span></span> <span class="quoted"><span class="skolem">dp</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> u1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">u</span> <span class="main">∨</span> emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> emb_step_equiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>›</span></span> emb_prepend_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="var">?p2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> position <span class="quoted">"0"</span> position_of_Nil True append_Cons append_Nil2 append_butlast_last_id 
        append_eq_append_conv_if append_eq_conv_conj dp_def dq_def p_def pos_emb_step_at_nested prio_emb_step_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> contr dp_def p_def prio_emb_posI 
         prio_emb_pos_le prio_emb_step_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"opp <span class="skolem">dp</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dir.exhaust opp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> merge_emb_step_at<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">dp</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">q</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">dq</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u1<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="var">?p2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc position_of_Nil True dp_def 
            <span class="quoted"><span class="quoted">‹length <span class="skolem">p</span> <span class="main">&lt;</span> length <span class="main">(</span>butlast <span class="var">?p1</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹opp <span class="skolem">dp</span> <span class="main">=</span> <span class="skolem">f</span>›</span></span> append.assoc append_butlast_last_id 
            append_take_drop_id f_def list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> p_def pos_emb_step_at_opp position take_hd_drop prio_emb_step_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dp_def p_def <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">=</span> emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> contr 
         prio_emb_posI prio_emb_pos_le prio_emb_step_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> butlast <span class="var">?p1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">p'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span>length <span class="main">(</span>butlast <span class="var">?p1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="var">?p2</span><span class="main">)</span> <span class="main">≠</span> butlast <span class="var">?p1</span>›</span></span> p'_def p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False p'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="main">(</span>emb_step_at <span class="skolem">p'</span> <span class="skolem">dq</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> u_def prio_emb_step_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dp_def dq_def p'_def p_def prio_emb_step_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> emb_step_at <span class="skolem">p'</span> <span class="skolem">dq</span> <span class="main">(</span>emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> swap_disjunct_emb_step_at<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">p'</span></span> <span class="quoted"><span class="skolem">dq</span></span> <span class="quoted"><span class="skolem">dp</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span>length <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">p'</span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>›</span></span> emb_prepend_step emb_step_equiv<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">dp</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pos_emb_step_at_disjunct
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span>length <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">p'</span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> append_butlast_last_id butlast.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
      dp_def list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> p'_def p_def position take_eq_Nil prio_emb_step_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">dp</span> <span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>›</span></span> append_butlast_last_id butlast.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> contr 
      dp_def list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> p_def take_eq_Nil prio_emb_pos_le<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sequence_prio_emb_steps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span><span class="main">.</span> <span class="bound">us</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">us</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∧</span> last <span class="bound">us</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">us</span> <span class="main">⟶</span> <span class="main">(</span>prio_emb_step <span class="free">prio</span> <span class="main">(</span><span class="bound">us</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">us</span> <span class="main">!</span> Suc <span class="bound">i</span> <span class="main">∧</span> <span class="bound">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">us</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms   
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">hsize</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prio_emb_pos <span class="free">prio</span> <span class="skolem">t</span> <span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"emb_step_at' <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="skolem">t</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prio_emb_posI less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> emb_step1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> emb_step_at' <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="skolem">t</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False emb_step_at_if_position less.prems prio_emb_posI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hsize <span class="main">(</span>emb_step_at' <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="skolem">t</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> hsize <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False emb_step_at_if_position emb_step_hsize less.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prio_emb_posI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> us_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
      <span class="quoted"><span class="quoted">"hd <span class="skolem">us</span> <span class="main">=</span> emb_step_at' <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="skolem">t</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> 
      <span class="quoted"><span class="quoted">"last <span class="skolem">us</span> <span class="main">=</span> <span class="free">s</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">us</span> <span class="main">⟶</span> prio_emb_step <span class="free">prio</span> <span class="main">(</span><span class="skolem">us</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">!</span> Suc <span class="bound">i</span> <span class="main">∧</span> <span class="skolem">us</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">us</span> <span class="main">!</span> Suc <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"emb_step_at' <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="skolem">t</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> emb_step_hsize 
        <span class="quoted"><span class="quoted">‹emb_step_at' <span class="main">(</span>prio_emb_pos <span class="free">prio</span> <span class="skolem">t</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">" hd <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> us_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>prio_emb_step <span class="free">prio</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">!</span> Suc <span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">" Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span>"</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prio_emb_step <span class="free">prio</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0"</span> emb_step1 hd_conv_nth prio_emb_step_def us_def<span class="main">(</span>1<span class="main">)</span> us_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span>›</span></span> us_def<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hd <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹last <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Embedding steps under arguments"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We want to perform positions that modify the head and the umber of arguments first. Formally these
positions can be characterized as "list\_all (op = Left) p". We show here that embeddings at other positions
do not modify the head, the number of arguments. Moreover, for each argument, the argument after the step
is an embedding of the argument before the step. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_under_args_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"head <span class="main">(</span>emb_step_at <span class="free">p</span> <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> head <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_head<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Left
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Right
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> App emb_step_at_right_context head_App<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_under_args_num_args<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>emb_step_at <span class="free">p</span> <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> num_args <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> list_all_simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd <span class="skolem">x1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_head<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> App <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> App Cons.IH Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_under_args_emb_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">¬</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="free">p</span>"</span></span>
   <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> num_args <span class="free">t</span>"</span></span>
   <span class="quoted"><span class="quoted">"args <span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span>emb_step_at <span class="free">p</span> <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> num_args <span class="free">t</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> args <span class="free">t</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> args <span class="main">(</span>emb_step_at <span class="free">p</span> <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> App<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> App <span class="skolem">t1</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> emb_step_at_if_position emb_step_at_is_App emb_step_equiv' tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Left
    <span class="keyword1"><span class="command">have</span></span> IH_cond1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> dir.Left<span class="main">)</span> <span class="skolem">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> Left <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> IH_cond2<span class="main">:</span> <span class="quoted"><span class="quoted">"position_of <span class="skolem">t1</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> App Cons.prems<span class="main">(</span>3<span class="main">)</span> Left <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'_def<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> num_args <span class="skolem">t1</span>"</span></span>
      <span class="quoted"><span class="quoted">"args <span class="skolem">t1</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span>emb_step_at <span class="skolem">p</span> <span class="free">d</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> num_args <span class="skolem">t1</span> <span class="main">⟹</span> <span class="skolem">i'</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> args <span class="skolem">t1</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> args <span class="main">(</span>emb_step_at <span class="skolem">p</span> <span class="free">d</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> _ IH_cond1 IH_cond2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> num_args<span class="main">:</span><span class="quoted"><span class="quoted">"num_args <span class="main">(</span>emb_step_at <span class="skolem">p</span> <span class="free">d</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> num_args <span class="skolem">t1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> App Cons.prems<span class="main">(</span>1<span class="main">)</span> Left emb_step_under_args_num_args
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emb_step_under_args_num_args IH_cond1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App i'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_SucI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"args <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span>emb_step_at <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span> <span class="free">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App Left i'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i'_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nth_append num_args<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">i'</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> args <span class="skolem">t</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> args <span class="main">(</span>emb_step_at <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span> <span class="free">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App Left i'_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_append num_args<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1 2 3<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Right
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span> <span class="main">⟹</span> num_args <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> args <span class="skolem">t</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> args <span class="main">(</span>emb_step_at <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span> <span class="free">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> App Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> emb_step_at_right_context Nitpick.size_list_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Right args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_snoc emb_step_under_args_num_args length_butlast length_tl less_antisym nth_butlast<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> App Cons.prems<span class="main">(</span>3<span class="main">)</span> Right emb_step_at_if_position 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_under_args_emb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="free">p</span>"</span></span>
   <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> num_args <span class="free">t</span> <span class="main">⟶</span> args <span class="free">t</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span>emb_step_at <span class="free">p</span> <span class="free">d</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms emb.simps emb_step_under_args_emb_step<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> position_Left_only_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"position_of <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">w</span><span class="main">)</span>  <span class="main">=</span> num_args <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"position_of <span class="free">w</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> position_of_Hd position_of_Nil Hd_head_id append_self_conv2 args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> length_0_conv list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> position_of.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> position_of_Hd Hd_head_id append_Cons args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">w1</span> <span class="skolem">w2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> num_args <span class="skolem">w1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> App Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> App Cons.hyps Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> position_of_left 
          append_Cons list.pred_inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rearranging embedding steps: first above, then below arguments›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perform_emb_above_vars0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="free">s</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">w</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">w</span>"</span></span>
    <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="free">w</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w'</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">w'</span> <span class="main">⟶</span> <span class="main">¬</span> subst <span class="free">ρ</span> <span class="bound">w'</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms   
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">hsize</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w'</span><span class="main">.</span> <span class="skolem">s</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">w'</span> <span class="main">⟶</span> <span class="main">¬</span> subst <span class="free">ρ</span> <span class="bound">w'</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
      <span class="keyword1"><span class="command">using</span></span> emb.refl less.prems<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> emb_step_is_emb emb_step_hsize emb_trans less.hyps less.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> emb_only_below_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="free">s</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">w</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_Sym <span class="main">(</span>head <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="free">w</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w'</span><span class="main">.</span> <span class="free">w</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">w'</span> <span class="main">⟶</span> <span class="main">¬</span> subst <span class="free">ρ</span> <span class="bound">w'</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ws</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="quoted"><span class="quoted">"hd <span class="free">ws</span> <span class="main">=</span> subst <span class="free">ρ</span> <span class="free">w</span>"</span></span>
    <span class="quoted"><span class="quoted">"last <span class="free">ws</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ws</span> <span class="main">⟶</span> 
      <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> emb_step_at <span class="bound">p</span> <span class="bound">d</span> <span class="main">(</span><span class="free">ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">!</span> Suc <span class="bound">i</span> <span class="main">∧</span> <span class="main">¬</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ws</span> <span class="main">⟶</span> head <span class="main">(</span><span class="free">ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> head <span class="free">w</span> <span class="main">∧</span> num_args <span class="main">(</span><span class="free">ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> num_args <span class="free">w</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ws</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> num_args <span class="free">w</span> <span class="main">⟶</span> args <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">w</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span><span class="free">ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">prio</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dir list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">prio</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="main">(</span>butlast <span class="bound">p</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="quoted"><span class="quoted">"hd <span class="skolem">ws</span> <span class="main">=</span> subst <span class="free">ρ</span> <span class="free">w</span>"</span></span>
    <span class="quoted"><span class="quoted">"last <span class="skolem">ws</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">ws</span> <span class="main">⟶</span> prio_emb_step <span class="skolem">prio</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> <span class="skolem">ws</span> <span class="main">!</span> Suc <span class="bound">i</span> <span class="main">∧</span> <span class="skolem">ws</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">ws</span> <span class="main">!</span> Suc <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subst <span class="free">ρ</span> <span class="free">w</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>›</span></span> sequence_prio_emb_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> ws_emb_u<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">ws</span> <span class="main">⟶</span> <span class="skolem">ws</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">u</span> <span class="main">∧</span> <span class="skolem">ws</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ws</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">ws</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">u</span>  <span class="main">∧</span> <span class="skolem">ws</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">ws</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prio_emb_step <span class="skolem">prio</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">ws</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> <span class="skolem">ws</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">ws</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> Suc_diff_Suc ws_def<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> One_nat_def Suc_diff_Suc Suc_lessD diff_Suc_less emb_step_equiv last_conv_nth ws_def<span class="main">(</span>1<span class="main">)</span> ws_def<span class="main">(</span>3<span class="main">)</span> ws_def<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_is_emb<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">ws</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">ws</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">ws</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_Suc diff_Suc_less length_greater_0_conv ws_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ws_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> emb_hsize_neq
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.IH Suc.prems Suc_lessD emb_hsize emb_step_is_emb emb_trans leD<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> 0 <span class="main">=</span> this
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ws</span> <span class="main">⟶</span> <span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="free">u</span> <span class="main">∧</span> <span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> Suc_diff_Suc ws_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ws</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> head <span class="free">w</span> 
             <span class="main">∧</span> num_args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> num_args <span class="free">w</span>
             <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> num_args <span class="free">w</span> <span class="main">⟶</span> args <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">w</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>
             <span class="main">∧</span> <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ws</span> <span class="main">⟶</span> <span class="skolem">prio</span> <span class="main">(</span>prio_emb_pos <span class="skolem">prio</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> head <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ground_imp_subst_iden hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> hd_conv_nth head_subst tm.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> ws_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ws_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"num_args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> num_args <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_self_conv2 args_subst assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> hd.case_eq_if hd_conv_nth length_map ws_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ws_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> num_args <span class="free">w</span> <span class="main">⟶</span> args <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">w</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> emb.refl hd_conv_nth ws_def<span class="main">(</span>1<span class="main">)</span> ws_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">ws</span> <span class="main">⟶</span> <span class="skolem">prio</span> <span class="main">(</span>prio_emb_pos <span class="skolem">prio</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹num_args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> num_args <span class="free">w</span>›</span></span> prio_def append_butlast_last_id assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> emb_step_at_if_position 
        emb_step_at_subst hd_conv_nth position_Left_only_subst prio_emb_posI ws_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ws_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ws_emb_u<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">prio</span> <span class="main">(</span>prio_emb_pos <span class="skolem">prio</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
        <span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> head <span class="free">w</span>"</span></span> 
        <span class="quoted"><span class="quoted">"num_args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> num_args <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> head <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems prio_def emb_step_under_args_head ih<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ih<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prio_emb_step_def ws_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> zero_neq_one<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"num_args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> num_args <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems emb_step_under_args_num_args ih<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ih<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prio_def prio_emb_step_def ws_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> zero_neq_one<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>num_args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">.</span> args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Suc.prems emb_step_under_args_emb ih<span class="main">(</span>1<span class="main">)</span> prio_def prio_emb_step_def ws_def<span class="main">(</span>4<span class="main">)</span> zero_neq_one 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_butlast_last_id prio_emb_posI ws_emb_u<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> num_args <span class="free">w</span> <span class="main">⟶</span> args <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">w</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems emb_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">dp</span> <span class="bound">dq</span><span class="main">.</span> <span class="skolem">prio</span> <span class="main">(</span><span class="bound">q</span> <span class="main">@</span> <span class="main">[</span><span class="bound">dq</span><span class="main">]</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">prio</span> <span class="main">(</span><span class="bound">p</span> <span class="main">@</span> <span class="main">[</span><span class="bound">dp</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> take <span class="main">(</span>length <span class="bound">p</span><span class="main">)</span> <span class="bound">q</span> <span class="main">≠</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prio_def
        <span class="keyword1"><span class="command">using</span></span> append_take_drop_id list_all_append 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> butlast_snoc gr_implies_not0 less_not_refl2<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">ws</span> <span class="main">⟶</span> <span class="skolem">prio</span> <span class="main">(</span>prio_emb_pos <span class="skolem">prio</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems ih<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_one_le_zero prio_def prio_emb_pos_increase ws_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ws_emb_u<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">ws</span> <span class="main">⟶</span> 
      <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> emb_step_at <span class="bound">p</span> <span class="bound">d</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ws</span> <span class="main">!</span> Suc <span class="bound">i</span> <span class="main">∧</span> <span class="main">¬</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span> Suc_lessD prio_def prio_emb_step_def ws_def<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> zero_neq_one<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that ws_def<span class="main">(</span>1<span class="main">)</span> ws_def<span class="main">(</span>2<span class="main">)</span> ws_def<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perform_emb_above_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="free">s</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">w</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">w</span>"</span></span>
    <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="free">w</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span>
    <span class="quoted"><span class="quoted">"is_Sym <span class="main">(</span>head <span class="free">w</span><span class="main">)</span> <span class="main">⟹</span> head <span class="free">w</span> <span class="main">=</span> head <span class="free">u</span> <span class="main">∧</span> num_args <span class="free">w</span> <span class="main">=</span> num_args <span class="free">u</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">&lt;</span>num_args <span class="free">w</span> <span class="main">⟶</span> args <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">w</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="free">u</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">w</span>"</span></span> 
    <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="skolem">w</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w'</span><span class="main">.</span> <span class="skolem">w</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">w'</span> <span class="main">⟶</span> <span class="main">¬</span> subst <span class="free">ρ</span> <span class="bound">w'</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> perform_emb_above_vars0<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹subst <span class="free">ρ</span> <span class="free">s</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_Sym <span class="main">(</span>head <span class="skolem">w</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
      <span class="quoted"><span class="quoted">"hd <span class="skolem">ws</span> <span class="main">=</span> subst <span class="free">ρ</span> <span class="skolem">w</span>"</span></span> 
      <span class="quoted"><span class="quoted">"last <span class="skolem">ws</span> <span class="main">=</span> <span class="free">u</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">ws</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> emb_step_at <span class="bound">p</span> <span class="bound">d</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ws</span> <span class="main">!</span> Suc <span class="bound">i</span> <span class="main">∧</span> <span class="main">¬</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">ws</span><span class="main">.</span> head <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> head <span class="skolem">w</span> <span class="main">∧</span> num_args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> num_args <span class="skolem">w</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">ws</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>num_args <span class="skolem">w</span><span class="main">.</span> args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span><span class="skolem">ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> emb_only_below_vars<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹subst <span class="free">ρ</span> <span class="free">s</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">w</span>›</span></span> <span class="quoted"><span class="quoted">‹is_Sym <span class="main">(</span>head <span class="skolem">w</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹subst <span class="free">ρ</span> <span class="skolem">w</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">u</span>›</span></span> w_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">w</span> <span class="main">=</span> head <span class="free">u</span> <span class="main">∧</span> num_args <span class="skolem">w</span> <span class="main">=</span> num_args <span class="free">u</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">&lt;</span>num_args <span class="skolem">w</span> <span class="main">⟶</span> args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="free">u</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def append_butlast_last_id diff_Suc_1 diff_Suc_less length_append_singleton length_greater_0_conv nth_append_length<span class="main">)</span>

  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> that w_def<span class="main">(</span>1<span class="main">)</span> w_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Chop">
<div class="head">
<h1>Theory Chop</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Chop Operation on Lambda-Free Higher-Order Terms
    Author:      Alexander Bentkamp &lt;a.bentkamp at vu.nl&gt;, 2018
    Maintainer:  Alexander Bentkamp &lt;a.bentkamp at vu.nl&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Chop Operation on Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Chop
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Embeddings.html">Embeddings</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">chop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chop</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> apps <span class="main">(</span>hd <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic properties›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chop_App_Hd<span class="main">:</span> <span class="quoted"><span class="quoted">"is_Hd <span class="free">s</span> <span class="main">⟹</span> chop <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> chop_def args.simps 
  <span class="keyword1"><span class="command">using</span></span> args_Nil_iff_is_Hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> chop_apps<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span> <span class="main">⟹</span> chop <span class="main">(</span>apps <span class="free">t</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> apps <span class="main">(</span>chop <span class="free">t</span><span class="main">)</span> <span class="free">ts</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> chop_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> args_Nil_iff_is_Hd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_chop<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span> <span class="main">⟹</span> vars <span class="main">(</span>chop <span class="free">t</span><span class="main">)</span> <span class="main">∪</span> vars_hd <span class="main">(</span>head <span class="free">t</span><span class="main">)</span> <span class="main">=</span> vars <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>tm_induct_apps<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> chop_def UN_insert Un_commute list.exhaust_sel list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span>
      args_Nil_iff_is_Hd tm.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> tm_exhaust_apps_sel vars_apps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_chop<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span> <span class="main">⟹</span> ground <span class="free">t</span> <span class="main">⟹</span> ground <span class="main">(</span>chop <span class="free">t</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> vars_chop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hsize_chop<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span>Suc <span class="main">(</span>hsize <span class="main">(</span>chop <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hsize <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hsize_args<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> chop_def hsize_apps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nil_is_map_conv args_Nil_iff_is_Hd list.exhaust_sel list.map_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_tl plus_1_eq_Suc sum_list.Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hsize_chop_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span> <span class="main">⟹</span> hsize <span class="main">(</span>chop <span class="free">t</span><span class="main">)</span> <span class="main">&lt;</span> hsize <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_le_lessD less_or_eq_imp_le hsize_chop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chop_fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"is_App <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="main">(</span>chop <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>arg <span class="free">t</span><span class="main">)</span> <span class="main">=</span> chop <span class="free">t</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> args_Nil_iff_is_Hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> chop_def
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> App_apps args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_append2 tl_append2 tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Chop and the Embedding Relation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_chop<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"num_args <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> nil<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> chop_def <span class="keyword1"><span class="command">using</span></span> 0 args_Nil_iff_is_Hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> args <span class="skolem">t</span> <span class="main">=</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> chop_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span> apps.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> args.elims args_Nil_iff_is_Hd emb_step_arg last.simps last_snoc list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> nil single
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.hyps"</span> length_0_conv length_tl list.exhaust_sel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"apps <span class="main">(</span>Hd <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="main">(</span>apps <span class="main">(</span>Hd <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"apps <span class="main">(</span>Hd <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 add_diff_cancel_right' args_Nil_iff_is_Hd length_butlast list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm_exhaust_apps_sel tm_inject_apps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"App <span class="main">(</span>apps <span class="main">(</span>Hd <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> App_apps Suc.prems args_Nil_iff_is_Hd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"App <span class="main">(</span>chop <span class="main">(</span>apps <span class="main">(</span>Hd <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> chop <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>butlast <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems append_butlast_last_id args_Nil_iff_is_Hd hd_append2 length_0_conv length_butlast nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>butlast <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>last <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems append_butlast_last_id args_Nil_iff_is_Hd length_0_conv length_butlast nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tl_append2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f1 chop_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> App_apps append_Nil args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> args_apps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> context_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> chop_emb_step_at<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chop <span class="free">t</span> <span class="main">=</span> emb_step_at <span class="main">(</span>replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span><span class="main">)</span> Left<span class="main">)</span> Right <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rep_Nil<span class="main">:</span><span class="quoted"><span class="quoted">"replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> dir.Left <span class="main">=</span> <span class="main">[]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rep_Nil 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.hyps"</span> <span class="quoted">"0.prems"</span> emb_step_at_right append_Nil apps.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> chop_def length_0_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> emb_step_at_left_context args.elims args_Nil_iff_is_Hd chop_fun butlast_snoc diff_Suc_1 length_0_conv length_butlast nat.distinct<span class="main">(</span>1<span class="main">)</span> replicate_Suc tm.collapse<span class="main">(</span>2<span class="main">)</span> tm.sel<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_at_chop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> emb_step_at<span class="main">:</span> <span class="quoted"><span class="quoted">"emb_step_at <span class="free">p</span> Right <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span><span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span>Right<span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> all_Left<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chop <span class="free">t</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∨</span> chop <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_if_position emb_step_at_is_App emb_step_equiv pos<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> p_replicate<span class="main">:</span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>length <span class="free">p</span><span class="main">)</span> Left <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> replicate_length_same<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted">Left</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_set all_Left<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="free">p</span><span class="main">)</span> <span class="main">=</span> num_args <span class="free">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span><span class="main">)</span> Left"</span></span> <span class="keyword1"><span class="command">using</span></span> p_replicate 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_inject <span class="quoted"><span class="quoted">‹is_App <span class="free">t</span>›</span></span> args.elims args_Nil_iff_is_Hd length_append_singleton tm.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> chop_emb_step_at<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="free">t</span>›</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">using</span></span> pos emb_step_at <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> num_args <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pos emb_step_at <span class="quoted"><span class="quoted">‹is_App <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> dir.Left<span class="main">)</span> <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI args_Nil_iff_is_Hd length_greater_0_conv list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Left"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span>"</span></span>  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> args.elims args_Nil_iff_is_Hd length_Cons length_append_singleton tm.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"position_of <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span>Right<span class="main">]</span><span class="main">)</span>"</span></span>   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹position_of <span class="skolem">t</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>Right<span class="main">]</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> position_of_left append_Cons list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"emb_step_at <span class="skolem">p</span> dir.Right <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> emb_step_at <span class="skolem">p</span> dir.Right <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> emb_step_at_left_context<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted">Right</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="main">&lt;</span> num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> 1 2 3<span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> Cons.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> Nil_is_append_conv list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_Cons_self2 position_of.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.discI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Suc_less_eq2 args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_Cons length_append_singleton tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>      
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="free">p</span><span class="main">)</span><span class="main">)</span> dir.Left"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="free">t</span> <span class="main">=</span> emb_step_at <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span>Left<span class="main">]</span> <span class="main">@</span> <span class="skolem">q</span><span class="main">)</span> dir.Right <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">+</span> <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span> <span class="main">-</span> length <span class="free">p</span><span class="main">)</span> <span class="main">=</span> num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span>length <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> num_args <span class="free">t</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq2 <span class="quoted"><span class="quoted">‹is_App <span class="free">t</span>›</span></span> args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_Suc_1 leD length_butlast nat_le_linear 
            ordered_cancel_comm_monoid_diff_class.add_diff_inverse snoc_eq_iff_butlast tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span><span class="main">)</span> dir.Left <span class="main">=</span> <span class="free">p</span> <span class="main">@</span> replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span> <span class="main">-</span> length <span class="free">p</span><span class="main">)</span> dir.Left"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> p_replicate replicate_add<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span> <span class="main">-</span> length <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> False <span class="quoted"><span class="quoted">‹is_App <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">p</span> <span class="main">+</span> <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span> <span class="main">-</span> length <span class="free">p</span><span class="main">)</span> <span class="main">=</span> num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span>›</span></span> args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_append_singleton less_Suc_eq less_add_Suc1 tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_diff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span> <span class="main">-</span> length <span class="free">p</span><span class="main">)</span> dir.Left <span class="main">=</span> <span class="main">[</span>Left<span class="main">]</span> <span class="main">@</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Cons_replicate_eq Nat.diff_cancel Suc_eq_plus1 <span class="quoted"><span class="quoted">‹length <span class="free">p</span> <span class="main">+</span> <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span> <span class="main">-</span> length <span class="free">p</span><span class="main">)</span> <span class="main">=</span> num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span>›</span></span> append_Cons self_append_conv2<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> chop_emb_step_at
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="free">t</span>›</span></span> 1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chop_emb_step_at<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pos merge_emb_step_at<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted">Right</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted">Right</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_if_position opp_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> emb_step_at pos_emb_step_at_opp<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_at_remove_arg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> emb_step_at<span class="main">:</span> <span class="quoted"><span class="quoted">"emb_step_at <span class="free">p</span> Left <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span><span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="free">p</span> <span class="main">@</span> <span class="main">[</span>Left<span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> all_Left<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> num_args <span class="free">t</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="free">p</span><span class="main">)</span> <span class="keyword1">in</span> 
  head <span class="free">t</span> <span class="main">=</span> head <span class="free">s</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> num_args <span class="free">t</span> <span class="main">∧</span> args <span class="free">s</span> <span class="main">=</span> take <span class="bound">i</span> <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>args <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_at_if_position emb_step_at_is_App emb_step_equiv pos<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> C1<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">t</span> <span class="main">=</span> head <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> all_Left emb_step_at pos <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> emb_step_at <span class="main">[]</span> dir.Left <span class="main">(</span>App <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> position_of.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snoc_eq_iff_butlast tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.discI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> fun <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Left"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>emb_step_at <span class="skolem">p</span> Left <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> head <span class="skolem">t</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> head_fun list.pred_inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> position_if_emb_step_at<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> emb_step_at_left_context<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"fun <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> Left›</span></span> emb_step_at_is_App head_App tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"num_args <span class="free">t</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="free">p</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> C2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> num_args <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="free">t</span>›</span></span> args_Nil_iff_is_Hd<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> C3<span class="main">:</span><span class="quoted"><span class="quoted">"args <span class="free">s</span> <span class="main">=</span> take <span class="var">?i</span> <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="var">?i</span><span class="main">)</span> <span class="main">(</span>args <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_Left pos emb_step_at <span class="quoted"><span class="quoted">‹is_App <span class="free">t</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> emb_step_at_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> One_nat_def args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_conv_take butlast_snoc tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"position_of <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span>Left<span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> position_of_left 
          append_Cons list.pred_inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"args <span class="main">(</span>emb_step_at <span class="skolem">p</span> Left <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">=</span> take <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> 
                   <span class="main">@</span> drop <span class="main">(</span>Suc <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> append_Nil args_Nil_iff_is_Hd drop_Nil 
          emb_step_at_is_App list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list_all_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> take_0 zero_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> App <span class="main">(</span>emb_step_at <span class="skolem">p</span> Left <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>arg <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> emb_step_at_left_context<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted">Left</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"take <span class="skolem">k</span> <span class="main">(</span>args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>num_args <span class="skolem">t</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> k_def Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> args.elims args_Nil_iff_is_Hd butlast_snoc diff_Suc_eq_diff_pred 
          diff_Suc_less length_Cons length_butlast length_greater_0_conv take_butlast tm.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> k_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> num_args <span class="skolem">t</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_Suc_Suc length_append_singleton local.Cons<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>arg <span class="skolem">t</span><span class="main">]</span> <span class="main">=</span> args <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹position_of <span class="skolem">t</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>Left<span class="main">]</span><span class="main">)</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3"</span> <span class="quoted"><span class="quoted">‹position_of <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span>dir.Left<span class="main">]</span><span class="main">)</span>›</span></span> args_Nil_iff_is_Hd butlast_snoc emb_step.simps emb_step_at_if_position length_butlast length_greater_0_conv tm.discI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span><span class="main">&lt;</span>num_args <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k_def'
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span> num_args <span class="skolem">t</span><span class="main">.</span> drop <span class="bound">k</span> <span class="main">(</span>args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>arg <span class="skolem">t</span><span class="main">]</span> <span class="main">=</span> drop <span class="bound">k</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>arg <span class="skolem">t</span><span class="main">]</span> <span class="main">=</span> args <span class="skolem">t</span>›</span></span> drop_butlast drop_eq_Nil last_drop leD snoc_eq_iff_butlast<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 1 2 3 k_def'
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">k</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span>›</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C1 C2 C3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emb_step_cases <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> chop extended_chop remove_arg under_arg<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> emb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> chop<span class="main">:</span><span class="quoted"><span class="quoted">"chop <span class="free">t</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> extended_chop<span class="main">:</span><span class="quoted"><span class="quoted">"chop <span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> remove_arg<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> head <span class="free">t</span> <span class="main">=</span> head <span class="free">s</span> <span class="main">⟹</span> <span class="bound">i</span><span class="main">&lt;</span>num_args <span class="free">t</span> <span class="main">⟹</span> args <span class="free">s</span> <span class="main">=</span> take <span class="bound">i</span> <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> under_arg<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> head <span class="free">t</span> <span class="main">=</span> head <span class="free">s</span> <span class="main">⟹</span> num_args <span class="free">t</span> <span class="main">=</span> num_args <span class="free">s</span> <span class="main">⟹</span> args <span class="free">t</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="free">s</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟹</span>
         <span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">&lt;</span>num_args <span class="free">t</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> args <span class="free">t</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> args <span class="free">s</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> pd_def<span class="main">:</span><span class="quoted"><span class="quoted">"emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"position_of <span class="free">t</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> emb emb_step_equiv' position_if_emb_step_at <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb emb_step_at_is_App emb_step_equiv<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Left
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">using</span></span> emb_step_at_remove_arg 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True pd_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pd_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> remove_arg<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Right
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> 
        <span class="keyword1"><span class="command">using</span></span> True chop emb_step_at_chop extended_chop pd_def<span class="main">(</span>1<span class="main">)</span> pd_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"num_args <span class="free">t</span> <span class="main">=</span> num_args <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> emb_step_under_args_num_args
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False pd_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"head <span class="free">t</span> <span class="main">=</span> head <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> emb_step_under_args_head
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False pd_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 under_arg emb_step_under_args_emb_step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False pd_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pd_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chop_position_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"position_of <span class="free">s</span> <span class="main">(</span>replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span><span class="main">)</span> dir.Left <span class="main">@</span> <span class="main">[</span>Right<span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_n_not_le_n assms chop_emb_step_at lessI less_imp_le_nat position_if_emb_step_at hsize_chop<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Chop and Substitutions›</span></span>

<span class="comment1">(* TODO: move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> Suc_num_args<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span> <span class="main">⟹</span> Suc <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> num_args <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_append_singleton tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* TODO: move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> fun_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span> <span class="main">⟹</span> subst <span class="free">ρ</span> <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span> <span class="main">=</span> fun <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* TODO: move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> args_subst_Hd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_Hd <span class="main">(</span>subst <span class="free">ρ</span> <span class="main">(</span>Hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"args <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil args_Nil_iff_is_Hd args_apps subst_apps tm_exhaust_apps_sel<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chop_subst_emb0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chop <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">≠</span> subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="main">(</span>replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span><span class="main">)</span> Left<span class="main">)</span> Right <span class="main">(</span>chop <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subst.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="free">s</span><span class="main">)</span> <span class="main">=</span> emb_step_at <span class="main">(</span>replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span><span class="main">)</span> dir.Left<span class="main">)</span> dir.Right <span class="main">(</span>subst <span class="free">ρ</span>  <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chop_emb_step_at<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> emb_step_at_subst chop_position_of<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="free">s</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> num_args <span class="main">(</span>fun <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fun_subst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="free">s</span>›</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_subst leI length_append length_map not_add_less2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> num_args <span class="main">(</span>fun <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted">"1"</span> <span class="quoted"><span class="quoted">‹is_App <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span>›</span></span> chop_emb_step_at le_imp_less_or_eq 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_args <span class="free">s</span> <span class="main">≤</span> num_args <span class="main">(</span>fun <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc_num_args<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="free">s</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span><span class="main">)</span> dir.Left <span class="main">@</span>
        <span class="main">[</span>opp dir.Right<span class="main">]</span> <span class="main">@</span> replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> num_args <span class="free">s</span><span class="main">)</span> dir.Left <span class="main">=</span>
        replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> dir.Left"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> append.simps opp_simps replicate_Suc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> replicate_add<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> Suc_num_args<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="free">s</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_shift ordered_cancel_comm_monoid_diff_class.add_diff_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1
    <span class="keyword1"><span class="command">unfolding</span></span>  chop_emb_step_at<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> merge_emb_step_at<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chop_subst_emb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chop <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chop_subst_emb0
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms emb.refl emb_step_equiv emb_step_is_emb<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> chop_subst_Hd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_Hd <span class="main">(</span>subst <span class="free">ρ</span> <span class="main">(</span>Hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chop <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="free">s</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subst.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span> <span class="main">=</span> num_args <span class="main">(</span>fun <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fun_subst<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="free">s</span>›</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> args_subst_Hd <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> chop_emb_step_at<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> chop_emb_step_at<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> emb_step_at_subst<span class="main">[</span><span class="operator">OF</span> chop_position_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="free">s</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chop_subst_Sym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_Sym <span class="main">(</span>head <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chop <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> chop_subst_Hd ground_imp_subst_iden hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> tm.disc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Lambda_Free_EPO">
<div class="head">
<h1>Theory Lambda_Free_EPO</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Embedding Path Order for Lambda-Free Higher-Order Terms
    Author:      Alexander Bentkamp &lt;a.bentkamp at vu.nl&gt;, 2018
    Maintainer:  Alexander Bentkamp &lt;a.bentkamp at vu.nl&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Embedding Path Order for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_EPO
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Chop.html">Chop</a> <a href="../Nested_Multisets_Ordinals/Multiset_More.html">Nested_Multisets_Ordinals.Multiset_More</a>
<span class="keyword2"><span class="keyword">abbrevs</span></span> <span class="quoted">"&gt;t"</span> <span class="main">=</span> <span class="quoted">"&gt;<span class="hidden">⇩</span><sub>t</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"≥t"</span> <span class="main">=</span> <span class="quoted">"≥<span class="hidden">⇩</span><sub>t</sub>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines the embedding path order for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free
higher-order terms.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>

<span class="keyword1"><span class="command">locale</span></span> epo <span class="main">=</span> ground_heads <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>s</sub>)</span></span>"</span></span> <span class="quoted"><span class="free">arity_sym</span></span> <span class="quoted"><span class="free">arity_var</span></span>
    <span class="keyword2"><span class="keyword">for</span></span>
      <span class="free">gt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>s</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> enat"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">extf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    extf_ext_trans_before_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_trans_before_irrefl <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    extf_ext_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_list <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_ext_compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_snoc <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_ext_compat_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_cons <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_ext_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_snoc <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_min_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">extf</span> <span class="free">f</span> <span class="free">gt</span> <span class="main">[]</span> <span class="free">ss</span>"</span></span> <span class="comment1">(* TODO: seperate definition? *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extf_ext_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_trans <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext_trans_before_irrefl.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> extf_ext_trans_before_irrefl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extf_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"ext <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext_trans.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> extf_ext_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> extf_mono_strong <span class="main">=</span> ext.mono_strong<span class="main">[</span><span class="operator">OF</span> extf_ext<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_mono <span class="main">=</span> ext.mono<span class="main">[</span><span class="operator">OF</span> extf_ext<span class="main">,</span> <span class="operator">mono</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_map <span class="main">=</span> ext.map<span class="main">[</span><span class="operator">OF</span> extf_ext<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_trans <span class="main">=</span> ext_trans.trans<span class="main">[</span><span class="operator">OF</span> extf_ext_trans<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_irrefl_from_trans <span class="main">=</span>
  ext_trans_before_irrefl.irrefl_from_trans<span class="main">[</span><span class="operator">OF</span> extf_ext_trans_before_irrefl<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_compat_list <span class="main">=</span> ext_compat_list.compat_list<span class="main">[</span><span class="operator">OF</span> extf_ext_compat_list<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> extf_snoc <span class="main">=</span> ext_snoc.snoc<span class="main">[</span><span class="operator">OF</span> extf_ext_snoc<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> extf_compat_append_right <span class="main">=</span> ext_compat_snoc.compat_append_right<span class="main">[</span><span class="operator">OF</span> extf_ext_compat_snoc<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_compat_append_left <span class="main">=</span> ext_compat_cons.compat_append_left<span class="main">[</span><span class="operator">OF</span> extf_ext_compat_cons<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> extf_ext_insert_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="free">f</span> <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">z</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> extf_compat_append_left extf_compat_append_right extf_snoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">gt</span></span> <span class="quoted">Nil</span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inductive Definitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">chkchop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chkchop</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> is_Hd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>chop <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">chkchop_same</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chkchop_same</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> 
            <span class="main">(</span><span class="keyword1">if</span> is_Var <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> 
            <span class="keyword1">then</span> is_Hd <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∨</span> chkchop <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="main">(</span>chop <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> 
            <span class="keyword1">else</span> chkchop <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chkchop_mono<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">≤</span> <span class="free">gt'</span> <span class="main">⟹</span> chkchop <span class="free">gt</span> <span class="main">≤</span> chkchop <span class="free">gt'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chkchop_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> chkchop_same_mono<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">≤</span> <span class="free">gt'</span> <span class="main">⟹</span> chkchop_same <span class="free">gt</span> <span class="main">≤</span> chkchop_same <span class="free">gt'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chkchop_same_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_chop<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> chop <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> chop <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> is_Sym <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span> chkchop <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_same<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chkchop_same <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_chop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_chopI<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> chop <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">gt_chop</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_diffI<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> is_Sym <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span> chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">gt_diff</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_same</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_sameI<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt_same</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_iff_chop_diff_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟷</span> gt_chop <span class="free">t</span> <span class="free">s</span> <span class="main">∨</span> gt_diff <span class="free">t</span> <span class="free">s</span> <span class="main">∨</span> gt_same <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gt.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_chop.simps gt_diff.simps gt_same.simps<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> t_gt_chop_t<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_chop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_imp_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> vars <span class="free">t</span> <span class="main">⊇</span> vars <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> hsize <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">+</span></span> hsize <span class="bound"><span class="bound">s</span></span>"</span></span></span>
      <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> vars <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⊇</span></span> vars <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> hsize <span class="bound">ta</span> <span class="main">+</span> hsize <span class="bound">sa</span> <span class="main">&lt;</span> hsize <span class="skolem">t</span> <span class="main">+</span> hsize <span class="skolem">s</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span> vars <span class="bound">ta</span> <span class="main">⊇</span> vars <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">t</span> <span class="main">⊇</span> vars <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>gt_chop<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_supI1 order_refl hsize_chop_lt vars_chop<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Hd
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff<span class="main">(</span>2<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> subsetI tm.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span>chop <span class="skolem">s</span><span class="main">)</span> <span class="main">⊆</span> vars <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih 
        <span class="keyword1"><span class="command">using</span></span> App chkchop_def local.gt_diff<span class="main">(</span>3<span class="main">)</span> nat_add_left_cancel_less hsize_chop_lt tm.disc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span>  App  le_sup_iff local.gt_diff<span class="main">(</span>2<span class="main">)</span> tm.disc<span class="main">(</span>2<span class="main">)</span> vars_chop
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> subsetI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd _<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gt_same extf_min_empty<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"args <span class="skolem">s</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd _<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> local.gt_same<span class="main">(</span>1<span class="main">)</span> vars_head_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="skolem">s</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Var args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chkchop_def chkchop_same_def epo.extf_min_empty 
                epo_axioms gt_hd_def gt_hd_irrefl hd.disc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> local.gt_same<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> local.gt_same<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span>chop <span class="skolem">s</span><span class="main">)</span> <span class="main">⊆</span> vars <span class="main">(</span>chop <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹chop <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="skolem">s</span>›</span></span><span class="main">]</span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> App add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> args_Nil_iff_is_Hd extf_min_empty gt_hd_def gt_hd_irrefl local.gt_same<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> hsize_chop_lt tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span>  gt_same<span class="main">(</span>1<span class="main">)</span> vars_chop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> vars_chop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> App args_Nil_iff_is_Hd extf_min_empty gt_hd_def gt_hd_irrefl le_sup_iff local.gt_same<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> order_refl sup.coboundedI1 tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sym <span class="skolem">f</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gt_same chkchop_same_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd _<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> local.gt_same<span class="main">(</span>1<span class="main">)</span> vars_head_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def <span class="keyword1"><span class="command">using</span></span> vars_chop ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span><span class="main">]</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>›</span></span> chkchop_def le_sup_iff local.gt_same<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
              nat_add_left_cancel_less hsize_chop_lt tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> vars_head_subseteq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>      
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> gt_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span>hsize <span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> hsize <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> hsize <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">u</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">u</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span> <span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span>hsize <span class="bound">ua</span><span class="main">,</span> hsize <span class="bound">ta</span><span class="main">,</span> hsize <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>hsize <span class="skolem">u</span><span class="main">,</span> hsize <span class="skolem">t</span><span class="main">,</span> hsize <span class="skolem">s</span><span class="main">#}</span> <span class="main">⟹</span>
      <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    u_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> u_gt_s_if_ui<span class="main">:</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> ui_in<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> t_gt_s gt_chop hsize_chop_lt ui_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> gt_chop
    <span class="keyword1"><span class="command">have</span></span> u_gt_s_if_chk_u_t<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> chk_u_t<span class="main">:</span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">u</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> gt_chop chk_u_t 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_lt_left_lt add_mset_lt_right_lt chkchop_def ih hsize_chop_lt<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd chkchop_def chkchop_same_def 
          epo.extf_min_empty epo_axioms gt.simps gt_hd_def gt_hd_irrefl
          u_gt_s_if_chk_u_t u_gt_s_if_ui u_gt_t<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff_t_s<span class="main">:</span> gt_diff
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_chop
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> u_gt_s_if_ui <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>1<span class="main">)</span> gt_diff_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_hd_trans<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> add_mset_lt_left_lt add_mset_lt_right_lt chkchop_def  gt_diff gt_diff_t_s<span class="main">(</span>3<span class="main">)</span> ih hsize_chop_lt u_gt_t
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gt_diff_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s<span class="main">(</span>1<span class="main">)</span> gt_same_u_t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> add_mset_lt_left_lt add_mset_lt_right_lt chkchop_def gt_diff gt_diff_t_s<span class="main">(</span>3<span class="main">)</span> ih hsize_chop_lt u_gt_t
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gt_diff_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same_t_s<span class="main">:</span> gt_same
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_chop
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> u_gt_s_if_ui <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>1<span class="main">)</span> gt_same_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> add_mset_lt_left_lt add_mset_lt_right_lt chkchop_def gt_diff gt_same_t_s ih hsize_chop_lt u_gt_t
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chkchop_same_def gt_diff_u_t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">have</span></span> hd_u_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_same_u_t<span class="main">(</span>1<span class="main">)</span> gt_same_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> gt_trans_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ua</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟶</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟶</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">ta</span> <span class="skolem">ua</span>
        <span class="keyword3"><span class="command">assume</span></span>
          ua_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sa_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          ua_gt_ta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">ta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_gt_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_lt_imp_lt_mset ua_gt_ta ta_gt_sa<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">meson</span> ua_in ta_in sa_in Un_iff max.strict_coboundedI1 max.strict_coboundedI2
               hsize_in_args<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> extf_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ gt_trans_args<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
        <span class="keyword3"><span class="command">assume</span></span> f_in_grounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f_in_grounds gt_same_u_t<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f_in_grounds gt_same_t_s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> gt_same_u_t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">u</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd _<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> Var <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">u1</span> <span class="skolem">u2</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="skolem">t</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Var args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chkchop_def chkchop_same_def epo.extf_min_empty epo_axioms gt_hd_def gt_hd_irrefl gt_same_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> gt_same_u_t<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd.disc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd _<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">using</span></span> extf_min_empty gt_same_t_s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> t_App<span class="main">:</span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">s</span> <span class="main">⟹</span> chop <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="skolem">s</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> gt_same_t_s <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def <span class="keyword1"><span class="command">using</span></span> Var hd_u_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>chop <span class="skolem">u</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> 
              <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> App <span class="quoted"><span class="quoted">‹chop <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="skolem">t</span>›</span></span> t_App add_mset_lt_lt_le less_imp_le mset_lt_single_iff hsize_chop_lt tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def 
              <span class="keyword1"><span class="command">using</span></span> Var <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sym <span class="skolem">f</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">u</span> <span class="skolem">s</span>"</span></span> 
         <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
           <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd _<span class="main">)</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
             <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">next</span></span>
           <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="skolem">s</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> Sym gt_same_t_s<span class="main">(</span>1<span class="main">)</span> gt_same_t_s<span class="main">(</span>2<span class="main">)</span> hd_u_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span><span class="main">]</span> 
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> App add_mset_lt_right_lt mset_lt_single_iff hsize_chop_lt tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> u_gt_t<span class="main">)</span>
           <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def
             <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
         <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sym<span class="main">)</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span>local.ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>›</span></span> gt_same hd_u_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Irreflexivity›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">hsize</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> s_gt_s <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> s_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> gt_chop
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gt.gt_chop gt_trans hsize_chop_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_hd_irrefl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same
    <span class="keyword1"><span class="command">note</span></span> in_grounds <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">si</span></span> <span class="keyword2"><span class="keyword">where</span></span> si_in_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> si_gt_si<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">si</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_grounds
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> all_not_in_conv extf_irrefl_from_trans ground_heads_nonempty gt_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hsize <span class="skolem">si</span> <span class="main">&lt;</span> hsize <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hsize_in_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> si_in_args<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ si_gt_si<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gt_irrefl gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Compatibility with Embedding Relation"</span></span>

<span class="comment1">(* TODO: move? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nth_drop_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟶</span> <span class="bound">i</span> <span class="main">≥</span> <span class="free">k</span> <span class="main">⟶</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> drop <span class="free">k</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span>  <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> leI length_Cons not_less_zero nth_equalityI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">m</span> <span class="skolem">xs</span> <span class="main">=</span> drop <span class="skolem">m</span> <span class="skolem">ys</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_le_mono Suc_mono length_Cons nth_Cons_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_embedding_step_property<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> hsize <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">+</span></span> hsize <span class="bound"><span class="bound">s</span></span>"</span></span></span>
      <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> tm"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tt</span> <span class="bound">ss</span><span class="main">.</span> hsize <span class="bound">tt</span> <span class="main">+</span> hsize <span class="bound">ss</span> <span class="main">&lt;</span> hsize <span class="skolem">t</span> <span class="main">+</span> hsize <span class="skolem">s</span> <span class="main">⟹</span> <span class="bound">tt</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">ss</span> <span class="main">⟹</span> <span class="bound">tt</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ss</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">s</span>›</span></span> emb_step_at_is_App emb_step_equiv<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"position_of <span class="skolem">t</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">s</span>›</span></span> emb_step_equiv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> position_if_emb_step_at<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_rep_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> Left"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Embedding removes an argument i›</span></span>
      <span class="keyword3"><span class="command">case</span></span> Left
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> num_args <span class="skolem">t</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span>  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" head <span class="skolem">t</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"args <span class="skolem">s</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> emb_step_at_remove_arg Left True <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹position_of <span class="skolem">t</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">d</span><span class="main">]</span><span class="main">)</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">s</span> <span class="main">⟹</span> chop <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">s</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">s</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>          
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_num_args True <span class="quoted"><span class="quoted">‹args <span class="skolem">s</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> append_self_conv2 cancel_comm_monoid_add_class.diff_cancel diff_Suc_1 i_def length_drop length_replicate q_rep_t take_eq_Nil<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="main">(</span>replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> Left<span class="main">)</span> Right <span class="main">(</span>chop <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span>
                emb_step_at <span class="main">(</span>replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> Left<span class="main">)</span> Right <span class="skolem">t</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> merge_emb_step_at<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> Left"</span></span> <span class="quoted">Right</span> <span class="quoted">Nil</span> <span class="quoted">Right</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span> <span class="operator">unfolded</span> append_Nil2 opp_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> replicate_append_same<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> chop_emb_step_at replicate_Suc<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="main">(</span>replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> dir.Left<span class="main">)</span> dir.Right <span class="main">(</span>chop <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> chop <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> chop_emb_step_at<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span>›</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> merge_emb_step_at<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> Left"</span></span> <span class="quoted">Right</span> <span class="quoted">Nil</span> <span class="quoted">Left</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span> <span class="operator">unfolded</span> append_Nil2 opp_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> replicate_append_same<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Left True <span class="quoted"><span class="quoted">‹Suc <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> q_rep_t replicate_Suc<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">s</span>›</span></span> emb_step_equiv emb_step_hsize nat_neq_iff hsize_chop<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">s</span>"</span></span> 
        <span class="keyword1"><span class="command">have</span></span> p_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> Left"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="skolem">p</span>›</span></span> list_all_iff replicate_length_same<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> length_p<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_position_replicate_num_args <span class="quoted"><span class="quoted">‹position_of <span class="skolem">t</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">d</span><span class="main">]</span><span class="main">)</span>›</span></span> 
            replicate_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">-</span> num_args <span class="skolem">t</span>"</span></span> <span class="quoted">Left</span><span class="main">]</span>  p_rep q_rep_t
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Left add_diff_inverse_nat replicate_app_Cons_same replicate_append_same shallower_pos<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">≤</span> length <span class="skolem">q</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Suc_num_args <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> q_rep_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">&lt;</span> length <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False le_neq_implies_less p_rep q_rep_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span>Left<span class="main">]</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">p</span> <span class="main">≤</span> length <span class="skolem">q</span>›</span></span> length_replicate min.orderE nth_replicate p_rep q_rep_t take_Suc_conv_app_nth take_replicate<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span>Left<span class="main">]</span> <span class="main">@</span> <span class="skolem">q'</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append_take_drop_id<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons_nth_drop_Suc Suc_num_args <span class="quoted"><span class="quoted">‹args <span class="skolem">s</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> add_Suc_right append_take_drop_id diff_Suc_1 length_Cons length_append<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span> <span class="main">=</span> emb_step_at <span class="skolem">p</span> dir.Left <span class="main">(</span>chop <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> swap_nested_emb_step_at<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q'</span></span> <span class="quoted">Right</span> <span class="quoted">Left</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> chop_emb_step_at<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span>›</span></span><span class="main">]</span>
            chop_emb_step_at<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span><span class="main">]</span>  
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons_replicate_eq Left <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span>dir.Left<span class="main">]</span> <span class="main">@</span> <span class="skolem">q'</span>›</span></span> append.assoc append_Cons diff_Suc_1 p_rep q_rep_t replicate_append_same<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">s</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Left <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹position_of <span class="skolem">t</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">d</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span>dir.Left<span class="main">]</span> <span class="main">@</span> <span class="skolem">q'</span>›</span></span> chop_emb_step_at emb_step_at_if_position pos_emb_step_at_nested q_rep_t<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_Var <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def chkchop_def  <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span><span class="main">]</span> 
           add_less_mono hsize_chop_lt <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span> <span class="main">⟹</span> chop <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def chkchop_def 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> add_less_mono gt_chop ih hsize_chop_lt 
        <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span> <span class="main">⟹</span> chop <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span>local.ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> extf_ext_insert_arg<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"take <span class="skolem">i</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹args <span class="skolem">s</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span>›</span></span> id_take_nth_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gt_same <span class="quoted"><span class="quoted">‹head <span class="skolem">t</span> <span class="main">=</span> head <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Embedding chops and might remove arguments from the left›</span></span>
      <span class="keyword3"><span class="command">case</span></span> Right
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> emb_step_at_chop
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Right True <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹position_of <span class="skolem">t</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">d</span><span class="main">]</span><span class="main">)</span>›</span></span> add_Suc gt_chop ih less_Suc_eq hsize_chop<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Embedding operates under one of the arguments›</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">t</span> <span class="main">=</span> num_args <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> emb_step_under_args_num_args<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span> <span class="bound">d</span><span class="main">.</span> num_args <span class="main">(</span>emb_step_at <span class="skolem">p</span> <span class="bound">d</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> num_args <span class="bound">t</span>›</span></span> <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹num_args <span class="skolem">t</span> <span class="main">=</span> num_args <span class="skolem">s</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd length_0_conv <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> q_rep_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> replicate <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> Left"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  q_rep_t <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹num_args <span class="skolem">t</span> <span class="main">=</span> num_args <span class="skolem">s</span>›</span></span> args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_snoc length_butlast tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">p</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True q_rep_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> False 
          <span class="keyword1"><span class="command">using</span></span> list_all_length q_rep_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">!</span> <span class="main">(</span>num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Right"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">!</span> num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">≠</span> Right"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">!</span> num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Left"</span></span> <span class="keyword1"><span class="command">using</span></span> dir.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>num_args <span class="skolem">t</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> replicate <span class="main">(</span>num_args <span class="skolem">t</span><span class="main">)</span> Left"</span></span> <span class="keyword1"><span class="command">using</span></span> True Suc_num_args<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span><span class="main">]</span> q_rep_t
            take_Suc_conv_app_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span> replicate_Suc replicate_append_same<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹num_args <span class="skolem">t</span> <span class="main">=</span> num_args <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹num_args <span class="skolem">t</span> <span class="main">=</span> num_args <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹position_of <span class="skolem">t</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">d</span><span class="main">]</span><span class="main">)</span>›</span></span> 
              append.assoc append_eq_Cons_conv append_take_drop_id no_position_replicate_num_args shallower_pos<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">@</span> <span class="main">[</span>Right<span class="main">]</span> <span class="main">@</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc True <span class="quoted"><span class="quoted">‹num_args <span class="main">(</span>fun <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span> append_Cons append_Nil append_eq_conv_conj length_replicate q_rep_t<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emb_step_at <span class="main">(</span><span class="skolem">q</span> <span class="main">@</span> <span class="skolem">q'</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">(</span>chop <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> chop <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> chop_emb_step_at<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span><span class="main">]</span> chop_emb_step_at<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span>›</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">using</span></span> swap_nested_emb_step_at<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">q'</span></span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted">Right</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span> <span class="operator">unfolded</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">@</span> <span class="main">[</span>Right<span class="main">]</span> <span class="main">@</span> <span class="skolem">q'</span>›</span></span> 
        q_rep_t q_rep_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span> <span class="main">≠</span> chop <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">s</span>›</span></span> emb_step_hsize nat_less_le hsize_chop<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">s</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> emb_step_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> takepq<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">q</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> q_rep_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> takeqp<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">≤</span> length <span class="skolem">q</span> <span class="main">⟹</span> take <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Left<span class="main">)</span> <span class="skolem">p</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> list_all_length<span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> diff_diff_cancel take_replicate length_replicate  nth_replicate q_rep_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span> <span class="main">=</span> emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">(</span>chop <span class="skolem">t</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> swap_disjunct_emb_step_at<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted">Right</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span> <span class="operator">OF</span> takeqp takepq<span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> chop_emb_step_at q_rep_s q_rep_t
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chop_emb_step_at<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹position_of <span class="skolem">t</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">d</span><span class="main">]</span><span class="main">)</span>›</span></span> chop_emb_step_at emb_step_at_if_position length_replicate nat_le_linear pos_emb_step_at_disjunct q_rep_t take_all takeqp<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gt1<span class="main">:</span><span class="quoted"><span class="quoted">"chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>  
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var _<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹chop <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> add_strict_mono hsize_chop_lt<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Var<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sym _<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹chop <span class="skolem">t</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> chop <span class="skolem">s</span>›</span></span> 
         <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> add_Suc add_Suc_shift chkchop_def gt_trans ih 
         less_Suc_eq hsize_chop t_gt_chop_t 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> gt2<span class="main">:</span><span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_under_args_head False <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> gt3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span>local.ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">∈</span>local.ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span>"</span></span>
        <span class="quoted"><span class="quoted">"args <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> args <span class="main">(</span>emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> num_args <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> args <span class="skolem">t</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> args <span class="main">(</span>emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> emb_step_under_args_emb_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹position_of <span class="skolem">t</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">d</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> compat_list1<span class="main">:</span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> args <span class="skolem">s</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹num_args <span class="skolem">t</span> <span class="main">=</span> num_args <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span>  add_less_mono i_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ih nth_mem hsize_in_args<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> compat_list2<span class="main">:</span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≠</span> args <span class="skolem">s</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> emb_step_equiv i_def<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> argst<span class="main">:</span><span class="quoted"><span class="quoted">"args <span class="skolem">t</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> args <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_nth_drop_Suc i_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> argss<span class="main">:</span><span class="quoted"><span class="quoted">"args <span class="skolem">s</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> args <span class="main">(</span>emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">i</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_take_lemma<span class="main">)</span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹num_args <span class="skolem">t</span> <span class="main">=</span> num_args <span class="skolem">s</span>›</span></span> i_def<span class="main">(</span>1<span class="main">)</span> i_def<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_drop_lemma<span class="main">)</span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹num_args <span class="skolem">t</span> <span class="main">=</span> num_args <span class="skolem">s</span>›</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_le_eq i_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> Suc_n_not_le_n <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> i_def<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> <span class="quoted"><span class="quoted">‹num_args <span class="skolem">t</span> <span class="main">=</span> num_args <span class="skolem">s</span>›</span></span> i_def<span class="main">(</span>1<span class="main">)</span> id_take_nth_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  extf_compat_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"args <span class="main">(</span>emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted">gt</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">i</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹emb_step_at <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>›</span></span> argss argst compat_list1 compat_list2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gt_same <span class="keyword1"><span class="command">using</span></span> gt1 gt2 gt3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> gt_embedding_property<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⊵<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">t</span> <span class="skolem">u</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> gt_embedding_step_property gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subterm Property›</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> gt_proper_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"proper_sub <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> gt_embedding_property sub_emb <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span>
  gt_emb_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  gt_emb_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_embedding_step_property left right<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compatibility with Contexts›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_fun_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"fun <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_fun gt_embedding_step_property gt_trans tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.exhaust_sel tm.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_arg_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emb_step_arg gt_embedding_step_property gt_trans tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.exhaust_sel tm.sel<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_compat_fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>atomize_imp<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> hsize <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">+</span></span> hsize <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">t'</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> App <span class="bound"><span class="bound">s</span></span> <span class="free"><span class="free">t'</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> App <span class="bound"><span class="bound">s</span></span> <span class="bound"><span class="bound">t</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> 
  <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> hsize <span class="bound">ta</span> <span class="main">+</span> hsize <span class="bound">sa</span> <span class="main">&lt;</span> hsize <span class="skolem">t</span> <span class="main">+</span> hsize <span class="skolem">s</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟹</span> App <span class="bound">sa</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="bound">sa</span> <span class="bound">ta</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> t'_gt_t<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> 

  <span class="keyword1"><span class="command">have</span></span> t'_ne_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">≠</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_antisym t'_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> extf_args_single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">t'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf_compat_list t'_gt_t t'_ne_t<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"App <span class="skolem">s</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>App <span class="skolem">s</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span>local.ground_heads <span class="main">(</span>head <span class="main">(</span>App <span class="skolem">s</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="skolem">s</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf_args_single<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"chop <span class="main">(</span>App <span class="skolem">s</span> <span class="free">t'</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd _<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> chop_App_Hd
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chop_App_Hd t'_gt_t<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span><span class="main">]</span> chop_fun 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_add_left_cancel_less hsize_chop_lt t'_gt_t tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>App <span class="skolem">s</span> <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_Var <span class="main">(</span>head <span class="main">(</span>App <span class="skolem">s</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def chkchop_def
        <span class="keyword1"><span class="command">using</span></span> True 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"App <span class="skolem">s</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_chop<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def chkchop_def 
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_compat_arg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> App <span class="free">s'</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>atomize_imp<span class="main"><span class="keyword3">,</span></span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>measure_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">s'</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> hsize <span class="bound"><span class="bound">s'</span></span> <span class="main"><span class="main">+</span></span> hsize <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">+</span></span> hsize <span class="bound"><span class="bound">t</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">s'</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="free"><span class="free">t'</span></span> <span class="keyword1"><span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> App <span class="bound"><span class="bound">s'</span></span> <span class="free"><span class="free">t'</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> App <span class="bound"><span class="bound">s</span></span> <span class="bound"><span class="bound">t</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">s'</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">s</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> atomize_all<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="skolem">s</span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ab</span> <span class="bound">ac</span> <span class="bound">ba</span><span class="main">.</span> hsize <span class="bound">ab</span> <span class="main">+</span> hsize <span class="bound">ac</span> <span class="main">+</span> hsize <span class="bound">ba</span> <span class="main">&lt;</span> hsize <span class="skolem">s'</span> <span class="main">+</span> hsize <span class="skolem">s</span> <span class="main">+</span> hsize <span class="skolem">t</span> <span class="main">⟹</span> <span class="bound">ab</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ac</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ba</span> <span class="main">⟹</span> App <span class="bound">ab</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="bound">ac</span> <span class="bound">ba</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> 

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s''</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword3"><span class="command">assume</span></span> hsize_s''<span class="main">:</span><span class="quoted"><span class="quoted">"hsize <span class="skolem">s''</span> <span class="main">≤</span> hsize <span class="skolem">s'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> chkchop_s'_s<span class="main">:</span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">s''</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>App <span class="skolem">s''</span> <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_Hd <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> chkchop_s'_s <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">t'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>›</span></span> chop_App_Hd gt_arg_imp gt_emb_arg tm.sel<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> chkchop_s'_s <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s''</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> hsize_s''
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">t'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>›</span></span> add_less_mono add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chop_fun le_eq_less_or_eq nat_add_left_cancel_less hsize_chop_lt tm.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> chkchop_compat_arg <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"App <span class="skolem">s'</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="skolem">s</span> <span class="skolem">t</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>gt.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> gt_chop
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True gt.gt_chop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"App <span class="skolem">s'</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"App <span class="skolem">s</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> gt_chop chkchop_compat_arg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s'</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_strict_right_mono chop_fun ih hsize_chop_lt tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"App <span class="skolem">s'</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="main">(</span>chop <span class="skolem">s'</span><span class="main">)</span> <span class="free">t'</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> context_left emb_step_chop gt_embedding_step_property local.gt_chop<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>›</span></span> gt_compat_fun local.gt_chop<span class="main">(</span>1<span class="main">)</span> local.gt_chop<span class="main">(</span>2<span class="main">)</span> hsize_chop_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> chkchop_compat_arg gt.gt_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same
    <span class="keyword1"><span class="command">have</span></span> hd_s'_eq_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s'</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.gt_same<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> f_gh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> f_s_args<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">s'</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> local.gt_same<span class="main">(</span>3<span class="main">)</span> f_gh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_s'_eq_s<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f_compat_snoc<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">x</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="bound">ys</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf_compat_append_right<span class="main">)</span>
     
      <span class="keyword1"><span class="command">have</span></span> f_st_args2<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="skolem">s'</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_compat_snoc f_s_args<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="bound">z</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">z</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">x</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_trans<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="bound">zs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="bound">ys</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="bound">zs</span> <span class="bound">xs</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span>  extf_trans<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">unfolded</span> lists_UNIV<span class="main">,</span> <span class="operator">OF</span> UNIV_I UNIV_I UNIV_I 0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="skolem">s'</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f_st_args2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> f_st_args1<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="skolem">s'</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="skolem">s'</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> extf_compat_list <span class="quoted"><span class="quoted">‹<span class="free">t'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>›</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f_trans f_st_args1 f_st_args2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> extf_cond <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>App <span class="skolem">s'</span> <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def
      <span class="keyword1"><span class="command">using</span></span> args.simps<span class="main">(</span>1<span class="main">)</span> chop_fun chkchop_compat_arg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s'</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> le_eq_less_or_eq<span class="main">]</span> 
      chkchop_compat_arg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> chkchop_def chkchop_same_def 
      hsize_chop_lt   epo.extf_min_empty<span class="main">[</span><span class="operator">OF</span> epo_axioms<span class="main">]</span> gt.gt_same gt_antisym hd_s'_eq_s head_App 
      leI less_irrefl_nat local.gt_same<span class="main">(</span>2<span class="main">)</span> local.gt_same<span class="main">(</span>3<span class="main">)</span> tm.collapse<span class="main">(</span>1<span class="main">)</span> tm.sel<span class="main">(</span>4<span class="main">)</span> tm.sel<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> extf_cond gt.gt_same hd_s'_eq_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_compat_fun_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t'_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apps <span class="free">s</span> <span class="main">(</span><span class="free">t'</span> <span class="main">#</span> <span class="free">us</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> apps <span class="free">s</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">us</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_compat_fun t'_gt_t<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> App_apps<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> append_Cons<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> gt_compat_arg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_or_eq_compat_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> App <span class="free">s'</span> <span class="free">t'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gt_compat_fun gt_compat_arg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_compat_App<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> App <span class="free">s'</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gt_compat_fun gt_compat_arg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Stability under Substitutions"</span></span>

<span class="comment1">(* TODO: move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> extf_map2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">ys</span> <span class="main">∪</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="free">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="free">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> extf_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"set <span class="free"><span class="free">ys</span></span> <span class="main"><span class="main">∪</span></span> set <span class="free"><span class="free">xs</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ys</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_listsI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_listsI<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> gt_antisym <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> gt_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_sus<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> ρ_wary<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ghd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> ground_heads <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span> <span class="comment1">(* This condition is only needed for gt_same, not for gt_diff ! *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst <span class="free">ρ</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>atomize_imp<span class="main"><span class="keyword3">,</span></span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>measure_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span> hsize <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> hsize <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">#}</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> subst <span class="free"><span class="free">ρ</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> subst <span class="free"><span class="free">ρ</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> atomize_all<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tt</span> <span class="bound">ss</span><span class="main">.</span>
               <span class="main">{#</span> hsize <span class="bound">tt</span><span class="main">,</span> hsize <span class="bound">ss</span> <span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span> hsize <span class="skolem">t</span><span class="main">,</span> hsize <span class="skolem">s</span> <span class="main">#}</span> <span class="main">⟹</span>
               <span class="bound">tt</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ss</span> <span class="main">⟹</span> subst <span class="free">ρ</span> <span class="bound">tt</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">ss</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> t_gt_s_chop<span class="main">:</span> gt_chop
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> emb_step_subst emb_step_chop<span class="main">[</span><span class="operator">OF</span> t_gt_s_chop<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> gt_embedding_step_property 
       emb_step_hsize gt_trans ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_lt_left_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> t_gt_s_diff<span class="main">:</span> gt_diff
    <span class="keyword1"><span class="command">have</span></span> gt_diff1<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms gt_hd_def subsetCE t_gt_s_diff<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wary_subst_ground_heads<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> gt_diff2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_Sym <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_imp_subst_iden hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> head_subst t_gt_s_diff<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> gt_diff3<span class="main">:</span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>    
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd _<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> t_gt_s_diff <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_imp_subst_iden hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> tm.disc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> s_App<span class="main">:</span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t_gt_s_diff <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span><span class="main">]</span> chop_subst_Sym hsize_chop_lt tm.disc<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_lt_left_lt add_mset_lt_right_lt<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_diff gt_diff1 gt_diff2 gt_diff3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> t_gt_s_same<span class="main">:</span> gt_same
    <span class="keyword1"><span class="command">have</span></span> gt_same1<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_gt_s_same<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> extf_map_ts<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span>ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> ih_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">x</span> <span class="main">⟶</span> subst <span class="free">ρ</span> <span class="bound">y</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff less_multiset_doubletons hsize_in_args ih<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span>ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>  
        <span class="keyword1"><span class="command">using</span></span> ghd t_gt_s_same<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> extf_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"args <span class="skolem">s</span>"</span></span> <span class="quoted">gt</span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> gt_irrefl gt_trans ih_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x1</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_Var <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span> <span class="main">⊆</span> ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"hsize <span class="skolem">u</span> <span class="main">≤</span> hsize <span class="main">(</span>subst <span class="free">ρ</span> <span class="main">(</span>Hd <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"apps <span class="skolem">u</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> apps <span class="skolem">u</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"hsize <span class="skolem">u</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="skolem">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>less_induct<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> less
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> u_Hd<span class="main">:</span> <span class="main">(</span>Hd _<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"args <span class="skolem">u</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> s_Hd<span class="main">:</span> <span class="main">(</span>Hd _<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main">)</span> 
                <span class="keyword1"><span class="command">using</span></span> extf_map_ts  args_Nil_iff_is_Hd s_Hd u_Hd <span class="quoted"><span class="quoted">‹args <span class="skolem">u</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> s_App<span class="main">:</span> <span class="main">(</span>App _ _<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">t</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_Nil_iff_is_Hd extf_min_empty gt_hd_def gt_hd_irrefl t_gt_s_same<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="skolem">s</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹is_Var <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span>›</span></span> s_App t_gt_s_same<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> less_multiset_doubletons s_App hsize_chop_lt tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  
              <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ut</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ut</span> <span class="main">=</span> apps <span class="skolem">u</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">=</span> apps <span class="skolem">u</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ss</span><span class="main">.</span> args <span class="main">(</span>apps <span class="skolem">u</span> <span class="bound">ss</span><span class="main">)</span> <span class="main">=</span> <span class="bound">ss</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹args <span class="skolem">u</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">have</span></span> chop_us<span class="main">:</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">us</span> <span class="main">=</span> subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="skolem">s</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">unfolding</span></span> chop_def subst_apps us_def 0 <span class="keyword1"><span class="command">using</span></span> hd_map
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> args_Nil_iff_is_Hd map_tl s_App tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> chop_ut<span class="main">:</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">ut</span> <span class="main">=</span> subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="skolem">t</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> chop_def subst_apps ut_def 0 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_App <span class="skolem">t</span>›</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> args_Nil_iff_is_Hd hd_map map_tl<span class="main">)</span>
  
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">ut</span> <span class="main">=</span> head <span class="skolem">us</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> us_def ut_def<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">ut</span> <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def chkchop_same_def 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0"</span> UNIV_witness <span class="quoted"><span class="quoted">‹is_Var <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="main">(</span>chop <span class="skolem">s</span><span class="main">)</span>›</span></span> 
                    args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chop_us chop_ut extf_map_ts extf_min_empty 
                    ghd gt_chop is_Var_def tm.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ut_def<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span>local.ground_heads <span class="main">(</span>head <span class="skolem">ut</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">ut</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">us</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> extf_map_ts less us_def ut_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ut</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">us</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> gt_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> u_app<span class="main">:</span> <span class="main">(</span>App _ _<span class="main">)</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ut</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"apps <span class="skolem">u</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?us</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"apps <span class="skolem">u</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"head <span class="var">?ut</span> <span class="main">=</span> head <span class="var">?ut</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"apps <span class="main">(</span>chop <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> apps <span class="main">(</span>chop <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> less.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">u</span>"</span></span><span class="main">]</span> hsize_chop_lt 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Var dual_order.trans ghd less.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_or_eq_imp_le subset_UNIV tm.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> u_app<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="var">?ut</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> chop <span class="var">?us</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chop_apps u_app<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ut</span> <span class="var">?us</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def chkchop_def 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I <span class="quoted"><span class="quoted">‹is_Var <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span>›</span></span> args_Nil_iff_is_Hd args_apps extf_compat_append_left 
                  extf_map_ts extf_min_empty ghd gt_chop is_Var_def<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span>local.ground_heads <span class="main">(</span>head <span class="var">?ut</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="var">?ut</span><span class="main">)</span> <span class="main">(</span>args <span class="var">?us</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> extf_compat_append_left extf_map_ts less.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gt_same 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">note</span></span> inner_induction <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inner_induction<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="main">(</span>Hd <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> subst_apps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Var ghd order_refl subset_UNIV t_gt_s_same<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm_collapse_apps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sym _<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_Sym <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> head <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t_gt_s_same <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def chkchop_def
        <span class="keyword1"><span class="command">using</span></span> Sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gt_same2<span class="main">:</span> <span class="quoted"><span class="quoted">"chkchop_same <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> chkchop_same_def chkchop_def
         <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span><span class="main">]</span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sym <span class="quoted"><span class="quoted">‹head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> head <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹is_Sym <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>›</span></span> 
             add_mset_commute add_mset_lt_left_lt chop_subst_Sym ground_imp_subst_iden hd.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> 
             hsize_chop_lt t_gt_s_same<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> gt_same3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span>local.ground_heads <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> head <span class="skolem">t</span>›</span></span> extf_compat_append_left extf_map_ts t_gt_s_same<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gt_same gt_same1 gt_same2 gt_same3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Totality on Ground Terms›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_total_ground<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> ext_total <span class="main">(</span><span class="free">extf</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ground <span class="free">t</span> <span class="main">⟹</span> ground <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">∨</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span> hsize <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> hsize <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">#}</span></span>"</span></span></span>
      <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> ground <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> ground <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">∨</span></span> <span class="bound"><span class="bound">s</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">∨</span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span> hsize <span class="bound">ta</span><span class="main">,</span> hsize <span class="bound">sa</span> <span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span> hsize <span class="skolem">t</span><span class="main">,</span> hsize <span class="skolem">s</span> <span class="main">#}</span> <span class="main">⟹</span> ground <span class="bound">ta</span> <span class="main">⟹</span> ground <span class="bound">sa</span> <span class="main">⟹</span>
      <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">∨</span> <span class="bound">sa</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">∨</span> <span class="bound">ta</span> <span class="main">=</span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span> <span class="main">∨</span> <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">∨</span> <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def tm.case_eq_if <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_mset_commute add_mset_lt_left_lt gr_s gr_t ground_chop gt_chop hsize_chop_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> chkchop_def tm.case_eq_if <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"chop <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_lt_left_lt gr_s gr_t ground_chop gt_chop.intros gt_iff_chop_diff_same hsize_chop_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      chkembs_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      chkembs_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"chkchop <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> Sym <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gr_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_head hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="main">=</span> Sym <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gr_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_head hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> g_gt_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> chkembs_t_s f g g_gt_f gt_diff gt_sym_imp_hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> f_gt_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> chkembs_s_t f f_gt_g g gt_diff gt_sym_imp_hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> g_eq_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> hd_t<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> g f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"args <span class="skolem">s</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> gr_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> set <span class="var">?ts</span><span class="main">.</span> ground <span class="bound">ta</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ground_args<span class="main">[</span><span class="operator">OF</span> _ gr_t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> gr_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> set <span class="var">?ss</span><span class="main">.</span> ground <span class="bound">sa</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ground_args<span class="main">[</span><span class="operator">OF</span> _ gr_s<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> ts_eq_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">=</span> <span class="var">?ss</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hd_t ts_eq_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tm_expand_apps<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> ts_gt_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ts</span> <span class="var">?ss</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> chkembs_t_s g gt_same hd_t ts_gt_ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> ss_gt_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ss</span> <span class="var">?ts</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> chkembs_s_t f g_eq_f gt_same hd_t ss_gt_ts <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ih gr_ss gr_ts
          ext_total.total<span class="main">[</span><span class="operator">OF</span> extf_total<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="var">?ts</span> <span class="main">∪</span> set <span class="var">?ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> less_multiset_doubletons epo_axioms hsize_in_args in_listsI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sym_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-foundedness›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gtg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ghd_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">ground_heads_var</span> <span class="bound">x</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> ext_wf <span class="main">(</span><span class="free">extf</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ground_wfP<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> inf_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def bad_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"worst_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> hsize <span class="bound">t</span> <span class="main">&gt;</span> hsize <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U_of</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⊳<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">u</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">note</span></span> wf_sz <span class="main">=</span> wf_app<span class="main">[</span><span class="operator">OF</span> wellorder_class.wf<span class="main">,</span> <span class="operator">of</span> <span class="quoted">hsize</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?U_of</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> ground <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> worst_chain_bad<span class="main">[</span><span class="operator">OF</span> wf_sz t_bad<span class="main">,</span> <span class="operator">unfolded</span> inf_chain_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">have</span></span> gr_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> ground <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> U_def
      <span class="keyword1"><span class="command">using</span></span> gr ground_emb <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> u_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?U_of</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ti</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="skolem">i</span>"</span></span>

      <span class="keyword3"><span class="command">assume</span></span> u_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> sz_u<span class="main">:</span> <span class="quoted"><span class="quoted">"hsize <span class="skolem">u</span> <span class="main">&lt;</span> hsize <span class="var">?ti</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> emb_hsize_neq u_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> sz_u min_worst_chain_0<span class="main">[</span><span class="operator">OF</span> wf_sz u_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Suc
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> worst_chain_pred<span class="main">[</span><span class="operator">OF</span> wf_sz t_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="skolem">i</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt_embedding_property u_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_trans<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> Suc sz_u min_worst_chain_Suc<span class="main">[</span><span class="operator">OF</span> wf_sz u_bad<span class="main">]</span> gr <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> u_good<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> <span class="main">¬</span> bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> bad_diff_same<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="var">?ff</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ground <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gr<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="skolem">i</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> worst_chain_pred<span class="main">[</span><span class="operator">OF</span> wf_sz t_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> gt_chop <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"gt_chop <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?U_of</span> <span class="skolem">i</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> emb_step_chop emb_step_is_emb gt_chop gt_chop.cases gt_irrefl mem_Collect_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  uij_in<span class="main">:</span><span class="quoted"><span class="quoted">"chop <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="var">?ff</span> <span class="bound">n</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> worst_chain_pred<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_sz t_bad<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> uij_gt_i_plus_3<span class="main">:</span> <span class="quoted"><span class="quoted">"chop <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> a gt_chop.cases<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> chop <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gr gr_u<span class="main"><span class="main">[</span></span><span class="operator">OF</span> uij_in<span class="main"><span class="main">]</span></span> uij_gt_i_plus_3 worst_chain_pred<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_sz t_bad<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="main">(</span>chop <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> bad_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> u_good<span class="main">[</span><span class="operator">OF</span> uij_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"gt_diff <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> gt_same <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt <span class="keyword1"><span class="command">unfolding</span></span> gt_iff_chop_diff_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">s</span> <span class="main">∧</span> ground <span class="bound">t</span> <span class="main">∧</span> sym <span class="main">(</span>head <span class="bound">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sym_wf <span class="keyword1"><span class="command">unfolding</span></span> wfP_def wf_iff_no_infinite_down_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
      <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">s</span> <span class="main">∧</span> ground <span class="bound">t</span> <span class="main">∧</span> sym <span class="main">(</span>head <span class="bound">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gt_diff_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"gt_diff <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_iff_chop_diff_same gt_imp_vars <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s ground_head<span class="main">[</span><span class="operator">OF</span> gr_s<span class="main">]</span> ground_head<span class="main">[</span><span class="operator">OF</span> gr_t<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_hd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> wf_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> diff_O_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span> <span class="keyword1">O</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
      <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gt_diff.simps gt_same.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> chkchop_def chkchop_same_def gt_same gt_trans<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> diff_same_as_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> bad_same<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_infinite_down_chain_compatible<span class="main">[</span><span class="operator">OF</span> wf_diff _ diff_O_same<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span><span class="main">]</span> bad_diff_same
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def diff_same_as_union<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> hd_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> is_Sym <span class="main">(</span>head <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_head<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> sym <span class="main">(</span>head <span class="main">(</span><span class="var">?ff</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> hd_eq_f<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sym <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_sym<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ia</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_same <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gtu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">thm</span></span> UnionI CollectI
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> UnionI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?U_of</span></span> <span class="skolem"><span class="skolem">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> arg_emb CollectI arg_emb hsize_in_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bad_same hd_eq_f <span class="keyword1"><span class="command">unfolding</span></span>  inf_chain_def gt_same.simps f_def hd.collapse<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ground_head<span class="main">,</span> <span class="operator">OF</span> gr<span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> extf_mono_strong<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="main">]</span> ground_hd_in_ground_heads 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ground_args<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtu</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> extf_mono_strong<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtu</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> nwf_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtu</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">have</span></span> gtu_le_gtg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gtu</span> <span class="main">≤</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gr_u<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?gtu</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
      <span class="keyword3"><span class="command">assume</span></span> bad_f<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="var">?gtu</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> bad_f0<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?gtu</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inf_chain_bad<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_f <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> good_f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bad <span class="var">?gtu</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> u_good bad_f inf_chain_bad inf_chain_subset<span class="main">[</span><span class="operator">OF</span> _ gtu_le_gtg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> bad_f0 good_f0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wf_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtu</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext_wf.wf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> extf_wf<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> nwf_ext wf_ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subst grounding_ρ"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?subst</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub></span> <span class="var">?subst</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wfP_app<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ground_wfP<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?subst</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?subst</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_grounding_ρ<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_sus ghd_UNIV ground_heads.simps<span class="main">(</span>1<span class="main">)</span> wary_grounding_ρ wfP_eq_minimal
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>