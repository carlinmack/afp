<div id="Factor_Bound_2">
<div class="head">
<h1>Theory Factor_Bound_2</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Jose Divasón
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Factor bound›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory extends the work about factor bounds which was carried out 
  in the Berlekamp-Zassenhaus development.›</span></span> 

<span class="keyword1"><span class="command">theory</span></span> Factor_Bound_2
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Berlekamp_Zassenhaus/Factor_Bound.html">Berlekamp_Zassenhaus.Factor_Bound</a>
   <a href="../LLL_Basis_Reduction/Norms.html">LLL_Basis_Reduction.Norms</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Factor_Bound_2-norm_1_bound_mignotte"><span class="command">lemma</span></span> norm_1_bound_mignotte<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="free">f</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>degree <span class="free">f</span><span class="main">)</span> <span class="main">*</span> mahler_measure <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> f0<span class="main">:</span> False
  <span class="keyword1"><span class="command">have</span></span> cf<span class="main">:</span> <span class="quoted"><span class="quoted">"coeffs <span class="free">f</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> coeff <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> Suc<span class="main">(</span> degree <span class="free">f</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> coeffs_def 
    <span class="keyword1"><span class="command">using</span></span> f0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>sum_list <span class="main">(</span>map abs <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>degree <span class="free">f</span><span class="main">.</span> real_of_int <span class="main">¦</span>poly.coeff <span class="free">f</span> <span class="bound">i</span><span class="main">¦</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cf of_int_hom.hom_sum_list <span class="keyword1"><span class="command">unfolding</span></span> sum_list_sum_nth 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>degree <span class="free">f</span><span class="main">.</span> real <span class="main">(</span>degree <span class="free">f</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> mahler_measure <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Mignotte_bound<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span>degree <span class="free">f</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{..</span>degree <span class="free">f</span><span class="main">}</span><span class="main">)</span> <span class="main">*</span> mahler_measure <span class="free">f</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> sum_distrib_right<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>degree <span class="free">f</span><span class="main">)</span> <span class="main">*</span> mahler_measure <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> choose_row_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm1_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mahler_measure_ge_0 norm1_def<span class="main">)</span>

<span class="keyword1" id="Factor_Bound_2-mahler_measure_l2norm"><span class="command">lemma</span></span> mahler_measure_l2norm<span class="main">:</span> <span class="quoted"><span class="quoted">"mahler_measure <span class="free">f</span> <span class="main">≤</span> sqrt <span class="main">(</span>of_int <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Landau_inequality_mahler_measure<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_poly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1" id="Factor_Bound_2-sq_norm_factor_bound"><span class="command">lemma</span></span> sq_norm_factor_bound<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">h</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="free">h</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">real_of_int</span>
  <span class="keyword1"><span class="command">have</span></span> h21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">∥</span><span class="free">h</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>norm1 <span class="free">h</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm2_le_norm1_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_le_iff of_int_power<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>degree <span class="free">h</span><span class="main">)</span> <span class="main">*</span> mahler_measure <span class="free">h</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> power_mono<span class="main">[</span><span class="operator">OF</span> norm_1_bound_mignotte<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm1_ge_0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="free">h</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>mahler_measure <span class="free">h</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_even_eq power_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="free">h</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>mahler_measure <span class="free">f</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> power_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mahler_measure_ge_0
    mahler_measure_dvd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f0 dvd<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="free">h</span><span class="main">)</span> <span class="main">*</span> <span class="var">?r</span> <span class="main">(</span><span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span><span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> real_sqrt_pow2<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mahler_measure <span class="free">f</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="var">?r</span> <span class="main">(</span><span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> power_mono<span class="main">[</span><span class="operator">OF</span> mahler_measure_l2norm<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mahler_measure_ge_0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>degree <span class="free">h</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">h</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="free">h</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_int_le_iff <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Missing_Dvd_Int_Poly">
<div class="head">
<h1>Theory Missing_Dvd_Int_Poly</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Jose Divasón
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Executable dvdm operation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains some results about division of integer polynomials which are not part of 
  Polynomial\_Factorization.Dvd\_Int\_Poly.thy. 

  Essentially, we give an executable implementation of division modulo m.
›</span></span> 

<span class="keyword1"><span class="command">theory</span></span> Missing_Dvd_Int_Poly
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Berlekamp_Zassenhaus/Poly_Mod_Finite_Field.html">Berlekamp_Zassenhaus.Poly_Mod_Finite_Field</a>
  <a href="../Berlekamp_Zassenhaus/Polynomial_Record_Based.html">Berlekamp_Zassenhaus.Polynomial_Record_Based</a>
  <a href="../Berlekamp_Zassenhaus/Hensel_Lifting.html">Berlekamp_Zassenhaus.Hensel_Lifting</a> <span class="comment1">(* for thm pdivmod_monic, should be moved *)</span>
  <a href="../Subresultants/Subresultant.html">Subresultants.Subresultant</a> <span class="comment1">(* for abbreviation pdivmod *)</span>
  <a href="../Perron_Frobenius/Cancel_Card_Constraint.html">Perron_Frobenius.Cancel_Card_Constraint</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*In mathematics, this lemma also works if q = 0 since degree 0 = -∞, but in Isabelle degree 0 = 0.*)</span>
<span class="keyword1" id="Missing_Dvd_Int_Poly-degree_div_mod_smult"><span class="command">lemma</span></span> degree_div_mod_smult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"int poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">g</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">r</span> <span class="main">&lt;</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> g1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="free">q</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> smult <span class="free">m</span> <span class="free">r</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">-</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> u_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> d_uq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> degree <span class="main">(</span><span class="free">u</span><span class="main">*</span><span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u degree_mult_right_le<span class="main">[</span><span class="operator">OF</span> q<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> degree <span class="main">(</span><span class="free">q</span><span class="main">*</span> <span class="free">u</span> <span class="main">+</span> smult <span class="free">m</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g1 g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>smult <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degree_smult_eq m_not0 r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> degree <span class="main">(</span><span class="free">u</span><span class="main">*</span><span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d_uq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> deg_mr_uq<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>smult <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> j2<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">q</span><span class="main">*</span> <span class="free">u</span> <span class="main">+</span> smult <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> degree <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_add_eq_left<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deg_mr_uq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> degree <span class="free">q</span> <span class="main">+</span> degree <span class="free">u</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_mult_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> q u_not0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">=</span> degree <span class="free">g</span> <span class="main">-</span> degree <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> j j2 <span class="quoted"><span class="quoted">‹degree <span class="main">(</span><span class="free">q</span> <span class="main">*</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> degree <span class="free">q</span> <span class="main">+</span> degree <span class="free">u</span>›</span></span> u 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Uniqueness of division algorithm for polynomials›</span></span>

<span class="keyword1" id="Missing_Dvd_Int_Poly-uniqueness_algorithm_division_poly"><span class="command">lemma</span></span> uniqueness_algorithm_division_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_ring<span class="main">,</span>semiring_1_no_zero_divisors<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="free">q1</span> <span class="main">+</span> <span class="free">r1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="free">q2</span> <span class="main">+</span> <span class="free">r2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">r1</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">r2</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q1</span> <span class="main">=</span> <span class="free">q2</span> <span class="main">∧</span> <span class="free">r1</span> <span class="main">=</span> <span class="free">r2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span>  <span class="free">g</span> <span class="main">*</span> <span class="free">q1</span> <span class="main">+</span> <span class="free">r1</span> <span class="main">-</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">q2</span> <span class="main">+</span> <span class="free">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 f2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">q1</span> <span class="main">-</span> <span class="free">q2</span><span class="main">)</span> <span class="main">+</span> <span class="free">r1</span> <span class="main">-</span> <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_diff_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">q1</span> <span class="main">-</span> <span class="free">q2</span><span class="main">)</span> <span class="main">=</span> <span class="free">r2</span> <span class="main">-</span> <span class="free">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> q_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q1</span> <span class="main">=</span> <span class="free">q2</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> q1_not_q2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q1</span> <span class="main">≠</span> <span class="free">q2</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">q1</span> <span class="main">-</span> <span class="free">q2</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="free">q1</span> <span class="main">-</span> <span class="free">q2</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> degree <span class="free">g</span>"</span></span>      
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_mult_right_le<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">r2</span> <span class="main">-</span> <span class="free">r1</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq nz degree_diff_less r1 r2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">=</span> <span class="free">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq q_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Dvd_Int_Poly-pdivmod_eq_pdivmod_monic"><span class="command">lemma</span></span> pdivmod_eq_pdivmod_monic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pdivmod <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> pdivmod_monic <span class="free">f</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> qr<span class="main">:</span> <span class="quoted"><span class="quoted">"pdivmod <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> QR<span class="main">:</span> <span class="quoted"><span class="quoted">"pdivmod_monic <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Q</span><span class="main">,</span><span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject mult_div_mod_eq qr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">=</span><span class="main">0</span> <span class="main">∨</span> degree <span class="skolem">r</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject assms degree_mod_less leading_coeff_0_iff qr zero_neq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="main">+</span> <span class="skolem">R</span>"</span></span>    
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QR assms pdivmod_monic<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span><span class="main">=</span><span class="main">0</span> <span class="main">∨</span> degree <span class="skolem">R</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pdivmod_monic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g QR<span class="main"><span class="main">]</span></span><span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">=</span><span class="skolem">Q</span> <span class="main">∧</span> <span class="skolem">r</span><span class="main">=</span><span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> uniqueness_algorithm_division_poly<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f1 f2 g0 r R<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> qr QR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> poly_mod
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pdivmod2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> Mp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>
 <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">ilc</span> <span class="main">=</span> inverse_p <span class="free">m</span> <span class="main">(</span><span class="main">(</span>lead_coeff <span class="main">(</span>Mp <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
      <span class="bound">h</span> <span class="main">=</span> Polynomial.smult <span class="bound">ilc</span> <span class="main">(</span>Mp <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> pseudo_divmod <span class="main">(</span>Mp <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Mp <span class="bound">h</span><span class="main">)</span> 
      <span class="keyword1">in</span> <span class="main">(</span>Polynomial.smult <span class="bound">ilc</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> poly_mod_prime_type
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Missing_Dvd_Int_Poly-dvdm_iff_pdivmod0"><span class="command">lemma</span></span> dvdm_iff_pdivmod0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">::</span> <span class="tfree">'a</span> mod_ring poly<span class="main">)</span> <span class="main">=</span> of_int_poly <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">G</span> <span class="main">::</span> <span class="tfree">'a</span> mod_ring poly<span class="main">)</span> <span class="main">=</span> of_int_poly <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">dvdm</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">(</span>pdivmod <span class="free">F</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="free">f</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mp_f_representative f<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="free">g</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mp_f_representative g<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>pdivmod <span class="free">F</span> <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">G</span> <span class="keyword1">dvd</span> <span class="free">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dvd_eq_mod_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="main">[</span><span class="operator">untransferred</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Missing_Dvd_Int_Poly-of_int_poly_Mp_0"><span class="command">lemma</span></span> of_int_poly_Mp_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_int_poly <span class="main">(</span>Mp <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span> <span class="tfree">'a</span> mod_ring poly<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Mp <span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Mp_f_representative map_poly_0 poly_mod.Mp_Mp<span class="main">)</span>

<span class="keyword1" id="Missing_Dvd_Int_Poly-uniqueness_algorithm_division_of_int_poly"><span class="command">lemma</span></span> uniqueness_algorithm_division_of_int_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"Mp <span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">::</span> <span class="tfree">'a</span> mod_ring poly<span class="main">)</span> <span class="main">=</span> of_int_poly <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">G</span> <span class="main">::</span> <span class="tfree">'a</span> mod_ring poly<span class="main">)</span> <span class="main">=</span> of_int_poly <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">G</span> <span class="main">*</span> <span class="free">Q</span> <span class="main">+</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">R</span> <span class="main">&lt;</span> degree <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Mp_f<span class="main">:</span> <span class="quoted"><span class="quoted">"Mp <span class="free">f</span> <span class="main">=</span> Mp <span class="free">g</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">r</span> <span class="main">&lt;</span> degree <span class="main">(</span>Mp <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">=</span> of_int_poly <span class="free">q</span> <span class="main">∧</span> <span class="free">R</span> <span class="main">=</span> of_int_poly <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> uniqueness_algorithm_division_poly<span class="main"><span class="main">[</span></span><span class="operator">OF</span> F _ _ R<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"Mp <span class="free">f</span> <span class="main">=</span> to_int_poly <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mp_f_representative<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"Mp <span class="free">g</span> <span class="main">=</span> to_int_poly <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mp_f_representative<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f''<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int_poly <span class="main">(</span>Mp <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Dp_Mp_eq Mp_f_representative 
        Mp_smult_m_0 add_cancel_left_right f map_poly_zero of_int_hom.map_poly_hom_add 
        to_int_mod_ring_hom.hom_zero to_int_mod_ring_hom.injectivity<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g''<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int_poly <span class="main">(</span>Mp <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Dp_Mp_eq Mp_f_representative 
        Mp_smult_m_0 add_cancel_left_right g map_poly_zero of_int_hom.map_poly_hom_add 
        to_int_mod_ring_hom.hom_zero to_int_mod_ring_hom.injectivity<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> of_int_poly <span class="main">(</span>Mp <span class="free">g</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Mp_f  f'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">G</span> <span class="main">*</span> of_int_poly <span class="free">q</span> <span class="main">+</span> of_int_poly <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g'' of_int_poly_hom.hom_add of_int_poly_hom.hom_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">G</span> <span class="main">*</span> of_int_poly <span class="free">q</span> <span class="main">+</span> of_int_poly <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>    
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"of_int_poly <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="main">(</span>of_int_poly <span class="free">r</span><span class="main">::</span><span class="tfree">'a</span> mod_ring poly<span class="main">)</span> <span class="main">&lt;</span> degree <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"of_int_poly <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>of_int_poly <span class="free">r</span><span class="main">::</span><span class="tfree">'a</span> mod_ring poly<span class="main">)</span> <span class="main">≤</span> degree <span class="main">(</span><span class="free">r</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_map_poly_le<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> degree <span class="main">(</span>Mp <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> degree <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g'<span class="main">)</span>    
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g0 <span class="keyword1"><span class="command">unfolding</span></span> g''<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> uniqueness_algorithm_division_to_int_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"Mp <span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">::</span> <span class="tfree">'a</span> mod_ring poly<span class="main">)</span> <span class="main">=</span> of_int_poly <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">G</span> <span class="main">::</span> <span class="tfree">'a</span> mod_ring poly<span class="main">)</span> <span class="main">=</span> of_int_poly <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">G</span> <span class="main">*</span> <span class="free">Q</span> <span class="main">+</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">R</span> <span class="main">&lt;</span> degree <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Mp_f<span class="main">:</span> <span class="quoted"><span class="quoted">"Mp <span class="free">f</span> <span class="main">=</span> Mp <span class="free">g</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">r</span> <span class="main">&lt;</span> degree <span class="main">(</span>Mp <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Mp <span class="free">q</span> <span class="main">=</span> to_int_poly <span class="free">Q</span> <span class="main">∧</span> Mp <span class="free">r</span> <span class="main">=</span> to_int_poly <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uniqueness_algorithm_division_of_int_poly<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mp_f_representative<span class="main">)</span>

<span class="keyword1" id="Missing_Dvd_Int_Poly-uniqueness_algorithm_division_Mp_Rel"><span class="command">lemma</span></span> uniqueness_algorithm_division_Mp_Rel<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> monic_Mpg<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span>Mp <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span> <span class="main">::</span> <span class="tfree">'a</span> mod_ring poly<span class="main">)</span> <span class="main">=</span> of_int_poly <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">G</span> <span class="main">::</span> <span class="tfree">'a</span> mod_ring poly<span class="main">)</span> <span class="main">=</span> of_int_poly <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> qr<span class="main">:</span> <span class="quoted"><span class="quoted">"pseudo_divmod <span class="main">(</span>Mp <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Mp <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> QR<span class="main">:</span> <span class="quoted"><span class="quoted">"pseudo_divmod <span class="free">F</span> <span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span><span class="main">,</span><span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"MP_Rel <span class="free">q</span> <span class="free">Q</span> <span class="main">∧</span> MP_Rel <span class="free">r</span> <span class="free">R</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> MP_Rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> uniqueness_algorithm_division_to_int_poly<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ f g<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> f_gq_r<span class="main">:</span> <span class="quoted"><span class="quoted">"Mp <span class="free">f</span> <span class="main">=</span> Mp <span class="free">g</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pdivmod_monic<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> monic_Mpg<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pdivmod_monic_pseudo_divmod qr monic_Mpg<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> monic_G<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> monic_Mpg
    <span class="keyword1"><span class="command">using</span></span> Mp_f_representative g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">G</span> <span class="main">*</span> <span class="free">Q</span> <span class="main">+</span> <span class="free">R</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pdivmod_monic<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> monic_G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pdivmod_monic_pseudo_divmod QR monic_G<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Mp <span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> monic_Mpg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">R</span> <span class="main">&lt;</span> degree <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pdivmod_monic<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> monic_G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pdivmod_monic_pseudo_divmod monic_G <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> QR<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free">r</span> <span class="main">&lt;</span> degree <span class="main">(</span>Mp <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pdivmod_monic<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> monic_Mpg<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pdivmod_monic_pseudo_divmod monic_Mpg <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> qr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">MP_Rel_Pair</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">in</span> MP_Rel <span class="bound">a</span> <span class="bound">c</span> <span class="main">∧</span> MP_Rel <span class="bound">b</span> <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Missing_Dvd_Int_Poly-pdivmod2_rel"><span class="command">lemma</span></span> pdivmod2_rel<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>MP_Rel <span class="main">===&gt;</span> MP_Rel <span class="main">===&gt;</span> MP_Rel_Pair<span class="main">)</span> <span class="main">(</span>pdivmod2<span class="main">)</span> <span class="main">(</span>pdivmod<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def MP_Rel_Pair_def<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> pm<span class="main">:</span> prime_field <span class="quoted"><span class="free">m</span></span> 
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> prime_field_def mod_ring_locale_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime_field <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> prime_field_def mod_ring_locale_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">F</span> <span class="skolem">g</span> <span class="skolem">G</span> <span class="skolem">a</span> <span class="skolem">b</span> 
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">f</span> <span class="skolem">F</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">g</span> <span class="skolem">G</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"pdivmod2 <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">a</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">∧</span> MP_Rel <span class="skolem">b</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">mod</span> <span class="skolem">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mp <span class="skolem">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> Mp_g <span class="main">=</span> True    
    <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Mp_g 2 <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> gG<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pm.mod_ring_rel <span class="main">(</span>lead_coeff <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lead_coeff <span class="skolem">G</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 2 
      <span class="keyword1"><span class="command">unfolding</span></span> pm.mod_ring_rel_def MP_Rel_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pm.mod_ring_rel <span class="main">===&gt;</span> pm.mod_ring_rel<span class="main">)</span> <span class="main">(</span>inverse_p <span class="free">m</span><span class="main">)</span> inverse"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_field.mod_ring_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> rel_inverse_p<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"pm.mod_ring_rel <span class="main">(</span>inverse_p <span class="free">m</span> <span class="main">(</span><span class="main">(</span>lead_coeff <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inverse <span class="main">(</span>lead_coeff <span class="skolem">G</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> gG <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span><span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Polynomial.smult <span class="main">(</span>inverse_p <span class="free">m</span> <span class="main">(</span>lead_coeff <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> Polynomial.smult <span class="main">(</span>inverse_p <span class="free">m</span> <span class="main">(</span>lead_coeff <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> Polynomial.smult <span class="main">(</span>inverse <span class="main">(</span>lead_coeff <span class="skolem">G</span><span class="main">)</span><span class="main">)</span> <span class="skolem">G</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> hH'<span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="var">?h</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def <span class="keyword1"><span class="command">unfolding</span></span> H 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted">"2"</span> MP_Rel_def M_to_int_mod_ring Mp_f_representative 
         rel_inverse_p functional_relation left_total_MP_Rel of_int_hom.map_poly_hom_smult 
         pm.mod_ring_rel_def right_unique_MP_Rel to_int_mod_ring_hom.injectivity to_int_mod_ring_of_int_M<span class="main">)</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mp <span class="main">(</span>Polynomial.smult <span class="main">(</span>inverse_p <span class="free">m</span> <span class="main">(</span>lead_coeff <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span> 
      <span class="main">=</span> Mp <span class="main">(</span>Polynomial.smult <span class="main">(</span>inverse_p <span class="free">m</span> <span class="main">(</span>lead_coeff <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> hH<span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">h</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hH' h <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> pseudo_fh<span class="main">:</span> <span class="quoted"><span class="quoted">"pseudo_divmod <span class="main">(</span>Mp <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>Mp <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>  
    <span class="keyword1"><span class="command">hence</span></span> lc_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lead_coeff <span class="skolem">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Polynomial.smult <span class="main">(</span>inverse_p <span class="free">m</span> <span class="main">(</span><span class="main">(</span>lead_coeff <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 3 pseudo_fh Mp_g 
      <span class="keyword1"><span class="command">unfolding</span></span> pdivmod2_def Let_def h <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 pseudo_fh Mp_g 
      <span class="keyword1"><span class="command">unfolding</span></span> pdivmod2_def Let_def h <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command">have</span></span> Mp_Rel_FH<span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">q</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">∧</span> MP_Rel <span class="skolem">x</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">mod</span> <span class="skolem">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> uniqueness_algorithm_division_Mp_Rel<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span>Mp <span class="skolem">h</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>        
        <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inverse_p <span class="free">m</span> <span class="main">(</span>lead_coeff <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> to_int_mod_ring <span class="main">(</span>inverse <span class="main">(</span>lead_coeff <span class="skolem">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rel_inverse_p <span class="keyword1"><span class="command">unfolding</span></span> pm.mod_ring_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"M <span class="main">(</span>inverse_p <span class="free">m</span> <span class="main">(</span>M <span class="main">(</span>poly.coeff <span class="skolem">g</span> <span class="main">(</span>degree <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">=</span> to_int_mod_ring <span class="main">(</span>inverse <span class="main">(</span>lead_coeff <span class="skolem">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_to_int_mod_ring Mp_coeff<span class="main">)</span>  
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> h <span class="keyword1"><span class="command">unfolding</span></span> Mp_coeff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"2"</span> H MP_Rel_def Mp_coeff aux degree_smult_eq gG hH' 
          inverse_zero_imp_zero lc_G left_inverse pm.mod_ring_rel_def to_int_mod_ring_hom.degree_map_poly_hom
          to_int_mod_ring_hom.hom_one to_int_mod_ring_times<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> monic_H<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hH H lc_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> of_int_poly <span class="skolem">f</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mp_f_representative poly_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pdivmod <span class="skolem">F</span> <span class="skolem">H</span> <span class="main">=</span> pdivmod_monic <span class="skolem">F</span> <span class="skolem">H</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pdivmod_eq_pdivmod_monic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monic_H<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> pseudo_divmod <span class="skolem">F</span> <span class="skolem">H</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pdivmod_monic_pseudo_divmod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monic_H<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pseudo_divmod <span class="skolem">F</span> <span class="skolem">H</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">H</span><span class="main">,</span> <span class="skolem">F</span> <span class="keyword1">mod</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> of_int_poly <span class="skolem">h</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> MP_Rel_def Mp_f_representative hH right_unique_MP_Rel right_unique_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pseudo_divmod <span class="main">(</span>Mp <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>Mp <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pseudo_fh<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> Mp_Rel_F_div_H<span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">q</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Mp_Rel_F_mod_H<span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">x</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">mod</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">H</span> <span class="main">=</span> Polynomial.smult <span class="main">(</span>lead_coeff <span class="skolem">G</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">G</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> H <span class="keyword1"><span class="command">using</span></span> div_smult_right<span class="main">[</span><span class="operator">OF</span> lc_G<span class="main">]</span> inverse_inverse_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_smult_right inverse_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> F_div_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">=</span> Polynomial.smult <span class="main">(</span>inverse <span class="main">(</span>lead_coeff <span class="skolem">G</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lc_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">a</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">G</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int_poly <span class="main">(</span>Polynomial.smult <span class="main">(</span>inverse_p <span class="free">m</span> <span class="main">(</span><span class="main">(</span>lead_coeff <span class="main">(</span>Mp <span class="skolem">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> 
        <span class="main">=</span> smult <span class="main">(</span>inverse <span class="main">(</span>lead_coeff <span class="skolem">G</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">H</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> MP_Rel_def M_to_int_mod_ring Mp_Rel_F_div_H Mp_f_representative 
            of_int_hom.map_poly_hom_smult pm.mod_ring_rel_def rel_inverse_p right_unique_MP_Rel 
            right_unique_def to_int_mod_ring_hom.injectivity to_int_mod_ring_of_int_M<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Mp_Rel_F_div_H
      <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def a F_div_G Mp_f_representative <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">b</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">mod</span> <span class="skolem">G</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Mp_Rel_F_mod_H b H inverse_zero_imp_zero lc_G    
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_smult_right<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> Mp_g_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Mp <span class="skolem">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pdivmod2 <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pdivmod2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> G0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Mp_g_0 2 <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">a</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def G0 a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">b</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">mod</span> <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def G0 a b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">a</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">div</span> <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"MP_Rel <span class="skolem">b</span> <span class="main">(</span><span class="skolem">F</span> <span class="keyword1">mod</span> <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Executable division operation modulo $m$ for polynomials›</span></span>

<span class="keyword1" id="Missing_Dvd_Int_Poly-dvdm_iff_Mp_pdivmod2"><span class="command">lemma</span></span> dvdm_iff_Mp_pdivmod2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">dvdm</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>Mp <span class="main">(</span>snd <span class="main">(</span>pdivmod2 <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>of_int_poly <span class="free">f</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> mod_ring poly"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>of_int_poly <span class="free">g</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> mod_ring poly"</span></span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="free">f</span> <span class="var">?F</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MP_Rel_def Mp_f_representative<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="free">g</span> <span class="var">?G</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MP_Rel_def Mp_f_representative<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MP_Rel_Pair <span class="main">(</span>pdivmod2 <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>pdivmod <span class="var">?F</span> <span class="var">?G</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pdivmod2_rel <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"MP_Rel <span class="main">(</span>snd <span class="main">(</span>pdivmod2 <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>pdivmod <span class="var">?F</span> <span class="var">?G</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_Pair_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Mp <span class="main">(</span>snd <span class="main">(</span>pdivmod2 <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">(</span>pdivmod <span class="var">?F</span> <span class="var">?G</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> MP_Rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dvdm_iff_pdivmod0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> poly_mod_prime<span class="main">)</span> dvdm_pdivmod <span class="main">=</span> poly_mod_prime_type.dvdm_iff_Mp_pdivmod2
  <span class="main">[</span><span class="operator">unfolded</span> poly_mod_type_simps<span class="main">,</span> <span class="operator">internalize_sort</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> prime_card"</span></span><span class="main">,</span> <span class="operator">OF</span> type_to_set<span class="main">,</span> 
   <span class="operator">unfolded</span> remove_duplicate_premise<span class="main">,</span> <span class="operator">cancel_type_definition</span><span class="main">,</span> <span class="operator">OF</span> non_empty<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> poly_mod<span class="main">)</span> dvdm_code<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">dvdm</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> prime <span class="free">m</span> <span class="keyword1">then</span> Mp <span class="main">(</span>snd <span class="main">(</span>pdivmod2 <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> 
    <span class="keyword1">else</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''dvdm error: m is not a prime number''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">g</span> <span class="keyword1">dvdm</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> poly_mod_prime.dvdm_pdivmod<span class="main">[</span><span class="operator">unfolded</span> poly_mod_prime_def<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> poly_mod.pdivmod2_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> poly_mod.dvdm_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LLL_Factorization_Impl">
<div class="head">
<h1>Theory LLL_Factorization_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Jose Divasón
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The LLL factorization algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains an implementation of a polynomial time factorization algorithm. 
  It first constructs a modular factorization. Afterwards it recursively 
  invokes the LLL basis reduction algorithm on one lattice to either split a polynomial into  
  two non-trivial factors, or to deduce irreducibility.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LLL_Factorization_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../LLL_Basis_Reduction/LLL_Certification.html">LLL_Basis_Reduction.LLL_Certification</a>
    <a href="Factor_Bound_2.html">Factor_Bound_2</a>
    <a href="Missing_Dvd_Int_Poly.html">Missing_Dvd_Int_Poly</a>
    <a href="../Berlekamp_Zassenhaus/Berlekamp_Zassenhaus.html">Berlekamp_Zassenhaus.Berlekamp_Zassenhaus</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> up_ring.coeff up_ring.monom
  Unique_Factorization.factors Divisibility.factors
  Unique_Factorization.factor Divisibility.factor 
  Divisibility.prime

<span class="comment1">(*
  Implementation of a polynomial-time factoring algorithm for ℤ[X], based on the book 
  "Modern Computer Algebra", second edition, pages 477-480.
*)</span>

<span class="comment1">(*The following function obtains the generators of the lattice L ⊆ Z^j
 - L = {ux^i: 0≤i≤j-d}∪{mx^i: 0≤i≤d}
 - d = degree u.
 - We have to complete with zeroes up to dimension j
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">factorization_lattice</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">factorization_lattice</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> vec_of_poly_n <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">*</span> monom <span class="main">1</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">&gt;..</span><span class="main">0</span><span class="main">]</span> <span class="main">@</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> vec_of_poly_n <span class="main">(</span>monom <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>degree <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">&gt;..</span><span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">min_degree_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly <span class="main">⇒</span> int poly"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_degree_poly</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> degree <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">choose_u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly list <span class="main">⇒</span> int poly"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">choose_u</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">choose_u</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">gi</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">gi</span></span></span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">choose_u</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">gi</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">gj</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span> min_degree_poly <span class="free"><span class="bound"><span class="entity">gi</span></span></span> <span class="main">(</span><span class="free">choose_u</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">gj</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LLL_Factorization_Impl-factorization_lattice_code"><span class="command">lemma</span></span> factorization_lattice_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"factorization_lattice <span class="free">u</span> <span class="free">k</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> degree <span class="free">u</span> <span class="keyword1">in</span>
 map 
  <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> vec_of_poly_n <span class="main">(</span>monom_mult <span class="bound">i</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">k</span><span class="main">&gt;..</span><span class="main">0</span><span class="main">]</span> 
  <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> vec_of_poly_n <span class="main">(</span>monom <span class="free">m</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="bound">n</span><span class="main">&gt;..</span><span class="main">0</span><span class="main">]</span>
<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> factorization_lattice_def monom_mult_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Optimization: directly try to minimize coefficients of polynomial $u$.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LLL_short_polynomial</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LLL_short_polynomial</span> <span class="free"><span class="bound"><span class="entity">pl</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> poly_of_vec <span class="main">(</span>short_vector_hybrid <span class="numeral">2</span> <span class="main">(</span>factorization_lattice 
     <span class="main">(</span>poly_mod.inv_Mp <span class="free"><span class="bound"><span class="entity">pl</span></span></span> <span class="main">(</span>poly_mod.Mp <span class="free"><span class="bound"><span class="entity">pl</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> degree <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">pl</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">locale</span></span> LLL_implementation <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">pl</span> <span class="main">::</span> <span class="quoted">int</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">LLL_many_reconstruction</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">LLL_many_reconstruction</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> 
     <span class="bound">d</span> <span class="main">=</span> degree <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="bound">d2</span> <span class="main">=</span> <span class="bound">d</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">;</span>
     <span class="bound">f2_opt</span> <span class="main">=</span> find_map_filter 
        <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> gcd <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>LLL_short_polynomial <span class="free">pl</span> <span class="main">(</span>Suc <span class="bound">d2</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span><span class="main">λ</span> <span class="bound">f2</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">deg</span> <span class="main">=</span> degree <span class="bound">f2</span> <span class="keyword1">in</span> <span class="bound">deg</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">deg</span> <span class="main">&lt;</span> <span class="bound">d</span><span class="main">)</span>
        <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> degree <span class="bound">u</span> <span class="main">≤</span> <span class="bound">d2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="keyword1">case</span> <span class="bound">f2_opt</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">]</span> 
    <span class="main">|</span> Some <span class="bound">f2</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">f1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">div</span> <span class="bound">f2</span><span class="main">;</span>
       <span class="main">(</span><span class="bound">us1</span><span class="main">,</span> <span class="bound">us2</span><span class="main">)</span> <span class="main">=</span> List.partition <span class="main">(</span><span class="main">λ</span> <span class="bound">gi</span><span class="main">.</span> poly_mod.dvdm <span class="free">p</span> <span class="bound">gi</span> <span class="bound">f1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>
       <span class="keyword1">in</span> <span class="free">LLL_many_reconstruction</span> <span class="bound">f1</span> <span class="bound">us1</span> <span class="main">@</span> <span class="free">LLL_many_reconstruction</span> <span class="bound">f2</span> <span class="bound">us2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">us</span><span class="main">)</span><span class="main">.</span> degree <span class="bound">f</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">us</span> <span class="skolem">d</span> <span class="skolem">d2</span> <span class="skolem">f2_opt</span> <span class="skolem">f2</span> <span class="skolem">f1</span> <span class="skolem">pair</span> <span class="skolem">us1</span> <span class="skolem">us2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> find_map_filter_Some<span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> 3<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Let_def<span class="main"><span class="main">]</span></span><span class="main">]</span> 3<span class="main">(</span>1<span class="main">,</span>5<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">us</span> <span class="skolem">d</span> <span class="skolem">d2</span> <span class="skolem">f2_opt</span> <span class="skolem">f2</span> <span class="skolem">f1</span> <span class="skolem">pair</span> <span class="skolem">us1</span> <span class="skolem">us2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> find_map_filter_Some<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> 2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Let_def<span class="main"><span class="main">]</span></span><span class="main">]</span> 2<span class="main">(</span>1<span class="main">,</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f1</span> <span class="main">*</span> <span class="skolem">f2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> degree <span class="skolem">f1</span> <span class="main">+</span> degree <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f0 <span class="keyword1"><span class="command">unfolding</span></span> f
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> deg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">LLL_reconstruction</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">LLL_reconstruction</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> 
     <span class="bound">d</span> <span class="main">=</span> degree <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="bound">u</span> <span class="main">=</span> choose_u <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">;</span>
     <span class="bound">g</span> <span class="main">=</span> LLL_short_polynomial <span class="free">pl</span> <span class="bound">d</span> <span class="bound">u</span><span class="main">;</span>
     <span class="bound">f2</span> <span class="main">=</span> gcd <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">g</span><span class="main">;</span>
     <span class="bound">deg</span> <span class="main">=</span> degree <span class="bound">f2</span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">deg</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">deg</span> <span class="main">≥</span> <span class="bound">d</span> <span class="keyword1">then</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">]</span> 
      <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">f1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1">div</span> <span class="bound">f2</span><span class="main">;</span>
       <span class="main">(</span><span class="bound">us1</span><span class="main">,</span> <span class="bound">us2</span><span class="main">)</span> <span class="main">=</span> List.partition <span class="main">(</span><span class="main">λ</span> <span class="bound">gi</span><span class="main">.</span> poly_mod.dvdm <span class="free">p</span> <span class="bound">gi</span> <span class="bound">f1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>
       <span class="keyword1">in</span> <span class="free">LLL_reconstruction</span> <span class="bound">f1</span> <span class="bound">us1</span> <span class="main">@</span> <span class="free">LLL_reconstruction</span> <span class="bound">f2</span> <span class="bound">us2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">us</span><span class="main">)</span><span class="main">.</span> degree <span class="bound">f</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">us</span> <span class="skolem">d</span> <span class="skolem">u</span> <span class="skolem">g</span> <span class="skolem">f2</span> <span class="skolem">deg</span> <span class="skolem">f1</span> <span class="skolem">pair</span> <span class="skolem">us1</span> <span class="skolem">us2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f1</span> <span class="main">*</span> <span class="skolem">f2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> degree <span class="skolem">f1</span> <span class="main">+</span> degree <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f0 <span class="keyword1"><span class="command">unfolding</span></span> f
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> deg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> LLL_implementation.LLL_reconstruction.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> LLL_implementation.LLL_many_reconstruction.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LLL_factorization</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LLL_factorization</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> 
     <span class="comment1">― ‹find suitable prime›</span>
     <span class="bound">p</span> <span class="main">=</span> suitable_prime_bz <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="comment1">― ‹compute finite field factorization›</span>
     <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">fs</span><span class="main">)</span> <span class="main">=</span> finite_field_factorization_int <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="comment1">― ‹determine exponent l and B›</span>
     <span class="bound">n</span> <span class="main">=</span> degree <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="bound">no</span> <span class="main">=</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">;</span>
     <span class="bound">B</span> <span class="main">=</span> sqrt_int_ceiling <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="main">(</span><span class="bound">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="bound">no</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="bound">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="bound">l</span> <span class="main">=</span> find_exponent <span class="bound">p</span> <span class="bound">B</span><span class="main">;</span>
     <span class="comment1">― ‹perform hensel lifting to lift factorization to mod $p^l$›</span>
     <span class="bound">us</span> <span class="main">=</span> hensel_lifting <span class="bound">p</span> <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">fs</span><span class="main">;</span>
     <span class="comment1">― ‹reconstruct integer factors via LLL algorithm›</span>
     <span class="bound">pl</span> <span class="main">=</span> <span class="bound">p</span><span class="main">^</span><span class="bound">l</span>
   <span class="keyword1">in</span> LLL_implementation.LLL_reconstruction <span class="bound">p</span> <span class="bound">pl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">us</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LLL_many_factorization</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LLL_many_factorization</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> 
     <span class="comment1">― ‹find suitable prime›</span>
     <span class="bound">p</span> <span class="main">=</span> suitable_prime_bz <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="comment1">― ‹compute finite field factorization›</span>
     <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">fs</span><span class="main">)</span> <span class="main">=</span> finite_field_factorization_int <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="comment1">― ‹determine exponent l and B›</span>
     <span class="bound">n</span> <span class="main">=</span> degree <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="bound">no</span> <span class="main">=</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">;</span>
     <span class="bound">B</span> <span class="main">=</span> sqrt_int_ceiling <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="bound">no</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="bound">l</span> <span class="main">=</span> find_exponent <span class="bound">p</span> <span class="bound">B</span><span class="main">;</span>
     <span class="comment1">― ‹perform hensel lifting to lift factorization to mod $p^l$›</span>
     <span class="bound">us</span> <span class="main">=</span> hensel_lifting <span class="bound">p</span> <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">fs</span><span class="main">;</span>
     <span class="comment1">― ‹reconstruct integer factors via LLL algorithm›</span>
     <span class="bound">pl</span> <span class="main">=</span> <span class="bound">p</span><span class="main">^</span><span class="bound">l</span>
   <span class="keyword1">in</span> LLL_implementation.LLL_many_reconstruction <span class="bound">p</span> <span class="bound">pl</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">us</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LLL_Factorization">
<div class="head">
<h1>Theory LLL_Factorization</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Jose Divasón
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the LLL factorization algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory connects short vectors of lattices and factors of polynomials. 
  From this connection, we derive soundness of the lattice based factorization algorithm. 
›</span></span> 

<span class="keyword1"><span class="command">theory</span></span> LLL_Factorization
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="LLL_Factorization_Impl.html">LLL_Factorization_Impl</a>  
    <a href="../Berlekamp_Zassenhaus/Factorize_Int_Poly.html">Berlekamp_Zassenhaus.Factorize_Int_Poly</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic facts about the auxiliary functions›</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> module.smult

<span class="keyword1" id="LLL_Factorization-nth_factorization_lattice"><span class="command">lemma</span></span> nth_factorization_lattice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≡</span> degree <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"factorization_lattice <span class="free">u</span> <span class="free">d</span> <span class="free">m</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span>
    vec_of_poly_n <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="free">u</span> <span class="main">*</span> monom <span class="main">1</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="keyword1">else</span> monom <span class="free">m</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">d</span><span class="main">-</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> factorization_lattice_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append smult_monom Let_def not_less<span class="main">)</span>

<span class="keyword1" id="LLL_Factorization-length_factorization_lattice"><span class="command">lemma</span></span> length_factorization_lattice<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="free">d</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> degree <span class="free">u</span> <span class="main">+</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> factorization_lattice_def Let_def<span class="main">)</span>

<span class="keyword1" id="LLL_Factorization-dim_factorization_lattice"><span class="command">lemma</span></span> dim_factorization_lattice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> degree <span class="free">u</span> <span class="main">+</span> <span class="free">d</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="free">d</span> <span class="free">m</span> <span class="main">!</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> degree <span class="free">u</span> <span class="main">+</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> factorization_lattice_def <span class="keyword1"><span class="command">using</span></span> assms nth_append
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append Let_def<span class="main">)</span>

<span class="keyword1" id="LLL_Factorization-dim_factorization_lattice_element"><span class="command">lemma</span></span> dim_factorization_lattice_element<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="free">d</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">x</span> <span class="main">=</span> degree <span class="free">u</span> <span class="main">+</span> <span class="free">d</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> factorization_lattice_def Let_def<span class="main">)</span>

<span class="keyword1" id="LLL_Factorization-set_factorization_lattice_in_carrier"><span class="command">lemma</span></span> set_factorization_lattice_in_carrier<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="free">d</span> <span class="free">m</span><span class="main">)</span> <span class="main">⊆</span> carrier_vec <span class="main">(</span>degree <span class="free">u</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> dim_factorization_lattice <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> factorization_lattice_def Let_def<span class="main">)</span> 

<span class="keyword1" id="LLL_Factorization-choose_u_Cons"><span class="command">lemma</span></span> choose_u_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"choose_u <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> min_degree_poly <span class="free">x</span> <span class="main">(</span>choose_u <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="LLL_Factorization-choose_u_member"><span class="command">lemma</span></span> choose_u_member<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> choose_u <span class="free">xs</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> choose_u_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> choose_u.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about Sylvester matrices and norms›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> LLL<span class="main">)</span> lattice_is_span <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lattice_of <span class="free">xs</span> <span class="main">=</span> span_list <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> lattice_of_def span_list_def lincomb_list_def image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="LLL_Factorization-sq_norm_row_sylvester_mat1"><span class="command">lemma</span></span> sq_norm_row_sylvester_mat1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> conjugatable_ring poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="main">(</span>row <span class="main">(</span>sylvester_mat <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sylvester_mat_def row_def sq_norm_vec_def o_def
        interv_sum_list_conv_sum_set_nat i <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_zero<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> f <span class="main">=</span> False         
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">-</span> <span class="free">i</span> <span class="main">≤</span> degree <span class="free">f</span> <span class="keyword1">then</span> coeff <span class="free">f</span> <span class="main">(</span>degree <span class="free">f</span> <span class="main">+</span> <span class="free">i</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?row</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">)</span> <span class="var">?f</span> "</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> degree <span class="free">f</span> <span class="main">-</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> image_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span> 
       <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Nat.add_diff_assoc add.commute add_diff_cancel_left' 
        atLeastLessThan_iff diff_Suc_Suc diff_Suc_less less_Suc_eq_le zero_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bij_h<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?h</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span> Suc <span class="main">(</span>degree <span class="free">f</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def image_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> atLeastLessThan_iff le_add_diff_inverse2 
        less_diff_conv linorder_not_less not_less_eq zero_order<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>row <span class="main">(</span>sylvester_mat <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span><span class="var">?row</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"sq_norm_vec"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> row_def sylvester_mat_def sylvester_mat_sub_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span>sq_norm <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span>sq_norm <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> interv_sum_list_conv_sum_set_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span>sq_norm <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span> Suc <span class="main">(</span>degree <span class="free">f</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">(</span>sq_norm <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">∘</span> <span class="var">?h</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> o_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> bij_h<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> sq_norm <span class="main">(</span>coeff <span class="free">f</span> <span class="main">(</span>degree <span class="free">f</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> sq_norm <span class="main">(</span>coeff <span class="free">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="var">?g</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">..</span></span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> sq_norm <span class="main">(</span>coeff <span class="free">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?g</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span>sq_norm <span class="main">∘</span> coeff <span class="free">f</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> image_g <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span>map sq_norm <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">unfolding</span></span> coeffs_def <span class="keyword1"><span class="command">using</span></span> f 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interv_sum_list_conv_sum_set_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_poly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="LLL_Factorization-sq_norm_row_sylvester_mat2"><span class="command">lemma</span></span> sq_norm_row_sylvester_mat2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> conjugatable_ring poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">g</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>row <span class="main">(</span>sylvester_mat <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">i</span> <span class="main">-</span> degree <span class="free">g</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="keyword1">then</span> coeff <span class="free">g</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?row</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">)</span> <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> <span class="free">i</span> <span class="main">-</span> degree <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> degree <span class="free">g</span> <span class="main">-</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> image_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">g</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">g</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff diff_diff_cancel diff_le_self less_Suc_eq_le zero_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> degree <span class="free">g</span><span class="main">)</span> <span class="main">≤</span> degree <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> bij_h<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?h</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">g</span><span class="main">)</span><span class="main">}</span> <span class="main">{</span><span class="free">i</span> <span class="main">-</span> degree <span class="free">g</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def inj_on_def <span class="keyword1"><span class="command">using</span></span> i1 i2 <span class="keyword1"><span class="command">unfolding</span></span> image_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Nat.add_diff_assoc atLeastLessThan_iff x less_Suc_eq_le 
        less_eq_nat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ordered_cancel_comm_monoid_diff_class.diff_add<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>row <span class="main">(</span>sylvester_mat <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">i</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span><span class="var">?row</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"sq_norm_vec"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i1 i2<span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> row_def sylvester_mat_def sylvester_mat_sub_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span>sq_norm <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span>sq_norm <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> interv_sum_list_conv_sum_set_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span>sq_norm <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span> <span class="main">-</span> degree <span class="free">g</span><span class="main">..&lt;</span> Suc <span class="free">i</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">(</span>sq_norm <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">∘</span> <span class="var">?h</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">g</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> o_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> bij_h<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> sq_norm <span class="main">(</span>coeff <span class="free">g</span> <span class="main">(</span>degree <span class="free">g</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">g</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> sq_norm <span class="main">(</span>coeff <span class="free">g</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="var">?g</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">g</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">..</span></span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> sq_norm <span class="main">(</span>coeff <span class="free">g</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?g</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">g</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span>sq_norm <span class="main">∘</span> coeff <span class="free">g</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span>degree <span class="free">g</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> image_g <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span>map sq_norm <span class="main">(</span>coeffs <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">unfolding</span></span> coeffs_def
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interv_sum_list_conv_sum_set_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sq_norm_poly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Factorization-Hadamard's_inequality_int"><span class="command">lemma</span></span> Hadamard's_inequality_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"int mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>det <span class="free">A</span><span class="main">¦</span> <span class="main">≤</span> sqrt <span class="main">(</span>of_int <span class="main">(</span>prod_list <span class="main">(</span>map sq_norm <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat real_of_int <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>det <span class="free">A</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span>det <span class="var">?A</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_int_hom.hom_det <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sqrt <span class="main">(</span>prod_list <span class="main">(</span>map sq_norm <span class="main">(</span>rows <span class="var">?A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Hadamard's_inequality<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?A</span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sqrt <span class="main">(</span>of_int <span class="main">(</span>prod_list <span class="main">(</span>map sq_norm <span class="main">(</span>rows <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_int_hom.hom_prod_list map_map
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> sqrt <span class="main"><span class="main"><span class="main">(</span></span></span>prod_list <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sq_norm_of_int<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> row_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">sq_norm_vec</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Factorization-resultant_le_prod_sq_norm"><span class="command">lemma</span></span> resultant_le_prod_sq_norm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"int poly"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≡</span> degree <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≡</span> degree <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>resultant <span class="free">f</span> <span class="free">g</span><span class="main">¦</span> <span class="main">≤</span> sqrt <span class="main">(</span>of_int <span class="main">(</span><span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="free">k</span> <span class="main">*</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sylvester_mat <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sq_norm <span class="main">∘</span> row <span class="var">?S</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> map_rw1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">g</span><span class="main">]</span> <span class="main">=</span> replicate <span class="free">k</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>sq_norm <span class="main">∘</span> row <span class="main">(</span>sylvester_mat <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">g</span><span class="main">]</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?M</span> <span class="main">=</span> length <span class="main">(</span>replicate <span class="free">k</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> replicate <span class="free">k</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="var">?M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> i_deg_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"replicate <span class="free">k</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_replicate<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ik<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>sq_norm <span class="main">∘</span> row <span class="main">(</span>sylvester_mat <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sq_norm_row_sylvester_mat1 ik k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>      
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_map_upt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i_deg_g<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> replicate <span class="free">k</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword1"><span class="command">have</span></span> map_rw2<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="var">?f</span> <span class="main">[</span>degree <span class="free">g</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">]</span> <span class="main">=</span> replicate <span class="free">n</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>sq_norm <span class="main">∘</span> row <span class="main">(</span>sylvester_mat <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>degree <span class="free">g</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">]</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?M</span> <span class="main">=</span> length <span class="main">(</span>replicate <span class="free">n</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> replicate <span class="free">n</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>length <span class="var">?M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> i_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n_def that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> i_deg_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> degree <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"replicate <span class="free">n</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_replicate<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i_n<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>sq_norm <span class="main">∘</span> row <span class="main">(</span>sylvester_mat <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">g</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_n n_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_row_sylvester_mat2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i_deg_f<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> replicate <span class="free">n</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">g</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_rw1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_list_replicate<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span>degree <span class="free">g</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_rw2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_list_replicate<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> list_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">g</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>degree <span class="free">g</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute upt_add_eq_append zero_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>resultant <span class="free">f</span> <span class="free">g</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span>det <span class="var">?S</span><span class="main">¦</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> resultant_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> sqrt <span class="main">(</span>of_int <span class="main">(</span>prod_list <span class="main">(</span>map sq_norm <span class="main">(</span>rows <span class="var">?S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Hadamard's_inequality_int<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map sq_norm <span class="main">(</span>rows <span class="var">?S</span><span class="main">)</span> <span class="main">=</span> map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Matrix.rows_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  map <span class="var">?f</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">g</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>degree <span class="free">g</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_rw<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="main">...</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>degree <span class="free">g</span><span class="main">]</span><span class="main">)</span>
    <span class="main">*</span> prod_list <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span>degree <span class="free">g</span><span class="main">..&lt;</span>degree <span class="free">f</span> <span class="main">+</span> degree <span class="free">g</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> p1 p2 <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of the key lemma 16.20›</span></span>
<span class="comment1">(* Lemma 16.20 *)</span>
<span class="keyword1" id="LLL_Factorization-common_factor_via_short"><span class="command">lemma</span></span> common_factor_via_short<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="free">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≡</span> degree <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≡</span> degree <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> monic<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uf<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.dvdm <span class="free">m</span> <span class="free">u</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ug<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.dvdm <span class="free">m</span> <span class="free">u</span> <span class="free">g</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> short<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="free">k</span> <span class="main">*</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="free">n</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> poly_mod <span class="quoted"><span class="free">m</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> f_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n0 k0 k_def n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> deg_f<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n0 n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> deg_g<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">g</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k0 k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> deg_s<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">s</span> <span class="main">&lt;</span> degree <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg_t<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">t</span> <span class="main">&lt;</span> degree <span class="free">f</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> res_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span>resultant <span class="free">f</span> <span class="free">g</span><span class="main">:]</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">f</span> <span class="main">+</span> <span class="skolem">t</span> <span class="main">*</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> resultant_as_nonzero_poly<span class="main">[</span><span class="operator">OF</span> deg_f deg_g<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> res_eq_modulo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span>resultant <span class="free">f</span> <span class="free">g</span><span class="main">:]</span> <span class="keyword1">=m</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">f</span> <span class="main">+</span> <span class="skolem">t</span> <span class="main">*</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> u_dvdm_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">dvdm</span> <span class="main">[:</span>resultant <span class="free">f</span> <span class="free">g</span><span class="main">:]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> res_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> dvdm_add<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">dvdm</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dvdm_factor<span class="main">[</span><span class="operator">OF</span> uf<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> mult.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">dvdm</span> <span class="skolem">t</span> <span class="main">*</span> <span class="free">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dvdm_factor<span class="main">[</span><span class="operator">OF</span> ug<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> mult.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> res_0_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"resultant <span class="free">f</span> <span class="free">g</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monic_dvdm_constant<span class="main"><span class="main">[</span></span><span class="operator">OF</span> u_dvdm_res monic deg_u<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> res0<span class="main">:</span> <span class="quoted"><span class="quoted">"resultant <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mod_0_abs_less_imp_0<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>resultant <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res_0_mod <span class="keyword1"><span class="command">unfolding</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>resultant <span class="free">f</span> <span class="free">g</span><span class="main">¦</span> <span class="main">≤</span> sqrt <span class="main">(</span><span class="main">(</span>sq_norm_poly <span class="free">f</span><span class="main">)</span><span class="main">^</span><span class="free">k</span> <span class="main">*</span> <span class="main">(</span>sq_norm_poly <span class="free">g</span><span class="main">)</span><span class="main">^</span><span class="free">n</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> k_def n_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> resultant_le_prod_sq_norm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> real_less_lsqrt<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real_of_int <span class="main">(</span><span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sq_norm_poly_ge_0<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real_of_int <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span><span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="main">∥</span><span class="free">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span>real_of_int <span class="free">m</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_less_iff of_int_power short<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>resultant <span class="free">f</span> <span class="free">g</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> of_int_less_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="free">f</span> <span class="free">g</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> resultant_zero_imp_common_factor<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deg_f res0<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> res0 resultant_0_gcd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of the computed lattice and its connection with Sylvester matrices›</span></span>

<span class="keyword1" id="LLL_Factorization-factorization_lattice_as_sylvester"><span class="command">lemma</span></span> factorization_lattice_as_sylvester<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semidom poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="free">d</span>"</span></span>   
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mat_of_rows <span class="free">j</span> <span class="main">(</span>factorization_lattice <span class="free">p</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> sylvester_mat_sub <span class="free">d</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">p</span> <span class="main">[:</span><span class="free">m</span><span class="main">:]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True 
  <span class="keyword1"><span class="command">have</span></span> deg_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> factorization_lattice_def True deg_p mat_of_rows_def d<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> p0<span class="main">:</span> False
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> degree_mult_eq<span class="main">[</span><span class="operator">OF</span> p0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"monom <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> monom_eq_0_iff<span class="main">,</span> <span class="operator">OF</span> one_neq_zero<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> dj <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_eq_iff d<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> 1 coeff_mult_monom
 sylvester_mat_sub_index mat_of_rows_index nth_factorization_lattice vec_index_of_poly_n
 degree_monom_eq coeff_const<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span> inj_comm_semiring_hom <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL_Factorization-map_poly_hom_mult_monom"><span class="command">lemma</span></span> map_poly_hom_mult_monom <span class="main">[</span><span class="operator">hom_distribs</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_poly <span class="free">hom</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> monom <span class="free">a</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> map_poly <span class="free">hom</span> <span class="free">p</span> <span class="main">*</span> monom <span class="main">(</span><span class="free">hom</span> <span class="free">a</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> poly_eqI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>coeff_mult_monom hom_mult<span class="main">)</span>

<span class="keyword1" id="LLL_Factorization-hom_vec_of_poly_n"><span class="command">lemma</span></span> hom_vec_of_poly_n <span class="main">[</span><span class="operator">hom_distribs</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_vec <span class="free">hom</span> <span class="main">(</span>vec_of_poly_n <span class="free">p</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span>map_poly <span class="free">hom</span> <span class="free">p</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_index_of_poly_n<span class="main">)</span>

<span class="keyword1" id="LLL_Factorization-hom_factorization_lattice"><span class="command">lemma</span></span> hom_factorization_lattice <span class="main">[</span><span class="operator">hom_distribs</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>map_vec <span class="free">hom</span><span class="main">)</span> <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> factorization_lattice <span class="main">(</span>map_poly <span class="free">hom</span> <span class="free">u</span><span class="main">)</span> <span class="free">k</span> <span class="main">(</span><span class="free">hom</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> vec_of_poly_n <span class="bound">p</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq nth_factorization_lattice hom_vec_of_poly_n map_poly_hom_mult_monom<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proving that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> factorization_lattice<span class="antiquote"><span class="antiquote">}</span></span></span></span> returns a basis of the lattice›</span></span>

<span class="keyword1"><span class="command">context</span></span> LLL
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> idom_vec <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TYPE</span><span class="main">(</span>int<span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="comment1">(*In this context, "n" is fixed by the locale and corresponds to "j" in the book*)</span>
<span class="keyword1" id="LLL_Factorization-upper_triangular_factorization_lattice"><span class="command">lemma</span></span> upper_triangular_factorization_lattice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semidom poly"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> du<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> degree <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"upper_triangular <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"upper_triangular <span class="var">?M</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> upper_triangularI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mat_of_rows_carrier length_factorization_lattice<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> degree <span class="free">u</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> d du <span class="keyword1"><span class="command">have</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> ji i <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> factorization_lattice_def mat_of_rows_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> d ji i
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> du mat_of_rows_index nth_factorization_lattice<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_index_of_poly_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> jn<span class="main"><span class="main">]</span></span> degree_mult_eq degree_monom_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Factorization-factorization_lattice_diag_nonzero"><span class="command">lemma</span></span> factorization_lattice_diag_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semidom poly"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">=</span>degree <span class="free">u</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">≤</span><span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">≠</span><span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">≠</span><span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"monom <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span>degree <span class="free">u</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> degree <span class="free">u</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">*</span> monom <span class="main">1</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span>degree <span class="free">u</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> degree <span class="free">u</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="var">?p</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_mult_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 1<span class="main"><span class="main">]</span></span> degree_monom_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> nth_factorization_lattice<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span> vec_index_of_poly_n<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms leading_coeff_0_iff<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> degree <span class="free">u</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d 3 degree_monom_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> factorization_lattice_diag_nonzero_RAT<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">d</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">=</span>degree <span class="free">u</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">≤</span><span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">≠</span><span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">≠</span><span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RAT <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">$</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> factorization_lattice_diag_nonzero<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_factorization_lattice<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> gs<span class="main">:</span> vec_space <span class="quoted"><span class="quoted">"<span class="keyword1">TYPE</span><span class="main">(</span>rat<span class="main">)</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="LLL_Factorization-lin_indpt_list_factorization_lattice"><span class="command">lemma</span></span> lin_indpt_list_factorization_lattice<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">d</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> degree <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gs.lin_indpt_list <span class="main">(</span>RAT <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"gs.lin_indpt_list <span class="main">(</span>RAT <span class="var">?vs</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"rows <span class="main">(</span>mat_of_rows <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span>map_vec rat_of_int<span class="main">)</span> <span class="var">?vs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>map_vec rat_of_int<span class="main">)</span> <span class="var">?vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dn d
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> rows_mat_of_rows<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> set_factorization_lattice_in_carrier<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> factorization_lattice_diag_nonzero_RAT<span class="main">[</span><span class="operator">OF</span> d dn u k<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> gs.upper_triangular_imp_lin_indpt_list<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"mat_of_rows <span class="free"><span class="free">n</span></span> <span class="main"><span class="main">(</span></span>RAT <span class="var"><span class="var">?vs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diag_mat_def mat_of_rows_index <span class="dynamic"><span class="dynamic">hom_distribs</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>upper_triangular_factorization_lattice<span class="main">)</span>
 <span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Being in the lattice is being a multiple modulo›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semiring_hom<span class="main">)</span> hom_poly_of_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"map_poly <span class="free">hom</span> <span class="main">(</span>poly_of_vec <span class="free">v</span><span class="main">)</span> <span class="main">=</span> poly_of_vec <span class="main">(</span>map_vec <span class="free">hom</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_poly_of_vec poly_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">of_int_vec</span> <span class="main">≡</span> map_vec of_int"</span></span>

<span class="keyword1"><span class="command">context</span></span> LLL
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL_Factorization-lincomb_to_dvd_modulo"><span class="command">lemma</span></span> lincomb_to_dvd_modulo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="free">d</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≡</span> degree <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lincomb<span class="main">:</span> <span class="quoted"><span class="quoted">"lincomb_list <span class="free">c</span> <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly_mod.dvdm <span class="free">k</span> <span class="free">u</span> <span class="main">(</span>poly_of_vec <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sylvester_mat_sub <span class="free">d</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">)</span> <span class="free">u</span> <span class="main">[:</span><span class="free">k</span><span class="main">:]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≡</span> poly_of_vec <span class="main">(</span>vec_first <span class="main">(</span>vec <span class="free">n</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≡</span> poly_of_vec <span class="main">(</span>vec_last <span class="main">(</span>vec <span class="free">n</span> <span class="free">c</span><span class="main">)</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?S</span><span class="keyword1"><span class="hidden">⇧</span><sup>T</sup></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> vec <span class="free">n</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lincomb_list_as_mat_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> d d_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>factorization_lattice_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> transpose_mat_of_rows<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> d d_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> factorization_lattice_as_sylvester<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">…</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> smult <span class="free">k</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sylvester_sub_poly<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> d_def d q_def r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> poly_of_vec <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lincomb of_int_hom.hom_poly_of_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="free">g</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> Polynomial.smult <span class="free">k</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly_mod.Mp <span class="free">k</span> <span class="main">(</span>poly_of_vec <span class="free">g</span><span class="main">)</span> <span class="main">=</span>  poly_mod.Mp <span class="free">k</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> Polynomial.smult <span class="free">k</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> poly_mod.Mp <span class="free">k</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> poly_mod.Mp <span class="free">k</span> <span class="main">(</span>Polynomial.smult <span class="free">k</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poly_mod.plus_Mp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  poly_mod.Mp <span class="free">k</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">*</span> <span class="free">u</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> poly_mod.plus_Mp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> poly_mod.Mp_smult_m_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> poly_mod.Mp <span class="free">k</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> poly_mod.dvdm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
  There is a typo in the textbook (page 476). The book states q' = q'' * u + r'' and 
  the correct fact is r' = q'' * u+r'' 
*)</span>
<span class="keyword1" id="LLL_Factorization-dvd_modulo_to_lincomb"><span class="command">lemma</span></span> dvd_modulo_to_lincomb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≡</span> degree <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.dvdm <span class="free">k</span> <span class="free">u</span> <span class="main">(</span>poly_of_vec <span class="free">g</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> k_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">≠</span><span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> monic_u<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dim_g<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">g</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> deg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>      
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> lincomb_list <span class="bound">c</span> <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> poly_mod <span class="quoted"><span class="free">k</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> u_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> monic_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> n<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="free">g</span> <span class="main">=</span> <span class="skolem">q'</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> smult <span class="free">k</span> <span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p.dvdm_imp_div_mod<span class="main">[</span><span class="operator">OF</span> dvd<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="keyword2"><span class="keyword">where</span></span> r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">q''</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> <span class="skolem">r''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg_r''<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">r''</span><span class="main">&lt;</span>degree <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> monic_imp_div_mod_int_poly_degree2<span class="main">[</span><span class="operator">OF</span> monic_u deg_u<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(*The following fact is explained in the paragraph below equation (6) in page 476 of the textbook*)</span>
  <span class="keyword1"><span class="command">have</span></span> g1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q'</span> <span class="main">+</span> smult <span class="free">k</span> <span class="skolem">q''</span><span class="main">)</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> smult <span class="free">k</span> <span class="skolem">r''</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> g r'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> combine_common_factor mult_smult_left smult_add_right<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q'</span> <span class="main">+</span> smult <span class="free">k</span> <span class="skolem">q''</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r''</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> degree_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="main">(</span><span class="skolem">q'</span> <span class="main">+</span> smult <span class="free">k</span> <span class="skolem">q''</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> degree_div_mod_smult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ g1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>poly_of_vec <span class="free">g</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_poly_of_vec_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_g<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">r''</span> <span class="main">&lt;</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deg_r'' <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">+</span> smult <span class="free">k</span> <span class="skolem">q''</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">=</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> g2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec_of_poly_n <span class="main">(</span><span class="skolem">q</span><span class="main">*</span><span class="free">u</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>vec_of_poly_n <span class="main">(</span>smult <span class="free">k</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span>poly_of_vec <span class="free">g</span><span class="main">)</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vec_of_poly_n_poly_of_vec<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_g<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span><span class="main">(</span><span class="skolem">q'</span> <span class="main">+</span> smult <span class="free">k</span> <span class="skolem">q''</span><span class="main">)</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> smult <span class="free">k</span> <span class="skolem">r''</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> g1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span><span class="skolem">q</span> <span class="main">*</span> <span class="free">u</span> <span class="main">+</span> smult <span class="free">k</span> <span class="skolem">r''</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span><span class="skolem">q</span> <span class="main">*</span> <span class="free">u</span><span class="main">)</span> <span class="free">n</span> <span class="main">+</span> vec_of_poly_n <span class="main">(</span>smult <span class="free">k</span> <span class="skolem">r''</span><span class="main">)</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vec_of_poly_n_add<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="free">d</span> <span class="keyword1">then</span> coeff <span class="skolem">q</span>  <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> coeff <span class="skolem">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?c</span> <span class="bound">i</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?c</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?part1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> vec_of_poly_n <span class="main">(</span><span class="free">u</span> <span class="main">*</span> monom <span class="main">1</span> <span class="bound">i</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">&gt;..</span><span class="main">0</span><span class="main">]</span>"</span></span>  
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?part2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> vec_of_poly_n <span class="main">(</span>monom <span class="free">k</span> <span class="bound">i</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="free">d</span><span class="main">&gt;..</span><span class="main">0</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dim_sumlist<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_factorization_lattice d_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dim_sumlist<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> d<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_factorization_lattice d_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> 
      <span class="keyword1"><span class="command">using</span></span> x dim_factorization_lattice_element nth_factorization_lattice<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="free">d</span>"</span></span><span class="main">]</span> d
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def less_imp_le_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> upt_minus_eq_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> list_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
    <span class="keyword1"><span class="command">have</span></span> qu1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">*</span><span class="free">u</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> poly_of_vec <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">}</span><span class="main">.</span> <span class="var">?c1</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_map_as_finsum<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> poly_of_vec <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">i</span><span class="main">∈</span>set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">]</span><span class="main">.</span> <span class="var">?c1</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> poly_of_vec <span class="main">(</span><span class="var">?c1</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>poly_of_vec_finsum<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> poly_of_vec <span class="main">(</span><span class="var">?c1</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">*</span><span class="free">u</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">u</span> <span class="main">*</span> monom <span class="main">1</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"monom <span class="main">(</span><span class="main">1</span><span class="main">::</span>int<span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> monom_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> deg_m<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?m</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_monom_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">u</span> <span class="main">*</span> <span class="var">?m</span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> degree_mult_eq<span class="main">[</span><span class="operator">OF</span> u_not0 monom_not0<span class="main">]</span> d_def deg_m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> lattice_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span><span class="free">u</span> <span class="main">*</span> monom <span class="main">1</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
          <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nth_factorization_lattice<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>d_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> q_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">.</span> <span class="main">(</span>smult <span class="main">(</span>coeff <span class="skolem">q</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>          
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_iff coeff_sum<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> 
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> coeff <span class="skolem">q</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>          
          <span class="keyword1"><span class="command">have</span></span> set_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">}</span> <span class="main">=</span> insert <span class="var">?m</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?m</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> sum0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?m</span><span class="main">}</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> insert <span class="var">?m</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?m</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> set_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?f</span> <span class="var">?m</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?m</span><span class="main">}</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?f</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> coeff <span class="skolem">q</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="free">d</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&gt;</span>degree <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degree_q q False d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> coeff_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>            
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">q</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">.</span> coeff <span class="skolem">q</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
            <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> poly_of_vec <span class="main">(</span><span class="var">?c1</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">}</span> 
        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">.</span> poly_of_vec <span class="main">(</span>coeff <span class="skolem">q</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">.</span> <span class="main">(</span>poly_of_vec <span class="main">(</span>coeff <span class="skolem">q</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
          <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>vec_of_poly_n <span class="main">(</span><span class="free">u</span> <span class="main">*</span> monom <span class="main">1</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lattice_rw<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">.</span> smult <span class="main">(</span>coeff <span class="skolem">q</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> monom <span class="main">1</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_of_vec_scalar_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deg<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">.</span> <span class="free">u</span><span class="main">*</span><span class="main">(</span>smult <span class="main">(</span>coeff <span class="skolem">q</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">u</span> <span class="main">*</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">.</span> <span class="main">(</span>smult <span class="main">(</span>coeff <span class="skolem">q</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_distrib_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">u</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">*</span><span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> qu<span class="main">:</span> <span class="quoted"><span class="quoted">"M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span><span class="skolem">q</span><span class="main">*</span><span class="free">u</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="main">(</span><span class="skolem">q</span><span class="main">*</span><span class="free">u</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span>poly_of_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> qu1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="main">(</span>poly_of_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span> 
        <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vec_of_poly_n_poly_of_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> rm1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> smult <span class="free">k</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly_of_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> poly_of_vec <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="var">?c1</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sumlist_map_as_finsum<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> poly_of_vec <span class="main">(</span><span class="main">⨁</span><span class="hidden">⇘</span><sub>V</sub><span class="hidden">⇙</span><span class="bound">i</span><span class="main">∈</span>set <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">.</span> <span class="var">?c1</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> poly_of_vec <span class="main">(</span><span class="var">?c1</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_of_vec_finsum<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smult <span class="free">k</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>monom <span class="free">k</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">≤</span><span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> 
          <span class="keyword1"><span class="command">using</span></span> degree_monom_le i i2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_monom_eq k_not0<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> lattice_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span>monom <span class="free">k</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
          <span class="keyword2"><span class="keyword">if</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="free">d</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
          <span class="keyword1"><span class="command">using</span></span> i2 i d d_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nth_factorization_lattice<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> r_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>monom <span class="main">(</span>coeff <span class="skolem">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_iff coeff_sum<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">r</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> coeff <span class="skolem">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="free">d</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">have</span></span> j_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> coeff <span class="skolem">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> sum0<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">(</span><span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="var">?i</span> <span class="main">(</span><span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">(</span>insert <span class="var">?i</span> <span class="main">(</span><span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?f</span> <span class="var">?i</span> <span class="main">+</span> sum <span class="var">?f</span> <span class="main">(</span><span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> coeff <span class="skolem">r</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum0 j_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> coeff <span class="skolem">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.neutral ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> False<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main">)</span> 
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> coeff <span class="skolem">r</span> <span class="skolem">j</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coeff_eq_0<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> False deg_r'' r d_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">qed</span></span> 
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> poly_of_vec <span class="main">(</span><span class="var">?c1</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> 
        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> poly_of_vec <span class="main">(</span>coeff <span class="skolem">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>poly_of_vec <span class="main">(</span>coeff <span class="skolem">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span> 
          <span class="keyword1">⋅<span class="hidden">⇩</span><sub>v</sub></span> vec_of_poly_n <span class="main">(</span>monom <span class="free">k</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lattice_rw<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> smult <span class="main">(</span>coeff <span class="skolem">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>monom <span class="free">k</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_of_vec_scalar_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deg<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> smult <span class="free">k</span> <span class="main">(</span>monom <span class="main">(</span>coeff <span class="skolem">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smult_monom smult_sum2<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smult <span class="free">k</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span>monom <span class="main">(</span>coeff <span class="skolem">r</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smult_sum2<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> smult <span class="free">k</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span>smult <span class="free">k</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="main">(</span>smult <span class="free">k</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">n</span> 
        <span class="main">=</span> vec_of_poly_n <span class="main">(</span>poly_of_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> rm1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec_of_poly_n <span class="main">(</span>poly_of_vec <span class="main">(</span>M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span> 
        <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vec_of_poly_n_poly_of_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>        
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lincomb_list <span class="var">?c</span> <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lincomb_list_def list_rw <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span> <span class="main">@</span> map <span class="var">?c1</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> M.sumlist <span class="main">(</span>map <span class="var">?c1</span> <span class="main">[</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def nth_factorization_lattice <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> M.sumlist_append<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> vec_of_poly_n <span class="main">(</span><span class="skolem">q</span><span class="main">*</span><span class="free">u</span><span class="main">)</span> <span class="free">n</span> <span class="main">+</span> vec_of_poly_n <span class="main">(</span>smult <span class="free">k</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> qu rm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lincomb_list <span class="var">?c</span> <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">d</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The factorization lattice precisely characterises the polynomials of a certain
  degree which divide $u$ modulo $M$.›</span></span>

<span class="keyword1" id="LLL_Factorization-factorization_lattice"><span class="command">lemma</span></span> factorization_lattice<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="keyword2"><span class="keyword">assumes</span></span>  
  deg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> poly_of_vec <span class="main">`</span> lattice_of <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> degree <span class="free">u</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="main">⟹</span> 
  degree <span class="free">f</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> poly_mod.dvdm <span class="free">M</span> <span class="free">u</span> <span class="free">f</span>"</span></span> 
  <span class="quoted"><span class="quoted">"monic <span class="free">u</span> <span class="main">⟹</span> degree <span class="free">u</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> 
  degree <span class="free">f</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> poly_mod.dvdm <span class="free">M</span> <span class="free">u</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> poly_of_vec <span class="main">`</span> lattice_of <span class="main">(</span>factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> degree <span class="free">u</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> deg_u <span class="keyword1"><span class="command">have</span></span> deg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"factorization_lattice <span class="free">u</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> degree <span class="free">u</span><span class="main">)</span> <span class="free">M</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.dvdm <span class="free">M</span> <span class="free">u</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">u</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> deg_u_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fv</span> <span class="main">=</span> vec <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span>coeff <span class="free">f</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> poly_of_vec <span class="skolem">fv</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fv_def poly_of_vec_def Let_def <span class="keyword1"><span class="command">using</span></span> deg 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> poly_eqI coeff_eq_0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_sum<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> dim_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="skolem">fv</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> dvd_modulo_to_lincomb<span class="main">[</span><span class="operator">OF</span> deg_u_lt _ M mon _ deg_u<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">fv</span></span><span class="main">,</span> <span class="operator">folded</span> f<span class="main">,</span> <span class="operator">OF</span> dvd dim_fv<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> gv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fv</span> <span class="main">=</span> lincomb_list <span class="skolem">c</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fv</span> <span class="main">∈</span> lattice_of <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gv lattice_is_span <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_span_listI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> poly_of_vec <span class="main">`</span> lattice_of <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> poly_of_vec <span class="main">`</span> lattice_of <span class="var">?L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fv</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> poly_of_vec <span class="skolem">fv</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fv</span> <span class="main">∈</span> lattice_of <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> in_span_listE<span class="main">[</span><span class="operator">OF</span> fv<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> lattice_is_span<span class="main"><span class="main">]</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fv</span> <span class="main">=</span> lincomb_list <span class="skolem">c</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">from</span></span> lincomb_to_dvd_modulo<span class="main">[</span><span class="operator">OF</span> _ fv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> deg_u f
    <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.dvdm <span class="free">M</span> <span class="free">u</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?L</span> <span class="main">⊆</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> factorization_lattice_def <span class="keyword1"><span class="command">using</span></span> deg_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fv</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lincomb_list_carrier<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">using</span></span> degree_poly_of_vec_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">fv</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> dvd <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> poly_mod.dvdm <span class="free">M</span> <span class="free">u</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness of the LLL factorization algorithm›</span></span>

<span class="keyword1" id="LLL_Factorization-LLL_short_polynomial"><span class="command">lemma</span></span> LLL_short_polynomial<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> deg_u_0<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg_le<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> pl1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> monic<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">u</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"poly_mod.dvdm <span class="free">pl</span> <span class="free">u</span> <span class="main">(</span>LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
    poly_mod.dvdm <span class="free">pl</span> <span class="free">u</span> <span class="free">f</span> <span class="main">⟹</span> degree <span class="free">f</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∥</span>LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> poly_mod_2 <span class="quoted"><span class="free">pl</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> pl1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pl1 <span class="keyword1"><span class="command">have</span></span> pl0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Mp <span class="free">u</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?iu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_Mp <span class="var">?u</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> Mp_inv_Mp_id<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?iu</span> <span class="keyword1">=m</span> <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="keyword1">=m</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> iu_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?iu</span> <span class="keyword1">=m</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> degu<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?u</span> <span class="main">=</span> degree <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> monic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> monic <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monic_Mp<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="var">?iu</span> <span class="main">=</span> degree <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_Mp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_map_poly<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mon<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mon pl1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> degu <span class="keyword1"><span class="command">have</span></span> deg_iu<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?iu</span> <span class="main">=</span> degree <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> mon_iu<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="var">?iu</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> deg_iu <span class="keyword1"><span class="command">unfolding</span></span> inv_Mp_def Mp_def inv_M_def M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> pl1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_map_poly monic<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"factorization_lattice <span class="var">?iu</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="var">?d</span><span class="main">)</span> <span class="free">pl</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"short_vector_hybrid <span class="numeral">2</span> <span class="var">?L</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> deg_u_0 deg_le <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> deg_u_0 <span class="keyword1"><span class="command">have</span></span> u0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span> <span class="main">=</span> poly_of_vec <span class="var">?sv</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> LLL_short_polynomial_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> id'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="var">?sv</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span>LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">interpret</span></span> vec_module <span class="quoted"><span class="quoted">"<span class="keyword1">TYPE</span><span class="main">(</span>int<span class="main">)</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> L<span class="main">:</span> LLL <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> deg_le deg_iu <span class="keyword1"><span class="command">have</span></span> deg_iu_le<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?iu</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?L</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> factorization_lattice_def <span class="keyword1"><span class="command">using</span></span> deg_le deg_iu <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> deg_u_0 deg_iu <span class="keyword1"><span class="command">have</span></span> deg_iu0<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?iu</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> iu0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?iu</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> L.lin_indpt_list_factorization_lattice<span class="main">[</span><span class="operator">OF</span> refl deg_iu_le iu0 pl0<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> rat<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"L.gs.lin_indpt_list <span class="main">(</span>L.RAT <span class="var">?L</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> deg_iu<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> L<span class="main">:</span> LLL_with_assms <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">n</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="quoted"><span class="numeral">2</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> deg_iu deg_le<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> short <span class="main">=</span> L.short_vector_hybrid<span class="main">[</span><span class="operator">OF</span> refl n<span class="main">,</span> <span class="operator">unfolded</span> id' L.L_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> short<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span> <span class="main">∈</span> poly_of_vec <span class="main">`</span> lattice_of <span class="var">?L</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> fact <span class="main">=</span> L.factorization_lattice<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> deg_iu0 pl0 deg_iu_le n<span class="main">,</span> <span class="operator">unfolded</span> deg_iu<span class="main">,</span> <span class="operator">OF</span> mem<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fact <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fact <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?iu</span> <span class="keyword1">dvdm</span> <span class="main">(</span>LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span> <span class="keyword1">=m</span> <span class="var">?iu</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvdm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?iu</span> <span class="main">*</span> <span class="skolem">h</span> <span class="keyword1">=m</span> Mp <span class="var">?iu</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult_Mp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mp <span class="var">?iu</span> <span class="main">*</span> <span class="skolem">h</span> <span class="keyword1">=m</span> <span class="free">u</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> iu_u <span class="keyword1"><span class="command">unfolding</span></span> mult_Mp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">dvdm</span> <span class="main">(</span>LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvdm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> short <span class="keyword1"><span class="command">have</span></span> sv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sv</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">from</span></span> short <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sv</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">assume</span></span> degu<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">dvdm</span> <span class="free">f</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> degf<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">=m</span> <span class="free">u</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvdm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">*</span> <span class="skolem">h</span> <span class="keyword1">=m</span> Mp <span class="free">u</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult_Mp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mp <span class="free">u</span> <span class="main">*</span> <span class="skolem">h</span> <span class="keyword1">=m</span> Mp <span class="var">?iu</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> iu_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mp <span class="var">?iu</span> <span class="main">*</span> <span class="skolem">h</span> <span class="keyword1">=m</span> <span class="var">?iu</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult_Mp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?iu</span> <span class="keyword1">dvdm</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvdm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> degu deg_iu <span class="keyword1"><span class="command">have</span></span> deg_iun<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?iu</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> L.factorization_lattice<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> deg_iu0 pl0 mon_iu deg_iun degf dvd<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> poly_of_vec <span class="main">`</span> lattice_of <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deg_iu <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fv</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> poly_of_vec <span class="skolem">fv</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fv</span> <span class="main">∈</span> lattice_of <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">fv</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> fv0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fv</span> <span class="main">≠</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f0 <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> fv <span class="keyword1"><span class="command">have</span></span> fvL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fv</span> <span class="main">∈</span> lattice_of <span class="var">?L</span> <span class="main">-</span> <span class="main">{</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> short<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">unfolded</span> norm<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">∥</span>LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> rat_of_int <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>LLL_short_polynomial <span class="free">pl</span> <span class="free">n</span> <span class="free">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> LLL_implementation
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LLL_Factorization-LLL_reconstruction"><span class="command">lemma</span></span> LLL_reconstruction<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_reconstruction <span class="free">f</span> <span class="free">us</span> <span class="main">=</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"poly_mod.unique_factorization_m <span class="free">pl</span> <span class="free">f</span> <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">,</span> mset <span class="free">us</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ui</span><span class="main">.</span> <span class="bound">ui</span> <span class="main">∈</span> set <span class="free">us</span> <span class="main">⟹</span> poly_mod.Mp <span class="free">pl</span> <span class="bound">ui</span> <span class="main">=</span> <span class="bound">ui</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> F0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="free">F</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.square_free_m <span class="free">p</span> <span class="free">F</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> pl1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> plp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">=</span> <span class="free">p</span><span class="main">^</span><span class="free">l</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> large<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">F</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">F</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">F</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">pl</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> prod_list <span class="free">fs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">fi</span> <span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">fi</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> poly_mod_prime <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> p<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> pl<span class="main">:</span> poly_mod_2 <span class="quoted"><span class="quoted">"<span class="free">pl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> pl1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pl1 plp <span class="keyword1"><span class="command">have</span></span> l0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-5<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> LLL_reconstruction.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">us</span> <span class="skolem">fs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> choose_u <span class="skolem">us</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> LLL_short_polynomial <span class="free">pl</span> <span class="main">(</span>degree <span class="skolem">f</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> gcd <span class="skolem">f</span> <span class="skolem">g</span>"</span></span> 
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> 1<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> degf <span class="main">=</span> 1<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> uf <span class="main">=</span> 1<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> fF <span class="main">=</span> 1<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> norm <span class="main">=</span> 1<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> to_fact <span class="main">=</span> pl.unique_factorization_m_imp_factorization
    <span class="keyword1"><span class="command">note</span></span> fact <span class="main">=</span> to_fact<span class="main">[</span><span class="operator">OF</span> uf<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> mon_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ui</span> <span class="main">∈</span> set <span class="skolem">us</span> <span class="main">⟹</span> monic <span class="skolem">ui</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ui</span> <span class="keyword1"><span class="command">using</span></span> norm fact
      <span class="keyword1"><span class="command">unfolding</span></span> pl.factorization_m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> p.coprime_lead_coeff_factor<span class="main">[</span><span class="operator">OF</span> p.prime<span class="main">]</span> fF cop 
    <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="skolem">f</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> plf0<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="skolem">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> fact pl.factorization_m_lead_coeff pl.unique_factorization_m_zero uf <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> pl.degree_m <span class="skolem">f</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> poly_mod.degree_m_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ pl.m1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">insert</span> cop p<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l0 p.coprime_exp_mod plp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  sum_mset <span class="main">(</span>image_mset pl.degree_m <span class="main">(</span>mset <span class="skolem">us</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pl.factorization_m_degree<span class="main">[</span><span class="operator">OF</span> fact plf0<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map pl.degree_m <span class="skolem">us</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> sum_mset_sum_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map degree <span class="skolem">us</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_cong<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> pl.monic_degree_m<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mon_gs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> degf_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> sum_list <span class="main">(</span>map degree <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">us</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> choose_u_member<span class="main">[</span><span class="operator">OF</span> gs<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> u_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fact u_gs <span class="keyword1"><span class="command">have</span></span> irred<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.irreducible<span class="hidden">⇩</span><sub>d</sub>_m <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pl.factorization_m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> deg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pl.irreducible<span class="hidden">⇩</span><sub>d</sub>_m_def norm<span class="main">[</span><span class="operator">OF</span> u_gs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> deg_uf<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">≤</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> degf_gs <span class="keyword1"><span class="command">using</span></span> split_list<span class="main">[</span><span class="operator">OF</span> u_gs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> mon_gs<span class="main">[</span><span class="operator">OF</span> u_gs<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> mon_u<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> norm <span class="keyword1"><span class="command">have</span></span> norm'<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset pl.Mp <span class="main">(</span>mset <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> mset <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">us</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> pl0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pl1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> short_main <span class="main">=</span> LLL_short_polynomial<span class="main">[</span><span class="operator">OF</span> deg_u deg_uf pl1 mon_u<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> short_main<span class="main">(</span>1-2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> g_def<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">k</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc_leI Suc_less_eq degree_gcd1 gcd.commute le_imp_less_Suc le_trans<span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> deg_fk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>degree <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="skolem">f</span> <span class="main">≤</span> degree <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>degree <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> LLL_reconstruction.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">us</span></span><span class="main"><span class="main">]</span></span> Let_def<span class="main">,</span> <span class="operator">folded</span> u_def<span class="main">,</span> 
        <span class="operator">folded</span> g_def<span class="main">,</span> <span class="operator">folded</span> k_def<span class="main">,</span> <span class="operator">unfolded</span> deg_fk<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> res <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">f</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> sf fF <span class="keyword1"><span class="command">have</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"p.square_free_m <span class="skolem">f</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> p.square_free_m_factor<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">f</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">f</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> reducible<span class="hidden">⇩</span><sub>d</sub>E<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> degf <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f1</span> <span class="main">*</span> <span class="skolem">f2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          deg12<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> pl.unique_factorization_m_factor<span class="main">[</span><span class="operator">OF</span> p uf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> f<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> f<span class="main">,</span> <span class="operator">OF</span> cop sf l0 plp<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us1</span></span> <span class="skolem"><span class="skolem">us2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          uf12<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">f1</span> <span class="main">(</span>lead_coeff <span class="skolem">f1</span><span class="main">,</span> <span class="skolem">us1</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">f2</span> <span class="main">(</span>lead_coeff <span class="skolem">f2</span><span class="main">,</span> <span class="skolem">us2</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">us1</span> <span class="main">+</span> <span class="skolem">us2</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> norm12<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset pl.Mp <span class="skolem">us2</span> <span class="main">=</span> <span class="skolem">us2</span>"</span></span> <span class="quoted"><span class="quoted">"image_mset pl.Mp <span class="skolem">us1</span> <span class="main">=</span> <span class="skolem">us1</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> pl.Mf_def norm' split <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pl.Mf_def<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> norm_u <span class="main">=</span> norm<span class="main">[</span><span class="operator">OF</span> u_gs<span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> u_gs <span class="keyword1"><span class="command">have</span></span> u_gs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈#</span> mset <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> pl.factorization_m_mem_dvdm<span class="main">[</span><span class="operator">OF</span> fact<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">have</span></span> u_f<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="skolem">u</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> u_gs'<span class="main">[</span><span class="operator">unfolded</span> gs<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈#</span> <span class="skolem">us1</span> <span class="main">∨</span> <span class="skolem">u</span> <span class="main">∈#</span> <span class="skolem">us2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> pl.factorization_m_mem_dvdm<span class="main">[</span><span class="operator">OF</span> to_fact<span class="main"><span class="main">[</span></span><span class="operator">OF</span> uf12<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> 
             pl.factorization_m_mem_dvdm<span class="main">[</span><span class="operator">OF</span> to_fact<span class="main"><span class="main">[</span></span><span class="operator">OF</span> uf12<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="skolem">u</span> <span class="skolem">f1</span> <span class="main">∨</span> pl.dvdm <span class="skolem">u</span> <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm12 norm_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">f1</span> <span class="bound">f2</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">=</span> <span class="bound">f1</span> <span class="main">*</span> <span class="bound">f2</span> <span class="main">∧</span> 
          degree <span class="bound">f1</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> degree <span class="bound">f2</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> degree <span class="bound">f1</span> <span class="main">&lt;</span> degree <span class="skolem">f</span> <span class="main">∧</span> degree <span class="bound">f2</span> <span class="main">&lt;</span> degree <span class="skolem">f</span> <span class="main">∧</span> 
          pl.dvdm <span class="skolem">u</span> <span class="bound">f1</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> 
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="skolem">u</span> <span class="skolem">f1</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f deg12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f2</span> <span class="main">*</span> <span class="skolem">f1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="skolem">u</span> <span class="skolem">f2</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f deg12 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f1</span> <span class="main">*</span> <span class="skolem">f2</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> uf1<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="skolem">u</span> <span class="skolem">f1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> pl.unique_factorization_m_factor<span class="main">[</span><span class="operator">OF</span> p uf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> prod<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> prod<span class="main">,</span> <span class="operator">OF</span> cop sf l0 plp<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fact_f1<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">f1</span> <span class="main">(</span>lead_coeff <span class="skolem">f1</span><span class="main">,</span> <span class="skolem">us1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> plf1<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="skolem">f1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> to_fact<span class="main">[</span><span class="operator">OF</span> fact_f1<span class="main">]</span> pl.factorization_m_lead_coeff 
            pl.unique_factorization_m_zero fact_f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">≤</span> degree <span class="skolem">f1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pl.dvdm_degree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mon_u uf1 plf1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> deg <span class="keyword1"><span class="command">have</span></span> deg_uf<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> pl0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pl.m1 plp <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span>"</span></span> 
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> prod fF <span class="keyword1"><span class="command">have</span></span> f1F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> deg_uf <span class="keyword1"><span class="command">have</span></span> deg_uf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">≤</span> <span class="var">?n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> deg <span class="keyword1"><span class="command">have</span></span> f1_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> ug<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="skolem">u</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> short_main<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> short_main<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> deg_gf<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> short_main<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degree <span class="free">F</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> fF prod <span class="keyword1"><span class="command">have</span></span> f1F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> short_main<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> deg_uf _ uf1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> deg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="skolem">f1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sq_norm_factor_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f1F F0<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> degree <span class="skolem">f1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> power_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> deg<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ineq_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">from</span></span> power_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?n1</span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> ineq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="var">?n1</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">^</span><span class="var">?n1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> F0 <span class="keyword1"><span class="command">have</span></span> normF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">from</span></span> g0 <span class="keyword1"><span class="command">have</span></span> normg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">from</span></span> f0 <span class="keyword1"><span class="command">have</span></span> normf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">from</span></span> f1_0 <span class="keyword1"><span class="command">have</span></span> normf1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">from</span></span> power_mono<span class="main">[</span><span class="operator">OF</span> sq_norm_factor_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f1F F0<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> ineq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">g</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?n1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">^</span> degree <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?n1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> deg_gf normF<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>          
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ineq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">g</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?n1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> nN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fF F0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_imp_degree_le<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> deg nN <span class="keyword1"><span class="command">have</span></span> n1N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="main">≤</span> <span class="var">?N</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">g</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="var">?n1</span> <span class="main">≤</span> 
          <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?n1</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="var">?n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">^</span><span class="var">?n1</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ineq2 ineq1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span>
          <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> power_both_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ mult_mono<span class="main"><span class="main">]</span></span> 
          power_both_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> normF n1N nN<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> power_both_mono mult_mono<span class="main">)</span> 
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> 
            <span class="main">*</span> <span class="main">(</span><span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> power_mult_distrib power_add power_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">5</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">pl</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> large<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> large<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">g</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">f1</span> <span class="main">&lt;</span> <span class="free">pl</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> deg_ug<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">≤</span> degree <span class="skolem">g</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pl.dvdm_degree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mon_u ug<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pl.Mp <span class="skolem">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">(</span>degree <span class="skolem">g</span><span class="main">)</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.M <span class="main">(</span>coeff <span class="skolem">g</span> <span class="main">(</span>degree <span class="skolem">g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pl.Mp_def coeff_map_poly<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> pl.M_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> lg<span class="main">:</span> <span class="quoted"><span class="quoted">"lead_coeff <span class="skolem">g</span> <span class="main">=</span> <span class="free">pl</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> g0 <span class="keyword1"><span class="command">have</span></span> c0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">pl</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span>lead_coeff <span class="skolem">g</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lg abs_le_square_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> aux_abs_int<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coeff_le_sq_norm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">f1</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> deg normg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">*</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">g</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">f1</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> normf1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">pl</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> large<span class="main">)</span> 
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> deg deg_u deg_ug <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> common_factor_via_short<span class="main">[</span><span class="operator">OF</span> this mon_u _ uf1 ug large<span class="main">]</span> deg_u pl.m1
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="main">(</span>gcd <span class="skolem">f1</span> <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True<span class="main">[</span><span class="operator">unfolded</span> k_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">f1</span> <span class="skolem">g</span> <span class="keyword1">dvd</span> gcd <span class="skolem">f</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f0 <span class="keyword1"><span class="command">unfolding</span></span> prod <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> divides_degree<span class="main">[</span><span class="operator">OF</span> dvd<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> f0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs <span class="keyword1"><span class="command">using</span></span> irr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> <span class="skolem">f</span> <span class="keyword1">div</span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f1</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f1_def k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">degree</span><span class="main">]</span> f0 <span class="keyword1"><span class="command">have</span></span> deg_f1k<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> degree <span class="skolem">f1</span> <span class="main">+</span> degree <span class="skolem">k</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_mult_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> f fF <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gs1</span></span> <span class="skolem"><span class="skolem">gs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"List.partition <span class="main">(</span><span class="main">λ</span><span class="bound">gi</span><span class="main">.</span> p.dvdm <span class="bound">gi</span> <span class="skolem">f1</span><span class="main">)</span> <span class="skolem">us</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">gs1</span><span class="main">,</span> <span class="skolem">gs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>  
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1-2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> refl u_def g_def k_def refl<span class="main">,</span> <span class="operator">unfolded</span> deg_fk<span class="main">,</span> <span class="operator">OF</span> False f1_def part<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> refl<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs1<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction <span class="skolem">f1</span> <span class="skolem">gs1</span> <span class="main">=</span> <span class="skolem">fs1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs2<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction <span class="skolem">k</span> <span class="skolem">gs2</span> <span class="main">=</span> <span class="skolem">fs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> False res<span class="main">[</span><span class="operator">folded</span> f1_def<span class="main">,</span> <span class="operator">unfolded</span> part split fs1 fs2<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="skolem">fs1</span> <span class="main">@</span> <span class="skolem">fs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> short_main<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> deg_gf<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> short_main<span class="main">(</span>2<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> deg_kg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">k</span> <span class="main">≤</span> degree <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k_def gcd.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_gcd1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g0<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> deg_gf deg_kg <span class="keyword1"><span class="command">have</span></span> deg_kf<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">k</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> deg_f1k <span class="keyword1"><span class="command">have</span></span> deg_f1<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> sf_f<span class="main">:</span> <span class="quoted"><span class="quoted">"p.square_free_m <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sf fF p.square_free_m_factor <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> p.unique_factorization_m_factor_partition<span class="main">[</span><span class="operator">OF</span> l0 uf<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> plp<span class="main"><span class="main"><span class="main">]</span></span></span> f cop sf_f part<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> uf<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">f1</span> <span class="main">(</span>lead_coeff <span class="skolem">f1</span><span class="main">,</span> mset <span class="skolem">gs1</span><span class="main">)</span>"</span></span>  
          <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">k</span> <span class="main">(</span>lead_coeff <span class="skolem">k</span><span class="main">,</span> mset <span class="skolem">gs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plp<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">us</span> <span class="main">=</span> set <span class="skolem">gs1</span> <span class="main">∪</span> set <span class="skolem">gs2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> norm <span class="keyword1"><span class="command">have</span></span> norm_12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gi</span> <span class="main">∈</span> set <span class="skolem">gs1</span> <span class="main">∨</span> <span class="skolem">gi</span> <span class="main">∈</span> set <span class="skolem">gs2</span> <span class="main">⟹</span> pl.Mp <span class="skolem">gi</span> <span class="main">=</span> <span class="skolem">gi</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">gi</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH1 <span class="main">=</span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> fs1 deg_f1 uf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dvd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> norm_12<span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> IH2 <span class="main">=</span> IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> fs2 False uf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dvd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> norm_12<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs f <span class="keyword1"><span class="command">using</span></span> IH1 IH2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Factorization-LLL_many_reconstruction"><span class="command">lemma</span></span> LLL_many_reconstruction<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_many_reconstruction <span class="free">f</span> <span class="free">us</span> <span class="main">=</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"poly_mod.unique_factorization_m <span class="free">pl</span> <span class="free">f</span> <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">,</span> mset <span class="free">us</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ui</span><span class="main">.</span> <span class="bound">ui</span> <span class="main">∈</span> set <span class="free">us</span> <span class="main">⟹</span> poly_mod.Mp <span class="free">pl</span> <span class="bound">ui</span> <span class="main">=</span> <span class="bound">ui</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> F0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="free">F</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.square_free_m <span class="free">p</span> <span class="free">F</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> pl1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> plp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">=</span> <span class="free">p</span><span class="main">^</span><span class="free">l</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> large<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">F</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">F</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">F</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">pl</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> prod_list <span class="free">fs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">fi</span> <span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">fi</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> poly_mod_prime <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> p<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> pl<span class="main">:</span> poly_mod_2 <span class="quoted"><span class="quoted">"<span class="free">pl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> pl1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pl1 plp <span class="keyword1"><span class="command">have</span></span> l0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-5<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> LLL_many_reconstruction.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">us</span> <span class="skolem">fs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> 1<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> degf <span class="main">=</span> 1<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> uf <span class="main">=</span> 1<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> fF <span class="main">=</span> 1<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> norm <span class="main">=</span> 1<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> to_fact <span class="main">=</span> pl.unique_factorization_m_imp_factorization
    <span class="keyword1"><span class="command">note</span></span> fact <span class="main">=</span> to_fact<span class="main">[</span><span class="operator">OF</span> uf<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> mon_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ui</span> <span class="main">∈</span> set <span class="skolem">us</span> <span class="main">⟹</span> monic <span class="skolem">ui</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ui</span> <span class="keyword1"><span class="command">using</span></span> norm fact
      <span class="keyword1"><span class="command">unfolding</span></span> pl.factorization_m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> p.coprime_lead_coeff_factor<span class="main">[</span><span class="operator">OF</span> p.prime<span class="main">]</span> fF cop 
    <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="skolem">f</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> plf0<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="skolem">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> fact pl.factorization_m_lead_coeff pl.unique_factorization_m_zero uf <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> pl.degree_m <span class="skolem">f</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> poly_mod.degree_m_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ pl.m1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">insert</span> cop p<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l0 p.coprime_exp_mod plp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  sum_mset <span class="main">(</span>image_mset pl.degree_m <span class="main">(</span>mset <span class="skolem">us</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pl.factorization_m_degree<span class="main">[</span><span class="operator">OF</span> fact plf0<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map pl.degree_m <span class="skolem">us</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> sum_mset_sum_list<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map degree <span class="skolem">us</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_cong<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> pl.monic_degree_m<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mon_gs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> degf_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> sum_list <span class="main">(</span>map degree <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">us</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> df0<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> norm <span class="keyword1"><span class="command">have</span></span> norm'<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset pl.Mp <span class="main">(</span>mset <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> mset <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">us</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> pl0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pl1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degree <span class="free">F</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gg</span> <span class="main">=</span> LLL_short_polynomial <span class="free">pl</span> <span class="main">(</span>Suc <span class="var">?d2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?us</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> degree <span class="bound">u</span> <span class="main">≤</span> <span class="var">?d2</span><span class="main">)</span> <span class="skolem">us</span>"</span></span> 
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> LLL_many_reconstruction.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">us</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> Let_def<span class="main">,</span>
        <span class="operator">folded</span> gg_def<span class="main">]</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f2_opt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"find_map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> gcd <span class="skolem">f</span> <span class="main">(</span><span class="skolem">gg</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">λ</span><span class="bound">f2</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> degree <span class="bound">f2</span> <span class="main">∧</span> degree <span class="bound">f2</span> <span class="main">&lt;</span> degree <span class="skolem">f</span><span class="main">)</span> <span class="var">?us</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?f2_opt</span></span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">f2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> find_map_filter_Some<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> deg_f2<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f2</span> <span class="keyword1">dvd</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f2</span> <span class="main">=</span> gcd <span class="skolem">f</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> Some option.simps<span class="main">]</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> <span class="skolem">f</span> <span class="keyword1">div</span> <span class="skolem">f2</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f1</span> <span class="main">*</span> <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f1_def <span class="keyword1"><span class="command">using</span></span> dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">degree</span><span class="main">]</span> f0 <span class="keyword1"><span class="command">have</span></span> deg_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> degree <span class="skolem">f1</span> <span class="main">+</span> degree <span class="skolem">f2</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_mult_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> deg_f2 <span class="keyword1"><span class="command">have</span></span> deg_f1<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> f fF <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f2</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gs1</span></span> <span class="skolem"><span class="skolem">gs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"List.partition <span class="main">(</span><span class="main">λ</span><span class="bound">gi</span><span class="main">.</span> p.dvdm <span class="bound">gi</span> <span class="skolem">f1</span><span class="main">)</span> <span class="skolem">us</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">gs1</span><span class="main">,</span> <span class="skolem">gs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>  
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1-2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> refl refl refl<span class="main">,</span> <span class="operator">unfolded</span> Let_def<span class="main">,</span> <span class="operator">folded</span> gg_def<span class="main">,</span> <span class="operator">OF</span> Some f1_def part<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> refl<span class="main">]</span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs1</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs1<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_many_reconstruction <span class="skolem">f1</span> <span class="skolem">gs1</span> <span class="main">=</span> <span class="skolem">fs1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs2<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_many_reconstruction <span class="skolem">f2</span> <span class="skolem">gs2</span> <span class="main">=</span> <span class="skolem">fs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">folded</span> f1_def<span class="main">,</span> <span class="operator">unfolded</span> part split fs1 fs2<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="skolem">fs1</span> <span class="main">@</span> <span class="skolem">fs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> sf_f<span class="main">:</span> <span class="quoted"><span class="quoted">"p.square_free_m <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sf fF p.square_free_m_factor <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> p.unique_factorization_m_factor_partition<span class="main">[</span><span class="operator">OF</span> l0 uf<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> plp<span class="main"><span class="main"><span class="main">]</span></span></span> f cop sf_f part<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> uf<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">f1</span> <span class="main">(</span>lead_coeff <span class="skolem">f1</span><span class="main">,</span> mset <span class="skolem">gs1</span><span class="main">)</span>"</span></span>  
          <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">f2</span> <span class="main">(</span>lead_coeff <span class="skolem">f2</span><span class="main">,</span> mset <span class="skolem">gs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plp<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">us</span> <span class="main">=</span> set <span class="skolem">gs1</span> <span class="main">∪</span> set <span class="skolem">gs2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> norm <span class="keyword1"><span class="command">have</span></span> norm_12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gi</span> <span class="main">∈</span> set <span class="skolem">gs1</span> <span class="main">∨</span> <span class="skolem">gi</span> <span class="main">∈</span> set <span class="skolem">gs2</span> <span class="main">⟹</span> pl.Mp <span class="skolem">gi</span> <span class="main">=</span> <span class="skolem">gi</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">gi</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH1 <span class="main">=</span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> fs1 deg_f1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> uf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dvd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> norm_12<span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> IH2 <span class="main">=</span> IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> fs2 deg_f2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> uf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dvd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> norm_12<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs f <span class="keyword1"><span class="command">using</span></span> IH1 IH2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> None option.simps<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fs_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">f</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> sf fF <span class="keyword1"><span class="command">have</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"p.square_free_m <span class="skolem">f</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> p.square_free_m_factor<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">f</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> reducible<span class="hidden">⇩</span><sub>d</sub>E<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> degf <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f1</span> <span class="main">*</span> <span class="skolem">f2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          deg12<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> f0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> degree <span class="skolem">f1</span> <span class="main">+</span> degree <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_mult_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">≤</span> degree <span class="skolem">f</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">∨</span> degree <span class="skolem">f2</span> <span class="main">≤</span> degree <span class="skolem">f</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f1</span> <span class="main">*</span> <span class="skolem">f2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          deg12<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">≤</span> degree <span class="skolem">f</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f2</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> 
          <span class="keyword3"><span class="command">case</span></span> 1
          <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f1</span></span> <span class="quoted"><span class="skolem">f2</span></span><span class="main">]</span> 1<span class="main">(</span>2<span class="main">)</span> f deg12 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>  
          <span class="keyword3"><span class="command">case</span></span> 2
          <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f2</span></span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">]</span> 2<span class="main">(</span>2<span class="main">)</span> f deg12 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> f0 f <span class="keyword1"><span class="command">have</span></span> f10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> sf f <span class="keyword1"><span class="command">have</span></span> sf1<span class="main">:</span> <span class="quoted"><span class="quoted">"p.square_free_m <span class="skolem">f1</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> p.square_free_m_factor<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> p.coprime_lead_coeff_factor<span class="main">[</span><span class="operator">OF</span> p.prime cop<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> f<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">have</span></span> cop1<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="skolem">f1</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> deg_m1<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.degree_m <span class="skolem">f1</span> <span class="main">=</span> degree <span class="skolem">f1</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_mod.degree_m_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ pl.m1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
            <span class="operator">insert</span> cop1 p<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l0 p.coprime_exp_mod plp<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> pl.unique_factorization_m_factor<span class="main">[</span><span class="operator">OF</span> p uf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> f<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> f<span class="main">,</span> <span class="operator">OF</span> cop sf l0 plp<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us1</span></span> <span class="skolem"><span class="skolem">us2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          uf12<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">f1</span> <span class="main">(</span>lead_coeff <span class="skolem">f1</span><span class="main">,</span> <span class="skolem">us1</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">f2</span> <span class="main">(</span>lead_coeff <span class="skolem">f2</span><span class="main">,</span> <span class="skolem">us2</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">us1</span> <span class="main">+</span> <span class="skolem">us2</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> norm12<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset pl.Mp <span class="skolem">us2</span> <span class="main">=</span> <span class="skolem">us2</span>"</span></span> <span class="quoted"><span class="quoted">"image_mset pl.Mp <span class="skolem">us1</span> <span class="main">=</span> <span class="skolem">us1</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> pl.Mf_def norm' split <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pl.Mf_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> gs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">us1</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈#</span> mset <span class="skolem">us</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> sub1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">us1</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">us</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> to_fact<span class="main">[</span><span class="operator">OF</span> uf12<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.factorization_m <span class="skolem">f1</span> <span class="main">(</span>lead_coeff <span class="skolem">f1</span><span class="main">,</span> <span class="skolem">us1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> plf10<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="skolem">f1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> fact1 pl.factorization_m_lead_coeff pl.unique_factorization_m_zero uf12<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">=</span> pl.degree_m <span class="skolem">f1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deg_m1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_mset <span class="main">(</span>image_mset pl.degree_m <span class="skolem">us1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> pl.factorization_m_degree<span class="main">[</span><span class="operator">OF</span> fact1 plf10<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_mset <span class="main">(</span>image_mset degree <span class="skolem">us1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sum_mset</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> image_mset_cong<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule</span> pl.monic_degree_m<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> mon_gs<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sub1<span class="main">)</span> 
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> degf1_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">=</span> sum_mset <span class="main">(</span>image_mset degree <span class="skolem">us1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> deg12 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us1</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">us11</span></span> <span class="keyword2"><span class="keyword">where</span></span> us1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">us1</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">u</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">us11</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">us1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>        
        <span class="keyword1"><span class="command">hence</span></span> u1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈#</span> <span class="skolem">us1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sub1<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">gg</span> <span class="skolem">u</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> pl.factorization_m_mem_dvdm<span class="main">[</span><span class="operator">OF</span> fact1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> u1 <span class="keyword1"><span class="command">have</span></span> u_f1<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="skolem">u</span> <span class="skolem">f1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> norm_u <span class="main">=</span> norm<span class="main">[</span><span class="operator">OF</span> u<span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> fact u <span class="keyword1"><span class="command">have</span></span> irred<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.irreducible<span class="hidden">⇩</span><sub>d</sub>_m <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pl.factorization_m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> deg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pl.irreducible<span class="hidden">⇩</span><sub>d</sub>_m_def norm<span class="main">[</span><span class="operator">OF</span> u<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">≤</span> degree <span class="skolem">f1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> degf1_sum <span class="keyword1"><span class="command">unfolding</span></span> us1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> degree <span class="skolem">f</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> deg_uf<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">≤</span> degree <span class="skolem">f</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">hence</span></span> deg_uf'<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">≤</span> Suc <span class="main">(</span>degree <span class="skolem">f</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">&lt;</span> Suc <span class="main">(</span>degree <span class="skolem">f</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> mon_gs<span class="main">[</span><span class="operator">OF</span> u<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> mon_u<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

        <span class="keyword1"><span class="command">note</span></span> short <span class="main">=</span> LLL_short_polynomial<span class="main">[</span><span class="operator">OF</span> deg_u deg_uf'<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span> pl1 mon_u<span class="main">,</span> <span class="operator">folded</span> gg_def<span class="main">]</span>
        <span class="keyword1"><span class="command">note</span></span> short <span class="main">=</span> short<span class="main">(</span>1-3<span class="main">)</span> short<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> deg_uf'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> short<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> deg12<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> f10 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="skolem">f</span> <span class="var">?g</span><span class="main">)</span> <span class="main">≤</span> degree <span class="skolem">f</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI Suc_le_mono degree_gcd1 gcd.commute le_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degf <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="skolem">f</span> <span class="var">?g</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> find_map_filter_None<span class="main">[</span><span class="operator">OF</span> None<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> deg_uf u
        <span class="keyword1"><span class="command">have</span></span> deg_gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="skolem">f</span> <span class="main">(</span><span class="var">?g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gcd.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">f1</span> <span class="main">(</span><span class="var">?g</span><span class="main">)</span> <span class="keyword1">dvd</span> gcd <span class="skolem">f</span> <span class="main">(</span><span class="var">?g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f0 <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> divides_degree<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">unfolded</span> deg_gcd<span class="main">]</span> f0
        <span class="keyword1"><span class="command">have</span></span> deg_gcd1<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="skolem">f1</span> <span class="main">(</span><span class="var">?g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> F0 <span class="keyword1"><span class="command">have</span></span> normF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">have</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> short<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">from</span></span> g0 <span class="keyword1"><span class="command">have</span></span> normg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="var">?g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">from</span></span> f10 <span class="keyword1"><span class="command">have</span></span> normf1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">from</span></span> fF f <span class="keyword1"><span class="command">have</span></span> f1F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> pl_ge0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pl.poly_mod_2_axioms poly_mod_2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> fF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">≤</span> degree <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F0 f0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_imp_degree_le<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> d2D2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?d2</span> <span class="main">≤</span> <span class="var">?D2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> deg12<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> df1_D2<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">≤</span> <span class="var">?D2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">from</span></span> short<span class="main">(</span>1<span class="main">)</span> d2D2 <span class="keyword1"><span class="command">have</span></span> dg_D2<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?D2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="main">(</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">f1</span>
          <span class="main">≤</span> <span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="var">?D2</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="var">?D2</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pow_mono_exp pow_mono_exp<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
              <span class="operator">insert</span> normf1 normg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> df1_D2 dg_D2<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">^</span><span class="var">?D2</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult_distrib<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="var">?D2</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="var">?D2</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> power_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> short<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> f10 u_f1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">insert</span> deg12 d2D2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="var">?D2</span> <span class="main">+</span> <span class="var">?D2</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?D2</span> <span class="main">*</span> <span class="var">?D2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> power_add power_mult_distrib power_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?D2</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="var">?D2</span> <span class="main">+</span> <span class="var">?D2</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?D2</span> <span class="main">*</span> <span class="var">?D2</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> power_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sq_norm_factor_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f1F F0<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
            <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> power_mono mult_right_mono df1_D2<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?D2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?D2</span> <span class="main">+</span> <span class="var">?D2</span><span class="main">)</span> <span class="main">+</span> <span class="var">?D2</span> <span class="main">*</span> <span class="var">?D2</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="var">?D2</span> <span class="main">+</span> <span class="var">?D2</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> power_mult_distrib power_mult power_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="var">?D2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?D2</span> <span class="main">+</span> <span class="var">?D2</span><span class="main">)</span> <span class="main">+</span> <span class="var">?D2</span> <span class="main">*</span> <span class="var">?D2</span> <span class="main">=</span> <span class="numeral">5</span> <span class="main">*</span> <span class="var">?D2</span> <span class="main">*</span> <span class="var">?D2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D2</span> <span class="main">+</span> <span class="var">?D2</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?D2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> large<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="main">(</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">f1</span> <span class="main">&lt;</span> <span class="free">pl</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> large <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">≤</span> degree <span class="main">(</span><span class="var">?g</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pl.dvdm_degree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mon_u short<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pl.Mp <span class="main">(</span><span class="var">?g</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">(</span>degree <span class="var">?g</span><span class="main">)</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.M <span class="main">(</span>coeff <span class="var">?g</span> <span class="main">(</span>degree <span class="var">?g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pl.Mp_def coeff_map_poly<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> pl.M_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> lg<span class="main">:</span> <span class="quoted"><span class="quoted">"lead_coeff <span class="var">?g</span> <span class="main">=</span> <span class="free">pl</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> g0 <span class="keyword1"><span class="command">have</span></span> c0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">pl</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span>lead_coeff <span class="var">?g</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lg abs_le_square_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> aux_abs_int<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∥</span><span class="var">?g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coeff_le_sq_norm<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∥</span><span class="var">?g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∥</span><span class="var">?g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">f1</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> deg12 normg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">*</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="var">?g</span> <span class="main">*</span> <span class="main">∥</span><span class="var">?g</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">f1</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> normf1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">pl</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> large<span class="main">)</span> 
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">with</span></span> deg_u <span class="keyword1"><span class="command">have</span></span> deg_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> pl_ge0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pl.poly_mod_2_axioms poly_mod_2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> fF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">≤</span> degree <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F0 f0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_imp_degree_le<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> d2D2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?d2</span> <span class="main">≤</span> <span class="var">?D2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> deg12<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> df1_D2<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f1</span> <span class="main">≤</span> <span class="var">?D2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">from</span></span> short<span class="main">(</span>1<span class="main">)</span> d2D2 <span class="keyword1"><span class="command">have</span></span> dg_D2<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?D2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="skolem">f1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deg12 deg_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> common_factor_via_short<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f1</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gg</span> <span class="skolem">u</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> deg_g mon_u this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> u_f1 short<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> _ pl_ge0<span class="main">]</span> deg_gcd1
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">pl</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">f1</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="main">(</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">gg</span> <span class="skolem">u</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">f1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">pl</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> large<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fs_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="LLL_Factorization-LLL_factorization"><span class="command">lemma</span></span> LLL_factorization<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_factorization <span class="free">f</span> <span class="main">=</span> <span class="free">gs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> prod_list <span class="free">gs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">gs</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lead_coeff <span class="free">f</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≡</span> suitable_prime_bz <span class="free">f</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">gs</span></span> <span class="keyword2"><span class="keyword">where</span></span> fff<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_field_factorization_int <span class="skolem">p</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">gs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?degs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map degree <span class="skolem">gs</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> LLL_factorization_def Let_def<span class="main">,</span> <span class="operator">folded</span> p_def<span class="main">,</span>
    <span class="operator">unfolded</span> fff split<span class="main">,</span> <span class="operator">folded</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> suitable_prime_bz<span class="main">[</span><span class="operator">OF</span> sff refl<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> prime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="var">?lc</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.square_free_m <span class="skolem">p</span> <span class="free">f</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> res
  <span class="keyword1"><span class="command">from</span></span> prime <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> poly_mod_prime <span class="quoted"><span class="skolem">p</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">f</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">f</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">f</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> sqrt_int_ceiling <span class="skolem">K</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> K0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N_def sqrt_int_ceiling <span class="keyword1"><span class="command">using</span></span> K0 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> of_int_nonneg real_sqrt_ge_0_iff zero_le_ceiling<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> find_exponent <span class="skolem">p</span> <span class="skolem">N</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">folded</span> n_def<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> N_def K_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> find_exponent<span class="main">[</span><span class="operator">OF</span> p.m1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">N</span></span></span></span><span class="main">,</span> <span class="operator">folded</span> n_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> bh <span class="main">=</span> p.berlekamp_and_hensel_separated<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> cop sf refl fff n<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> deg <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> n p.m1 <span class="keyword1"><span class="command">have</span></span> pn1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">folded</span> bh<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> p.berlekamp_hensel_unique<span class="main">[</span><span class="operator">OF</span> cop sf bh n<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> p.berlekamp_hensel_main<span class="main">[</span><span class="operator">OF</span> n<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> bh cop sf fff<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> res * **
  <span class="keyword1"><span class="command">have</span></span> uf<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.unique_factorization_m <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">,</span> mset <span class="main">(</span>berlekamp_hensel <span class="skolem">p</span> <span class="skolem">n</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ui</span><span class="main">.</span> <span class="bound">ui</span> <span class="main">∈</span> set <span class="main">(</span>berlekamp_hensel <span class="skolem">p</span> <span class="skolem">n</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> poly_mod.Mp <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">ui</span> <span class="main">=</span> <span class="bound">ui</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> berlekamp_hensel_def fff split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n sqrt_int_ceiling_bound<span class="main">[</span><span class="operator">OF</span> K0<span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> N0 N_def n<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> power2_le_imp_le<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_implementation.LLL_reconstruction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> res deg uf dvd_refl norm f0 cop sf pn1 
          refl prime K<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> K_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LLL_Factorization-LLL_many_factorization"><span class="command">lemma</span></span> LLL_many_factorization<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_many_factorization <span class="free">f</span> <span class="main">=</span> <span class="free">gs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> prod_list <span class="free">gs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">gs</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lead_coeff <span class="free">f</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≡</span> suitable_prime_bz <span class="free">f</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">gs</span></span> <span class="keyword2"><span class="keyword">where</span></span> fff<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_field_factorization_int <span class="skolem">p</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">gs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?degs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map degree <span class="skolem">gs</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> LLL_many_factorization_def Let_def<span class="main">,</span> <span class="operator">folded</span> p_def<span class="main">,</span>
    <span class="operator">unfolded</span> fff split<span class="main">,</span> <span class="operator">folded</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> suitable_prime_bz<span class="main">[</span><span class="operator">OF</span> sff refl<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> prime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="var">?lc</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.square_free_m <span class="skolem">p</span> <span class="free">f</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> res
  <span class="keyword1"><span class="command">from</span></span> prime <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> poly_mod_prime <span class="quoted"><span class="skolem">p</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">f</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">f</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>degree <span class="free">f</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> sqrt_int_ceiling <span class="skolem">K</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> K0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N_def sqrt_int_ceiling <span class="keyword1"><span class="command">using</span></span> K0 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> of_int_nonneg real_sqrt_ge_0_iff zero_le_ceiling<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> find_exponent <span class="skolem">p</span> <span class="skolem">N</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">folded</span> n_def<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> N_def K_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> find_exponent<span class="main">[</span><span class="operator">OF</span> p.m1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">N</span></span></span></span><span class="main">,</span> <span class="operator">folded</span> n_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> bh <span class="main">=</span> p.berlekamp_and_hensel_separated<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> cop sf refl fff n<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> deg <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> n p.m1 <span class="keyword1"><span class="command">have</span></span> pn1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">folded</span> bh<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> p.berlekamp_hensel_unique<span class="main">[</span><span class="operator">OF</span> cop sf bh n<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> p.berlekamp_hensel_main<span class="main">[</span><span class="operator">OF</span> n<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> bh cop sf fff<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> res * **
  <span class="keyword1"><span class="command">have</span></span> uf<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.unique_factorization_m <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">,</span> mset <span class="main">(</span>berlekamp_hensel <span class="skolem">p</span> <span class="skolem">n</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ui</span><span class="main">.</span> <span class="bound">ui</span> <span class="main">∈</span> set <span class="main">(</span>berlekamp_hensel <span class="skolem">p</span> <span class="skolem">n</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> poly_mod.Mp <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">ui</span> <span class="main">=</span> <span class="bound">ui</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> berlekamp_hensel_def fff split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n sqrt_int_ceiling_bound<span class="main">[</span><span class="operator">OF</span> K0<span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> N0 N_def n<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> power2_le_imp_le<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_implementation.LLL_many_reconstruction<span class="main"><span class="main">[</span></span><span class="operator">OF</span> res deg uf dvd_refl norm f0 cop sf pn1 
          refl prime K<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> K_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> one_lattice_LLL_factorization <span class="main">::</span> <span class="quoted">int_poly_factorization_algorithm</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">LLL_factorization</span> <span class="keyword1"><span class="command">using</span></span> LLL_factorization <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> many_lattice_LLL_factorization <span class="main">::</span> <span class="quoted">int_poly_factorization_algorithm</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">LLL_many_factorization</span> <span class="keyword1"><span class="command">using</span></span> LLL_many_factorization <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LLL_Factorization-LLL_factorization_primitive"><span class="command">lemma</span></span> LLL_factorization_primitive<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LLL_factorization <span class="free">f</span> <span class="main">=</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="free">f</span>"</span></span> 
  <span class="quoted"><span class="quoted">"primitive <span class="free">f</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> prod_list <span class="free">fs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">fi</span><span class="main">∈</span>set <span class="free">fs</span><span class="main">.</span> irreducible <span class="bound">fi</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> degree <span class="bound">fi</span> <span class="main">∧</span> primitive <span class="bound">fi</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> int_poly_factorization_algorithm_irreducible<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">one_lattice_LLL_factorization</span></span></span><span class="main"><span class="main">,</span></span> 
      <span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
 
<span class="keyword1"><span class="command">thm</span></span> factorize_int_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">one_lattice_LLL_factorization</span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">thm</span></span> factorize_int_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">many_lattice_LLL_factorization</span></span></span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sub_Sums">
<div class="head">
<h1>Theory Sub_Sums</h1>
</div>
<pre class="source"><span class="comment1">(*
    Author:     René Thiemann
    License:    BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Calculating All Possible Sums of Sub-Multisets›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Sub_Sums
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../../HOL/HOL/Main.html">Main</a> 
    <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sub_mset_sums</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_monoid_add list <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sub_mset_sums</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sub_mset_sums</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">S</span> <span class="main">=</span> <span class="free">sub_mset_sums</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span> <span class="bound">S</span> <span class="main">∪</span> <span class="main">(</span> <span class="main">(+)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Sub_Sums-subset_add_mset"><span class="command">lemma</span></span> subset_add_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">⊆#</span> add_mset <span class="free">x</span> <span class="free">zs</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">ys</span> <span class="main">⊆#</span> <span class="free">zs</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">⊆#</span> <span class="free">zs</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">=</span> add_mset <span class="free">x</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">⊆#</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">⊆#</span> add_mset <span class="free">x</span> <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_remove_trivial diff_subset_eq_self subset_mset.dual_order.trans<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">ys</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span> <span class="main">-</span> <span class="main">{#</span> <span class="free">x</span> <span class="main">#}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> add_mset <span class="free">x</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> l<span class="main">[</span><span class="operator">unfolded</span> ys<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">⊆#</span> <span class="free">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> l <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">⊆#</span> <span class="free">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset.le_iff_sup<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sub_Sums-sub_mset_sums"><span class="command">lemma</span></span> sub_mset_sums<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sub_mset_sums <span class="free">xs</span> <span class="main">=</span> sum_mset <span class="main">`</span> <span class="main">{</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">⊆#</span> mset <span class="free">xs</span> <span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">⊆#</span> mset <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">⊆#</span> mset <span class="skolem">xs</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>add_mset <span class="skolem">x</span> <span class="bound">ys</span> <span class="main">|</span> <span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">⊆#</span> mset <span class="skolem">xs</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> mset.simps subset_add_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sub_mset_sums.simps Let_def Cons id image_Un 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Factorization_Algorithm_16_22">
<div class="head">
<h1>Theory Factorization_Algorithm_16_22</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Jose Divasón
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation and soundness of a modified version of Algorithm 16.22›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Algorithm 16.22 is quite similar to the LLL factorization algorithm that was verified
in the previous section. Its main difference is that it has an inner loop where each inner loop
iteration has one invocation of the LLL basis reduction algorithm. Algorithm 16.22 of the textbook
is therefore closer to the factorization algorithm as it is described by Lenstra, Lenstra, and
Lov{\'a}sz \cite{LLL}, which also uses an inner loop.

The advantage of the inner loop is that it can find factors earlier, 
and then small lattices suffice where without the inner loop one
invokes the basis reduction algorithm on a large lattice. The disadvantage of the inner loop
is that if the input is irreducible, then one cannot find any factor early, so that all but the
last iteration have been useless: only the last iteration will prove irreducibility.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We will describe the modifications w.r.t.\ the original Algorithm 16.22 of the textbook
later in this theory.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Factorization_Algorithm_16_22
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="LLL_Factorization.html">LLL_Factorization</a>
    <a href="Sub_Sums.html">Sub_Sums</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Previous lemmas obtained using local type definitions›</span></span>

<span class="keyword1"><span class="command">context</span></span> poly_mod_prime_type
<span class="keyword2"><span class="keyword">begin</span></span>                           

<span class="keyword1" id="Factorization_Algorithm_16_22-irreducible_m_dvdm_prod_list_connect"><span class="command">lemma</span></span> irreducible_m_dvdm_prod_list_connect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible_m <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvdm</span> <span class="main">(</span>prod_list <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">dvdm</span> <span class="bound">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>of_int_poly <span class="free">a</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> mod_ring poly"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?XS</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">(</span>map of_int_poly <span class="free">xs</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> mod_ring poly list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?XS1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_int_poly <span class="main">(</span>prod_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span> mod_ring poly"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="free">a</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MP_Rel_def Mp_f_representative<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MP_Rel <span class="main">(</span>prod_list <span class="free">xs</span><span class="main">)</span> <span class="var">?XS1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MP_Rel_def Mp_f_representative<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 MP_Rel <span class="free">xs</span> <span class="var">?XS</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MP_Rel_def Mp_f_representative list_all2_conv_all_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">dvd</span> <span class="var">?XS1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="var">?XS</span><span class="main">.</span> <span class="var">?A</span> <span class="keyword1">dvd</span> <span class="bound">b</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> irreducible_dvd_prod_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> irr<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">untransferred</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> poly_mod_prime<span class="main">)</span> irreducible_m_dvdm_prod_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible_m <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvdm</span> <span class="main">(</span>prod_list <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">dvdm</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_mod_prime_type.irreducible_m_dvdm_prod_list_connect<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> poly_mod_type_simps<span class="main"><span class="main">,</span></span> 
        <span class="operator">internalize_sort</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> prime_card"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> type_to_set<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> remove_duplicate_premise<span class="main"><span class="main">,</span></span> 
        <span class="operator">cancel_type_definition</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> non_empty irr dvd<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The modified version of Algorithm 16.22›</span></span>

    <span class="comment1">(* Implementation of the for loop of step 8. The loop will finishes in two cases:
      - If j&gt;n'
      - If a divisor is found *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">B2_LLL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">B2_LLL</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> factors
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> factors
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> factor
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> factor

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly list"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Degs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the critical inner loop.

  In the textbook there is a bug, namely that the filter
  is applied to $g'$ and not to the primitive part of $g'$. (Problems occur if the content
  of $g'$ is divisible by $p$.) We have fixed this problem in the obvious way.

  However, there also is a second problem,
  namely it is only guaranteed that $g'$ is divisible by $u$ modulo $p^l$. However, for soundness
  we need to know that then also the primitive part of $g'$ is divisible by $u$ modulo $p^l$. 
  This is not necessary true, e.g., if $g' = p^l$, then the primitive part is $1$ which is not
  divisible by $u$ modulo $p^l$. 
  It is open, whether such a large $g'$ can actually occur. Therefore, the current fix
  is to manually test whether the leading coefficient of $g'$ is strictly smaller than $p^l$.

  With these two modifications, Algorithm 16.22 will become sound as proven below.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">LLL_reconstruction_inner</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">j'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">in</span>
  <span class="comment1">― ‹optimization: check whether degree j' is possible›</span>
  <span class="keyword1">if</span> <span class="bound">j'</span> <span class="main">∉</span> <span class="free">Degs</span> <span class="keyword1">then</span> None <span class="keyword1">else</span>
  <span class="comment1">― ‹short vector computation›</span>
  <span class="keyword1">let</span> 
      <span class="bound">ll</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> sqrt_int_ceiling <span class="main">(</span><span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="bound">j'</span> <span class="main">*</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
      <span class="bound">ll'</span> <span class="main">=</span> find_exponent <span class="free">p</span> <span class="bound">n</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">ll'</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="keyword1">then</span> <span class="bound">ll'</span> <span class="keyword1">else</span> <span class="free">l</span><span class="main">)</span><span class="main">;</span>
  <span class="comment1">― ‹optimization: dynamically adjust the modulus›</span>
      <span class="bound">pl</span> <span class="main">=</span> <span class="free">p</span><span class="main">^</span><span class="bound">ll</span><span class="main">;</span>
      <span class="bound">g'</span> <span class="main">=</span> LLL_short_polynomial <span class="bound">pl</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free">u</span> 
  <span class="comment1">― ‹fix: forbid multiples of $p^l$ as short vector, unclear whether this is really required›</span>
  <span class="keyword1">in</span> <span class="keyword1">if</span> abs <span class="main">(</span>lead_coeff <span class="bound">g'</span><span class="main">)</span> <span class="main">≥</span> <span class="bound">pl</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> 
  <span class="keyword1">let</span> <span class="bound">ppg</span> <span class="main">=</span> primitive_part <span class="bound">g'</span>
  <span class="keyword1">in</span>
  <span class="comment1">― ‹slight deviation from textbook: we check divisibility instead of norm-inequality›</span>
  <span class="keyword1">case</span> div_int_poly <span class="free">f</span> <span class="bound">ppg</span> <span class="keyword1">of</span> Some <span class="bound">f'</span> <span class="main">⇒</span>
    <span class="comment1">― ‹fix: consider modular factors of ppg and not of g'›</span>
    Some <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">gi</span><span class="main">.</span> <span class="main">¬</span> poly_mod.dvdm <span class="free">p</span> <span class="bound">gi</span> <span class="bound">ppg</span><span class="main">)</span> <span class="free">gs</span><span class="main">,</span> lead_coeff <span class="bound">f'</span><span class="main">,</span> <span class="bound">f'</span><span class="main">,</span> <span class="bound">ppg</span><span class="main">)</span>  
  <span class="main">|</span> None <span class="main">⇒</span> None"</span></span>


<span class="keyword1"><span class="command">function</span></span> <span class="entity">LLL_reconstruction_inner_loop</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">LLL_reconstruction_inner_loop</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&gt;</span> degree <span class="free">f</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="keyword1">case</span> LLL_reconstruction_inner <span class="free"><span class="bound"><span class="entity">j</span></span></span>
     <span class="keyword1">of</span> Some <span class="bound">tuple</span> <span class="main">⇒</span> <span class="bound">tuple</span>
     <span class="main">|</span>  None <span class="main">⇒</span> <span class="free">LLL_reconstruction_inner_loop</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> Suc <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span> <span class="main">-</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*The main loop (line 6)*)</span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">LLL_reconstruction''</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">LLL_reconstruction''</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">factors</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">factors</span></span></span>
   <span class="keyword1">else</span>
     <span class="keyword1">let</span> <span class="bound">u</span> <span class="main">=</span> choose_u <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">;</span>
         <span class="bound">d</span> <span class="main">=</span> degree <span class="bound">u</span><span class="main">;</span>
         <span class="bound">gs'</span> <span class="main">=</span> remove1 <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">;</span>
         <span class="bound">degs</span> <span class="main">=</span> map degree <span class="bound">gs'</span><span class="main">;</span>
         <span class="bound">Degs</span> <span class="main">=</span> <span class="main">(</span><span class="main">(+)</span> <span class="bound">d</span><span class="main">)</span> <span class="main">`</span> sub_mset_sums <span class="bound">degs</span><span class="main">;</span>
         <span class="main">(</span><span class="bound">gs'</span><span class="main">,</span> <span class="bound">b'</span><span class="main">,</span> <span class="bound">f'</span><span class="main">,</span> <span class="bound">factor</span><span class="main">)</span> <span class="main">=</span> LLL_reconstruction_inner_loop <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">u</span> <span class="bound">Degs</span> <span class="main">(</span><span class="bound">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="free">LLL_reconstruction''</span> <span class="bound">gs'</span> <span class="bound">b'</span> <span class="bound">f'</span> <span class="main">(</span><span class="bound">factor</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">factors</span></span></span><span class="main">)</span>
   <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">reconstruction_of_algorithm_16_22</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">G</span> <span class="main">=</span> <span class="main">[]</span><span class="main">;</span>
      <span class="bound">b</span> <span class="main">=</span> lead_coeff <span class="free"><span class="bound"><span class="entity">f</span></span></span>
  <span class="keyword1">in</span> LLL_reconstruction'' <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">G</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">factorization_algorithm_16_22</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">factorization_algorithm_16_22</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> 
     <span class="comment1">― ‹find suitable prime›</span>
     <span class="bound">p</span> <span class="main">=</span> suitable_prime_bz <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="comment1">― ‹compute finite field factorization›</span>
     <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">fs</span><span class="main">)</span> <span class="main">=</span> finite_field_factorization_int <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="comment1">― ‹determine l and B›</span>
     <span class="bound">n</span> <span class="main">=</span> degree <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
     <span class="comment1">― ‹bound improved according to textbook, which uses $no = (n + 1) * (max-norm f)^2$›</span>
     <span class="bound">no</span> <span class="main">=</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">;</span>
     <span class="comment1">― ‹possible improvement: $B = sqrt (2 ^{5 * n * (n - 1)} * no ^ {2 * n - 1}$, cf. <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> LLL_factorization<span class="antiquote">}</span></span>›</span>
     <span class="bound">B</span> <span class="main">=</span> sqrt_int_ceiling <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="bound">n</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="bound">no</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="bound">l</span> <span class="main">=</span> find_exponent <span class="bound">p</span> <span class="bound">B</span><span class="main">;</span>
     <span class="comment1">― ‹perform hensel lifting to lift factorization to mod $p^l$›</span>
     <span class="bound">vs</span> <span class="main">=</span> hensel_lifting <span class="bound">p</span> <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">fs</span>
     <span class="comment1">― ‹reconstruct integer factors›</span>
   <span class="keyword1">in</span> reconstruction_of_algorithm_16_22 <span class="bound">p</span> <span class="bound">l</span> <span class="bound">vs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness proof›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Starting the proof›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Key lemma to show that forbidding values of $p^l$ or larger suffices to find correct factors.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> poly_mod_prime<span class="main">)</span> Mp_smult_p_removal<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.Mp <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>smult <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> poly_mod.Mp <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">k</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.left_neutral m1 poly_mod.Dp_Mp_eq poly_mod.Mp_smult_m_0 sdiv_poly_smult smult_smult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> poly_mod_prime<span class="main">)</span> eq_m_smult_p_removal<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.eq_m <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>smult <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>smult <span class="free">p</span> <span class="free">g</span><span class="main">)</span> 
  <span class="main">⟹</span> poly_mod.eq_m <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">k</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Mp_smult_p_removal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-</span> <span class="free">g</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' diff_add_cancel diff_self poly_mod.Mp_0 poly_mod.minus_Mp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> smult_diff_right<span class="main">)</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-content_le_lead_coeff"><span class="command">lemma</span></span> content_le_lead_coeff<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>content <span class="main">(</span><span class="free">f</span> <span class="main">::</span> int poly<span class="main">)</span><span class="main">)</span> <span class="main">≤</span> abs <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> content_dvd_coeff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>content <span class="free">f</span><span class="main">)</span> <span class="keyword1">dvd</span> abs <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dvd_imp_le_int<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-poly_mod_dvd_drop_smult"><span class="command">lemma</span></span> poly_mod_dvd_drop_smult<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">c</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">^</span><span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.dvdm <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">l</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>smult <span class="free">c</span> <span class="free">f</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly_mod.dvdm <span class="free">p</span> <span class="free">u</span> <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> c dvd
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">l</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> poly_mod_prime <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> c <span class="main">=</span> less<span class="main">(</span>2-3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> dvd <span class="main">=</span> less<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> less<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> l0<span class="main">:</span> False
    <span class="keyword1"><span class="command">interpret</span></span> pl<span class="main">:</span> poly_mod_2 <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> m1 l0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">c</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inverse_mod <span class="skolem">c</span> <span class="main">(</span><span class="free">p</span> <span class="main">^</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">c</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Primes.prime_int_iff gcd_ge_0_int semiring_gcd_class.gcd_dvd1 semiring_gcd_class.gcd_dvd2<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">c</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_refl gcd_dvd_1<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> pl.inverse_mod_coprime_exp<span class="main">[</span><span class="operator">OF</span> refl p l0 this<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.M <span class="main">(</span><span class="var">?i</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.Mp <span class="main">(</span>smult <span class="var">?i</span> <span class="main">(</span>smult <span class="skolem">c</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pl.Mp <span class="main">(</span>smult <span class="main">(</span>pl.M <span class="main">(</span><span class="var">?i</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pl.Mp <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">u</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pl.dvdm_smult<span class="main">[</span><span class="operator">OF</span> dvd<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pl.dvdm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">dvdm</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l0 pl_dvdm_imp_p_dvdm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> cpd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> cpd c <span class="keyword1"><span class="command">have</span></span> d0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> to_p <span class="main">=</span> Mp_Mp_pow_is_Mp<span class="main">[</span><span class="operator">OF</span> l0 m1<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.eq_m <span class="main">(</span><span class="free">u</span> <span class="main">*</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>smult <span class="free">p</span> <span class="main">(</span>smult <span class="skolem">d</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> pl.dvdm_def cpd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">Mp</span><span class="main">,</span> <span class="operator">unfolded</span> to_p<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mp <span class="main">(</span><span class="free">u</span> <span class="main">*</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Mp_smult_m_0 <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mp <span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mp_0 add_eq_0_iff_both_eq_0 degree_0 
            degree_m_mult_eq monic_degree_0 monic_degree_m mult_cancel_right2<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Mp_0_smult_sdiv_poly<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> smult <span class="free">p</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.eq_m <span class="main">(</span>smult <span class="free">p</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smult <span class="free">p</span> <span class="main">(</span>smult <span class="skolem">d</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> l0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ll</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> Suc <span class="skolem">ll</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> pl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="skolem">l</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="free">p</span><span class="main">^</span><span class="skolem">ll</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ll</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> c<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> d_small<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">d</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">^</span><span class="skolem">ll</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pl cpd abs_mult
        <span class="keyword1"><span class="command">using</span></span> mult_less_cancel_left_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="skolem">ll</span>"</span></span><span class="main">]</span> m1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> eq_m_smult_p_removal<span class="main">[</span><span class="operator">OF</span> eq<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> pl<span class="main"><span class="main">]</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly_mod.eq_m <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="skolem">ll</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">*</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span>smult <span class="skolem">d</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">hence</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.dvdm <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="skolem">ll</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>smult <span class="skolem">d</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> poly_mod.dvdm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ll d0 d_small dvd<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">int</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> degree <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bound_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">N</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> B2_LLL <span class="free">F</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-F0"><span class="command">lemma</span></span> F0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> N0 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-p1"><span class="command">lemma</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p prime_gt_1_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> p<span class="main">:</span> poly_mod_prime <span class="quoted"><span class="free">p</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">interpretation</span></span> pl<span class="main">:</span> poly_mod <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="free">l</span>"</span></span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-B2_2"><span class="command">lemma</span></span> B2_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> B2_LLL <span class="free">F</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> F0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> F1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span> F0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">1</span> <span class="main">*</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> B2_LLL <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B2_LLL_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono power_increasing F1<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> N0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> B2_LLL <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-l_gt_0"><span class="command">lemma</span></span> l_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">N</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> B2_LLL <span class="free">F</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">N</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> N0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">N</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> B2_LLL <span class="free">F</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> power_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B2_2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> B2_LLL <span class="free">F</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bound_l<span class="main">[</span><span class="operator">unfolded</span> 0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-l0"><span class="command">lemma</span></span> l0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-pl_not0"><span class="command">lemma</span></span> pl_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">^</span> <span class="free">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p1 l0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> pl<span class="main">:</span> poly_mod_2 <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="free">l</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> p1 l0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> pl_dvdm_imp_p_dvdm <span class="main">=</span> p.pl_dvdm_imp_p_dvdm<span class="main">[</span><span class="operator">OF</span> l0<span class="main">]</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-p_Mp_pl_Mp"><span class="command">lemma</span></span> p_Mp_pl_Mp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"p.Mp <span class="main">(</span>pl.Mp <span class="free">k</span><span class="main">)</span> <span class="main">=</span> p.Mp <span class="free">k</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Mp_Mp_pow_is_Mp<span class="main">[</span><span class="operator">OF</span> l0 p.m1<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">gs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly list"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Degs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≡</span> degree <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> irred_u<span class="main">:</span> <span class="quoted"><span class="quoted">"p.irreducible_m <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> u_f<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f_dvd_F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">==</span> degree <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="free">f</span> <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">,</span> mset <span class="free">gs</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"p.square_free_m <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sf_F<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> u_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="free">gs</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> norm_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"map pl.Mp <span class="free">gs</span> <span class="main">=</span> <span class="free">gs</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> Degs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">factor</span><span class="main">.</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> degree <span class="bound">factor</span> <span class="main">∈</span> <span class="free">Degs</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> pl<span class="main">:</span> poly_mod_2 <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l0 p1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-f0"><span class="command">lemma</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sf_F <span class="keyword1"><span class="command">unfolding</span></span> square_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-Mpf0"><span class="command">lemma</span></span> Mpf0<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> p.square_free_m_def p_Mp_pl_Mp sf<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-pMpf0"><span class="command">lemma</span></span> pMpf0<span class="main">:</span> <span class="quoted"><span class="quoted">"p.Mp <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p.square_free_m_def sf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-dn"><span class="command">lemma</span></span> dn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p.dvdm_imp_degree_le<span class="main">[</span><span class="operator">OF</span> u_f u pMpf0 p1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-n0"><span class="command">lemma</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d0 dn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-B2_0"><span class="command">lemma</span></span> B2_0<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"B2_LLL <span class="free">F</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B2_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-deg_u"><span class="command">lemma</span></span> deg_u<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d0 d_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-n_le_N"><span class="command">lemma</span></span> n_le_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≤</span><span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_imp_degree_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f_dvd_F F0<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-dvdm_power"><span class="command">lemma</span></span> dvdm_power<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">g</span> <span class="main">⟷</span> pl.dvdm <span class="free">u</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">u</span> <span class="free">g</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pl_dvdm_imp_p_dvdm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> norm_gs <span class="keyword1"><span class="command">have</span></span> norm_gsp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="free">gs</span> <span class="main">⟹</span> pl.Mp <span class="bound">f</span> <span class="main">=</span> <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">gs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f_gs<span class="main">[</span><span class="operator">unfolded</span> pl.unique_factorization_m_alt_def pl.factorization_m_def split<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> gs_irred_mon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈#</span> mset <span class="free">gs</span> <span class="main">⟹</span> pl.irreducible<span class="hidden">⇩</span><sub>d</sub>_m <span class="bound">f</span> <span class="main">∧</span> monic <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
  <span class="keyword1"><span class="command">from</span></span> norm_gs <span class="keyword1"><span class="command">have</span></span> norm_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset pl.Mp <span class="main">(</span>mset <span class="free">gs</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">gs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pl.unique_factorization_m_factor<span class="main">[</span><span class="operator">OF</span> p.prime f_gs<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> f<span class="main"><span class="main">]</span></span> _ _ l0 refl<span class="main">,</span> <span class="operator">folded</span> f<span class="main">,</span> 
      <span class="operator">OF</span> cop sf<span class="main">,</span> <span class="operator">unfolded</span> pl.Mf_def split<span class="main">]</span> norm_gs
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hs</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> uf<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">h</span> <span class="main">(</span>lead_coeff <span class="skolem">h</span><span class="main">,</span> <span class="skolem">hs</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="free">g</span> <span class="main">(</span>lead_coeff <span class="free">g</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">gs</span> <span class="main">=</span> <span class="skolem">fs</span> <span class="main">+</span> <span class="skolem">hs</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset pl.Mp <span class="skolem">fs</span> <span class="main">=</span> <span class="skolem">fs</span>"</span></span> <span class="quoted"><span class="quoted">"image_mset pl.Mp <span class="skolem">hs</span> <span class="main">=</span> <span class="skolem">hs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> p.square_free_m_prod_imp_coprime_m<span class="main">[</span><span class="operator">OF</span> sf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> f<span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> cop_h_f<span class="main">:</span> <span class="quoted"><span class="quoted">"p.coprime_m <span class="free">g</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">u</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈#</span> <span class="skolem">fs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pl.Mp <span class="free">u</span> <span class="main">∈#</span> image_mset pl.Mp <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> pl.factorization_m_mem_dvdm<span class="main">[</span><span class="operator">OF</span> pl.unique_factorization_m_imp_factorization<span class="main"><span class="main">[</span></span><span class="operator">OF</span> uf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> u_gs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈#</span> mset <span class="free">gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> id<span class="main">]</span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈#</span> <span class="skolem">hs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pl.Mp <span class="free">u</span> <span class="main">∈#</span> image_mset pl.Mp <span class="skolem">hs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> pl.factorization_m_mem_dvdm<span class="main">[</span><span class="operator">OF</span> pl.unique_factorization_m_imp_factorization<span class="main"><span class="main">[</span></span><span class="operator">OF</span> uf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">u</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> pl_dvdm_imp_p_dvdm<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> cop_h_f<span class="main">[</span><span class="operator">unfolded</span> p.coprime_m_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> dvd this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> p.dvdm_imp_degree_le<span class="main">[</span><span class="operator">OF</span> this u _ p.m1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> deg_u <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-uf"><span class="command">lemma</span></span> uf<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">u</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvdm_power<span class="main">[</span><span class="operator">OF</span> dvd_refl<span class="main">]</span> u_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-exists_reconstruction"><span class="command">lemma</span></span> exists_reconstruction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h0</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">h0</span> <span class="main">∧</span> p.dvdm <span class="free">u</span> <span class="bound">h0</span> <span class="main">∧</span> <span class="bound">h0</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>   
  <span class="keyword1"><span class="command">have</span></span> deg_f<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≡</span> degree <span class="free">f</span>›</span></span> n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> berlekamp_zassenhaus_factorization_irreducible<span class="hidden">⇩</span><sub>d</sub><span class="main">[</span><span class="operator">OF</span> refl sf_F deg_f<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> prod_list <span class="skolem">fs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">fi</span><span class="main">∈</span>set <span class="skolem">fs</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">fi</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> degree <span class="bound">fi</span> <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">u</span> <span class="main">(</span>prod_list <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> uf f_fs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="main">(</span>prod_list <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pl_dvdm_imp_p_dvdm<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h0</span></span> <span class="keyword2"><span class="keyword">where</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h0</span> <span class="main">∈</span> set <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvdm_u_h0<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="skolem">h0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> p.irreducible_m_dvdm_prod_list<span class="main">[</span><span class="operator">OF</span> irred_u<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h0</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> f_fs<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prod_list_dvd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> h0<span class="main"><span class="main">]</span></span><span class="main">)</span>  
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">h0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c h0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-factor_dvd_f_0"><span class="command">lemma</span></span> factor_dvd_f_0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pl.Mp <span class="free">factor</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">factor</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">pl.Mp</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> pl.Mp <span class="main">(</span>pl.Mp <span class="free">factor</span> <span class="main">*</span> <span class="skolem">h</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Mpf0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-degree_factor_ge_degree_u"><span class="command">lemma</span></span> degree_factor_ge_degree_u<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u_dvdm_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">factor</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> factor_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≤</span> degree <span class="free">factor</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> factor_dvd_f_0<span class="main">[</span><span class="operator">OF</span> factor_dvd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> factor0<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="free">factor</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>  
  <span class="keyword1"><span class="command">from</span></span> u_dvdm_factor<span class="main">[</span><span class="operator">unfolded</span> dvdm_power<span class="main"><span class="main">[</span></span><span class="operator">OF</span> factor_dvd<span class="main"><span class="main">]</span></span> pl.dvdm_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    *<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="free">factor</span> <span class="main">=</span> pl.Mp <span class="main">(</span><span class="free">u</span> <span class="main">*</span> pl.Mp <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> factor0 <span class="keyword1"><span class="command">have</span></span> v0<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> lead_coeff <span class="main">(</span>pl.Mp <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lead_coeff <span class="main">(</span>pl.Mp <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> pl.M <span class="main">(</span>lead_coeff <span class="main">(</span>pl.Mp <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pl.Mp_def coeff_map_poly<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"lead_coeff <span class="main">(</span>pl.Mp <span class="skolem">v</span><span class="main">)</span> <span class="main">≠</span> <span class="free">p</span> <span class="main">^</span> <span class="free">l</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pl.M_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">factor</span> <span class="main">≥</span> pl.degree_m <span class="main">(</span><span class="free">u</span> <span class="main">*</span> pl.Mp <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pl.degree_m_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">factor</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.degree_m <span class="main">(</span><span class="free">u</span> <span class="main">*</span> pl.Mp <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> degree <span class="main">(</span><span class="free">u</span> <span class="main">*</span> pl.Mp <span class="skolem">v</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pl.degree_m_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> lead_coeff_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> u pl.m1 **<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> degree <span class="free">u</span> <span class="main">+</span> degree <span class="main">(</span>pl.Mp <span class="skolem">v</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> v0 u<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Inner loop›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">j'</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dj'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> j'n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> degree <span class="bound">factor</span> <span class="main">≥</span> <span class="free">j'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≡</span> Suc <span class="free">j'</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-jn"><span class="command">lemma</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"j <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j'n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Factorization_Algorithm_16_22-factor_irreducible"><span class="command">lemma</span></span> factor_irreducible<span class="hidden">⇩</span><sub>d</sub>I<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> puh<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">h</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> degh<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">h</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> degh_j<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">h</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">h</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> dvdm_power<span class="main">[</span><span class="operator">OF</span> hf<span class="main">]</span> puh <span class="keyword1"><span class="command">have</span></span> pluh<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">u</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> uf_partition <span class="main">=</span> p.unique_factorization_m_factor_partition<span class="main">[</span><span class="operator">OF</span> l0<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gs1</span></span> <span class="skolem"><span class="skolem">gs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"List.partition <span class="main">(</span><span class="main">λ</span><span class="bound">gi</span><span class="main">.</span> p.dvdm <span class="bound">gi</span> <span class="free">h</span><span class="main">)</span> <span class="free">gs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">gs1</span><span class="main">,</span> <span class="skolem">gs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> part u_gs puh 
  <span class="keyword1"><span class="command">have</span></span> u_gs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> set <span class="skolem">gs1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> gs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gs1</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">gi</span><span class="main">.</span> p.dvdm <span class="bound">gi</span> <span class="free">h</span><span class="main">)</span> <span class="free">gs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> part <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">h</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hf <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> uf_partition<span class="main">[</span><span class="operator">OF</span> f_gs f cop sf part<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> uf_h<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="free">h</span> <span class="main">(</span>lead_coeff <span class="free">h</span><span class="main">,</span> mset <span class="skolem">gs1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> irreducible<span class="hidden">⇩</span><sub>d</sub>I degh<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> deg_q<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&lt;</span> degree <span class="free">h</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> deg_r<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">r</span> <span class="main">&lt;</span> degree <span class="free">h</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">dvd</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> h dvd_trans<span class="main">[</span><span class="operator">OF</span> _ hf<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> cop<span class="main">[</span><span class="operator">unfolded</span> f<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="free">h</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p.prime pl.coprime_lead_coeff_factor<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> sf<span class="main">[</span><span class="operator">unfolded</span> f<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"p.square_free_m <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p.square_free_m_factor <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> norm_gs1<span class="main">:</span> <span class="quoted"><span class="quoted">"image_mset pl.Mp <span class="main">(</span>mset <span class="skolem">gs1</span><span class="main">)</span> <span class="main">=</span> mset <span class="skolem">gs1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm_gs <span class="keyword1"><span class="command">unfolding</span></span> gs1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">gs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> pl.unique_factorization_m_factor<span class="main">[</span><span class="operator">OF</span> p uf_h<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> h<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> h<span class="main">,</span> <span class="operator">OF</span> cop sf l0 refl<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="skolem"><span class="skolem">gs</span></span> <span class="keyword2"><span class="keyword">where</span></span> uf_q<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">q</span> <span class="main">(</span>lead_coeff <span class="skolem">q</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> uf_r<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">r</span> <span class="main">(</span>lead_coeff <span class="skolem">r</span><span class="main">,</span> <span class="skolem">gs</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">gs1</span> <span class="main">=</span> <span class="skolem">fs</span> <span class="main">+</span> <span class="skolem">gs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pl.Mf_def split <span class="keyword1"><span class="command">using</span></span> norm_gs1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> degh degh_j deg_q deg_r <span class="keyword1"><span class="command">have</span></span> qj'<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&lt;</span> <span class="free">j'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rj'<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈#</span> <span class="skolem">r</span> <span class="main">⟹</span> pl.Mp <span class="free">u</span> <span class="main">∈#</span> image_mset pl.Mp <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">note</span></span> dvdI <span class="main">=</span> pl.factorization_m_mem_dvdm<span class="main">[</span><span class="operator">OF</span> pl.unique_factorization_m_imp_factorization intro<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> u_gs1 id <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈#</span> <span class="skolem">fs</span> <span class="main">∨</span> <span class="free">u</span> <span class="main">∈#</span> <span class="skolem">gs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> in_multiset_in_set<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> dvdI<span class="main">[</span><span class="operator">OF</span> uf_q<span class="main">]</span> dvdI<span class="main">[</span><span class="operator">OF</span> uf_r<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">u</span> <span class="skolem">q</span> <span class="main">∨</span> pl.dvdm <span class="free">u</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="skolem">q</span> <span class="main">∨</span> p.dvdm <span class="free">u</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pl_dvdm_imp_p_dvdm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> 1 qj' rj' <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> deg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ll</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> sqrt_int_ceiling <span class="main">(</span><span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
    <span class="bound">ll'</span> <span class="main">=</span> find_exponent <span class="free">p</span> <span class="bound">n</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">ll'</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="keyword1">then</span> <span class="bound">ll'</span> <span class="keyword1">else</span> <span class="free">l</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Factorization_Algorithm_16_22-ll"><span class="command">lemma</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">"ll <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ll_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-ll0"><span class="command">lemma</span></span> ll0<span class="main">:</span> <span class="quoted"><span class="quoted">"ll <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l0 find_exponent<span class="main">[</span><span class="operator">OF</span> p.m1<span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> ll_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-pll1"><span class="command">lemma</span></span> pll1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span>ll <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ll0 p.m1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> pll<span class="main">:</span> poly_mod_2 <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span>ll"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> ll0 p.m1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1" id="Factorization_Algorithm_16_22-pll0"><span class="command">lemma</span></span> pll0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span>ll <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-dvdm_l_ll"><span class="command">lemma</span></span> dvdm_l_ll<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pll.dvdm <span class="free">a</span> <span class="free">b</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="free">l</span> <span class="main">=</span> <span class="free">p</span><span class="main">^</span>ll <span class="main">*</span> <span class="free">p</span> <span class="main">^</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> ll<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ll <span class="keyword1"><span class="command">unfolding</span></span> power_add<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> pl.dvdm_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.eq_m <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> pll.Mp_shrink_modulus<span class="main">[</span><span class="operator">OF</span> eq<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id<span class="main"><span class="main">]</span></span><span class="main">]</span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pll.eq_m <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pll.dvdm_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> LLL_short_polynomial <span class="main">(</span><span class="free">p</span><span class="main">^</span>ll<span class="main">)</span> j <span class="free">u</span>"</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-deg_g_j"><span class="command">lemma</span></span> deg_g_j<span class="main">:</span> <span class="quoted"><span class="quoted">"degree g <span class="main">&lt;</span> j"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"g <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ug <span class="main">:</span><span class="quoted"><span class="quoted">"pll.dvdm <span class="free">u</span> g"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> short_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> pll.dvdm <span class="free">u</span> <span class="free">h</span> <span class="main">⟹</span> degree <span class="free">h</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟹</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">j'</span> <span class="main">*</span> <span class="main">∥</span><span class="free">h</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">from</span></span> deg_u <span class="keyword1"><span class="command">have</span></span> degu0<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ju<span class="main">:</span> <span class="quoted"><span class="quoted">"j <span class="main">≥</span> degree <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d_def dj' le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> ju'<span class="main">:</span> <span class="quoted"><span class="quoted">"j <span class="main">&gt;</span> degree <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d_def dj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">note</span></span> short <span class="main">=</span> LLL_short_polynomial<span class="main">[</span><span class="operator">OF</span> degu0 ju pll1 u<span class="main">,</span> <span class="operator">folded</span> g_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> short<span class="main">(</span>1-3<span class="main">)</span> short<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ju'<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-LLL_reconstruction_inner_simps"><span class="command">lemma</span></span> LLL_reconstruction_inner_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> j
  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j'</span> <span class="main">∉</span> <span class="free">Degs</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">p</span> <span class="main">^</span> ll <span class="main">≤</span> <span class="main">¦</span>lead_coeff g<span class="main">¦</span> <span class="keyword1">then</span> None
   <span class="keyword1">else</span> <span class="keyword1">case</span> div_int_poly <span class="free">f</span> <span class="main">(</span>primitive_part g<span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
        <span class="main">|</span> Some <span class="bound">f'</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="main">[</span><span class="bound">gi</span><span class="main">←</span><span class="free">gs</span> <span class="main">.</span> <span class="main">¬</span> p.dvdm <span class="bound">gi</span> <span class="main">(</span>primitive_part g<span class="main">)</span><span class="main">]</span><span class="main">,</span> lead_coeff <span class="bound">f'</span><span class="main">,</span> <span class="bound">f'</span><span class="main">,</span> primitive_part g<span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">j'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> LLL_reconstruction_inner_def Suc Let_def ll_def<span class="main">[</span><span class="operator">unfolded</span> Let_def<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
     g_def<span class="main">[</span><span class="operator">unfolded</span> Let_def<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Factorization_Algorithm_16_22-LLL_reconstruction_inner_complete"><span class="command">lemma</span></span> LLL_reconstruction_inner_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> j <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> degree <span class="bound">factor</span> <span class="main">≥</span> j"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">factor</span>
  <span class="keyword3"><span class="command">assume</span></span> pu_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="skolem">factor</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> factor_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> deg_factor2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> j <span class="main">≤</span> degree <span class="skolem">factor</span>"</span></span> 
  <span class="keyword1"><span class="command">with</span></span> deg<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> deg_factor_j <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">factor</span> <span class="main">=</span> <span class="free">j'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg_factor_lt_j<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">factor</span> <span class="main">&lt;</span> j"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Degs<span class="main">[</span><span class="operator">OF</span> factor_f pu_factor<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> Degs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">j'</span> <span class="main">∉</span> <span class="free">Degs</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvdm_power<span class="main">[</span><span class="operator">OF</span> factor_f<span class="main">]</span> pu_factor <span class="keyword1"><span class="command">have</span></span> u_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">u</span> <span class="skolem">factor</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">from</span></span> dvdm_l_ll<span class="main">[</span><span class="operator">OF</span> u_factor<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> pll_u_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"pll.dvdm <span class="free">u</span> <span class="skolem">factor</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> deg_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">factor</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d0 deg_factor_j dj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> 
  <span class="keyword1"><span class="command">from</span></span> f0 deg_factor divides_degree<span class="main">[</span><span class="operator">OF</span> factor_f<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> deg_f<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> deg_factor <span class="keyword1"><span class="command">have</span></span> j'0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> factor_f f0 <span class="keyword1"><span class="command">have</span></span> factor0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">factor</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> factor_f <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">factor</span> <span class="main">*</span> <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> deg_u <span class="keyword1"><span class="command">have</span></span> deg_u0<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pu_factor u <span class="keyword1"><span class="command">have</span></span> u_j'<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> deg_factor_j<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> d_def deg_factor_j dj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> u_j<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≤</span> j"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">&lt;</span> j"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> LLL <span class="main">=</span> LLL_short_polynomial<span class="main">[</span><span class="operator">OF</span> deg_u0 u_j<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span> pll1 u<span class="main">,</span> <span class="operator">folded</span> g_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ret <span class="main">=</span> ret<span class="main">[</span><span class="operator">unfolded</span> LLL_reconstruction_inner_simps Degs if_False<span class="main">]</span>   
  <span class="keyword1"><span class="command">note</span></span> LLL <span class="main">=</span> LLL<span class="main">(</span>1-3<span class="main">)</span> LLL<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> u_j<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> factor0 pll_u_factor deg_factor_lt_j<span class="main">]</span>
  <span class="keyword1"><span class="command">hence</span></span> deg_g<span class="main">:</span> <span class="quoted"><span class="quoted">"degree g <span class="main">≤</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> LLL<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> normg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted">g</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">from</span></span> f0 <span class="keyword1"><span class="command">have</span></span> normf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">from</span></span> factor0 <span class="keyword1"><span class="command">have</span></span> normf1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">factor</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">from</span></span> F0 <span class="keyword1"><span class="command">have</span></span> normF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_norm_poly_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">from</span></span> factor_f <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="keyword1">dvd</span> <span class="free">F</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> factor_F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">factor</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree g <span class="main">*</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">factor</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="free">j'</span> <span class="main">*</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="free">j'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> power_increasing<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> normg normf1 deg_g<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">^</span><span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">j'</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="free">j'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> power_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_left_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> LLL<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> power_mult_distrib power_mult power_add mult_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> approx_part_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree g <span class="main">*</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">factor</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">factor</span> <span class="keyword1">dvd</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">note</span></span> approx_part_1
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="skolem">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> power_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sq_norm_factor_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∥</span><span class="skolem">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">j'</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">*</span><span class="free">j'</span> <span class="main">+</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> power_mult_distrib power_add <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">j'</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">*</span><span class="free">j'</span> <span class="main">+</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">=</span> <span class="numeral">5</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree g <span class="main">*</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">factor</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> approx <span class="main">=</span> this
  <span class="keyword1"><span class="command">note</span></span> approx_1 <span class="main">=</span> approx<span class="main">[</span><span class="operator">OF</span> factor_f f0<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> approx_2_part <span class="main">=</span> approx<span class="main">[</span><span class="operator">OF</span> factor_F F0<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> large<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree g <span class="main">*</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">factor</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span>ll<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ll <span class="main">=</span> <span class="free">l</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sqrt_int_ceiling <span class="var">?n</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ll <span class="main">=</span> find_exponent <span class="free">p</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ll_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> spll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">^</span>ll"</span></span> <span class="keyword1"><span class="command">using</span></span> find_exponent<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> p.m1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="var">?n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt <span class="var">?n</span> <span class="main">&gt;</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>    
    <span class="keyword1"><span class="command">have</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="var">?s</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sqrt_int_ceiling_bound<span class="main">[</span><span class="operator">OF</span> n<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span>ll<span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> power_strict_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> spll<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sqrt<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> approx_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> ll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span>ll <span class="main">=</span> <span class="free">p</span><span class="main">^</span><span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ll
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less_le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_less_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> approx_2_part<span class="main"><span class="main">]</span></span> bound_l<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> 
          <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="free">j'</span> <span class="main">+</span> <span class="free">j'</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> mult_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">N</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">N</span><span class="main">*</span><span class="free">N</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_less_le_imp_less<span class="main"><span class="main">[</span></span><span class="operator">OF</span> power_strict_increasing pow_mono_exp<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normF<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> jN'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">≤</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jn divides_degree<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="keyword1">dvd</span> <span class="free">F</span>›</span></span><span class="main">]</span> F0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">+</span> <span class="free">j'</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">+</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deg_g j'n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">+</span> <span class="free">j'</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="free">j'</span> <span class="main">+</span> <span class="free">j'</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zero_less_power<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> normF<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">5</span> <span class="main">*</span> <span class="main">(</span><span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">5</span> <span class="main">*</span> <span class="main">(</span><span class="free">N</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_strict_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_strict_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> jN'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">N</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">N</span> <span class="main">*</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span> 
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">&lt;</span> <span class="free">N</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">N</span> <span class="main">*</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">N</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span> <span class="main">*</span> <span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> power_mult_distrib power_add <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">F</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="free">j'</span> <span class="main">*</span> <span class="free">j'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">N</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> B2_LLL <span class="free">F</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> B2_LLL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¦</span>lead_coeff g<span class="main">¦</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span>ll<span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_less_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ large<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="main">¦</span>lead_coeff g<span class="main">¦</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">^</span><span class="main">1</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree g <span class="main">*</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">factor</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> power_mono pow_mono_exp<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">insert</span> normg normf1 deg_f g0 coeff_le_sq_norm<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">g</span></span></span><span class="main"><span class="main">]</span></span> j'0<span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pow_mono_one<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>lead_coeff g<span class="main">¦</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree g <span class="main">*</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">factor</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lead_coeff g<span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span>ll<span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>lead_coeff g<span class="main">¦</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">^</span>ll"</span></span> <span class="keyword1"><span class="command">using</span></span> p.m1 abs_le_square_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span>ll"</span></span> <span class="quoted"><span class="quoted">"lead_coeff g"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">^</span>ll <span class="main">≤</span> <span class="main">¦</span>lead_coeff g<span class="main">¦</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> ret <span class="main">=</span> ret<span class="main">[</span><span class="operator">unfolded</span> this if_False<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> deg_f<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> deg_ug<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≤</span> degree g"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pll.dvdm_degree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> u LLL<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pll.Mp g <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">(</span>degree g<span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pll.M <span class="main">(</span>coeff g <span class="main">(</span>degree g<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pll.Mp_def coeff_map_poly<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> pll.M_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> lg<span class="main">:</span> <span class="quoted"><span class="quoted">"lead_coeff g <span class="main">=</span> <span class="free">p</span><span class="main">^</span>ll <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> LLL<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> c0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">^</span>ll<span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span>lead_coeff g<span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lg abs_le_square_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> aux_abs_int<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coeff_le_sq_norm<span class="main">[</span><span class="operator">of</span> <span class="quoted">g</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">factor</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pow_mono_exp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> deg_f normg j'0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">*</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">∥</span><span class="skolem">factor</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree g <span class="main">*</span> <span class="main">∥</span>g<span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> degree <span class="skolem">factor</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> normf1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span>ll<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> large<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> deg_u <span class="keyword1"><span class="command">have</span></span> deg_g<span class="main">:</span> <span class="quoted"><span class="quoted">"degree g <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> j'0 <span class="keyword1"><span class="command">have</span></span> deg_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">factor</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">factor</span> g"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> common_factor_via_short<span class="main">[</span><span class="operator">OF</span> deg_factor deg_g u deg_u pll_u_factor LLL<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> large<span class="main">]</span> pll.m1
  <span class="keyword1"><span class="command">have</span></span> gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> gcd_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="keyword1">dvd</span> <span class="skolem">factor</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd_trans<span class="main">[</span><span class="operator">OF</span> this factor_f<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> gcd_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> deg_g <span class="keyword1"><span class="command">have</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"g <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> gcd_g<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?g</span> <span class="main">≤</span> degree g"</span></span> <span class="keyword1"><span class="command">using</span></span> g0 <span class="keyword1"><span class="command">using</span></span> divides_degree <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> gcd_g LLL<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> hj'<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?g</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"primitive_part g"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> ret <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"div_int_poly <span class="free">f</span> <span class="var">?pp</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> div_int_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="var"><span class="quoted"><span class="var">?pp</span></span></span><span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span> g0 
  <span class="keyword1"><span class="command">have</span></span> ppf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?pp</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> irr_f1<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">factor</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> factor_irreducible<span class="hidden">⇩</span><sub>d</sub>I<span class="main"><span class="main">[</span></span><span class="operator">OF</span> factor_f pu_factor deg_factor<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> gcd_factor <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> factor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">factor</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>D<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> irr_f1<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="quoted"><span class="skolem">h</span></span><span class="main">,</span> <span class="operator">folded</span> factor<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>degree <span class="var">?g</span> <span class="main">&lt;</span> <span class="free">j'</span> <span class="main">∧</span> degree <span class="skolem">h</span> <span class="main">&lt;</span> <span class="free">j'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j'</span> <span class="main">=</span> degree <span class="var">?g</span> <span class="main">+</span> degree <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> factor0 arg_cong<span class="main">[</span><span class="operator">OF</span> factor<span class="main">,</span> <span class="operator">of</span> <span class="quoted">degree</span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j'0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gcd <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> degree0_coeffs<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> factor factor0
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">:]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> factor<span class="main">,</span> <span class="operator">of</span> <span class="quoted">degree</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?g</span> <span class="main">=</span> degree <span class="skolem">factor</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> h <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="var">?g</span> <span class="main">≤</span> degree g"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gcd.commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> degree_gcd1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g0<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree g <span class="main">≥</span> degree <span class="skolem">factor</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> id deg_factor2 deg_g_j <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?g</span> <span class="main">=</span> degree g"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"degree g <span class="main">=</span> degree <span class="skolem">factor</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="keyword1">dvd</span> g"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"g <span class="main">=</span> <span class="var">?g</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">degree</span><span class="main">]</span> deg
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> g g0<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> degree0_coeffs<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> g g0
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">d</span><span class="main">:]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> factor<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="skolem">q</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">factor</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">*</span> g"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> g<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"smult <span class="skolem">d</span> <span class="skolem">factor</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">*</span> g"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p h <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"g <span class="keyword1">dvd</span> smult <span class="skolem">d</span> <span class="skolem">factor</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> dvd_smult_int<span class="main">[</span><span class="operator">OF</span> d this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"primitive_part g <span class="keyword1">dvd</span> <span class="skolem">factor</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> dvd_trans<span class="main">[</span><span class="operator">OF</span> this factor_f<span class="main">]</span> ppf <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="Factorization_Algorithm_16_22-LLL_reconstruction_inner_sound"><span class="command">lemma</span></span> LLL_reconstruction_inner_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> j <span class="main">=</span> Some <span class="main">(</span><span class="free">gs'</span><span class="main">,</span><span class="free">b'</span><span class="main">,</span><span class="free">f'</span><span class="main">,</span><span class="free">h</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">*</span> <span class="free">h</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">h</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> lead_coeff <span class="free">f'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g3</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="free">f'</span> <span class="main">(</span>lead_coeff <span class="free">f'</span><span class="main">,</span> mset <span class="free">gs'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g4</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">h</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g5</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">h</span> <span class="main">=</span> <span class="free">j'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g6</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">gs'</span> <span class="main">&lt;</span> length <span class="free">gs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g7</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">gs'</span> <span class="main">⊆</span> set <span class="free">gs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g8</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g9</span></span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ppg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"primitive_part g"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> ret <span class="main">=</span> ret<span class="main">[</span><span class="operator">unfolded</span> LLL_reconstruction_inner_simps<span class="main">]</span>   
  <span class="keyword1"><span class="command">from</span></span> ret <span class="keyword1"><span class="command">have</span></span> lc<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>lead_coeff g<span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">^</span>ll"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ret <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rest</span></span> <span class="keyword2"><span class="keyword">where</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"div_int_poly <span class="free">f</span> <span class="main">(</span>primitive_part g<span class="main">)</span> <span class="main">=</span> Some <span class="skolem">rest</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ret<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span> div_int_then_rqp<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> lc
  <span class="keyword1"><span class="command">have</span></span> out <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="var">?ppg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">gs'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="bound">gi</span><span class="main">.</span> <span class="main">¬</span> p.dvdm <span class="bound">gi</span> <span class="var">?ppg</span><span class="main">)</span> <span class="free">gs</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">=</span> <span class="skolem">rest</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> lead_coeff <span class="skolem">rest</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="var">?ppg</span> <span class="main">*</span> <span class="skolem">rest</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> div_int_then_rqp<span class="main">[</span><span class="operator">OF</span> rest<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="var"><span class="quoted"><span class="var">?g3</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?g1</span>›</span></span> f0 <span class="keyword1"><span class="command">have</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"content g"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> g0 <span class="keyword1"><span class="command">have</span></span> ct0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?c</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span>lead_coeff g<span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> content_le_lead_coeff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">^</span>ll"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ct_pl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="var">?c</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">^</span>ll"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ug <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pll.dvdm <span class="free">u</span> <span class="main">(</span>smult <span class="var">?c</span> <span class="var">?ppg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> poly_mod_dvd_drop_smult<span class="main">[</span><span class="operator">OF</span> u p ct0 ct_pl this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> puh<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> dvdm_power<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span> f
  <span class="keyword1"><span class="command">have</span></span> uh<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="free">u</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dvd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>dvdI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> degh<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">h</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> d_def deg deg_u puh dj' hf le_neq_implies_less not_less0 neq0_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> irr_h<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> factor_irreducible<span class="hidden">⇩</span><sub>d</sub>I degh hf puh<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> deg_g_j<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> deg_h<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?g6</span></span></span> <span class="keyword1"><span class="command">using</span></span> deg deg_g_j g_def hf le_less_Suc_eq puh degree_primitive_part <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g7</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> out 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> length_filter_less<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> pl_dvdm_imp_p_dvdm<span class="main"><span class="main">[</span></span><span class="operator">OF</span> uh<span class="main"><span class="main">]</span></span> u_gs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g8</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> f out <span class="keyword1"><span class="command">have</span></span> fh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">h</span> <span class="main">*</span> <span class="free">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gs'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">gi</span> <span class="main">←</span> <span class="free">gs</span><span class="main">.</span> <span class="main">¬</span> p.dvdm <span class="bound">gi</span> <span class="free">h</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span><span class="main">]</span> <span class="main">=</span> out
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">gi</span><span class="main">.</span> p.dvdm <span class="bound">gi</span> <span class="free">h</span><span class="main">)</span> <span class="free">gs</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"List.partition <span class="main">(</span><span class="main">λ</span><span class="bound">gi</span><span class="main">.</span> p.dvdm <span class="bound">gi</span> <span class="free">h</span><span class="main">)</span> <span class="free">gs</span> <span class="main">=</span> <span class="main">(</span><span class="var">?fs</span><span class="main">,</span> <span class="free">gs'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> gs' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> p.unique_factorization_m_factor_partition<span class="main">[</span><span class="operator">OF</span> l0 f_gs fh cop sf part<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> uf<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="free">f'</span> <span class="main">(</span>lead_coeff <span class="free">f'</span><span class="main">,</span> mset <span class="free">gs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g9</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">gs'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> pl.unique_factorization_m_imp_factorization<span class="main">[</span><span class="operator">OF</span> uf<span class="main">,</span> <span class="operator">unfolded</span> pl.factorization_m_def<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.Mp <span class="free">f'</span> <span class="main">=</span> pl.Mp <span class="main">(</span>smult <span class="main">(</span>lead_coeff <span class="free">f'</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">degree</span><span class="main">]</span> pl.degree_m_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>lead_coeff <span class="free">f'</span><span class="main">)</span> <span class="main">1</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.degree_m <span class="free">f'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.degree_m <span class="free">f'</span> <span class="main">=</span> degree <span class="free">f'</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> poly_mod.degree_m_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ pl.m1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="free">f'</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span>  p.coprime_lead_coeff_factor<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p.prime cop<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">unfolded</span></span> fh<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lead_coeff <span class="free">f'</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">^</span> <span class="free">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l0 p.prime <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> degf'<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> degree0_coeffs<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> f0 fh <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">:]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="free">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">h</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> irr_f<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">f</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_smult_int<span class="main">[</span><span class="operator">OF</span> c<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> fch <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">=</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hf irr_h deg_h
      <span class="keyword1"><span class="command">using</span></span> irr_f <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≡</span> degree <span class="free">f</span>›</span></span> degh j'n
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral degf' degree_mult_eq f0 fh mult_not_zero<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> j'n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">interpretation</span></span> LLL <span class="quoted"><span class="free">d</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-LLL_reconstruction_inner_None_upt_j'"><span class="command">lemma</span></span> LLL_reconstruction_inner_None_upt_j'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≤</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> degree <span class="bound">factor</span> <span class="main">≥</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_reconstruction_inner_complete<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor2</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor2</span> <span class="main">⟹</span> <span class="bound">factor2</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">≤</span> degree <span class="bound">factor2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
       <span class="keyword3"><span class="command">case</span></span> False
       <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor2</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor2</span> <span class="main">⟹</span> <span class="bound">factor2</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">≤</span> degree <span class="bound">factor2</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.hyps<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Suc.prems False<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">next</span></span>
       <span class="keyword3"><span class="command">case</span></span> True
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor2</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor2</span> <span class="main">⟹</span> <span class="bound">factor2</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">≤</span> degree <span class="bound">factor2</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> degree_factor_ge_degree_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> Suc.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> LLL_reconstruction_inner_None_upt_j<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">≤</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≤</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> degree <span class="bound">factor</span> <span class="main">≥</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">=</span><span class="free">j</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">d</span> <span class="main">=</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> degree <span class="bound">factor</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> degree_factor_ge_degree_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> dj2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">d</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> degree <span class="bound">factor</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> LLL_reconstruction_inner_None_upt_j'<span class="main">[</span><span class="operator">OF</span> ij dj2 jn<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-LLL_reconstruction_inner_all_None_imp_irreducible"><span class="command">lemma</span></span> LLL_reconstruction_inner_all_None_imp_irreducible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">f</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">factor</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> irreducible_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">factor</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> dvdp_u_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="skolem">factor</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> factor_dvd_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_reconstruction <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> deg_factor1<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">u</span> <span class="main">≤</span> degree <span class="skolem">factor</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_factor_ge_degree_u<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dvdp_u_factor factor_dvd_f<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> factor_not0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">factor</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> deg_factor2<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">factor</span> <span class="main">≤</span> degree <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> divides_degree<span class="main">[</span><span class="operator">OF</span> factor_dvd_f<span class="main">]</span> f0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">factor</span>"</span></span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">factor</span> <span class="main">=</span> degree <span class="free">f</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> factor_dvd_f <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">factor</span> <span class="main">*</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> True<span class="main">[</span><span class="operator">unfolded</span> f_factor<span class="main">]</span> f0<span class="main">[</span><span class="operator">unfolded</span> f_factor<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> degree0_coeffs<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">:]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> f_factor <span class="keyword1"><span class="command">have</span></span> fc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="skolem">factor</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> irreducible_factor irreducible<span class="hidden">⇩</span><sub>d</sub>_smult_int<span class="main">[</span><span class="operator">OF</span> c<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">factor</span></span><span class="main">,</span> <span class="operator">folded</span> fc<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> Suc_j<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="var">?j</span> <span class="main">≤</span> degree <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deg_factor2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="var">?j</span> <span class="main">≤</span> degree <span class="skolem">factor</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_reconstruction_inner_None_upt_j<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ dvdp_u_factor factor_dvd_f<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> Suc <span class="var">?j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deg_factor1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span>Suc <span class="var">?j</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc_j i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="var">?j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-irreducible_imp_LLL_reconstruction_inner_all_None"><span class="command">lemma</span></span> irreducible_imp_LLL_reconstruction_inner_all_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irr_f<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>   
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?LLL_inner</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="var">?LLL_inner</span> <span class="bound">j</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="var">?LLL_inner</span> <span class="bound">i</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> G_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Min <span class="var">?G</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> j_in_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> j_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Min_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ G_not_empty<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> LLL_not_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?LLL_inner</span> <span class="skolem">j</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> j_in_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> <span class="var">?LLL_inner</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> <span class="var">?LLL_inner</span> <span class="bound">i</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> LLL_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?LLL_inner</span> <span class="skolem">i</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> iG<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_def G_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> iG j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>    
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> all_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="var">?LLL_inner</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gs'</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="skolem"><span class="skolem">factor</span></span> <span class="keyword2"><span class="keyword">where</span></span> LLL_inner_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?LLL_inner</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">gs'</span><span class="main">,</span> <span class="skolem">b'</span><span class="main">,</span> <span class="skolem">f'</span><span class="main">,</span> <span class="skolem">factor</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> LLL_not_None <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> Suc_j1_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j d0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j d0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> degree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> degree <span class="bound">factor</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_reconstruction_inner_None_upt_j<span class="main"><span class="main">[</span></span><span class="operator">OF</span> all_None dj<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> jn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> LLL_inner_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?LLL_inner</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">gs'</span><span class="main">,</span> <span class="skolem">b'</span><span class="main">,</span> <span class="skolem">f'</span><span class="main">,</span> <span class="skolem">factor</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> LLL_inner_eq Suc_j1_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">have</span></span> deg_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">factor</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ff'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="main">*</span> <span class="skolem">factor</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> irreducible_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">factor</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LLL_reconstruction_inner_sound<span class="main">[</span><span class="operator">OF</span> dj jn degree LLL_inner_Some<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> ff'<span class="main">,</span> <span class="operator">of</span> <span class="quoted">degree</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> f0 ff' deg_factor<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> irreducible_factor jn <span class="keyword1"><span class="command">unfolding</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_def deg_factor <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> deg_f'<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f'</span> <span class="main">&lt;</span> degree <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ff' <span class="keyword1"><span class="command">have</span></span> factor_dvd_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">f</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reducible<span class="hidden">⇩</span><sub>d</sub>I<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">f'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">factor</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">intro</span> conjI ff'<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> deg_factor jn deg_f'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> irr_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-LLL_reconstruction_inner_all_None"><span class="command">lemma</span></span> LLL_reconstruction_inner_all_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">&lt;</span><span class="free">j</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dj                             
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> LLL_reconstruction_inner_loop.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">gs</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Degs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?innerl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?inner</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> hyp <span class="main">=</span> <span class="quoted">"1.hyps"</span>
  <span class="keyword1"><span class="command">note</span></span> dj <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> jn <span class="main">=</span> True
    <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="skolem">j</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">=</span><span class="skolem">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span>  i jn dj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>     
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?innerl</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?innerl</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> jn step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hyp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ step<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> jn dj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jn dj<span class="main">)</span>      
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> irreducible_imp_LLL_reconstruction_inner_loop_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irr_f<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> irreducible_imp_LLL_reconstruction_inner_all_None<span class="main">[</span><span class="operator">OF</span> irr_f<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> LLL_reconstruction_inner_all_None<span class="main">[</span><span class="operator">OF</span> _ dj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Factorization_Algorithm_16_22-exists_index_LLL_reconstruction_inner_Some"><span class="command">lemma</span></span> exists_index_LLL_reconstruction_inner_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inner_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">gs'</span><span class="main">,</span><span class="free">b'</span><span class="main">,</span><span class="free">f'</span><span class="main">,</span><span class="free">factor</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≤</span><span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> <span class="free">j</span> <span class="main">≤</span> <span class="bound">j'</span> <span class="main">∧</span> <span class="bound">j'</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="free">d</span><span class="main">&lt;</span><span class="bound">j'</span>
    <span class="main">∧</span> <span class="main">(</span>LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">j'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="bound">j'</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_loop i dj jn
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> LLL_reconstruction_inner_loop.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">gs</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Degs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?innerl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?inner</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> hyp <span class="main">=</span> <span class="quoted">"1.hyps"</span>  
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> dj <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> jn <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>4<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="skolem">j</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">=</span><span class="free">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> j_eq_n <span class="main">=</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="free">n</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> 2 j_eq_n True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">f</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> LLL_reconstruction_inner_all_None_imp_irreducible<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="free">n</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> False 1 j_eq_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> 2 j_eq_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 jn j_eq_n
          <span class="keyword1"><span class="command">using</span></span> False  dn nat_less_le
          <span class="keyword1"><span class="command">using</span></span> d_def dj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> j_eq_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>    
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j'</span></span><span class="main">≥</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="bound">j'</span> <span class="main">∧</span>
                 <span class="var">?inner</span> <span class="bound">j'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="bound">j'</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> hyp<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> degree <span class="free">f</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="skolem">j</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?innerl</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> 1 True jn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>        
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> One_nat_def True add.comm_neutral add_Suc_right atLeastLessThan_iff 
              le_neq_implies_less less_Suc_eq_le<span class="main">)</span>      
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jn False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">≥</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> a5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="skolem">j'</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">≥</span><span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False    
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> False 1 jn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 False dj jn
      <span class="keyword1"><span class="command">using</span></span> le_neq_implies_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="comment1">(* TODO: move *)</span>
<span class="keyword1" id="Factorization_Algorithm_16_22-unique_factorization_m_1"><span class="command">lemma</span></span> unique_factorization_m_1<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="main">1</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> pl.unique_factorization_mI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">gs</span>
  <span class="keyword3"><span class="command">assume</span></span> pl<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.factorization_m <span class="main">1</span> <span class="main">(</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">gs</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> pl.factorization_m_degree<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> deg0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈#</span> <span class="skolem">gs</span> <span class="main">⟹</span> pl.degree_m <span class="bound">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">hs</span></span> <span class="keyword2"><span class="keyword">where</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> <span class="main">{#</span> <span class="skolem">g</span> <span class="main">#}</span> <span class="main">+</span> <span class="skolem">hs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">gs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> pl <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.irreducible<span class="hidden">⇩</span><sub>d</sub>_m <span class="main">(</span>pl.Mp <span class="skolem">g</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"monic <span class="main">(</span>pl.Mp <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pl.factorization_m_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> deg0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">,</span> <span class="operator">unfolded</span> gs<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pl.irreducible<span class="hidden">⇩</span><sub>d</sub>_m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> pl <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pl.Mf <span class="main">(</span><span class="skolem">d</span><span class="main">,</span> <span class="skolem">gs</span><span class="main">)</span> <span class="main">=</span> pl.Mf <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pl.factorization_m_def pl.Mf_def pl.Mp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pl.factorization_m_def<span class="main">)</span>

<span class="keyword1" id="Factorization_Algorithm_16_22-LLL_reconstruction_inner_loop_j_le_n"><span class="command">lemma</span></span> LLL_reconstruction_inner_loop_j_le_n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">gs'</span><span class="main">,</span><span class="free">b'</span><span class="main">,</span><span class="free">f'</span><span class="main">,</span><span class="free">factor</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> degree <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">*</span> <span class="free">factor</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">factor</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> lead_coeff <span class="free">f'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g3</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="free">f'</span> <span class="main">(</span><span class="free">b'</span><span class="main">,</span> mset <span class="free">gs'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g4</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">factor</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g5</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> length <span class="free">gs'</span> <span class="main">&lt;</span> length <span class="free">gs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g6</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g7</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g8</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">gs'</span> <span class="main">⊆</span> set <span class="free">gs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g9</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gs'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">f'</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g10</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> ret ij jn dj
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> deg_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?innerl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?inner</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">have</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> degree <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> <span class="skolem">j</span> <span class="main">≤</span> degree <span class="bound">factor</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_reconstruction_inner_None_upt_j<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ij dj<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> n jn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?innerl</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> LLL_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False deg Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> LLL_reconstruction_inner_sound<span class="main">[</span><span class="operator">OF</span> dj jn c LLL_rw<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>    
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> Suc_j_None <span class="main">=</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> nj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> degree <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> dj2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> d_eq_j <span class="main">=</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">f</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> pl_Mp_1<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> d_Suc_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?innerl</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> irreducible_imp_LLL_reconstruction_inner_loop_f<span class="main"><span class="main">[</span></span><span class="operator">OF</span> True d_Suc_j<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> result_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> thesis1<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">factor</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u_f result_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> thesis2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">=</span> pl.Mp <span class="main">(</span>Polynomial.smult <span class="free">b'</span> <span class="main">(</span>prod_list <span class="free">gs'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> result_eq pl_Mp_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_factorization_m_1<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> irreducible_f <span class="main">=</span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">j'</span> <span class="main">∧</span> <span class="bound">j'</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="free">d</span><span class="main">&lt;</span><span class="bound">j'</span>
        <span class="main">∧</span> <span class="main">(</span><span class="var">?inner</span> <span class="bound">j'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="bound">j'</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exists_index_LLL_reconstruction_inner_Some<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ False<span class="main"><span class="main">]</span></span><span class="main">)</span>        
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?innerl</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>       
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span>Suc <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> da<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> an<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ja<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="skolem">a</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">≡</span><span class="skolem">a</span><span class="main">-</span><span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> dj'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> da <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dj' d0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> j'n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> an <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> LLL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?inner</span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">gs'</span><span class="main">,</span> <span class="free">b'</span><span class="main">,</span> <span class="free">f'</span><span class="main">,</span> <span class="free">factor</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> a1 j' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> prev_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span><span class="main">.</span> <span class="var">?inner</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> a2 j' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> Suc_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">j'</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> Suc <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> degree <span class="bound">factor</span>"</span></span>        
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_reconstruction_inner_None_upt_j<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> dj' Suc_rw j'n prev_None<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> p.dvdm <span class="free">u</span> <span class="bound">factor</span> <span class="main">⟹</span> <span class="bound">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> <span class="skolem">j'</span> <span class="main">≤</span> degree <span class="bound">factor</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j' <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> LLL_reconstruction_inner_sound<span class="main">[</span><span class="operator">OF</span> dj' j'n c2 LLL<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-LLL_reconstruction_inner_loop_j_ge_n"><span class="command">lemma</span></span> LLL_reconstruction_inner_loop_j_ge_n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">gs'</span><span class="main">,</span><span class="free">b'</span><span class="main">,</span><span class="free">f'</span><span class="main">,</span><span class="free">factor</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&gt;</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">*</span> <span class="free">factor</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">factor</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> lead_coeff <span class="free">f'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g3</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="free">f'</span> <span class="main">(</span><span class="free">b'</span><span class="main">,</span> mset <span class="free">gs'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g4</span>"</span></span><span class="main">)</span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">factor</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g5</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> length <span class="free">gs'</span> <span class="main">&lt;</span> length <span class="free">gs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g6</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g7</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g8</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">gs'</span> <span class="main">⊆</span> set <span class="free">gs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g9</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g10</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> jn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> gs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gs'</span><span class="main">=</span><span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b'</span><span class="main">=</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> factor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">factor</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ret <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LLL_reconstruction_inner_all_None_imp_irreducible<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ij<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="var"><span class="quoted"><span class="var">?g3</span></span></span> <span class="var"><span class="quoted"><span class="var">?g4</span></span></span> <span class="var"><span class="quoted"><span class="var">?g5</span></span></span> <span class="var"><span class="quoted"><span class="var">?g6</span></span></span> <span class="var"><span class="quoted"><span class="var">?g7</span></span></span> <span class="var"><span class="quoted"><span class="var">?g8</span></span></span> <span class="var"><span class="quoted"><span class="var">?g9</span></span></span> <span class="var"><span class="quoted"><span class="var">?g10</span></span></span> <span class="keyword1"><span class="command">using</span></span> f' factor b' gs' u_f 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_factorization_m_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-LLL_reconstruction_inner_loop"><span class="command">lemma</span></span> LLL_reconstruction_inner_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ret<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">gs'</span><span class="main">,</span><span class="free">b'</span><span class="main">,</span><span class="free">f'</span><span class="main">,</span><span class="free">factor</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> degree <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">*</span> <span class="free">factor</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g1</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">factor</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g2</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> lead_coeff <span class="free">f'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g3</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="free">f'</span> <span class="main">(</span><span class="free">b'</span><span class="main">,</span> mset <span class="free">gs'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g4</span>"</span></span><span class="main">)</span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"p.dvdm <span class="free">u</span> <span class="free">factor</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g5</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> length <span class="free">gs'</span> <span class="main">&lt;</span> length <span class="free">gs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g6</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">factor</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g7</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g8</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">gs'</span> <span class="main">⊆</span> set <span class="free">gs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g9</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gs'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">f'</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g10</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&gt;</span><span class="free">n</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> conjI<span class="main">)</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> ij2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">f</span> <span class="free">u</span> <span class="free">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ij True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="var"><span class="quoted"><span class="var">?g3</span></span></span> <span class="var"><span class="quoted"><span class="var">?g4</span></span></span> <span class="var"><span class="quoted"><span class="var">?g5</span></span></span> <span class="var"><span class="quoted"><span class="var">?g6</span></span></span> <span class="var"><span class="quoted"><span class="var">?g7</span></span></span> <span class="var"><span class="quoted"><span class="var">?g8</span></span></span> <span class="var"><span class="quoted"><span class="var">?g9</span></span></span> <span class="var"><span class="quoted"><span class="var">?g10</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> LLL_reconstruction_inner_loop_j_ge_n<span class="main">[</span><span class="operator">OF</span> ret ij2 dj True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≤</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span> <span class="var"><span class="quoted"><span class="var">?g3</span></span></span> <span class="var"><span class="quoted"><span class="var">?g4</span></span></span> <span class="var"><span class="quoted"><span class="var">?g5</span></span></span> <span class="var"><span class="quoted"><span class="var">?g6</span></span></span> <span class="var"><span class="quoted"><span class="var">?g7</span></span></span> <span class="var"><span class="quoted"><span class="var">?g8</span></span></span> <span class="var"><span class="quoted"><span class="var">?g9</span></span></span> <span class="var"><span class="quoted"><span class="var">?g10</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> LLL_reconstruction_inner_loop_j_le_n<span class="main">[</span><span class="operator">OF</span> ret ij n jn dj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Outer loop›</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-LLL_reconstruction''"><span class="command">lemma</span></span> LLL_reconstruction''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction'' <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">b</span> <span class="free">f</span> <span class="free">G</span> <span class="main">=</span> <span class="free">G'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> irreducible_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">factor</span><span class="main">.</span> <span class="bound">factor</span> <span class="main">∈</span> set <span class="free">G</span> <span class="main">⟹</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">factor</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="free">f</span> <span class="main">*</span> prod_list <span class="free">G</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="free">f</span> <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">,</span> mset <span class="free">gs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">gi</span><span class="main">.</span> <span class="bound">gi</span> <span class="main">∈</span> set <span class="free">gs</span> <span class="main">⟹</span> pl.Mp <span class="bound">gi</span> <span class="main">=</span> <span class="bound">gi</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">gi</span><span class="main">.</span> <span class="bound">gi</span> <span class="main">∈</span> set <span class="free">gs</span> <span class="main">⟹</span> p.irreducible<span class="hidden">⇩</span><sub>d</sub>_m <span class="bound">gi</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"p.square_free_m <span class="free">f</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="free">f</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> sf_F<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="free">F</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free">G'</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> <span class="free">F</span> <span class="main">=</span> prod_list <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 1 irreducible_G 3 4 5 6 7 8 9
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">gs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">G'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">gs</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">note</span></span> LLL_f' <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span>  
  <span class="keyword1"><span class="command">note</span></span> irreducible_G <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> F_f_G <span class="main">=</span> <span class="quoted">"1.prems"</span> <span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> f_gs_factor <span class="main">=</span> <span class="quoted">"1.prems"</span> <span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> gs_not_empty <span class="main">=</span> <span class="quoted">"1.prems"</span> <span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> norm <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>6<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> irred_p <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>7<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sf <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>8<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> cop <span class="main">=</span> <span class="quoted">"1.prems"</span><span class="main">(</span>9<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> choose_u_result<span class="main">:</span> <span class="quoted"><span class="quoted">"choose_u <span class="skolem">gs</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> choose_u_member<span class="main">[</span><span class="operator">OF</span>  gs_not_empty<span class="main">,</span> <span class="operator">unfolded</span> choose_u_result<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> u_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> degree <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> degree <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> degree <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≡</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs''</span> <span class="main">=</span> remove1 <span class="skolem">u</span> <span class="skolem">gs</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">degs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">degs</span> <span class="main">=</span> map degree <span class="skolem">gs''</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Degs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Degs</span> <span class="main">=</span> <span class="main">(+)</span> <span class="skolem">d</span> <span class="main">`</span> sub_mset_sums <span class="skolem">degs</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gs'</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">factor</span></span> <span class="keyword2"><span class="keyword">where</span></span> inner_loop_result<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="skolem">gs</span> <span class="skolem">f</span> <span class="skolem">u</span> <span class="skolem">Degs</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">gs'</span><span class="main">,</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">h</span><span class="main">,</span><span class="skolem">factor</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"LLL_reconstruction_inner_loop <span class="free">p</span> <span class="free">l</span> <span class="skolem">gs</span> <span class="skolem">f</span> <span class="skolem">u</span> <span class="skolem">Degs</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">gs'</span><span class="main">,</span> <span class="skolem">b'</span><span class="main">,</span> <span class="skolem">h</span><span class="main">,</span> <span class="skolem">factor</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inner_loop_result <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span>degree <span class="skolem">u</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> LLL_reconstruction_inner <span class="free">p</span> <span class="free">l</span> <span class="skolem">gs</span> <span class="skolem">f</span> <span class="skolem">u</span> <span class="skolem">Degs</span> <span class="bound">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LLL_reconstruction'' <span class="free">p</span> <span class="free">l</span> <span class="skolem">gs</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">G</span> <span class="main">=</span> LLL_reconstruction'' <span class="free">p</span> <span class="free">l</span> <span class="skolem">gs'</span> <span class="skolem">b'</span> <span class="skolem">h</span> <span class="main">(</span><span class="skolem">factor</span> <span class="main">#</span> <span class="skolem">G</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> LLL_reconstruction''.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="skolem">gs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> gs_not_empty
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">using</span></span> choose_u_result inner_loop_result <span class="keyword1"><span class="command">unfolding</span></span> Degs_def degs_def gs''_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> LLL_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"LLL_reconstruction'' <span class="free">p</span> <span class="free">l</span> <span class="skolem">gs'</span> <span class="skolem">b'</span> <span class="skolem">h</span> <span class="main">(</span><span class="skolem">factor</span> <span class="main">#</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">G'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LLL_f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pl.unique_factorization_m_imp_factorization<span class="main">[</span><span class="operator">OF</span> f_gs_factor<span class="main">,</span> 
    <span class="operator">unfolded</span> pl.factorization_m_def<span class="main">]</span> norm
  <span class="keyword1"><span class="command">have</span></span> f_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.eq_m <span class="skolem">f</span> <span class="main">(</span>smult <span class="main">(</span>lead_coeff <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>prod_mset <span class="main">(</span>mset <span class="skolem">gs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    mon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> set <span class="skolem">gs</span> <span class="main">⟹</span> monic <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> irred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> set <span class="skolem">gs</span> <span class="main">⟹</span> pl.irreducible<span class="hidden">⇩</span><sub>d</sub>_m <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">g</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> u_gs<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gs1</span></span> <span class="skolem"><span class="skolem">gs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> <span class="skolem">gs1</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">#</span> <span class="skolem">gs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> f_gs<span class="main">[</span><span class="operator">unfolded</span> gs<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.dvdm <span class="skolem">u</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pl.dvdm_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span>  <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"smult <span class="main"><span class="main"><span class="main">(</span></span></span>lead_coeff <span class="skolem"><span class="skolem"><span class="skolem">f</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>prod_mset <span class="main"><span class="main"><span class="main">(</span></span></span>mset <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">gs1</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">gs2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> pl_uf <span class="main">=</span> this
  <span class="keyword1"><span class="command">hence</span></span> p_uf<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="skolem">u</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pl_dvdm_imp_p_dvdm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> monic_u<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mon<span class="main">[</span><span class="operator">OF</span> u_gs<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> irred_u<span class="main">:</span> <span class="quoted"><span class="quoted">"p.irreducible_m <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> irred_p<span class="main">[</span><span class="operator">OF</span> u_gs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> degree_m_u<span class="main">:</span> <span class="quoted"><span class="quoted">"p.degree_m <span class="skolem">u</span> <span class="main">=</span> degree <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> monic_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> degree_u<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> degree <span class="skolem">u</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> irred_u <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> degree_m_u<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p.irreducible_degree<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> deg_u_d<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">u</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> F_f_G <span class="keyword1"><span class="command">have</span></span> f_dvd_F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> square_free_factor<span class="main">[</span><span class="operator">OF</span> f_dvd_F sf_F<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> sf_f<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">from</span></span> norm <span class="keyword1"><span class="command">have</span></span> norm_map<span class="main">:</span> <span class="quoted"><span class="quoted">"map pl.Mp <span class="skolem">gs</span> <span class="main">=</span> <span class="skolem">gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">gs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">factor</span>
    <span class="keyword3"><span class="command">assume</span></span> factor_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">factor</span> <span class="keyword1">dvd</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"p.dvdm <span class="skolem">u</span> <span class="skolem">factor</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> factor_f <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">factor</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gs1</span></span> <span class="skolem"><span class="skolem">gs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"List.partition <span class="main">(</span><span class="main">λ</span><span class="bound">gi</span><span class="main">.</span> p.dvdm <span class="bound">gi</span> <span class="skolem">factor</span><span class="main">)</span> <span class="skolem">gs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">gs1</span><span class="main">,</span> <span class="skolem">gs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> p.unique_factorization_m_factor_partition<span class="main">[</span><span class="operator">OF</span> l0 f_gs_factor f cop sf part<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> factor<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">factor</span> <span class="main">(</span>lead_coeff <span class="skolem">factor</span><span class="main">,</span> mset <span class="skolem">gs1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> u_factor part u_gs <span class="keyword1"><span class="command">have</span></span> u_gs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">gs1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gs1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs1'</span> <span class="main">=</span> remove1 <span class="skolem">u</span> <span class="skolem">gs1</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> remove1_mset<span class="main">[</span><span class="operator">OF</span> u_gs1<span class="main">,</span> <span class="operator">folded</span> gs1'_def<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> gs1<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">gs1</span> <span class="main">=</span> add_mset <span class="skolem">u</span> <span class="main">(</span>mset <span class="skolem">gs1'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> remove1_mset<span class="main">[</span><span class="operator">OF</span> u_gs<span class="main">,</span> <span class="operator">folded</span> gs''_def<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">gs</span> <span class="main">=</span> add_mset <span class="skolem">u</span> <span class="main">(</span>mset <span class="skolem">gs''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> part <span class="keyword1"><span class="command">have</span></span> filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gs1</span> <span class="main">=</span> <span class="main">[</span><span class="bound">gi</span><span class="main">←</span><span class="skolem">gs</span> <span class="main">.</span> p.dvdm <span class="bound">gi</span> <span class="skolem">factor</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">gs1</span> <span class="main">⊆#</span> mset <span class="skolem">gs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> filter mset_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">gs1'</span> <span class="main">⊆#</span> mset <span class="skolem">gs''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs gs1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> p.coprime_lead_coeff_factor<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹prime <span class="free"><span class="free">p</span></span>›</span></span></span> cop<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> f<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> cop'<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="skolem">factor</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> p_factor0<span class="main">:</span> <span class="quoted"><span class="quoted">"p.Mp <span class="skolem">factor</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f p.Mp_0 p.square_free_m_def poly_mod.square_free_m_factor<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sf<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> pl_factor0<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="skolem">factor</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_factor0 l0
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> p.Mp_0 p_Mp_pl_Mp<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> pl.factorization_m_degree<span class="main">[</span><span class="operator">OF</span> pl.unique_factorization_m_imp_factorization<span class="main"><span class="main">[</span></span><span class="operator">OF</span> factor<span class="main"><span class="main">]</span></span> pl_factor0<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.degree_m <span class="skolem">factor</span> <span class="main">=</span> sum_mset <span class="main">(</span>image_mset pl.degree_m <span class="main">(</span>mset <span class="skolem">gs1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"image_mset pl.degree_m <span class="main">(</span>mset <span class="skolem">gs1</span><span class="main">)</span> <span class="main">=</span> image_mset degree <span class="main">(</span>mset <span class="skolem">gs1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_mset_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> pl.monic_degree_m<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mon<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> part<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pl.degree_m <span class="skolem">factor</span> <span class="main">=</span> degree <span class="skolem">factor</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pl.degree_m_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p.coprime_exp_mod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cop' l0<span class="main"><span class="main">]</span></span> pl.m1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">factor</span> <span class="main">=</span> <span class="skolem">d</span> <span class="main">+</span> sum_mset <span class="main">(</span>image_mset degree <span class="main">(</span>mset <span class="skolem">gs1'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gs1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_mset <span class="main">(</span>image_mset degree <span class="main">(</span>mset <span class="skolem">gs1'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> sub_mset_sums <span class="skolem">degs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> degs_def
      sub_mset_sums mset_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI CollectI image_mset_subseteq_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sub<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">factor</span> <span class="main">∈</span> <span class="skolem">Degs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Degs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> Degs <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> length_less<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">gs'</span> <span class="main">&lt;</span> length <span class="skolem">gs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> irreducible_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">factor</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> h_dvd_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="keyword1">dvd</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_h_factor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">*</span> <span class="skolem">factor</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> h_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">h</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span> mset <span class="skolem">gs'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> gs'_gs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">gs'</span> <span class="main">⊆</span> set <span class="skolem">gs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> lead_coeff <span class="skolem">h</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gs'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="skolem">h</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LLL_reconstruction_inner_loop<span class="main">[</span><span class="operator">OF</span> degree_u monic_u irred_u p_uf f_dvd_F n_def<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span>
      f_gs_factor cop sf sf_f u_gs norm_map Degs
      a1 a2 n_def<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> deg_u_d gs_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> F_h_factor_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">*</span> prod_list <span class="main">(</span><span class="skolem">factor</span> <span class="main">#</span> <span class="skolem">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F_f_G f_h_factor <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> h_dvd_F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="keyword1">dvd</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_dvd_F dvd_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> irreducible_factor_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">factor</span> <span class="main">#</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">⟹</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> irreducible_factor irreducible_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> p.coprime_lead_coeff_factor<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹prime <span class="free"><span class="free">p</span></span>›</span></span></span> cop<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> f_h_factor<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> cop'<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="skolem">h</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lc'<span class="main">:</span> <span class="quoted"><span class="quoted">"lead_coeff <span class="main">(</span>smult <span class="main">(</span>lead_coeff <span class="skolem">h</span><span class="main">)</span> <span class="main">(</span>prod_list <span class="skolem">gs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lead_coeff <span class="skolem">h</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> gs'_gs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> monic_prod_list <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mon<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lc<span class="main">:</span> <span class="quoted"><span class="quoted">"lead_coeff <span class="main">(</span>pl.Mp <span class="main">(</span>smult <span class="main">(</span>lead_coeff <span class="skolem">h</span><span class="main">)</span> <span class="main">(</span>prod_list <span class="skolem">gs'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pl.M <span class="main">(</span>lead_coeff <span class="skolem">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> pl.degree_m_eq_lead_coeff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pl.degree_m_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ pl.m1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold</span> lc'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lead_coeff <span class="skolem">h</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="free">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p.coprime_exp_mod<span class="main">[</span><span class="operator">OF</span> cop' l0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> uh<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.unique_factorization_m <span class="skolem">h</span> <span class="main">(</span>lead_coeff <span class="skolem">h</span><span class="main">,</span> mset <span class="skolem">gs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h_eq <span class="keyword1"><span class="command">unfolding</span></span> b' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> p.square_free_m_factor<span class="main">[</span><span class="operator">OF</span> sf<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> f_h_factor<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> sf'<span class="main">:</span> <span class="quoted"><span class="quoted">"p.square_free_m <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">gs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> gs'_not_empty<span class="main">:</span> True 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"1.IH"</span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> length_less LLL_eq irreducible_factor_G F_h_factor_G 
        uh gs'_not_empty norm irred_p sf' cop'<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gs'_gs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> pl_ge0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="free">l</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> G'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G'</span> <span class="main">=</span> <span class="skolem">factor</span> <span class="main">#</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LLL_eq False <span class="keyword1"><span class="command">using</span></span> LLL_reconstruction''.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> condition1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="skolem">G'</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> irreducible_factor_G G'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> h_eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="skolem">h</span> <span class="main">=</span> pl.Mp <span class="main">[:</span><span class="skolem">b'</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h_eq False 
      <span class="keyword1"><span class="command">unfolding</span></span> pl.unique_factorization_m_alt_def pl.factorization_m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> Mp_const_rw<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pl.Mp <span class="main">[:</span><span class="skolem">b'</span><span class="main">:]</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">b'</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">^</span><span class="free">l</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pl.Mp_const_poly <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> condition2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> prod_list <span class="skolem">G'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h1 False f_h_factor G'_eq F_h_factor_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> condition1 condition2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly list"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> gs_hen<span class="main">:</span> <span class="quoted"><span class="quoted">"berlekamp_hensel <span class="free">p</span> <span class="free">l</span> <span class="free">F</span> <span class="main">=</span> <span class="free">gs</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>lead_coeff <span class="free">F</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.square_free_m <span class="free">p</span> <span class="free">F</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> sf_F<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="free">F</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-gs_not_empty"><span class="command">lemma</span></span> gs_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> c_fs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_field_factorization_int <span class="free">p</span> <span class="free">F</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sort <span class="main">(</span>map degree <span class="skolem">fs</span><span class="main">)</span> <span class="main">=</span> sort <span class="main">(</span>map degree <span class="free">gs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> p.berlekamp_hensel_main<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ gs_hen cop sf c_fs<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l0<span class="main">)</span>    
  <span class="keyword1"><span class="command">hence</span></span> fs_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">fs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">fs</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"p.unique_factorization_m <span class="free">F</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> mset <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p.finite_field_factorization_int<span class="main">[</span><span class="operator">OF</span> sf c_fs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"p.factorization_m <span class="free">F</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> mset <span class="skolem">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p.unique_factorization_m_imp_factorization <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
  <span class="keyword1"><span class="command">hence</span></span> eq_m_F<span class="main">:</span> <span class="quoted"><span class="quoted">"p.eq_m <span class="free">F</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs p.factorization_m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> p.degree_m <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p.Mp_const_poly<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> degree <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> p.degree_m_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ p1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> cop p1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">F</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> N0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-reconstruction_of_algorithm_16_22"><span class="command">lemma</span></span> reconstruction_of_algorithm_16_22<span class="main">:</span>   
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"reconstruction_of_algorithm_16_22 <span class="free">p</span> <span class="free">l</span> <span class="free">gs</span> <span class="free">F</span> <span class="main">=</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">G</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> <span class="free">F</span> <span class="main">=</span> prod_list <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> p.berlekamp_hensel_unique<span class="main">[</span><span class="operator">OF</span> cop sf gs_hen l0<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite_field_factorization_int <span class="free">p</span> <span class="free">F</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> p.berlekamp_hensel_main<span class="main">[</span><span class="operator">OF</span> l0 gs_hen cop sf this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> reconstruction_of_algorithm_16_22_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> LLL_reconstruction''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ gs_not_empty<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> * sf sf_F cop<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Final statement›</span></span>

<span class="keyword1" id="Factorization_Algorithm_16_22-factorization_algorithm_16_22"><span class="command">lemma</span></span> factorization_algorithm_16_22<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"factorization_algorithm_16_22 <span class="free">f</span> <span class="main">=</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">G</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> prod_list <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lead_coeff <span class="free">f</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≡</span> suitable_prime_bz <span class="free">f</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">gs</span></span> <span class="keyword2"><span class="keyword">where</span></span> fff<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_field_factorization_int <span class="skolem">p</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">gs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?degs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map degree <span class="skolem">gs</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> factorization_algorithm_16_22_def Let_def<span class="main">,</span> <span class="operator">folded</span> p_def<span class="main">,</span>
    <span class="operator">unfolded</span> fff split<span class="main">,</span> <span class="operator">folded</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> suitable_prime_bz<span class="main">[</span><span class="operator">OF</span> sff refl<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> prime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="var">?lc</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"poly_mod.square_free_m <span class="skolem">p</span> <span class="free">f</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> res
  <span class="keyword1"><span class="command">from</span></span> prime <span class="keyword1"><span class="command">interpret</span></span> poly_mod_prime <span class="quoted"><span class="skolem">p</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> degree <span class="free">f</span> <span class="main">*</span> degree <span class="free">f</span><span class="main">)</span> <span class="main">*</span>
            <span class="main">∥</span><span class="free">f</span><span class="main">∥<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> sqrt_int_ceiling <span class="skolem">K</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> K0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N_def sqrt_int_ceiling <span class="keyword1"><span class="command">using</span></span> K0 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> of_int_nonneg real_sqrt_ge_0_iff zero_le_ceiling<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> find_exponent <span class="skolem">p</span> <span class="skolem">N</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">folded</span> n_def<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> N_def K_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> find_exponent<span class="main">[</span><span class="operator">OF</span> m1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">N</span></span></span></span><span class="main">,</span> <span class="operator">folded</span> n_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> bh <span class="main">=</span> berlekamp_and_hensel_separated<span class="main">[</span><span class="operator">OF</span> cop sf refl fff n<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">folded</span> bh<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> reconstruction_of_algorithm_16_22<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prime deg _ refl cop sf sff res<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> n<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">p</span><span class="main">^</span><span class="skolem">n</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_mono N0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>        
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> B2_LLL <span class="free">f</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ *<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> B2_LLL <span class="free">f</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">K</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> K_def B2_LLL_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> 
          power_mult_distrib power2_eq_square power_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> power_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">N</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sqrt_int_ceiling_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> K0<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> B2_LLL <span class="free">f</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> degree <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">N</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> increasing_lattices_LLL_factorization <span class="main">::</span> <span class="quoted">int_poly_factorization_algorithm</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">factorization_algorithm_16_22</span> <span class="keyword1"><span class="command">using</span></span> factorization_algorithm_16_22 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">thm</span></span> factorize_int_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">increasing_lattices_LLL_factorization</span></span></span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Modern_Computer_Algebra_Problem">
<div class="head">
<h1>Theory Modern_Computer_Algebra_Problem</h1>
</div>
<pre class="source"><span class="comment1">(*
    Authors:    Jose Divasón
                Sebastiaan Joosten
                René Thiemann
                Akihisa Yamada
    License:    BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Mistakes in the textbook Modern Computer Algebra (2nd edition)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Modern_Computer_Algebra_Problem
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Factorization_Algorithm_16_22.html">Factorization_Algorithm_16_22</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">max_degree_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly <span class="main">⇒</span> int poly"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">max_degree_poly</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≥</span> degree <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
 
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">choose_u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly list <span class="main">⇒</span> int poly"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">choose_u</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">choose_u</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">gi</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">gi</span></span></span>"</span></span> 
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">choose_u</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">gi</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">gj</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span> max_degree_poly <span class="free"><span class="bound"><span class="entity">gi</span></span></span> <span class="main">(</span><span class="free">choose_u</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">gj</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A real problem of Algorithm 16.22›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Bogus example for Modern Computer Algebra (2nd edition), Algorithm 16.22, step 9:
  After having detected the factor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[:</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">,</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">,</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">,</span></span><span class="main"><span class="main">1</span></span> <span class="main"><span class="main">::</span></span> int<span class="main"><span class="main">:]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the remaining polynomial
  $f^*$ will be 1, and the remaining list of modular factors will be empty.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">*</span> <span class="main">[:</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">;</span>
   <span class="bound">p</span> <span class="main">=</span> suitable_prime_bz <span class="bound">f</span><span class="main">;</span>
   <span class="bound">b</span> <span class="main">=</span> lead_coeff <span class="bound">f</span><span class="main">;</span>
   <span class="bound">A</span> <span class="main">=</span> linf_norm_poly <span class="bound">f</span><span class="main">;</span> <span class="bound">n</span> <span class="main">=</span> degree <span class="bound">f</span><span class="main">;</span> <span class="bound">B</span> <span class="main">=</span> sqrt_int_ceiling <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="bound">n</span> <span class="main">*</span> <span class="bound">A</span><span class="main">;</span>
   <span class="bound">Bnd</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="bound">n</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="bound">B</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">;</span> <span class="bound">l</span> <span class="main">=</span> log_ceiling <span class="bound">p</span> <span class="bound">Bnd</span><span class="main">;</span>
   <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">fs</span><span class="main">)</span> <span class="main">=</span> finite_field_factorization_int <span class="bound">p</span> <span class="bound">f</span><span class="main">;</span>
   <span class="bound">gs</span> <span class="main">=</span> hensel_lifting <span class="bound">p</span> <span class="bound">l</span> <span class="bound">f</span> <span class="bound">fs</span><span class="main">;</span>
   <span class="bound">u</span> <span class="main">=</span> choose_u <span class="bound">gs</span><span class="main">;</span>
   <span class="bound">d</span> <span class="main">=</span> degree <span class="bound">u</span><span class="main">;</span>
   <span class="bound">g_star</span> <span class="main">=</span> <span class="main">[:</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="numeral">2</span> <span class="main">::</span> int <span class="main">:]</span><span class="main">;</span>
   <span class="main">(</span><span class="bound">gs'</span><span class="main">,</span><span class="bound">hs'</span><span class="main">)</span> <span class="main">=</span> List.partition <span class="main">(</span><span class="main">λ</span><span class="bound">gi</span><span class="main">.</span> poly_mod.dvdm <span class="bound">p</span> <span class="bound">gi</span> <span class="bound">g_star</span><span class="main">)</span> <span class="bound">gs</span><span class="main">;</span>
   <span class="bound">h_star</span> <span class="main">=</span> smult <span class="bound">b</span> <span class="main">(</span>prod_list <span class="bound">hs'</span><span class="main">)</span><span class="main">;</span>
   <span class="bound">f_star</span> <span class="main">=</span> primitive_part <span class="bound">h_star</span>
  <span class="keyword1">in</span> <span class="main">(</span><span class="bound">hs'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">f_star</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Another potential problem of Algorithm 16.22›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Suppose that $g^*$ is $p^l$. (It is is not yet clear whether lattices exists 
  where this $g^*$ is short enough).
  Then $pp(g^*) = 1$ is detected as \emph{irreducible} factor and the algorithm stops.
›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">input_poly</span> <span class="main">=</span> <span class="main">[:</span> <span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">1</span> <span class="main">::</span> int <span class="main">:]</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> input_poly<span class="antiquote"><span class="antiquote">}</span></span></span></span> the factorization will result in a lattice where
  each initial basis element has a Euclidean norm of at least $p^l$ (since the
  input polynomial $u$ has a norm larger than $p^l$.)
  So, just from the norm of the basis one cannot infer that the lattice contains small vectors.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> input_poly<span class="main">;</span>
   <span class="bound">p</span> <span class="main">=</span> suitable_prime_bz <span class="bound">f</span><span class="main">;</span>
   <span class="bound">b</span> <span class="main">=</span> lead_coeff <span class="bound">f</span><span class="main">;</span>
   <span class="bound">A</span> <span class="main">=</span> linf_norm_poly <span class="bound">f</span><span class="main">;</span> <span class="bound">n</span> <span class="main">=</span> degree <span class="bound">f</span><span class="main">;</span> <span class="bound">B</span> <span class="main">=</span> sqrt_int_ceiling <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="bound">n</span> <span class="main">*</span> <span class="bound">A</span><span class="main">;</span>
   <span class="bound">Bnd</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="bound">n</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="bound">B</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">;</span> <span class="bound">l</span> <span class="main">=</span> log_ceiling <span class="bound">p</span> <span class="bound">Bnd</span><span class="main">;</span>
   <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">fs</span><span class="main">)</span> <span class="main">=</span> finite_field_factorization_int <span class="bound">p</span> <span class="bound">f</span><span class="main">;</span>
   <span class="bound">gs</span> <span class="main">=</span> hensel_lifting <span class="bound">p</span> <span class="bound">l</span> <span class="bound">f</span> <span class="bound">fs</span><span class="main">;</span>
   <span class="bound">u</span> <span class="main">=</span> choose_u <span class="bound">gs</span><span class="main">;</span>
   <span class="bound">pl</span> <span class="main">=</span> <span class="bound">p</span><span class="main">^</span><span class="bound">l</span><span class="main">;</span>
   <span class="bound">pl2</span> <span class="main">=</span> <span class="bound">pl</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">;</span>  
   <span class="bound">u'</span> <span class="main">=</span> poly_mod.inv_Mp2 <span class="bound">pl</span> <span class="bound">pl2</span> <span class="main">(</span>poly_mod.Mp <span class="bound">pl</span> <span class="main">(</span>smult <span class="bound">b</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">in</span> sqrt_int_floor <span class="main">(</span>sq_norm <span class="bound">u'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="bound">pl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following calculation will show that the norm of $g^*$ is not that much
  shorter than $p^l$ which is an indication that it is not obvious that in general
  $p^l$ cannot be chosen as short polynomial.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compute_norms</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> input_poly<span class="main">;</span>
   <span class="bound">p</span> <span class="main">=</span> suitable_prime_bz <span class="bound">f</span><span class="main">;</span>
   <span class="bound">b</span> <span class="main">=</span> lead_coeff <span class="bound">f</span><span class="main">;</span>
   <span class="bound">A</span> <span class="main">=</span> linf_norm_poly <span class="bound">f</span><span class="main">;</span> <span class="bound">n</span> <span class="main">=</span> degree <span class="bound">f</span><span class="main">;</span> <span class="bound">B</span> <span class="main">=</span> sqrt_int_ceiling <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="bound">n</span> <span class="main">*</span> <span class="bound">A</span><span class="main">;</span>
   <span class="bound">Bnd</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="bound">n</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="bound">B</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">;</span> <span class="bound">l</span> <span class="main">=</span> log_ceiling <span class="bound">p</span> <span class="bound">Bnd</span><span class="main">;</span>
   <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">fs</span><span class="main">)</span> <span class="main">=</span> finite_field_factorization_int <span class="bound">p</span> <span class="bound">f</span><span class="main">;</span>
   <span class="bound">gs</span> <span class="main">=</span> hensel_lifting <span class="bound">p</span> <span class="bound">l</span> <span class="bound">f</span> <span class="bound">fs</span><span class="main">;</span>
   <span class="bound">u</span> <span class="main">=</span> choose_u <span class="bound">gs</span><span class="main">;</span>
   <span class="bound">pl</span> <span class="main">=</span> <span class="bound">p</span><span class="main">^</span><span class="bound">l</span><span class="main">;</span>
   <span class="bound">pl2</span> <span class="main">=</span> <span class="bound">pl</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">;</span>  
   <span class="bound">u'</span> <span class="main">=</span> poly_mod.inv_Mp2 <span class="bound">pl</span> <span class="bound">pl2</span> <span class="main">(</span>poly_mod.Mp <span class="bound">pl</span> <span class="main">(</span>smult <span class="bound">b</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
   <span class="bound">d</span> <span class="main">=</span> degree <span class="bound">u</span><span class="main">;</span>
   <span class="bound">pl</span> <span class="main">=</span> <span class="bound">p</span><span class="main">^</span><span class="bound">l</span><span class="main">;</span>
   <span class="bound">L</span> <span class="main">=</span> factorization_lattice <span class="bound">u'</span> <span class="main">1</span> <span class="bound">pl</span><span class="main">;</span>
   <span class="bound">g_star</span> <span class="main">=</span> short_vector <span class="numeral">2</span> <span class="bound">L</span> 
  <span class="keyword1">in</span> <span class="main">(</span>
     <span class="inner_quoted">''p^l:         ''</span> <span class="main">@</span> show <span class="bound">pl</span> <span class="main">@</span> shows_nl <span class="main">[]</span> <span class="main">@</span> 
     <span class="inner_quoted">''norm u:      ''</span> <span class="main">@</span> show <span class="main">(</span>sqrt_int_floor <span class="main">(</span>sq_norm_poly <span class="bound">u'</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> shows_nl <span class="main">[]</span> <span class="main">@</span>
     <span class="inner_quoted">''norm g_star: ''</span> <span class="main">@</span> show <span class="main">(</span>sqrt_int_floor <span class="main">(</span>sq_norm_vec <span class="bound">g_star</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> shows_nl <span class="main">[]</span> <span class="main">@</span> shows_nl <span class="main">[]</span> 
<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">compute_norms</span></span> <span class="keyword2"><span class="keyword">in</span></span> Haskell 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
<span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span><span class="main"><span class="main">^</span></span><span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:         $\approx 6.61056 \cdot 10^{122}$, namely 661055968790248598951915308032771039828404682964281219284648795274405791236311345825189210439715284847591212025023358304256
<span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"norm <span class="free"><span class="free">u</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:      $\approx 6.67555 \cdot 10^{122}$, namely 667555058938127908386141559707490406617756492853269306735125739182352318769782701477339940304992057299993307341153235059302
<span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"norm <span class="free"><span class="free">g_star</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: $\approx 5.02568 \cdot 10^{110}$, namely 502567871888893789258107599397950338997348731386301514804539180088146716526330518979464688385872213886910747667
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verified wrong results›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An equality in example 16.24 of the textbook which is not valid.›</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">g2</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="numeral">984</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">;</span>
           <span class="bound">g3</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="numeral">72</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">;</span>
           <span class="bound">g4</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="numeral">6828</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">;</span>
           <span class="bound">rhs</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="numeral">1728</span><span class="main">,</span><span class="main">-</span><span class="numeral">840</span><span class="main">,</span><span class="main">-</span><span class="numeral">420</span><span class="main">,</span><span class="numeral">6</span><span class="main">:]</span>
  <span class="keyword1">in</span> <span class="main">¬</span> poly_mod.eq_m <span class="main">(</span><span class="numeral">5</span><span class="main">^</span><span class="numeral">6</span><span class="main">)</span> <span class="main">(</span>smult <span class="numeral">6</span> <span class="main">(</span><span class="bound">g2</span><span class="main">*</span><span class="bound">g3</span><span class="main">*</span><span class="bound">g4</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">rhs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>